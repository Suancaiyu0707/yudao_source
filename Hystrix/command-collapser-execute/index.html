<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Hystrix æºç è§£æ â€”â€” å‘½ä»¤åˆå¹¶æ‰§è¡Œ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-collapser-execute/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬  

1. æ¦‚è¿°
2. HystrixCollapser
2.1 æ„é€ æ–¹æ³•
2."><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Hystrix/command-collapser-execute/" title="Hystrix æºç è§£æ â€”â€” å‘½ä»¤åˆå¹¶æ‰§è¡Œ" itemprop="url">Hystrix æºç è§£æ â€”â€” å‘½ä»¤åˆå¹¶æ‰§è¡Œ</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">http://www.iocoder.cn/Hystrix/command-collapser-execute/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2. HystrixCollapser</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2.1 æ„é€ æ–¹æ³•</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2.2 æ‰§è¡Œå‘½ä»¤æ–¹å¼</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2.3 æ ¸å¿ƒæ–¹æ³•</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">3. RequestCollapserFactory</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4. RequestCollapser</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.1 æ„é€ æ–¹æ³•</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.2 RequestBatch</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.3 #submitRequest(arg)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">5. CollapserTimer</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">5.1 RealCollapserTimer</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">5.2 CollapsedTask</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix å‘½ä»¤åˆå¹¶æ‰§è¡Œ</strong>ã€‚</p><p>åœ¨ <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#è¯·æ±‚åˆå¹¶" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œè¯·æ±‚åˆå¹¶ã€</a> ä¸­ï¼Œå¯¹ Hystrix å‘½ä»¤åˆå¹¶æ‰§è¡Œçš„<strong>æ¦‚å¿µ</strong>ã€<strong>åŸç†</strong>ã€<strong>ä½¿ç”¨åœºæ™¯</strong>ã€<strong>ä¼˜ç¼ºç‚¹</strong>å·²ç»åšäº†éå¸¸è¯¦ç»†é€å½»çš„åˆ†äº«ï¼Œæ‰€ä»¥èƒ–å‹å¯ä»¥å…ˆè®¤çœŸé˜…è¯»å­¦ä¹ ä¸‹ã€‚</p><p>å‘½ä»¤åˆå¹¶æ‰§è¡Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ ï¼š</p><blockquote><p>FROM <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#è¯·æ±‚åˆå¹¶" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œè¯·æ±‚åˆå¹¶ã€</a><br><img src="http://www.iocoder.cn/images/Hystrix/2018_11_04/01.jpeg" alt=""></p></blockquote><ul><li>ç¬¬ä¸€æ­¥ï¼Œæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—( RequestQueue )</li><li>ç¬¬äºŒéƒ¨ï¼Œå®šæ—¶ä»»åŠ¡( TimerTask ) <strong>å›ºå®šå‘¨æœŸ</strong>ä»è¯·æ±‚é˜Ÿåˆ—è·å–<strong>å¤šä¸ª</strong>å‘½ä»¤æ‰§è¡Œï¼Œåˆå¹¶æ‰§è¡Œã€‚</li></ul><p>åœ¨å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandCollapserGetValueForKey.java" rel="external nofollow noopener noreferrer" target="_blank">CommandCollapserGetValueForKey</a> ç†Ÿæ‚‰å‘½ä»¤åˆå¹¶æ‰§è¡Œçš„ä½¿ç”¨ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><p><strong>æ¨è Spring Cloud è§†é¢‘</strong>ï¼š</p><ul><li><a href="https://segmentfault.com/ls/1650000011063780?r=bPN0Ir" rel="external nofollow noopener noreferrer" target="_blank">Java å¾®æœåŠ¡å®è·µ - Spring Boot</a></li><li><a href="https://segmentfault.com/ls/1650000011386794?r=bPN0Ir" rel="external nofollow noopener noreferrer" target="_blank">Java å¾®æœåŠ¡å®è·µ - Spring Cloud</a></li><li><a href="https://segmentfault.com/ls/1650000011387052?r=bPN0Ir" rel="external nofollow noopener noreferrer" target="_blank">Java å¾®æœåŠ¡å®è·µ - Spring Boot / Spring Cloud</a></li></ul><h1 id="2-HystrixCollapser"><a href="#2-HystrixCollapser" class="headerlink" title="2. HystrixCollapser"></a>2. HystrixCollapser</h1><p><code>com.netflix.hystrix.HystrixCollapser</code> ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨<strong>æŠ½è±¡çˆ¶ç±»</strong>ã€‚</p><blockquote><p>NOTE ï¼š<code>com.netflix.hystrix.HystrixObservableCollapser</code> ï¼Œ<strong>å¦ä¸€ç§</strong>å‘½ä»¤åˆå¹¶å™¨<strong>æŠ½è±¡çˆ¶ç±»</strong>ï¼Œæœ¬æ–‡æš‚ä¸è§£æã€‚</p></blockquote><h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><p>HystrixCollapser <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCollapser</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt;</span></div><div class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">HystrixExecutable</span>&lt;<span class="title">ResponseType</span>&gt;, <span class="title">HystrixObservable</span>&lt;<span class="title">ResponseType</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestCollapserFactory&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; collapserFactory;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixRequestCache requestCache;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; collapserInstanceWrapper;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserMetrics metrics;</div><div class="line">    </div><div class="line">    <span class="comment">/* package for tests */</span> HystrixCollapser(HystrixCollapserKey collapserKey, Scope scope, CollapserTimer timer, HystrixCollapserProperties.Setter propertiesBuilder, HystrixCollapserMetrics metrics) &#123;</div><div class="line">        <span class="keyword">if</span> (collapserKey == <span class="keyword">null</span> || collapserKey.name().trim().equals(<span class="string">""</span>)) &#123;</div><div class="line">            String defaultKeyName = getDefaultNameFromClass(getClass());</div><div class="line">            collapserKey = HystrixCollapserKey.Factory.asKey(defaultKeyName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        HystrixCollapserProperties properties = HystrixPropertiesFactory.getCollapserProperties(collapserKey, propertiesBuilder);</div><div class="line">        <span class="keyword">this</span>.collapserFactory = <span class="keyword">new</span> RequestCollapserFactory&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;(collapserKey, scope, timer, properties);</div><div class="line">        <span class="keyword">this</span>.requestCache = HystrixRequestCache.getInstance(collapserKey, HystrixPlugins.getInstance().getConcurrencyStrategy());</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (metrics == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.metrics = HystrixCollapserMetrics.getInstance(collapserKey, properties);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.metrics = metrics;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> HystrixCollapser&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">         <span class="comment">/* strategy: HystrixMetricsPublisherCollapser */</span></div><div class="line">        HystrixMetricsPublisherFactory.createOrRetrievePublisherForCollapser(collapserKey, <span class="keyword">this</span>.metrics, properties);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * Used to pass public method invocation to the underlying implementation in a separate package while leaving the methods 'protected' in this class.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        collapserInstanceWrapper = <span class="keyword">new</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shardRequests(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests) &#123;</div><div class="line">                Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shards = self.shardRequests(requests);</div><div class="line">                self.metrics.markShards(shards.size());</div><div class="line">                <span class="keyword">return</span> shards;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;BatchReturnType&gt; <span class="title">createObservableCommand</span><span class="params">(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span> </span>&#123;</div><div class="line">                <span class="keyword">final</span> HystrixCommand&lt;BatchReturnType&gt; command = self.createCommand(requests);</div><div class="line"></div><div class="line">                command.markAsCollapsedCommand(<span class="keyword">this</span>.getCollapserKey(), requests.size());</div><div class="line">                self.metrics.markBatch(requests.size());</div><div class="line"></div><div class="line">                <span class="keyword">return</span> command.toObservable();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;Void&gt; <span class="title">mapResponseToRequests</span><span class="params">(Observable&lt;BatchReturnType&gt; batchResponse, <span class="keyword">final</span> Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> batchResponse.single().doOnNext(<span class="keyword">new</span> Action1&lt;BatchReturnType&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(BatchReturnType batchReturnType)</span> </span>&#123;</div><div class="line">                        <span class="comment">// this is a blocking call in HystrixCollapser</span></div><div class="line">                        self.mapResponseToRequests(batchReturnType, requests);</div><div class="line">                    &#125;</div><div class="line">                &#125;).ignoreElements().cast(Void.class);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> HystrixCollapserKey <span class="title">getCollapserKey</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> self.getCollapserKey();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>BatchReturnType <strong>æ³›å‹</strong>ï¼Œ<strong>å¤šä¸ª</strong>å‘½ä»¤åˆå¹¶æ‰§è¡Œè¿”å›ç»“æœç±»å‹ã€‚</li><li>ResponseType <strong>æ³›å‹</strong>ï¼Œ<strong>å•ä¸ª</strong>å‘½ä»¤æ‰§è¡Œè¿”å›ç»“æœç±»å‹ã€‚</li><li>RequestArgumentType <strong>æ³›å‹</strong>ï¼Œ<strong>å•ä¸ª</strong>å‘½ä»¤å‚æ•°ç±»å‹ã€‚</li><li><code>collapserFactory</code> å±æ€§ï¼ŒRequestCollapser <strong>å·¥å‚</strong>ï¼Œåœ¨ <a href="#">ã€Œ3. RequestCollapserFactoryã€</a> è¯¦ç»†è§£æã€‚</li><li><code>requestCache</code> å±æ€§ï¼ŒTODO ã€2012ã€‘ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘</li><li><code>collapserInstanceWrapper</code> å±æ€§ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨åŒ…è£…å™¨ã€‚<ul><li><code>com.netflix.hystrix.collapser.HystrixCollapserBridge</code> <strong>æ¥å£</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/HystrixCollapserBridge.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>HystrixCollapserBridge ï¼Œä¸º RequestBatch <strong>é€æ˜</strong>è°ƒç”¨ HystrixCollapser æˆ– HystrixObservableCollapser çš„æ–¹æ³•ä¸åŒçš„å®ç°ã€‚å‚è§ <a href="http://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/bridge.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ¡¥æ¥æ¨¡å¼ã€‹</a> ã€‚</li></ul></li><li><code>metrics</code> å±æ€§ï¼ŒTODO ã€2002ã€‘ã€metricsã€‘</li></ul><h2 id="2-2-æ‰§è¡Œå‘½ä»¤æ–¹å¼"><a href="#2-2-æ‰§è¡Œå‘½ä»¤æ–¹å¼" class="headerlink" title="2.2 æ‰§è¡Œå‘½ä»¤æ–¹å¼"></a>2.2 æ‰§è¡Œå‘½ä»¤æ–¹å¼</h2><p>åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-mode/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œå‘½ä»¤æ–¹å¼ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹äº† HystrixCommand æä¾›çš„<strong>å››ç§</strong>æ‰§è¡Œå‘½ä»¤æ–¹å¼ã€‚</p><p>HystrixCollapser ç±»ä¼¼äº HystrixCommand ï¼Œä¹Ÿæä¾›<strong>å››ç§</strong>ç›¸åŒçš„æ‰§è¡Œå‘½ä»¤æ–¹å¼ï¼Œå…¶ä¸­å¦‚ä¸‹ä¸‰ç§æ–¹å¼ä»£ç åŸºæœ¬<strong>ç±»ä¼¼</strong>ï¼Œæˆ‘ä»¬å°±ç»™ä¸‹<strong>ä¼ é€é—¨</strong>ï¼Œå°±ä¸é‡å¤å•°å—¦äº† ï¼š</p><ul><li><code>#observe()</code> æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L336" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ã€‚</li><li><code>#queue()</code> æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L456" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ã€‚</li><li><code>#execute()</code> æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L426" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ã€‚</li></ul><p>ä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹ <code>#toObservable()</code> æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// when we callback with the data we want to do the work</span></div><div class="line"> <span class="number">3</span>:     <span class="comment">// on a separate thread than the one giving us the callback</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">return</span> toObservable(Schedulers.computation());</div><div class="line"> <span class="number">5</span>: &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">toObservable</span><span class="params">(Scheduler observeOn)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;ResponseType&gt;&gt;() &#123;</div><div class="line"> <span class="number">9</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">10</span>:         <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">11</span>:             <span class="comment">// // ç¼“å­˜å¼€å…³ã€ç¼“å­˜KEY</span></div><div class="line"><span class="number">12</span>:             <span class="keyword">final</span> <span class="keyword">boolean</span> isRequestCacheEnabled = getProperties().requestCacheEnabled().get();</div><div class="line"><span class="number">13</span>:             <span class="keyword">final</span> String cacheKey = getCacheKey();</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:             <span class="comment">// ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–</span></div><div class="line"><span class="number">16</span>:             <span class="comment">/* try from cache first */</span></div><div class="line"><span class="number">17</span>:             <span class="keyword">if</span> (isRequestCacheEnabled) &#123;</div><div class="line"><span class="number">18</span>:                 HystrixCachedObservable&lt;ResponseType&gt; fromCache = requestCache.get(cacheKey);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (fromCache != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:                     metrics.markResponseFromCache();</div><div class="line"><span class="number">21</span>:                     <span class="keyword">return</span> fromCache.toObservable();</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:             &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:             <span class="comment">// è·å¾— RequestCollapser</span></div><div class="line"><span class="number">26</span>:             RequestCollapser&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; requestCollapser = collapserFactory.getRequestCollapser(collapserInstanceWrapper);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:             <span class="comment">// æäº¤ å‘½ä»¤è¯·æ±‚</span></div><div class="line"><span class="number">29</span>:             Observable&lt;ResponseType&gt; response = requestCollapser.submitRequest(getRequestArgument());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:             <span class="comment">// è·å¾— ç¼“å­˜Observable</span></div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (isRequestCacheEnabled &amp;&amp; cacheKey != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">33</span>:                 HystrixCachedObservable&lt;ResponseType&gt; toCache = HystrixCachedObservable.from(response);</div><div class="line"><span class="number">34</span>:                 HystrixCachedObservable&lt;ResponseType&gt; fromCache = requestCache.putIfAbsent(cacheKey, toCache);</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (fromCache == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">36</span>:                     <span class="keyword">return</span> toCache.toObservable();</div><div class="line"><span class="number">37</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>:                     toCache.unsubscribe(); <span class="comment">// å–æ¶ˆè®¢é˜…</span></div><div class="line"><span class="number">39</span>:                     <span class="keyword">return</span> fromCache.toObservable();</div><div class="line"><span class="number">40</span>:                 &#125;</div><div class="line"><span class="number">41</span>:             &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:             <span class="comment">// è·å¾— éç¼“å­˜Observable</span></div><div class="line"><span class="number">44</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">45</span>:         &#125;</div><div class="line"><span class="number">46</span>:     &#125;);</div><div class="line"><span class="number">47</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>observeOn</code> æ–¹æ³•å‚æ•°ï¼Œå®é™…æ–¹æ³•æš‚æœªç”¨åˆ°ï¼Œè·³è¿‡æ— è§†ã€‚</li><li>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šç¼“å­˜å­˜å¼€å…³ã€KEY ã€‚</li><li>ã€<em>åå‘</em>ã€‘ç¬¬ 32 è‡³ 41 è¡Œ ï¼šè·å¾—ã€ç¼“å­˜ Observableã€‘ã€‚è¿™å—ä»£ç å’Œ <code>AbstractCommand#toObservavle(...)</code> ç±»ä¼¼ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹ã€Œ4. AbstractCommand#toObservavle(â€¦)ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ã€<em>åå‘</em>ã€‘ç¬¬ 44 è¡Œ ï¼šè·å¾—ã€éç¼“å­˜ Observableã€‘ã€‚</li><li>æ³¨æ„ ï¼šè¿”å›çš„ Observable ï¼Œå¾ˆå¯èƒ½å‘½ä»¤å®é™…å¹¶æœªæ‰§è¡Œï¼Œæˆ–è€…è¯´å¹¶æœªæ‰§è¡Œå®Œæˆï¼Œæ­¤æ—¶åœ¨ <code>#queue()</code> / <code>#execute()</code> æ–¹æ³•ï¼Œé€šè¿‡ BlockingObservable <strong>é˜»å¡</strong>ç­‰å¾…æ‰§è¡Œå®Œæˆã€‚BlockingObservable åœ¨ <a href="http://www.iocoder.cn/RxJava/blocking-observable/?self">ã€ŠRxJava æºç è§£æ â€”â€” BlockingObservableã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>RequestCollapserFactory#getRequestCollapser()</code> ï¼Œè·å¾— RequestCollapser ã€‚åœ¨ <a href="#">ã€Œ3. RequestCollapserFactoryã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 29 è¡Œ ï¼šæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—( RequestQueue )ï¼Œå³<strong>å‘½ä»¤åˆå¹¶æ‰§è¡Œæ•´ä½“æµç¨‹ç¬¬ä¸€æ­¥</strong>ã€‚åœ¨ <a href="#">ã€Œ4. RequestCollapserã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2 id="2-3-æ ¸å¿ƒæ–¹æ³•"><a href="#2-3-æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="2.3 æ ¸å¿ƒæ–¹æ³•"></a>2.3 æ ¸å¿ƒæ–¹æ³•</h2><ul><li><p><code>#getRequestArgument(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—<strong>å•ä¸ª</strong>å‘½ä»¤å‚æ•°ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> RequestArgumentType <span class="title">getRequestArgument</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></li></ul><hr><ul><li><p><code>#createCommand(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆå¹¶</strong>ï¼Œåˆ›å»º<strong>ä¸€ä¸ª</strong> HystrixCommand ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> HystrixCommand&lt;BatchReturnType&gt; <span class="title">createCommand</span><span class="params">(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span></span>;</div></pre></td></tr></table></figure></li></ul><hr><ul><li><p><code>#mapResponseToRequests(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå°†<strong>ä¸€ä¸ª</strong> HystrixCommand çš„æ‰§è¡Œç»“æœï¼Œ<strong>æ˜ å°„</strong>å›å¯¹åº”çš„å‘½ä»¤è¯·æ±‚ä»¬ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">mapResponseToRequests</span><span class="params">(BatchReturnType batchResponse, Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span></span>;</div></pre></td></tr></table></figure></li></ul><hr><ul><li><p><code>#shardRequests(...)</code> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆ†ç‰‡</strong>æˆ <strong>N</strong> ä¸ªã€<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‘ã€‚é»˜è®¤å®ç°ä¸‹ï¼Œä¸è¿›è¡Œåˆ†ç‰‡ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shardRequests(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests) &#123;</div><div class="line">    <span class="keyword">return</span> Collections.singletonList(requests);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><ul><li><p>åœ¨<strong>æœªé‡å†™</strong> <code>#shardRequests(...)</code> çš„æƒ…å†µä¸‹ï¼Œæ•´ä½“æ–¹æ³•æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_11_04/02.png" alt=""></p></li><li><p>åœ¨<strong>é‡å†™</strong> <code>#shardRequests(...)</code> çš„æƒ…å†µä¸‹ï¼Œæ•´ä½“æ–¹æ³•æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_11_04/03.png" alt=""></p><ul><li>æœ¬å›¾ä¸­å‘½ä»¤è¯·æ±‚åˆ†ç‰‡ä»…ä»…æ˜¯ä¾‹å­ï¼Œå®é™…æ ¹æ®é‡å†™çš„é€»è¾‘ä¸åŒè€Œä¸åŒã€‚</li></ul></li></ul><h1 id="3-RequestCollapserFactory"><a href="#3-RequestCollapserFactory" class="headerlink" title="3. RequestCollapserFactory"></a>3. RequestCollapserFactory</h1><p><code>com.netflix.hystrix.collapser.RequestCollapserFactory</code> ï¼ŒRequestCollapser <strong>å·¥å‚</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCollapserFactory</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt; </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CollapserTimer timer;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserKey collapserKey;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserProperties properties;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixConcurrencyStrategy concurrencyStrategy;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scope scope;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestCollapserFactory</span><span class="params">(HystrixCollapserKey collapserKey, Scope scope, CollapserTimer timer, HystrixCollapserProperties properties)</span> </span>&#123;</div><div class="line">         <span class="comment">/* strategy: ConcurrencyStrategy */</span></div><div class="line">        <span class="keyword">this</span>.concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</div><div class="line">        <span class="keyword">this</span>.timer = timer;</div><div class="line">        <span class="keyword">this</span>.scope = scope;</div><div class="line">        <span class="keyword">this</span>.collapserKey = collapserKey;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><ul><li><code>timer</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨ï¼Œåœ¨ <a href="#">ã€Œ5. CollapserTimerã€</a> è¯¦ç»†è§£æã€‚</li><li><code>collapserKey</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨æ ‡è¯†ï¼Œå®ç°ç±»ä¼¼ HystrixThreadPoolKey ã€‚<ul><li>HystrixCollapserKey ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapserKey.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>HystrixThreadPoolKey ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹ã€Œ3. HystrixThreadPoolKeyã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><code>properties</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨å±æ€§é…ç½®ã€‚</li><li><code>concurrencyStrategy</code> å±æ€§ï¼Œå¹¶å‘ç­–ç•¥ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹ã€Œ4. HystrixConcurrencyStrategyã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><p><code>scope</code> å±æ€§ï¼Œå‘½ä»¤è¯·æ±‚ä½œç”¨åŸŸã€‚ç›®å‰æœ‰ä¸¤ç§ä½œç”¨åŸŸ ï¼š</p><ul><li><p><code>REQUEST</code> ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡( HystrixRequestContext )ã€‚</p><blockquote><p>Typically this means that requests within a single user-request (ie. HTTP request) are collapsed.<br>No interaction with other user requests.<br>1 queue per user request.</p></blockquote></li><li><p><code>GLOBAL</code> ï¼šå…¨å±€ã€‚</p><blockquote><p>Requests from any thread (ie. all HTTP requests) within the JVM will be collapsed.<br>1 queue for entire app.</p></blockquote></li></ul></li></ul><hr><p>è°ƒç”¨ <code>#getRequestCollapser()</code> æ–¹æ³•ï¼Œè·å¾— RequestCollapser ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestCollapser&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; <span class="title">getRequestCollapser</span><span class="params">(HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (Scopes.REQUEST == Scopes.valueOf(getScope().name())) &#123;</div><div class="line">       <span class="keyword">return</span> getCollapserForUserRequest(commandCollapser);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Scopes.GLOBAL == Scopes.valueOf(getScope().name())) &#123;</div><div class="line">       <span class="keyword">return</span> getCollapserForGlobalScope(commandCollapser);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.warn(<span class="string">"Invalid Scope: &#123;&#125;  Defaulting to REQUEST scope."</span>, getScope());</div><div class="line">       <span class="keyword">return</span> getCollapserForUserRequest(commandCollapser);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ ¹æ® <code>scope</code> ä¸åŒï¼Œè°ƒç”¨ä¸¤ä¸ªä¸åŒæ–¹æ³•ï¼Œè·å¾— RequestCollapser ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•å¤§ä½“é€»è¾‘ç›¸åŒï¼Œä¼˜å…ˆä»<strong>ç¼“å­˜</strong>ä¸­æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„ RequestCollapser è¿”å›ï¼›è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ»¡è¶³æ¡ä»¶çš„ RequestCollapser æ·»åŠ åˆ°<strong>ç¼“å­˜</strong>å¹¶è¿”å›ã€‚<ul><li><code>REQUEST</code> ï¼šè°ƒç”¨ <code>#getCollapserForUserRequest()</code> æ–¹æ³•ï¼ŒTODO ã€2012ã€‘ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘ã€‚</li><li><code>GLOBAL</code> ï¼šè°ƒç”¨ <code>#getCollapserForGlobalScope()</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/RequestCollapserFactory.java#L97" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹<strong>ä¸­æ–‡æ³¨é‡Š</strong>çš„ä»£ç ã€‚</li></ul></li></ul><h1 id="4-RequestCollapser"><a href="#4-RequestCollapser" class="headerlink" title="4. RequestCollapser"></a>4. RequestCollapser</h1><p><code>com.netflix.hystrix.collapser.RequestCollapser</code> ï¼Œ<strong>å‘½ä»¤è¯·æ±‚</strong>åˆå¹¶å™¨ã€‚ä¸»è¦ç”¨äº ï¼š</p><ul><li>æäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—( RequestQueue )ã€‚</li><li>æ¥æ”¶<strong>æ¥è‡ªå®šæ—¶ä»»åŠ¡</strong>æäº¤çš„<strong>å¤šä¸ª</strong>å‘½ä»¤ï¼Œåˆå¹¶æ‰§è¡Œã€‚</li></ul><h2 id="4-1-æ„é€ æ–¹æ³•"><a href="#4-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.1 æ„é€ æ–¹æ³•"></a>4.1 æ„é€ æ–¹æ³•</h2><p>RequestCollapser <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCollapser</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser;</div><div class="line">    <span class="comment">// batch can be null once shutdown</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;&gt; batch = <span class="keyword">new</span> AtomicReference&lt;RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Reference&lt;TimerListener&gt;&gt; timerListenerReference = <span class="keyword">new</span> AtomicReference&lt;Reference&lt;TimerListener&gt;&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean timerListenerRegistered = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CollapserTimer timer;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserProperties properties;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixConcurrencyStrategy concurrencyStrategy;</div><div class="line">    </div><div class="line">    RequestCollapser(HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser, HystrixCollapserProperties properties, CollapserTimer timer, HystrixConcurrencyStrategy concurrencyStrategy) &#123;</div><div class="line">        <span class="keyword">this</span>.commandCollapser = commandCollapser; <span class="comment">// the command with implementation of abstract methods we need </span></div><div class="line">        <span class="keyword">this</span>.concurrencyStrategy = concurrencyStrategy;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">        <span class="keyword">this</span>.timer = timer;</div><div class="line">        batch.set(<span class="keyword">new</span> RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;(properties, commandCollapser, properties.maxRequestsInBatch().get()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>commandCollapser</code> å±æ€§ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨åŒ…è£…å™¨ã€‚</li><li><code>batch</code> å±æ€§ï¼ŒRequestBatchï¼Œ<strong>å³æ˜¯æœ¬æ–‡ä¸€ç›´è¯´çš„è¯·æ±‚é˜Ÿåˆ—</strong>ã€‚åœ¨ <a href="#">ã€Œ4.2 RequestBatchã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li><li><code>timerListenerReference</code> å±æ€§ï¼Œ<strong>æ³¨å†Œ</strong>åœ¨å‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨çš„ç›‘å¬å™¨ã€‚æ¯ä¸ª RequestCollapser <strong>ç‹¬æœ‰ä¸€ä¸ª</strong>ç›‘å¬å™¨ã€‚è¯¥ç›‘å¬å™¨( å®é™…ä¸Šä¼šä½¿ç”¨è¯¥ç›‘å¬å™¨åˆ›å»ºå®šæ—¶ä»»åŠ¡ )<strong>å›ºå®šå‘¨æœŸ</strong>ä»è¯·æ±‚é˜Ÿåˆ—è·å–<strong>å¤šä¸ª</strong>å‘½ä»¤æ‰§è¡Œï¼Œæäº¤ RequestCollapser åˆå¹¶æ‰§è¡Œã€‚åœ¨ <a href="#">ã€Œ5. CollapserTimerã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li><li><code>timerListenerRegistered</code> å±æ€§ï¼Œ<code>timerListenerReference</code> æ˜¯å¦å·²ç»æ³¨å†Œã€‚</li><li><code>timer</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨ã€‚</li><li><code>properties</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨å±æ€§é…ç½®ã€‚</li><li><code>concurrencyStrategy</code> å±æ€§ï¼Œå¹¶å‘ç­–ç•¥ã€‚</li></ul><h2 id="4-2-RequestBatch"><a href="#4-2-RequestBatch" class="headerlink" title="4.2 RequestBatch"></a>4.2 RequestBatch</h2><p><code>com.netflix.hystrix.collapser.RequestBatch</code> ï¼Œå‘½ä»¤è¯·æ±‚é˜Ÿåˆ—ã€‚æä¾›å¦‚ä¸‹åŠŸèƒ½ ï¼š</p><ul><li>å‘½ä»¤è¯·æ±‚çš„æ·»åŠ </li><li>å‘½ä»¤è¯·æ±‚çš„ç§»é™¤</li><li>å‘½ä»¤è¯·æ±‚çš„<strong>æ‰¹é‡æ‰§è¡Œ</strong>ã€‚ç¬”è€…æŠŠ RequestBatch è§£é‡Šæˆ â€œå‘½ä»¤è¯·æ±‚é˜Ÿåˆ—â€ï¼Œä¸»è¦æ–¹ä¾¿å¤§å®¶ç†è§£ã€‚<ul><li>é‚£å¯èƒ½æœ‰èƒ–å‹æœ‰ç–‘é—®ï¼Œä¸ºå•¥è¯¥åŠŸèƒ½ä¸åœ¨ RequestCollapser ç›´æ¥å®ç°ï¼Œè¿™æ · RequestBatch æˆä¸ºçº¯ç²¹çš„é˜Ÿåˆ—å‘¢ï¼Ÿåœ¨ <a href="#">ã€Œ4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><p>RequestBatch <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBatch</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBatchSize;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean batchStarted = <span class="keyword">new</span> AtomicBoolean();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;RequestArgumentType, CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; argumentMap =</div><div class="line">            <span class="keyword">new</span> ConcurrentHashMap&lt;RequestArgumentType, CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserProperties properties;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ReentrantReadWriteLock batchLock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestBatch</span><span class="params">(HystrixCollapserProperties properties, HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser, <span class="keyword">int</span> maxBatchSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">        <span class="keyword">this</span>.commandCollapser = commandCollapser;</div><div class="line">        <span class="keyword">this</span>.maxBatchSize = maxBatchSize;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>commandCollapser</code> å±æ€§ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨åŒ…è£…å™¨ã€‚</li><li><code>maxBatchSize</code> å±æ€§ï¼Œé˜Ÿåˆ—æœ€å¤§é•¿åº¦ã€‚</li><li><code>batchStarted</code> å±æ€§ï¼Œæ‰§è¡Œæ˜¯å¦å¼€å§‹ã€‚</li><li><code>argumentMap</code> å±æ€§ï¼Œå‘½ä»¤è¯·æ±‚å‚æ•°æ˜ å°„( <strong>é˜Ÿåˆ—</strong> )ã€‚</li><li><code>properties</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨å±æ€§é…ç½®ã€‚</li><li><code>batchLock</code> å±æ€§ï¼Œ<code>argumentMap</code> æ“ä½œçš„<strong>è¯»å†™é”</strong>ã€‚</li></ul><p>RequestBatch å®ç°é˜Ÿåˆ—å…·ä½“çš„æ“ä½œæ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ4.3 #submitRequest(arg)ã€</a>/<a href="#">ã€Œ4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)ã€</a> ä¸€èµ·è§£æã€‚</p><h2 id="4-3-submitRequest-arg"><a href="#4-3-submitRequest-arg" class="headerlink" title="4.3 #submitRequest(arg)"></a>4.3 #submitRequest(arg)</h2><p>åœ¨ <code>#toObservable()</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>#submitRequest(arg)</code> æ–¹æ³•ï¼Œæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ° RequestBatch ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">submitRequest</span><span class="params">(<span class="keyword">final</span> RequestArgumentType arg)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/*</span></div><div class="line"><span class="comment"> 3:      * We only want the timer ticking if there are actually things to do so we register it the first time something is added.</span></div><div class="line"><span class="comment"> 4:      */</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (!timerListenerRegistered.get() &amp;&amp; timerListenerRegistered.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">/* schedule the collapsing task to be executed every x milliseconds (x defined inside CollapsedTask) */</span></div><div class="line"> <span class="number">7</span>:         timerListenerReference.set(timer.addListener(<span class="keyword">new</span> CollapsedTask()));</div><div class="line"> <span class="number">8</span>:     &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="comment">// loop until succeed (compare-and-set spin-loop)</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// è·å¾— RequestBatch</span></div><div class="line"><span class="number">13</span>:         <span class="keyword">final</span> RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; b = batch.get();</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (b == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"Submitting requests after collapser is shutdown"</span>));</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         <span class="comment">// æ·»åŠ åˆ° RequestBatch</span></div><div class="line"><span class="number">19</span>:         <span class="keyword">final</span> Observable&lt;ResponseType&gt; response;</div><div class="line"><span class="number">20</span>:         <span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:             response = b.offer(arg);</div><div class="line"><span class="number">22</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">23</span>:             response = b.offer( (RequestArgumentType) NULL_SENTINEL);</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="comment">// æ·»åŠ æˆåŠŸï¼Œè¿”å› Observable</span></div><div class="line"><span class="number">27</span>:         <span class="comment">// it will always get an Observable unless we hit the max batch size</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">30</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:             <span class="comment">// æ·»åŠ å¤±è´¥ï¼Œæ‰§è¡Œ RequestBatch ï¼Œå¹¶åˆ›å»ºæ–°çš„ RequestBatch</span></div><div class="line"><span class="number">32</span>:             <span class="comment">// this batch can't accept requests so create a new one and set it if another thread doesn't beat us</span></div><div class="line"><span class="number">33</span>:             createNewBatchAndExecutePreviousIfNeeded(b);</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šå½“ RequestCollapser çš„ç›‘å¬ä»»åŠ¡( CollapsedTask )è¿˜æœªåˆ›å»ºï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>ç¬¬ 11 è‡³ 35 è¡Œ ï¼š<strong>æ­»å¾ªç¯</strong>ï¼Œç›´åˆ°æäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ° RequestBatch <strong>æˆåŠŸ</strong>ã€‚<ul><li>ç¬¬ 13 è‡³ 16 è¡Œ ï¼šè·å¾— RequestBatch ã€‚ä»ç›®å‰ä»£ç çœ‹ä¸‹æ¥ï¼Œé™¤é RequestCollapser è¢« <code>#shutdown()</code> åæ‰ä¼šå‡ºç°ä¸º <code>null</code> çš„æƒ…å†µã€‚</li><li>ç¬¬ 19 è‡³ 24 è¡Œ ï¼šè°ƒåŠ¨ <code>RequestBatch#offer(...)</code> æ–¹æ³•ï¼Œæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ° RequestBatch ï¼Œå¹¶è·å¾— Observable ã€‚è¿™é‡Œå¯¹ <code>arg == null</code> åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸º <code>RequestBatch.argumentMap</code> æ˜¯ ConcurrentHashMap ï¼Œä¸å…è®¸å€¼ä¸º <code>null</code> ã€‚å¦å¤–ï¼Œ<code>RequestBatch#offer(...)</code> æ–¹æ³•çš„å®ç°ä»£ç ï¼Œåœ¨ç»“æŸäº†å½“å‰æ–¹æ³•ï¼Œè¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œè¿”å› Observable ã€‚</li><li>ç¬¬ 30 è‡³ 34 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œæ‰§è¡Œå½“å‰ RequestBatch çš„<strong>å¤šä¸ª</strong>å‘½ä»¤åˆå¹¶æ‰§è¡Œï¼Œå¹¶åˆ›å»º<strong>æ–°çš„</strong> RequestBatch ã€‚åœ¨ <a href="#">ã€Œ4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><hr><p><code>RequestBatch#offer(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt;  <span class="title">offer</span><span class="params">(RequestArgumentType arg)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// æ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥</span></div><div class="line"> <span class="number">3</span>:     <span class="comment">/* short-cut - if the batch is started we reject the offer */</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">/*</span></div><div class="line"><span class="comment"> 9:      * The 'read' just means non-exclusive even though we are writing.</span></div><div class="line"><span class="comment">10:      */</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (batchLock.readLock().tryLock()) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="comment">// æ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥</span></div><div class="line"><span class="number">14</span>:             <span class="comment">/* double-check now that we have the lock - if the batch is started we reject the offer */</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:             <span class="comment">// è¶…è¿‡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œæ·»åŠ å¤±è´¥</span></div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (argumentMap.size() &gt;= maxBatchSize) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">22</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">23</span>:                 <span class="comment">// åˆ›å»º CollapsedRequestSubject ï¼Œå¹¶æ·»åŠ åˆ°é˜Ÿåˆ—</span></div><div class="line"><span class="number">24</span>:                 CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt; collapsedRequest = <span class="keyword">new</span> CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;(arg, <span class="keyword">this</span>);</div><div class="line"><span class="number">25</span>:                 <span class="keyword">final</span> CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt; existing = (CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;) argumentMap.putIfAbsent(arg, collapsedRequest);</div><div class="line"><span class="number">26</span>:                 <span class="comment">/**</span></div><div class="line"><span class="comment">27:                  * If the argument already exists in the batch, then there are 2 options:</span></div><div class="line"><span class="comment">28:                  * A) If request caching is ON (the default): only keep 1 argument in the batch and let all responses</span></div><div class="line"><span class="comment">29:                  * be hooked up to that argument</span></div><div class="line"><span class="comment">30:                  * B) If request caching is OFF: return an error to all duplicate argument requests</span></div><div class="line"><span class="comment">31:                  *</span></div><div class="line"><span class="comment">32:                  * This maintains the invariant that each batch has no duplicate arguments.  This prevents the impossible</span></div><div class="line"><span class="comment">33:                  * logic (in a user-provided mapResponseToRequests for HystrixCollapser and the internals of HystrixObservableCollapser)</span></div><div class="line"><span class="comment">34:                  * of trying to figure out which argument of a set of duplicates should get attached to a response.</span></div><div class="line"><span class="comment">35:                  *</span></div><div class="line"><span class="comment">36:                  * See https://github.com/Netflix/Hystrix/pull/1176 for further discussion.</span></div><div class="line"><span class="comment">37:                  */</span></div><div class="line"><span class="number">38</span>:                 <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">39</span>:                     <span class="keyword">boolean</span> requestCachingEnabled = properties.requestCacheEnabled().get();</div><div class="line"><span class="number">40</span>:                     <span class="keyword">if</span> (requestCachingEnabled) &#123;</div><div class="line"><span class="number">41</span>:                         <span class="keyword">return</span> existing.toObservable();</div><div class="line"><span class="number">42</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">43</span>:                         <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalArgumentException(<span class="string">"Duplicate argument in collapser batch : ["</span> + arg + <span class="string">"]  This is not supported.  Please turn request-caching on for HystrixCollapser:"</span> + commandCollapser.getCollapserKey().name() + <span class="string">" or prevent duplicates from making it into the batch!"</span>));</div><div class="line"><span class="number">44</span>:                     &#125;</div><div class="line"><span class="number">45</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">46</span>:                     <span class="keyword">return</span> collapsedRequest.toObservable();</div><div class="line"><span class="number">47</span>:                 &#125;</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:             &#125;</div><div class="line"><span class="number">50</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">51</span>:             batchLock.readLock().unlock();</div><div class="line"><span class="number">52</span>:         &#125;</div><div class="line"><span class="number">53</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">54</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è‡³ 6 è¡Œ ï¼šæ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥ã€‚åœ¨ <code>RequestBatch#executeBatchIfNotAlreadyStarted(...)</code> æ–¹æ³•çš„å¼€å¤´ï¼Œä¼˜å…ˆ <strong>CAS</strong> ä½¿ <code>batchStarted = true</code> ã€‚</li><li>ç¬¬ 11 è¡Œ ï¼šè·å¾—<strong>è¯»é”</strong>ã€‚<code>The &#39;read&#39; just means non-exclusive even though we are writing.</code> ï¼Œå³ä½¿è¯¥æ–¹æ³•å®é™…åœ¨åš<strong>â€œå†™æ“ä½œâ€</strong>ï¼Œä¸æ’ä»–ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨è¯»é”ã€‚</li><li>ç¬¬ 15 è‡³ 17 è¡Œ ï¼š<code>double-check</code>ï¼Œæ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥ã€‚åœ¨ <code>RequestBatch#executeBatchIfNotAlreadyStarted(...)</code> æ–¹æ³•ï¼Œä¼˜å…ˆ <strong>CAS</strong> ä½¿ <code>batchStarted = true</code>ï¼Œå†è·å–<strong>å†™é”</strong>ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¯¥æƒ…å†µã€‚</li><li>ç¬¬ 20 è‡³ 21 è¡Œ ï¼šè¶…è¿‡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œæ·»åŠ å¤±è´¥ã€‚</li><li><p>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º <code>com.netflix.hystrix.collapser.CollapsedRequestSubject</code> ï¼Œå¹¶å°†<strong>å®ƒ</strong>æ·»åŠ åˆ°é˜Ÿåˆ—( <code>argumentMap</code> ) ã€‚</p><ul><li>CollapsedRequestSubject å®ç° <code>com.netflix.hystrix.HystrixCollapser.CollapsedRequest</code> <strong>æ¥å£</strong>ï¼Œå®šä¹‰äº†æ‰¹é‡å‘½ä»¤æ‰§è¡Œçš„<strong>è¯·æ±‚</strong>ï¼Œä¸ä»…é™äºè·å¾—è¯·æ±‚å‚æ•°( <code>#getArgument()</code> æ–¹æ³• )ï¼Œä¹ŸåŒ…æ‹¬å¯¹æ‰¹é‡å‘½ä»¤æ‰§è¡Œç»“æŸåï¼Œæ¯ä¸ª<strong>è¯·æ±‚</strong>çš„ç»“æœè®¾ç½®( <code>#setResponse(...)</code>/<code>#emitResponse(...)</code>/<code>#setException(...)</code>/<code>#setComplete()</code> æ–¹æ³• )ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L512" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ¥å£çš„ä»£ç ã€‚</li><li><p>CollapsedRequestSubject <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package */</span><span class="class"><span class="keyword">class</span> <span class="title">CollapsedRequestSubject</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">CollapsedRequest</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> R argument;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç»“æœ( response ) æ˜¯å¦è®¾ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> AtomicBoolean valueSet = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯å›æ”¾çš„ ReplaySubject</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReplaySubject&lt;T&gt; subject = ReplaySubject.create();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¸¦è®¢é˜…æ•°é‡çš„ ReplaySubject</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Observable&lt;T&gt; subjectWithAccounting;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢é˜…æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> outstandingSubscriptions = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CollapsedRequestSubject</span><span class="params">(<span class="keyword">final</span> R arg, <span class="keyword">final</span> RequestBatch&lt;?, T, R&gt; containingBatch)</span> </span>&#123;</div><div class="line">        <span class="comment">// è®¾ç½® argument</span></div><div class="line">        <span class="keyword">if</span> (arg == RequestCollapser.NULL_SENTINEL) &#123;</div><div class="line">            <span class="keyword">this</span>.argument = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.argument = arg;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½® å¸¦è®¢é˜…æ•°é‡çš„ ReplaySubject</span></div><div class="line">        <span class="keyword">this</span>.subjectWithAccounting = subject</div><div class="line">                .doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">                        outstandingSubscriptions++;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .doOnUnsubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">                        outstandingSubscriptions--;</div><div class="line">                        <span class="keyword">if</span> (outstandingSubscriptions == <span class="number">0</span>) &#123;</div><div class="line">                            containingBatch.remove(arg);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>argument</code> å±æ€§ï¼Œ<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚å‚æ•°ã€‚</li><li><code>valueSet</code> å±æ€§ï¼Œç»“æœ( Response ) æ˜¯å¦è®¾ç½®ï¼Œé€šè¿‡ <code>#setResponse()</code>/<code>#emitResponse()</code> æ–¹æ³•è®¾ç½®ã€‚</li><li><code>subject</code> å±æ€§ï¼Œ<strong>å¯å›æ”¾æ‰§è¡Œç»“æœ</strong>çš„ Subject ã€‚æ­¤å¤„ä½¿ç”¨ ReplaySubject çš„ä¸»è¦ç›®çš„ï¼Œå½“ HystrixCollapser å¼€å¯<strong>ç¼“å­˜</strong>åŠŸèƒ½æ—¶ï¼Œé€šè¿‡å›æ”¾æ‰§è¡Œç»“æœï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹ã€Œ5. HystrixCachedObservableã€</a> ä¹Ÿæœ‰ç›¸åŒçš„å®ç°ã€‚å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼ŒReplaySubject å¹¶<strong>æ²¡æœ‰</strong>å‘ä»»ä½• Observable è®¢é˜…ç»“æœï¼Œ<strong>è€Œæ˜¯é€šè¿‡ <code>#setResponse()</code>/<code>#emitResponse()</code> æ–¹æ³•è®¾ç½®ç»“æœ</strong>ã€‚</li><li><code>outstandingSubscriptions</code> å±æ€§ï¼Œè®¢é˜…æ•°é‡ã€‚</li><li><code>subjectWithAccounting</code> å±æ€§ï¼Œå¸¦è®¢é˜…æ•°é‡çš„ ReplaySubject ã€‚å½“å–æ¶ˆè®¢é˜…æ—¶ï¼Œè°ƒç”¨ <code>RequestBatch#remove(arg)</code> æ–¹æ³•ï¼Œç§»é™¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 38 è‡³ 47 è¡Œ ï¼šè¿”å› Observable ã€‚</p><ul><li>å½“ <code>argumentMap</code> å·²ç»å­˜åœ¨ <code>arg</code> å¯¹åº”çš„ Observable æ—¶ï¼Œå¿…é¡»å¼€å¯ç¼“å­˜ ( <code>HystrixCollapserProperties.requestCachingEnabled = true</code> ) åŠŸèƒ½ã€‚åŸå› æ˜¯ï¼Œå¦‚æœåœ¨<strong>ç›¸åŒçš„</strong> <code>arg</code> ï¼Œå¹¶ä¸”æœªå¼€å¯ç¼“å­˜ï¼ŒåŒæ—¶<strong>ç¬¬ 43 è¡Œ</strong>å®ç°çš„æ˜¯ <code>collapsedRequest.toObservable()</code> ï¼Œé‚£ä¹ˆ<strong>ç›¸åŒçš„</strong> <code>arg</code> å°†æœ‰<strong>å¤šä¸ª</strong> Observable æ‰§è¡Œå‘½ä»¤ï¼Œæ­¤æ—¶ <code>HystrixCollapserBridge#mapResponseToRequests(...)</code> æ–¹æ³•æ— æ³•å°†æ‰§è¡Œ( Response )èµ‹å€¼åˆ° <code>arg</code> å¯¹åº”çš„å‘½ä»¤è¯·æ±‚( CollapsedRequestSubject ) ã€‚æ›´å¤šè®¨è®ºï¼Œè§ <a href="https://github.com/Netflix/Hystrix/pull/1176" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/Hystrix/pull/1176</a> ã€‚</li><li>å›è¿‡å¤´çœ‹ <code>HystrixCollapser#toObservable()</code> æ–¹æ³•çš„<strong>ç¬¬ 32 è‡³ 41 è¡Œçš„ä»£ç </strong>ï¼Œè¿™é‡Œä¹Ÿæœ‰å¯¹<strong>ç¼“å­˜</strong>åŠŸèƒ½ï¼Œæ˜¯ä¸æ˜¯<strong>é‡å¤</strong>äº†å‘¢ï¼Ÿ<code>argumentMap</code> é’ˆå¯¹çš„æ˜¯ RequestBatch çº§çš„ç¼“å­˜ï¼ŒHystrixCollapser : RequestCollapser : RequestBatch æ˜¯ <code>1 : 1 : N</code> çš„å…³ç³»ï¼Œé€šè¿‡ <code>HystrixCollapser#toObservable()</code> å¯¹ç¼“å­˜çš„å¤„ç†é€»è¾‘ï¼Œä¿è¯ RequestBatch åˆ‡æ¢åï¼Œ<strong>ä¾ç„¶æœ‰ç¼“å­˜</strong>ã€‚</li></ul></li></ul><hr><p><code>RequestBatch#remove()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package-private */</span> <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(RequestArgumentType arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line">        <span class="comment">//nothing we can do</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (batchLock.readLock().tryLock()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">/* double-check now that we have the lock - if the batch is started, deleting is useless */</span></div><div class="line">            <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            argumentMap.remove(arg);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            batchLock.readLock().unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ RequestBatch å¼€å§‹æ‰§è¡Œï¼Œä¸å…è®¸ç§»é™¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‚</li></ul><h2 id="4-4-createNewBatchAndExecutePreviousIfNeeded-previousBatch"><a href="#4-4-createNewBatchAndExecutePreviousIfNeeded-previousBatch" class="headerlink" title="4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)"></a>4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)</h2><p>æœ¬å°èŠ‚å»ºè®®åœ¨ <a href="#">ã€Œ5. CollapserTimerã€</a> åï¼Œå†å›è¿‡å¤´çœ‹ã€‚</p><p><code>#createNewBatchAndExecutePreviousIfNeeded(previousBatch)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createNewBatchAndExecutePreviousIfNeeded</span><span class="params">(RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; previousBatch)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">if</span> (previousBatch == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Trying to start null batch which means it was shutdown already."</span>);</div><div class="line"><span class="number">4</span>:     &#125;</div><div class="line"><span class="number">5</span>:     <span class="keyword">if</span> (batch.compareAndSet(previousBatch, <span class="keyword">new</span> RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;(properties, commandCollapser, properties.maxRequestsInBatch().get()))) &#123;</div><div class="line"><span class="number">6</span>:         <span class="comment">// this thread won so trigger the previous batch</span></div><div class="line"><span class="number">7</span>:         previousBatch.executeBatchIfNotAlreadyStarted();</div><div class="line"><span class="number">8</span>:     &#125;</div><div class="line"><span class="number">9</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 5 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿®æ”¹ <code>batch</code> ï¼Œä¿è¯å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹å®‰å…¨ã€‚åŒæ—¶æ³¨æ„ï¼Œæ­¤å¤„ä¹Ÿè¿›è¡Œäº†<strong>æ–°çš„</strong> RequestBatch ï¼Œåˆ‡æ¢æ‰<strong>è€çš„</strong> RequestBatch ã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šä½¿ç”¨<strong>è€çš„</strong> RequestBatch ï¼Œè°ƒç”¨ <code>RequestBatch#executeBatchIfNotAlreadyStarted()</code> æ–¹æ³•ï¼Œå‘½ä»¤åˆå¹¶æ‰§è¡Œã€‚</li></ul><hr><p><code>RequestBatch#executeBatchIfNotAlreadyStarted()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchIfNotAlreadyStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">/*</span></div><div class="line"><span class="comment">  3:      * - check that we only execute once since there's multiple paths to do so (timer, waiting thread or max batch size hit)</span></div><div class="line"><span class="comment">  4:      * - close the gate so 'offer' can no longer be invoked and we turn those threads away so they create a new batch</span></div><div class="line"><span class="comment">  5:      */</span></div><div class="line">  <span class="number">6</span>:     <span class="comment">// è®¾ç½® æ‰§è¡Œå·²ç»å¼€å§‹</span></div><div class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (batchStarted.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">  <span class="number">8</span>:         <span class="comment">// è·å¾— å†™é”</span></div><div class="line">  <span class="number">9</span>:         <span class="comment">/* wait for 'offer'/'remove' threads to finish before executing the batch so 'requests' is complete */</span></div><div class="line"> <span class="number">10</span>:         batchLock.writeLock().lock();</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">13</span>:             <span class="comment">// å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚åˆ†ç‰‡æˆ N ä¸ªã€å¤šä¸ªå‘½ä»¤è¯·æ±‚ã€‘ã€‚</span></div><div class="line"> <span class="number">14</span>:             <span class="comment">// shard batches</span></div><div class="line"> <span class="number">15</span>:             Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shards = commandCollapser.shardRequests(argumentMap.values());</div><div class="line"> <span class="number">16</span>:             <span class="comment">// for each shard execute its requests </span></div><div class="line"> <span class="number">17</span>:             <span class="keyword">for</span> (<span class="keyword">final</span> Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; shardRequests : shards) &#123;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:                     <span class="comment">// å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚åˆå¹¶ï¼Œåˆ›å»ºä¸€ä¸ª HystrixCommand</span></div><div class="line"> <span class="number">20</span>:                     <span class="comment">// create a new command to handle this batch of requests</span></div><div class="line"> <span class="number">21</span>:                     Observable&lt;BatchReturnType&gt; o = commandCollapser.createObservableCommand(shardRequests);</div><div class="line"> <span class="number">22</span>: </div><div class="line"> <span class="number">23</span>:                     <span class="comment">// å°†ä¸€ä¸ª HystrixCommand çš„æ‰§è¡Œç»“æœï¼Œæ˜ å°„å›å¯¹åº”çš„å‘½ä»¤è¯·æ±‚ä»¬</span></div><div class="line"> <span class="number">24</span>:                     commandCollapser.mapResponseToRequests(o, shardRequests).doOnError(<span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:                         <span class="comment">/**</span></div><div class="line"><span class="comment"> 27:                          * This handles failed completions</span></div><div class="line"><span class="comment"> 28:                          */</span></div><div class="line"> <span class="number">29</span>:                         <span class="meta">@Override</span></div><div class="line"> <span class="number">30</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"> <span class="number">31</span>:                             <span class="comment">// handle Throwable in case anything is thrown so we don't block Observers waiting for onError/onCompleted</span></div><div class="line"> <span class="number">32</span>:                             Exception ee;</div><div class="line"> <span class="number">33</span>:                             <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Exception) &#123;</div><div class="line"> <span class="number">34</span>:                                 ee = (Exception) e;</div><div class="line"> <span class="number">35</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">36</span>:                                 ee = <span class="keyword">new</span> RuntimeException(<span class="string">"Throwable caught while executing batch and mapping responses."</span>, e);</div><div class="line"> <span class="number">37</span>:                             &#125;</div><div class="line"> <span class="number">38</span>:                             logger.debug(<span class="string">"Exception mapping responses to requests."</span>, e);</div><div class="line"> <span class="number">39</span>:                             <span class="comment">// if a failure occurs we want to pass that exception to all of the Futures that we've returned</span></div><div class="line"> <span class="number">40</span>:                             <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : argumentMap.values()) &#123;</div><div class="line"> <span class="number">41</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">42</span>:                                     ((CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;) request).setExceptionIfResponseNotReceived(ee);</div><div class="line"> <span class="number">43</span>:                                 &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">44</span>:                                     <span class="comment">// if we have partial responses set in mapResponseToRequests</span></div><div class="line"> <span class="number">45</span>:                                     <span class="comment">// then we may get IllegalStateException as we loop over them</span></div><div class="line"> <span class="number">46</span>:                                     <span class="comment">// so we'll log but continue to the rest</span></div><div class="line"> <span class="number">47</span>:                                     logger.error(<span class="string">"Partial success of 'mapResponseToRequests' resulted in IllegalStateException while setting Exception. Continuing ... "</span>, e2);</div><div class="line"> <span class="number">48</span>:                                 &#125;</div><div class="line"> <span class="number">49</span>:                             &#125;</div><div class="line"> <span class="number">50</span>:                         &#125;</div><div class="line"> <span class="number">51</span>: </div><div class="line"> <span class="number">52</span>:                     &#125;).doOnCompleted(<span class="keyword">new</span> Action0() &#123;</div><div class="line"> <span class="number">53</span>: </div><div class="line"> <span class="number">54</span>:                         <span class="comment">/**</span></div><div class="line"><span class="comment"> 55:                          * This handles successful completions</span></div><div class="line"><span class="comment"> 56:                          */</span></div><div class="line"> <span class="number">57</span>:                         <span class="meta">@Override</span></div><div class="line"> <span class="number">58</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">59</span>:                             <span class="comment">// check that all requests had setResponse or setException invoked in case 'mapResponseToRequests' was implemented poorly</span></div><div class="line"> <span class="number">60</span>:                             Exception e = <span class="keyword">null</span>;</div><div class="line"> <span class="number">61</span>:                             <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : shardRequests) &#123;</div><div class="line"> <span class="number">62</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">63</span>:                                    e = ((CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;) request).setExceptionIfResponseNotReceived(e,<span class="string">"No response set by "</span> + commandCollapser.getCollapserKey().name() + <span class="string">" 'mapResponseToRequests' implementation."</span>);</div><div class="line"> <span class="number">64</span>:                                 &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">65</span>:                                     logger.debug(<span class="string">"Partial success of 'mapResponseToRequests' resulted in IllegalStateException while setting 'No response set' Exception. Continuing ... "</span>, e2);</div><div class="line"> <span class="number">66</span>:                                 &#125;</div><div class="line"> <span class="number">67</span>:                             &#125;</div><div class="line"> <span class="number">68</span>:                         &#125;</div><div class="line"> <span class="number">69</span>: </div><div class="line"> <span class="number">70</span>:                     &#125;).subscribe();</div><div class="line"> <span class="number">71</span>:                     </div><div class="line"> <span class="number">72</span>:                 &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">73</span>:                     <span class="comment">// å¼‚å¸¸</span></div><div class="line"> <span class="number">74</span>:                     logger.error(<span class="string">"Exception while creating and queueing command with batch."</span>, e);</div><div class="line"> <span class="number">75</span>:                     <span class="comment">// if a failure occurs we want to pass that exception to all of the Futures that we've returned</span></div><div class="line"> <span class="number">76</span>:                     <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : shardRequests) &#123;</div><div class="line"> <span class="number">77</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">78</span>:                             request.setException(e);</div><div class="line"> <span class="number">79</span>:                         &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">80</span>:                             logger.debug(<span class="string">"Failed trying to setException on CollapsedRequest"</span>, e2);</div><div class="line"> <span class="number">81</span>:                         &#125;</div><div class="line"> <span class="number">82</span>:                     &#125;</div><div class="line"> <span class="number">83</span>:                 &#125;</div><div class="line"> <span class="number">84</span>:             &#125;</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">87</span>:             <span class="comment">// å¼‚å¸¸</span></div><div class="line"> <span class="number">88</span>:             logger.error(<span class="string">"Exception while sharding requests."</span>, e);</div><div class="line"> <span class="number">89</span>:             <span class="comment">// same error handling as we do around the shards, but this is a wider net in case the shardRequest method fails</span></div><div class="line"> <span class="number">90</span>:             <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : argumentMap.values()) &#123;</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">92</span>:                     request.setException(e);</div><div class="line"> <span class="number">93</span>:                 &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">94</span>:                     logger.debug(<span class="string">"Failed trying to setException on CollapsedRequest"</span>, e2);</div><div class="line"> <span class="number">95</span>:                 &#125;</div><div class="line"> <span class="number">96</span>:             &#125;</div><div class="line"> <span class="number">97</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">98</span>:             batchLock.writeLock().unlock();</div><div class="line"> <span class="number">99</span>:         &#125;</div><div class="line"><span class="number">100</span>:     &#125;</div><div class="line"><span class="number">101</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰ç‚¹é•¿å“ˆï¼Œè¯·å¯¹ç…§ç€å®˜æ–¹ç¤ºä¾‹ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandCollapserGetValueForKey.java" rel="external nofollow noopener noreferrer" target="_blank">CommandCollapserGetValueForKey</a> ä¸€èµ·çœ‹ï¼Œä¸´é—¨ä¸€è„šäº†ï¼Œèƒ–å‹ï¼</li><li>ç¬¬ 7 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿®æ”¹ <code>batchStarted</code> ï¼Œä¿è¯å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹å®‰å…¨ã€‚</li><li>ç¬¬ 10 è¡Œ ï¼šè·å¾—<strong>å†™é”</strong>ã€‚ç­‰å¾…è°ƒç”¨ <code>#offer(...)</code>/<code>#remove(...)</code> æ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œä»¥ä¿è¯å‘½ä»¤åˆå¹¶æ‰§è¡Œæ—¶ï¼Œä¸å†æœ‰æ–°çš„è¯·æ±‚æ·»åŠ æˆ–ç§»é™¤ã€‚</li><li>ç¬¬ 15 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCollapserBridge#shardRequests(...)</code> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆ†ç‰‡</strong>æˆ <strong>N</strong> ä¸ªã€<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‘ã€‚é»˜è®¤å®ç°ä¸‹ï¼Œä¸è¿›è¡Œåˆ†ç‰‡ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L146" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>ç¬¬ 17 è¡Œ ï¼šå¾ªç¯ <strong>N</strong> ä¸ªã€<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‘ã€‚</li><li>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCollapserBridge#createObservableCommand(...)</code> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆå¹¶</strong>ï¼Œåˆ›å»º<strong>ä¸€ä¸ª</strong> HystrixCommand ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L156" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>ç¬¬ 24 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCollapserBridge#mapResponseToRequests(...)</code> æ–¹æ³•ï¼Œå°†<strong>ä¸€ä¸ª</strong> HystrixCommand çš„æ‰§è¡Œç»“æœï¼Œ<strong>æ˜ å°„</strong>å›å¯¹åº”çš„å‘½ä»¤è¯·æ±‚ä»¬ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L166" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚<ul><li><code>Observable#single()</code> æ–¹æ³•ï¼Œå¦‚æœ Observable ç»ˆæ­¢æ—¶åªå‘å°„äº†ä¸€ä¸ªå€¼ï¼Œè¿”å›é‚£ä¸ªå€¼ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚åœ¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/First.html#single" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€Œsingleã€</a> æœ‰ç›¸å…³åˆ†äº«ã€‚</li><li><code>Observable#ignoreElements()</code> æ–¹æ³•ï¼ŒæŠ‘åˆ¶åŸå§‹ Observable å‘å°„çš„æ‰€æœ‰æ•°æ®ï¼Œåªå…è®¸å®ƒçš„ç»ˆæ­¢é€šçŸ¥ï¼ˆ<code>#onError()</code> æˆ– <code>#onCompleted()</code>ï¼‰é€šè¿‡ã€‚åœ¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/IgnoreElements.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€ŒIgnoreElementsã€</a> æœ‰ç›¸å…³åˆ†äº«ã€‚ä¹Ÿæ¨èç‚¹å‡» <a href="https://github.com/ReactiveX/RxJava/blob/6db98f8750f580995657f83b5620b579c97e6a06/src/main/java/rx/internal/operators/OperatorIgnoreElements.java" rel="external nofollow noopener noreferrer" target="_blank"><code>rx.internal.operators.OperatorIgnoreElements</code></a> çœ‹ä¸‹æºç ï¼Œå¯èƒ½æ›´åŠ æ˜“æ‡‚ã€‚</li><li><code>Observable#cast()</code> æ–¹æ³•ï¼Œå°†åŸå§‹ Observable å‘å°„çš„æ¯ä¸€é¡¹æ•°æ®éƒ½å¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ªæŒ‡å®šçš„ç±»å‹ï¼Œç„¶åå†å‘å°„æ•°æ®ï¼Œå®ƒæ˜¯ <code>map</code> çš„ä¸€ä¸ªç‰¹æ®Šç‰ˆæœ¬ã€‚åœ¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Map.html#cast" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€Œcastã€</a> æœ‰ç›¸å…³åˆ†äº«ã€‚ä¹Ÿæ¨èç‚¹å‡» <a href="https://github.com/ReactiveX/RxJava/blob/6db98f8750f580995657f83b5620b579c97e6a06/src/main/java/rx/internal/operators/OperatorCast.java" rel="external nofollow noopener noreferrer" target="_blank"><code>rx.internal.operators.OperatorCast</code></a> çœ‹ä¸‹æºç ï¼Œå¯èƒ½æ›´åŠ æ˜“æ‡‚ã€‚</li><li>ä½¿ç”¨ <code>Observable#ignoreElements()</code>/<code>Observable#cast()</code> æ–¹æ³•ï¼Œç”¨äºå°† Observable å˜æˆä¸å†ç»§ç»­å‘ä¸‹å‘å°„æ•°æ®é¡¹ï¼Œåªç»™ç°æœ‰æ–¹æ³•é‡Œ <code>Observable#doNext()</code> å¤„ç†æ•°æ®é¡¹ï¼Œè°ƒç”¨ <code>HystrixCollapser#mapResponseToRequests(...)</code> æ–¹æ³•ã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/CollapsedRequestSubject.java#L101" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> ï¼ŒæŸ¥çœ‹ <code>CollapsedRequestSubject#setResponse(response)</code> æ–¹æ³•çš„ä»£ç ã€‚</li></ul></li><li>ç¬¬ 24 è‡³ 50 è¡Œ ï¼šè°ƒç”¨ <code>Observable#doError(Action1)</code> æ–¹æ³•ï¼Œå½“å‘½ä»¤åˆå¹¶æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè®¾ç½®<strong>æ¯ä¸ª</strong> CollapsedRequestSubject çš„æ‰§è¡Œç»“æœä¸ºå¼‚å¸¸ã€‚<ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/CollapsedRequestSubject.java#L137" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ï¼ŒæŸ¥çœ‹ <code>CollapsedRequestSubject#setResponse(response)</code> æ–¹æ³•çš„ä»£ç ã€‚</li></ul></li><li>ç¬¬ 52 è‡³ 68 è¡Œ ï¼šè°ƒç”¨ <code>Observable#doOnCompleted(Action0)</code> æ–¹æ³•ï¼Œå½“å‘½ä»¤åˆå¹¶æ‰§è¡Œå®Œæˆæ—¶ï¼Œæ£€æŸ¥<strong>æ¯ä¸ª</strong> CollapsedRequestSubject æ˜¯å¦éƒ½æœ‰è¿”å›ç»“æœã€‚è®¾ç½®æ²¡æœ‰è¿”å›ç»“æœçš„ CollapsedRequestSubject çš„æ‰§è¡Œç»“æœä¸ºå¼‚å¸¸ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯ç”¨æˆ·å®ç° <code>HystrixCollapser#mapResponseToRequests(...)</code> æ–¹æ³•å­˜åœ¨ BUG ã€‚å¦å¤–ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œå°†å¯¼è‡´æ— ç»“æœçš„<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>æ— é™é˜»å¡</strong>ã€‚</li><li>ç¬¬ 70 è¡Œ ï¼šè°ƒç”¨ <code>Observable#subscribe()</code> æ–¹æ³•ï¼Œ<strong>è§¦å‘</strong> HystrixCommand æ‰§è¡Œã€‚</li><li>ç¬¬ 72 è‡³ 96 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè®¾ç½®<strong>æ¯ä¸ª</strong> CollapsedRequestSubject çš„æ‰§è¡Œç»“æœä¸ºå¼‚å¸¸ã€‚<ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/CollapsedRequestSubject.java#L170" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ï¼ŒæŸ¥çœ‹ <code>CollapsedRequestSubject#setException(response)</code> æ–¹æ³•çš„ä»£ç ã€‚</li></ul></li><li>ç¬¬ 97 è‡³ 99 è¡Œ ï¼šé‡Šæ”¾<strong>å†™é”</strong>ã€‚</li></ul><h1 id="5-CollapserTimer"><a href="#5-CollapserTimer" class="headerlink" title="5. CollapserTimer"></a>5. CollapserTimer</h1><p><code>com.netflix.hystrix.collapser.CollapserTimer</code> ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº†<strong>æäº¤å®šæ—¶ç›‘å¬å™¨ï¼Œç”Ÿæˆå®šæ—¶ä»»åŠ¡</strong>çš„æ¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CollapserTimer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Reference&lt;TimerListener&gt; <span class="title">addListener</span><span class="params">(TimerListener collapseTask)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="5-1-RealCollapserTimer"><a href="#5-1-RealCollapserTimer" class="headerlink" title="5.1 RealCollapserTimer"></a>5.1 RealCollapserTimer</h2><p><code>com.netflix.hystrix.collapser.RealCollapserTimer</code> ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨<strong>å®ç°ç±»</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealCollapserTimer</span> <span class="keyword">implements</span> <span class="title">CollapserTimer</span> </span>&#123;</div><div class="line">    <span class="comment">/* single global timer that all collapsers will schedule their tasks on */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HystrixTimer timer = HystrixTimer.getInstance();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Reference&lt;TimerListener&gt; <span class="title">addListener</span><span class="params">(TimerListener collapseTask)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> timer.addTimerListener(collapseTask);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å®é™…ä¸Šï¼Œä½¿ç”¨çš„æ˜¯ HystrixTimer æä¾›çš„å•ä¾‹ã€‚åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹ã€Œ3. HystrixTimer<br>ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h2 id="5-2-CollapsedTask"><a href="#5-2-CollapsedTask" class="headerlink" title="5.2 CollapsedTask"></a>5.2 CollapsedTask</h2><p><code>com.netflix.hystrix.collapser.RequestCollapser.CollapsedTask</code> ï¼Œå®šæ—¶ä»»åŠ¡ï¼Œå›ºå®šå‘¨æœŸ( å¯é…ï¼Œé»˜è®¤ <code>HystrixCollapserProperties.timerDelayInMilliseconds = 10ms</code> ) è½®è¯¢å…¶å¯¹åº”çš„<strong>ä¸€ä¸ª</strong> RequestCollapser <strong>å½“å‰</strong> RequestBatch ã€‚è‹¥æœ‰å‘½ä»¤éœ€è¦æ‰§è¡Œï¼Œåˆ™æäº¤ RequestCollapser åˆå¹¶æ‰§è¡Œã€‚</p><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/RequestCollapser.java#L138" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> ç›´æ¥çœ‹ä»£ç ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="çŸ¥è¯†æ˜Ÿçƒ"></p><p>T T ä¸€å¼€å§‹æŠŠå‘½ä»¤åˆå¹¶æ‰§è¡Œï¼Œç†è§£æˆç±»ä¼¼çº¿ç¨‹æ± æ‰¹é‡æ‰§è¡Œä»»åŠ¡ï¼Œæ€ä¹ˆçœ‹å®˜æ–¹ç¤ºä¾‹ï¼Œæ€ä¹ˆå¥‡æ€ªã€‚æœ‰ä¸€æ ·çš„åŒå­¦ï¼Œä¸€èµ·æ³ªç›® + æ¡çˆªä¸‹ã€‚</p><p>æœ¬æ–‡æœ‰ç‚¹ç‚¹é•¿ï¼Œå®åœ¨ä¸æƒ³æ‹†åˆ†æˆå¤šç¯‡ã€‚</p><p>æ©ï¼Œå¦å¤–éƒ¨åˆ†åœ°æ–¹å†™çš„ä¸å¤Ÿæ¸…æ™°ï¼Œæ¬¢è¿ä¸€èµ·è®¨è®ºå’Œä¼˜åŒ–ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Hystrix/">Hystrix</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Hystrix/command-collapser-execute/" data-title="Hystrix æºç è§£æ â€”â€” å‘½ä»¤åˆå¹¶æ‰§è¡Œ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Hystrix/circuit-breaker/" title="Hystrix æºç è§£æ â€”â€” æ–­è·¯å™¨ HystrixCircuitBreaker"><strong>PREVIOUS:</strong><br><span>Hystrix æºç è§£æ â€”â€” æ–­è·¯å™¨ HystrixCircuitBreaker</span></a></div><div class="next"><a href="/Hystrix/command-execute-fourth-fallback/" title="Hystrix æºç è§£æ â€”â€” è¯·æ±‚æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘"><strong>NEXT:</strong><br><span>Hystrix æºç è§£æ â€”â€” è¯·æ±‚æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-HystrixCollapser"><span class="toc-number">2.</span> <span class="toc-text">2. HystrixCollapser</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-æ„é€ æ–¹æ³•"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-æ‰§è¡Œå‘½ä»¤æ–¹å¼"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 æ‰§è¡Œå‘½ä»¤æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-æ ¸å¿ƒæ–¹æ³•"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 æ ¸å¿ƒæ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-RequestCollapserFactory"><span class="toc-number">3.</span> <span class="toc-text">3. RequestCollapserFactory</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-RequestCollapser"><span class="toc-number">4.</span> <span class="toc-text">4. RequestCollapser</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-æ„é€ æ–¹æ³•"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-RequestBatch"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 RequestBatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-submitRequest-arg"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 #submitRequest(arg)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-createNewBatchAndExecutePreviousIfNeeded-previousBatch"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-CollapserTimer"><span class="toc-number">5.</span> <span class="toc-text">5. CollapserTimer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-RealCollapserTimer"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 RealCollapserTimer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-CollapsedTask"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 CollapsedTask</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">6.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>2</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å…«/" title="èŠ‹é“æºç çš„å‘¨å…«">èŠ‹é“æºç çš„å‘¨å…«<sup>12</sup></a></li></ul></div><div id="authorInfo2"><div><img width="100%" src="/images/common/zsxq/02.png"></div></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2"),ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>