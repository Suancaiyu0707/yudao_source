<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ® | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-store-trace/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº SkyWalking 3.2.6 æ­£å¼ç‰ˆ

1. æ¦‚è¿°
2. SpanListener
3. GlobalTrace"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/SkyWalking/collector-store-trace/" title="SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®" itemprop="url">SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-store-trace/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº SkyWalking 3.2.6 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">2. SpanListener</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">3. GlobalTrace</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">4. InstPerformance</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">5. SegmentCost</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">6. NodeComponent</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">7. NodeMapping</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">8. NodeReference</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">9. ServiceEntry</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">10. ServiceReference</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">11. Segment</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œé“¾è·¯çš„è¿½è¸ªå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Agent æ”¶é›† Trace æ•°æ®ã€‚</li><li>Agent å‘é€ Trace æ•°æ®ç»™ Collector ã€‚</li><li>Collector æ¥æ”¶ Trace æ•°æ®ã€‚</li><li><strong>Collector å­˜å‚¨ Trace æ•°æ®åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼Œæ•°æ®åº“</strong>ã€‚</li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†äº«ã€ç¬¬å››éƒ¨åˆ†ã€‘ <strong>SkyWalking Collector å­˜å‚¨ Trace æ•°æ®</strong>ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šCollector æ¥æ”¶åˆ° TraceSegment çš„æ•°æ®ï¼Œå¯¹åº”çš„ç±»æ˜¯ Protobuf ç”Ÿæˆçš„ã€‚è€ƒè™‘åˆ°æ›´åŠ æ˜“è¯»æ˜“æ‡‚ï¼Œæœ¬æ–‡ä½¿ç”¨ TraceSegment ç›¸å…³çš„<strong>åŸå§‹ç±»</strong>ã€‚</p></blockquote><p>Collector åœ¨æ¥æ”¶åˆ° Trace æ•°æ®åï¼Œç»è¿‡<strong>æµå¼å¤„ç†</strong>ï¼Œæœ€ç»ˆ<strong>å­˜å‚¨</strong>åˆ°å­˜å‚¨å™¨ã€‚å¦‚ä¸‹å›¾ï¼Œ<strong>çº¢åœˆéƒ¨åˆ†</strong>ï¼Œä¸ºæœ¬æ–‡åˆ†äº«çš„å†…å®¹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/01.jpeg" alt=""></p><h1>2. SpanListener</h1><p>åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° <a href="https://github.com/YunaiV/skywalking/blob/428190e783d887c8240546f321e76e0a6b5f5d18/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentParse#parse(UpstreamSegment, Source)</code></a> æ–¹æ³•ä¸­ï¼š</p><ul><li>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/428190e783d887c8240546f321e76e0a6b5f5d18/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>#preBuild(List&lt;UniqueId&gt;, SegmentDecorator)</code></a> æ–¹æ³•ä¸­ï¼Œé¢„æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ Span ç›‘å¬å™¨ä»¬ï¼Œä» TraceSegment è§£æå‡ºä¸åŒçš„æ•°æ®ã€‚</li><li>åœ¨<strong>é¢„æ„å»º</strong>æˆåŠŸåï¼Œé€šçŸ¥ Span ç›‘å¬å™¨ä»¬ï¼Œå»æ„å»ºå„è‡ªçš„æ•°æ®ï¼Œç»è¿‡<strong>æµå¼å¤„ç†</strong>ï¼Œæœ€ç»ˆ<strong>å­˜å‚¨</strong>åˆ°å­˜å‚¨å™¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.SpanListener</code></a> ï¼ŒSpan ç›‘å¬å™¨<strong>æ¥å£</strong>ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SpanListener.java#L28" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºæ•°æ®ï¼Œæ‰§è¡Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆå­˜å‚¨åˆ°å­˜å‚¨å™¨ã€‚</li></ul><p>SpanListener çš„å­ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/02.png" alt=""></p><ul><li>ç¬¬ä¸€å±‚ï¼Œé€šç”¨æ¥å£å±‚ï¼Œå®šä¹‰äº†ä» TraceSegment è§£ææ•°æ®çš„æ–¹æ³•ã€‚<ul><li>â‘  <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/GlobalTraceIdsListener.java" rel="external nofollow noopener noreferrer" target="_blank">GlobalTraceSpanListener</a> ï¼šè§£æé“¾è·¯è¿½è¸ªå…¨å±€ç¼–å·æ•°ç»„( <code>TraceSegment.relatedGlobalTraces</code> )ã€‚</li><li>â‘¡ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/RefsListener.java" rel="external nofollow noopener noreferrer" target="_blank">RefsListener</a> ï¼šè§£æçˆ¶ Segment æŒ‡å‘æ•°ç»„( <code>TraceSegment.refs</code> )ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/FirstSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">FirstSpanListener</a> ï¼šè§£æ<strong>ç¬¬ä¸€ä¸ª</strong> Span (<code>TraceSegment.spans[0]</code>) ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/EntrySpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">EntrySpanListener</a> ï¼šè§£æ EntrySpan (<code>TraceSegment.spans</code>)ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/LocalSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">LocalSpanListener</a> ï¼šè§£æ LocalSpan (<code>TraceSegment.spans</code>)ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/ExitSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">ExitSpanListener</a> ï¼šè§£æ ExitSpan (<code>TraceSegment.spans</code>)ã€‚</li></ul></li><li>ç¬¬äºŒå±‚ï¼Œä¸šåŠ¡å®ç°å±‚ï¼Œæ¯ä¸ªå®ç°ç±»å¯¹åº”ä¸€ä¸ªæ•°æ®å®ä½“ç±»ï¼Œä¸€ä¸ª Graph å¯¹è±¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/03.png" alt=""></li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»¥æ¯ä¸ªæ•°æ®å®ä½“ç±»ä¸ºä¸­å¿ƒï¼Œé€ä¸ªåˆ†äº«ã€‚</p><h1>3. GlobalTrace</h1><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/global/GlobalTrace.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.global.GlobalTrace</code></a> ï¼Œå…¨å±€é“¾è·¯è¿½è¸ªï¼Œè®°å½•ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ŒåŒ…æ‹¬çš„ TraceSegment ç¼–å·ã€‚</p><ul><li>GlobalTrace : TraceSegment = N : M ï¼Œä¸€ä¸ª GlobalTrace å¯ä»¥æœ‰å¤šä¸ª TraceSegment ï¼Œä¸€ä¸ª TraceSegment å¯ä»¥å…³è”å¤šä¸ª GlobalTrace ã€‚å‚è§ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®ã€‹ã€Œ2. Traceã€</a> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/global/GlobalTraceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.global.GlobalTraceTable</code></a> ï¼Œ GlobalTrace è¡¨( <code>global_trace</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>global_trace_id</code> ï¼šå…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ã€‚</li><li><code>segment_id</code> ï¼šTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GlobalTraceEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.GlobalTraceEsPersistenceDAO</code></a> ï¼ŒGlobalTrace çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/04.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.global.GlobalTraceSpanListener</code></a> ï¼Œ<strong>GlobalTrace çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€GlobalTraceIdsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>globalTraceIds</code> å±æ€§ï¼Œå…¨å±€é“¾è·¯è¿½è¸ªç¼–å·<strong>æ•°ç»„</strong>ã€‚</li><li><code>segmentId</code> å±æ€§ï¼ŒTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» Span ä¸­è§£æåˆ° <code>segmentId</code> ï¼Œ<code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseGlobalTraceId(UniqueId)</code></a> æ–¹æ³•ï¼Œè§£æå…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ï¼Œæ·»åŠ åˆ° <code>globalTraceIds</code> æ•°ç»„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– GlobalTrace å¯¹åº”çš„ <code>Graph&lt;GlobalTrace&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>globalTraceIds</code> æ•°ç»„ï¼Œåˆ›å»º GlobalTrace å¯¹è±¡ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(application)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ GlobalTrace åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L93" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createGlobalTraceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° GlobalTrace å¯¹åº”çš„ <code>Graph&lt;GlobalTrace&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.global.GlobalTracePersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒGlobalTrace <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java#L51" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>PersistenceWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ4. PersistenceWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 120 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>false</code> ï¼Œå­˜å‚¨æ—¶ï¼Œä¸éœ€è¦åˆå¹¶æ•°æ®ã€‚GlobalTrace åªæœ‰æ–°å¢æ“ä½œï¼Œæ²¡æœ‰æ›´æ–°æ“ä½œï¼Œå› æ­¤æ— éœ€åˆå¹¶æ•°æ®ã€‚</li></ul></li></ul><h1>4. InstPerformance</h1><blockquote><p>æ—ç™½å›ï¼šInstPerformance å’Œ GlobalTrace æ•´ä½“æ¯”è¾ƒç›¸ä¼¼ï¼Œåˆ†äº«çš„ä¼šæ¯”è¾ƒç®€æ´ä¸€äº›ã€‚</p></blockquote><p><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/instance/InstPerformance.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.instance.InstPerformance</code></a> ï¼Œåº”ç”¨å®ä¾‹æ€§èƒ½ï¼Œè®°å½•åº”ç”¨å®ä¾‹<strong>æ¯ç§’</strong>çš„è¯·æ±‚æ€»æ¬¡æ•°ï¼Œè¯·æ±‚æ€»æ—¶é•¿ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/instance/InstPerformanceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.instance.InstPerformanceTable</code></a> ï¼Œ GlobalTrace è¡¨( <code>global_trace</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>application_id</code> ï¼šåº”ç”¨ç¼–å·ã€‚</li><li><code>instance_id</code> ï¼šåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>calls</code> ï¼šè°ƒç”¨æ€»æ¬¡æ•°ã€‚</li><li><code>cost_total</code> ï¼šæ¶ˆè€—æ€»æ—¶é•¿ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstPerformanceEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.InstPerformanceEsPersistenceDAO</code></a> ï¼ŒInstPerformance çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/05.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/instance/InstPerformanceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.instance.InstPerformanceSpanListener</code></a> ï¼Œ<strong>InstPerformance çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€EntrySpanListener æ¥å£ã€‚</p><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L101" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createInstPerformanceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° InstPerformance å¯¹åº”çš„ <code>Graph&lt;InstPerformance&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/instance/InstPerformancePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.instance.InstPerformancePersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒInstPerformance <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li>ç±»ä¼¼ GlobalTracePersistenceWorker ï¼Œ... çœç•¥å…¶å®ƒç±»å’Œæ–¹æ³•ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/instance/InstPerformancePersistenceWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>true</code> ï¼Œå­˜å‚¨æ—¶ï¼Œéœ€è¦åˆå¹¶æ•°æ®ã€‚<code>calls</code> ã€<code>cost_total</code> éœ€è¦ç´¯åŠ åˆå¹¶ã€‚</li></ul></li></ul><h1>5. SegmentCost</h1><blockquote><p>æ—ç™½å›ï¼šSegmentCost å’Œ GlobalTrace æ•´ä½“æ¯”è¾ƒç›¸ä¼¼ï¼Œåˆ†äº«çš„ä¼šæ¯”è¾ƒç®€æ´ä¸€äº›ã€‚</p></blockquote><p><a href="https://github.com/YunaiV/skywalking/blob/b8be916ac2bf7817544d6ff77a95a624bcc3efe6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/segment/SegmentCost.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.segment.SegmentCost</code></a> ï¼ŒTraceSegment æ¶ˆè€—æ—¶é•¿ï¼Œè®°å½• TraceSegment å¼€å§‹æ—¶é—´ï¼Œç»“æŸæ—¶é—´ï¼ŒèŠ±è´¹æ—¶é•¿ç­‰ç­‰ã€‚</p><ul><li>SegmentCost : TraceSegment = 1 : 1 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/b8be916ac2bf7817544d6ff77a95a624bcc3efe6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/segment/SegmentCostTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.instance.SegmentCostTable</code></a> ï¼Œ SegmentCostTable è¡¨( <code>segment_cost</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>segment_id</code> ï¼šTraceSegment ç¼–å·ã€‚</li><li><code>application_id</code> ï¼šåº”ç”¨ç¼–å·ã€‚</li><li><code>start_time</code> ï¼šå¼€å§‹æ—¶é—´ã€‚</li><li><code>end_time</code> ï¼šç»“æŸæ—¶é—´ã€‚</li><li><code>service_name</code> ï¼šæ“ä½œåã€‚</li><li><code>cost</code> ï¼šæ¶ˆè€—æ—¶é•¿ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentCostEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.SegmentCostEsPersistenceDAO</code></a> ï¼ŒSegmentCost çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/06.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/segment/SegmentCostSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.SegmentCostSpanListener</code></a> ï¼Œ<strong>SegmentCost çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€EntrySpanListener ã€ExitSpanListener ã€LocalSpanListener æ¥å£ã€‚</p><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L172" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createSegmentCostGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° SegmentCost å¯¹åº”çš„ <code>Graph&lt;SegmentCost&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/b8be916ac2bf7817544d6ff77a95a624bcc3efe6/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/segment/SegmentCostPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.SegmentCostPersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒInstPerformance <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li>ç±»ä¼¼ GlobalTracePersistenceWorker ï¼Œ... çœç•¥å…¶å®ƒç±»å’Œæ–¹æ³•ã€‚</li></ul></li></ul><h1>6. NodeComponent</h1><p><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeComponent.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeComponent</code></a> ï¼ŒèŠ‚ç‚¹ç»„ä»¶ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeComponentTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeComponentTable</code></a> ï¼Œ NodeComponentTable è¡¨( <code>node_component</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>component_id</code> ï¼šç»„ä»¶ç¼–å·ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-network/src/main/java/org/skywalking/apm/network/trace/component/ComponentsDefine.java" rel="external nofollow noopener noreferrer" target="_blank">ComponentsDefine</a> çš„æšä¸¾ã€‚</li><li><code>peer_id</code> ï¼šå¯¹ç­‰ç¼–å·ã€‚æ¯ä¸ªç»„ä»¶ï¼Œæˆ–æ˜¯æœåŠ¡æä¾›è€…ï¼Œæœ‰æœåŠ¡åœ°å€ï¼›åˆæˆ–æ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œæœ‰è°ƒç”¨æœåŠ¡åœ°å€ã€‚è¿™ä¸¤è€…éƒ½è„±ç¦»ä¸å¼€<strong>æœåŠ¡åœ°å€</strong>ã€‚SkyWalking å°†<strong>æœåŠ¡åœ°å€</strong>ä½œä¸º <code>applicationCode</code> ï¼Œæ³¨å†Œåˆ° Application ã€‚å› æ­¤ï¼Œæ­¤å¤„çš„ <code>peer_id</code> å®é™…ä¸Šæ˜¯ï¼Œ<strong>æœåŠ¡åœ°å€</strong>å¯¹åº”çš„åº”ç”¨ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeComponentEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.NodeComponentEsPersistenceDAO</code></a> ï¼ŒNodeComponent çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/07.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeComponentSpanListener</code></a> ï¼Œ<strong>NodeComponent çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€EntrySpanListener ã€ExitSpanListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeComponents</code> å±æ€§ï¼ŒèŠ‚ç‚¹ç»„ä»¶<strong>æ•°ç»„</strong>ï¼Œä¸€æ¬¡ TraceSegment å¯ä»¥ç»è¿‡ä¸ªèŠ‚ç‚¹ç»„ä»¶ï¼Œä¾‹å¦‚ SpringMVC =&gt; MongoDB ã€‚</li><li><code>segmentId</code> å±æ€§ï¼ŒTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L65" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» EntrySpan ä¸­è§£æåˆ° <code>segmentId</code> ï¼Œ<code>applicationId</code> ï¼Œåˆ›å»º NodeComponent å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nodeComponents</code> ã€‚<strong>æ³¨æ„</strong>ï¼ŒEntrySpan ä½¿ç”¨ <code>applicationId</code> ä½œä¸º <code>peerId</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseExit(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» ExitSpan ä¸­è§£æåˆ° <code>segmentId</code> ï¼Œ<code>peerId</code> ï¼Œåˆ›å»º NodeComponent å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nodeComponents</code> ã€‚<strong>æ³¨æ„</strong>ï¼ŒExitSpan ä½¿ç”¨ <code>peerId</code> ä½œä¸º <code>peerId</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L78" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ° <code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L83" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– NodeComponent å¯¹åº”çš„ <code>Graph&lt;NodeComponent&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>nodeComponents</code> æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(nodeComponent)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ NodeComponent åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createNodeComponentGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NodeComponent å¯¹åº”çš„ <code>Graph&lt;NodeComponent&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeComponentAggregationWorker</code></a> ï¼Œç»§æ‰¿ AggregationWorker æŠ½è±¡ç±»ï¼ŒNodeComponent èšåˆ Worker ã€‚</p><ul><li>NodeComponent çš„ç¼–å·ç”Ÿæˆè§„åˆ™ä¸º <code>${timeBucket}_${componentId}_${peerId}</code> ï¼Œå¹¶ä¸” <code>timeBucket</code> æ˜¯<strong>åˆ†é’Ÿçº§</strong> ï¼Œå¯ä»¥ä½¿ç”¨ AggregationWorker è¿›è¡Œèšåˆï¼Œåˆå¹¶ç›¸åŒæ“ä½œï¼Œå‡å° Collector å’Œ ES çš„å‹åŠ›ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java#L40" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AggregationWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ3. AggregationWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 106 ã€‚</li></ul></li><li><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryRemoteWorker</code></a> ï¼Œç»§æ‰¿ AbstractRemoteWorker æŠ½è±¡ç±»ï¼Œåº”ç”¨æ³¨å†Œè¿œç¨‹ Worker ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java#L50" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractRemoteWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 AbstractRemoteWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AbstractRemoteWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 AbstractRemoteWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 10002 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#selector</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>Selector.HashCode</code> ã€‚å°†<strong>ç›¸åŒç¼–å·</strong>çš„ NodeComponent å‘ç»™åŒä¸€ä¸ª Collector èŠ‚ç‚¹ï¼Œç»Ÿä¸€å¤„ç†ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Remote è¿œç¨‹é€šä¿¡æœåŠ¡ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryPersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒNodeComponent <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li>ç±»ä¼¼ GlobalTracePersistenceWorker ï¼Œ... çœç•¥å…¶å®ƒç±»å’Œæ–¹æ³•ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryPersistenceWorker.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>true</code> ï¼Œå­˜å‚¨æ—¶ï¼Œéœ€è¦åˆå¹¶æ•°æ®ã€‚</li></ul></li></ul><h1>7. NodeMapping</h1><p><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeComponent.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeComponent</code></a> ï¼ŒèŠ‚ç‚¹åŒ¹é…ï¼Œç”¨äºåŒ¹é…æœåŠ¡æ¶ˆè´¹è€…ä¸æä¾›è€…ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeMappingTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeMappingTable</code></a> ï¼Œ NodeMappingTable è¡¨( <code>node_mapping</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>application_id</code> ï¼šæœåŠ¡æ¶ˆè´¹è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>address_id</code> ï¼šæœåŠ¡æä¾›è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeMappingEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.NodeMappingEsPersistenceDAO</code></a> ï¼ŒNodeMapping çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/08.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingSpanListener</code></a> ï¼Œ<strong>NodeMapping çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeMappings</code> å±æ€§ï¼ŒèŠ‚ç‚¹åŒ¹é…<strong>æ•°ç»„</strong>ï¼Œä¸€æ¬¡ TraceSegment å¯ä»¥ç»è¿‡ä¸ªèŠ‚ç‚¹ç»„ä»¶ï¼Œä¾‹å¦‚è°ƒç”¨å¤šæ¬¡è¿œç¨‹æœåŠ¡ï¼Œæˆ–è€…æ•°æ®åº“ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» TraceSegmentRef ä¸­è§£æåˆ° <code>applicationId</code> ï¼Œ<code>peerId</code> ï¼Œåˆ›å»º NodeMapping å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nodeMappings</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ°<code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– NodeMapping å¯¹åº”çš„ <code>Graph&lt;NodeMapping&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>nodeMappings</code> æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(nodeMapping)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ NodeMapping åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L120" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createNodeMappingGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NodeMapping å¯¹åº”çš„ <code>Graph&lt;NodeMapping&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingPersistenceWorker</code></a></li></ul><h1>8. NodeReference</h1><p><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/noderef/NodeReference.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.noderef.NodeReference</code></a> ï¼ŒèŠ‚ç‚¹è°ƒç”¨ç»Ÿè®¡ï¼Œç”¨äºè®°å½•æœåŠ¡æ¶ˆè´¹è€…å¯¹æœåŠ¡æä¾›è€…çš„è°ƒç”¨ï¼ŒåŸºäº<strong>åº”ç”¨</strong>çº§åˆ«çš„ï¼Œä»¥<strong>åˆ†é’Ÿ</strong>ä¸ºæ—¶é—´æœ€å°ç²’åº¦çš„èšåˆç»Ÿè®¡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/noderef/NodeReferenceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.noderef.NodeReference</code></a> ï¼Œ NodeReference è¡¨( <code>node_reference</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>front_application_id</code> ï¼šæœåŠ¡æ¶ˆè´¹è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>behind_application_id</code> ï¼šæœåŠ¡æä¾›è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>s1_lte</code> ï¼š( 0, 1000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s3_lte</code> ï¼š( 1000, 3000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s5_lte</code> ï¼š( 3000, 5000ms ] çš„è°ƒç”¨æ¬¡æ•°</li><li><code>s5_gt</code> ï¼š( 5000, +âˆ ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>error</code> ï¼šå‘ç”Ÿå¼‚å¸¸çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>summary</code> ï¼šæ€»å…±çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeReferenceEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.NodeReferenceEsPersistenceDAO</code></a> ï¼ŒNodeReference çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/09.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferenceSpanListener</code></a> ï¼Œ<strong>NodeReference çš„ SpanListener</strong> ï¼Œå®ç°äº† EntrySpanListener ã€ExitSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>references</code> å±æ€§ï¼Œ<strong>çˆ¶ TraceSegment</strong> è°ƒç”¨äº§ç”Ÿçš„ NodeReference æ•°ç»„ã€‚</li><li><code>nodeReferences</code> å±æ€§ï¼ŒNodeReference æ•°ç»„ï¼Œæœ€ç»ˆä¼šåŒ…å« <code>references</code> æ•°ç»„ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 106 è‡³ 109 è¡Œï¼šä½¿ç”¨çˆ¶ TraceSegment çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ç¼–å·ï¼Œè‡ªå·±çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æä¾›è€…</strong>åº”ç”¨ç¼–å·ï¼Œåˆ›å»º NodeReference å¯¹è±¡ã€‚</li><li>ç¬¬ 111 è¡Œï¼šå°† NodeReference å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>references</code> ã€‚<strong>æ³¨æ„</strong>ï¼Œæ˜¯ <code>references</code> ï¼Œè€Œä¸æ˜¯ <code>nodeReference</code> ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ä½œä¸ºæœåŠ¡æä¾›è€…ï¼Œ<strong>æ¥å—</strong>è°ƒç”¨ã€‚</li><li>------- <strong>çˆ¶ TraceSegment å­˜åœ¨</strong> --------</li><li>ç¬¬ 79 è‡³ 85 è¡Œï¼š<code>references</code> éç©ºï¼Œè¯´æ˜è¢«çˆ¶ TraceSegment è°ƒç”¨ã€‚å› æ­¤ï¼Œå¾ªç¯ <code>references</code> æ•°ç»„ï¼Œè®¾ç½® <code>id</code> ï¼Œ<code>timeBucket</code> å±æ€§( å› ä¸º <code>timeBucket</code> éœ€è¦ä» EntrySpan ä¸­è·å–ï¼Œæ‰€ä»¥ <code>#parseRef(...)</code> çš„ç›®çš„ï¼Œå°±æ˜¯ä¸´æ—¶å­˜å‚¨çˆ¶ TraceSegment çš„åº”ç”¨ç¼–å·åˆ° <code>references</code> ä¸­ )ã€‚</li><li>ç¬¬ 87 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildserviceSum(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæ·»åŠ åˆ° <code>nodeReferences</code> ä¸­ã€‚</li><li>------- <strong>çˆ¶ TraceSegment ä¸å­˜åœ¨</strong> --------</li><li>ç¬¬ 91 è‡³ 97 è¡Œï¼šä½¿ç”¨ <code>USER_ID</code> çš„åº”ç”¨ç¼–å·( ç‰¹æ®Šï¼Œä»£è¡¨ &quot;<strong>ç”¨æˆ·</strong>&quot; )ä½œä¸ºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ç¼–å·ï¼Œè‡ªå·±çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æä¾›è€…</strong>åº”ç”¨ç¼–å·ï¼Œåˆ›å»º NodeReference å¯¹è±¡ã€‚</li><li>ç¬¬ 99 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildserviceSum(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæ·»åŠ åˆ° <code>nodeReferences</code> ä¸­ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseExit(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ï¼Œ<strong>å‘èµ·</strong>è°ƒç”¨ã€‚</li><li>ç¬¬ 64 è‡³ 71 è¡Œï¼šä½¿ç”¨è‡ªå·±çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ç¼–å·ï¼Œ<code>peerId</code> ä½œä¸ºæœåŠ¡<strong>æä¾›è€…</strong>åº”ç”¨ç¼–å·ï¼Œåˆ›å»º NodeReference å¯¹è±¡ã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildserviceSum(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæ·»åŠ åˆ° <code>nodeReferences</code> ä¸­ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– NodeReference å¯¹åº”çš„ <code>Graph&lt;NodeReference&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>nodeReferences</code> æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(nodeReference)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ NodeReference åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L131" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createNodeReferenceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NodeReference å¯¹åº”çš„ <code>Graph&lt;NodeReference&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferenceAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferenceRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferencePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferencePersistenceWorker</code></a></li></ul><h1>9. ServiceEntry</h1><p><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/service/ServiceEntry.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.service.ServiceEntry</code></a> ï¼Œå…¥å£æ“ä½œã€‚</p><ul><li>ServiceEntry <strong>åªä¿å­˜åˆ†å¸ƒå¼é“¾è·¯çš„å…¥å£æ“ä½œ</strong>ï¼Œä¸åŒäº ServiceName <strong>ä¿å­˜æ‰€æœ‰æ“ä½œ</strong>ï¼Œå³ ServiceEntry æ˜¯ ServiceName çš„<strong>å­é›†</strong>ã€‚<ul><li><strong>æ³¨æ„ï¼Œå­ TraceSegment çš„å…¥å£æ“ä½œä¹Ÿä¸è®°å½•</strong>ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/service/ServiceEntryTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.service.ServiceEntryTable</code></a> ï¼Œ ServiceEntry è¡¨( <code>service_entry</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>application_id</code> ï¼šåº”ç”¨ç¼–å·ã€‚</li><li><code>entry_service_id</code> ï¼šå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>entry_service_name</code> ï¼šå…¥å£æ“ä½œåã€‚</li><li><code>register_time</code> ï¼šæ³¨å†Œæ—¶é—´ã€‚</li><li><code>newest_time</code> ï¼šæœ€åè°ƒç”¨æ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceEntryEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.ServiceEntryEsPersistenceDAO</code></a> ï¼ŒServiceEntry çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/10.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntrySpanListener</code></a> ï¼Œ<strong>ServiceEntry çš„ SpanListener</strong> ï¼Œå®ç°äº† EntrySpanListener ã€FirstSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>hasReference</code> å±æ€§ï¼Œ æ˜¯å¦æœ‰ TraceSegmentRef ã€‚</li><li><code>applicationId</code> å±æ€§ï¼Œåº”ç”¨ç¼–å·ã€‚</li><li><code>entryServiceId</code> å±æ€§ï¼Œå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>entryServiceName</code> å±æ€§ï¼Œå…¥å£æ“ä½œåã€‚</li><li><code>hasEntry</code> å±æ€§ï¼Œæ˜¯å¦æœ‰ EntrySpan ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œæ˜¯å¦æœ‰ TraceSegmentRef ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ° <code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» EntrySpan ä¸­è§£æåˆ° <code>applicationId</code> ã€<code>entryServiceId</code> ã€<code>entryServiceName</code> ã€<code>hasEntry</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 96 è¡Œï¼šåªä¿å­˜åˆ†å¸ƒå¼é“¾è·¯çš„å…¥å£æ“ä½œã€‚</li><li>ç¬¬ 98 è‡³ 103 è¡Œï¼šåˆ›å»º ServiceEntry å¯¹è±¡ã€‚</li><li>ç¬¬ 107 è¡Œï¼šè·å– ServiceEntry å¯¹åº”çš„ <code>Graph&lt;ServiceEntry&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 108 è¡Œï¼šè°ƒç”¨ <code>Graph#start(serviceEntry)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ ServiceEntry åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L142" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createServiceEntryGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ServiceEntry å¯¹åº”çš„ <code>Graph&lt;ServiceEntry&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryPersistenceWorker</code></a></li></ul><h1>10. ServiceReference</h1><p><a href="https://github.com/YunaiV/skywalking/blob/288d70975ed1c5f1ecfb7d51e2233ec75ad8d12a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/serviceref/ServiceReference.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.serviceref.ServiceReference</code></a> ï¼Œå…¥å£æ“ä½œè°ƒç”¨ç»Ÿè®¡ï¼Œç”¨äºè®°å½•å…¥å£æ“ä½œçš„è°ƒç”¨ï¼ŒåŸºäº<strong>å…¥å£æ“ä½œ</strong>çº§åˆ«çš„ï¼Œä»¥<strong>åˆ†é’Ÿ</strong>ä¸ºæ—¶é—´æœ€å°ç²’åº¦çš„èšåˆç»Ÿè®¡ã€‚</p><ul><li>å’Œ NodeReference ç±»ä¼¼ã€‚</li><li><strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„çš„ &quot;<strong>å…¥å£æ“ä½œ</strong>&quot; ä¸åŒäº ServiceEntry ï¼Œ<strong>åŒ…å«</strong>æ¯ä¸€æ¡ TraceSegment çš„å…¥å£æ“ä½œã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/288d70975ed1c5f1ecfb7d51e2233ec75ad8d12a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/serviceref/ServiceReferenceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.serviceref.ServiceReferenceTable</code></a> ï¼Œ ServiceReference è¡¨( <code>service_reference</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>entry_service_id</code> ï¼šå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>front_service_id</code> ï¼šæœåŠ¡æ¶ˆè´¹è€…æ“ä½œç¼–å·ã€‚</li><li><code>behind_service_id</code> ï¼šæœåŠ¡æä¾›è€…æ“ä½œç¼–å·ã€‚</li><li><code>s1_lte</code> ï¼š( 0, 1000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s3_lte</code> ï¼š( 1000, 3000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s5_lte</code> ï¼š( 3000, 5000ms ] çš„è°ƒç”¨æ¬¡æ•°</li><li><code>s5_gt</code> ï¼š( 5000, +âˆ ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>error</code> ï¼šå‘ç”Ÿå¼‚å¸¸çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>summary</code> ï¼šæ€»å…±çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>cost_summary</code> ï¼šæ€»å…±çš„èŠ±è´¹æ—¶é—´ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceReference.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.ServiceReference</code></a> ï¼ŒServiceReference çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/11.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.ServiceReferenceSpanListener</code></a> ï¼Œ<strong>ServiceReference çš„ SpanListener</strong> ï¼Œå®ç°äº† EntrySpanListener ã€FirstSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>referenceServices</code> å±æ€§ï¼ŒReferenceDecorator æ•°ç»„ï¼Œè®°å½• TraceSegmentRef æ•°ç»„ã€‚</li><li><code>serviceId</code> å±æ€§ï¼Œå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>startTime</code> å±æ€§ï¼Œå¼€å§‹æ—¶é—´ã€‚</li><li><code>endTime</code> å±æ€§ï¼Œç»“æŸæ—¶é—´ã€‚</li><li><code>isError</code> å±æ€§ï¼Œæ˜¯å¦æœ‰é”™è¯¯ã€‚</li><li><code>hasEntry</code> å±æ€§ï¼Œæ˜¯å¦æœ‰ SpanEntry ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œå°† TraceSegmentRef æ·»åŠ åˆ° <code>referenceServices</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ° <code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» EntrySpan ä¸­è§£æ <code>serviceId</code> ã€<code>startTime</code> ã€<code>endTime</code> ã€<code>isError</code> ã€<code>hasEntry</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L112" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 114 è¡Œï¼šåˆ¤æ–­ <code>hasEntry = true</code> ï¼Œå­˜åœ¨ EntrySpan ã€‚</li><li>--------- <strong>æœ‰ TraceSegmentRef</strong> ---------</li><li>ç¬¬ 117 è‡³ 120 è¡Œï¼šåˆ›å»º ServiceReference å¯¹è±¡ï¼Œå…¶ä¸­ï¼š<ul><li><code>entryServiceId</code> ï¼šTraceSegmentRef çš„å…¥å£ç¼–å·ã€‚</li><li><code>frontServiceId</code> ï¼šTraceSegmentRef çš„æ“ä½œç¼–å·ã€‚</li><li><code>behindServiceId</code> ï¼š è‡ªå·± EntrySpan çš„æ“ä½œç¼–å·ã€‚</li></ul></li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#calculateCost(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ã€‚</li><li>ç¬¬ 126 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L141" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToAggregationWorker(...)</code></a> æ–¹æ³•ï¼Œå‘é€ ServiceReference ç»™ AggregationWorker ï¼Œæ‰§è¡Œæµå¼å¤„ç†ã€‚</li><li>--------- <strong>æ—  TraceSegmentRef</strong> ---------</li><li>ç¬¬ 117 è‡³ 120 è¡Œï¼šåˆ›å»º ServiceReference å¯¹è±¡ï¼Œå…¶ä¸­ï¼š<ul><li><code>entryServiceId</code> ï¼šè‡ªå·± EntrySpan çš„æ“ä½œç¼–å·ã€‚</li><li><code>frontServiceId</code> ï¼š<code>Const.NONE_SERVICE_ID</code> å¯¹åº”çš„æ“ä½œç¼–å·( ç³»ç»Ÿå†…ç½®ï¼Œä»£è¡¨ã€ç©ºã€‘ )ã€‚</li><li><code>behindServiceId</code> ï¼š è‡ªå·± EntrySpan çš„æ“ä½œç¼–å·ã€‚</li></ul></li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#calculateCost(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ã€‚</li><li>ç¬¬ 126 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L141" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToAggregationWorker(...)</code></a> æ–¹æ³•ï¼Œå‘é€ ServiceReference ç»™ AggregationWorker ï¼Œæ‰§è¡Œæµå¼å¤„ç†ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L153" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createServiceReferenceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ServiceReference å¯¹åº”çš„ <code>Graph&lt;ServiceReference&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.ServiceEntryAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.ServiceEntryRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferencePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.ServiceEntryPersistenceWorker</code></a></li></ul><h1>11. Segment</h1><p>ä¸åŒäºä¸Šè¿°æ‰€æœ‰æ•°æ®å®ä½“ï¼ŒSegment æ— éœ€<strong>è§£æ</strong>ï¼Œç›´æ¥ä½¿ç”¨ TraceSegment æ„å»ºï¼Œå‚è§å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentParse#parse(UpstreamSegment, Source)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L177" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentParse#buildSegment(id, dataBinary)</code></a></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/global/GlobalTrace.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.segment.Segment</code></a> ï¼Œå…¨å±€é“¾è·¯è¿½è¸ªï¼Œè®°å½•ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ŒåŒ…æ‹¬çš„ TraceSegment ç¼–å·ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/25a830d4fed13ee2d62adb7ad7b35ada436bd6f6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/segment/Segment.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.global.GlobalTraceTable</code></a> ï¼Œ Segment è¡¨( <code>segment</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>_id</code> ï¼šTraceSegment ç¼–å·ã€‚</li><li><code>data_binary</code> ï¼šTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.SegmentEsPersistenceDAO</code></a> ï¼ŒGlobalTrace çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/12.png" alt=""></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L164" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createSegmentGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Segment å¯¹åº”çš„ <code>Graph&lt;Segment&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/segment/SegmentPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.SegmentPersistenceWorker</code></a></li></ul><h1>666. å½©è›‹</h1><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="çŸ¥è¯†æ˜Ÿçƒ"></p><p>æŠ±æ­‰ï¼Œæœ¬æ–‡å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›é”™è¯¯æˆ–è€…ç»†èŠ‚æ²¡æœ‰æ‰£åˆ°ï¼Œçƒ¦è¯·è§è°…ã€‚<br>èƒ–å‹å¦‚æœæœ‰ç–‘æƒ‘ï¼Œè¯·ç»™æˆ‘çš„å…¬ä¼—å·ç•™è¨€ï¼Œä¸€èµ·æ¢è®¨ã€‚</p><p>å¤§é‡ç±»ä¼¼çš„å†…å®¹ï¼Œç¬”è€…ä¸€å¤©éƒ½å¤„äºæ˜æ˜æ²‰æ²‰çš„çŠ¶æ€ï¼Œä¸­é—´æœ‰ä¸€å—ä¸å°å¿ƒæ›¿æ¢é”™è¯¯ï¼Œå®åœ¨æ˜¯è‹¦é—·è€Œåˆå‡ åˆ†æ¯ç‡¥ï¼Œä¸å¾—ä¸ä½©æœ SkyWalking å¼€å‘è€…çš„è€å¿ƒã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/13.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/SkyWalking/">SkyWalking</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/SkyWalking/collector-store-trace/" data-title="SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ® | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/SkyWalking/jvm-collect/" title="SkyWalking æºç åˆ†æ â€”â€” JVM æŒ‡æ ‡çš„æ”¶é›†ä¸å­˜å‚¨"><strong>PREVIOUS:</strong><br><span>SkyWalking æºç åˆ†æ â€”â€” JVM æŒ‡æ ‡çš„æ”¶é›†ä¸å­˜å‚¨</span></a></div><div class="next"><a href="/SkyWalking/collector-receive-trace/" title="SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®"><strong>NEXT:</strong><br><span>SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. SpanListener</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. GlobalTrace</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. InstPerformance</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">5. SegmentCost</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">6. NodeComponent</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">7.</span> <span class="toc-text">7. NodeMapping</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">8.</span> <span class="toc-text">8. NodeReference</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">9.</span> <span class="toc-text">9. ServiceEntry</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">10.</span> <span class="toc-text">10. ServiceReference</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">11.</span> <span class="toc-text">11. Segment</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">12.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/HikarCP/" title="HikarCP">HikarCP<sup>1</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>2</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å…«/" title="èŠ‹é“æºç çš„å‘¨å…«">èŠ‹é“æºç çš„å‘¨å…«<sup>14</sup></a></li></ul></div><div id="authorInfo2"><div><img width="100%" src="/images/common/zsxq/02.png"></div></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>