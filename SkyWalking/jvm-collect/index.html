<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>SkyWalking 源码分析 —— JVM 指标的收集与存储 | 芋道源码 —— 纯源码解析博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="芋道源码"><meta name="description" content="摘要: 原创出处 http://www.iocoder.cn/SkyWalking/jvm-collect/ 「芋道源码」欢迎转载，保留摘要，谢谢！
本文主要基于 SkyWalking 3.2.6 正式版

1. 概述
2. Agent 收集 JVM 指标

2.1 JVMService
2.2 C"><meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客,Sharding-JDBC,分库分表"><link rel="alternate" href="atom.xml" title="芋道源码 —— 纯源码解析博客" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="芋道源码 —— 纯源码解析博客">芋道源码 —— 纯源码解析博客</a></h1><a class="blog-motto">愿半生编码，如一生老友！</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="菜单"></a></div><nav class="animated"><ul><ul><li><a href="/">文章</a></li><li><a href="/2018-meet-you">知识星球</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">微信公众号</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">工作内推</a></li><li><a href="/link_url">友链</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/SkyWalking/jvm-collect/" title="SkyWalking 源码分析 —— JVM 指标的收集与存储" itemprop="url">SkyWalking 源码分析 —— JVM 指标的收集与存储</a></h1><p class="article-author"></p><p class="article-time">总阅读量:<span id="busuanzi_value_page_pv"></span>次</p></header><div class="article-content"><p>摘要: 原创出处 http://www.iocoder.cn/SkyWalking/jvm-collect/ 「芋道源码」欢迎转载，保留摘要，谢谢！</p><p><strong>本文主要基于 SkyWalking 3.2.6 正式版</strong></p><ul><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">1. 概述</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2. Agent 收集 JVM 指标</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.1 JVMService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.2 CPU</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.3 Memory</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.4 MemoryPool</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.5 GC</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3. Collector 存储 JVM 指标</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.1 JVMMetricsServiceHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.2 CPU</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.3 Memory</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.4 MemoryPool</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.5 GC</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">4. 心跳</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">666. 彩蛋</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>🙂🙂🙂关注**微信公众号：【芋道源码】**有福利：</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>所有</strong>源码分析文章列表</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>中文注释源码 GitHub 地址</strong></li><li>您对于源码的疑问每条留言<strong>都</strong>将得到<strong>认真</strong>回复。<strong>甚至不知道如何读源码也可以请教噢</strong>。</li><li><strong>新的</strong>源码解析文章<strong>实时</strong>收到通知。<strong>每周更新一篇左右</strong>。</li><li><strong>认真的</strong>源码交流微信群。</li></ol></blockquote><hr><h1>1. 概述</h1><p>本文主要分享 <strong>SkyWalking JVM 指标的收集与存储</strong>。大体流程如下：</p><ul><li>Agent 每秒定时收集 JVM 指标到缓冲队列。</li><li>Agent 每秒定时将缓冲队列的 JVM 指标发送到 Collector 。</li><li>Collector 接收到 JVM 指标，异步批量存储到存储器( 例如，ES )。</li></ul><p>目前 JVM 指标包括<strong>四个维度</strong>：</p><ul><li>CPU</li><li>Memory</li><li>MemoryPool</li><li>GC</li></ul><p>SkyWalking UI 界面如下：</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/02.png" alt=""></p><h1>2. Agent 收集 JVM 指标</h1><h2>2.1 JVMService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.JVMService</code></a> ，实现 BootService 、Runnable 接口，JVM 指标服务，负责将 JVM 指标收集并发送给 Collector 。代码如下：</p><ul><li><code>queue</code> 属性，收集指标队列。</li><li><code>collectMetricFuture</code> 属性，收集指标定时任务。</li><li><code>sendMetricFuture</code> 属性，发送指标定时任务。</li><li><code>sender</code> 属性，发送器。</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeBoot()</code></a> 方法，初始化 <code>queue</code> ，<code>sender</code> 属性，并将自己添加到 GRPCChannelManager ，从而监听与 Collector 的连接状态。</p><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>boot</code></a> 方法，创建两个定时任务：</p><ul><li>第 88 至 90 行：创建收集指标定时任务，0 秒延迟，1 秒间隔，调用 <code>JVMService#run()</code> 方法。</li><li>第 92 至 94 行：创建发送指标定时任务，0 秒延迟，1 秒间隔，调用 <code>Sender#run()</code> 方法。</li></ul><h3>2.1.1 定时收集</h3><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMService#run()</code></a> 方法，代码如下：</p><ul><li>第 110 至 111 行：应用实例注册后，才收集 JVM 指标。</li><li>第 116 至 122 行：创建 JVMMetric 对象。<ul><li>第 118 行：调用 <code>CPUProvider#getCpuMetric()</code> 方法，获得 GC 指标。</li><li>第 119 行：调用 <code>MemoryProvider#getMemoryMetricList()</code> 方法，获得 Memory 指标。</li><li>第 120 行：调用 <code>MemoryPoolProvider#getMemoryPoolMetricList()</code> 方法，获得 MemoryPool 指标。</li><li>第 121 行：调用 <code>GCProvider#getGCList()</code> 方法，获得 GC 指标。</li></ul></li><li>第 125 至 128 行：提交 JVMMetric 对象到收集指标队列。</li></ul><h3>2.1.2 定时发送</h3><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L135" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMService.Sender</code></a> ，实现 Runnable 、GRPCChannelListener 接口，JVM 指标发送器。代码如下：</p><ul><li><code>status</code> 属性，连接状态。</li><li><code>stub</code> 属性，<strong>阻塞</strong> Stub 。</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L171" rel="external nofollow noopener noreferrer" target="_blank"><code>#statusChanged(GRPCChannelStatus)</code></a> 方法，当连接成功时，创建<strong>阻塞</strong> Stub 。</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L147" rel="external nofollow noopener noreferrer" target="_blank"><code>#run()</code></a> 方法，代码如下：<ul><li>第 148 至 151 行：应用实例注册后，并且连接中，才发送 JVM 指标。</li><li>第 153 至 155 行：调用 <code>#drainTo(Collection)</code> 方法，从队列移除所有 JVMMetric 到 <code>buffer</code> 数组。</li><li>第 157 至 162 行：使用 Stub ，<strong>批量</strong>发送到 Collector 。</li></ul></li></ul><h2>2.2 CPU</h2><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.cpu.CPUProvider</code></a> ，CPU 提供者，提供 <a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUProvider.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCpuMetric()</code></a> 方法，采集 CPU 指标，如下图所示：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/05.png" alt=""></p><ul><li><code>usagePercent</code> ：JVM 进程占用 CPU 百分比。</li><li>第 51 行：调用 <code>CPUMetricAccessor#getCPUMetric()</code> 方法，获得 CPU 指标。</li></ul><p>在 <a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUProvider.java#L35" rel="external nofollow noopener noreferrer" target="_blank">CPUProvider 构造方法</a> 中，初始化 <code>cpuMetricAccessor</code> 数量，代码如下：</p><ul><li>第 37 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/os/ProcessorUtil.java#L27" rel="external nofollow noopener noreferrer" target="_blank"><code>ProcessorUtil#getNumberOfProcessors()</code></a> 方法，获得 CPU 数量。</li><li>第 40 至 42 行：创建 SunCpuAccessor 对象。</li><li>第 44 至 46 行：发生异常，说明不支持，创建 NoSupportedCPUAccessor 对象。</li><li><strong>为什么需要使用 <code>ClassLoader#loadClass(className)</code> 方法呢</strong>？因为 SkyWalking Agent 是通过 JavaAgent 机制，实际未引入，所以通过该方式加载类。</li></ul><h3>2.2.1 CPUMetricAccessor</h3><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.cpu.CPUMetricAccessor</code></a> ，CPU 指标访问器<strong>抽象类</strong>。代码如下：</p><ul><li><code>lastCPUTimeNs</code> 属性，获得进程占用 CPU 时长，单位：纳秒。</li><li><code>lastSampleTimeNs</code> 属性，最后采样时间，单位：纳秒。</li><li><code>cpuCoreNum</code> 属性，CPU 数量。</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#init()</code></a> 方法，初始化 <code>lastCPUTimeNs</code> 、<code>lastSampleTimeNs</code> 。</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCpuTime()</code></a> 抽象方法，获得 CPU 占用时间，由子类完成。</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCPUMetric()</code></a> 方法，获得 CPU 指标。放在和 SunCpuAccessor 一起分享。这里我先记得，JVM 进程占用 CPU 率的计算公式：<code>进程 CPU 占用总时间 / ( 进程启动总时间 * CPU 数量)</code> 。</li></ul><hr><p>CPUMetricAccessor 有两个子类，实际上文我们已经看到它的创建：</p><ul><li>SunCpuAccessor ，基于 SUN 提供的方法，获取 CPU 指标访问器。</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/NoSupportedCPUAccessor.java" rel="external nofollow noopener noreferrer" target="_blank">NoSupportedCPUAccessor</a> ，不支持的 CPU 指标访问器。因此，使用该类的情况下，获取不到具体的进程 CPU 占用率。</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/SunCpuAccessor.java#L31" rel="external nofollow noopener noreferrer" target="_blank">SunCpuAccessor 构造方法</a> ，代码如下：</p><ul><li><p>第 32 行：设置 CPU 数量。</p></li><li><p>第 33 行：获得 OperatingSystemMXBean 对象。通过该对象，在 <a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/SunCpuAccessor.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCpuTime()</code></a> 实现方法，调用 <a href="https://docs.oracle.com/javase/7/docs/jre/api/management/extension/com/sun/management/OperatingSystemMXBean.html#getProcessCpuTime()" rel="external nofollow noopener noreferrer" target="_blank"><code>OperatingSystemMXBean#getProcessCpuTime()</code></a> 方法，获得 JVM 进程占用 CPU 总时长。</p><blockquote><p>long getProcessCpuTime()</p><p>Returns the CPU time used by the process on which the Java virtual machine is running in nanoseconds. The returned value is of nanoseconds precision but not necessarily nanoseconds accuracy. This method returns -1 if the the platform does not support this operation.</p><p><strong>Returns</strong>:<br>the CPU time used by the process in nanoseconds, or -1 if this operation is not supported.</p></blockquote></li><li><p>第 34 行：调用 <code>#init()</code> 方法，初始化 <code>lastCPUTimeNs</code> 、<code>lastSampleTimeNs</code> 。</p></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCPUMetric()</code></a> 方法，获得 CPU 指标。代码如下：</p><ul><li>第 58 至 59 行：获得 JVM 进程占用 CPU 总时长。</li><li>第 64 行：<code>now - lastSampleTimeNs</code> ，获得 JVM 进程启动总时长。</li><li><strong>这里为什么相减呢</strong>？因为 CPUMetricAccessor 不是在 JVM 启动时就进行计算，通过相减，解决偏差。</li><li>第 63 至 64 行：计算 JVM 进程占用 CPU 率。</li></ul><h2>2.3 Memory</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ac31b37208b33a06616e580dfc71e2079531a2a6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memory/MemoryProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memory.MemoryProvider</code></a> ，Memory 提供者，提供 <a href="https://github.com/YunaiV/skywalking/blob/ac31b37208b33a06616e580dfc71e2079531a2a6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memory/MemoryProvider.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryMetricList()</code></a> 方法，采集 Memory 指标，如下图所示：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/07.png" alt=""></p><ul><li>推荐阅读文章：<ul><li><a href="https://docs.oracle.com/javase/7/docs/api/java/lang/management/MemoryUsage.html" rel="external nofollow noopener noreferrer" target="_blank">MemoryUsage</a></li><li><a href="http://blog.sina.com.cn/s/blog_ad7c19000102vjcw.html" rel="external nofollow noopener noreferrer" target="_blank">Java中监控程序内存的函数</a></li><li><a href="http://zhanjindong.com/2016/03/02/jvm-memory-tunning-notes" rel="external nofollow noopener noreferrer" target="_blank">JVM内存调优相关的一些笔记（杂）</a></li></ul></li><li><code>isHeap</code> ：是否堆内内存。</li><li><code>init</code> ：初始化的内存数量。</li><li><code>max</code> ：最大的内存数量。</li><li><code>used</code> ：已使用的内存数量。</li><li><code>committed</code> ：可以使用的内存数量。</li><li>第 44 至 51 行：使用 MemoryMXBean 对象，获得堆内( Heap )内存。</li><li>第 54 至 61 行：使用 MemoryMXBean 对象，获得非堆内( None-Heap )内存。</li></ul><h2>2.4 MemoryPool</h2><p><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.MemoryPoolProvider</code></a> ，MemoryPool 提供者，提供 <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> 方法，采集 MemoryPool 指标<strong>数组</strong>，如下图：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/09.png" alt=""></p><ul><li>推荐阅读文章：<ul><li><a href="JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%92%8C%E9%9D%9E%E5%A0%86%E5%86%85%E5%AD%98">MemoryUsage</a></li></ul></li><li><code>type</code> ：内存区域类型。MemoryPool 和 Memory 的差别在于拆分的维度不同，如下图：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/11.png" alt=""></li><li><code>init</code> ：初始化的内存数量。</li><li><code>max</code> ：最大的内存数量。</li><li><code>used</code> ：已使用的内存数量。</li><li><code>committed</code> ：可以使用的内存数量。</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java#L36" rel="external nofollow noopener noreferrer" target="_blank">MemoryPoolProvider 构造方法</a>，代码如下：</p><ul><li>第 38 行：获得 MemoryPoolMXBean 数组。每个 MemoryPoolMXBean 对象，代表上面的一个区域类型。</li><li>第 39 至 46 行：循环 MemoryPoolMXBean 数组，调用 <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#findByBeanName(name)</code></a> 方法，找到对应的 GC 算法，创建对应的 MemoryPoolMetricAccessor 对象。</li><li>第 47 至 49 行：未找到匹配的 GC 算法，创建 UnknownMemoryPool 对象。</li></ul><h3>2.4.1 MemoryPoolMetricAccessor</h3><p><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolMetricAccessor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.MemoryPoolMetricAccessor</code></a> ，MemoryPool 指标访问器<strong>接口</strong>。</p><ul><li>定义了 <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolMetricAccessor.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> 接口，获得 MemoryPool 指标<strong>数组</strong>。</li></ul><p>MemoryPoolMetricAccessor 子类如下图：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/12.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/UnknownMemoryPool.java" rel="external nofollow noopener noreferrer" target="_blank">UnknownMemoryPool</a> ，未知的 MemoryPool 指标访问器实现类。每次 <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/UnknownMemoryPool.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> 方法，返回 MemoryPool 指标<strong>数组</strong>，但是每个指标元素是无具体数据的。</li></ul><h3>2.4.2 MemoryPoolModule</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.MemoryPoolModule</code></a> ，实现 MemoryPoolMetricAccessor 接口，MemoryPool 指标访问器<strong>抽象类</strong>。不同 GC 算法之间，内存区域命名不同，通过如下<strong>六个</strong>方法抽象，分别对应不同内存区域，形成映射关系，屏蔽差异：</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#getPermNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L87" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCodeCacheNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#getEdenNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L91" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOldNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L93" rel="external nofollow noopener noreferrer" target="_blank"><code>#getSurvivorNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L95" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMetaspaceNames()</code></a></li><li>胖友可以看看 MemoryPoolModule 子类的实现：<ul><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/CMSCollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">CMSCollectorModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/G1CollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">G1CollectorModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/ParallelCollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">ParallelCollectorModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/SerialCollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">SerialCollectorModule</a></li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L41" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> <strong>实现方法</strong>，代码如下：</p><ul><li>第 44 行：循环每个内存区域，收集每个 MemoryPool 指标。</li><li>第 47 至 62 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>#contains(possibleNames, name)</code></a> 方法，逐个内存区域名字判断，获得对应的内存区域类型。</li><li>第 65 至 71 行：创建 MemoryUsage 对象，并添加到结果数组。</li></ul><h2>2.5 GC</h2><p>整体实现类似 <a href="#">「2.4 MemoryPool」</a> 。</p><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.GCProvider</code></a> ，GC 提供者，提供 <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> 方法，采集 GC 指标<strong>数组</strong>，如下图：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/13.png" alt=""></p><ul><li><code>phrase</code> ：生代类型，包括新生代、老生代。</li><li><code>count</code> ：总回收次数。</li><li><code>time</code> ：总回收占用时间。</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L37" rel="external nofollow noopener noreferrer" target="_blank">GCProvider 构造方法</a>，代码如下：</p><ul><li>第 38 行：获得 GarbageCollectorMXBean 数组。</li><li>第 39 至 46 行：循环 MemoryPoolMXBean 数组，调用 <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>#findByBeanName(name)</code></a> 方法，找到对应的 GC 算法，创建对应的 GCMetricAccessor 对象。</li><li>第 47 至 49 行：未找到匹配的 GC 算法，创建 UnknowGC 对象。</li></ul><h3>2.5.1 GCMetricAccessor</h3><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCMetricAccessor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.gc.GCMetricAccessor</code></a> ，GC 指标访问器<strong>接口</strong>。</p><ul><li>定义了 <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCMetricAccessor.java#L28" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> 接口，获得 GC 指标<strong>数组</strong>。</li></ul><p>GCMetricAccessor 子类如下图：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/15.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/UnknowGC.java" rel="external nofollow noopener noreferrer" target="_blank">UnknowGC</a> ，未知的 GC 指标访问器实现类。每次 <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/UnknowGC.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> 方法，返回 GC 指标<strong>数组</strong>，但是每个指标元素是无具体数据的。</li></ul><h3>2.5.2 GCModule</h3><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.gc.GCModule</code></a> ，实现 GCMetricAccessor 接口，GC 指标访问器<strong>抽象类</strong>。不同 GC 算法之间，生代命名不同，通过如下<strong>两个</strong>方法抽象，分别对应两个生代，形成映射关系，屏蔽差异：</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOldGCName()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#getNewGCName()</code></a></li><li>胖友可以看看 GCModule 子类的实现：<ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/CMSGCModule.java" rel="external nofollow noopener noreferrer" target="_blank">CMSGCModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/G1GCModule.java" rel="external nofollow noopener noreferrer" target="_blank">G1GCModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/ParallelGCModule.java" rel="external nofollow noopener noreferrer" target="_blank">ParallelGCModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/SerialGCModule.java" rel="external nofollow noopener noreferrer" target="_blank">SerialGCModule</a></li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> <strong>实现方法</strong>，代码如下：</p><ul><li>第 44 行：循环 GarbageCollectorMXBean 数组，收集每个 GC 指标。</li><li>第 47 至 62 行：获得生代类型。</li><li>第 65 至 71 行：创建 GC 对象，并添加到结果数组。</li></ul><h1>3. Collector 存储 JVM 指标</h1><h2>3.1 JVMMetricsServiceHandler</h2><p>我们先来看看 API 的定义，<a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-network/src/main/proto/JVMMetricsService.proto#L8" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMMetricsService.proto</code></a> ，如下图所示：</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/01.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/TraceSegmentServiceHandler.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMMetricsServiceHandler#collect(JVMMetrics, StreamObserver&lt;Downstream&gt;)</code></a>, 代码如下：</p><ul><li>第 60 行：<strong>循环</strong>接收到的 JVMMetric <strong>数组</strong>。</li><li>第 62 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToInstanceHeartBeatService(...)</code></a> 方法，发送心跳，记录应用实例的最后心跳时间。因为目前 SkyWaling 主要用于 JVM 平台，通过每秒的 JVM 指标收集的同时，记录应用实例的最后心跳时间。</li><li>第 62 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L91" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToCpuMetricService(...)</code></a> 方法，处理 CPU 数据。</li><li>第 64 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToMemoryMetricService(...)</code></a> 方法，处理 Memory 数据。</li><li>第 66 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToMemoryPoolMetricService(...)</code></a> 方法，处理 Memory Pool 数据。</li><li>第 68 行：调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L95" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToGCMetricService(...)</code></a> 方法，处理 GC 数据。</li><li>第 73 至 74 行：全部处理完成，返回成功。</li></ul><p>上述的 <code>#sendToXXX()</code> 方法，内部每个对应调用一个如下图 Service 提供的方法：<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/04.png" alt=""></p><ul><li>每个 Service 的实现，对应一个数据实体和一个 Graph 对象，通过流式处理，最终存储到存储器( 例如 ES ) ，流程如下图：</li><li>具体的实现代码，我们放在下面的数据实体一起分享。</li></ul><h2>3.2 CPU</h2><p><a href="https://github.com/YunaiV/skywalking/blob/aadff78dcde7c2e05dc8d29f3381032c1650137e/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/CpuMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.CpuMetric</code></a> ，CPU 指标。</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/aadff78dcde7c2e05dc8d29f3381032c1650137e/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/CpuMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.CpuMetricTable</code></a> ， CpuMetric 表( <code>cpu_metric</code> )。字段如下：<ul><li><code>instance_id</code> ：应用实例编号。</li><li><code>usage_percent</code> ：CPU 占用率。</li><li><code>time_bucket</code> ：时间。</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/CpuMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.CpuMetricEsPersistenceDAO</code></a> ，CpuMetric 的 EsDAO 。</li><li>在 ES 存储例子如下图： <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/06.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/CpuMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.CpuMetricService</code></a> ，CPU 指标服务，调用 CPUMetric 对应的 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;CPUMetric&gt;</code></a> 对象，流式处理，最终 CPUMetric 保存到存储器。</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/CpuMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.CpuMetricPersistenceWorker</code></a> , CPU 指标批量存储 Worker 。</li></ul><h2>3.3 Memory</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryMetric</code></a> ，Memory 指标。</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryMetricTable</code></a> ， MemoryMetric 表( <code>memory_metric</code> )。字段如下：<ul><li><code>instance_id</code> ：应用实例编号。</li><li><code>isHeap</code> ：是否堆内内存。</li><li><code>init</code> ：初始化的内存数量。</li><li><code>max</code> ：最大的内存数量。</li><li><code>used</code> ：已使用的内存数量。</li><li><code>committed</code> ：可以使用的内存数量。</li><li><code>time_bucket</code> ：时间。</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/MemoryMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.MemoryMetricEsPersistenceDAO</code></a> ，MemoryMetric 的 EsDAO 。</li><li>在 ES 存储例子如下图： <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/08.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricService</code></a> ，Memory 指标服务，调用 MemoryMetric 对应的 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;MemoryMetric&gt;</code></a> 对象，流式处理，最终 MemoryMetric 保存到存储器。</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricPersistenceWorker</code></a> , Memory 指标批量存储 Worker 。</li></ul><h2>3.4 MemoryPool</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryPoolMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryPoolMetric</code></a> ，MemoryPool 指标。</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryPoolMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryPoolMetricTable</code></a> ， MemoryPool 表( <code>memory_pool_metric</code> )。字段如下：<ul><li><code>instance_id</code> ：应用实例编号。</li><li><code>pool_type</code> ：内存区域类型。</li><li><code>init</code> ：初始化的内存数量。</li><li><code>max</code> ：最大的内存数量。</li><li><code>used</code> ：已使用的内存数量。</li><li><code>committed</code> ：可以使用的内存数量。</li><li><code>time_bucket</code> ：时间。</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/MemoryPoolMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.MemoryPoolMetricEsPersistenceDAO</code></a> ，MemoryPoolMetric 的 EsDAO 。</li><li>在 ES 存储例子如下图： <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/10.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryPoolMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricService</code></a> ，MemoryPoolMetric 指标服务，调用 MemoryPoolMetric 对应的 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L82" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;MemoryPoolMetric&gt;</code></a> 对象，流式处理，最终 MemoryPoolMetric 保存到存储器。</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricPersistenceWorker</code></a> , MemoryPool 指标批量存储 Worker 。</li></ul><h2>3.5 GC</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/GCMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.GCMetric</code></a> ，GC 指标。</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/GCMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.GCMetricTable</code></a> ， GCMetric 表( <code>gc_metric</code> )。字段如下：<ul><li><code>instance_id</code> ：应用实例编号。</li><li><code>phrase</code> ：生代类型，包括新生代、老生代。</li><li><code>count</code> ：总次数。</li><li><code>time</code> ：总时间。</li><li><code>time_bucket</code> ：时间。</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GCMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.GCMetricEsPersistenceDAO</code></a> ，GCMetric 的 EsDAO 。</li><li>在 ES 存储例子如下图： <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/14.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/GCMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.GCMetricService</code></a> ，GCMetric 指标服务，调用 GCMetric 对应的 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;GCMetric&gt;</code></a> 对象，流式处理，最终 GCMetric 保存到存储器。</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricPersistenceWorker</code></a> , MemoryPool 指标批量存储 Worker 。</li></ul><h1>4. 心跳</h1><p>Collector 在接收到 GC 指标上传后，调用 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMMetricsServiceHandler#sendToInstanceHeartBeatService(...)</code></a> 方法，发送心跳，记录应用实例的最后心跳时间。因为目前 SkyWaling 主要用于 JVM 平台，通过每秒的 JVM 指标收集的同时，记录应用实例的最后心跳时间。</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/InstanceHeartBeatService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.InstanceHeartBeatService</code></a> ，应用实例心跳服务，调用 Instance 对应的 <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L90" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;Instance&gt;</code></a> 对象，流式处理，最终更新 Instance 的最后<strong>心跳时间</strong>( <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/InstanceTable.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>heartbeat_time</code></a> )到存储器。</li></ul><h1>666. 彩蛋</h1><p>比想象中冗长的文章，有些考验耐心，心疼 SkyWalking 开发者 30 秒。</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/16.png" alt=""></p><p>胖友，分享个朋友圈可好？</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/SkyWalking/">SkyWalking</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/SkyWalking/jvm-collect/" data-title="SkyWalking 源码分析 —— JVM 指标的收集与存储 | 芋道源码 —— 纯源码解析博客" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/SkyWalking/ui-1-application/" title="SkyWalking 源码分析 —— 运维界面（一）之应用视角"><strong>PREVIOUS:</strong><br><span>SkyWalking 源码分析 —— 运维界面（一）之应用视角</span></a></div><div class="next"><a href="/SkyWalking/collector-store-trace/" title="SkyWalking 源码分析 —— Collector 存储 Trace 数据"><strong>NEXT:</strong><br><span>SkyWalking 源码分析 —— Collector 存储 Trace 数据</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div><div id="toc" class="toc-aside"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. Agent 收集 JVM 指标</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 JVMService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 定时收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 定时发送</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 CPUMetricAccessor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Memory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 MemoryPool</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 MemoryPoolMetricAccessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 MemoryPoolModule</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 GC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1 GCMetricAccessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2 GCModule</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. Collector 存储 JVM 指标</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JVMMetricsServiceHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 CPU</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Memory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MemoryPool</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 GC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. 心跳</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">666. 彩蛋</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">微信公众号福利：芋道源码</p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. 阅读源码葵花宝典</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC 详细中文注释源码</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. 您对于源码的疑问每条留言都将得到认真回复</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. 新的源码解析文章实时收到通知，每周六十点更新</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. 认真的源码交流微信群</a></li></ul></div><div class="categorieslist"><p class="asidetitle">分类</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>34</sup></a></li><li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li><li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li><li><a href="/categories/工作内推/" title="工作内推">工作内推<sup>4</sup></a></li><li><a href="/categories/技术杂文/" title="技术杂文">技术杂文<sup>5</sup></a></li><li><a href="/categories/芋道源码的周天/" title="芋道源码的周天">芋道源码的周天<sup>1</sup></a></li></ul></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">© 2018 <a href="http://www.iocoder.cn" target="_blank" title="芋道源码">芋道源码</a> && <span style="display:inline" id="busuanzi_container_site_uv">总访客数 <span id="busuanzi_value_site_uv" font="微软雅黑"></span> 次</span> && <span style="display:inline" id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv" font="微软雅黑"></span> 次</span></p></div><div class="copyright">沪ICP备17037075号-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>