<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>SkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-storage-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº SkyWalking 3.2.6 æ­£å¼ç‰ˆ

1. æ¦‚è¿°
2. apm-collector-core

2.1 "><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/SkyWalking/collector-storage-module/" title="SkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶" itemprop="url">SkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-storage-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº SkyWalking 3.2.6 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">2. apm-collector-core</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">2.1 Table</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">2.2 TableDefine</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">2.3 Data</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">3. collector-storage-define</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">3.1 StorageModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">3.2 table åŒ…</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">3.3 StorageInstaller</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">3.4 dao åŒ…</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">4. collector-storage-h2-provider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">5. collector-storage-es-provider</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">5.1 StorageModuleEsProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">5.2 define åŒ…</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">5.3 dao åŒ…</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">5.4 DataTTLKeeperTimer</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Storage å­˜å‚¨ç»„ä»¶</strong>ã€‚é¡¾åæ€ä¹‰ï¼Œè´Ÿè´£å°†è°ƒç”¨é“¾è·¯ã€åº”ç”¨ã€åº”ç”¨å®ä¾‹ç­‰ç­‰ä¿¡æ¯å­˜å‚¨åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼ŒES ã€H2 ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šå»ºè®®å…ˆé˜…è¯» <a href="http://www.iocoder.cn/SkyWalking/collector-init/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector åˆå§‹åŒ–ã€‹</a> ï¼Œä»¥äº†è§£ Collector ç»„ä»¶ä½“ç³»ã€‚</p></blockquote><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/02.png" alt=""></p><ul><li><code>apm-collector-core</code> çš„ <code>data</code> å’Œ <code>define</code> <strong>åŒ…</strong> ï¼šæ•°æ®çš„æŠ½è±¡ã€‚</li><li><code>collector-storage-define</code> ï¼šå®šä¹‰å­˜å‚¨ç»„ä»¶æ¥å£ã€‚</li><li><code>collector-storage-h2-provider</code> ï¼šåŸºäº H2 çš„ å­˜å‚¨ç»„ä»¶å®ç°ã€‚<strong>è¯¥å®ç°æ˜¯å•æœºç‰ˆï¼Œå»ºè®®ä»…ç”¨äº SkyWalking å¿«é€Ÿä¸Šæ‰‹ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</strong>ã€‚</li><li><code>collector-storage-es-provider</code> ï¼šåŸºäº Elasticsearch çš„é›†ç¾¤ç®¡ç†å®ç°ã€‚<strong>ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨</strong>ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1>2. apm-collector-core</h1><p><code>apm-collector-core</code> çš„ <code>data</code> å’Œ <code>define</code> <strong>åŒ…</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/03.png" alt=""></p><p>æˆ‘ä»¬å¯¹ç±»è¿›è¡Œæ¢³ç†åˆ†ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/04.png" alt=""></p><ul><li>Table ï¼šData å’Œ TableDefine ä¹‹é—´çš„æ¡¥æ¢ï¼Œæ¯ä¸ª Table å®šä¹‰äº†è¯¥è¡¨çš„<strong>è¡¨å</strong>ï¼Œ<strong>å­—æ®µåä»¬</strong>ã€‚</li><li>TableDefine ï¼šTable çš„è¯¦ç»†å®šä¹‰ï¼ŒåŒ…æ‹¬<strong>è¡¨å</strong>ï¼Œ<strong>å­—æ®µå®šä¹‰</strong>( ColumnDefine )ä»¬ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œ<a href="https://github.com/apache/incubator-skywalking/blob/15328202b8b7df89a609885d9110361ff29ce668/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/apache/skywalking/apm/collector/storage/StorageInstaller.java" rel="external nofollow noopener noreferrer" target="_blank">StorageInstaller</a> ä¼šåŸºäº TableDefine åˆå§‹åŒ–è¡¨çš„ç›¸å…³ä¿¡æ¯ã€‚</li><li>Data ï¼šæ•°æ®ï¼ŒåŒ…æ‹¬<strong>ä¸€æ¡</strong>æ•°æ®çš„æ•°æ®å€¼ä»¬å’Œæ•°æ®å­—æ®µ( Column )ä»¬ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œ<a href="https://github.com/apache/incubator-skywalking/blob/15328202b8b7df89a609885d9110361ff29ce668/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/apache/skywalking/apm/collector/storage/base/dao/DAO.java" rel="external nofollow noopener noreferrer" target="_blank">Dao</a> ä¼šå­˜å‚¨ Data åˆ°å­˜å‚¨å™¨ä¸­ã€‚å¦å¤–ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šçœ‹åˆ°å¯¹ Data çš„æµå¼å¤„ç†<strong>é€šç”¨</strong>å°è£…ã€‚</li></ul><h2>2.1 Table</h2><p><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/CommonTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.CommonTable</code></a> ï¼Œé€šç”¨è¡¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/CommonTable.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>TABLE_TYPE</code></a> <strong>é™æ€</strong>å±æ€§ï¼Œè¡¨ç±»å‹ã€‚ç›®å‰åªæœ‰ ES å­˜å‚¨ç»„ä»¶ä½¿ç”¨åˆ°ï¼Œä¸‹æ–‡è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/CommonTable.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>COLUMN_</code></a> å‰ç¼€çš„<strong>é™æ€</strong>å±æ€§ï¼Œé€šç”¨çš„å­—æ®µåã€‚</li></ul><p>åœ¨ <code>collector-storage-define</code> çš„ <a href="https://github.com/YunaiV/skywalking/tree/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table" rel="external nofollow noopener noreferrer" target="_blank"><code>table</code></a> <strong>åŒ…</strong>ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰ Table ç±»ï¼Œä»¥ <code>&quot;Table&quot;</code> ç»“å°¾ã€‚æ¯ä¸ª Table çš„è¡¨åï¼Œåœ¨æ¯ä¸ªå®ç°ç±»é‡Œï¼Œä¾‹å¦‚ <a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/ApplicationTable.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationTable</a> ã€‚</p><h2>2.2 TableDefine</h2><p><code>org.skywalking.apm.collector.core.data.TableDefine</code> ï¼Œè¡¨å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/TableDefine.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>name</code></a> å±æ€§ï¼Œè¡¨åã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/TableDefine.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>columnDefines</code></a> å±æ€§ï¼ŒColumnDefineæ•°ç»„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/578ea4f66f11bdfe5dcda25f574a1ed57ca47d24/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/TableDefine.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>#initialize()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆå§‹åŒ–è¡¨å®šä¹‰ã€‚ä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/578ea4f66f11bdfe5dcda25f574a1ed57ca47d24/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/define/ApplicationEsTableDefine.java#L38" rel="external nofollow noopener noreferrer" target="_blank">ApplicationEsTableDefine</a> ã€‚</li></ul><p>ä¸åŒçš„å­˜å‚¨ç»„ä»¶å®ç°ï¼Œæœ‰ä¸åŒçš„ TableDefine å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/05.png" alt=""></p><ul><li><p>ElasticSearchTableDefine ï¼šåŸºäº Elasticsearch çš„è¡¨å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ï¼Œåœ¨ <code>collector-storage-es-provider</code> çš„ <a href="https://github.com/YunaiV/skywalking/tree/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/define" rel="external nofollow noopener noreferrer" target="_blank"><code>define</code></a> <strong>åŒ…</strong>ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>æ‰€æœ‰</strong> ES çš„ TableDefine ç±»ã€‚</p></li><li><p>H2TableDefine ï¼šåŸºäº H2 çš„è¡¨å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ï¼Œåœ¨ <code>collector-storage-h2-provider</code> çš„ <a href="https://github.com/YunaiV/skywalking/tree/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-storage/collector-storage-h2-provider/src/main/java/org/skywalking/apm/collector/storage/h2/define" rel="external nofollow noopener noreferrer" target="_blank"><code>define</code></a> <strong>åŒ…</strong>ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>æ‰€æœ‰</strong> H2 çš„ TableDefine ç±»ã€‚</p></li></ul><h3>2.2.1 ColumnDefine</h3><p><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/ColumnDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.ColumnDefine</code></a> ï¼Œå­—æ®µå®šä¹‰<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/ColumnDefine.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>name</code></a> å±æ€§ï¼Œå­—æ®µåã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/ColumnDefine.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>type</code></a> å±æ€§ï¼Œå­—æ®µç±»å‹ã€‚</li></ul><p>åœ¨ <code>collector-storage-xxx-provider</code> æ¨¡å—ä¸­ï¼ŒH2ColumnDefine ã€ElasticSearchColumnDefine å®ç° ColumnDefine ã€‚</p><h3>2.2.2 Loader</h3><p>æ¶‰åŠåˆ°çš„ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/06.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/0aa5e6a49c1f29b43824ebabf6bb7d76b80e3eb7/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/StorageDefineLoader.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.StorageDefineLoader</code></a> ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/0aa5e6a49c1f29b43824ebabf6bb7d76b80e3eb7/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/define/DefinitionLoader.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.define.DefinitionLoader</code></a> ï¼Œä» <a href="https://github.com/YunaiV/skywalking/blob/0aa5e6a49c1f29b43824ebabf6bb7d76b80e3eb7/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/StorageDefinitionFile.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.StorageDefinitionFile</code></a> ä¸­ï¼ŒåŠ è½½ TableDefine å®ç°ç±»æ•°ç»„ã€‚</p><p>å¦å¤–ï¼Œåœ¨ <code>collector-storage-es-provider</code> å’Œ <code>collector-storage-h2-provider</code> é‡Œéƒ½æœ‰ <code>storage.define</code> æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/07.png" alt=""></p><ul><li>StorageDefinitionFile å£°æ˜äº†è¯»å–è¯¥æ–‡ä»¶ã€‚</li><li><strong>æ³¨æ„</strong>ï¼ŒDefinitionLoader åœ¨åŠ è½½æ—¶ï¼Œä¸¤ä¸ªæ–‡ä»¶éƒ½ä¼šè¢«è¯»å–ï¼Œæœ€ç»ˆåœ¨ <code>StorageInstaller#defineFilter(List&lt;TableDefine&gt;)</code> æ–¹æ³•ï¼Œè¿›è¡Œè¿‡æ»¤ã€‚</li></ul><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸­æ–‡æ³¨é‡Šå·²åŠ ï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ä¸‹ã€‚</p><h2>2.3 Data</h2><p><code>org.skywalking.apm.collector.core.data.Data</code> ï¼Œæ•°æ®<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href=""><code>dataXXX</code></a> <strong>å‰ç¼€</strong>çš„å±æ€§ï¼Œå­—æ®µå€¼ä»¬ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Data.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>dataStrings</code></a> å±æ€§çš„ç¬¬ä¸€ä½ï¼Œæ˜¯ <strong>ID</strong> å±æ€§ã€‚å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Data.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a>çš„ã€ç¬¬ 51 è¡Œã€‘ æˆ–è€… <a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Data.java#L142" rel="external nofollow noopener noreferrer" target="_blank"><code>#setId(id)</code></a> æ–¹æ³•ã€‚</li></ul></li><li><a href=""><code>xxxColumns</code></a> <strong>åç¼€</strong>çš„å±æ€§ï¼Œå­—æ®µ( Column )ä»¬ã€‚</li><li>é€šè¿‡ä¸Šè¿°ä¸¤ç§å±æ€§ + è‡ªèº«ç±»ï¼Œå¯ä»¥ç¡®å®šä¸€æ¡æ•°æ®è®°å½•çš„è¡¨ã€å­—æ®µç±»å‹ã€å­—æ®µåã€å­—æ®µå€¼ã€‚</li><li><strong>ç»§æ‰¿</strong> <a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/EndOfBatchQueueMessage.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.EndOfBatchQueueMessage</code></a> ï¼Œå¸¦æ˜¯å¦æ¶ˆæ¯æ‰¹å¤„ç†çš„æœ€åä¸€æ¡æ ‡è®°çš„<strong>æ¶ˆæ¯æŠ½è±¡ç±»</strong>ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/EndOfBatchQueueMessage.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>endOfBatch</code></a> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ3. AggregationWorkerã€</a> è¯¦ç»†è§£æã€‚<ul><li><strong>ç»§æ‰¿</strong> <a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/AbstractHashMessage.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.AbstractHashMessage</code></a> ï¼Œå¸¦å“ˆå¸Œç çš„<strong>æ¶ˆæ¯æŠ½è±¡ç±»</strong>ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/AbstractHashMessage.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>hashCode</code></a> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ3. AggregationWorkerã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Data.java#L154" rel="external nofollow noopener noreferrer" target="_blank"><code>#mergeData(Data)</code></a> æ–¹æ³•ï¼Œåˆå¹¶ä¼ å…¥çš„æ•°æ®åˆ°è‡ªèº«ã€‚è¯¥æ–¹æ³•è¢« <a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>AggregationWorker#aggregate(message)</code></a> è°ƒç”¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ3. AggregationWorkerã€</a> è¯¦ç»†è§£æã€‚</li></ul><p>åœ¨ <code>collector-storage-define</code> çš„ <a href="https://github.com/YunaiV/skywalking/tree/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table" rel="external nofollow noopener noreferrer" target="_blank"><code>table</code></a> <strong>åŒ…</strong>ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰ Data ç±»ï¼Œ<strong>é</strong> <code>&quot;Table&quot;</code> ç»“å°¾ï¼Œä¾‹å¦‚ <a href="https://github.com/YunaiV/skywalking/blob/beebd8f8f419ca0b25dc086c71a9b1c580a083d4/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/Application.java" rel="external nofollow noopener noreferrer" target="_blank">Application</a> ã€‚</p><h3>2.3.1 Column</h3><p><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Column.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.Column</code></a> ï¼Œå­—æ®µã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Column.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>name</code></a> å±æ€§ï¼Œå­—æ®µåã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Column.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>operation</code></a> å±æ€§ï¼Œæ“ä½œ( Operation )ã€‚</li></ul><h3>2.3.2 Operation</h3><p><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Operation.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.data.Operation</code></a> ï¼Œæ“ä½œ<strong>æ¥å£</strong>ã€‚ç”¨äºä¸¤ä¸ªå€¼ä¹‹é—´çš„æ“ä½œï¼Œä¾‹å¦‚ï¼Œç›¸åŠ ç­‰ç­‰ã€‚ç›®å‰å®ç°ç±»æœ‰ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/operator/AddOperation.java" rel="external nofollow noopener noreferrer" target="_blank">AddOperation</a> ï¼šå€¼ç›¸åŠ æ“ä½œã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/operator/CoverOperation.java" rel="external nofollow noopener noreferrer" target="_blank">CoverOperation</a> ï¼šå€¼è¦†ç›–æ“ä½œï¼Œå³ä»¥æ–°å€¼ä¸ºè¿”å›ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/operator/NonOperation.java" rel="external nofollow noopener noreferrer" target="_blank">NonOperation</a> ï¼šç©ºæ“ä½œï¼Œå³ä»¥è€å€¼ä¸ºè¿”å›ã€‚</li></ul><h1>3. collector-storage-define</h1><p><code>collector-cluster-define</code> ï¼šå®šä¹‰å­˜å‚¨ç»„ä»¶æ¥å£ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/08.png" alt=""></p><h2>3.1 StorageModule</h2><p><code>org.skywalking.apm.collector.storage.StorageModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼Œé›†ç¾¤ç®¡ç† Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageModule.java#L67" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;storage&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageModule.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šåœ¨ <a href="https://github.com/YunaiV/skywalking/tree/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/dao" rel="external nofollow noopener noreferrer" target="_blank">org.skywalking.apm.collector.storage.dao</a> <strong>åŒ…</strong>ä¸‹çš„æ‰€æœ‰ç±» å’Œ IBatchDAOã€‚</p><h2>3.2 table åŒ…</h2><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/tree/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table</code></a> åŒ…ä¸‹ï¼Œå®šä¹‰äº†å­˜å‚¨æ¨¡å—æ‰€æœ‰çš„ Table å’Œ Data å®ç°ç±»ã€‚</p><h2>3.3 StorageInstaller</h2><p><code>org.skywalking.apm.collector.storage.StorageInstaller</code> ï¼Œå­˜å‚¨å®‰è£…å™¨<strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº TableDefine ï¼Œåˆå§‹åŒ–å­˜å‚¨ç»„ä»¶çš„è¡¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageInstaller.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>#defineFilter(List&lt;TableDefine&gt;)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¿‡æ»¤ TableDefine æ•°ç»„ä¸­ï¼Œéè‡ªèº«éœ€è¦çš„ã€‚ä¾‹å¦‚è¯´ï¼ŒElasticSearchStorageInstaller è¿‡æ»¤åï¼Œåªä¿ç•™ ElasticSearchTableDefine å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageInstaller.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#isExists(Client, TableDefine)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ¤æ–­è¡¨æ˜¯å¦å­˜åœ¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageInstaller.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteTable(Client, TableDefine)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ é™¤è¡¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageInstaller.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#createTable(Client, TableDefine)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ›å»ºè¡¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageInstaller.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#install(Client)</code></a> æ–¹æ³•ï¼ŒåŸºäº TableDefine ï¼Œåˆå§‹åŒ–å­˜å‚¨ç»„ä»¶çš„è¡¨ã€‚<ul><li>è¯¥æ–¹æ³•ä¼šè¢« StorageModuleH2Provider æˆ– StorageModuleEsProvider å¯åŠ¨æ—¶è°ƒç”¨ã€‚</li></ul></li></ul><h2>3.4 dao åŒ…</h2><p>åœ¨ <code>collector-storage-define</code> é¡¹ç›®ç»“æ„å›¾ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€å…±æœ‰<strong>ä¸¤</strong>ä¸ª <code>bao</code> åŒ…ï¼š</p><ul><li><code>org.skywalking.apm.collector.storage.base.dao</code> ï¼Œ<strong>ç³»ç»Ÿ</strong>çš„ DAO æ¥å£ã€‚</li><li><code>org.skywalking.apm.collector.storage.dao</code> ï¼Œ<strong>ä¸šåŠ¡</strong>çš„ DAO æ¥å£ã€‚<ul><li><strong>ç»§æ‰¿</strong>ç³»ç»Ÿçš„ DAO æ¥å£ã€‚</li><li>è¢« <code>collector-storage-xxx-provider</code> çš„ <code>dao</code> åŒ…<strong>å®ç°</strong>ã€‚</li></ul></li></ul><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/09.png" alt=""></p><h3>3.4.1 ç³»ç»Ÿ DAO</h3><p><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/DAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.base.dao.DAO</code></a> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼ŒDAO <strong>æ¥å£</strong>ã€‚</p><p>æ— ä»»ä½•æ–¹æ³•ã€‚</p><h4>3.4.1.1 AbstractDAO</h4><p><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/AbstractDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.base.dao.AbstractDAO</code></a> ï¼Œå®ç° DAO æ¥å£ï¼ŒDAO æŠ½è±¡åŸºç±»ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/AbstractDAO.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>client</code></a> å±æ€§ï¼Œæ•°æ®æ“ä½œå®¢æˆ·ç«¯ã€‚ä¾‹å¦‚ï¼ŒH2Client ã€ElasticSearchClient ã€‚</li></ul><p>åœ¨ <code>collector-storage-xxx-provider</code> æ¨¡å—ä¸­ï¼ŒH2DAO ã€EsDAO å®ç° AbstractDAO ã€‚</p><h4>3.4.1.2 IPersistenceDAO</h4><p><code>org.skywalking.apm.collector.storage.base.dao.IPersistenceDAO</code> ï¼Œå®ç° DAO æ¥å£ï¼ŒæŒä¹…åŒ– DAO <strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† Data çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/IPersistenceDAO.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#get(id)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ ¹æ® ID æŸ¥è¯¢ä¸€æ¡ Data ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/IPersistenceDAO.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteHistory(startTimestamp, endTimestamp)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ é™¤æ—¶é—´èŒƒå›´å†…çš„ Data ä»¬ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/IPersistenceDAO.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepareBatchInsert(data)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå‡†å¤‡æ‰¹é‡æ’å…¥æ“ä½œå¯¹è±¡ã€‚ä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/CpuMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CpuMetricEsPersistenceDAO#prepareBatchInsert(CpuMetric)</code></a> æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ <code>org.elasticsearch.action.index.IndexRequestBuilder</code> å¯¹è±¡ã€‚æ³¨æ„ï¼š<ul><li>è¯¥æ–¹æ³•ä¸ä¼šå‘èµ·å…·ä½“çš„ DAO æ“ä½œï¼Œä»…ä»…æ˜¯åˆ›å»ºæ’å…¥æ“ä½œå¯¹è±¡ï¼Œæœ€ç»ˆçš„æ‰§è¡Œåœ¨ <code>IBatchDAO#batchPersistence(List&lt;?&gt;)</code>ã€‚</li><li>è¯¥æ–¹æ³•åˆ›å»ºçš„æ˜¯æ‰¹é‡æ’å…¥æ“ä½œå¯¹è±¡ä»¬ä¸­çš„ä¸€ä¸ªã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/IPersistenceDAO.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepareBatchUpdate(data)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå‡†å¤‡æ‰¹é‡æ›´æ–°æ“ä½œå¯¹è±¡ã€‚ç±»ä¼¼ <code>#prepareBatchInsert(data)</code> æ–¹æ³•ã€‚</li></ul><h4>3.4.1.3 IBatchDAO</h4><p><code>org.skywalking.apm.collector.storage.base.dao.IBatchDAO</code> ï¼Œå®ç° DAO æ¥å£ï¼Œæ‰¹é‡æ“ä½œ DAO <strong>æ¥å£</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/2b700457124e7d4f788343d8bcd9a03d2e273aca/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/base/dao/IBatchDAO.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#batchPersistence(List&lt;?&gt; batchCollection)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œæ‰¹é‡æ“ä½œå¯¹è±¡æ•°ç»„ï¼Œå®ç°æ‰¹é‡æŒä¹…åŒ–æ•°æ®ã€‚<ul><li><code>batchCollection</code> <strong>æ–¹æ³•å‚æ•°</strong>ï¼Œé€šè¿‡ <code>IPersistenceDAO#prepareBatchInsert</code> æˆ– <code>IPersistenceDAO#prepareBatchUpdate</code> æ–¹æ³•ï¼Œç”Ÿæˆ<strong>æ¯ä¸ª</strong>æ“ä½œæ•°ç»„å…ƒç´ ã€‚</li><li>è¯¥æ–¹æ³•ä¼šè¢« <code>PersistenceTimer#extractDataAndSave(...)</code> æˆ– <code>PersistenceWorker#onWork(...)</code> æ–¹æ³•è°ƒç”¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ4. PersistenceWorkerã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><p>åœ¨ <code>collector-storage-xxx-provider</code> æ¨¡å—ä¸­ï¼ŒBatchH2DAO ã€BatchEsDAO å®ç° IBatchDAO ã€‚</p><h3>3.4.2 ä¸šåŠ¡ DAO</h3><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/445bf9da669784b28d24f2e31576d3b0673c2852/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/StorageModule.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>StorageModule#services()</code></a> æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸šåŠ¡ DAO æŒ‰ç…§<strong>ç”¨é€”</strong>å¯ä»¥æ‹†åˆ†æˆ<strong>å››ç§</strong>ï¼š</p><ul><li>Cache ï¼šç¼“å­˜åº”ç”¨ã€åº”ç”¨å®ä¾‹ã€æœåŠ¡å</li><li>Register ï¼šæ³¨å†Œåº”ç”¨ã€åº”ç”¨å®ä¾‹ã€æœåŠ¡å</li><li>Persistence ï¼šæŒä¹…åŒ–ï¼Œå®é™…å¯ä»¥ç†è§£æˆæ‰¹é‡æŒä¹…åŒ–</li><li>UI ï¼šSkyWaling UI æŸ¥è¯¢ä½¿ç”¨ã€‚</li></ul><p>é‚£ä¹ˆæ•´ç†å¦‚ä¸‹ï¼š</p><table><thead><tr><th>Package</th><th>Data</th><th>Cache / Register</th><th>Persistence</th><th>UI</th><th>å…³è”æ–‡ç« </th></tr></thead><tbody><tr><td>register</td><td>Application</td><td>âˆš</td><td></td><td></td><td></td></tr><tr><td>register</td><td>Instance</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>register</td><td>ServiceName</td><td>âˆš</td><td></td><td></td><td></td></tr><tr><td>jvm</td><td>CpuMetric</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>jvm</td><td>CMetric</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>jvm</td><td>MemoryMetric</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>jvm</td><td>MemoryPoolMetric</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>global</td><td>GlobalTrace</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>instance</td><td>InstPerformance</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>node</td><td>NodeComponent</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>node</td><td>NodeMapping</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>noderef</td><td>NodeReference</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>segment</td><td>SegmentCost</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>segment</td><td>Segment</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>service</td><td>ServiceEntry</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr><tr><td>serviceref</td><td>ServiceReference</td><td></td><td>âˆš</td><td>âˆš</td><td></td></tr></tbody></table><h1>4. collector-storage-h2-provider</h1><p><code>collector-storage-h2-provider</code> ï¼ŒåŸºäº H2 çš„å­˜å‚¨ç»„ä»¶å®ç°ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/12.png" alt=""></p><p><strong>è¯¥å®ç°æ˜¯å•æœºç‰ˆï¼Œå»ºè®®ä»…ç”¨äº SkyWalking å¿«é€Ÿä¸Šæ‰‹ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</strong>ã€‚</p><p>ç”±äºç”Ÿäº§ç¯å¢ƒä¸»è¦ä½¿ç”¨ ES çš„å­˜å‚¨ç»„ä»¶å®ç°ï¼Œæ‰€ä»¥æœ¬æ–‡æš‚ä¸è§£æç›¸å…³å®ç°ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹è‡ªå·±å—¨èµ·æ¥ã€‚</p><h1>5. collector-storage-es-provider</h1><p><code>collector-storage-es-provider</code> ï¼ŒåŸºäº ES çš„å­˜å‚¨ç»„ä»¶å®ç°ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/10.png" alt=""></p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œé€šè¿‡ <code>application.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">storage:</div><div class="line">  elasticsearch:</div><div class="line">    cluster_name: elasticsearch</div><div class="line">    cluster_transport_sniffer: true</div><div class="line">    cluster_nodes: 127.0.0.1:9300</div><div class="line">    index_shards_number: 2</div><div class="line">    index_replicas_number: 0</div><div class="line">    ttl: 7</div></pre></td></tr></table></figure><p></p><ul><li>ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæ¨è Elasticsearch é…ç½®æˆé›†ç¾¤ã€‚</li><li><code>cluster_name</code> ã€<code>cluster_transport_sniffer</code> ã€<code>cluster_nodes</code> ã€<code>index_shards_number</code> ã€<code>index_replicas_number</code> å‚æ•°ï¼ŒElasticsearch ç›¸å…³å‚æ•°ã€‚</li><li><code>ttl</code> ï¼šä¿ç•™ N å¤©å†…çš„æ•°æ®ã€‚è¶…è¿‡ N å¤©çš„æ•°æ®ï¼Œå°†è¢«è‡ªåŠ¨æ»šåŠ¨åˆ é™¤ã€‚<ul><li>è¯¥åŠŸèƒ½ç›®å‰ç‰ˆæœ¬<strong>æš‚æœªå‘å¸ƒ</strong>ï¼Œéœ€è¦ç­‰åˆ° 5.0 ç‰ˆæœ¬åã€‚</li></ul></li><li><a href="https://github.com/apache/incubator-skywalking/blob/master/docs/cn/Deploy-collector-in-cluster-mode-CN.md" rel="external nofollow noopener noreferrer" target="_blank">ã€Šéƒ¨ç½²é›†ç¾¤collectorã€‹</a></li></ul><h2>5.1 StorageModuleEsProvider</h2><p><code>org.skywalking.apm.collector.storage.es.StorageModuleEsProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº ES çš„å­˜å‚¨ç»„ä»¶æœåŠ¡æä¾›è€…ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;elasticsearch&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º StorageModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L119" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸º <code>&quot;cluster&quot;</code> ã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 71 è‡³ 75 è¡Œ ï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/elasticsearch/ElasticSearchClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.elasticsearch.ElasticSearchClient</code></a> å¯¹è±¡ã€‚</li><li>ç¬¬ 77 è‡³ 82 è¡Œ ï¼šåˆ›å»º DAO å¯¹è±¡ä»¬ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation()</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 90 è¡Œ ï¼šè°ƒç”¨ <code>ElasticSearchClient#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– ZookeeperClient ã€‚</li><li>ç¬¬ 93 è‡³ 94 è¡Œ ï¼šåˆ›å»º ElasticSearchStorageInstaller å¯¹è±¡ï¼Œåˆå§‹åŒ–å­˜å‚¨ç»„ä»¶çš„è¡¨ã€‚åœ¨ <a href="#">ã€Œ5.2.4 ElasticSearchStorageInstallerã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 100 è‡³ 102 è¡Œ ï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsRegistration.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.StorageModuleEsRegistration</code></a> å¯¹è±¡ï¼Œå¹¶æ³¨å†Œä¿¡æ¯åˆ°é›†ç¾¤ç®¡ç†ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 105 è‡³ 107 è¡Œ ï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsNamingListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.StorageModuleEsNamingListener</code></a> å¯¹è±¡ï¼Œå¹¶æ³¨å†Œä¿¡æ¯åˆ°é›†ç¾¤ç®¡ç†ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 110 è‡³ 111 è¡Œ ï¼šåˆ›å»º DataTTLKeeperTimer å¯¹è±¡ã€‚åœ¨ <a href="#">ã€Œ5.4 DataTTLKeeperTimerã€</a> è¯¦ç»†è§£æã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/7eecc004e69685fe6f5ce3b3dc4822475d6aa713/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨å®Œæˆé€»è¾‘ã€‚</p><ul><li>ç¬¬ 115 è¡Œ ï¼šè°ƒç”¨ <code>DataTTLKeeperTimer#start()</code> æ–¹æ³•ï¼Œå¯åŠ¨ DataTTLKeeperTimer ã€‚åœ¨æœ¬æ–‡ <a href="#">ã€Œ5.4 DataTTLKeeperTimerã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>5.2 define åŒ…</h2><p>åœ¨ <code>collector-storage-es-provider</code> é¡¹ç›®ç»“æ„å›¾ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€å…±æœ‰<strong>ä¸¤</strong>ä¸ª <code>define</code> åŒ…ï¼š</p><ul><li><code>org.skywalking.apm.collector.storage.es.base.define</code> ï¼Œ<strong>ç³»ç»Ÿ</strong>çš„ TableDefine æŠ½è±¡ç±»ã€‚</li><li><code>org.skywalking.apm.collector.storage.es.define</code> ï¼Œ<strong>ä¸šåŠ¡</strong>çš„ TableDefine å®ç°ç±»ã€‚<ul><li><strong>ç»§æ‰¿</strong>ç³»ç»Ÿçš„ TableDefine æŠ½è±¡ç±»ã€‚</li></ul></li></ul><h3>5.2.1 ElasticSearchTableDefine</h3><p><code>org.skywalking.apm.collector.storage.es.base.define.ElasticSearchTableDefine</code> ï¼Œå®ç° TableDefine æ¥å£ï¼ŒåŸºäº Elasticsearch çš„è¡¨å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/7a4a409e266b953e523dca14a7ba88af07039f57/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/define/ElasticSearchTableDefine.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#type()</code></a> æ–¹æ³•ï¼Œæ–‡æ¡£å…ƒæ•°æ® <code>_type</code> å­—æ®µï¼Œå‚è§ <a href="http://geosmart.github.io/2016/07/22/Elasticsearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#type" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠElasticsearchå­¦ä¹ ç¬”è®°ã€‹ã€Œ_typeã€</a> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/7a4a409e266b953e523dca14a7ba88af07039f57/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/define/ElasticSearchTableDefine.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#refreshInterval()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ–‡æ¡£ç´¢å¼•åˆ·æ–°é¢‘ç‡ï¼Œå‚è§ <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/near-real-time.html#refresh-api" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠElasticsearch: æƒå¨æŒ‡å— Â» åŸºç¡€å…¥é—¨ Â» åˆ†ç‰‡å†…éƒ¨åŸç† Â» è¿‘å®æ—¶æœç´¢ã€‹ã€Œrefresh APIã€</a>ã€‚</li></ul><h3>5.2.2 ElasticSearchColumnDefine</h3><p><code>org.skywalking.apm.collector.storage.es.base.define.ElasticSearchColumnDefine</code> ï¼Œå®ç° ColumnDefine æŠ½è±¡ç±»ï¼ŒåŸºäº ES çš„å­—æ®µå®šä¹‰ã€‚</p><ul><li><a href="https://github.com/peng-yongsheng/incubator-skywalking/blob/89c601ba386d30acb04b3713a90b52e6c0d501d8/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/apache/skywalking/apm/collector/storage/es/base/define/ElasticSearchColumnDefine.java#L32" rel="external nofollow noopener noreferrer" target="_blank">Type</a> <strong>æšä¸¾</strong>ç±»ï¼šæšä¸¾ ES å­—æ®µç±»å‹ã€‚</li></ul><h3>5.2.3 ä¸šåŠ¡ TableDefine å®ç°ç±»</h3><p>åœ¨ <a href="https://github.com/peng-yongsheng/incubator-skywalking/tree/89c601ba386d30acb04b3713a90b52e6c0d501d8/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/apache/skywalking/apm/collector/storage/es/define" rel="external nofollow noopener noreferrer" target="_blank"><code>org.apache.skywalking.apm.collector.storage.es.define</code></a> <strong>åŒ…</strong>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<strong>æ‰€æœ‰</strong>åŸºäº ES çš„ä¸šåŠ¡ TableDefine å®ç°ç±»ã€‚ä¾‹å¦‚ï¼š<a href="https://github.com/peng-yongsheng/incubator-skywalking/blob/89c601ba386d30acb04b3713a90b52e6c0d501d8/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/apache/skywalking/apm/collector/storage/es/define/ApplicationEsTableDefine.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationEsTableDefine</a> ã€‚</p><p>æ•´ä½“ <code>#refreshInterval()</code> æ–¹æ³•è¿”å›çš„ç»“æœå¦‚ä¸‹ï¼š</p><ul><li>1 s<ul><li>CpuMetricEsTableDefine</li><li>GCMetricEsTableDefine</li><li>MemoryMetricEsTableDefine</li><li>MemoryPoolMetricEsTableDefine</li></ul></li><li>2 s<ul><li>InstPerformanceEsTableDefine</li><li>NodeComponentEsTableDefine</li><li>NodeMappingEsTableDefine</li><li>NodeReferenceEsTableDefine</li><li>ServiceEntryEsTableDefine</li><li>ServiceReferenceEsTableDefine</li></ul></li><li>2 s &amp;&amp; <a href="https://static.javadoc.io/org.elasticsearch/elasticsearch/5.0.0/org/elasticsearch/action/support/WriteRequest.RefreshPolicy.html#IMMEDIATE" rel="external nofollow noopener noreferrer" target="_blank">WriteRequest.RefreshPolicy.IMMEDIATE</a><ul><li>ã€WriteRequest.RefreshPolicy.IMMEDIATEã€‘å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsRegisterDAO.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationEsRegisterDAO#save(Application)</code></a> æ–¹æ³•</li><li>ApplicationEsTableDefine</li><li>InstanceEsTableDefine</li><li>ServiceNameEsTableDefine</li></ul></li><li>5 s<ul><li>GlobalTraceEsTableDefine</li><li>SegmentCostEsTableDefine</li></ul></li><li>10 s<ul><li>SegmentEsTableDefine</li></ul></li></ul><h3>5.2.4 ElasticSearchStorageInstaller</h3><blockquote><p>å‹æƒ…æç¤ºï¼šElasticSearchStorageInstaller ä¸»è¦æ˜¯å¯¹ Elasticsearch Java API çš„ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œå¯ä»¥ Google ä¸‹ã€‚</p></blockquote><p><code>org.skywalking.apm.collector.storage.es.base.define.ElasticSearchStorageInstaller</code> ï¼Œå®ç° StorageInstaller æŠ½è±¡ç±»ï¼Œ åŸºäº ES å­˜å‚¨å®‰è£…å™¨å®ç°ç±»ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/222024defff2d1a7647dbeb5811cad146c49a604/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/define/ElasticSearchStorageInstaller.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#defineFilter(List&lt;TableDefine&gt;)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿‡æ»¤æ•°ç»„ä¸­ï¼Œé ElasticSearchTableDefine çš„å…ƒç´ ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/222024defff2d1a7647dbeb5811cad146c49a604/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/define/ElasticSearchStorageInstaller.java#L63" rel="external nofollow noopener noreferrer" target="_blank"><code>#createTable(Client, TableDefine)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º Elasticsearch ç´¢å¼•ã€‚<ul><li>æ–‡æ¡£æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š<ul><li><code>_id</code> ï¼šæ•°æ®ç¼–å·ï¼ŒString ç±»å‹ã€‚</li><li><code>_type</code> ï¼š<code>&quot;type&quot;</code> ã€‚</li><li><code>_index</code> ï¼šTableDefine å®šä¹‰çš„<strong>è¡¨å</strong>ã€‚</li><li><code>source</code> ï¼šData æ•°æ®ã€‚</li></ul></li><li>äº†è§£ Elasticsearch çš„èƒ–å‹å¯èƒ½æœ‰å’Œç¬”è€…ä¸€æ ·çš„ç–‘æƒ‘ï¼Œç½‘ç»œä¸Šå¾ˆå¤šæ–‡ç« æŠŠ <code>_index</code> ç±»æ¯”æˆå…³ç³»æ•°æ®åº“çš„ DB ï¼Œ<code>_type</code> ç±»æ¯”æˆå…³ç³»æ•°æ®åº“çš„ Table ï¼Œå’Œ SkyWalking ç›®å‰ä½¿ç”¨çš„æ–¹å¼<strong>ä¸ä¸€è‡´</strong>ï¼Ÿ<ul><li>SkyWalking <a href="https://github.com/peng-yongsheng" rel="external nofollow noopener noreferrer" target="_blank">å½­å‹‡å‡</a> ï¼š<code>_index</code>å’Œ <code>_type</code> æ˜¯ ES ç‰¹æœ‰çš„ï¼Œè€ƒè™‘å…¶ä»–æ•°æ®åº“æ¥å…¥ï¼Œæ‰€ä»¥æ²¡æœ‰ç”¨ä»–è¿™ä¸ªç‰¹æ€§ã€‚</li><li>SkyWalking QQäº¤æµç¾¤( 392443393 ) ï¼Œ<a href="#">å°å¿ƒ</a> ç¾¤å‹ ï¼š<code>_type</code> æœ¬æ¥å°±æ²¡åšç‰©ç†éš”ç¦»ï¼ŒLucene å±‚é¢ä¹Ÿä¸å­˜åœ¨ï¼ŒES 6.x å·²ç»åºŸå¼ƒäº†ã€‚</li><li><a href="https://elasticsearch.cn/article/158" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠElasticsearch 6.0 å°†ç§»é™¤ Typeã€‹</a></li></ul></li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/222024defff2d1a7647dbeb5811cad146c49a604/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/define/ElasticSearchStorageInstaller.java#L131" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteTable(Client, TableDefine)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ é™¤ Elasticsearch ç´¢å¼•ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/222024defff2d1a7647dbeb5811cad146c49a604/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/define/ElasticSearchStorageInstaller.java#L141" rel="external nofollow noopener noreferrer" target="_blank"><code>#isExists(Client, TableDefine)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ¤æ–­ Elasticsearch ç´¢å¼•æ˜¯å¦å­˜åœ¨ã€‚</li><li>åœ¨æ–¹æ³•é‡Œï¼Œç¬”è€…æ·»åŠ äº†ä¸€äº› API çš„è¯´æ˜ï¼Œä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œå¯ä»¥ä»”ç»†é˜…è¯»ç†è§£ã€‚</li></ul><h2>5.3 dao åŒ…</h2><p>åœ¨ <code>collector-storage-es-provider</code> é¡¹ç›®ç»“æ„å›¾ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€å…±æœ‰<strong>ä¸¤</strong>ä¸ª <code>dao</code> åŒ…ï¼š</p><ul><li><code>org.skywalking.apm.collector.storage.es.base.dao</code> ï¼Œ<strong>ç³»ç»Ÿ</strong>çš„ DAO æŠ½è±¡ç±»ã€‚</li><li><code>org.skywalking.apm.collector.storage.es.dao</code> ï¼Œ<strong>ä¸šåŠ¡</strong>çš„ DAO å®ç°ç±»ã€‚<ul><li><strong>ç»§æ‰¿</strong>ç³»ç»Ÿçš„ DAO æŠ½è±¡ç±»ã€‚</li></ul></li></ul><h3>5.3.1 EsDAO</h3><p><code>org.skywalking.apm.collector.storage.es.base.dao.EsDAO</code> ï¼Œå®ç° AbstractDAO æŠ½è±¡ç±»ï¼ŒåŸºäº ES çš„ DAO <strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/dao/EsDAO.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMaxId(indexName, columnName)</code></a> æ–¹æ³•ï¼Œè·å¾—ç´¢å¼•åçš„æŒ‡å®šå­—æ®µçš„<strong>æœ€å¤§å€¼</strong>ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/dao/EsDAO.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMinId(indexName, columnName)</code></a> æ–¹æ³•ï¼Œè·å¾—ç´¢å¼•åçš„æŒ‡å®šå­—æ®µçš„<strong>æœ€å°å€¼</strong>ã€‚</li></ul><h3>5.3.2 BatchEsDAO</h3><p><code>org.skywalking.apm.collector.storage.es.base.dao.BatchEsDAO</code> ï¼Œå®ç° IBatchDAO æ¥å£ï¼Œç»§æ‰¿ EsDAO æŠ½è±¡ç±»ï¼ŒåŸºäº ES æ‰¹é‡æ“ä½œ DAO å®ç°ç±»ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/base/dao/BatchEsDAO.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#batchPersistence(List&lt;?&gt;)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå°† <code>org.elasticsearch.action.index.IndexRequestBuilder</code> å’Œ <code>org.elasticsearch.action.index.UpdateRequestBuilder</code> æ•°ç»„ï¼Œåˆ›å»ºæˆ <code>org.elasticsearch.action.bulk.BulkRequestBuilder</code> å¯¹è±¡ï¼Œæ‰¹é‡æŒä¹…åŒ–ã€‚<ul><li>IndexRequestBuilder å’Œ UpdateRequestBuilder çš„åˆ›å»ºï¼Œåœ¨ <a href="#">ã€Œ5.3.3 ä¸šåŠ¡ DAO å®ç°ç±»ã€</a> ä¼šçœ‹åˆ°ã€‚</li></ul></li></ul><h3>5.3.3 ä¸šåŠ¡ DAO å®ç°ç±»</h3><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/tree/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao" rel="external nofollow noopener noreferrer" target="_blank"><code>org.apache.skywalking.apm.collector.storage.es.dao</code></a> <strong>åŒ…</strong>é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<strong>æ‰€æœ‰</strong>åŸºäº ES çš„ä¸šåŠ¡ DAO å®ç°ç±»ã€‚</p><p>å®ç°ä»£ç æ˜“æ‡‚ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±é˜…è¯»ã€‚è‰¯å¿ƒå¦‚æˆ‘ä»¬ï¼ŒæŒ‰ç…§ DAO çš„ä¸šåŠ¡ç”¨é€”ï¼Œæ¨èä¾‹å­å¦‚ä¸‹ï¼š</p><ul><li>Cache ï¼š<a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsCacheDAO.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationEsCacheDAO</a></li><li>Register ï¼š<a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsRegisterDAO.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationEsRegisterDAO</a></li><li>Persistence ï¼š<a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank">SegmentEsPersistenceDAO</a><ul><li>æ­¤å¤„å¯è§ IndexRequestBuilder å’Œ UpdateRequestBuilder çš„åˆ›å»ºã€‚</li></ul></li><li>UI ï¼š<a href="https://github.com/YunaiV/skywalking/blob/6f925c180fbd1bb543fbf5bbf6fafe118f031d11/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentEsUIDAO.java" rel="external nofollow noopener noreferrer" target="_blank">SegmentEsUIDAO</a></li></ul><h2>5.4 DataTTLKeeperTimer</h2><p><code>org.skywalking.apm.collector.storage.es.DataTTLKeeperTimer</code> ï¼Œè¿‡æœŸæ•°æ®åˆ é™¤<strong>å®šæ—¶å™¨</strong>ã€‚é€šè¿‡è¯¥å®šæ—¶å™¨ï¼Œåªä¿ç•™ N å¤©å†…çš„æ•°æ®ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/efe2967813b706ae97901d7620fef9d7f975e745/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/DataTTLKeeperTimer.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> æ–¹æ³•ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡ã€‚<ul><li>ç¬¬ 49 è¡Œï¼šåˆ›å»ºå»¶è¿Ÿ 1 å°æ—¶ï¼Œæ¯ 8 å°æ—¶æ‰§è¡Œä¸€æ¬¡ <code>#delete()</code> æ–¹æ³•çš„å®šæ—¶ä»»åŠ¡ã€‚ç›®å‰è¯¥è¡Œä»£ç è¢«æ³¨é‡Šï¼Œèƒ–å‹å¯ä»¥ç­‰å¾… SkyWallking 5.0 ç‰ˆæœ¬çš„å‘å¸ƒã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/efe2967813b706ae97901d7620fef9d7f975e745/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/DataTTLKeeperTimer.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#delete()</code></a> æ–¹æ³•ï¼Œåˆ é™¤è¿‡æœŸæ•°æ®ã€‚<ul><li>ç¬¬ 54 è‡³ 66 è¡Œï¼šè®¡ç®—åˆ é™¤çš„å¼€å§‹ä¸ç»“æŸæ—¶é—´ï¼Œå³æŒ‡å®šæ—¶é—´çš„<strong>å‰ä¸€å¤©</strong>ã€‚ä¾‹å¦‚ï¼Œ2017-12-23 æ‰§è¡Œæ—¶ï¼Œåˆ é™¤ 2017-12-16 é‚£å¤©çš„æ•°æ®ã€‚</li><li>ç¬¬ 69 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/efe2967813b706ae97901d7620fef9d7f975e745/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/DataTTLKeeperTimer.java#L73" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteJVMRelatedData(startTimestamp, endTimestamp)</code></a> æ–¹æ³•ï¼Œåˆ é™¤ JVM ç›¸å…³çš„æ•°æ®ã€‚</li><li>ç¬¬ 70 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/efe2967813b706ae97901d7620fef9d7f975e745/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/DataTTLKeeperTimer.java#L87" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteTraceRelatedData(startTimestamp, endTimestamp)</code></a> æ–¹æ³•ï¼Œåˆ é™¤ Trace ç›¸å…³çš„æ•°æ®ã€‚</li></ul></li></ul><p>å¦‚ä¸‹æ˜¯<strong>ä¸ä¼šåˆ é™¤</strong>çš„æ•°æ®çš„è¡¨ï¼š</p><ul><li>Application</li><li>Instance</li><li>ServiceName</li><li>ServiceEntry</li></ul><h1>666. å½©è›‹</h1><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="çŸ¥è¯†æ˜Ÿçƒ"></p><p>ğŸ˜ˆ æœ‰ç§è‡ªå·±æŠŠç®€å•çš„ä¸œè¥¿å†™çš„å¤ªå¤æ‚äº†ï¼Œæ‚²ä¼¤ã€‚</p><p>èƒ–å‹æœ›è§è°…ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/11.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/SkyWalking/">SkyWalking</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/SkyWalking/collector-storage-module/" data-title="SkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/SkyWalking/collector-streaming-first/" title="SkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰"><strong>PREVIOUS:</strong><br><span>SkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰</span></a></div><div class="next"><a href="/SkyWalking/collector-queue-module/" title="SkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶"><strong>NEXT:</strong><br><span>SkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. apm-collector-core</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 TableDefine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 ColumnDefine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 Loader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 Column</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 Operation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. collector-storage-define</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 StorageModule</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 table åŒ…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 StorageInstaller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 dao åŒ…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 ç³»ç»Ÿ DAO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">3.4.1.1 AbstractDAO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">3.4.1.2 IPersistenceDAO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.1.3.</span> <span class="toc-text">3.4.1.3 IBatchDAO</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 ä¸šåŠ¡ DAO</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. collector-storage-h2-provider</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">5. collector-storage-es-provider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 StorageModuleEsProvider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 define åŒ…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 ElasticSearchTableDefine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 ElasticSearchColumnDefine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.3.</span> <span class="toc-text">5.2.3 ä¸šåŠ¡ TableDefine å®ç°ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.4.</span> <span class="toc-text">5.2.4 ElasticSearchStorageInstaller</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 dao åŒ…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 EsDAO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 BatchEsDAO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.3.3.</span> <span class="toc-text">5.3.3 ä¸šåŠ¡ DAO å®ç°ç±»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 DataTTLKeeperTimer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>6</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å…«/" title="èŠ‹é“æºç çš„å‘¨å…«">èŠ‹é“æºç çš„å‘¨å…«<sup>10</sup></a></li></ul></div><div id="authorInfo2"><div><img width="100%" src="/images/common/zsxq/02.png"></div></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>