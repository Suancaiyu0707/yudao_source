<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ® | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-receive-trace/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº SkyWalking 3.2.6 æ­£å¼ç‰ˆ

1. æ¦‚è¿°
2. TraceSegmentServiceHandle"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/SkyWalking/collector-receive-trace/" title="SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®" itemprop="url">SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-receive-trace/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº SkyWalking 3.2.6 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2. TraceSegmentServiceHandler</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2.1 TraceSegmentService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2.2 SegmentParse</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2.3 Standardization æ ‡å‡†åŒ–</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3. Buffer æ–‡ä»¶</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3.1 åˆå§‹åŒ–</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3.2 å†™å…¥</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3.3 è¯»å–</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œé“¾è·¯çš„è¿½è¸ªå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Agent æ”¶é›† Trace æ•°æ®ã€‚</li><li>Agent å‘é€ Trace æ•°æ®ç»™ Collector ã€‚</li><li><strong>Collector æ¥æ”¶ Trace æ•°æ®</strong>ã€‚</li><li>Collector å­˜å‚¨ Trace æ•°æ®åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼Œæ•°æ®åº“ã€‚</li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†äº«ã€ç¬¬ä¸‰éƒ¨åˆ†ã€‘ <strong>SkyWalking Collector æ¥æ”¶ Trace æ•°æ®</strong>ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šCollector æ¥æ”¶åˆ° TraceSegment çš„æ•°æ®ï¼Œå¯¹åº”çš„ç±»æ˜¯ Protobuf ç”Ÿæˆçš„ã€‚è€ƒè™‘åˆ°æ›´åŠ æ˜“è¯»æ˜“æ‡‚ï¼Œæœ¬æ–‡ä½¿ç”¨ TraceSegment ç›¸å…³çš„<strong>åŸå§‹ç±»</strong>ã€‚</p></blockquote><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/01.png" alt=""></p><ul><li>Collector æ¥æ”¶åˆ° TraceSegment æ•°æ®åï¼Œè¿›è¡Œ<strong>æ„å»º</strong>ã€‚</li><li>ã€è“è‰²æµç¨‹ã€‘æ„å»º<strong>æˆåŠŸ</strong>ï¼Œè¿›è¡Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆå­˜å‚¨åˆ°å­˜å‚¨å™¨( ä¾‹å¦‚ï¼ŒES / H2 )ã€‚</li><li>ã€ç²‰è‰²æµç¨‹ã€‘æ„å»º<strong>å¤±è´¥</strong>ï¼Œå†™å…¥ Buffer æ–‡ä»¶è¿›è¡Œæš‚å­˜ã€‚</li><li>ã€ç»¿è‰²æµç¨‹ã€‘åå°çº¿ç¨‹ï¼Œå®šæ—¶è¯»å– Buffer æ–‡ä»¶ï¼Œé‡æ–°æäº¤æ„å»ºã€‚</li></ul><p><strong>ä»€ä¹ˆæ˜¯æ„å»º</strong>ï¼Ÿ</p><p>ä» TraceSegment <strong>æ•°æ®</strong>ä¸­ï¼Œä¼šæ„å»ºå‡ºæ›´å¤šçš„<strong>æ•°æ®ç»´åº¦</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/02.png" alt=""></p><p>æ„å»ºçš„è¿‡ç¨‹ï¼Œæœ¬æ–‡åªåˆ†äº«<strong>è°ƒç”¨</strong>çš„è¿‡ç¨‹ï¼Œå…·ä½“æ€ä¹ˆ<strong>ç”Ÿæˆ</strong>æ–°çš„æ•°æ®ï¼Œæ•°æ®çš„<strong>æµå¼å¤„ç†ä¸å­˜å‚¨</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/?self">ã€ŠSkyWalking æºç è§£æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®ã€‹</a> è¯¦ç»†è§£æã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ„å»ºä¼šå¤±è´¥</strong>ï¼Ÿ</p><p>åœ¨ TraceSegment é‡Œçš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚æ“ä½œå( <code>operationName</code> )å’Œæ“ä½œç¼–å·( <code>operationId</code> ) ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®ã€‹</a> ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè€ƒè™‘åˆ°ç½‘ç»œä¼ è¾“ï¼Œä¼˜å…ˆä½¿ç”¨ <code>operationId</code> ï¼Œè‹¥ä¸å­˜åœ¨( ä¾‹å¦‚æ“ä½œè¿˜æœªæ³¨å†Œï¼Œæˆ–è€…æ³¨å†Œäº† Agent æœªåŒæ­¥åˆ°æœ¬åœ° )ï¼Œåˆ™ä½¿ç”¨ <code>operationName</code> ã€‚</p><p>ä½†æ˜¯ï¼ŒCollector æ„å»ºè¿‡ç¨‹æ—¶ï¼Œè¦æ±‚çš„æ˜¯ <code>operationId</code> ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ <code>operationName</code> æ—¶ï¼Œéœ€è¦å°† <code>operationName</code> è½¬æ¢æˆ <code>operationId</code> ã€‚è‹¥æ­¤æ—¶ <code>operationName</code> æœªæ³¨å†Œæ—¶ï¼Œåˆ™æ— æ³•è·å–åˆ° <code>operationId</code> ï¼Œå¯¼è‡´<strong>æ„å»ºå¤±è´¥</strong>ã€‚</p><p>é‚£ä¹ˆæœ‰èƒ–å‹å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œåœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæ³¨å†Œ <code>operationName</code> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œ åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent DictionaryManager å­—å…¸ç®¡ç†ã€‹ã€Œ2.2 æ“ä½œçš„åŒæ­¥ APIã€</a> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>operationName</code> çš„æ³¨å†Œï¼Œæ˜¯<strong>å¼‚æ­¥</strong>çš„è¿‡ç¨‹ã€‚å› è€Œï¼Œå³ä½¿æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨æ³¨å†Œï¼Œä¹Ÿæ— æ³•è·å¾— <code>operationId</code> ã€‚</p><p>æ¶‰åŠçš„é€»è¾‘ç‚¹æ¯”è¾ƒå¤šï¼Œå¦‚æœèƒ–å‹ç†è§£ä¸èƒ½ï¼Œä¸‹é¢æˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹ä»£ç ã€‚</p><h1>2. TraceSegmentServiceHandler</h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-network/src/main/proto/TraceSegmentService.proto#L9" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentService.proto</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/03.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/TraceSegmentServiceHandler.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentServiceHandler#collect(Application, StreamObserver&lt;ApplicationMapping&gt;)</code></a>, ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 51 è¡Œï¼šè°ƒç”¨ <code>ITraceSegmentService#send(UpstreamSegment)</code> æ–¹æ³•ï¼Œå¤„ç†<strong>ä¸€æ¡</strong> TraceSegment ã€‚</li></ul><h2>2.1 TraceSegmentService</h2><p><code>org.skywalking.apm.collector.agent.stream.service.trace.ITraceSegmentService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼ŒTraceSegment æœåŠ¡æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-define/src/main/java/org/skywalking/apm/collector/agent/stream/service/trace/ITraceSegmentService.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#send(UpstreamSegment)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå¤„ç†<strong>ä¸€æ¡</strong> TraceSegment ã€‚</li></ul><p><code>org.skywalking.apm.collector.agent.stream.worker.trace.ApplicationIDService</code> ï¼Œå®ç° IApplicationIDService æ¥å£ï¼ŒTraceSegment æœåŠ¡å®ç°ç±»ã€‚</p><ul><li><p>å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/TraceSegmentService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#send(UpstreamSegment)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 40 è‡³ 41 è¡Œï¼šåˆ›å»º SegmentParse å¯¹è±¡ï¼Œåè°ƒç”¨ <code>SegmentParse#parse(UpstreamSegment, Source)</code> æ–¹æ³•ï¼Œè§£æå¹¶å¤„ç† TraceSegment ã€‚</li></ul></li></ul><h2>2.2 SegmentParse</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.SegmentParse</code></a> ï¼ŒSegment è§£æå™¨ã€‚å±æ€§å¦‚ä¸‹ï¼š</p><ul><li><code>spanListeners</code> å±æ€§ï¼ŒSpan ç›‘å¬å™¨é›†åˆã€‚<strong>é€šè¿‡ä¸åŒçš„ç›‘å¬å™¨ï¼Œå¯¹ TraceSegment è¿›è¡Œæ„å»ºï¼Œç”Ÿæˆä¸åŒçš„æ•°æ®</strong>ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#SegmentParse(ModuleManager)</code> æ„é€ æ–¹æ³•</a> ï¼Œä¼šçœ‹åˆ°å®ƒçš„åˆå§‹åŒ–ã€‚</li><li><code>segmentId</code> å±æ€§ï¼ŒTraceSegment ç¼–å·ï¼Œå³ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.traceSegmentId</code></a> ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œç¬¬ä¸€ä¸ª Span çš„å¼€å§‹æ—¶é—´ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>#parse(UpstreamSegment, Source)</code></a> æ–¹æ³•ï¼Œè§£æå¹¶å¤„ç† TraceSegment ã€‚åœ¨è¯¥æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œæœ¬æ–‡å¼€å¤´æåˆ°çš„ã€<strong>æ„é€ </strong>ã€‘ã€‚æ•´ä¸ªæ„é€ çš„è¿‡ç¨‹ï¼Œå®é™…åˆ†æˆ<strong>ä¸¤æ­¥</strong>ï¼š1ï¼‰é¢„æ„å»ºï¼›2ï¼‰æ‰§è¡Œæ„å»ºã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 88 è‡³ 89 è¡Œï¼šä» <code>segment</code> å‚æ•°ä¸­ï¼Œè§£æå‡º ï¼š<ul><li><code>traceIds</code> ï¼Œå…³è”çš„é“¾è·¯è¿½è¸ª<strong>å…¨å±€ç¼–å·</strong>ã€‚</li><li><code>segmentObject</code> ï¼ŒTraceSegmentObject å¯¹è±¡ã€‚</li></ul></li><li>ç¬¬ 91 è¡Œï¼šåˆ›å»º SegmentDecorator å¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„ç”¨é€”ï¼Œåœ¨ <a href="#">ã€Œ2.3 Standardization æ ‡å‡†åŒ–ã€</a> ç»Ÿä¸€è§£æã€‚</li><li>-------- æ„å»ºå¤±è´¥ --------</li><li>ç¬¬ 94 è¡Œï¼šè°ƒç”¨ <code>#preBuild(List&lt;UniqueId&gt;, SegmentDecorator)</code> æ–¹æ³•ï¼Œ<strong>é¢„æ„å»º</strong>ã€‚</li><li>ç¬¬ 97 è‡³ 99 è¡Œï¼šè°ƒç”¨ <code>#writeToBufferFile()</code> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Buffer æ–‡ä»¶<strong>æš‚å­˜</strong>ã€‚ä¸ºä»€ä¹ˆä¼šåˆ¤æ–­ <code>source == Source.Agent</code> å‘¢ï¼Ÿ<code>#parse(UpstreamSegment, Source)</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œå…±æœ‰<strong>ä¸¤ä¸ª</strong> <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L256" rel="external nofollow noopener noreferrer" target="_blank">Source</a> ï¼š<ul><li>ç›®å‰æˆ‘ä»¬çœ‹åˆ° TraceSegmentService çš„è°ƒç”¨ä½¿ç”¨çš„æ˜¯ <code>Source.Agent</code> ã€‚</li><li>è€Œåå°çº¿ç¨‹ï¼Œå®šæ—¶è°ƒç”¨è¯¥æ–¹æ³•é‡æ–°æ„å»ºä½¿ç”¨çš„æ˜¯ <code>Source.Buffer</code> ï¼Œå¦‚æœä¸åŠ ç›–åˆ¤æ–­ï¼Œä¼šé¢„æ„å»ºå¤±è´¥<strong>é‡å¤</strong>å†™å…¥ã€‚</li></ul></li><li>ç¬¬ 100 è¡Œï¼šè¿”å› <code>false</code> ï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥ã€‚</li><li>-------- æ„å»ºæˆåŠŸ --------</li><li>ç¬¬ 106 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L199" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyListenerToBuild()</code></a> æ–¹æ³•ï¼Œé€šçŸ¥ Span ç›‘å¬å™¨ä»¬ï¼Œ<strong>æ‰§è¡Œæ„å»º</strong>å„è‡ªçš„æ•°æ®ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/?self">ã€ŠSkyWalking æºç è§£æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 109 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L177" rel="external nofollow noopener noreferrer" target="_blank"><code>buildSegment(id, dataBinary)</code></a> æ–¹æ³•ï¼Œ<strong>æ‰§è¡Œæ„å»º</strong> TraceSegment ã€‚</li><li>ç¬¬ 110 è¡Œï¼šè¿”å› <code>true</code> ï¼Œè¡¨ç¤ºæ„å»ºæˆåŠŸã€‚</li><li>ç¬¬ 112 è‡³ 115 è¡Œï¼šå‘ç”Ÿ InvalidProtocolBufferException å¼‚å¸¸ï¼Œè¿”å› <code>false</code> ï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥ã€‚</li></ul><h3>2.2.1 é¢„æ„å»º</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>#preBuild(List&lt;UniqueId&gt;, SegmentDecorator)</code></a> æ–¹æ³•ï¼Œå‰ç½®æ„å»ºï¼Œç”¨äº<strong>é€šè¿‡ä¸åŒçš„ç›‘å¬å™¨ï¼Œå¯¹ TraceSegment è¿›è¡Œæ„å»ºï¼Œç”Ÿæˆä¸åŒçš„æ•°æ®</strong>ã€‚åœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”Ÿæˆ‘ä»¬åœ¨æ–‡ç« å¤´æ‰€è¯´çš„ï¼Œ&quot;<strong>ä¸ºä»€ä¹ˆæ„å»ºä¼šå¤±è´¥</strong>&quot;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 120 è‡³ 128 è¡Œï¼šæ‹¼æ¥ç”Ÿæˆ <code>segmentId</code> ã€‚</li><li>ç¬¬ 131 è‡³ 133 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L132" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyGlobalsListener(...)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨ GlobalTraceSpanListener å¤„ç†é“¾è·¯è¿½è¸ªå…¨å±€ç¼–å·æ•°ç»„( <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.relatedGlobalTraces</code></a> )ã€‚</li><li>ç¬¬ 139 è‡³ 147 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L239" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyRefsListener(...)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨ RefsListener å¤„ç†çˆ¶ Segment æŒ‡å‘æ•°ç»„( <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.refs</code></a> )ã€‚<ul><li>ç¬¬ 140 è‡³ 144 è¡Œï¼šè°ƒç”¨ <code>ReferenceIdExchanger#exchange(ReferenceDecorator, applicationId)</code> æ–¹æ³•ï¼Œå°† TraceSegmentRef æœªç”Ÿæˆç¼–å·çš„å±æ€§ï¼Œè¿›è¡Œå…‘æ¢å¤„ç†ã€‚<strong>è‹¥å…‘æ¢å¤±è´¥ï¼Œè¿”å›æ„é€ å¤±è´¥</strong>ã€‚åœ¨ <a href="#">ã€Œ2.3 Standardization æ ‡å‡†åŒ–ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 149 è‡³ 172 è¡Œï¼šå¤„ç† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.spans</code></a> å±æ€§ã€‚<ul><li>ç¬¬ 150 è‡³ 154 è¡Œï¼šå°† Span æœªç”Ÿæˆç¼–å·çš„å±æ€§ï¼Œè¿›è¡Œå…‘æ¢å¤„ç†ã€‚<strong>è‹¥å…‘æ¢å¤±è´¥ï¼Œè¿”å›æ„é€ å¤±è´¥</strong>ã€‚åœ¨ <a href="#">ã€Œ2.3 Standardization æ ‡å‡†åŒ–ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 157 è‡³ 160 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L230" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyFirstListener(...)</code></a> ï¼Œä½¿ç”¨ FirstSpanListener å¤„ç†<strong>ç¬¬ä¸€ä¸ª</strong> Span ã€‚</li><li>ç¬¬ 164 è¡Œï¼šè‹¥æ˜¯ ExitSpan ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L230" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyExitListener(...)</code></a> ï¼Œä½¿ç”¨ ExitSpanListener å¤„ç†ã€‚</li><li>ç¬¬ 166 è¡Œï¼šè‹¥æ˜¯ EntrySpan ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L212" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyEntryListener(...)</code></a> ï¼Œä½¿ç”¨ EntrySpanListener å¤„ç†ã€‚</li><li>ç¬¬ 168 è¡Œï¼šè‹¥æ˜¯ LocalSpan ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L221" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyLocalListener(...)</code></a> ï¼Œä½¿ç”¨ LocalSpanListener å¤„ç†ã€‚</li></ul></li><li>ç¬¬ 174 è¡Œï¼šè¿”å› <code>true</code> ï¼Œ<strong>é¢„æ„å»ºæˆåŠŸ</strong>ã€‚</li></ul><h3>2.2.2 å†™å…¥ Buffer æ–‡ä»¶</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L191" rel="external nofollow noopener noreferrer" target="_blank"><code>#writeToBufferFile(id, upstreamSegment)</code></a> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Buffer æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 193 è¡Œï¼šåˆ›å»º 193 è‡³ 194 è¡Œï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardization.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.standardization.SegmentStandardization</code></a> å¯¹è±¡ï¼Œå¹¶è®¾ç½® TraceSegment å±æ€§ã€‚</li><li>ç¬¬ 195 è¡Œï¼šè·å¾— <code>TraceStreamGraph.SEGMENT_STANDARDIZATION_GRAPH_ID</code> å¯¹è±¡çš„ Graph å¯¹è±¡ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createSegmentStandardizationGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ Graph å¯¹è±¡åªæœ‰ä¸€ä¸ª SegmentStandardizationWorker ã€‚</li><li>ç¬¬ 196 è¡Œï¼šè°ƒç”¨ <code>Graph#start(INPUT)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>è¯¥ Graph å®ç°çš„</strong>æµå¼å¤„ç†ï¼Œå°† TraceSegment å†™åˆ° Buffer æ–‡ä»¶ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.standardization.SegmentStandardizationWorker</code></a> ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼ŒTraceSegment æ ‡å‡†åŒ– Worker ï¼Œè´Ÿè´£å°†æ¥æ”¶åˆ°çš„ TraceSegment <strong>å¼‚æ­¥</strong>å†™åˆ° Buffer æ–‡ä»¶ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L59" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AbstractLocalAsyncWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 108 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork(SegmentStandardization)</code></a> å®ç°æ–¹æ³•ï¼Œå°†æ¥æ”¶åˆ°çš„ TraceSegment <strong>å¼‚æ­¥</strong>å†™åˆ° Buffer æ–‡ä»¶ã€‚ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 52 è¡Œï¼šè°ƒç”¨ <code>SegmentBufferManager#writeBuffer(UpstreamSegment)</code> æ–¹æ³•ï¼Œå°†æ¥æ”¶åˆ°çš„ TraceSegment å†™åˆ° Buffer æ–‡ä»¶ã€‚åœ¨ <a href="#">ã€Œ3. Buffer æ–‡ä»¶ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L65" rel="external nofollow noopener noreferrer" target="_blank"><code>Factory#workerInstance(ModuleManager)</code></a> æ–¹æ³•ï¼Œåˆ›å»º SegmentStandardizationWorker åï¼Œä¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#startTimer(SegmentStandardizationWorker)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚è¯¥å®šæ—¶ä»»åŠ¡è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#flushAndSwitch()</code></a> æ–¹æ³•ï¼Œå®šæ—¶å°† Buffer æ–‡ä»¶ flush ã€‚ç›®å‰ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L139" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferManager#flush()</code></a> æ˜¯ä¸ªç©ºæ–¹æ³•ã€‚ä¸ºä»€ä¹ˆä¸è¿™é‡Œä¸éœ€è¦ flush å‘¢ï¼Ÿå› ä¸º <code>SegmentBufferManager#writeBuffer(UpstreamSegment)</code> <strong>å·²ç»è¿›è¡Œ flush</strong> ã€‚</li></ul><h2>2.3 Standardization æ ‡å‡†åŒ–</h2><p>æœ¬å°èŠ‚æ¶‰åŠåˆ°çš„ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/04.png" alt=""></p><p>æˆ‘ä»¬å…ˆæ¥è¯´è¯´ï¼Œä»€ä¹ˆå« standardization <strong>æ ‡å‡†åŒ–</strong>ï¼Ÿå…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨æ–‡ç« å¼€å¤´è¯´çš„&quot;<strong>ä¾‹å¦‚å°†</strong> <code>operationName</code> <strong>è½¬æ¢æˆ</strong> <code>operationId</code>&quot;ã€‚</p><h3>2.3.1 StandardBuilder</h3><p><code>org.skywalking.apm.collector.agent.stream.parser.standardization.StandardBuilder</code> ï¼Œæ ‡å‡†åŒ– Builder æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/StandardBuilder.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#toBuilder()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè½¬æ¢æˆ Builder ã€‚æ„Ÿè§‰è¿™ä¸ªæ¥å£æ–¹æ³•<strong>æ€ªæ€ªçš„</strong>ï¼Ÿä¸è¦æ‰æ€¥ï¼Œç­‰ä¼šçœ‹ä¸€ä¸ªå®ç°ç±»å°±æ˜ç™½äº†ã€‚</li></ul><p>StandardBuilder æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentDecorator.java" rel="external nofollow noopener noreferrer" target="_blank">SegmentDecorator</a> ï¼ŒTraceSegment è£…é¥°è€…ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/ReferenceDecorator.java" rel="external nofollow noopener noreferrer" target="_blank">ReferenceDecorator</a> ï¼ŒReferenceDecorator è£…é¥°è€…ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java" rel="external nofollow noopener noreferrer" target="_blank">SpanDecorator</a> ï¼ŒSpan è£…é¥°è€…ã€‚</li></ul><p>æ€ä¹ˆéƒ½æ˜¯<strong>è£…é¥°è€…</strong>å‘¢ï¼Œè€Œä¸”æ°å¥½å’Œä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åº”ï¼Ÿä»¥ SpanDecorator ä¸ºä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>spanObject</code> å±æ€§ï¼ŒSpanObject ï¼ŒSpan çš„ Protobuf æ•°æ®å¯¹è±¡ã€‚</li><li><code>standardBuilder</code> å±æ€§ï¼ŒSpanObject çš„ Builder å¯¹è±¡ã€‚</li><li><code>isOrigin</code> å±æ€§ï¼Œæ˜¯å¦æ˜¯åŸå§‹å¯¹è±¡ã€‚<ul><li><code>isOrigin = true</code> ï¼Œä½¿ç”¨ <code>spanObject</code>å±æ€§ ã€‚</li><li><code>isOrigin = false</code> ï¼Œä½¿ç”¨ <code>standardBuilder</code> å±æ€§ã€‚</li></ul></li><li>åœ¨ Protobuf é‡Œï¼Œæ•°æ®ä¿®æ”¹å€¼æ—¶ï¼Œéœ€è¦ä½¿ç”¨å¯¹åº”çš„ Builder å¯¹è±¡ã€‚é€šè¿‡ä½¿ç”¨<strong>è£…é¥°è€…</strong>è®¾è®¡æ¨¡å¼ï¼Œå¯¹ä½¿ç”¨è€…å±è”½ç»†èŠ‚ï¼Œè°ƒç”¨ä¹Ÿæ›´åŠ æ–¹ä¾¿ã€‚ä¸‹é¢åœ¨æ¥çœ‹çœ‹å¦‚ä¸‹æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯å°±æ›´åŠ æ˜ç™½äº†ï¼š<ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java#L165" rel="external nofollow noopener noreferrer" target="_blank"><code>#setOperationNameId(value)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java#L172" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOperationName()</code></a></li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java#L195" rel="external nofollow noopener noreferrer" target="_blank"><code>#toBuilder()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º SpanObject å¯¹åº”çš„ Builder ï¼Œå¹¶ä¿®æ”¹ <code>isOrigin = false</code> ã€‚å¦å¤–ï¼Œä¼šè°ƒç”¨ <code>standardBuilder</code> å±æ€§çš„ <code>#toBuilder()</code> æ–¹æ³•ï¼Œç›®å‰åœ¨é¡¹ç›®é‡Œï¼Œæ­¤å¤„çš„ <code>standardBuilder</code> å±æ€§ä¸º SegmentDecorator ã€‚</li></ul><p>SegmentDecorator ã€ReferenceDecorator å’Œ SpanDecorator ç›®çš„ä¸€è‡´ã€‚</p><h3>2.3.2 IdExchanger</h3><p><code>org.skywalking.apm.collector.agent.stream.parser.standardization.IdExchanger</code> ï¼Œç¼–å·å…‘æ¢å™¨<strong>æ¥å£</strong>ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/IdExchanger.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>#exchange(standardBuilder, applicationId)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå…‘æ¢ standardBuilder é‡Œçš„å±æ€§ï¼Œå¹¶è¿”å›æ˜¯å¦å…‘æ¢æˆåŠŸã€‚</li></ul><p>IdExchanger æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/ReferenceIdExchanger.java" rel="external nofollow noopener noreferrer" target="_blank">ReferenceIdExchanger</a> ï¼šTraceSegmentRef ç¼–å·å…‘æ¢å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanIdExchanger.java" rel="external nofollow noopener noreferrer" target="_blank">SpanIdExchanger</a> ï¼šSpan ç¼–å·å…‘æ¢å™¨ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/ReferenceIdExchanger.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>ReferenceIdExchanger#exchange(standardBuilder, applicationId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 60 è‡³ 73 è¡Œï¼š<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.entryOperationId</code></a> ä¸ºç©ºï¼Œå°† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.entryOperationName</code></a> è¿›è¡Œå…‘æ¢ã€‚<ul><li>ç¬¬ 61 è¡Œï¼šè°ƒç”¨ <code>ServiceNameService#getOrCreate(applicationId, serviceName)</code> æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨ç¼–å·å’Œæ“ä½œåè·å¾—æˆ–åˆ›å»ºæ“ä½œç¼–å·ã€‚</li><li>ç¬¬ 62 è‡³ 67 è¡Œï¼šè·å¾—<strong>ä¸åˆ°</strong>ï¼Œå› ä¸ºåˆ›å»ºçš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã€‚è¿”å› <code>false</code> ã€‚</li><li>ç¬¬ 68 è‡³ 72 è¡Œï¼šè·å¾—<strong>åˆ°</strong>ï¼Œè°ƒç”¨ <code>ReferenceDecorator#toBuilder()</code> æ–¹æ³•ï¼Œåˆ›å»º Builder ï¼Œç„¶åè®¾ç½®æ“ä½œç¼–å·ã€‚</li></ul></li><li>ç¬¬ 75 è‡³ 89 è¡Œï¼š<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.parentApplicationInstanceId</code></a> ä¸ºç©ºï¼Œå°† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L90" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.parentOperationName</code></a> è¿›è¡Œå…‘æ¢ã€‚</li><li>ç¬¬ 92 è‡³ 104 è¡Œï¼š<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.entryOperationName</code></a> ä¸ºç©ºï¼Œå°† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.peerHost</code></a> è¿›è¡Œå…‘æ¢ã€‚åœ¨ã€ç¬¬ 93 è¡Œã€‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>ApplicationIDService#getOrCreate(applicationCode)</code> æ–¹æ³•ï¼Œå°†<strong>æœåŠ¡åœ°å€</strong>ä½œä¸º <code>applicationCode</code> ä½¿ç”¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanIdExchanger.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>SpanIdExchanger#exchange(standardBuilder, applicationId)</code></a> æ–¹æ³•ï¼Œç±»ä¼¼ï¼Œå·²ç»æ·»åŠ ä»£ç æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚</p><h1>3. Buffer æ–‡ä»¶</h1><p>æœ¬å°èŠ‚æ¶‰åŠåˆ°çš„ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/05.png" alt=""></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Buffer åŒ…æ‹¬å“ªäº›æ–‡ä»¶ï¼š</p><p></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">yunai$ pwd</div><div class="line">/Users/yunai/Java/buffer</div><div class="line">yunai$ ls</div><div class="line">data_20171205004132.sw		offset_20171205004132.sw</div></pre></td></tr></table></figure><p></p><ul><li>Data æ–‡ä»¶ï¼Œè®°å½• TraceSegment å…·ä½“æ•°æ®ï¼Œé€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java" rel="external nofollow noopener noreferrer" target="_blank">SegmentBufferManager</a> ç®¡ç†ã€‚</li><li>Offset æ–‡ä»¶ï¼Œè®°å½•åç§»ï¼ŒåŒ…æ‹¬å†™å…¥æ–‡ä»¶çš„åå­—å’Œåç§»ï¼Œè¯»å–æ–‡ä»¶çš„åå­—å’Œåç§»ï¼Œé€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java" rel="external nofollow noopener noreferrer" target="_blank">OffsetManager</a> ç®¡ç†ã€‚</li><li>ä»å‘½åä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™<strong>ä¸¤ç§</strong>æ–‡ä»¶ï¼Œæ–‡ä»¶åå­—æ ¼å¼ä¸º <code>ç±»å‹_${æ—¶é—´}.sw</code> ï¼Œå¹¶ä¸”<strong>ç›¸åŒç±»å‹ï¼ŒåŒæ—¶å¯ä»¥å­˜åœ¨å¤šä¸ª</strong>ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/BufferFileConfig.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.buffer.BufferFileConfig</code></a> ï¼ŒBuffer æ–‡ä»¶é…ç½® ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/Offset.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.buffer.Offset</code></a> ï¼Œåç§» ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ Buffer æ–‡ä»¶çš„åˆå§‹åŒ–ã€å†™å…¥ã€è¯»å–çš„ä¸‰ç§æ“ä½œè¿‡ç¨‹ã€‚</p><h2>3.1 åˆå§‹åŒ–</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferManager#initialize(ModuleManager)</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– Offset æ–‡ä»¶ã€Data æ–‡ä»¶ã€å®šæœŸè¯»å– Buffer æ–‡ä»¶çš„ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 58 è¡Œï¼šè°ƒç”¨ <code>OffsetManager#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Offset æ–‡ä»¶ã€‚</li><li>ç¬¬ 60 è‡³ 63 è¡Œï¼šåˆ›å»º Buffer æ–‡ä»¶å¤¹æˆåŠŸ( æ„å‘³ç€è¯¥æ–‡ä»¶å¤¹ä¸å­˜åœ¨ )ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L113" rel="external nofollow noopener noreferrer" target="_blank"><code>#newDataFile()</code></a> ï¼Œåˆ›å»º Data æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 116 è‡³ 119 è¡Œï¼šåˆ›å»º<strong>æ–°</strong>çš„ Data æ–‡ä»¶ã€‚æ–‡ä»¶åæ ¼å¼ä¸ºï¼Œ<code>data_${yyyyMMddHHmmss}.sw</code> ã€‚</li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <code>OffsetManager#setWriteOffset(writeFileName, writeFileOffset)</code> æ–¹æ³•ï¼Œè®¾ç½® Offset çš„<strong>å†™å…¥</strong>çš„æ–‡ä»¶åå’Œåç§»ã€‚</li><li>ç¬¬ 124 è‡³ 126 è¡Œï¼šå…³é—­<strong>è€</strong>çš„ Data æ–‡ä»¶çš„ <code>outputStream</code> ã€‚</li><li>ç¬¬ 129 è‡³ 130 è¡Œï¼šåˆ›å»º<strong>æ–°</strong>çš„ Data æ–‡ä»¶çš„ <code>outputStream</code> ã€‚</li></ul></li><li>ç¬¬ 66 è‡³ 77 è¡Œï¼šè·å¾— Offset çš„<strong>å†™å…¥</strong>çš„ Data æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ <code>outputStream</code> ã€‚</li><li>ç¬¬ 80 è¡Œï¼šè°ƒç”¨ <code>SegmentBufferReader#initialize(ModuleManager)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å®šæœŸè¯»å– Buffer æ–‡ä»¶çš„ä»»åŠ¡ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>OffsetManager#initialize()</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– Offset æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 74 è¡Œï¼šåˆ›å»º Offer å¯¹è±¡ã€‚è¯¥å¯¹è±¡åŒ…å«äº†<strong>å½“å‰</strong>åˆ†åˆ«å†™å…¥å’Œè¯»å–çš„æ–‡ä»¶åä¸åç§»é‡ã€‚</li><li>ç¬¬ 60 è‡³ 63 è¡Œï¼šåˆ›å»º Buffer æ–‡ä»¶å¤¹æˆåŠŸ( æ„å‘³ç€è¯¥æ–‡ä»¶å¤¹ä¸å­˜åœ¨ )ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L112" rel="external nofollow noopener noreferrer" target="_blank"><code>#createOffsetFile()</code></a> ï¼Œåˆ›å»º Data æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 114 è‡³ 116 è¡Œï¼šåˆ›å»º<strong>æ–°</strong>çš„ Offset æ–‡ä»¶ã€‚æ–‡ä»¶åæ ¼å¼ä¸ºï¼Œ<code>offset_${yyyyMMddHHmmss}.sw</code> ã€‚</li><li>ç¬¬ 118 è‡³ 121 è¡Œï¼šè®¾ç½® Offset å¯¹è±¡çš„å†™å…¥å’Œè¯»å–çš„æ–‡ä»¶åä¸åç§»é‡éƒ½ä¸º<strong>ç©º</strong>ã€‚åœ¨ä¸Šé¢çš„æ–¹æ³•ï¼Œæ­¤å¤„çš„ã€ç©ºã€‘ï¼Œåœ¨ Data æ–‡ä»¶åˆ›å»ºæ—¶ï¼Œä¼šé‡æ–°è®¾ç½® Offset ã€‚</li><li>ç¬¬ 123 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L129" rel="external nofollow noopener noreferrer" target="_blank"><code>#flush()</code></a> æ–¹æ³•ï¼Œå†™å…¥ Offset å¯¹è±¡åˆ° Offset æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 131 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/Offset.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>Offset#serialize()</code></a> æ–¹æ³•ï¼Œåºåˆ—åŒ–è¯»å†™åç§»ï¼Œæ ¼å¼ä¸º <code>${è¯»å–æ–‡ä»¶å},${è¯»å–æ–‡ä»¶åç§»é‡},${å†™å…¥æ–‡ä»¶å},${å†™å…¥æ–‡ä»¶åç§»é‡}</code> ã€‚</li><li>ç¬¬ 133 è‡³ 142 è¡Œï¼šå†™å…¥ Offset å¯¹è±¡åˆ° Offset æ–‡ä»¶ã€‚å†™å…¥æ–¹å¼ä¸º<strong>æ•´è¡Œ</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/06.png" alt=""></li></ul></li></ul></li><li>ç¬¬ 82 è‡³ 94 è¡Œï¼šè·å¾—æ‰€æœ‰ Offset æ–‡ä»¶ï¼Œåˆ é™¤è€çš„ Offset æ–‡ä»¶ï¼Œä¿ç•™æœ€åä¸€ä¸ªã€‚è‹¥ä¸å­˜åœ¨ Offset æ–‡ä»¶ï¼Œåˆ™è°ƒç”¨ <code>#createOffsetFile()</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ–°</strong>çš„ Offset æ–‡ä»¶ã€‚</li><li>ç¬¬ 98 è‡³ 99 è¡Œï¼šä» Offset æ–‡ä»¶çš„<strong>æœ€åä¸€è¡Œ</strong>è¯»å–ï¼Œååºåˆ—åŒ–åˆ° Offset å¯¹è±¡ã€‚</li><li>ç¬¬ 103 è¡Œï¼šåˆ›å»ºå®šä¹‰ä»»åŠ¡ï¼Œå»¶è¿Ÿ 10 ç§’ï¼Œé—´éš” 3 ç§’ï¼Œè°ƒç”¨ <code>#flush()</code> æ–¹æ³•ï¼Œ<strong>å®šæ—¶</strong>å†™å…¥ Offset å¯¹è±¡åˆ° Offset æ–‡ä»¶ã€‚<strong>æ³¨æ„ï¼Œæ‰€ä»¥ Offset æ”¹å˜æ—¶ï¼Œä¸æ˜¯ç«‹å³å†™å…¥ Offset æ–‡ä»¶ï¼Œè€Œæ˜¯å‘¨æœŸæ€§åˆ·ç›˜</strong>ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferReader#initialize(ModuleManager)</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ–å®šæœŸè¯»å– Buffer æ–‡ä»¶çš„ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 56 è¡Œï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå»¶è¿Ÿ 3 ç§’ï¼Œé—´éš” 3 ç§’ï¼Œè°ƒç”¨ <code>#preRead()</code> æ–¹æ³•ï¼Œè¯»å– Buffer æ–‡ä»¶ï¼Œå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚</li></ul><h2>3.2 å†™å…¥</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L91" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferManager#writeBuffer(UpstreamSegment)</code></a> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Buffer æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š1ï¼‰å°† TraceSegment å†™å…¥ Data æ–‡ä»¶ï¼›2ï¼‰æ›´æ–° Offset æ–‡ä»¶çš„åç§»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 94 è‡³ 95 è¡Œï¼šè°ƒç”¨ <code>AbstractMessageLite#writeDelimitedTo(OutputStream)</code> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Data æ–‡ä»¶ã€‚è¯¥æ–¹æ³•åŒ…æ‹¬ <strong>flush</strong> æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/07.png" alt=""></li><li>ç¬¬ 97 è‡³ 98 è¡Œï¼šè¶…è¿‡ Buffer <strong>å•æ–‡ä»¶å®¹é‡ä¸Šé™</strong>ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L113" rel="external nofollow noopener noreferrer" target="_blank"><code>#newDataFile()</code></a> ï¼Œåˆ›å»º Data æ–‡ä»¶ã€‚</li><li>ç¬¬ 99 è‡³ 102 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L186" rel="external nofollow noopener noreferrer" target="_blank"><code>OffsetManager#setWriteOffset(position)</code></a> æ–¹æ³•ï¼Œè®¾ç½® Offset å¯¹è±¡çš„å†™å…¥åç§»ã€‚</li></ul><h2>3.3 è¯»å–</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferReader#preRead()</code></a> æ–¹æ³•ï¼Œè¯»å– Buffer æ–‡ä»¶ï¼Œå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚<strong>å¦å¤–è¯¥æ–¹æ³•ï¼Œä¼šåˆ é™¤å·²ç»è¯»å–å®Œæˆçš„ Data æ–‡ä»¶</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>-------- è¯»å–æ–‡ä»¶å­˜åœ¨</li><li>è¯¥æƒ…å†µå‘ç”Ÿäºï¼ŒData æ–‡ä»¶æœªè¢«è¯»å–å®Œæˆ</li><li>ç¬¬ 65 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L88" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteTheDataFilesBeforeReadFile(readFileName)</code></a> æ–¹æ³•ï¼Œåˆ é™¤æ¯”æŒ‡å®šæ–‡ä»¶æ—©åˆ›å»ºçš„ Data æ–‡ä»¶ï¼Œ<strong>åŸºäºæ–‡ä»¶åå¸¦æœ‰åˆ›å»ºæ—¶é—´</strong>ã€‚</li><li>ç¬¬ 67 è‡³ 68 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L130" rel="external nofollow noopener noreferrer" target="_blank"><code>#read()</code></a> æ–¹æ³•ï¼Œè¯»å– Buffer æ–‡ä»¶ï¼Œå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚å¦å¤–ï¼Œè¿”å› <code>true</code> ï¼Œæ–‡ä»¶è¢«å…¨éƒ¨è¯»å–å®Œæˆã€å¤„ç†å¹¶åˆ é™¤ã€‚è¿”å› <code>false</code> ï¼Œæ–‡ä»¶æœªè¢«å…¨éƒ¨è¯»å–å®Œæˆã€‚<ul><li>ç¬¬ 133 è‡³ 134 è¡Œï¼šåˆ›å»º FileInputStream å¯¹è±¡ï¼Œå¹¶è·³è½¬åˆ°è¯»å–ä½ç½®ã€‚</li><li>ç¬¬ 137 è‡³ 141 è¡Œï¼šè·å–<strong>è¯»å–ç»“æŸ</strong>çš„ä½ç½®ã€‚</li><li>ç¬¬ 143 è‡³ 159 è¡Œï¼š<strong>å¾ªç¯è¯»å–å¤„ç†</strong>ï¼Œç›´åˆ°åˆ°è¾¾è¯»å–æ–‡ä»¶ä¸Šé™ä½ç½®<ul><li>ç¬¬ 144 è‡³ 146 è¡Œï¼šä» Data æ–‡ä»¶ï¼Œè¯»å–ä¸€æ¡ TraceSegment ã€‚</li><li>ç¬¬ 149 è‡³ 152 è¡Œï¼šå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚è‹¥è§£æå¤„ç†å¤±è´¥ï¼Œè¿”å› <code>false</code> ï¼Œç»“æŸå¾ªç¯ï¼Œç­‰å¾…ä¸‹æ¬¡è¯»å–å¤„ç†ã€‚</li><li>ç¬¬ 155 è‡³ 158 è¡Œï¼šè®¾ç½® Offset å¯¹è±¡çš„è¯»å–åç§»ã€‚</li></ul></li><li>ç¬¬ 161 è‡³ 165 è¡Œï¼š<strong>å…¨éƒ¨è¯»å–å¤„ç†å®Œæˆï¼Œå…³é—­ InputStream ï¼ŒåŒæ—¶åˆ é™¤è¯»å–çš„ Data æ–‡ä»¶</strong>ã€‚</li><li>ç¬¬ 166 è‡³ 169 è¡Œï¼šå‘ç”Ÿ IOException å¼‚å¸¸ï¼Œè¿”å› <code>false</code> ã€‚</li><li>ç¬¬ 170 è¡Œï¼šè¿”å› <code>true</code> ï¼Œæ–‡ä»¶è¢«å…¨éƒ¨è¯»å–å®Œæˆã€å¤„ç†å¹¶åˆ é™¤ã€‚</li></ul></li><li>ç¬¬ 75 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L110" rel="external nofollow noopener noreferrer" target="_blank"><code>#readEarliestCreateDataFile()</code></a> æ–¹æ³•ï¼Œå¾ªç¯é¡ºåºè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚<ul><li>ç¬¬ 112 è‡³ 118 è¡Œï¼šè‹¥ç¬¬ä¸€ä¸ª Data æ–‡ä»¶å’Œ Offset è¯»å–çš„æ–‡ä»¶ç›¸åŒï¼Œè¿”å›ã€‚è¯´æ˜ï¼Œåœ¨ä¸Šä¸€æ¬¡ <code>#read()</code> æ–¹æ³•é‡Œï¼Œæ²¡æœ‰è¯»å®Œã€‚</li><li>ç¬¬ 121 è‡³ 127 è¡Œï¼šå¾ªç¯é¡ºåºè°ƒç”¨ <code>#read(readFile, readFileOffset)</code> æ–¹æ³•ï¼Œè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚</li></ul></li><li>-------- è¯»å–æ–‡ä»¶ä¸å­˜åœ¨ --------</li><li>è¯¥æƒ…å†µå‘ç”Ÿäºï¼ŒData æ–‡ä»¶è¢«å…¨éƒ¨è¯»å–å®Œæˆï¼Œå¹¶ä¸”åˆ é™¤ã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <code>#deleteTheDataFilesBeforeReadFile(readFileName)</code> æ–¹æ³•ï¼Œåˆ é™¤æ¯”æŒ‡å®šæ–‡ä»¶æ—©åˆ›å»ºçš„ Data æ–‡ä»¶ã€‚</li><li>ç¬¬ 75 è¡Œï¼šè°ƒç”¨ <code>#readEarliestCreateDataFile()</code> æ–¹æ³•ï¼Œå¾ªç¯é¡ºåºè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚</li><li>-------- æ²¡æœ‰å¯è¯»å–çš„æ–‡ä»¶ --------</li><li>è¯¥æƒ…å†µå‘ç”Ÿäºï¼ŒData æ–‡ä»¶ã€Buffer æ–‡ä»¶<strong>é¦–æ¬¡</strong>åˆå§‹åŒ–åˆ›å»ºï¼Œæœªè®¾ç½®å¯è¯»æ–‡ä»¶åã€‚</li><li>ç¬¬ 79 è¡Œï¼šè°ƒç”¨ <code>#readEarliestCreateDataFile()</code> æ–¹æ³•ï¼Œå¾ªç¯é¡ºåºè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚</li></ul><h1>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œå³å°†å¼€å§‹ Trace æµå¼å¤„ç†çš„æ–‡ç« ï¼Œå¾ˆå—¨çš®ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/08.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/SkyWalking/">SkyWalking</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/SkyWalking/collector-receive-trace/" data-title="SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ® | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/SkyWalking/collector-store-trace/" title="SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®"><strong>PREVIOUS:</strong><br><span>SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®</span></a></div><div class="next"><a href="/SkyWalking/agent-send-trace/" title="SkyWalking æºç åˆ†æ â€”â€” Agent å‘é€ Trace æ•°æ®"><strong>NEXT:</strong><br><span>SkyWalking æºç åˆ†æ â€”â€” Agent å‘é€ Trace æ•°æ®</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. TraceSegmentServiceHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 TraceSegmentService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 SegmentParse</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 é¢„æ„å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 å†™å…¥ Buffer æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Standardization æ ‡å‡†åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 StandardBuilder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 IdExchanger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. Buffer æ–‡ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 å†™å…¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 è¯»å–</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Myth/" title="Myth">Myth<sup>1</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li><li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li><li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>5</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>5</sup></a></li><li><a href="/categories/æ•°æ®åº“å®ä½“è®¾è®¡/" title="æ•°æ®åº“å®ä½“è®¾è®¡">æ•°æ®åº“å®ä½“è®¾è®¡<sup>1</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å…«/" title="èŠ‹é“æºç çš„å‘¨å…«">èŠ‹é“æºç çš„å‘¨å…«<sup>5</sup></a></li></ul></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>