
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">

    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">

  
    <title>Sharding-JDBC 源码分析 —— SQL 解析（二）之SQL解析 | 芋道源码 —— 纯源码解析博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="芋道源码">
    
    <meta name="description" content="摘要: 原创出处 http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/ 「芋道源码」欢迎转载，保留摘要，谢谢！
本文主要基于 Sharding-JDBC 1.5.0 正式版  

1. 概述
2. SQLParsingEngine
3. SQLParser">
    

    
    <meta name="keywords" content="Sharding-JDBC,ShardingJDBC,Sharding-JDBC 源码,SQL解析, SQL 解析,Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客,Sharding-JDBC,分库分表">
    

    
    
    <link rel="alternate" href="atom.xml" title="芋道源码 —— 纯源码解析博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            var _bdId ='9e70e3362807c1bd185a79655b307027';
             hm.src = "//hm.baidu.com/hm.js?" + _bdId;
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

    <!-- 不蒜子统计 -->
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>
</html>
  <body>
    <header>
      <div>
    
    <div id="textlogo">
        <h1 class="site-name"><a href="/" title="芋道源码 —— 纯源码解析博客">芋道源码 —— 纯源码解析博客</a></h1>
        <a class="blog-motto">
            
            愿半生编码，如一生老友！
            
        </a>
    </div>
    <div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
        </a></div>
    <nav class="animated">
        <ul>
            <ul>
                
                <li><a href="/">文章</a></li>
                
                <li><a href="/2018-meet-you">知识星球</a></li>
                
                <li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li>
                
                <li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">微信公众号</a></li>
                
                <li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">工作内推</a></li>
                
                <li><a href="/link_url">友链</a></li>
                
                <!--<li>-->
                    <!---->
                        <!--<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">-->
                            <!--<label>Search</label>-->
                            <!--<input type="text" id="search" name="q" autocomplete="off" maxlength="20"-->
                                   <!--placeholder="搜索"/>-->
                            <!--<input type="hidden" name="q" value="site:www.iocoder.cn">-->
                        <!--</form>-->
                        <!---->
                <!--</li>-->
            </ul>
    </ul></nav>
</div>

    </header>
    <div id="container">

        <div id="main" class="post" itemscope="" itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/Sharding-JDBC/sql-parse-2/" title="Sharding-JDBC 源码分析 —— SQL 解析（二）之SQL解析" itemprop="url">Sharding-JDBC 源码分析 —— SQL 解析（二）之SQL解析</a>
  </h1>
  <p class="article-author">
      <!--By-->
    <!---->
      <!--<a href="http://www.iocoder.cn" title="芋道源码">芋道源码</a>-->
    <!---->
  </p>
  <p class="article-time">
    <!--<time datetime="2017-07-25T16:00:00.000Z" itemprop="datePublished">2017-07-26</time>-->
    <!--更新日期:<time datetime="2017-10-12T06:23:46.000Z" itemprop="dateModified">2017-10-12</time>-->
    <!---->
      总阅读量:<span id="busuanzi_value_page_pv"></span>次
  </p>
</header>
	<div class="article-content">
		
		
		<p>摘要: 原创出处 <a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/</a> 「芋道源码」欢迎转载，保留摘要，谢谢！</p>
<p><strong>本文主要基于 Sharding-JDBC 1.5.0 正式版</strong>  </p>
<ul>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">1. 概述</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">2. SQLParsingEngine</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3. SQLParser SQL解析器</a><ul>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.1 AbstractParser</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.2 SQLParser</a><ul>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.2.1 #parseExpression() 和 SQLExpression</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.2.2 #parseAlias()</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.2.3 #parseSingleTable()</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.2.4 #skipJoin()</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">3.2.5 #parseWhere()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">4. StatementParser SQL语句解析器</a><ul>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">4.1 StatementParser</a></li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">4.2 Statement</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/">5. 彩蛋</a></li>
</ul>
<hr>
<p><img src="https://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>🙂🙂🙂关注<strong>微信公众号：<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">【芋道源码】</a></strong>有福利：  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>所有</strong>源码分析文章列表  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>中文注释源码 GitHub 地址</strong>  </li>
<li>您对于源码的疑问每条留言<strong>都</strong>将得到<strong>认真</strong>回复。<strong>甚至不知道如何读源码也可以请教噢</strong>。  </li>
<li><strong>新的</strong>源码解析文章<strong>实时</strong>收到通知。<strong>每周更新一篇左右</strong>。  </li>
<li><strong>认真的</strong>源码交流微信群。</li>
</ol>
</blockquote>
<hr>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>上篇文章<a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-1/">《词法解析》</a>分享了<strong>词法解析器Lexer</strong>是如何解析 SQL 里的词法。本文分享<strong>SQL解析引擎</strong>是如何解析与理解 SQL的。因为本文建立在<a href="http://www.iocoder.cn/Sharding-JDBC/sql-parse-1/">《词法解析》</a>之上，你需要阅读它后在开始这段旅程。🙂如果对词法解析不完全理解，请给我的公众号<strong>（<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">芋道源码</a>）</strong>留言，我会<strong>逐条认真耐心</strong>回复。</p>
<p>区别于 Lexer，Parser <strong>理解SQL</strong>：</p>
<ul>
<li><strong>提炼分片上下文</strong></li>
<li><strong>标记需要SQL改写的部分</strong></li>
</ul>
<p>Parser 有三个组件：</p>
<ul>
<li>SQLParsingEngine ：SQL 解析引擎</li>
<li>SQLParser ：SQL 解析器</li>
<li>StatementParser ：SQL语句解析器</li>
</ul>
<p>SQLParsingEngine 调用 StatementParser 解析 SQL。<br>StatementParser 调用 SQLParser 解析 SQL 表达式。<br>SQLParser 调用 Lexer 解析 SQL 词法。</p>
<p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/01.png" alt=""></p>
<p>😜 是不是觉得 SQLParser 和 StatementParser 看起来很接近？下文为你揭开这个答案。</p>
<blockquote>
<p><strong>Sharding-JDBC 正在收集使用公司名单：<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">传送门</a>。<br>🙂 你的登记，会让更多人参与和使用 Sharding-JDBC。<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">传送门</a><br>Sharding-JDBC 也会因此，能够覆盖更多的业务场景。<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">传送门</a><br>登记吧，骚年！<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">传送门</a></strong></p>
</blockquote>
<h1 id="2-SQLParsingEngine"><a href="#2-SQLParsingEngine" class="headerlink" title="2. SQLParsingEngine"></a>2. SQLParsingEngine</h1><p>SQLParsingEngine，SQL 解析引擎。其 <code>#parse()</code> 方法作为 SQL 解析入口，本身不带复杂逻辑，通过调用 SQL 对应的 StatementParser 进行 SQL 解析。</p>
<p>核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// 获取 SQL解析器</span></div><div class="line">   SQLParser sqlParser = getSQLParser();</div><div class="line">   <span class="comment">//</span></div><div class="line">   sqlParser.skipIfEqual(Symbol.SEMI); <span class="comment">// 跳过 ";"</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.WITH)) &#123; <span class="comment">// WITH Syntax</span></div><div class="line">       skipWith(sqlParser);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 获取对应 SQL语句解析器 解析SQL</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.INSERT)) &#123;</div><div class="line">       <span class="keyword">return</span> InsertParserFactory.newInstance(shardingRule, sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UPDATE)) &#123;</div><div class="line">       <span class="keyword">return</span> UpdateParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DELETE)) &#123;</div><div class="line">       <span class="keyword">return</span> DeleteParserFactory.newInstance(sqlParser).parse();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-SQLParser-SQL解析器"><a href="#3-SQLParser-SQL解析器" class="headerlink" title="3. SQLParser SQL解析器"></a>3. SQLParser SQL解析器</h1><p>SQLParser，SQL 解析器。和词法解析器 Lexer 一样，不同数据库有不同的实现。</p>
<p>类图如下（<strong>包含所有属性和方法</strong>）（<strong><a href="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/02.png">放大图片</a></strong>）：</p>
<p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/02.png" alt=""></p>
<h2 id="3-1-AbstractParser"><a href="#3-1-AbstractParser" class="headerlink" title="3.1 AbstractParser"></a>3.1 AbstractParser</h2><p>AbstractParser，SQLParser 的抽象父类，对 Lexer 简单封装。例如：</p>
<ul>
<li><code>#skipIfEqual()</code>：判断当前词法标记类型是否与其中一个传入值相等</li>
<li><code>#equalAny()</code>：判断当前词法标记类型是否与其中一个传入值相等</li>
</ul>
<p><em><strong>这里有一点我们需要注意，SQLParser 并不是等 Lexer 解析完词法( Token )，再根据词法去理解 SQL。而是，在理解 SQL 的过程中，调用 Lexer 进行分词。</strong></em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParsingEngine.java#parse()片段</span></div><div class="line"><span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">    <span class="keyword">return</span> SelectParserFactory.newInstance(sqlParser).parse();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equalAny</span><span class="params">(<span class="keyword">final</span> TokenType... tokenTypes)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TokenType each : tokenTypes) &#123;</div><div class="line">       <span class="keyword">if</span> (each == lexer.getCurrentToken().getType()) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>↑↑↑ 判断当前<strong>词法</strong>是否为 SELECT。实际 AbstractParser 只知道当前词法，并<strong>不知道</strong>后面还有哪些词法，也<strong>不知道</strong>之前有哪些词法。</li>
</ul>
<p>我们来看 AbstractParser 里比较复杂的方法 <code>#skipParentheses()</code> 帮助大家再理解下。请认真看代码注释噢。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 跳过小括号内所有的词法标记.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 小括号内所有的词法标记</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">skipParentheses</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder(<span class="string">""</span>);</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition();</div><div class="line">       result.append(Symbol.LEFT_PAREN.getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">               increaseParametersIndex();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// 到达结尾 或者 匹配合适数的)右括号</span></div><div class="line">           <span class="keyword">if</span> (Assist.END == getLexer().getCurrentToken().getType() || (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType() &amp;&amp; <span class="number">0</span> == count)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// 处理里面有多个括号的情况，例如：SELECT COUNT(DISTINCT(order_id) FROM t_order</span></div><div class="line">           <span class="keyword">if</span> (Symbol.LEFT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count++;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Symbol.RIGHT_PAREN == getLexer().getCurrentToken().getType()) &#123;</div><div class="line">               count--;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// 下一个词法</span></div><div class="line">           getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 获得括号内的内容</span></div><div class="line">       result.append(getLexer().getInput().substring(beginPosition, getLexer().getCurrentToken().getEndPosition()));</div><div class="line">       <span class="comment">// 下一个词法</span></div><div class="line">       getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个类其它方法很重要，逻辑相对简单，我们就不占用篇幅了。大家一定要看哟，后面调用非常非常多。<a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/AbstractParser.java" rel="external nofollow noopener noreferrer" target="_blank">AbstractParser.java 传送门</a>。👼也可以关注我的公众号<strong>（<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">芋道源码</a>）</strong>发送关键字【sjdbc】获取<strong>增加方法内注释的项目地址</strong>。</p>
<h2 id="3-2-SQLParser"><a href="#3-2-SQLParser" class="headerlink" title="3.2 SQLParser"></a>3.2 SQLParser</h2><p>SQLParser，SQL 解析器，<strong>主要提供只考虑 SQL 块的解析方法，<em>不考虑 SQL 上下文</em></strong>。下文即将提到的 StatementParser 将 SQL 拆成对应的<strong>块</strong>，调用 SQLParser 进行解析。🤓 这么说，可能会有些抽象，我们下面来一起看。</p>
<p>SQLParser 看起来方法特别多，合并下一共 5 种：</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">#parseExpression()</td>
<td style="text-align:left">解析表达式</td>
</tr>
<tr>
<td style="text-align:left">#parseAlias()</td>
<td style="text-align:left">解析别名</td>
</tr>
<tr>
<td style="text-align:left">#parseSingleTable()</td>
<td style="text-align:left">解析单表</td>
</tr>
<tr>
<td style="text-align:left">#skipJoin()</td>
<td style="text-align:left">跳过表关联词法</td>
</tr>
<tr>
<td style="text-align:left">#parseWhere()</td>
<td style="text-align:left">解析查询条件</td>
</tr>
</tbody>
</table>
<p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/03.png" alt=""></p>
<p>看了这 5 个方法是否有点理解了？SQLParser 不考虑 SQL 是 SELECT / INSERT / UPDATE / DELETE ，它考虑的是，<strong>给我的是 WHERE 处解析查询条件，或是 INSERT INTO 解析单表 等</strong>，提供 SELECT / INSERT / UPDATE / DELETE 需要的 SQL 块公用解析。</p>
<h3 id="3-2-1-parseExpression-和-SQLExpression"><a href="#3-2-1-parseExpression-和-SQLExpression" class="headerlink" title="3.2.1 #parseExpression() 和 SQLExpression"></a>3.2.1 #parseExpression() 和 SQLExpression</h3><p>SQLExpression，SQL表达式接口。目前 6 种实现：</p>
<table>
<thead>
<tr>
<th style="text-align:left">类</th>
<th style="text-align:left">说明</th>
<th style="text-align:left">对应Token</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SQLIdentifierExpression</td>
<td style="text-align:left">标识表达式</td>
<td style="text-align:left">Literals.IDENTIFIER</td>
</tr>
<tr>
<td style="text-align:left">SQLPropertyExpression</td>
<td style="text-align:left">属性表达式</td>
<td style="text-align:left">无</td>
</tr>
<tr>
<td style="text-align:left">SQLNumberExpression</td>
<td style="text-align:left">数字表达式</td>
<td style="text-align:left">Literals.INT, Literals.HEX</td>
</tr>
<tr>
<td style="text-align:left">SQLPlaceholderExpression</td>
<td style="text-align:left">占位符表达式</td>
<td style="text-align:left">Symbol.QUESTION</td>
</tr>
<tr>
<td style="text-align:left">SQLTextExpression</td>
<td style="text-align:left">字符表达式</td>
<td style="text-align:left">Literals.CHARS</td>
</tr>
<tr>
<td style="text-align:left">SQLIgnoreExpression</td>
<td style="text-align:left">分片中无需关注的SQL表达式</td>
<td style="text-align:left">无</td>
</tr>
</tbody>
</table>
<p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/04.png" alt=""></p>
<ul>
<li>SQLPropertyExpression 例如：<code>SELECT * FROM t_order o ORDER BY o.order_id</code> 中的 <code>o.order_id</code>。<strong>SQLPropertyExpression 从 SQLIdentifierExpression 进一步判断解析而来。</strong><br> <img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/05.png" alt=""> </li>
<li>SQLIgnoreExpression 例如：<code>SELECT * FROM t_order o ORDER BY o.order_id % 2</code> 中的<code>o.order_id % 2</code>。<strong>复合表达式都会解析成 SQLIgnoreExpression。</strong></li>
</ul>
<p>解析 SQLExpression 核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 解析表达式.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 表达式</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="comment">// TODO 完善Expression解析的各种场景</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SQLExpression <span class="title">parseExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// 解析表达式</span></div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="keyword">final</span> SQLExpression expression = getExpression(literals);</div><div class="line">   <span class="comment">// SQLIdentifierExpression 需要特殊处理。考虑自定义函数，表名.属性情况。</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// 例如，ORDER BY o.uid 中的 "o.uid"</span></div><div class="line">           String property = getLexer().getCurrentToken().getLiterals();</div><div class="line">           getLexer().nextToken();</div><div class="line">           <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : <span class="keyword">new</span> SQLPropertyExpression(<span class="keyword">new</span> SQLIdentifierExpression(literals), property);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.LEFT_PAREN)) &#123; <span class="comment">// 例如，GROUP BY DATE(create_time) 中的 "DATE(create_time)"</span></div><div class="line">           skipParentheses();</div><div class="line">           skipRestCompositeExpression();</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">   &#125;</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">return</span> skipIfCompositeExpression() ? <span class="keyword">new</span> SQLIgnoreExpression() : expression;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 获得 词法Token 对应的 SQLExpression</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> literals 词法字面量标记</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> SQLExpression</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> SQLExpression <span class="title">getExpression</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">       increaseParametersIndex();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLPlaceholderExpression(getParametersIndex() - <span class="number">1</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.CHARS)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLTextExpression(literals);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO 考虑long的情况</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.INT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.FLOAT)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Double.parseDouble(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TODO 考虑long的情况</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.HEX)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLNumberExpression(Integer.parseInt(literals, <span class="number">16</span>));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SQLIdentifierExpression(SQLUtil.getExactlyValue(literals));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SQLIgnoreExpression();</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 如果是 复合表达式，跳过。</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 是否跳过</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">skipIfCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT, Symbol.LEFT_PAREN)) &#123;</div><div class="line">       skipParentheses();</div><div class="line">       skipRestCompositeExpression();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 跳过剩余复合表达式</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipRestCompositeExpression</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (skipIfEqual(Symbol.PLUS, Symbol.SUB, Symbol.STAR, Symbol.SLASH, Symbol.PERCENT, Symbol.AMP, Symbol.BAR, Symbol.DOUBLE_AMP, Symbol.DOUBLE_BAR, Symbol.CARET, Symbol.DOT)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.QUESTION)) &#123;</div><div class="line">           increaseParametersIndex();</div><div class="line">       &#125;</div><div class="line">       getLexer().nextToken();</div><div class="line">       skipParentheses();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解析了 SQLExpression 有什么用呢？我们会在<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《查询SQL解析》</a>、<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《插入SQL解析》</a>、<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《更新SQL解析》</a>、<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《删除SQL解析》</a>。留个悬念😈，关注我的公众号<strong>（<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">芋道源码</a>）</strong>，<strong>实时收到新文更新通知</strong>。</p>
<h3 id="3-2-2-parseAlias"><a href="#3-2-2-parseAlias" class="headerlink" title="3.2.2 #parseAlias()"></a>3.2.2 #parseAlias()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 解析别名.不仅仅是字段的别名，也可以是表的别名。</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 别名</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">parseAlias</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// 解析带 AS 情况</span></div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.AS)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(Symbol.values())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.absent();</div><div class="line">       &#125;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 解析别名</span></div><div class="line">   <span class="comment">// TODO 增加哪些数据库识别哪些关键字作为别名的配置</span></div><div class="line">   <span class="keyword">if</span> (equalAny(Literals.IDENTIFIER, Literals.CHARS, DefaultKeyword.USER, DefaultKeyword.END, DefaultKeyword.CASE, DefaultKeyword.KEY, DefaultKeyword.INTERVAL, DefaultKeyword.CONSTRAINT)) &#123;</div><div class="line">       String result = SQLUtil.getExactlyValue(getLexer().getCurrentToken().getLiterals());</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">return</span> Optional.of(result);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-3-parseSingleTable"><a href="#3-2-3-parseSingleTable" class="headerlink" title="3.2.3 #parseSingleTable()"></a>3.2.3 #parseSingleTable()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 解析单表.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> sqlStatement SQL语句对象</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSingleTable</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> hasParentheses = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (equalAny(DefaultKeyword.SELECT)) &#123; <span class="comment">// multiple-update 或者 multiple-delete</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery"</span>);</div><div class="line">       &#125;</div><div class="line">       hasParentheses = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   Table table;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> beginPosition = getLexer().getCurrentToken().getEndPosition() - getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = getLexer().getCurrentToken().getLiterals();</div><div class="line">   getLexer().nextToken();</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(Symbol.DOT)) &#123;</div><div class="line">       getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">if</span> (hasParentheses) &#123;</div><div class="line">           accept(Symbol.RIGHT_PAREN);</div><div class="line">       &#125;</div><div class="line">       table = <span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), parseAlias());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (skipJoin()) &#123; <span class="comment">// multiple-update 或者 multiple-delete</span></div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Multiple-Table."</span>);</div><div class="line">   &#125;</div><div class="line">   sqlStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   sqlStatement.getTables().add(table);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-4-skipJoin"><a href="#3-2-4-skipJoin" class="headerlink" title="3.2.4 #skipJoin()"></a>3.2.4 #skipJoin()</h3><p>跳过表关联词法，支持 <code>SELECT * FROM t_user, t_order WHERE ...</code>, <code>SELECT * FROM t_user JOIN t_order ON ...</code>。下篇<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《查询SQL解析》</a><strong>解析表</strong>会用到这个方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 跳过表关联词法.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 是否表关联.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">skipJoin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.LEFT, DefaultKeyword.RIGHT, DefaultKeyword.FULL)) &#123;</div><div class="line">       skipIfEqual(DefaultKeyword.OUTER);</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.INNER)) &#123;</div><div class="line">       accept(DefaultKeyword.JOIN);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, Symbol.COMMA, DefaultKeyword.STRAIGHT_JOIN)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.CROSS)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.JOIN, DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.OUTER)) &#123;</div><div class="line">       <span class="keyword">if</span> (skipIfEqual(DefaultKeyword.APPLY)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-5-parseWhere"><a href="#3-2-5-parseWhere" class="headerlink" title="3.2.5 #parseWhere()"></a>3.2.5 #parseWhere()</h3><p>解析 WHERE 查询条件。目前支持 AND 条件，不支持 OR 条件。近期 OR 条件支持的可能性比较低。另外条件这块对括号解析需要继续优化，实际使用请勿写冗余的括号。例如：<code>SELECT * FROM tbl_name1 WHERE ((val1=?) AND (val2=?)) AND val3 =?</code>。</p>
<p>根据不同的运算操作符，分成如下情况：</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>附加条件</th>
<th>方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td></td>
<td>#parseEqualCondition()</td>
</tr>
<tr>
<td>IN</td>
<td></td>
<td>#parseInCondition()</td>
</tr>
<tr>
<td>BETWEEN</td>
<td></td>
<td>#parseBetweenCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td>Oracle 或 SQLServer 分页</td>
<td>#parseRowNumberCondition()</td>
</tr>
<tr>
<td>&lt;, &lt;=, &gt;, &gt;=</td>
<td></td>
<td>#parseOtherCondition()</td>
</tr>
<tr>
<td>LIKE</td>
<td></td>
<td>parseOtherCondition</td>
</tr>
</tbody>
</table>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 解析所有查询条件。</span></div><div class="line"><span class="comment">* 目前不支持 OR 条件。</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> sqlStatement SQL</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConditions</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="comment">// AND 查询</span></div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       parseComparisonCondition(sqlStatement);</div><div class="line">   &#125; <span class="keyword">while</span> (skipIfEqual(DefaultKeyword.AND));</div><div class="line">   <span class="comment">// 目前不支持 OR 条件</span></div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.OR)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125; </div><div class="line"><span class="comment">// TODO 解析组合expr</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 解析单个查询条件</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> sqlStatement SQL</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseComparisonCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   skipIfEqual(Symbol.LEFT_PAREN);</div><div class="line">   SQLExpression left = parseExpression(sqlStatement);</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.EQ)) &#123;</div><div class="line">       parseEqualCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.IN)) &#123;</div><div class="line">       parseInCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(DefaultKeyword.BETWEEN)) &#123;</div><div class="line">       parseBetweenCondition(sqlStatement, left);</div><div class="line">       skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (equalAny(Symbol.LT, Symbol.GT, Symbol.LT_EQ, Symbol.GT_EQ)) &#123;</div><div class="line">       <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLIdentifierExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLIdentifierExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left <span class="keyword">instanceof</span> SQLPropertyExpression &amp;&amp; sqlStatement <span class="keyword">instanceof</span> SelectStatement</div><div class="line">               &amp;&amp; isRowNumberCondition((SelectStatement) sqlStatement, ((SQLPropertyExpression) left).getName())) &#123;</div><div class="line">           parseRowNumberCondition((SelectStatement) sqlStatement);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           parseOtherCondition(sqlStatement);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (equalAny(DefaultKeyword.LIKE)) &#123;</div><div class="line">       parseOtherCondition(sqlStatement);</div><div class="line">   &#125;</div><div class="line">   skipIfEqual(Symbol.RIGHT_PAREN);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#parseComparisonCondition()</code> 解析到 <code>左SQL表达式(left)</code> 和 运算符，调用相应方法进一步处理。我们选择 <code>#parseEqualCondition()</code> 看下，其他方法有兴趣跳转 <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/master/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/SQLParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLParser</a> 查看。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 解析 = 条件</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> sqlStatement SQL</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> left 左SQLExpression</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseEqualCondition</span><span class="params">(<span class="keyword">final</span> SQLStatement sqlStatement, <span class="keyword">final</span> SQLExpression left)</span> </span>&#123;</div><div class="line">   getLexer().nextToken();</div><div class="line">   SQLExpression right = parseExpression(sqlStatement);</div><div class="line">   <span class="comment">// 添加列</span></div><div class="line">   <span class="comment">// TODO 如果有多表,且找不到column是哪个表的,则不加入condition,以后需要解析binding table</span></div><div class="line">   <span class="keyword">if</span> ((sqlStatement.getTables().isSingleTable() || left <span class="keyword">instanceof</span> SQLPropertyExpression)</div><div class="line">           <span class="comment">// 只有对路由结果有影响的才会添加到 conditions。SQLPropertyExpression 和 SQLIdentifierExpression 无法判断，所以未加入 conditions</span></div><div class="line">           &amp;&amp; (right <span class="keyword">instanceof</span> SQLNumberExpression || right <span class="keyword">instanceof</span> SQLTextExpression || right <span class="keyword">instanceof</span> SQLPlaceholderExpression)) &#123;</div><div class="line">       Optional&lt;Column&gt; column = find(sqlStatement.getTables(), left);</div><div class="line">       <span class="keyword">if</span> (column.isPresent()) &#123;</div><div class="line">           sqlStatement.getConditions().add(<span class="keyword">new</span> Condition(column.get(), right), shardingRule);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#parseEqualCondition()</code> 解析到 <code>右SQL表达式(right)</code>，并判断 <code>左右SQL表达式</code> 与路由逻辑是否有影响，如果有，则加入到 Condition。<strong>这个就是 <code>#parseWhere()</code> 的目的：解析 WHERE 查询条件对路由有影响的条件。</strong><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《路由》</a>相关的逻辑，会单独开文章介绍。这里，我们先留有映像。</p>
<h1 id="4-StatementParser-SQL语句解析器"><a href="#4-StatementParser-SQL语句解析器" class="headerlink" title="4. StatementParser SQL语句解析器"></a>4. StatementParser SQL语句解析器</h1><h2 id="4-1-StatementParser"><a href="#4-1-StatementParser" class="headerlink" title="4.1 StatementParser"></a>4.1 StatementParser</h2><p>StatementParser，SQL语句解析器。每种 SQL，都有相应的 SQL语句解析器实现。不同数据库，继承这些 SQL语句解析器，实现各自 SQL 上的差异。大体结构如下：</p>
<p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/06.png" alt=""></p>
<p>SQLParsingEngine 根据不同 SQL 调用对应工厂创建 StatementParser。核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectParserFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 创建Select语句解析器.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> sqlParser SQL解析器</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> Select语句解析器</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSelectParser <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> SQLParser sqlParser)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> MySQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MySQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> OracleParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OracleSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> SQLServerParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SQLServerSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sqlParser <span class="keyword">instanceof</span> PostgreSQLParser) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PostgreSQLSelectParser(sqlParser);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(String.format(<span class="string">"Cannot support sqlParser class [%s]."</span>, sqlParser.getClass()));</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用 <code>StatementParser#parse()</code> 实现方法，对 SQL 进行解析。具体解析过程，另开文章分享。</p>
<h2 id="4-2-Statement"><a href="#4-2-Statement" class="headerlink" title="4.2 Statement"></a>4.2 Statement</h2><p>不同 SQL 解析后，返回对应的 SQL 结果,即 Statement。大体结构如下：</p>
<p><img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/07.png" alt=""></p>
<p>Statement 包含两部分信息：</p>
<ul>
<li><p>分片上下文：用于 SQL 路由。</p>
<p>  <img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/08.png" alt=""></p>
</li>
<li><p>SQL 标记对象：用于 SQL 改写。</p>
<p> <img src="http://www.iocoder.cn/images/Sharding-JDBC/2017_07_26/09.png" alt=""></p>
</li>
</ul>
<p>我们会在后文增删改查SQL解析的过程中分享到它们。</p>
<h2 id="4-3-预告"><a href="#4-3-预告" class="headerlink" title="4.3 预告"></a>4.3 预告</h2><table>
<thead>
<tr>
<th>Parser</th>
<th>Statement</th>
<th>分享文章</th>
</tr>
</thead>
<tbody>
<tr>
<td>SelectStatementParser</td>
<td>SelectStatement + AbstractSQLStatement</td>
<td><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《查询SQL解析》</a></td>
</tr>
<tr>
<td>InsertStatementParser</td>
<td>InsertStatement</td>
<td><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《插入SQL解析》</a></td>
</tr>
<tr>
<td>UpdateStatementParser</td>
<td>UpdateStatement</td>
<td><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《更新SQL解析》</a></td>
</tr>
<tr>
<td>DeleteStatementParser</td>
<td>DeleteStatement</td>
<td><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《删除SQL解析》</a></td>
</tr>
</tbody>
</table>
<h1 id="5-彩蛋"><a href="#5-彩蛋" class="headerlink" title="5. 彩蛋"></a>5. 彩蛋</h1><p>老铁，是不是有丢丢长？<br>如果有地方错误，烦请指出🙂。<br>如果有地方不是很理解，可以加我的公众号<strong>（<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">芋道源码</a>）</strong>留言，我会<strong>逐条认真耐心</strong>回复。<br>如果觉得还凑合，劳驾分享朋友圈或者基佬。</p>
<p><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">《查询SQL解析》</a>已经写了一半，预计很快…</p>
<p><img src="https://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Sharding-JDBC/">Sharding-JDBC</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.iocoder.cn/Sharding-JDBC/sql-parse-2/" data-title="Sharding-JDBC 源码分析 —— SQL 解析（二）之SQL解析 | 芋道源码 —— 纯源码解析博客" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/Sharding-JDBC/sql-parse-3/" title="Sharding-JDBC 源码分析 —— SQL 解析（三）之查询SQL">
  <strong>PREVIOUS:</strong><br>
  <span>
  Sharding-JDBC 源码分析 —— SQL 解析（三）之查询SQL</span>
</a>
</div>


<div class="next">
<a href="/Sharding-JDBC/sql-parse-1/" title="Sharding-JDBC 源码分析 —— SQL 解析（一）之词法解析">
 <strong>NEXT:</strong><br> 
 <span>Sharding-JDBC 源码分析 —— SQL 解析（一）之词法解析
</span>
</a>
</div>

</nav>

	

</div>  
        <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="toc" class="toc-aside">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SQLParsingEngine"><span class="toc-number">2.</span> <span class="toc-text">2. SQLParsingEngine</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-SQLParser-SQL解析器"><span class="toc-number">3.</span> <span class="toc-text">3. SQLParser SQL解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-AbstractParser"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 AbstractParser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-SQLParser"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 SQLParser</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-parseExpression-和-SQLExpression"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 #parseExpression() 和 SQLExpression</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-parseAlias"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 #parseAlias()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-parseSingleTable"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 #parseSingleTable()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-skipJoin"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.2.4 #skipJoin()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5-parseWhere"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.2.5 #parseWhere()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-StatementParser-SQL语句解析器"><span class="toc-number">4.</span> <span class="toc-text">4. StatementParser SQL语句解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-StatementParser"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 StatementParser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Statement"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Statement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-预告"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 预告</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-彩蛋"><span class="toc-number">5.</span> <span class="toc-text">5. 彩蛋</span></a></li></ol>
</div>

<div id="asidepart">
    <!--<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>-->
    <aside class="clearfix">
        <div id="authorInfo">
            <!---->
            <!--<div class="author-logo"></div>-->
            <!---->

            <div> <img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"> </div>

            <div class="social-list">
                
                
                
                
                
            </div>
        </div>

        
        <div class="categorieslist">
    <p class="asidetitle">微信公众号福利：芋道源码</p>
    <ul>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 0. 阅读源码葵花宝典 </a></li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 1. RocketMQ / MyCAT / Sharding-JDBC 详细中文注释源码 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 2. 您对于源码的疑问每条留言都将得到认真回复 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 3. 新的源码解析文章实时收到通知，每周六十点更新 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. 认真的源码交流微信群 </a> </li>


    </ul>
</div>
        
        
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
            
			    <li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li>
            
		
            
			    <li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li>
            
		
            
			    <li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/Myth/" title="Myth">Myth<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li>
            
		
            
			    <li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li>
            
		
            
			    <li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li>
            
		
            
			    <li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/工作内推/" title="工作内推">工作内推<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/技术杂文/" title="技术杂文">技术杂文<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/数据库实体设计/" title="数据库实体设计">数据库实体设计<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/芋道源码的周八/" title="芋道源码的周八">芋道源码的周八<sup>4</sup></a></li>
            
		
		</ul>
</div>

        
    </aside>
</div>
    </div>
    <footer><div id="footer">
    <img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display: none">
    
            <p class="copyright"> © 2018 
		
		<a href="http://www.iocoder.cn" target="_blank" title="芋道源码">芋道源码</a>
		
            && <span style="display: inline;" id="busuanzi_container_site_uv">总访客数 <span id="busuanzi_value_site_uv" font="微软雅黑"></span> 次</span>
            && <span style="display: inline;" id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv" font="微软雅黑"></span> 次</span>
            <!--&& Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>-->
            <!--&& Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney">coney</a>-->
            </p></div>
            <div class="copyright">沪ICP备17037075号-1</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<link rel="stylesheet" href="/alert/css/alert.css">
<script src="/alert/js/alert.js"></script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/util.js"></script>





<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-107572620-1', 'auto');  
ga('send', 'pageview');
</script>

  </body>


