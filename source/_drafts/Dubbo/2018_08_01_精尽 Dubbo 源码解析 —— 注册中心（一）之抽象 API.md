# 1. æ¦‚è¿°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹ã€Œ3.5 dubbo-registryã€](#) ä¸­ï¼Œå¯¹ `dubbo-registry` **æ³¨å†Œä¸­å¿ƒ**è¿™ä¸ªå¤§æ¨¡å—åšäº†å¤§ä½“çš„ä»‹ç»ã€‚é‚£ä¹ˆä»æœ¬æ–‡å¼€å§‹ï¼Œåˆ†äº«æ³¨å†Œä¸­å¿ƒçš„ä»£ç å®ç°ã€‚

æœ¬æ–‡åˆ†äº« `dubbo-registry-api` æ¨¡å—ï¼Œæ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ API ï¼Œç±»ç»“æ„å¦‚ä¸‹å›¾ï¼š

[ç±»å›¾](http://www.iocoder.cn/images/Dubbo/2018_08_01/01.png)

ğŸ˜ˆ æ•´ä½“æ¯”è¾ƒæ˜“æ‡‚ï¼Œç¬”è€…åœ¨è¿™é‡Œå…ˆä¸ä»‹ç»ï¼Œèƒ–å‹å¯ä»¥çœ‹å®Œæœ¬æ–‡ï¼Œå›è¿‡å¤´çœ‹çœ‹ï¼Œè‡ªå·±æ˜¯ä¸æ˜¯ç†è§£äº†ï¼Ÿï¼

ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºï¼Œé€ä¸ªåˆ†äº«ã€‚

# 2. RegistryFactory

[`com.alibaba.dubbo.registry.RegistryFactory`](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryFactory.java) ï¼Œæ³¨å†Œä¸­å¿ƒå·¥å‚**æ¥å£**ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
@SPI("dubbo")
public interface RegistryFactory {

    /**
     * Connect to the registry
     * <p>
     * Connecting the registry needs to support the contract: <br>
     * 1. When the check=false is set, the connection is not checked, otherwise the exception is thrown when disconnection <br>
     * 2. Support username:password authority authentication on URL.<br>
     * 3. Support the backup=10.20.153.10 candidate registry cluster address.<br>
     * 4. Support file=registry.cache local disk file cache.<br>
     * 5. Support the timeout=1000 request timeout setting.<br>
     * 6. Support session=60000 session timeout or expiration settings.<br>
     *
     * @param url Registry address, is not allowed to be empty
     * @return Registry reference, never return empty value
     */
    /**
     * è¿æ¥æ³¨å†Œä¸­å¿ƒ.
     * <p>
     * è¿æ¥æ³¨å†Œä¸­å¿ƒéœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. å½“è®¾ç½®check=falseæ—¶è¡¨ç¤ºä¸æ£€æŸ¥è¿æ¥ï¼Œå¦åˆ™åœ¨è¿æ¥ä¸ä¸Šæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚<br>
     * 2. æ”¯æŒURLä¸Šçš„username:passwordæƒé™è®¤è¯ã€‚<br>
     * 3. æ”¯æŒbackup=10.20.153.10å¤‡é€‰æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€ã€‚<br>
     * 4. æ”¯æŒfile=registry.cacheæœ¬åœ°ç£ç›˜æ–‡ä»¶ç¼“å­˜ã€‚<br>
     * 5. æ”¯æŒtimeout=1000è¯·æ±‚è¶…æ—¶è®¾ç½®ã€‚<br>
     * 6. æ”¯æŒsession=60000ä¼šè¯è¶…æ—¶æˆ–è¿‡æœŸè®¾ç½®ã€‚<br>
     *
     * @param url æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¸å…è®¸ä¸ºç©º
     * @return æ³¨å†Œä¸­å¿ƒå¼•ç”¨ï¼Œæ€»ä¸è¿”å›ç©º
     */
    @Adaptive({"protocol"})
    Registry getRegistry(URL url);

}
```

* RegistryFactory æ˜¯ä¸€ä¸ª Dubbo SPI æ‹“å±•æ¥å£ã€‚
* `#getRegistry(url)` æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚
    * æ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„**å¤„ç†å¥‘çº¦**ã€‚
    * `@Adaptive({"protocol"})` æ³¨è§£ï¼ŒDubbo SPI ä¼šè‡ªåŠ¨å®ç° RegistryFactory$Adaptive ç±»ï¼Œæ ¹æ® `url.protocol` è·å¾—å¯¹åº”çš„ RegistryFactory å®ç°ç±»ã€‚ä¾‹å¦‚ï¼Œ`url.protocol = zookeeper` æ—¶ï¼Œè·å¾— ZookeeperRegistryFactory å®ç°ç±»ã€‚

## 2.1 AbstractRegistryFactory    

[`com.alibaba.dubbo.registry.support.AbstractRegistryFactory`](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java) ï¼Œå®ç° RegistryFactory æ¥å£ï¼ŒRegistryFactory æŠ½è±¡ç±»ï¼Œå®ç°äº† Registry çš„**ç¼“å­˜ç®¡ç†**ã€‚

### 2.1.1 å±æ€§

```Java
// The lock for the acquisition process of the registry
private static final ReentrantLock LOCK = new ReentrantLock();

/**
 * Registry é›†åˆ
 *
 * keyï¼š{@link URL#toServiceString()}
 */
// Registry Collection Map<RegistryAddress, Registry>
private static final Map<String, Registry> REGISTRIES = new ConcurrentHashMap<String, Registry>();
```

* `REGISTRIES` é™æ€å±æ€§ï¼ŒRegistry é›†åˆã€‚
* `LOCK` é™æ€å±æ€§ï¼Œé”ï¼Œç”¨äº `#destroyAll()` å’Œ `#getRegistry(url)` æ–¹æ³•ï¼Œå¯¹ `REGISTRIES` è®¿é—®çš„ç«äº‰ã€‚

### 2.1.2 createRegistry

`#createRegistry(url)` **æŠ½è±¡**æ–¹æ³•ï¼Œåˆ›å»º Registry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
/**
 * åˆ›å»º Registry å¯¹è±¡
 *
 * @param url æ³¨å†Œä¸­å¿ƒåœ°å€
 * @return Registry å¯¹è±¡
 */
protected abstract Registry createRegistry(URL url);
```

å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œåˆ›å»ºå…¶å¯¹åº”çš„ Registry å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒZookeeperRegistryFactory çš„è¯¥æ–¹æ³•ï¼Œåˆ›å»º ZookeeperRegistry å¯¹è±¡ã€‚

### 2.1.3 getRegistry

[`#getRegistry(url)`](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L96-L132) **å®ç°**æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è¿›è¡Œåˆ›å»ºã€‚

* ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚

### 2.1.4 destroyAll

[`#destroyAll()`](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L65-L94) æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ Registry å¯¹è±¡ã€‚

* ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚

# 3. RegistryService

 [`com.alibaba.dubbo.registry.RegistryService`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryService.java) ï¼Œæ³¨å†Œä¸­å¿ƒæœåŠ¡**æ¥å£**ï¼Œå®šä¹‰äº†æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢**ä¸‰ç§**æ“ä½œæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š
 
 * `#register(url)` æ–¹æ³•ï¼Œ**æ³¨å†Œ**æ•°æ®ï¼Œæ¯”å¦‚ï¼šæä¾›è€…åœ°å€ï¼Œæ¶ˆè´¹è€…åœ°å€ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™ï¼Œç­‰æ•°æ®ã€‚
    * `#unregister(url)` æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚ 
* `#subscribe(url, NotifyListener)` æ–¹æ³•ï¼Œ**è®¢é˜…**ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œå½“æœ‰æ³¨å†Œæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ¨é€ã€‚
    * `#unsubscribe(url, NotifyListener)` æ–¹æ³•ï¼Œå–æ¶ˆè®¢é˜…ã€‚
* `#lookup(url)` æ–¹æ³•ï¼Œ**æŸ¥è¯¢**ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚

psï¼šæ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„å¤„ç†å¥‘çº¦ã€‚

## 3.1 Registry

[`com.alibaba.dubbo.registry.Registry`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/Registry.java) ï¼Œæ³¨å†Œä¸­å¿ƒ**æ¥å£**ã€‚Registry ç»§æ‰¿äº†ï¼š

* RegistryService æ¥å£ï¼Œæ‹¥æœ‰æ‹¥æœ‰æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ä¸‰ç§æ“ä½œæ–¹æ³•ã€‚
* [`com.alibaba.dubbo.common.Node`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-common/src/main/java/com/alibaba/dubbo/common/Node.java) æ¥å£ï¼Œæ‹¥æœ‰èŠ‚ç‚¹ç›¸å…³çš„æ–¹æ³•ã€‚

## 3.2 AbstractRegistry

## 3.3 FailbackRegistry

# 4. ProviderConsumerRegTable

## 4.1 ProviderInvokerWrapper

## 4.2 ConsumerInvokerWrapper

# 5. integration

# 5.1 RegistryProtocol

# 5.2 

# 666. å½©è›‹


