# 1. 概述

在 [《精尽 Dubbo 源码分析 —— 项目结构一览》「3.5 dubbo-registry」](#) 中，对 `dubbo-registry` **注册中心**这个大模块做了大体的介绍。那么从本文开始，分享注册中心的代码实现。

本文分享 `dubbo-registry-api` 模块，注册中心的抽象 API ，类结构如下图：

[类图](http://www.iocoder.cn/images/Dubbo/2018_08_01/01.png)

😈 整体比较易懂，笔者在这里先不介绍，胖友可以看完本文，回过头看看，自己是不是理解了？！

下面，我们按照从左到右的顺序，逐个分享。

# 2. RegistryFactory

[`com.alibaba.dubbo.registry.RegistryFactory`](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryFactory.java) ，注册中心工厂**接口**，代码如下：

```Java
@SPI("dubbo")
public interface RegistryFactory {

    /**
     * Connect to the registry
     * <p>
     * Connecting the registry needs to support the contract: <br>
     * 1. When the check=false is set, the connection is not checked, otherwise the exception is thrown when disconnection <br>
     * 2. Support username:password authority authentication on URL.<br>
     * 3. Support the backup=10.20.153.10 candidate registry cluster address.<br>
     * 4. Support file=registry.cache local disk file cache.<br>
     * 5. Support the timeout=1000 request timeout setting.<br>
     * 6. Support session=60000 session timeout or expiration settings.<br>
     *
     * @param url Registry address, is not allowed to be empty
     * @return Registry reference, never return empty value
     */
    /**
     * 连接注册中心.
     * <p>
     * 连接注册中心需处理契约：<br>
     * 1. 当设置check=false时表示不检查连接，否则在连接不上时抛出异常。<br>
     * 2. 支持URL上的username:password权限认证。<br>
     * 3. 支持backup=10.20.153.10备选注册中心集群地址。<br>
     * 4. 支持file=registry.cache本地磁盘文件缓存。<br>
     * 5. 支持timeout=1000请求超时设置。<br>
     * 6. 支持session=60000会话超时或过期设置。<br>
     *
     * @param url 注册中心地址，不允许为空
     * @return 注册中心引用，总不返回空
     */
    @Adaptive({"protocol"})
    Registry getRegistry(URL url);

}
```

* RegistryFactory 是一个 Dubbo SPI 拓展接口。
* `#getRegistry(url)` 方法，获得注册中心 Registry 对象。
    * 注意方法上注释的**处理契约**。
    * `@Adaptive({"protocol"})` 注解，Dubbo SPI 会自动实现 RegistryFactory$Adaptive 类，根据 `url.protocol` 获得对应的 RegistryFactory 实现类。例如，`url.protocol = zookeeper` 时，获得 ZookeeperRegistryFactory 实现类。

## 2.1 AbstractRegistryFactory    

[`com.alibaba.dubbo.registry.support.AbstractRegistryFactory`](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java) ，实现 RegistryFactory 接口，RegistryFactory 抽象类，实现了 Registry 的**缓存管理**。

### 2.1.1 属性

```Java
// The lock for the acquisition process of the registry
private static final ReentrantLock LOCK = new ReentrantLock();

/**
 * Registry 集合
 *
 * key：{@link URL#toServiceString()}
 */
// Registry Collection Map<RegistryAddress, Registry>
private static final Map<String, Registry> REGISTRIES = new ConcurrentHashMap<String, Registry>();
```

* `REGISTRIES` 静态属性，Registry 集合。
* `LOCK` 静态属性，锁，用于 `#destroyAll()` 和 `#getRegistry(url)` 方法，对 `REGISTRIES` 访问的竞争。

### 2.1.2 createRegistry

`#createRegistry(url)` **抽象**方法，创建 Registry 对象。代码如下：

```Java
/**
 * 创建 Registry 对象
 *
 * @param url 注册中心地址
 * @return Registry 对象
 */
protected abstract Registry createRegistry(URL url);
```

子类实现该方法，创建其对应的 Registry 实现类。例如，ZookeeperRegistryFactory 的该方法，创建 ZookeeperRegistry 对象。

### 2.1.3 getRegistry

[`#getRegistry(url)`](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L96-L132) **实现**方法，获得注册中心 Registry 对象。优先从缓存中获取，否则进行创建。

* 🙂 实现比较易懂，点击链接查看，有代码注释。

### 2.1.4 destroyAll

[`#destroyAll()`](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L65-L94) 方法，销毁所有 Registry 对象。

* 🙂 实现比较易懂，点击链接查看，有代码注释。

# 3. RegistryService

 [`com.alibaba.dubbo.registry.RegistryService`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryService.java) ，注册中心服务**接口**，定义了注册、订阅、查询**三种**操作方法，如下：
 
 * `#register(url)` 方法，**注册**数据，比如：提供者地址，消费者地址，路由规则，覆盖规则，等数据。
    * `#unregister(url)` 方法，取消注册。 
* `#subscribe(url, NotifyListener)` 方法，**订阅**符合条件的已注册数据，当有注册数据变更时自动推送。
    * `#unsubscribe(url, NotifyListener)` 方法，取消订阅。
* `#lookup(url)` 方法，**查询**符合条件的已注册数据，与订阅的推模式相对应，这里为拉模式，只返回一次结果。

ps：注意方法上注释的处理契约。

## 3.1 Registry

[`com.alibaba.dubbo.registry.Registry`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/Registry.java) ，注册中心**接口**。Registry 继承了：

* RegistryService 接口，拥有拥有注册、订阅、查询三种操作方法。
* [`com.alibaba.dubbo.common.Node`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-common/src/main/java/com/alibaba/dubbo/common/Node.java) 接口，拥有节点相关的方法。

## 3.2 AbstractRegistry

## 3.3 FailbackRegistry

# 4. ProviderConsumerRegTable

## 4.1 ProviderInvokerWrapper

## 4.2 ConsumerInvokerWrapper

# 5. integration

# 5.1 RegistryProtocol

# 5.2 

# 666. 彩蛋


