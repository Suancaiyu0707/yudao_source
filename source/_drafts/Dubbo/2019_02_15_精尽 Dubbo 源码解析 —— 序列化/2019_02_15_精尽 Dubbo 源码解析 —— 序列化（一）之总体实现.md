title: ç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åºåˆ—åŒ–ï¼ˆä¸€ï¼‰ä¹‹æ€»ä½“å®ç°
date: 2019-02-15
tags:
categories: Dubbo
permalink: Dubbo/serialize-1-all

-------

# 1. æ¦‚è¿°

ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„åºåˆ—åŒ–çš„å®ç°ã€‚åœ¨ [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” åºåˆ—åŒ–æ‰©å±•ã€‹](https://dubbo.gitbooks.io/dubbo-dev-book/impls/serialize.html) ï¼Œå¯¹åºåˆ—åŒ–å®šä¹‰å¦‚ä¸‹ï¼š

> å°†å¯¹è±¡è½¬æˆå­—èŠ‚æµï¼Œç”¨äºç½‘ç»œä¼ è¾“ï¼Œä»¥åŠå°†å­—èŠ‚æµè½¬ä¸ºå¯¹è±¡ï¼Œç”¨äºåœ¨æ”¶åˆ°å­—èŠ‚æµæ•°æ®åè¿˜åŸæˆå¯¹è±¡ã€‚

* æ‰€ä»¥ï¼Œåºåˆ—åŒ–å®é™…ä¸ŠåŒ…å«**ä¸¤éƒ¨åˆ†**ã€‚
* æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬éœ€è¦**å¼ºè°ƒ**ä¸€ä¸‹ï¼šåè®®å’Œåºåˆ—åŒ–ï¼Œæ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒHTTP æ˜¯ä¸€ç§åè®®ï¼Œå¯ä»¥æœ‰ XML å’Œ JSON **ç­‰ç­‰**åºåˆ—åŒ–( æ•°æ®äº¤æ¢ )çš„æ–¹å¼ã€‚åŒæ—¶ï¼ŒXML å’Œ JSON ä¸ä»…ä»…å¯ä»¥ç”¨åœ¨ HTTP åè®®ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ HTTPS ç­‰ç­‰åè®®ä¸­ã€‚**æ‰€ä»¥ï¼Œåè®®å’Œåºåˆ—åŒ–ä¸æ˜¯åŒ…å«çš„å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆçš„å…³ç³»**ã€‚

åºåˆ—åŒ–åœ¨ `dubbo-common` é¡¹ç›®çš„ `serialize` æ¨¡å—å®ç°ã€‚ä»£ç ç»“æ„å¦‚ä¸‹å›¾ï¼š

> ğŸ™‚ åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Dubbo é¡¹ç›®ä¸­ï¼Œ`serialize` æ¨¡å—ï¼Œå·²ç»**ç‹¬ç«‹**æˆ `dubbo-serialize` é¡¹ç›®ã€‚

[ä»£ç ç»“æ„](http://www.iocoder.cn/images/Dubbo/2019_02_15/01.png)

* æœ€å¤–å±‚ï¼Œå®šä¹‰äº† API **æ¥å£**ã€‚
* `support` åŒ…ï¼Œæä¾›äº†å¤šç§åºåˆ—åŒ–çš„**å®ç°**ã€‚

# 2. API å®šä¹‰

API æ¥å£ï¼Œç±»å›¾å¦‚ä¸‹ï¼š

[ç±»å›¾](http://www.iocoder.cn/images/Dubbo/2019_02_15/02.png)

## 2.1 Serialization

`com.alibaba.dubbo.common.serialize.Serialization` ï¼Œ**åºåˆ—åŒ–**æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
@SPI("hessian2")
public interface Serialization {

    /**
     * get content type id
     *
     * è·å¾—å†…å®¹ç±»å‹ç¼–å·
     *
     * @return content type id
     */
    byte getContentTypeId();

    /**
     * get content type
     *
     * è·å¾—å†…å®¹ç±»å‹å
     *
     * @return content type
     */
    String getContentType();

    /**
     * create serializer
     *
     * åˆ›å»º ObjectOutput å¯¹è±¡ï¼Œåºåˆ—åŒ–è¾“å‡ºåˆ° OutputStream
     *
     * @param url URL
     * @param output è¾“å‡ºæµ
     * @return serializer
     * @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
     */
    @Adaptive
    ObjectOutput serialize(URL url, OutputStream output) throws IOException;

    /**
     * create deserializer
     *
     * åˆ›å»º ObjectInput å¯¹è±¡ï¼Œä» InputStream ååºåˆ—åŒ–
     *
     * @param url URL
     * @param input è¾“å…¥æµ
     * @return deserializer
     * @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
     */
    @Adaptive
    ObjectInput deserialize(URL url, InputStream input) throws IOException;

}
```

* `@SPI("hessian2")` æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º `"hessian2"` ï¼Œå³æœªé…ç½®æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ– ã€‚
* `#getContentTypeId()`,`#getContentType()` æ–¹æ³•ï¼Œè·å¾—å†…å®¹ç±»å‹ç¼–å·å’Œåå­—ã€‚
* `#serialize(...)`,`#deserialize(...)` æ–¹æ³•ï¼ŒğŸ™‚ å…·ä½“çœ‹æ³¨é‡Šã€‚
    * è™½ç„¶æ·»åŠ äº† `@Adaptive` æ³¨è§£ï¼Œ ä½†æ˜¯å®é™…ä¸Šï¼Œä¸ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œè€Œæ˜¯ä»£ç ä¸­ï¼Œç›´æ¥è·å–ã€‚ä¾‹å¦‚ï¼š

        ```Java
        // CodecSupport.java
        public static Serialization getSerialization(URL url) {
            return ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(
                    url.getParameter(Constants.SERIALIZATION_KEY, Constants.DEFAULT_REMOTING_SERIALIZATION));
        }
        ```
        * x
    * Serialization å®ç°ç±»ï¼Œå®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ ObjectOutput å’Œ ObjectInput **å®ç°ç±»**çš„å¯¹è±¡ã€‚

## 2.2 DataInput

`com.alibaba.dubbo.common.serialize.DataInput` ï¼Œæ•°æ®**è¾“å…¥**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
boolean readBool() throws IOException;

byte readByte() throws IOException;
short readShort() throws IOException;
int readInt() throws IOException;
long readLong() throws IOException;
float readFloat() throws IOException;
double readDouble() throws IOException;

String readUTF() throws IOException;

byte[] readBytes() throws IOException;
```

* ä» InputStream ä¸­ï¼Œè¯»å–**åŸºæœ¬ç±»å‹**çš„æ•°æ®ã€‚

### 2.2.1 ObjectInput

`com.alibaba.dubbo.common.serialize.ObjectInput` ï¼Œå®ç° DataInput æ¥å£ï¼Œå¯¹è±¡**è¾“å…¥**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
Object readObject() throws IOException, ClassNotFoundException;
<T> T readObject(Class<T> cls) throws IOException, ClassNotFoundException;
<T> T readObject(Class<T> cls, Type type) throws IOException, ClassNotFoundException;
```

* åœ¨ DataInput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ è¯»å–å¯¹è±¡çš„æ•°æ®ã€‚

## 2.3 DataOutput

> DataOutput å’Œ DataInput ç›¸åã€‚

`com.alibaba.dubbo.common.serialize.DataOutput` ï¼Œæ•°æ®**è¾“å‡º**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
void writeBool(boolean v) throws IOException;
    
void writeByte(byte v) throws IOException;
void writeShort(short v) throws IOException;
void writeInt(int v) throws IOException;
void writeLong(long v) throws IOException;
void writeFloat(float v) throws IOException;
void writeDouble(double v) throws IOException;

void writeUTF(String v) throws IOException;

void writeBytes(byte[] v) throws IOException;
void writeBytes(byte[] v, int off, int len) throws IOException;

// Flush buffer.
void flushBuffer() throws IOException;
```

* å‘ InputStream ä¸­ï¼Œå†™å…¥**åŸºæœ¬ç±»å‹**çš„æ•°æ®ã€‚

### 2.3.1 ObjectOutput

`com.alibaba.dubbo.common.serialize.ObjectOutput` ï¼Œå®ç° DataOutput æ¥å£ï¼Œå¯¹è±¡**è¾“å‡º**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
void writeObject(Object obj) throws IOException;
```

* åœ¨ DataOutput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ å†™å…¥å¯¹è±¡çš„æ•°æ®ã€‚

## 2.4 Cleanable

`com.alibaba.dubbo.common.serialize.Cleanable` ï¼Œ**æ¸…ç†**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
void cleanup();
```

* éƒ¨åˆ† Serialize å®ç°ç±»ï¼Œå®Œæˆåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œéœ€è¦åšæ¸…ç†ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæ‰§è¡Œæ¸…ç†çš„é€»è¾‘ã€‚

## 2.5 Optimizer ç›¸å…³

### 2.5.1  SerializationOptimizer

`com.alibaba.dubbo.common.serialize.support.SerializationOptimizer` ï¼Œåºåˆ—åŒ–ä¼˜åŒ–å™¨æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
public interface SerializationOptimizer {

    /**
     * @return éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆ
     */
    Collection<Class> getSerializableClasses();

}
```

åœ¨ Kryo ã€Fst ä¸­ï¼Œæ”¯æŒ**é…ç½®**éœ€è¦ä¼˜åŒ–çš„ç±»ã€‚ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå¯ä»¥å®ç°è‡ªå®šä¹‰çš„ SerializationOptimizer å­ç±»ï¼Œè¿›è¡Œé…ç½®ã€‚å½“ç„¶ï¼Œä½¿ç”¨æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªé€‰æ‹©ï¼ŒDubbo åœ¨å®ç°è€ƒè™‘å–èˆçš„åŸå› å¦‚ä¸‹ï¼š

> FROM ç±»æ³¨é‡Š
> 
> This class can be replaced with the contents in config file, but for now I think the class is easier to write
> 
> è¿™ä¸ªç±»å¯ä»¥æ›¿æ¢ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œä½†æ˜¯ç°åœ¨æˆ‘è®¤ä¸ºè¿™ä¸ªç±»æ›´å®¹æ˜“ç¼–å†™ã€‚

### 2.5.2 SerializableClassRegistry

`com.alibaba.dubbo.common.serialize.support.SerializableClassRegistry` ï¼Œåºåˆ—åŒ–ä¼˜åŒ–ç±»çš„æ³¨å†Œè¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public abstract class SerializableClassRegistry {

    private static final Set<Class> registrations = new LinkedHashSet<Class>();

    /**
     * only supposed to be called at startup time
     */
    public static void registerClass(Class clazz) {
        registrations.add(clazz);
    }

    public static Set<Class> getRegisteredClasses() {
        return registrations;
    }

}
```

* `#registerClass(clazz)` **é™æ€**æ–¹æ³•ï¼Œæ³¨å†Œã€‚åœ¨ `SerializationOptimizer#getSerializableClasses()` æ–¹æ³•ï¼Œè·å¾—çš„ç±»çš„é›†åˆï¼Œä¼šæ³¨å†Œåˆ° SerializableClassRegistry ä¸­ã€‚
* `#getRegisteredClasses()` **é™æ€**æ–¹æ³•ï¼Œè·å¾—ã€‚åœ¨ Kryo ã€Fst ä¸­ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾—éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆã€‚

### 2.5.3 åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨

åœ¨ `DubboProtocol#optimizeSerialization()` æ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
/**
 * å·²åˆå§‹åŒ–çš„ SerializationOptimizer å®ç°ç±»åçš„é›†åˆ
 */
private final Set<String> optimizers = new ConcurrentHashSet<String>();

private void optimizeSerialization(URL url) throws RpcException {
    // è·å¾— `"optimizer"` é…ç½®é¡¹
    String className = url.getParameter(Constants.OPTIMIZER_KEY, "");
    if (StringUtils.isEmpty(className) || optimizers.contains(className)) { // å·²æ³¨å†Œ
        return;
    }

    logger.info("Optimizing the serialization process for Kryo, FST, etc...");

    try {
        // åŠ è½½ SerializationOptimizer å®ç°ç±»
        Class clazz = Thread.currentThread().getContextClassLoader().loadClass(className);
        if (!SerializationOptimizer.class.isAssignableFrom(clazz)) {
            throw new RpcException("The serialization optimizer " + className + " isn't an instance of " + SerializationOptimizer.class.getName());
        }

        // åˆ›å»º SerializationOptimizer å¯¹è±¡
        SerializationOptimizer optimizer = (SerializationOptimizer) clazz.newInstance();
        if (optimizer.getSerializableClasses() == null) {
            return;
        }

        // æ³¨å†Œåˆ° SerializableClassRegistry ä¸­
        for (Class c : optimizer.getSerializableClasses()) {
            SerializableClassRegistry.registerClass(c);
        }

        // æ·»åŠ åˆ° optimizers ä¸­
        optimizers.add(className);
    } catch (ClassNotFoundException e) {
        throw new RpcException("Cannot find the serialization optimizer class: " + className, e);
    } catch (InstantiationException e) {
        throw new RpcException("Cannot instantiate the serialization optimizer class: " + className, e);
    } catch (IllegalAccessException e) {
        throw new RpcException("Cannot instantiate the serialization optimizer class: " + className, e);
    }
}
```

* ğŸ™‚ èƒ–å‹ï¼Œç›´æ¥çœ‹ä»£ç æ³¨é‡Šã€‚

# 3. 

