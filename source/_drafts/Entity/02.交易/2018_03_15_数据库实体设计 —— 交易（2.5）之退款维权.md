# 1. 概述

本文主要分享**交易模块的[退款维权](#)的数据库实体设计**。

基于如下信息，逆向猜测数据库实体：

* [有赞云提供的商家退款API](https://www.youzanyun.com/apilist/list/group_trade/trade_advanced)
* [有赞云提供的买家下单API](https://www.youzanyun.com/apilist/list/group_buyer/buyer_bill)
* [有赞**微商城**的退款维权](https://www.youzan.com/v2/trade/refundsManage/index)
* [有赞云**开发指南**的交易场景【订单逆向调用】](https://www.youzanyun.com/docs/guide/3399/3422)

> 【护脸旁白】  
> 笔者非电商行业出身 && **非有赞工程师**，所以有错误或不合理的地方，烦请斧正和探讨。  
> 有赞是个各方面都很 NICE 的公司，[推荐](http://www.iocoder.cn/NeiTui/hangzhou/?self) 。

# 2. 背景了解

## 2.1 买家如何申请退款/退款退货？

参见 [《买家如何申请退款/退款退货？》](https://help.youzan.com/qa?cat_sys=K#/menu/2118/detail/700?_k=24orls) 文档。

## 2.2 卖家如何处理维权订单

参见 [《卖家如何处理维权订单？》](https://help.youzan.com/qa?cat_sys=K#/menu/2118/detail/891?_k=asc0iq) 文档。

## 2.3 订单逆向调用

参见 [《有赞云**开发指南**的交易场景【订单逆向调用】》](https://www.youzanyun.com/docs/guide/3399/3422#-2-) 文档。

* 打开如上文档后，搜索 "**订单逆向调用**" 关键字。

## 2.4 退款维权状态图

[](http://www.iocoder.cn/images/Entity/2018_03_20/01.png)

# 3. 数据库实体

## 3.1 Trade

我们需要在 [Trade](https://github.com/YunaiV/doraemon-entity/blob/74600725d23eea2220490e5de07dc3556ef80036/src/main/java/cn/iocoder/doraemon/tradegroup/trade/entity/Trade.java#L210-L242) 上，新增退款维权相关的字段。

```Java
/**
 * 交易维权状态。
 *
 * 0 无维权，
 * 
 * 1 顾客发起维权，
 * 2 顾客拒绝商家的处理结果，
 * 3 顾客接受商家的处理结果，
 * 9 商家正在处理；
 *
 * 101 维权处理中,
 * 110 维权结束；
 *
 * 备注：1到10的状态码是微信维权状态码，100以上的状态码是有赞维权状态码
 */
private Integer feedback;
/**
 * 处于交易维权状态的订单数
 */
private Integer feedbackNum;
/**
 * 退款状态。
 *
 * 0 - NO_REFUND（无退款）
 * 1 - PARTIAL_REFUNDING（部分退款中）
 * 2 - PARTIAL_REFUNDED（已部分退款）
 * 3 - PARTIAL_REFUND_FAILED（部分退款失败）
 * 11 - FULL_REFUNDING（全额退款中）
 * 12 - FULL_REFUNDED（已全额退款）
 * 13 - FULL_REFUND_FAILED（全额退款失败）
 */
private Integer refundStatus;
```

* `feedback` ，交易维权状态。
    * 区间 `[1, 10]` ，**微信**退款维权状态码。 // TODO 6010，猜测是微信的**交易记录**的功能的投诉功能。目前暂时未测试出来。
    * 区间 `[100, +∞)` ，**有赞**退款维权状态码。
        * 101 ，退款维权处理中。当交易中存在**任意**交易明细（订单）处于退款维权处理中时，交易则处于该状态。
        * 110 ，退款维权已结束。当交易中交易明细（订单）的退款维权**全部**处理完成时，交易则处于该状态。
* `feedbackNum` ，处于退款维权状态的订单数。
    * `feedback = 0 || 110` 时，`feedbackNum = 0` 。
    * `feedback = 101` 时，`feedbackNum > 0` 。
* `refundStatus` ，退款状态。分成了**无退款、部分退款、全部退款**的三种金额情况。
    * 为什么存在**退款中**的中间状态？金额的退款不一定是实时到账，参见 [《订单退款到账说明》](https://help.youzan.com/qa?cat_sys=K#/menu/2118/detail/998?_k=nt1s94) 文档。
    * // TODO 说明下，退款单

## 3.2 TradeOrder

## 3.3 TradeRefund

## 3.4 TradeRefundDelivery

## 3.5 TradeRefundMessage

# 4. API

# 666. 彩蛋


