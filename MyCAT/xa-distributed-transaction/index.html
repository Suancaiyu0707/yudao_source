<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>MyCAT 源码分析 —— XA分布式事务 | 芋道源码 —— 纯源码解析BLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="芋道源码"><meta name="description" content="摘要: 原创出处 http://www.iocoder.cn/MyCAT/xa-distributed-transaction/ 「芋道源码」欢迎转载，保留摘要，谢谢！
本文主要基于 MyCAT 1.6.5 正式版  

1. 概述
2. XA 概念
3. MyCAT 代码实现
3.1 JDBC D"><meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客,Sharding-JDBC,分库分表"><link rel="alternate" href="atom.xml" title="芋道源码 —— 纯源码解析BLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="芋道源码 —— 纯源码解析BLOG">芋道源码 —— 纯源码解析BLOG</a></h1><a class="blog-motto">愿半生编码，如一生老友！</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="菜单"></a></div><nav class="animated"><ul><ul><li><a href="/">文章</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">微信公众号</a></li><li><a href="/link_url">友链</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/MyCAT/xa-distributed-transaction/" title="MyCAT 源码分析  —— XA分布式事务" itemprop="url">MyCAT 源码分析 —— XA分布式事务</a></h1><p class="article-author"></p><p class="article-time">总阅读量:<span id="busuanzi_value_page_pv"></span>次</p></header><div class="article-content"><p>摘要: 原创出处 <a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">http://www.iocoder.cn/MyCAT/xa-distributed-transaction/</a> 「芋道源码」欢迎转载，保留摘要，谢谢！</p><p><strong>本文主要基于 MyCAT 1.6.5 正式版</strong></p><ul><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">1. 概述</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">2. XA 概念</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3. MyCAT 代码实现</a><ul><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.1 JDBC Demo 代码</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.2 MyCAT 开启 XA 事务</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.3 MyCAT 接收 SQL</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.4 MySQL 接收 COMMIT</a><ul><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.4.1 单节点事务 or 多节点事务</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.4.2 协调日志</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.4.3 MultiNodeCoordinator</a></li></ul></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">3.5 MyCAT 启动回滚 XA事务</a></li></ul></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">4. MyCAT 实现缺陷</a><ul><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">4.1 协调日志写入性能</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">4.2 数据节点未全部 PREPARE 就进行 COMMIT</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">4.3 MyCAT 启动回滚 PREPARE 的 XA事务</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">4.4 单节点事务未记录协调日志</a></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">4.5 XA COMMIT 部分节点挂了重新恢复后，未进一步处理</a></li></ul></li><li><a href="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/">5. 彩蛋</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>🙂🙂🙂关注<strong>微信公众号：【芋道源码】</strong>有福利：</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>所有</strong>源码分析文章列表</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>中文注释源码 GitHub 地址</strong></li><li>您对于源码的疑问每条留言<strong>都</strong>将得到<strong>认真</strong>回复。<strong>甚至不知道如何读源码也可以请教噢</strong>。</li><li><strong>新的</strong>源码解析文章<strong>实时</strong>收到通知。<strong>每周更新一篇左右</strong>。</li><li><strong>认真的</strong>源码交流微信群。</li></ol></blockquote><hr><h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>数据库拆分后，业务上会碰到需要分布式事务的场景。MyCAT 基于 XA 实现分布式事务。国内目前另外一款很火的数据库中间件 Sharding-JDBC 准备基于 TCC 实现分布式事务。</p><p>本文内容分成三部分：</p><ol><li>XA 概念简述</li><li>MyCAT 代码如何实现 XA</li><li>MyCAT 在实现 XA 存在的一些缺陷</li></ol><h1 id="2-XA-概念"><a href="#2-XA-概念" class="headerlink" title="2. XA 概念"></a>2. XA 概念</h1><p>&gt;<br>X/Open 组织（即现在的 Open Group ）定义了分布式事务处理模型。 X/Open DTP 模型（ 1994 ）包括：</p><ol><li>应用程序（ <strong>AP</strong> ）</li><li>事务管理器（ <strong>TM</strong> ）</li><li>资源管理器（ <strong>RM</strong> ）</li><li>通信资源管理器（ <strong>CRM</strong> ）<br>一般，常见的事务管理器（ TM ）是交易中间件，常见的资源管理器（ <strong>RM</strong> ）是数据库，常见的通信资源管理器（ <strong>CRM</strong> ）是消息中间件，下图是X/Open DTP模型：</li></ol><p><img src="http://www.iocoder.cn/images/MyCAT/2017_07_15/01.png" alt=""></p><blockquote><p>一般的编程方式是这样的：</p><ol><li>配置 <strong>TM</strong> ，通过 <strong>TM</strong> 或者 <strong>RM</strong> 提供的方式，把 <strong>RM</strong> 注册到 <strong>TM</strong>。可以理解为给 <strong>TM</strong> 注册 <strong>RM</strong> 作为数据源。一个 <strong>TM</strong> 可以注册多个 <strong>RM</strong>。</li><li><strong>AP</strong> 从 <strong>TM</strong> 获取资源管理器的代理（例如：使用JTA接口，从TM管理的上下文中，获取出这个TM所管理的RM的JDBC连接或JMS连接）<br><strong>AP</strong> 向 <strong>TM</strong> 发起一个全局事务。这时，<strong>TM</strong> 会通知各个 <strong>RM</strong>。<strong>XID</strong>（全局事务ID）会通知到各个RM。</li><li><strong>AP</strong> 通过 <strong>TM</strong> 中获取的连接，<strong>间接</strong>操作 <strong>RM</strong> 进行业务操作。这时，<strong>TM</strong> 在每次 <strong>AP</strong> 操作时把 <strong>XID</strong>(包括所属分支的信息)传递给 <strong>RM</strong>，<strong>RM</strong> 正是通过这个 <strong>XID</strong> 关联来操作和事务的关系的。</li><li><strong>AP</strong> 结束全局事务时，<strong>TM</strong> 会通知 <strong>RM</strong> 全局事务结束。开始二段提交，也就是prepare - commit的过程。</li></ol></blockquote><hr><blockquote><p>XA协议指的是TM（事务管理器）和RM（资源管理器）之间的接口。目前主流的关系型数据库产品都是实现了XA接口的。JTA(Java Transaction API)是符合X/Open DTP模型的，事务管理器和资源管理器之间也使用了XA协议。 本质上也是借助两阶段提交协议来实现分布式事务的，下面分别来看看XA事务成功和失败的模型图：</p></blockquote><p><img src="http://www.iocoder.cn/images/MyCAT/2017_07_15/02.png" alt="成功"></p><p><img src="http://www.iocoder.cn/images/MyCAT/2017_07_15/03.png" alt="失败"></p><hr><p>😈 看到这里是不是有种黑人问号的感觉？淡定！我们接下来看 MyCAT 代码层面是如何实现 XA 的。另外，有兴趣对概念了解更多的，可以参看如下文章：</p><ol><li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">《XA事务处理》</a></li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">《XA Transaction SQL Syntax》</a></li><li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">《MySQL XA 事务支持调研》</a></li></ol><h1 id="3-MyCAT-代码实现"><a href="#3-MyCAT-代码实现" class="headerlink" title="3. MyCAT 代码实现"></a>3. MyCAT 代码实现</h1><ul><li>MyCAT ：TM，协调者。</li><li>数据节点 ：RM，参与者。</li></ul><h2 id="3-1-JDBC-Demo-代码"><a href="#3-1-JDBC-Demo-代码" class="headerlink" title="3.1 JDBC Demo 代码"></a>3.1 JDBC Demo 代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. 获得数据库连接</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. 开启 MyCAT XA 事务</span></div><div class="line">        conn.prepareStatement(<span class="string">"set xa=on"</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. 插入 SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 A库</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">"insert into t_user(id, username, password) VALUES (%d, '%s', '%s')"</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 B库</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">"insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')"</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. 提交 XA 事务</span></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>set xa=on</code> MyCAT 开启 XA 事务。</li><li><code>conn.commit</code> 提交 XA 事务。</li></ul><h2 id="3-2-MyCAT-开启-XA-事务"><a href="#3-2-MyCAT-开启-XA-事务" class="headerlink" title="3.2 MyCAT 开启 XA 事务"></a>3.2 MyCAT 开启 XA 事务</h2><p>当 MyCAT 接收到 <code>set xa = on</code> 命令时，开启 XA 事务，并生成 XA 事务编号。XA 事务编号生成算法为 UUID。核心代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) &#123;</div><div class="line">		<span class="comment">// ... 省略代码</span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: &#123;</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) &#123;</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">"set xa cmd on can't used in autocommit connection "</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: &#123;</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">"set xa cmd off not for external use "</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ... 省略代码</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) &#123;</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// 😈😈😈获得 XA 事务编号</span></div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">&#125;</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"'"</span> + getUUID() + <span class="string">"'"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123; <span class="comment">// 😈😈😈</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-3-MyCAT-接收-SQL"><a href="#3-3-MyCAT-接收-SQL" class="headerlink" title="3.3 MyCAT 接收 SQL"></a>3.3 MyCAT 接收 SQL</h2><p>此处 SQL 指的是 <code>insert</code>、<code>update</code>、<code>delete</code> 操作。</p><p>当向某个数据节点<strong>第一次</strong>发起 SQL 时，会在 SQL 前面附加 <code>XA START &#39;xaTranId&#39;</code>，并设置该数据节点<strong>连接</strong>事务状态为 <code>TxState.TX_STARTED_STATE</code>（<em>分布式事务状态，下文会专门整理</em>）。核心代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">boolean</span> clientAutoCommit)</span> </span>&#123;</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) &#123; <span class="comment">// 😈😈😈</span></div><div class="line">       xaCmd = <span class="string">"XA START "</span> + xaTxID + <span class="string">';'</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... 省略代码</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... 省略代码</span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) &#123;</div><div class="line">       sb.append(xaCmd);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">";"</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>举个 变量<code>sb</code> 的例子：</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">'1f2da7353e8846e5833b8d8dd041cfb1'</span>,<span class="string">'db2'</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">'b7c5ec1f-11cc-4599-851c-06ad617fec42'</span>, <span class="string">'d2694679-f6a2-4623-a339-48d4a868be90'</span>);</div></pre></td></tr></table></figure><h2 id="3-4-MySQL-接收-COMMIT"><a href="#3-4-MySQL-接收-COMMIT" class="headerlink" title="3.4 MySQL 接收 COMMIT"></a>3.4 MySQL 接收 COMMIT</h2><h3 id="3-4-1-单节点事务-or-多节点事务"><a href="#3-4-1-单节点事务-or-多节点事务" class="headerlink" title="3.4.1 单节点事务 or 多节点事务"></a>3.4.1 单节点事务 or 多节点事务</h3><p><code>COMMIT</code> 执行时，MyCAT 会判断 XA 事务里，涉及到的数据库节点数量。</p><ul><li>如果节点数量为 1，单节点事务，使用 <code>CommitNodeHandler</code> 处理。</li><li>如果节点数量 &gt; 1，多节点事务，使用 <code>MultiNodeCoordinator</code> 处理。</li></ul><p><code>CommitNodeHandler</code> 相比 <code>MultiNodeCoordinator</code> 来说，只有一个数据节点，不需要进行多节点协调，逻辑会相对简单，有兴趣的同学可以另外看。我们主要分析 <code>MultiNodeCoordinator</code>。</p><h3 id="3-4-2-协调日志"><a href="#3-4-2-协调日志" class="headerlink" title="3.4.2 协调日志"></a>3.4.2 协调日志</h3><p><strong>协调日志</strong>，记录协调过程中各数据节点 XA 事务状态，处理<strong>MyCAT异常奔溃</strong>或者<strong>数据节点部分XA COMMIT，另外部分 XA PREPARE</strong>下的状态恢复。</p><p><strong>XA 事务共有种</strong>：</p><ol><li>TX_INITIALIZE_STATE ：事务初始化</li><li>TX_STARTED_STATE ：事务开始完成</li><li>TX_PREPARED_STATE ：事务准备完成</li><li>TX_COMMITED_STATE ：事务提交完成</li><li>TX_ROLLBACKED_STATE ：事务回滚完成</li></ol><p><strong>状态变更流</strong> ：TX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE 。</p><p><strong>协调日志包含两个部分</strong>：</p><ol><li>CoordinatorLogEntry ：协调者日志</li><li>ParticipantLogEntry ：参与者日志。<strong>此处，数据节点扮演参与者的角色。下文中，可能会出现参与者与数据节点混用的情况，望见谅。</strong></li></ol><p><em>一次 XA 事务，对应一条 <code>CoordinatorLogEntry</code>。一条<code>CoordinatorLogEntry</code> 包含 N条<code>ParticipantLogEntry</code></em>。 核心代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry ：协调者日志</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * XA 事务编号</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 参与者日志数组</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ParticipantLogEntry ：参与者日志</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * XA 事务编号</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 数据库 uri</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 过期描述</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * XA 事务状态</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 参与者名字</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>MyCAT 记录协调日志以 JSON格式 到文件</strong>。<strong>每行</strong>包含一条<code>CoordinatorLogEntry</code>。举个例子：</p><figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'e827b3fe666c4d968961350d19adda31'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db3"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'f00b61fa17cb4ec5b8264a6d82f847d0'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db2"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div></pre></td></tr></table></figure><p>实现类为：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA 协调者日志 存储接口：https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA 协调者日志 文件存储：https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA 协调者日志 文件存储：https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div></pre></td></tr></table></figure><p>目前日志文件写入的方式性能较差，这里我们不做分析，在【4. MyCAT 实现缺陷】里一起讲。</p><h3 id="3-4-3-MultiNodeCoordinator"><a href="#3-4-3-MultiNodeCoordinator" class="headerlink" title="3.4.3 MultiNodeCoordinator"></a>3.4.3 MultiNodeCoordinator</h3><p>敲敲敲，这里是本文的重点之一噢。😈</p><p><strong>第一阶段：发起 PREPARE。</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// 执行</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) &#123;</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) &#123; <span class="comment">// XA 事务</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"XA END "</span> + xaTxId, <span class="comment">// XA END 命令</span></div><div class="line">                       <span class="string">"XA PREPARE "</span> + xaTxId&#125;; <span class="comment">// XA PREPARE 命令</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// 非 XA 事务</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           &#125;</div><div class="line">           ++started;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) &#123; <span class="comment">// TODO 疑问：如何触发</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">"some connection failed to execute "</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * assumption: only caused by front-end connection close. &lt;br/&gt;</span></div><div class="line"><span class="comment">        * Otherwise, packet must be returned to front-end</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>向各数据节点发送 <code>XA END</code> + <code>XA PREPARE</code> 指令。举个 变量<code>cmds</code> 例子：</li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;XA <span class="keyword">PREPARE</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;</div></pre></td></tr></table></figure><ul><li>记录协调日志。每条参与者日志状态为 <code>TxState.TX_STARTED_STATE</code>。</li></ul><hr><p><strong>第二阶段：发起 COMMIT。</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>&#123;</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) &#123;</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) &#123;</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) &#123;</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">"XA COMMIT "</span> + xaTxId + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"Start execute the cmd :"</span> + cmd + <span class="string">",current host:"</span> + mysqlCon.getHost() + <span class="string">":"</span> + mysqlCon.getPort());</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"[In Memory CoordinatorLogEntry]"</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: &#123;</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 释放连接</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) &#123;</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 是否所有节点都完成commit，如果是，则返回Client 成功</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) &#123;</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) &#123;</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 1.  事务提交后,xa 事务结束   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 2. preAcStates 为true,事务结束后,需要设置为true。preAcStates 为ac上一个状态    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) &#123;</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>mysqlCon.batchCmdFinished()</code> 每个数据节点，第一次返回的是 <code>XA END</code> 成功，第二次返回的是 <code>XA PREPARE</code>。在 <code>XA PREPARE</code> 成功后，记录该数据节点的<strong>参与者日志</strong>状态为 <code>TxState.TX_PREPARED_STATE</code>。之后，向该数据节点发起 <code>XA COMMIT</code> 命令。</li><li><code>XA COMMIT</code> 返回成功后，记录该数据节点的<strong>事务参与者日志</strong>状态为 <code>TxState.TX_COMMITED_STATE</code>。</li><li>当所有数据节点（参与者）都执行完成 <code>XA COMMIT</code> 返回，即 <code>this.finished() == true</code>，返回 MySQL Client XA 事务提交成功。</li></ul><p>[x] <code>XA PREPARE</code> 和 <code>XA COMMIT</code>，数据节点可能返回失败，目前暂时没模拟出来，对应方法为 <code>#errorResponse(....)</code>。</p><h2 id="3-5-MyCAT-启动回滚-XA事务"><a href="#3-5-MyCAT-启动回滚-XA事务" class="headerlink" title="3.5 MyCAT 启动回滚 XA事务"></a>3.5 MyCAT 启动回滚 XA事务</h2><p>MyCAT 启动时，会<strong>回滚处于TxState.TX_PREPARED_STATE</strong>的 <code>ParticipantLogEntry</code> 对应的数据节点的 XA 事务。代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) &#123;</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (needRollback) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">"XA ROLLBACK "</span> + coordinatorLogEntry.id + <span class="string">';'</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) &#123;</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) &#123;</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) &#123;</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) &#123;</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="4-MyCAT-实现缺陷"><a href="#4-MyCAT-实现缺陷" class="headerlink" title="4. MyCAT 实现缺陷"></a>4. MyCAT 实现缺陷</h1><p>MyCAT 1.6.5 版本实现弱XA事务，相对来说，笔者认为距离实际生产使用存在一些差距。下面罗列可能存在的缺陷，如有错误，麻烦指出。🙂希望 MyCAT 在分布式事务的实现上，能够越来越给力。</p><h2 id="4-1-协调日志写入性能"><a href="#4-1-协调日志写入性能" class="headerlink" title="4.1 协调日志写入性能"></a>4.1 协调日志写入性能</h2><p>1、<code>CoordinatorLogEntry</code>、<code>ParticipantLogEntry</code> 在每次写入文件时，是将内存中所有的日志<strong>全部重新</strong>写入，导致写入性能随着 XA 事务次数的增加，性能会越来越糟糕，导致 XA 事务整体性能会非常差。另外，该方法是<strong>同步</strong>的，也加大了写入的延迟。</p><p>建议：先获得可写入文件的 OFFSET，写入协调日志到文件，内存维护好 XA事务编号 与 OFFSET 的映射关系，从而实现<strong>顺序写入</strong> + <strong>并行写入</strong>。</p><p>2、内存里维护了所有的协调日志，占用内存会越来越大，并且无释放机制。即使重启，协调日志也会重新加载到内存。</p><p>建议：已完全回滚或者提交的协调日志不放入内存。另外有文件存储好 XA事务编号 与 OFFSET 的映射关系。</p><p>3、协调日志只写入单个文件。</p><p>建议：分拆协调日志文件。</p><p>PS：有兴趣的同学可以看下 <code>RocketMQ</code> 对 <code>CommitLog</code> 的存储，性能上很赞！</p><h2 id="4-2-数据节点未全部-PREPARE-就进行-COMMIT"><a href="#4-2-数据节点未全部-PREPARE-就进行-COMMIT" class="headerlink" title="4.2 数据节点未全部 PREPARE 就进行 COMMIT"></a>4.2 数据节点未全部 PREPARE 就进行 COMMIT</h2><p>XA 事务定义，需要等待所有参与者<strong>全部</strong> <code>XA PREPARE</code> 成功完成后发起 <code>XA COMMIT</code>。目前 MyCAT 是某个数据节点 <code>XA PREPARE</code> 完成后<strong>立即</strong>进行 <code>XA COMMIT</code>。比如说：第一个数据节点提交了 <code>XA END;XA PREPARE</code> 时，第二个数据节在进行 <code>XA END;XA PREAPRE;</code> 前挂了，第一个节点依然会 <code>XA COMMIT</code> 成功。</p><p>建议：按照严格的 XA 事务定义。</p><h2 id="4-3-MyCAT-启动回滚-PREPARE-的-XA事务"><a href="#4-3-MyCAT-启动回滚-PREPARE-的-XA事务" class="headerlink" title="4.3 MyCAT 启动回滚 PREPARE 的 XA事务"></a>4.3 MyCAT 启动回滚 PREPARE 的 XA事务</h2><p>1、MyCAT 启动时，回滚所有的 <code>PREPARE</code> 的 XA 事务，可能某个 XA 事务，部分 <code>COMMIT</code>，部分 <code>PREPARE</code>。此时直接回滚，会导致数据不一致。</p><p>建议：当判断到某个 XA 事务存在 <code>PREPARE</code> 的参与者，<strong>同时判断该 XA 事务里其他参与者的事务状态</strong>以及<strong>数据节点里 XA 事务状态</strong>，比如参与者为 <code>MySQL</code>时，可以使用 <code>XA RECOVER</code> 查询处于 <code>PREPARE</code> 所有的 XA 事务。</p><p>2、回滚 <code>PREPARE</code> 是异步进行的，在未进行完成时已经设置文件里回滚成功。如果异步过程中失败，会导致 XA 事务状态不一致。</p><p>建议：回调成功后，更新该 XA 事务状态。</p><h2 id="4-4-单节点事务未记录协调日志"><a href="#4-4-单节点事务未记录协调日志" class="headerlink" title="4.4 单节点事务未记录协调日志"></a>4.4 单节点事务未记录协调日志</h2><p>该情况较为极端。发起 <code>XA PREPARE</code>完后，MyCAT 挂了。重启后，该 XA 事务在 MyCAT 里就“消失“了，参与者的该 XA 事务一直处于 <code>PREPARE</code> 状态。从理论上来说，需要回滚该 XA 事务。</p><p>建议：记录协调日志。</p><h2 id="4-5-XA-COMMIT-部分节点挂了重新恢复后，未进一步处理"><a href="#4-5-XA-COMMIT-部分节点挂了重新恢复后，未进一步处理" class="headerlink" title="4.5 XA COMMIT 部分节点挂了重新恢复后，未进一步处理"></a>4.5 XA COMMIT 部分节点挂了重新恢复后，未进一步处理</h2><p>当一部分节点 <code>XA COMMIT</code> 完成，另外一部分此时挂了。在管理员重启挂掉的节点，其对应的 XA 事务未进一步处理，导致数据不一致。</p><p>建议：😈木有建议。也很好奇，如果是这样的情况，如何处理较为合适。如有大大知道，烦请告知下。</p><h1 id="5-彩蛋"><a href="#5-彩蛋" class="headerlink" title="5. 彩蛋"></a>5. 彩蛋</h1><p>例行“彩蛋”？</p><ul><li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">《Mycat源码篇 : MyCat事务管理机制分析》</a> 来自 MyCAT Committer 的文章</li><li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">《MySQL · 捉虫动态 · 连接断开导致XA事务丢失》</a></li><li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">《分布式系统事务一致性解决方案》</a></li><li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">《MySQL数据库分布式事务XA优缺点与改进方案》</a></li><li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">《深入理解分布式系统的2PC和3PC》</a></li><li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" rel="external nofollow noopener noreferrer" target="_blank">【分布式事务.xmind】</a> 笔者拙作</li><li><a href="http://www.iocoder.cn/RocketMQ/message-transaction/?self">《RocketMQ 源码分析 —— 事务消息》</a> 笔者拙作</li></ul></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/MyCAT/">MyCAT</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/MyCAT/xa-distributed-transaction/" data-title="MyCAT 源码分析  —— XA分布式事务 | 芋道源码 —— 纯源码解析BLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Sharding-JDBC/why-read-Sharding-JDBC-source-code/" title="Sharding-JDBC 源码分析 —— 为什么阅读 Sharding-JDBC 源码？"><strong>PREVIOUS:</strong><br><span>Sharding-JDBC 源码分析 —— 为什么阅读 Sharding-JDBC 源码？</span></a></div><div class="next"><a href="/MyCAT/two-table-share-join/" title="MyCAT 源码分析  —— 跨库两表Join"><strong>NEXT:</strong><br><span>MyCAT 源码分析 —— 跨库两表Join</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div><div id="toc" class="toc-aside"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-概念"><span class="toc-number">2.</span> <span class="toc-text">2. XA 概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-代码实现"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-代码"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo 代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-开启-XA-事务"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT 开启 XA 事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-接收-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT 接收 SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-接收-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL 接收 COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-单节点事务-or-多节点事务"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 单节点事务 or 多节点事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-协调日志"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 协调日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-启动回滚-XA事务"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT 启动回滚 XA事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-实现缺陷"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT 实现缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-协调日志写入性能"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 协调日志写入性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-数据节点未全部-PREPARE-就进行-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 数据节点未全部 PREPARE 就进行 COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-启动回滚-PREPARE-的-XA事务"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT 启动回滚 PREPARE 的 XA事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-单节点事务未记录协调日志"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 单节点事务未记录协调日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-部分节点挂了重新恢复后，未进一步处理"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT 部分节点挂了重新恢复后，未进一步处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-彩蛋"><span class="toc-number">5.</span> <span class="toc-text">5. 彩蛋</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">微信公众号福利：芋道源码</p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. 阅读源码葵花宝典</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC 详细中文注释源码</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. 您对于源码的疑问每条留言都将得到认真回复</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. 新的源码解析文章实时收到通知，每周六十点更新</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. 认真的源码交流微信群</a></li></ul></div><div class="categorieslist"><p class="asidetitle">分类</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/技术杂文/" title="技术杂文">技术杂文<sup>5</sup></a></li></ul></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">© 2017 <a href="http://www.iocoder.cn" target="_blank" title="芋道源码">芋道源码</a> && <span style="display:inline" id="busuanzi_container_site_uv">总访客数 <span id="busuanzi_value_site_uv" font="微软雅黑"></span> 次</span> && <span style="display:inline" id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv" font="微软雅黑"></span> 次</span></p></div><div class="copyright">沪ICP备17037075号-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>