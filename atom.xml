<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2018-01-09T09:50:59.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>èŠ‹é“æºç </name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent æ’ä»¶ï¼ˆä¸€ï¼‰ä¹‹ Tomcat</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/</id>
    <published>2020-11-19T16:00:00.000Z</published>
    <updated>2018-01-09T09:50:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/">http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/">2. TomcatInstrumentation</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/">2.1 TomcatInvokeInterceptor</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/">2.2 TomcatExceptionInterceptor</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Agent Tomcat æ’ä»¶</strong>ã€‚æ¶‰åŠåˆ°çš„ä»£ç ä¸å¤šï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_20/01.png" alt=""></p><h1 id="2-TomcatInstrumentation"><a href="#2-TomcatInstrumentation" class="headerlink" title="2. TomcatInstrumentation"></a>2. TomcatInstrumentation</h1><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/resources/skywalking-plugin.def" rel="external nofollow noopener noreferrer" target="_blank"><code>skywalking-plugin.def</code></a> é‡Œï¼Œå®šä¹‰äº†æ’ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_20/03.png" alt=""></p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/define/TomcatInstrumentation.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.plugin.tomcat78x.define.TomcatInstrumentation</code></a> ï¼Œå®ç° ClassInstanceMethodsEnhancePluginDefine æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†æ–¹æ³•åˆ‡é¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_20/02.png" alt=""></p><h2 id="2-1-TomcatInvokeInterceptor"><a href="#2-1-TomcatInvokeInterceptor" class="headerlink" title="2.1 TomcatInvokeInterceptor"></a>2.1 TomcatInvokeInterceptor</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/TomcatInvokeInterceptor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.plugin.tomcat78x.TomcatInvokeInterceptor</code></a> ï¼Œå®ç° InstanceMethodsAroundInterceptor æ¥å£ï¼ŒTomcatInstrumentation çš„æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/TomcatInvokeInterceptor.java#L5" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeMethod(...)</code></a> æ–¹æ³•ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 59 è‡³ 65 è¡Œï¼šè§£æ ContextCarrier å¯¹è±¡ï¼Œç”¨äºè·¨è¿›ç¨‹çš„é“¾è·¯è¿½è¸ªã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®ã€‹ã€Œ 3.2.3 ContextCarrier ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 68 è¡Œï¼šè°ƒç”¨ <code>ContextManager#createLocalSpan(operationName, contextCarrier)</code> æ–¹æ³•ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚</li><li>ç¬¬ 71 è‡³ 72 è¡Œï¼šè®¾ç½® EntrySpan å¯¹è±¡çš„ <code>url</code> / <code>http.method</code> æ ‡ç­¾é”®å€¼å¯¹ã€‚</li><li>ç¬¬ 75 è¡Œï¼šè®¾ç½® EntrySpan å¯¹è±¡çš„ç»„ä»¶ç±»å‹ã€‚</li><li>ç¬¬ 78 è¡Œï¼šè®¾ç½® EntrySpan å¯¹è±¡çš„åˆ†å±‚ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/TomcatInvokeInterceptor.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterMethod(...)</code></a> æ–¹æ³•ï¼Œå®Œæˆ EntrySpan å¯¹è±¡ã€‚<ul><li>ç¬¬ 89 è‡³ 92 è¡Œï¼šå½“è¿”å›çŠ¶æ€ç å¤§äºç­‰äº 400 æ—¶ï¼Œæ ‡è®° EntrySpan å‘ç”Ÿå¼‚å¸¸ï¼Œå¹¶è®¾ç½® <code>status_code</code> æ ‡ç­¾é”®å€¼å¯¹ã€‚</li><li>è°ƒç”¨ <code>ContextManager#stopSpan()</code> æ–¹æ³•ï¼Œå®Œæˆ EntrySpan å¯¹è±¡ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/TomcatInvokeInterceptor.java#L99" rel="external nofollow noopener noreferrer" target="_blank"><code>#handleMethodException(...)</code></a> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ã€‚<strong>æ³¨æ„</strong>ï¼Œè¯¥æ–¹æ³•å®é™…å¹¶ä¸”è°ƒç”¨ï¼Œåœ¨ Tomcat çš„<a href="https://github.com/Oreste-Luci/apache-tomcat-8.0.26-src/blob/master/java/org/apache/catalina/core/StandardWrapperValve.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>StandardWrapperValve#invoke(request, response)</code></a> æ–¹æ³•é‡Œï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šæäº¤å¼‚å¸¸ç»™ <a href="https://github.com/Oreste-Luci/apache-tomcat-8.0.26-src/blob/master/java/org/apache/catalina/core/StandardWrapperValve.java#L507" rel="external nofollow noopener noreferrer" target="_blank"><code>StandardWrapperValve#exception(request, response, exception)</code></a> å¤„ç†ï¼Œæ‰€ä»¥ä¼šè¢« <a href="#">ã€Œ 2.2 TomcatExceptionInterceptor ã€</a> æ‹¦æˆªã€‚</li></ul><h2 id="2-2-TomcatExceptionInterceptor"><a href="#2-2-TomcatExceptionInterceptor" class="headerlink" title="2.2 TomcatExceptionInterceptor"></a>2.2 TomcatExceptionInterceptor</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/TomcatExceptionInterceptor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.plugin.tomcat78x.TomcatExceptionInterceptor</code></a> ï¼Œå®ç° InstanceMethodsAroundInterceptor æ¥å£ï¼ŒTomcatInstrumentation çš„æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0128349b40592b8ae329443c52f43577cc9fa16b/apm-sniffer/apm-sdk-plugin/tomcat-7.x-8.x-plugin/src/main/java/org/skywalking/apm/plugin/tomcat78x/TomcatExceptionInterceptor.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeMethod(...)</code></a> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨ <code>AbstractSpan#errorOccurred()</code> æ–¹æ³•ï¼Œæ ‡è®° EntrySpan å¯¹è±¡å‘ç”Ÿå¼‚å¸¸ã€‚</li><li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨ <code>AbstractSpan#log(Throwable)</code> æ–¹æ³•ï¼Œè®°å½•å¼‚å¸¸æ—¥å¿—åˆ° EntrySpan å¯¹è±¡ã€‚</li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä¸€å¤§æ³¢æ’ä»¶æ¥è¢­ï¼</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_20/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢èƒ–å‹åœˆæ‹¬å·ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/&quot;&gt;http://www.iocoder.cn/SkyWalking/agent-plugin-tomcat/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” @Trace æ³¨è§£æƒ³è¦è¿½è¸ªçš„ä»»ä½•æ–¹æ³•</title>
    <link href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/"/>
    <id>http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/</id>
    <published>2020-11-09T16:00:00.000Z</published>
    <updated>2018-01-09T04:50:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">2. ä½¿ç”¨ä¾‹å­</a></li><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">3. å®ç°ä»£ç </a><ul><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">3.1 TraceAnnotationActivation</a></li><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">3.2 ActiveSpanTagActivation</a></li><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">3.3 TraceContextActivation</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>@Trace æ³¨è§£æƒ³è¦è¿½è¸ªçš„ä»»ä½•æ–¹æ³•</strong>ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹ <a href="https://github.com/apache/incubator-skywalking/blob/af2c1b979fe025603dc65d7e2a2dbdea8005ede8/apm-application-toolkit/apm-toolkit-trace/src/main/java/org/apache/skywalking/apm/toolkit/trace/Trace.java" rel="external nofollow noopener noreferrer" target="_blank"><code>@Trace</code></a> çš„ä½¿ç”¨ä¾‹å­ï¼Œå†çœ‹çœ‹ <code>@Trace</code> çš„å®ç°ä»£ç ã€‚æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š</p><ul><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/01.png" alt=""></li><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/02.png" alt=""></li></ul><h1 id="2-ä½¿ç”¨ä¾‹å­"><a href="#2-ä½¿ç”¨ä¾‹å­" class="headerlink" title="2. ä½¿ç”¨ä¾‹å­"></a>2. ä½¿ç”¨ä¾‹å­</h1><blockquote><p>æœ¬èŠ‚å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/apache/incubator-skywalking/blob/master/docs/cn/Application-toolkit-trace-CN.md" rel="external nofollow noopener noreferrer" target="_blank">Application-toolkit-trace-CN.md</a></p></blockquote><p>1ã€ä½¿ç”¨ Maven å¼•å…¥ç›¸åº”çš„å·¥å…·åŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.skywalking<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apm-toolkit-trace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;skywalking.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p>2ã€åœ¨<strong>ä»»ä½•æƒ³è¦è¿½è¸ª</strong>çš„æ–¹æ³•ä¸Šæ·»åŠ  <code>@Trace</code> æ³¨è§£ï¼Œä»¥ SpringMVC ä¸ºä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Trace</span></div><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/log"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">log</span><span class="params">()</span> </span>&#123;</div><div class="line">    ActiveSpan.tag(<span class="string">"mp"</span>, <span class="string">"èŠ‹é“æºç "</span>);</div><div class="line">    System.out.println(<span class="string">"traceIdï¼š"</span> + TraceContext.traceId());</div><div class="line">    <span class="keyword">return</span> <span class="string">"log"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>@Trace</code> æ³¨è§£çš„æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€ä¸ª <strong>LocalSpan</strong> ã€‚</li><li><a href="https://github.com/apache/incubator-skywalking/blob/af2c1b979fe025603dc65d7e2a2dbdea8005ede8/apm-application-toolkit/apm-toolkit-trace/src/main/java/org/apache/skywalking/apm/toolkit/trace/ActiveSpan.java#L32" rel="external nofollow noopener noreferrer" target="_blank"><code>ActiveSpan#tag(key, value)</code></a> æ–¹æ³•ï¼Œåœ¨ LocalSpan ä¸Šæ·»åŠ æ ‡ç­¾é”®å€¼å¯¹ã€‚</li><li><a href=""><code>TraceContext.traceId#traceId</code></a> æ–¹æ³•ï¼Œè·å¾—å…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ã€‚</li></ul><p>3ã€æ‰§è¡Œåï¼Œæˆ‘ä»¬çœ‹æ¥çœ‹çœ‹ SkyWalking WEBUI çš„å±•ç¤ºã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/03.png" alt=""></p><h1 id="3-å®ç°ä»£ç "><a href="#3-å®ç°ä»£ç " class="headerlink" title="3. å®ç°ä»£ç "></a>3. å®ç°ä»£ç </h1><blockquote><p>å‹æƒ…æç¤ºï¼šæœ¬å°èŠ‚éœ€è¦èƒ–å‹é˜…è¯»è¿‡ <a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ’ä»¶ä½“ç³»ã€‹</a>  ã€‚</p></blockquote><h2 id="3-1-TraceAnnotationActivation"><a href="#3-1-TraceAnnotationActivation" class="headerlink" title="3.1 TraceAnnotationActivation"></a>3.1 TraceAnnotationActivation</h2><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationActivation.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.trace.TraceAnnotationActivation</code></a> ï¼Œå®ç° ClassInstanceMethodsEnhancePluginDefine æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†æ–¹æ³•åˆ‡é¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/04.png" alt=""></p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.trace.TraceAnnotationMethodInterceptor</code></a> ï¼Œå®ç° InstanceMethodsAroundInterceptor æ¥å£ï¼ŒTraceAnnotationActivation çš„æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeMethod(...)</code></a> æ–¹æ³•ï¼Œåˆ›å»º LocalSpan å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 42 è‡³ 46 è¡Œï¼šè·å¾—æ“ä½œåã€‚è‹¥ <a href="https://github.com/apache/incubator-skywalking/blob/af2c1b979fe025603dc65d7e2a2dbdea8005ede8/apm-application-toolkit/apm-toolkit-trace/src/main/java/org/apache/skywalking/apm/toolkit/trace/Trace.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>@Trace#operationName()</code></a> éç©ºï¼Œä½œä¸ºæ“ä½œåã€‚å¦åˆ™ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>#generateOperationName(Method)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨æ–¹æ³•ç­¾åã€‚</li><li>ç¬¬ 49 è¡Œï¼šè°ƒç”¨ <code>ContextManager#createLocalSpan(operationName)</code> æ–¹æ³•ï¼Œåˆ›å»º LocalSpan å¯¹è±¡ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterMethod(...)</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>ContextManager#stopSpan()</code> æ–¹æ³•ï¼Œå®Œæˆ LocalSpan å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#handleMethodException(...)</code></a> æ–¹æ³•ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ã€‚</li></ul><h2 id="3-2-ActiveSpanTagActivation"><a href="#3-2-ActiveSpanTagActivation" class="headerlink" title="3.2 ActiveSpanTagActivation"></a>3.2 ActiveSpanTagActivation</h2><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/ActiveSpanTagActivation.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.trace.ActiveSpanTagActivation</code></a> ï¼Œå®ç° ClassStaticMethodsEnhancePluginDefine æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†æ–¹æ³•åˆ‡é¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/05.png" alt=""></p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceAnnotationMethodInterceptor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.trace.TraceAnnotationMethodInterceptor</code></a> ï¼Œå®ç° StaticMethodsAroundInterceptor æ¥å£ï¼ŒActiveSpanTag çš„æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/ActiveSpanTagInterceptor.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeMethod(...)</code></a> æ–¹æ³•ï¼Œæ·»åŠ  Span çš„<strong>æ ‡ç­¾é”®å€¼å¯¹</strong>ã€‚<strong>æ³¨æ„</strong>ï¼Œå¯ä»¥ä¸ä¾èµ– <code>@Trace</code> æ³¨è§£ã€‚</li></ul><h2 id="3-3-TraceContextActivation"><a href="#3-3-TraceContextActivation" class="headerlink" title="3.3 TraceContextActivation"></a>3.3 TraceContextActivation</h2><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceContextActivation.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.trace.TraceContextActivation</code></a> ï¼Œå®ç° ClassStaticMethodsEnhancePluginDefine æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†æ–¹æ³•åˆ‡é¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/06.png" alt=""></p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceContextInterceptor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.trace.TraceAnnotationMethodInterceptor</code></a> ï¼Œå®ç° StaticMethodsAroundInterceptor æ¥å£ï¼ŒTraceContextActivation çš„æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-trace-activation/src/main/java/org/skywalking/apm/toolkit/activation/trace/TraceContextInterceptor.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterMethod(...)</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>ContextManager#getGlobalTraceId()</code> æ–¹æ³•ï¼Œä½¿ç”¨å…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ï¼Œè€Œä¸æ˜¯åŸæœ‰ç»“æœã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç®€å•ä¸€æ–‡ä¸€ç¯‡ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_10/07.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/&quot;&gt;http://www.iocoder.cn/SkyWalking/@trace-for-any-methods/&lt;/a&gt; 
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” traceId é›†æˆåˆ°æ—¥å¿—ç»„ä»¶</title>
    <link href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/"/>
    <id>http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/</id>
    <published>2020-11-09T16:00:00.000Z</published>
    <updated>2018-01-09T07:45:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">2. ä½¿ç”¨ä¾‹å­</a></li><li><a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">3. å®ç°ä»£ç </a><ul><li><a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">3.1 TraceIdPatternLogbackLayout</a></li><li><a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">3.2 LogbackPatternConverterActivation</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>traceId é›†æˆåˆ°æ—¥å¿—ç»„ä»¶</strong>ï¼Œä¾‹å¦‚ log4j ã€log4j2 ã€logback ç­‰ç­‰ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹<strong>é›†æˆ</strong>çš„ä½¿ç”¨ä¾‹å­ï¼Œå†çœ‹çœ‹<strong>é›†æˆ</strong>çš„å®ç°ä»£ç ã€‚æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š</p><ul><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_15/01.png" alt=""></li><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_15/02.png" alt=""></li></ul><p>æœ¬æ–‡ä»¥ <strong>logback 1.x</strong> ä¸ºä¾‹å­ã€‚</p><h1 id="2-ä½¿ç”¨ä¾‹å­"><a href="#2-ä½¿ç”¨ä¾‹å­" class="headerlink" title="2. ä½¿ç”¨ä¾‹å­"></a>2. ä½¿ç”¨ä¾‹å­</h1><p>1ã€<strong>æ— éœ€</strong>å¼•å…¥ç›¸åº”çš„å·¥å…·åŒ…ï¼Œåªéœ€å¯åŠ¨å‚æ•°å¸¦ä¸Š <code>-javaagent:/Users/yunai/Java/skywalking/packages/skywalking-agent/skywalking-agent.jar</code> ã€‚</p><p>2ã€åœ¨ <code>logback.xml</code> é…ç½® <code>%tid</code> å ä½ç¬¦ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_15/03.png" alt=""></p><p>3ã€ä½¿ç”¨ <code>logger.info(...)</code> ï¼Œä¼šæ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_15/04.png" alt=""></p><p><strong>æ³¨æ„</strong>ï¼ŒtraceId æ‰“å°åˆ°æ¯æ¡æ—¥å¿—é‡Œï¼Œæœ€ç»ˆéœ€è¦ç»è¿‡ä¾‹å¦‚ ELK ï¼Œæ”¶é›†åˆ°æ—¥å¿—ä¸­å¿ƒã€‚</p><h1 id="3-å®ç°ä»£ç "><a href="#3-å®ç°ä»£ç " class="headerlink" title="3. å®ç°ä»£ç "></a>3. å®ç°ä»£ç </h1><h2 id="3-1-TraceIdPatternLogbackLayout"><a href="#3-1-TraceIdPatternLogbackLayout" class="headerlink" title="3.1 TraceIdPatternLogbackLayout"></a>3.1 TraceIdPatternLogbackLayout</h2><p><a href=""><code>org.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout</code></a> ï¼Œå®ç° <code>ch.qos.logback.classic.PatternLayout</code> ç±»ï¼Œå®ç°æ”¯æŒ <code>%tid</code> çš„å ä½ç¬¦ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 33 è¡Œï¼šæ·»åŠ  <code>tid</code> çš„è½¬æ¢å™¨ä¸º <a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-application-toolkit/apm-toolkit-logback-1.x/src/main/java/org/skywalking/apm/toolkit/log/logback/v1/x/LogbackPatternConverter.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.log.logback.v1.x.LogbackPatternConverter</code></a> ç±»ã€‚</li></ul><h2 id="3-2-LogbackPatternConverterActivation"><a href="#3-2-LogbackPatternConverterActivation" class="headerlink" title="3.2 LogbackPatternConverterActivation"></a>3.2 LogbackPatternConverterActivation</h2><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-logback-1.x-activation/src/main/java/org/skywalking/apm/toolkit/activation/log/logback/v1/x/LogbackPatternConverterActivation.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.log.logback.v1.x.LogbackPatternConverterActivation</code></a> ï¼Œå®ç° ClassInstanceMethodsEnhancePluginDefine æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†æ–¹æ³•åˆ‡é¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_15/05.png" alt=""></p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-logback-1.x-activation/src/main/java/org/skywalking/apm/toolkit/activation/log/logback/v1/x/PrintTraceIdInterceptor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.activation.log.logback.v1.x.PrintTraceIdInterceptor</code></a> ï¼Œå®ç° InstanceMethodsAroundInterceptor æ¥å£ï¼ŒLogbackPatternConverterActivation çš„æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5106601937af942dabcad917b90d8c92886a2e4d/apm-sniffer/apm-toolkit-activation/apm-toolkit-logback-1.x-activation/src/main/java/org/skywalking/apm/toolkit/activation/log/logback/v1/x/PrintTraceIdInterceptor.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterMethod(...)</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>ContextManager#getGlobalTraceId()</code> æ–¹æ³•ï¼Œä½¿ç”¨å…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ï¼Œè€Œä¸æ˜¯åŸæœ‰ç»“æœã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç®€å•ä¸€æ–‡ä¸€ç¯‡ Again ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_15/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/trace-id-integrate-into-logs/&quot;&gt;http://www.iocoder.cn/SkyWalking/trace-id-integrate-int
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆå››ï¼‰ä¹‹æ“ä½œè§†è§’</title>
    <link href="http://www.iocoder.cn/SkyWalking/ui-4-operation/"/>
    <id>http://www.iocoder.cn/SkyWalking/ui-4-operation/</id>
    <published>2020-11-04T16:00:00.000Z</published>
    <updated>2018-01-08T23:39:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">http://www.iocoder.cn/SkyWalking/ui-4-operation/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">2. AllInstanceLastTimeGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">3. ApplicationsGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">4. EntryServiceGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">5. ServiceTreeGetByIdHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-4-operation/">6. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>è¿ç»´ç•Œé¢çš„ç¬¬å››éƒ¨åˆ†ï¼Œæ“ä½œè§†è§’</strong>ã€‚</p><blockquote><p>SkyWalking WEBUI ï¼š<a href="https://github.com/apache/incubator-skywalking-ui" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubator-skywalking-ui</a></p></blockquote><p>åœ¨æˆ‘ä»¬æ‰“å¼€ SkyWalking WEBUI çš„ <code>Service Tree</code> ( <code>service/serviceTree.html</code> ) é¡µæ—¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_05/01.png" alt=""></p><ul><li>ä»¥æ“ä½œä¸ºç»´åº¦è¿›è¡Œå±•ç¤ºã€‚</li><li>é»„è‰²éƒ¨åˆ†ï¼Œæ—¶é—´è¿›åº¦æ¡ï¼Œè°ƒç”¨ <a href="#">ã€Œ2. AllInstanceLastTimeGetHandlerã€</a> æ¥å£ï¼Œè·å¾—åº”ç”¨å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ã€‚å¤§å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿›å…¥è¯¥ç•Œé¢ï¼Œçœ‹çš„æ˜¯ä»æœ€åå¿ƒè·³æ—¶é—´å¼€å§‹çš„æ“ä½œæƒ…å†µã€‚</li><li>çº¢è‰²éƒ¨åˆ†ï¼Œåº”ç”¨ç­›é€‰å™¨ï¼Œè°ƒç”¨ <a href="#">ã€Œ3. ApplicationsGetHandlerã€</a> æ¥å£ï¼Œè·å¾—åº”ç”¨åˆ—è¡¨ã€‚</li><li>ç´«è‰²éƒ¨åˆ†ï¼Œå…¥å£æ“ä½œ( EntryService )åˆ†é¡µåˆ—è¡¨ï¼Œè°ƒç”¨ <a href="#">ã€Œ4. EntryServiceGetHandlerã€</a> æ¥å£ï¼Œè·å¾—æ•°æ®ã€‚</li><li>è“è‰²éƒ¨åˆ†ï¼Œã€ç‚¹å‡»å•ä¸ªæ“ä½œã€‘ï¼Œè·å¾—æŒ‡å®šæ“ä½œçš„å…³è”æ“ä½œè°ƒç”¨ç»Ÿè®¡<strong>æ ‘åˆ—è¡¨</strong>ï¼Œè°ƒç”¨ <a href="#">ã€Œ5. ServiceTreeGetByIdHandlerã€</a> æ¥å£ï¼Œè·å¾—æ•°æ®ã€‚</li></ul><blockquote><p>åŸºæƒ…æç¤ºï¼šè¿ç»´ç•Œé¢ç›¸å…³ HTTP æ¥å£ï¼Œé€»è¾‘ç®€å•æ˜“æ‡‚ï¼Œç¬”è€…å†™çš„ä¼šæ¯”è¾ƒç®€ç•¥ä¸€äº›ã€‚ </p></blockquote><h1 id="2-AllInstanceLastTimeGetHandler"><a href="#2-AllInstanceLastTimeGetHandler" class="headerlink" title="2. AllInstanceLastTimeGetHandler"></a>2. AllInstanceLastTimeGetHandler</h1><p>åŒ <a href="http://www.iocoder.cn/SkyWalking/ui-1-application/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆä¸€ï¼‰ä¹‹åº”ç”¨è§†è§’ã€‹ã€Œ2. AllInstanceLastTimeGetHandlerã€</a> ç›¸åŒã€‚</p><h1 id="3-ApplicationsGetHandler"><a href="#3-ApplicationsGetHandler" class="headerlink" title="3. ApplicationsGetHandler"></a>3. ApplicationsGetHandler</h1><p>åŒ <a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆäºŒï¼‰ä¹‹åº”ç”¨å®ä¾‹è§†è§’ã€‹ã€Œ3. ApplicationsGetHandlerã€</a> ç›¸åŒã€‚</p><h1 id="4-EntryServiceGetHandler"><a href="#4-EntryServiceGetHandler" class="headerlink" title="4. EntryServiceGetHandler"></a>4. EntryServiceGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/3b31539e2e77baf00fafbc60ac9c30802e6c922a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/servicetree/EntryServiceGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.servicetree.EntryServiceGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—å…¥å£æ“ä½œ( EntryService )åˆ†é¡µåˆ—è¡¨çš„é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/3b31539e2e77baf00fafbc60ac9c30802e6c922a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/servicetree/EntryServiceGetHandler.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/service/entry&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_05/02.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/3b31539e2e77baf00fafbc60ac9c30802e6c922a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/servicetree/EntryServiceGetHandler.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 66 è‡³ 71 è¡Œï¼šè§£æ <code>applicationId</code> å‚æ•°ã€‚</li><li>ç¬¬ 73 è‡³ 85 è¡Œï¼šè§£æ <code>startTime</code> å’Œ <code>endTime</code> å‚æ•°ã€‚</li><li>ç¬¬ 88 è‡³ 99 è¡Œï¼šè§£æ <code>from</code> å’Œ <code>size</code> åˆ†é¡µå‚æ•°ã€‚ </li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3b31539e2e77baf00fafbc60ac9c30802e6c922a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/ServiceTreeService.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>ServiceTreeService#loadEntryService(...)</code></a> æ–¹æ³•ï¼Œè·å¾—å…¥å£æ“ä½œ( EntryService )åˆ†é¡µåˆ—è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3b31539e2e77baf00fafbc60ac9c30802e6c922a/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceEntryEsUIDAO.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>ServiceEntryEsUIDAO#load(...)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢ ServiceEntry åˆ†é¡µ JSON æ•°ç»„ã€‚</li><li>ç¬¬ 63 è‡³ 69 è¡Œï¼šè®¾ç½®åº”ç”¨ç¼–ç ã€‚</li></ul></li></ul></li></ul><h1 id="5-ServiceTreeGetByIdHandler"><a href="#5-ServiceTreeGetByIdHandler" class="headerlink" title="5. ServiceTreeGetByIdHandler"></a>5. ServiceTreeGetByIdHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/7e453f0e8237685b7b46ddd390afce3b76b45123/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/servicetree/ServiceTreeGetByIdHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.servicetree.ServiceTreeGetByIdHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—æŒ‡å®šæ“ä½œçš„å…³è”æ“ä½œè°ƒç”¨ç»Ÿè®¡æ ‘åˆ—è¡¨çš„é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/7e453f0e8237685b7b46ddd390afce3b76b45123/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/servicetree/ServiceTreeGetByIdHandler.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/service/tree/entryServiceId&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_05/03.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancehealth/InstanceHealthGetHandler.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š <ul><li>ç¬¬ 61 è‡³ 66 è¡Œï¼šè§£æ <code>entryServiceId</code> å‚æ•°ã€‚ </li><li>ç¬¬ 60 è‡³ 74 è¡Œï¼šè§£æ <code>startTime</code> å’Œ <code>endTime</code> å‚æ•°ã€‚</li><li>ç¬¬ 94 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/7e453f0e8237685b7b46ddd390afce3b76b45123/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/ServiceTreeService.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>ServiceTreeService#loadServiceTree(entryServiceId, startTime, endTime)</code></a> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šæ“ä½œçš„å…³è”æ“ä½œè°ƒç”¨ç»Ÿè®¡æ ‘åˆ—è¡¨ï¼Œæ¶‰åŠ <strong>ServiceReference</strong> æ•°æ®è¡¨ã€‚ä»£ç æ¯”è¾ƒç®€å•æ˜“æ‡‚( ç¬”è€…å¤ªæ‡’äº† )ï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_05/04.png" alt=""></li></ul></li></ul><h1 id="6-å½©è›‹"><a href="#6-å½©è›‹" class="headerlink" title="6. å½©è›‹"></a>6. å½©è›‹</h1><p>æ°´æ›´ç¬¬å››å‘ï¼</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/ui-4-operation/&quot;&gt;http://www.iocoder.cn/SkyWalking/ui-4-operation/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œ
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆä¸‰ï¼‰ä¹‹é“¾è·¯è¿½è¸ªè§†è§’</title>
    <link href="http://www.iocoder.cn/SkyWalking/ui-3-trace/"/>
    <id>http://www.iocoder.cn/SkyWalking/ui-3-trace/</id>
    <published>2020-10-31T16:00:00.000Z</published>
    <updated>2018-01-08T13:56:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">http://www.iocoder.cn/SkyWalking/ui-3-trace/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">2. ApplicationsGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">3. SegmentTopGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">4. TraceStackGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">5. SpanGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-3-trace/">6. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>è¿ç»´ç•Œé¢çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼Œé“¾è·¯è¿½è¸ªè§†è§’</strong>ã€‚</p><blockquote><p>SkyWalking WEBUI ï¼š<a href="https://github.com/apache/incubator-skywalking-ui" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubator-skywalking-ui</a></p></blockquote><p>åœ¨æˆ‘ä»¬æ‰“å¼€ SkyWalking WEBUI çš„ <code>Trace Stack</code> ( <code>trace/trace.html</code> ) é¡µæ—¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_11_01/01.png" alt=""></p><ul><li>ä»¥é“¾è·¯è¿½è¸ªä¸ºç»´åº¦è¿›è¡Œå±•ç¤ºã€‚</li><li>çº¢è‰²éƒ¨åˆ†ï¼Œåº”ç”¨ç­›é€‰å™¨ï¼Œè°ƒç”¨ <a href="#">ã€Œ2. ApplicationsGetHandlerã€</a> æ¥å£ï¼Œè·å¾—åº”ç”¨åˆ—è¡¨ã€‚</li><li>ç´«è‰²éƒ¨åˆ†ï¼ŒTraceSegment åˆ†é¡µåˆ—è¡¨ï¼Œè°ƒç”¨ <a href="#">ã€Œ3. SegmentTopGetHandlerã€</a> æ¥å£ï¼Œè·å¾—æ•°æ®ã€‚</li><li>è“è‰²éƒ¨åˆ†ï¼Œã€ç‚¹å‡»å•æ¡ TraceSegmentã€‘ï¼Œ<strong>ä¸€æ¬¡å®Œæ•´</strong>çš„åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªè®°å½•è¯¦æƒ…ï¼Œè°ƒç”¨ <a href="#">ã€Œ5. TraceStackGetHandlerã€</a> æ¥å£ï¼Œè·å¾—æ•°æ®ã€‚</li><li>é»„è‰²éƒ¨åˆ†ï¼Œã€ç‚¹å‡»å•ä¸ª Spanã€‘ï¼Œå•æ¡ Span è®°å½•è¯¦æƒ…ï¼Œè°ƒç”¨ <a href="#">ã€Œ5. SpanGetHandlerã€</a> æ¥å£ï¼Œè·å¾—æ•°æ®ã€‚</li></ul><blockquote><p>åŸºæƒ…æç¤ºï¼šè¿ç»´ç•Œé¢ç›¸å…³ HTTP æ¥å£ï¼Œé€»è¾‘ç®€å•æ˜“æ‡‚ï¼Œç¬”è€…å†™çš„ä¼šæ¯”è¾ƒç®€ç•¥ä¸€äº›ã€‚ </p></blockquote><h1 id="2-ApplicationsGetHandler"><a href="#2-ApplicationsGetHandler" class="headerlink" title="2. ApplicationsGetHandler"></a>2. ApplicationsGetHandler</h1><p>åŒ <a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆäºŒï¼‰ä¹‹åº”ç”¨å®ä¾‹è§†è§’ã€‹ã€Œ3. ApplicationsGetHandlerã€</a> ç›¸åŒã€‚</p><h1 id="3-SegmentTopGetHandler"><a href="#3-SegmentTopGetHandler" class="headerlink" title="3. SegmentTopGetHandler"></a>3. SegmentTopGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/SegmentTopGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.SegmentTopGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾— TraceSegment åˆ†é¡µåˆ—è¡¨çš„é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/SegmentTopGetHandler.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/segment/top&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_01/03.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/SegmentTopGetHandler.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 62 è‡³ 73 è¡Œï¼šè§£æ <code>startTime</code> å’Œ <code>endTime</code> å‚æ•°ã€‚</li><li>ç¬¬ 75 è‡³ 87 è¡Œï¼šè§£æ <code>from</code> å’Œ <code>limit</code> <strong>åˆ†é¡µ</strong>å‚æ•°ã€‚</li><li>ç¬¬ 90 è‡³ 97 è¡Œï¼šè§£æ <code>minCost</code> å’Œ <code>maxCost</code> å‚æ•°ã€‚</li><li>ç¬¬ 100 è‡³ 103 è¡Œï¼šè§£æ <code>globalTraceId</code> å‚æ•°ã€‚</li><li>ç¬¬ 106 è‡³ 109 è¡Œï¼šè§£æ <code>operationName</code> å‚æ•°ã€‚</li><li>ç¬¬ 112 è‡³ 117 è¡Œï¼šè§£æ <code>applicationId</code> å‚æ•°ã€‚</li><li>ç¬¬ 120 è‡³ 132 è¡Œï¼šè§£æ <code>error</code> å‚æ•°ã€‚</li><li>ç¬¬ 135 è‡³ 141 è¡Œï¼šè§£æ <code>sort</code> æ’åº<strong>é”®</strong>å‚æ•°ï¼Œå€’åºã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/SegmentTopService.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentTopService#load(...)</code></a> æ–¹æ³•ï¼Œï¼Œè·å¾— TraceSegment åˆ†é¡µåˆ—è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 59 è‡³ 62 è¡Œï¼šè‹¥å­˜åœ¨ <code>globalTraceId</code> å‚æ•°ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GlobalTraceEsUIDAO.java#L65" rel="external nofollow noopener noreferrer" target="_blank"><code>GlobalTraceEsUIDAO#getSegmentIds(globalTraceId)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢å¯¹åº”çš„ TraceSegment ç¼–å·æ•°ç»„ã€‚<strong>ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆæŸ¥è¯¢å‘¢</strong>ï¼Ÿåœ¨ä¸‹é¢ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œå®é™…æŸ¥è¯¢çš„æ˜¯ SegmentCost è¡¨ï¼Œè¯¥è¡¨ä¸å­˜åœ¨ <code>global_trace_id</code> ï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢åˆ° <code>segment_id</code> æ•°ç»„ï¼Œä½œä¸ºæŸ¥è¯¢æ¡ä»¶ã€‚</li><li>ç¬¬ 65 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentCostEsUIDAO.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentCostEsUIDAO#loadTop(...)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢ <strong>SegmentCost</strong> æ•°ç»„ã€‚</li><li>ç¬¬ 68 è‡³ 77 è¡Œï¼šå¾ªç¯ <strong>SegmentCost</strong> æ•°ç»„ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/826af725e7477b5d8d49a479a5cbbdee021c8306/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GlobalTraceEsUIDAO.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>GlobalTraceEsUIDAO#getGlobalTraceId(segmentId)</code></a> æ–¹æ³•ï¼Œè·å¾—æ¯ä¸ª SegmentCost å¯¹åº”çš„ <code>global_trace_id</code> å±æ€§ï¼Œå¹¶è®¾ç½®è¿”å›ã€‚</li></ul></li></ul></li></ul><h1 id="4-TraceStackGetHandler"><a href="#4-TraceStackGetHandler" class="headerlink" title="4. TraceStackGetHandler"></a>4. TraceStackGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/e26853f280a23a9eadb8267963b75727a65ea31a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/TraceStackGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.TraceStackGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å–ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªè®°å½•è¯¦æƒ…çš„é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/e26853f280a23a9eadb8267963b75727a65ea31a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/TraceStackGetHandler.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/traceStack/globalTraceId&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_01/04.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/e26853f280a23a9eadb8267963b75727a65ea31a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/TraceStackGetHandler.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/e26853f280a23a9eadb8267963b75727a65ea31a/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/TraceStackService.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStackService#load(globalTraceId)</code></a> æ–¹æ³•ï¼ŒåŸº <strong>GlobalTrace</strong> å’Œ <strong>Segment</strong> è¡¨ï¼Œè·å–ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªè®°å½•è¯¦æƒ…çš„é€»è¾‘å¤„ç†å™¨ã€‚é€»è¾‘è¾ƒä¸ºç¹çï¼Œç¬”è€…å·²ç»æ·»åŠ æ³¨é‡Šï¼Œèƒ–å‹è°ƒè¯•ä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“æ˜ç™½æ»´ã€‚<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_01/05.png" alt=""></li></ul></li></ul><h1 id="5-SpanGetHandler"><a href="#5-SpanGetHandler" class="headerlink" title="5. SpanGetHandler"></a>5. SpanGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/c3f55e55593158e065b9589855ca90e819558765/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/SpanGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.SpanGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾— TraceSegment å•ä¸ª Span è¯¦ç»†çš„é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c3f55e55593158e065b9589855ca90e819558765/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/SpanGetHandler.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/span/spanId&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_11_01/02.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/c3f55e55593158e065b9589855ca90e819558765/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/SpanGetHandler.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 52 è¡Œï¼šè§£æ <code>segmentId</code> å‚æ•°ã€‚</li><li>ç¬¬ 55 è‡³ 62 è¡Œï¼šè§£æ <code>spanId</code> å‚æ•°ã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c3f55e55593158e065b9589855ca90e819558765/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/SpanService.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>SpanService#load(segmentId, spanId)</code></a> æ–¹æ³•ï¼Œè·å¾— TraceSegment å•ä¸ª Span è¯¦ç»†ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c3f55e55593158e065b9589855ca90e819558765/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentEsUIDAO.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentEsUIDAO#load(segmentId)</code></a> æ–¹æ³•ï¼Œè·å¾— TraceSegment ã€‚</li><li>ç¬¬ 58 è‡³ 139 è¡Œï¼šå¾ªç¯è·å¾—çš„ TraceSegment çš„ Span æ•°ç»„ï¼Œæ‰¾åˆ°å¯¹åº”çš„ Span è®°å½•ï¼Œè®¾ç½®åè¿”å›ã€‚</li></ul></li></ul></li></ul><h1 id="6-å½©è›‹"><a href="#6-å½©è›‹" class="headerlink" title="6. å½©è›‹"></a>6. å½©è›‹</h1><p>æ°´æ›´ç¬¬ä¸‰å‘ï¼</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/ui-3-trace/&quot;&gt;http://www.iocoder.cn/SkyWalking/ui-3-trace/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;

      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆäºŒï¼‰ä¹‹åº”ç”¨å®ä¾‹è§†è§’</title>
    <link href="http://www.iocoder.cn/SkyWalking/ui-2-instance/"/>
    <id>http://www.iocoder.cn/SkyWalking/ui-2-instance/</id>
    <published>2020-10-27T16:00:00.000Z</published>
    <updated>2018-01-07T14:48:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">http://www.iocoder.cn/SkyWalking/ui-2-instance/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">2. AllInstanceLastTimeGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">3. ApplicationsGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">4. InstanceHealthGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">5. InstanceMetricGetRangeTimeBucketHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-2-instance/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>è¿ç»´ç•Œé¢çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œåº”ç”¨å®ä¾‹è§†è§’</strong>ã€‚</p><blockquote><p>SkyWalking WEBUI ï¼š<a href="https://github.com/apache/incubator-skywalking-ui" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubator-skywalking-ui</a></p></blockquote><p>åœ¨æˆ‘ä»¬æ‰“å¼€ SkyWalking WEBUI çš„ <code>Instance Override</code> ( <code>health/health.html</code> ) é¡µæ—¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_28/01.png" alt=""></p><ul><li>ä»¥åº”ç”¨å®ä¾‹ä¸ºç»´åº¦è¿›è¡Œå±•ç¤ºã€‚</li><li>çº¢è‰²éƒ¨åˆ†ï¼Œæ—¶é—´è¿›åº¦æ¡ï¼Œè°ƒç”¨ <a href="#">ã€Œ2. AllInstanceLastTimeGetHandlerã€</a> æ¥å£ï¼Œè·å¾—åº”ç”¨å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ã€‚å¤§å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿›å…¥è¯¥ç•Œé¢ï¼Œçœ‹çš„æ˜¯ä»æœ€åå¿ƒè·³æ—¶é—´å¼€å§‹çš„åº”ç”¨è°ƒç”¨æƒ…å†µã€‚</li><li>ç»¿è‰²éƒ¨åˆ†ï¼Œåº”ç”¨åˆ—è¡¨ï¼Œåˆå§‹åŒ–ä»¥ [ å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´å‰ä¸€å°æ—¶ , å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ ] è°ƒç”¨ <a href="#">ã€Œ3. ApplicationsGetHandlerã€</a> æ¥å£ï¼Œè·å¾—<strong>èŒƒå›´</strong>æ•°æ®ï¼Œè€Œåæ¯ 4 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæ•°æ®èŒƒå›´å‘å‰èµ° 4 ç§’( æ—¶é—´è¿›åº¦æ¡æ˜¯èµ° 2 æ¬¡ 2 ç§’ )ï¼Œä¸º [ å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´å‰ä¸€å°æ—¶ + å››ç§’ , å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ + å››ç§’ ]ã€‚ </li><li>çº¢è‰²éƒ¨åˆ†ï¼Œã€ç‚¹å‡»ä»»æ„åº”ç”¨ã€‘ï¼Œåº”ç”¨å®ä¾‹åˆ—è¡¨ï¼Œè°ƒç”¨ <a href="#">ã€Œ4. InstanceHealthGetHandlerã€</a> æ¥å£ï¼Œè·å¾—<strong>å½“å‰æ—¶é—´</strong>æ•°æ®ï¼Œè€Œåæ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡ã€‚</li><li>é€šè¿‡è¿›åº¦æ¡çš„ã€<strong>æ’­æ”¾/æš‚åœæŒ‰é’®</strong>ã€‘å¯ä»¥åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œåˆ‡æ¢æ—¶é—´èŒƒå›´ï¼ŒæŸ¥çœ‹æ—¶é—´èŒƒå›´ä¸ºä¸€å°æ—¶å†…çš„åº”ç”¨è°ƒç”¨æ‹“æ‰‘å›¾ã€‚æ³¨æ„ï¼Œä¸€å®šè¦åˆ‡æ¢åˆ°ã€æš‚æ—¶æ¨¡å¼ã€‘æ‰å¯è°ƒæ•´æ—¶é—´èŒƒå›´ï¼Œåœ¨ã€æ’­æ”¾æ¨¡å¼ã€‘ä¸‹ï¼Œæ¯æ¬¡<strong>è‡ªåŠ¨</strong>è¯·æ±‚éƒ½ä¼šé‡è®¾æ—¶é—´èŒƒå›´ã€‚</li></ul><p>åœ¨æˆ‘ä»¬ã€ç‚¹å‡»ä»»æ„åº”ç”¨å®ä¾‹ã€‘ï¼Œæ‰“å¼€ SkyWalking WEBUI çš„ <code>Instance</code> ( <code>instance/instance.html</code> ) é¡µæ—¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_28/02.png" alt=""></p><ul><li>ä»¥<strong>å•ä¸ª</strong>åº”ç”¨å®ä¾‹ä¸ºç»´åº¦è¿›è¡Œå±•ç¤ºã€‚</li><li>æ©˜è‰²éƒ¨åˆ†ï¼Œåº”ç”¨å®ä¾‹æŒ‡æ ‡ï¼Œåˆå§‹åŒ–ä»¥ [ æ‰“å¼€é¡µé¢æ—¶é—´å‰äº”åˆ†é’Ÿ , æ‰“å¼€é¡µé¢æ—¶é—´ ] è°ƒç”¨ <a href="#">ã€Œ5. InstanceMetricGetRangeTimeBucketHandlerã€</a> æ¥å£ï¼Œè·å¾—<strong>èŒƒå›´</strong>æ•°æ®ã€‚</li><li>çº¢è‰²éƒ¨åˆ†ï¼Œã€ç‚¹å‡» auto å¼€å…³ã€‘ï¼Œæ¯ 1 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæ•°æ®èŒƒå›´å‘å‰èµ° 1 ç§’ï¼Œä¸º [ æ‰“å¼€é¡µé¢æ—¶é—´ + ä¸€ç§’ , æ‰“å¼€é¡µé¢æ—¶é—´ + ä¸€ç§’ ]ï¼Œè·å¾—<strong>æ¯ç§’å¢é‡</strong>æ•°æ®ã€‚</li></ul><blockquote><p>åŸºæƒ…æç¤ºï¼šè¿ç»´ç•Œé¢ç›¸å…³ HTTP æ¥å£ï¼Œé€»è¾‘ç®€å•æ˜“æ‡‚ï¼Œç¬”è€…å†™çš„ä¼šæ¯”è¾ƒç®€ç•¥ä¸€äº›ã€‚ </p></blockquote><h1 id="2-AllInstanceLastTimeGetHandler"><a href="#2-AllInstanceLastTimeGetHandler" class="headerlink" title="2. AllInstanceLastTimeGetHandler"></a>2. AllInstanceLastTimeGetHandler</h1><p>åŒ <a href="http://www.iocoder.cn/SkyWalking/ui-1-application/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆä¸€ï¼‰ä¹‹åº”ç”¨è§†è§’ã€‹ã€Œ2. AllInstanceLastTimeGetHandlerã€</a> ç›¸åŒã€‚</p><h1 id="3-ApplicationsGetHandler"><a href="#3-ApplicationsGetHandler" class="headerlink" title="3. ApplicationsGetHandler"></a>3. ApplicationsGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/a5db282a68747668356a1bc55e9227bd2b7869a0/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/application/ApplicationsGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.application.ApplicationsGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—åº”ç”¨åˆ—è¡¨é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a5db282a68747668356a1bc55e9227bd2b7869a0/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/application/ApplicationsGetHandler.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;applications&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_28/03.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/time/AllInstanceLastTimeGetHandler.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a5db282a68747668356a1bc55e9227bd2b7869a0/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/ApplicationService.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationService#getApplications(startTime, endTime)</code></a> æ–¹æ³•ï¼Œä»¥åº”ç”¨ç¼–å·ä¸ºèšåˆï¼Œè·å¾—åº”ç”¨å®ä¾‹æ•°é‡æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a5db282a68747668356a1bc55e9227bd2b7869a0/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsUIDAO.java#L112" rel="external nofollow noopener noreferrer" target="_blank"><code>NodeComponentEsUIDAO#load(startTime, endTime)</code></a> æ–¹æ³•ï¼Œä»¥åº”ç”¨ç¼–å·ä¸ºèšåˆï¼Œè·å¾—åº”ç”¨å®ä¾‹æ•°é‡ JSON æ•°ç»„ã€‚</li><li>ç¬¬ 47 è‡³ 52 è¡Œï¼šè®¾ç½®åº”ç”¨ç¼–ç ã€‚</li></ul></li></ul></li></ul><h1 id="4-InstanceHealthGetHandler"><a href="#4-InstanceHealthGetHandler" class="headerlink" title="4. InstanceHealthGetHandler"></a>4. InstanceHealthGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancehealth/InstanceHealthGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.instancehealth.InstanceHealthGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—åº”ç”¨çš„åº”ç”¨å®ä¾‹å¥åº·ç›¸å…³ä¿¡æ¯æ•°ç»„ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancehealth/InstanceHealthGetHandler.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/instance/health/applicationId&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_28/04.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancehealth/InstanceHealthGetHandler.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š <ul><li>ç¬¬ 58 è‡³ 62 è¡Œï¼šè§£æ <code>timeBucket</code> å‚æ•°ï¼Œç§’çº§ã€‚</li><li>ç¬¬ 65 è‡³ 72 è¡Œï¼šè§£æ <code>applicationIds</code> å‚æ•°ï¼Œåº”ç”¨ç¼–å·<strong>æ•°ç»„</strong>ã€‚ </li><li>ç¬¬ 75 è‡³ 79 è¡Œï¼šè¿”å›å­—æ®µè®¾ç½®ã€‚</li><li>ç¬¬ 82 è‡³ 85 è¡Œï¼šå¾ªç¯åº”ç”¨ç¼–å·æ•°ç»„ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/InstanceHealthService.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceHealthService#getInstances(timeBucket, applicationId)</code></a> æ–¹æ³•ï¼Œè·å¾—åº”ç”¨çš„åº”ç”¨å®ä¾‹å¥åº·ç›¸å…³ä¿¡æ¯æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 80 è¡Œï¼šè·å¾—æŒ‡å®šæ—¶é—´å†…çš„ <strong>5 ç§’å†…</strong>çš„æ•°ç»„ï¼Œå€’åºã€‚ä¸ºä»€ä¹ˆï¼Ÿè§ä¸‹æ–‡çš„ InstPerformance çš„æŸ¥è¯¢ã€‚</li><li>ç¬¬ 81 è‡³ 82 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsUIDAO.java#L158" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceEsUIDAO#getInstances(applicationId, timeBucket)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢æŸ¥è¯¢åŠå°æ—¶å†…æœ‰<strong>å¿ƒè·³</strong>çš„ Instance æ•°ç»„ã€‚</li><li>ç¬¬ 90 è¡Œï¼š<strong>å¾ªç¯</strong> Instance æ•°ç»„ï¼Œé€ä¸ªæŸ¥è¯¢åº”ç”¨å®ä¾‹çš„å¥åº·ç›¸å…³ä¿¡æ¯ã€‚</li><li>ç¬¬ 98 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstPerformanceEsUIDAO.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>InstPerformanceEsUIDAO#get(timeBuckets, instanceId)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢åº”ç”¨å®ä¾‹<strong>äº”ç§’å†…</strong>çš„( <code>timeBuckets</code> )çš„ InstPerformance <strong>ç´¯åŠ </strong>æ•°æ®ã€‚<ul><li>ç¬¬ 100 è‡³ 105 è¡Œï¼šåŸºäº InstPerformance æ•°æ®ï¼Œè®¾ç½® <code>tps</code> è¿”å›å­—æ®µã€‚</li><li>ç¬¬ 108 è‡³ 121 è¡Œï¼šåŸºäº InstPerformance æ•°æ®ï¼Œè®¾ç½® <code>avg</code> å’Œ <code>healthLevel</code> è¿”å›æ•°æ®ã€‚</li></ul></li><li>ç¬¬ 124 è‡³ 130 è¡Œï¼šåŸºäº Instance æ•°æ®ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹æ˜¯å¦å­˜æ´»( ä¸¤åˆ†é’Ÿå†…æ˜¯å¦æœ‰å¿ƒè·³ )ã€‚</li><li>ç¬¬ 133 è‡³ 135 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GCMetricEsUIDAO.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>GCMetricEsUIDAO#getGCCount(timeBuckets, instanceId)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢åº”ç”¨å®ä¾‹<strong>äº”ç§’å†…</strong>çš„( <code>timeBuckets</code> )çš„ GCCount <strong>ç´¯åŠ </strong>æ•°æ®ï¼Œè®¾ç½® <code>ygc</code> å’Œ <code>ogc</code> è¿”å›å­—æ®µã€‚</li></ul></li></ul></li></ul><h1 id="5-InstanceMetricGetRangeTimeBucketHandler"><a href="#5-InstanceMetricGetRangeTimeBucketHandler" class="headerlink" title="5. InstanceMetricGetRangeTimeBucketHandler"></a>5. InstanceMetricGetRangeTimeBucketHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/ecee73223defd374e711e7d5f08fa8ae13e6bd97/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancemetric/InstanceMetricGetRangeTimeBucketHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.instancemetric.InstanceMetricGetRangeTimeBucketHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—åº”ç”¨å®ä¾‹æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„ Metric ä¿¡æ¯ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ecee73223defd374e711e7d5f08fa8ae13e6bd97/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancemetric/InstanceMetricGetRangeTimeBucketHandler.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/instance/jvm/instanceId/rangeBucket&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_28/05.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/68b704ef2395067fdb135262089c5c3d316efee7/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/instancehealth/InstanceHealthGetHandler.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š <ul><li>ç¬¬ 60 è‡³ 74 è¡Œï¼šè§£æ <code>startTimeBucket</code> å’Œ <code>endTimeBucket</code> å‚æ•°ï¼Œç§’çº§ã€‚</li><li>ç¬¬ 77 è‡³ 88 è¡Œï¼šè§£æ <code>instanceId</code> å‚æ•°ï¼Œåº”ç”¨å®ä¾‹ç¼–å·ã€‚ </li><li>ç¬¬ 84 è‡³ 92 è¡Œï¼šè§£æ <code>metricTypes</code> æ•°ç»„ã€‚</li><li>ç¬¬ 94 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ecee73223defd374e711e7d5f08fa8ae13e6bd97/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/InstanceJVMService.java#L101" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceJVMService#getInstanceJvmMetrics(instanceId, metricTypes, startTimeBucket, endTimeBucket)</code></a> æ–¹æ³•ï¼Œè·å¾—åº”ç”¨å®ä¾‹æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„ Metric ä¿¡æ¯ï¼Œæ¶‰åŠ GCMetric ã€InstPerformanceMetric ã€MemoryMetric ã€MemoryPoolMetric æ•°æ®è¡¨ã€‚ä»£ç æ¯”è¾ƒç®€å•æ˜“æ‡‚( ç¬”è€…å¤ªæ‡’äº† )ï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_28/06.png" alt=""></li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ°´æ›´ç¬¬äºŒå‘ï¼</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/ui-2-instance/&quot;&gt;http://www.iocoder.cn/SkyWalking/ui-2-instance/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” è¿ç»´ç•Œé¢ï¼ˆä¸€ï¼‰ä¹‹åº”ç”¨è§†è§’</title>
    <link href="http://www.iocoder.cn/SkyWalking/ui-1-application/"/>
    <id>http://www.iocoder.cn/SkyWalking/ui-1-application/</id>
    <published>2020-10-24T16:00:00.000Z</published>
    <updated>2018-01-07T06:58:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/ui-1-application/">http://www.iocoder.cn/SkyWalking/ui-1-application/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/ui-1-application/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-1-application/">2. AllInstanceLastTimeGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-1-application/">3. TraceDagGetHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/ui-1-application/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>è¿ç»´ç•Œé¢çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œåº”ç”¨è§†è§’</strong>ã€‚</p><blockquote><p>SkyWalking WEBUI ï¼š<a href="https://github.com/apache/incubator-skywalking-ui" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubator-skywalking-ui</a></p></blockquote><p>åœ¨æˆ‘ä»¬æ‰“å¼€ SkyWalking WEBUI çš„é¦–é¡µæ—¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/01.png" alt=""></p><ul><li>ä»¥åº”ç”¨ä¸ºç»´åº¦è¿›è¡Œå±•ç¤ºã€‚</li><li>ç´«è‰²éƒ¨åˆ†ï¼Œæ—¶é—´è¿›åº¦æ¡ï¼Œè°ƒç”¨ <a href="#">ã€Œ2. AllInstanceLastTimeGetHandlerã€</a> æ¥å£ï¼Œè·å¾—åº”ç”¨å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ã€‚å¤§å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿›å…¥è¯¥ç•Œé¢ï¼Œçœ‹çš„æ˜¯ä»æœ€åå¿ƒè·³æ—¶é—´å¼€å§‹çš„åº”ç”¨è°ƒç”¨æƒ…å†µã€‚</li><li>çº¢è‰²éƒ¨åˆ†ï¼Œåº”ç”¨è°ƒç”¨æ‹“æ‰‘å›¾ï¼Œåˆå§‹åŒ–ä»¥ [ å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´å‰ä¸€å°æ—¶ , å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ ] è°ƒç”¨ <a href="#">ã€Œ3. TraceDagGetHandlerã€</a> æ¥å£ï¼Œè·å¾—æ•°æ®ï¼Œè€Œåæ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œ30 æ¬¡åˆ·æ–°åï¼Œå³è¿‡äº† 1 åˆ†é’Ÿåï¼Œæ•°æ®èŒƒå›´å‘å‰èµ°ä¸€åˆ†é’Ÿï¼Œä¸º [ å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´å‰ä¸€å°æ—¶ + ä¸€åˆ†é’Ÿ , å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ + ä¸€åˆ†é’Ÿ ]ã€‚ </li><li>é€šè¿‡è¿›åº¦æ¡çš„ã€<strong>æ’­æ”¾/æš‚åœæŒ‰é’®</strong>ã€‘å¯ä»¥åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œåˆ‡æ¢æ—¶é—´èŒƒå›´ï¼ŒæŸ¥çœ‹æ—¶é—´èŒƒå›´ä¸ºä¸€å°æ—¶å†…çš„åº”ç”¨è°ƒç”¨æ‹“æ‰‘å›¾ã€‚æ³¨æ„ï¼Œä¸€å®šè¦åˆ‡æ¢åˆ°ã€æš‚æ—¶æ¨¡å¼ã€‘æ‰å¯è°ƒæ•´æ—¶é—´èŒƒå›´ï¼Œåœ¨ã€æ’­æ”¾æ¨¡å¼ã€‘ä¸‹ï¼Œæ¯æ¬¡<strong>è‡ªåŠ¨</strong>è¯·æ±‚éƒ½ä¼šé‡è®¾æ—¶é—´èŒƒå›´ã€‚</li></ul><blockquote><p>åŸºæƒ…æç¤ºï¼šè¿ç»´ç•Œé¢ç›¸å…³ HTTP æ¥å£ï¼Œé€»è¾‘ç®€å•æ˜“æ‡‚ï¼Œç¬”è€…å†™çš„ä¼šæ¯”è¾ƒç®€ç•¥ä¸€äº›ã€‚</p></blockquote><h1 id="2-AllInstanceLastTimeGetHandler"><a href="#2-AllInstanceLastTimeGetHandler" class="headerlink" title="2. AllInstanceLastTimeGetHandler"></a>2. AllInstanceLastTimeGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/time/AllInstanceLastTimeGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.time.AllInstanceLastTimeGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—åº”ç”¨å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´å¤„ç†å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/time/AllInstanceLastTimeGetHandler.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;/time/allInstance&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/02.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/time/AllInstanceLastTimeGetHandler.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 55 è‡³ 59 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/service/TimeSynchronousService.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>TimeSynchronousService#allInstanceLastTime()</code></a> æ–¹æ³•ï¼Œè·å¾—åº”ç”¨å®ä¾‹æœ€åå¿ƒè·³æ—¶é—´ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/fe20d4fff8e2ebf4ad44c9e7ac455f69146c0b9c/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsUIDAO.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceEsUIDAO#lastHeartBeatTime()</code></a></li></ul></li><li>ç¬¬ 61 è‡³ 65 è¡Œï¼šå‡ 5 ç§’ï¼Œå› ä¸ºåº”ç”¨å¿ƒè·³æ˜¯æœ€é¢‘ç¹çš„ï¼Œé˜²æ­¢å…¶ä»–ä¿¡æ¯è¿˜æ²¡ä¸Šä¼ ã€‚</li><li>ç¬¬ 68 è‡³ 69 è¡Œï¼šè¿”å›æ•°æ®ã€‚ </li></ul></li></ul><h1 id="3-TraceDagGetHandler"><a href="#3-TraceDagGetHandler" class="headerlink" title="3. TraceDagGetHandler"></a>3. TraceDagGetHandler</h1><p><a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/time/AllInstanceLastTimeGetHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.ui.jetty.handler.TraceDagGetHandler</code></a> ï¼Œå®ç° JettyHandler æ¥å£ï¼Œè·å¾—åº”ç”¨æ‹“æ‰‘å›¾æ•°æ®é€»è¾‘å¤„ç†å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/f32d6d88343ec18a3b32127bf9c4152e5dc9d4d1/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/TraceDagGetHandler.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> ï¼Œè·¯å¾„å®šä¹‰ï¼Œ<code>&quot;traceDag&quot;</code> ã€‚</li><li>å“åº”ç¤ºä¾‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/03.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/9f2dab1c61b49610eca0fc2634ee7af918ba7d1f/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/time/AllInstanceLastTimeGetHandler.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/f32d6d88343ec18a3b32127bf9c4152e5dc9d4d1/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/TraceDagGetHandler.java#L73" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceDagService#load(startTime, endTime)</code></a> æ–¹æ³•ï¼Œè·å¾—åº”ç”¨æ‹“æ‰‘å›¾æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 53 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/f32d6d88343ec18a3b32127bf9c4152e5dc9d4d1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeComponentEsUIDAO.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>NodeComponentEsUIDAO#load(startTime, endTime)</code></a> æ–¹æ³•ï¼Œè·å¾— NodeComponent JSON æ•°ç»„ã€‚</li><li>ç¬¬ 56 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/f32d6d88343ec18a3b32127bf9c4152e5dc9d4d1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeMappingEsUIDAO.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>NodeMappingEsUIDAO#load(startTime, endTime)</code></a> æ–¹æ³•ï¼Œè·å¾— NodeMapping JSON æ•°ç»„ã€‚</li><li>ç¬¬ 59 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/f32d6d88343ec18a3b32127bf9c4152e5dc9d4d1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeReferenceEsUIDAO.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>NodeReferenceEsUIDAO#load(startTime, endTime)</code></a> æ–¹æ³•ï¼Œè·å¾— NodeReference JSON æ•°ç»„ã€‚</li><li>ç¬¬ 62 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/f32d6d88343ec18a3b32127bf9c4152e5dc9d4d1/apm-collector/apm-collector-ui/collector-ui-jetty-provider/src/main/java/org/skywalking/apm/collector/ui/jetty/handler/TraceDagGetHandler.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceDagDataBuilder#build(nodeCompArray, nodesMappingArray, resSumArray)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨è·å¾—çš„ NodeComponent ã€NodeMapping ã€NodeReference æ•°æ®ï¼Œæ„å»ºåº”ç”¨æ‹“æ‰‘å›¾ã€‚é€»è¾‘è¾ƒä¸ºç¹çï¼Œç¬”è€…å·²ç»æ·»åŠ æ³¨é‡Šï¼Œèƒ–å‹è°ƒè¯•ä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“æ˜ç™½æ»´ã€‚<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/04.png" alt=""></li></ul></li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ°´æ›´ç¬¬ä¸€å‘ï¼</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_25/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/ui-1-application/&quot;&gt;http://www.iocoder.cn/SkyWalking/ui-1-application/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” JVM æŒ‡æ ‡çš„æ”¶é›†ä¸å­˜å‚¨</title>
    <link href="http://www.iocoder.cn/SkyWalking/jvm-collect/"/>
    <id>http://www.iocoder.cn/SkyWalking/jvm-collect/</id>
    <published>2020-10-19T16:00:00.000Z</published>
    <updated>2018-01-06T13:58:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">http://www.iocoder.cn/SkyWalking/jvm-collect/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2. Agent æ”¶é›† JVM æŒ‡æ ‡</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.1 JVMService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.2 CPU</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.3 Memory</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.4 MemoryPool</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">2.5 GC</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3. Collector å­˜å‚¨ JVM æŒ‡æ ‡</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.1 JVMMetricsServiceHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.2 CPU</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.3 Memory</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.4 MemoryPool</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">3.5 GC</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">4. å¿ƒè·³</a></li><li><a href="http://www.iocoder.cn/SkyWalking/jvm-collect/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking JVM æŒ‡æ ‡çš„æ”¶é›†ä¸å­˜å‚¨</strong>ã€‚å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>Agent æ¯ç§’å®šæ—¶æ”¶é›† JVM æŒ‡æ ‡åˆ°ç¼“å†²é˜Ÿåˆ—ã€‚</li><li>Agent æ¯ç§’å®šæ—¶å°†ç¼“å†²é˜Ÿåˆ—çš„ JVM æŒ‡æ ‡å‘é€åˆ° Collector ã€‚</li><li>Collector æ¥æ”¶åˆ° JVM æŒ‡æ ‡ï¼Œå¼‚æ­¥æ‰¹é‡å­˜å‚¨åˆ°å­˜å‚¨å™¨( ä¾‹å¦‚ï¼ŒES )ã€‚</li></ul><p>ç›®å‰ JVM æŒ‡æ ‡åŒ…æ‹¬<strong>å››ä¸ªç»´åº¦</strong>ï¼š</p><ul><li>CPU</li><li>Memory</li><li>MemoryPool</li><li>GC</li></ul><p>SkyWalking UI ç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/02.png" alt=""></p><h1 id="2-Agent-æ”¶é›†-JVM-æŒ‡æ ‡"><a href="#2-Agent-æ”¶é›†-JVM-æŒ‡æ ‡" class="headerlink" title="2. Agent æ”¶é›† JVM æŒ‡æ ‡"></a>2. Agent æ”¶é›† JVM æŒ‡æ ‡</h1><h2 id="2-1-JVMService"><a href="#2-1-JVMService" class="headerlink" title="2.1 JVMService"></a>2.1 JVMService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.JVMService</code></a> ï¼Œå®ç° BootService ã€Runnable æ¥å£ï¼ŒJVM æŒ‡æ ‡æœåŠ¡ï¼Œè´Ÿè´£å°† JVM æŒ‡æ ‡æ”¶é›†å¹¶å‘é€ç»™ Collector ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>queue</code> å±æ€§ï¼Œæ”¶é›†æŒ‡æ ‡é˜Ÿåˆ—ã€‚</li><li><code>collectMetricFuture</code> å±æ€§ï¼Œæ”¶é›†æŒ‡æ ‡å®šæ—¶ä»»åŠ¡ã€‚</li><li><code>sendMetricFuture</code> å±æ€§ï¼Œå‘é€æŒ‡æ ‡å®šæ—¶ä»»åŠ¡ã€‚</li><li><code>sender</code> å±æ€§ï¼Œå‘é€å™¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeBoot()</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– <code>queue</code> ï¼Œ<code>sender</code> å±æ€§ï¼Œå¹¶å°†è‡ªå·±æ·»åŠ åˆ° GRPCChannelManager ï¼Œä»è€Œç›‘å¬ä¸ Collector çš„è¿æ¥çŠ¶æ€ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>boot</code></a> æ–¹æ³•ï¼Œåˆ›å»ºä¸¤ä¸ªå®šæ—¶ä»»åŠ¡ï¼š</p><ul><li>ç¬¬ 88 è‡³ 90 è¡Œï¼šåˆ›å»ºæ”¶é›†æŒ‡æ ‡å®šæ—¶ä»»åŠ¡ï¼Œ0 ç§’å»¶è¿Ÿï¼Œ1 ç§’é—´éš”ï¼Œè°ƒç”¨ <code>JVMService#run()</code> æ–¹æ³•ã€‚</li><li>ç¬¬ 92 è‡³ 94 è¡Œï¼šåˆ›å»ºå‘é€æŒ‡æ ‡å®šæ—¶ä»»åŠ¡ï¼Œ0 ç§’å»¶è¿Ÿï¼Œ1 ç§’é—´éš”ï¼Œè°ƒç”¨ <code>Sender#run()</code> æ–¹æ³•ã€‚</li></ul><h3 id="2-1-1-å®šæ—¶æ”¶é›†"><a href="#2-1-1-å®šæ—¶æ”¶é›†" class="headerlink" title="2.1.1 å®šæ—¶æ”¶é›†"></a>2.1.1 å®šæ—¶æ”¶é›†</h3><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMService#run()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 110 è‡³ 111 è¡Œï¼šåº”ç”¨å®ä¾‹æ³¨å†Œåï¼Œæ‰æ”¶é›† JVM æŒ‡æ ‡ã€‚</li><li>ç¬¬ 116 è‡³ 122 è¡Œï¼šåˆ›å»º JVMMetric å¯¹è±¡ã€‚<ul><li>ç¬¬ 118 è¡Œï¼šè°ƒç”¨ <code>CPUProvider#getCpuMetric()</code> æ–¹æ³•ï¼Œè·å¾— GC æŒ‡æ ‡ã€‚</li><li>ç¬¬ 119 è¡Œï¼šè°ƒç”¨ <code>MemoryProvider#getMemoryMetricList()</code> æ–¹æ³•ï¼Œè·å¾— Memory æŒ‡æ ‡ã€‚</li><li>ç¬¬ 120 è¡Œï¼šè°ƒç”¨ <code>MemoryPoolProvider#getMemoryPoolMetricList()</code> æ–¹æ³•ï¼Œè·å¾— MemoryPool æŒ‡æ ‡ã€‚</li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <code>GCProvider#getGCList()</code> æ–¹æ³•ï¼Œè·å¾— GC æŒ‡æ ‡ã€‚</li></ul></li><li>ç¬¬ 125 è‡³ 128 è¡Œï¼šæäº¤ JVMMetric å¯¹è±¡åˆ°æ”¶é›†æŒ‡æ ‡é˜Ÿåˆ—ã€‚</li></ul><h3 id="2-1-2-å®šæ—¶å‘é€"><a href="#2-1-2-å®šæ—¶å‘é€" class="headerlink" title="2.1.2 å®šæ—¶å‘é€"></a>2.1.2 å®šæ—¶å‘é€</h3><p><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L135" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMService.Sender</code></a> ï¼Œå®ç° Runnable ã€GRPCChannelListener æ¥å£ï¼ŒJVM æŒ‡æ ‡å‘é€å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>status</code> å±æ€§ï¼Œè¿æ¥çŠ¶æ€ã€‚</li><li><code>stub</code> å±æ€§ï¼Œ<strong>é˜»å¡</strong> Stub ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L171" rel="external nofollow noopener noreferrer" target="_blank"><code>#statusChanged(GRPCChannelStatus)</code></a> æ–¹æ³•ï¼Œå½“è¿æ¥æˆåŠŸæ—¶ï¼Œåˆ›å»º<strong>é˜»å¡</strong> Stub ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/JVMService.java#L147" rel="external nofollow noopener noreferrer" target="_blank"><code>#run()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 148 è‡³ 151 è¡Œï¼šåº”ç”¨å®ä¾‹æ³¨å†Œåï¼Œå¹¶ä¸”è¿æ¥ä¸­ï¼Œæ‰å‘é€ JVM æŒ‡æ ‡ã€‚</li><li>ç¬¬ 153 è‡³ 155 è¡Œï¼šè°ƒç”¨ <code>#drainTo(Collection)</code> æ–¹æ³•ï¼Œä»é˜Ÿåˆ—ç§»é™¤æ‰€æœ‰ JVMMetric åˆ° <code>buffer</code> æ•°ç»„ã€‚</li><li>ç¬¬ 157 è‡³ 162 è¡Œï¼šä½¿ç”¨ Stub ï¼Œ<strong>æ‰¹é‡</strong>å‘é€åˆ° Collector ã€‚</li></ul></li></ul><h2 id="2-2-CPU"><a href="#2-2-CPU" class="headerlink" title="2.2 CPU"></a>2.2 CPU</h2><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.cpu.CPUProvider</code></a> ï¼ŒCPU æä¾›è€…ï¼Œæä¾› <a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUProvider.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCpuMetric()</code></a> æ–¹æ³•ï¼Œé‡‡é›† CPU æŒ‡æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/05.png" alt=""></p><ul><li><code>usagePercent</code> ï¼šJVM è¿›ç¨‹å ç”¨ CPU ç™¾åˆ†æ¯”ã€‚</li><li>ç¬¬ 51 è¡Œï¼šè°ƒç”¨ <code>CPUMetricAccessor#getCPUMetric()</code> æ–¹æ³•ï¼Œè·å¾— CPU æŒ‡æ ‡ã€‚</li></ul><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUProvider.java#L35" rel="external nofollow noopener noreferrer" target="_blank">CPUProvider æ„é€ æ–¹æ³•</a> ä¸­ï¼Œåˆå§‹åŒ– <code>cpuMetricAccessor</code> æ•°é‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 37 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/os/ProcessorUtil.java#L27" rel="external nofollow noopener noreferrer" target="_blank"><code>ProcessorUtil#getNumberOfProcessors()</code></a> æ–¹æ³•ï¼Œè·å¾— CPU æ•°é‡ã€‚</li><li>ç¬¬ 40 è‡³ 42 è¡Œï¼šåˆ›å»º SunCpuAccessor å¯¹è±¡ã€‚</li><li>ç¬¬ 44 è‡³ 46 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè¯´æ˜ä¸æ”¯æŒï¼Œåˆ›å»º NoSupportedCPUAccessor å¯¹è±¡ã€‚</li><li><strong>ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ <code>ClassLoader#loadClass(className)</code> æ–¹æ³•å‘¢</strong>ï¼Ÿå› ä¸º SkyWalking Agent æ˜¯é€šè¿‡ JavaAgent æœºåˆ¶ï¼Œå®é™…æœªå¼•å…¥ï¼Œæ‰€ä»¥é€šè¿‡è¯¥æ–¹å¼åŠ è½½ç±»ã€‚</li></ul><h3 id="2-2-1-CPUMetricAccessor"><a href="#2-2-1-CPUMetricAccessor" class="headerlink" title="2.2.1 CPUMetricAccessor"></a>2.2.1 CPUMetricAccessor</h3><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.cpu.CPUMetricAccessor</code></a> ï¼ŒCPU æŒ‡æ ‡è®¿é—®å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>lastCPUTimeNs</code> å±æ€§ï¼Œè·å¾—è¿›ç¨‹å ç”¨ CPU æ—¶é•¿ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li><li><code>lastSampleTimeNs</code> å±æ€§ï¼Œæœ€åé‡‡æ ·æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li><li><code>cpuCoreNum</code> å±æ€§ï¼ŒCPU æ•°é‡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#init()</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– <code>lastCPUTimeNs</code> ã€<code>lastSampleTimeNs</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCpuTime()</code></a> æŠ½è±¡æ–¹æ³•ï¼Œè·å¾— CPU å ç”¨æ—¶é—´ï¼Œç”±å­ç±»å®Œæˆã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCPUMetric()</code></a> æ–¹æ³•ï¼Œè·å¾— CPU æŒ‡æ ‡ã€‚æ”¾åœ¨å’Œ SunCpuAccessor ä¸€èµ·åˆ†äº«ã€‚è¿™é‡Œæˆ‘å…ˆè®°å¾—ï¼ŒJVM è¿›ç¨‹å ç”¨ CPU ç‡çš„è®¡ç®—å…¬å¼ï¼š<code>è¿›ç¨‹ CPU å ç”¨æ€»æ—¶é—´ / ( è¿›ç¨‹å¯åŠ¨æ€»æ—¶é—´ * CPU æ•°é‡)</code> ã€‚</li></ul><hr><p>CPUMetricAccessor æœ‰ä¸¤ä¸ªå­ç±»ï¼Œå®é™…ä¸Šæ–‡æˆ‘ä»¬å·²ç»çœ‹åˆ°å®ƒçš„åˆ›å»ºï¼š</p><ul><li>SunCpuAccessor ï¼ŒåŸºäº SUN æä¾›çš„æ–¹æ³•ï¼Œè·å– CPU æŒ‡æ ‡è®¿é—®å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/NoSupportedCPUAccessor.java" rel="external nofollow noopener noreferrer" target="_blank">NoSupportedCPUAccessor</a> ï¼Œä¸æ”¯æŒçš„ CPU æŒ‡æ ‡è®¿é—®å™¨ã€‚å› æ­¤ï¼Œä½¿ç”¨è¯¥ç±»çš„æƒ…å†µä¸‹ï¼Œè·å–ä¸åˆ°å…·ä½“çš„è¿›ç¨‹ CPU å ç”¨ç‡ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/SunCpuAccessor.java#L31" rel="external nofollow noopener noreferrer" target="_blank">SunCpuAccessor æ„é€ æ–¹æ³•</a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 32 è¡Œï¼šè®¾ç½® CPU æ•°é‡ã€‚</li><li><p>ç¬¬ 33 è¡Œï¼šè·å¾— OperatingSystemMXBean å¯¹è±¡ã€‚é€šè¿‡è¯¥å¯¹è±¡ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/SunCpuAccessor.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCpuTime()</code></a> å®ç°æ–¹æ³•ï¼Œè°ƒç”¨ <a href="https://docs.oracle.com/javase/7/docs/jre/api/management/extension/com/sun/management/OperatingSystemMXBean.html#getProcessCpuTime(" rel="external nofollow noopener noreferrer" target="_blank"><code>OperatingSystemMXBean#getProcessCpuTime()</code></a>) æ–¹æ³•ï¼Œè·å¾— JVM è¿›ç¨‹å ç”¨ CPU æ€»æ—¶é•¿ã€‚</p><blockquote><p>long getProcessCpuTime()  </p><p>Returns the CPU time used by the process on which the Java virtual machine is running in nanoseconds. The returned value is of nanoseconds precision but not necessarily nanoseconds accuracy. This method returns -1 if the the platform does not support this operation.  </p><p><strong>Returns</strong>:<br>the CPU time used by the process in nanoseconds, or -1 if this operation is not supported.</p></blockquote></li><li><p>ç¬¬ 34 è¡Œï¼šè°ƒç”¨ <code>#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– <code>lastCPUTimeNs</code> ã€<code>lastSampleTimeNs</code> ã€‚</p></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/d10357a372d8178ff205a2272d2cb7d57bc8f605/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/cpu/CPUMetricAccessor.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCPUMetric()</code></a> æ–¹æ³•ï¼Œè·å¾— CPU æŒ‡æ ‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 58 è‡³ 59 è¡Œï¼šè·å¾— JVM è¿›ç¨‹å ç”¨ CPU æ€»æ—¶é•¿ã€‚</li><li>ç¬¬ 64 è¡Œï¼š<code>now - lastSampleTimeNs</code> ï¼Œè·å¾— JVM è¿›ç¨‹å¯åŠ¨æ€»æ—¶é•¿ã€‚</li><li><strong>è¿™é‡Œä¸ºä»€ä¹ˆç›¸å‡å‘¢</strong>ï¼Ÿå› ä¸º CPUMetricAccessor ä¸æ˜¯åœ¨ JVM å¯åŠ¨æ—¶å°±è¿›è¡Œè®¡ç®—ï¼Œé€šè¿‡ç›¸å‡ï¼Œè§£å†³åå·®ã€‚</li><li>ç¬¬ 63 è‡³ 64 è¡Œï¼šè®¡ç®— JVM è¿›ç¨‹å ç”¨ CPU ç‡ã€‚</li></ul><h2 id="2-3-Memory"><a href="#2-3-Memory" class="headerlink" title="2.3 Memory"></a>2.3 Memory</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ac31b37208b33a06616e580dfc71e2079531a2a6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memory/MemoryProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memory.MemoryProvider</code></a> ï¼ŒMemory æä¾›è€…ï¼Œæä¾› <a href="https://github.com/YunaiV/skywalking/blob/ac31b37208b33a06616e580dfc71e2079531a2a6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memory/MemoryProvider.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryMetricList()</code></a> æ–¹æ³•ï¼Œé‡‡é›† Memory æŒ‡æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/07.png" alt=""></p><ul><li>æ¨èé˜…è¯»æ–‡ç« ï¼š<ul><li><a href="https://docs.oracle.com/javase/7/docs/api/java/lang/management/MemoryUsage.html" rel="external nofollow noopener noreferrer" target="_blank">MemoryUsage</a></li><li><a href="http://blog.sina.com.cn/s/blog_ad7c19000102vjcw.html" rel="external nofollow noopener noreferrer" target="_blank">Javaä¸­ç›‘æ§ç¨‹åºå†…å­˜çš„å‡½æ•°</a> </li><li><a href="http://zhanjindong.com/2016/03/02/jvm-memory-tunning-notes" rel="external nofollow noopener noreferrer" target="_blank">JVMå†…å­˜è°ƒä¼˜ç›¸å…³çš„ä¸€äº›ç¬”è®°ï¼ˆæ‚ï¼‰</a></li></ul></li><li><code>isHeap</code> ï¼šæ˜¯å¦å †å†…å†…å­˜ã€‚</li><li><code>init</code> ï¼šåˆå§‹åŒ–çš„å†…å­˜æ•°é‡ã€‚</li><li><code>max</code> ï¼šæœ€å¤§çš„å†…å­˜æ•°é‡ã€‚</li><li><code>used</code> ï¼šå·²ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li><code>committed</code> ï¼šå¯ä»¥ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li>ç¬¬ 44 è‡³ 51 è¡Œï¼šä½¿ç”¨ MemoryMXBean å¯¹è±¡ï¼Œè·å¾—å †å†…( Heap )å†…å­˜ã€‚</li><li>ç¬¬ 54 è‡³ 61 è¡Œï¼šä½¿ç”¨ MemoryMXBean å¯¹è±¡ï¼Œè·å¾—éå †å†…( None-Heap )å†…å­˜ã€‚ </li></ul><h2 id="2-4-MemoryPool"><a href="#2-4-MemoryPool" class="headerlink" title="2.4 MemoryPool"></a>2.4 MemoryPool</h2><p><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.MemoryPoolProvider</code></a> ï¼ŒMemoryPool æä¾›è€…ï¼Œæä¾› <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> æ–¹æ³•ï¼Œé‡‡é›† MemoryPool æŒ‡æ ‡<strong>æ•°ç»„</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/09.png" alt=""></p><ul><li>æ¨èé˜…è¯»æ–‡ç« ï¼š<ul><li><a href="JVMå †å†…å­˜å’Œéå †å†…å­˜">MemoryUsage</a></li></ul></li><li><code>type</code> ï¼šå†…å­˜åŒºåŸŸç±»å‹ã€‚MemoryPool å’Œ Memory çš„å·®åˆ«åœ¨äºæ‹†åˆ†çš„ç»´åº¦ä¸åŒï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/11.png" alt=""></li><li><code>init</code> ï¼šåˆå§‹åŒ–çš„å†…å­˜æ•°é‡ã€‚</li><li><code>max</code> ï¼šæœ€å¤§çš„å†…å­˜æ•°é‡ã€‚</li><li><code>used</code> ï¼šå·²ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li><code>committed</code> ï¼šå¯ä»¥ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java#L36" rel="external nofollow noopener noreferrer" target="_blank">MemoryPoolProvider æ„é€ æ–¹æ³•</a>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 38 è¡Œï¼šè·å¾— MemoryPoolMXBean æ•°ç»„ã€‚æ¯ä¸ª MemoryPoolMXBean å¯¹è±¡ï¼Œä»£è¡¨ä¸Šé¢çš„ä¸€ä¸ªåŒºåŸŸç±»å‹ã€‚</li><li>ç¬¬ 39 è‡³ 46 è¡Œï¼šå¾ªç¯ MemoryPoolMXBean æ•°ç»„ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolProvider.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#findByBeanName(name)</code></a> æ–¹æ³•ï¼Œæ‰¾åˆ°å¯¹åº”çš„ GC ç®—æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ MemoryPoolMetricAccessor å¯¹è±¡ã€‚</li><li>ç¬¬ 47 è‡³ 49 è¡Œï¼šæœªæ‰¾åˆ°åŒ¹é…çš„ GC ç®—æ³•ï¼Œåˆ›å»º UnknownMemoryPool å¯¹è±¡ã€‚</li></ul><h3 id="2-4-1-MemoryPoolMetricAccessor"><a href="#2-4-1-MemoryPoolMetricAccessor" class="headerlink" title="2.4.1 MemoryPoolMetricAccessor"></a>2.4.1 MemoryPoolMetricAccessor</h3><p> <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolMetricAccessor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.MemoryPoolMetricAccessor</code></a> ï¼ŒMemoryPool æŒ‡æ ‡è®¿é—®å™¨<strong>æ¥å£</strong>ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolMetricAccessor.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> æ¥å£ï¼Œè·å¾— MemoryPool æŒ‡æ ‡<strong>æ•°ç»„</strong>ã€‚</li></ul><p>MemoryPoolMetricAccessor å­ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/12.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/UnknownMemoryPool.java" rel="external nofollow noopener noreferrer" target="_blank">UnknownMemoryPool</a> ï¼ŒæœªçŸ¥çš„ MemoryPool æŒ‡æ ‡è®¿é—®å™¨å®ç°ç±»ã€‚æ¯æ¬¡ <a href="https://github.com/YunaiV/skywalking/blob/868b01dbabccb8dd81031914d1536cb2393e9ab5/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/UnknownMemoryPool.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> æ–¹æ³•ï¼Œè¿”å›  MemoryPool æŒ‡æ ‡<strong>æ•°ç»„</strong>ï¼Œä½†æ˜¯æ¯ä¸ªæŒ‡æ ‡å…ƒç´ æ˜¯æ— å…·ä½“æ•°æ®çš„ã€‚</li></ul><h3 id="2-4-2-MemoryPoolModule"><a href="#2-4-2-MemoryPoolModule" class="headerlink" title="2.4.2 MemoryPoolModule"></a>2.4.2 MemoryPoolModule</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.MemoryPoolModule</code></a> ï¼Œå®ç° MemoryPoolMetricAccessor æ¥å£ï¼ŒMemoryPool æŒ‡æ ‡è®¿é—®å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚ä¸åŒ GC ç®—æ³•ä¹‹é—´ï¼Œå†…å­˜åŒºåŸŸå‘½åä¸åŒï¼Œé€šè¿‡å¦‚ä¸‹<strong>å…­ä¸ª</strong>æ–¹æ³•æŠ½è±¡ï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒå†…å­˜åŒºåŸŸï¼Œå½¢æˆæ˜ å°„å…³ç³»ï¼Œå±è”½å·®å¼‚ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#getPermNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L87" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCodeCacheNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#getEdenNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L91" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOldNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L93" rel="external nofollow noopener noreferrer" target="_blank"><code>#getSurvivorNames()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L95" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMetaspaceNames()</code></a></li><li>èƒ–å‹å¯ä»¥çœ‹çœ‹ MemoryPoolModule å­ç±»çš„å®ç°ï¼š<ul><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/CMSCollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">CMSCollectorModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/G1CollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">G1CollectorModule</a> </li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/ParallelCollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">ParallelCollectorModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/SerialCollectorModule.java" rel="external nofollow noopener noreferrer" target="_blank">SerialCollectorModule</a></li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L41" rel="external nofollow noopener noreferrer" target="_blank"><code>#getMemoryPoolMetricList()</code></a> <strong>å®ç°æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 44 è¡Œï¼šå¾ªç¯æ¯ä¸ªå†…å­˜åŒºåŸŸï¼Œæ”¶é›†æ¯ä¸ª MemoryPool æŒ‡æ ‡ã€‚</li><li>ç¬¬ 47 è‡³ 62 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/memorypool/MemoryPoolModule.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>#contains(possibleNames, name)</code></a> æ–¹æ³•ï¼Œé€ä¸ªå†…å­˜åŒºåŸŸåå­—åˆ¤æ–­ï¼Œè·å¾—å¯¹åº”çš„å†…å­˜åŒºåŸŸç±»å‹ã€‚</li><li>ç¬¬ 65 è‡³ 71 è¡Œï¼šåˆ›å»º MemoryUsage å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç»“æœæ•°ç»„ã€‚</li></ul><h2 id="2-5-GC"><a href="#2-5-GC" class="headerlink" title="2.5 GC"></a>2.5 GC</h2><p>æ•´ä½“å®ç°ç±»ä¼¼ <a href="#">ã€Œ2.4 MemoryPoolã€</a> ã€‚ </p><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.memorypool.GCProvider</code></a> ï¼ŒGC æä¾›è€…ï¼Œæä¾› <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> æ–¹æ³•ï¼Œé‡‡é›† GC æŒ‡æ ‡<strong>æ•°ç»„</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/13.png" alt=""></p><ul><li><code>phrase</code> ï¼šç”Ÿä»£ç±»å‹ï¼ŒåŒ…æ‹¬æ–°ç”Ÿä»£ã€è€ç”Ÿä»£ã€‚</li><li><code>count</code> ï¼šæ€»å›æ”¶æ¬¡æ•°ã€‚</li><li><code>time</code> ï¼šæ€»å›æ”¶å ç”¨æ—¶é—´ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L37" rel="external nofollow noopener noreferrer" target="_blank">GCProvider æ„é€ æ–¹æ³•</a>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 38 è¡Œï¼šè·å¾— GarbageCollectorMXBean æ•°ç»„ã€‚</li><li>ç¬¬ 39 è‡³ 46 è¡Œï¼šå¾ªç¯ MemoryPoolMXBean æ•°ç»„ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCProvider.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>#findByBeanName(name)</code></a> æ–¹æ³•ï¼Œæ‰¾åˆ°å¯¹åº”çš„ GC ç®—æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ GCMetricAccessor å¯¹è±¡ã€‚</li><li>ç¬¬ 47 è‡³ 49 è¡Œï¼šæœªæ‰¾åˆ°åŒ¹é…çš„ GC ç®—æ³•ï¼Œåˆ›å»º UnknowGC å¯¹è±¡ã€‚</li></ul><h3 id="2-5-1-GCMetricAccessor"><a href="#2-5-1-GCMetricAccessor" class="headerlink" title="2.5.1 GCMetricAccessor"></a>2.5.1 GCMetricAccessor</h3><p> <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCMetricAccessor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.gc.GCMetricAccessor</code></a> ï¼ŒGC æŒ‡æ ‡è®¿é—®å™¨<strong>æ¥å£</strong>ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCMetricAccessor.java#L28" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> æ¥å£ï¼Œè·å¾— GC æŒ‡æ ‡<strong>æ•°ç»„</strong>ã€‚</li></ul><p>GCMetricAccessor å­ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/15.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/UnknowGC.java" rel="external nofollow noopener noreferrer" target="_blank">UnknowGC</a> ï¼ŒæœªçŸ¥çš„ GC æŒ‡æ ‡è®¿é—®å™¨å®ç°ç±»ã€‚æ¯æ¬¡ <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/UnknowGC.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> æ–¹æ³•ï¼Œè¿”å›  GC æŒ‡æ ‡<strong>æ•°ç»„</strong>ï¼Œä½†æ˜¯æ¯ä¸ªæŒ‡æ ‡å…ƒç´ æ˜¯æ— å…·ä½“æ•°æ®çš„ã€‚</li></ul><h3 id="2-5-2-GCModule"><a href="#2-5-2-GCModule" class="headerlink" title="2.5.2 GCModule"></a>2.5.2 GCModule</h3><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.jvm.gc.GCModule</code></a> ï¼Œå®ç° GCMetricAccessor æ¥å£ï¼ŒGC æŒ‡æ ‡è®¿é—®å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚ä¸åŒ GC ç®—æ³•ä¹‹é—´ï¼Œç”Ÿä»£å‘½åä¸åŒï¼Œé€šè¿‡å¦‚ä¸‹<strong>ä¸¤ä¸ª</strong>æ–¹æ³•æŠ½è±¡ï¼Œåˆ†åˆ«å¯¹åº”ä¸¤ä¸ªç”Ÿä»£ï¼Œå½¢æˆæ˜ å°„å…³ç³»ï¼Œå±è”½å·®å¼‚ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOldGCName()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#getNewGCName()</code></a></li><li>èƒ–å‹å¯ä»¥çœ‹çœ‹ GCModule å­ç±»çš„å®ç°ï¼š<ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/CMSGCModule.java" rel="external nofollow noopener noreferrer" target="_blank">CMSGCModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/G1GCModule.java" rel="external nofollow noopener noreferrer" target="_blank">G1GCModule</a> </li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/ParallelGCModule.java" rel="external nofollow noopener noreferrer" target="_blank">ParallelGCModule</a></li><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/SerialGCModule.java" rel="external nofollow noopener noreferrer" target="_blank">SerialGCModule</a></li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/jvm/gc/GCModule.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#getGCList()</code></a> <strong>å®ç°æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 44 è¡Œï¼šå¾ªç¯ GarbageCollectorMXBean æ•°ç»„ï¼Œæ”¶é›†æ¯ä¸ª GC æŒ‡æ ‡ã€‚</li><li>ç¬¬ 47 è‡³ 62 è¡Œï¼šè·å¾—ç”Ÿä»£ç±»å‹ã€‚</li><li>ç¬¬ 65 è‡³ 71 è¡Œï¼šåˆ›å»º GC å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç»“æœæ•°ç»„ã€‚</li></ul><h1 id="3-Collector-å­˜å‚¨-JVM-æŒ‡æ ‡"><a href="#3-Collector-å­˜å‚¨-JVM-æŒ‡æ ‡" class="headerlink" title="3. Collector å­˜å‚¨ JVM æŒ‡æ ‡"></a>3. Collector å­˜å‚¨ JVM æŒ‡æ ‡</h1><h2 id="3-1-JVMMetricsServiceHandler"><a href="#3-1-JVMMetricsServiceHandler" class="headerlink" title="3.1 JVMMetricsServiceHandler"></a>3.1 JVMMetricsServiceHandler</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-network/src/main/proto/JVMMetricsService.proto#L8" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMMetricsService.proto</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/01.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/TraceSegmentServiceHandler.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMMetricsServiceHandler#collect(JVMMetrics, StreamObserver&lt;Downstream&gt;)</code></a>, ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 60 è¡Œï¼š<strong>å¾ªç¯</strong>æ¥æ”¶åˆ°çš„ JVMMetric <strong>æ•°ç»„</strong>ã€‚</li><li>ç¬¬ 62 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToInstanceHeartBeatService(...)</code></a> æ–¹æ³•ï¼Œå‘é€å¿ƒè·³ï¼Œè®°å½•åº”ç”¨å®ä¾‹çš„æœ€åå¿ƒè·³æ—¶é—´ã€‚å› ä¸ºç›®å‰ SkyWaling ä¸»è¦ç”¨äº JVM å¹³å°ï¼Œé€šè¿‡æ¯ç§’çš„ JVM æŒ‡æ ‡æ”¶é›†çš„åŒæ—¶ï¼Œè®°å½•åº”ç”¨å®ä¾‹çš„æœ€åå¿ƒè·³æ—¶é—´ã€‚</li><li>ç¬¬ 62 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L91" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToCpuMetricService(...)</code></a> æ–¹æ³•ï¼Œå¤„ç† CPU æ•°æ®ã€‚</li><li>ç¬¬ 64 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToMemoryMetricService(...)</code></a> æ–¹æ³•ï¼Œå¤„ç† Memory æ•°æ®ã€‚</li><li>ç¬¬ 66 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToMemoryPoolMetricService(...)</code></a> æ–¹æ³•ï¼Œå¤„ç† Memory Pool æ•°æ®ã€‚</li><li>ç¬¬ 68 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L95" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToGCMetricService(...)</code></a> æ–¹æ³•ï¼Œå¤„ç† GC æ•°æ®ã€‚</li><li>ç¬¬ 73 è‡³ 74 è¡Œï¼šå…¨éƒ¨å¤„ç†å®Œæˆï¼Œè¿”å›æˆåŠŸã€‚</li></ul><p>ä¸Šè¿°çš„ <code>#sendToXXX()</code> æ–¹æ³•ï¼Œå†…éƒ¨æ¯ä¸ªå¯¹åº”è°ƒç”¨ä¸€ä¸ªå¦‚ä¸‹å›¾ Service æä¾›çš„æ–¹æ³•ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/04.png" alt=""></p><ul><li>æ¯ä¸ª Service çš„å®ç°ï¼Œå¯¹åº”ä¸€ä¸ªæ•°æ®å®ä½“å’Œä¸€ä¸ª Graph å¯¹è±¡ï¼Œé€šè¿‡æµå¼å¤„ç†ï¼Œæœ€ç»ˆå­˜å‚¨åˆ°å­˜å‚¨å™¨( ä¾‹å¦‚ ES ) ï¼Œæµç¨‹å¦‚ä¸‹å›¾ï¼š</li><li>å…·ä½“çš„å®ç°ä»£ç ï¼Œæˆ‘ä»¬æ”¾åœ¨ä¸‹é¢çš„æ•°æ®å®ä½“ä¸€èµ·åˆ†äº«ã€‚</li></ul><h2 id="3-2-CPU"><a href="#3-2-CPU" class="headerlink" title="3.2 CPU"></a>3.2 CPU</h2><p><a href="https://github.com/YunaiV/skywalking/blob/aadff78dcde7c2e05dc8d29f3381032c1650137e/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/CpuMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.CpuMetric</code></a> ï¼ŒCPU æŒ‡æ ‡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/aadff78dcde7c2e05dc8d29f3381032c1650137e/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/CpuMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.CpuMetricTable</code></a> ï¼Œ CpuMetric è¡¨( <code>cpu_metric</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>instance_id</code> ï¼šåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>usage_percent</code> ï¼šCPU å ç”¨ç‡ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/CpuMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.CpuMetricEsPersistenceDAO</code></a> ï¼ŒCpuMetric çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/06.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/CpuMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.CpuMetricService</code></a> ï¼ŒCPU æŒ‡æ ‡æœåŠ¡ï¼Œè°ƒç”¨ CPUMetric å¯¹åº”çš„ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;CPUMetric&gt;</code></a> å¯¹è±¡ï¼Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆ CPUMetric ä¿å­˜åˆ°å­˜å‚¨å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/CpuMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.CpuMetricPersistenceWorker</code></a> , CPU æŒ‡æ ‡æ‰¹é‡å­˜å‚¨ Worker ã€‚</li></ul><h2 id="3-3-Memory"><a href="#3-3-Memory" class="headerlink" title="3.3 Memory"></a>3.3 Memory</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryMetric</code></a> ï¼ŒMemory æŒ‡æ ‡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryMetricTable</code></a> ï¼Œ MemoryMetric è¡¨( <code>memory_metric</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>instance_id</code> ï¼šåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>isHeap</code> ï¼šæ˜¯å¦å †å†…å†…å­˜ã€‚</li><li><code>init</code> ï¼šåˆå§‹åŒ–çš„å†…å­˜æ•°é‡ã€‚</li><li><code>max</code> ï¼šæœ€å¤§çš„å†…å­˜æ•°é‡ã€‚</li><li><code>used</code> ï¼šå·²ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li><code>committed</code> ï¼šå¯ä»¥ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/MemoryMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.MemoryMetricEsPersistenceDAO</code></a> ï¼ŒMemoryMetric çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/08.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricService</code></a> ï¼ŒMemory æŒ‡æ ‡æœåŠ¡ï¼Œè°ƒç”¨ MemoryMetric å¯¹åº”çš„ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;MemoryMetric&gt;</code></a> å¯¹è±¡ï¼Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆ MemoryMetric ä¿å­˜åˆ°å­˜å‚¨å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricPersistenceWorker</code></a> , Memory æŒ‡æ ‡æ‰¹é‡å­˜å‚¨ Worker ã€‚</li></ul><h2 id="3-4-MemoryPool"><a href="#3-4-MemoryPool" class="headerlink" title="3.4 MemoryPool"></a>3.4 MemoryPool</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryPoolMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryPoolMetric</code></a> ï¼ŒMemoryPool æŒ‡æ ‡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c94fca439b748760bb7561e4fa79f2673df171a3/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/MemoryPoolMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.MemoryPoolMetricTable</code></a> ï¼Œ MemoryPool è¡¨( <code>memory_pool_metric</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>instance_id</code> ï¼šåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>pool_type</code> ï¼šå†…å­˜åŒºåŸŸç±»å‹ã€‚</li><li><code>init</code> ï¼šåˆå§‹åŒ–çš„å†…å­˜æ•°é‡ã€‚</li><li><code>max</code> ï¼šæœ€å¤§çš„å†…å­˜æ•°é‡ã€‚</li><li><code>used</code> ï¼šå·²ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li><code>committed</code> ï¼šå¯ä»¥ä½¿ç”¨çš„å†…å­˜æ•°é‡ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/MemoryPoolMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.MemoryPoolMetricEsPersistenceDAO</code></a> ï¼ŒMemoryPoolMetric çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/10.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryPoolMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricService</code></a> ï¼ŒMemoryPoolMetric æŒ‡æ ‡æœåŠ¡ï¼Œè°ƒç”¨ MemoryPoolMetric å¯¹åº”çš„ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L82" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;MemoryPoolMetric&gt;</code></a> å¯¹è±¡ï¼Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆ MemoryPoolMetric ä¿å­˜åˆ°å­˜å‚¨å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricPersistenceWorker</code></a> , MemoryPool æŒ‡æ ‡æ‰¹é‡å­˜å‚¨ Worker ã€‚</li></ul><h2 id="3-5-GC"><a href="#3-5-GC" class="headerlink" title="3.5 GC"></a>3.5 GC</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0051d648dc8e5435dd63666a34da81274f0a0e61/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/GCMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.GCMetric</code></a> ï¼ŒGC æŒ‡æ ‡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/jvm/GCMetricTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.jvm.GCMetricTable</code></a> ï¼Œ GCMetric è¡¨( <code>gc_metric</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>instance_id</code> ï¼šåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>phrase</code> ï¼šç”Ÿä»£ç±»å‹ï¼ŒåŒ…æ‹¬æ–°ç”Ÿä»£ã€è€ç”Ÿä»£ã€‚</li><li><code>count</code> ï¼šæ€»æ¬¡æ•°ã€‚</li><li><code>time</code> ï¼šæ€»æ—¶é—´ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GCMetricEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.GCMetricEsPersistenceDAO</code></a> ï¼ŒGCMetric çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/14.png" alt=""></li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/GCMetricService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.GCMetricService</code></a> ï¼ŒGCMetric æŒ‡æ ‡æœåŠ¡ï¼Œè°ƒç”¨ GCMetric å¯¹åº”çš„ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;GCMetric&gt;</code></a> å¯¹è±¡ï¼Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆ GCMetric ä¿å­˜åˆ°å­˜å‚¨å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/MemoryMetricPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.MemoryMetricPersistenceWorker</code></a> , MemoryPool æŒ‡æ ‡æ‰¹é‡å­˜å‚¨ Worker ã€‚</li></ul><h1 id="4-å¿ƒè·³"><a href="#4-å¿ƒè·³" class="headerlink" title="4. å¿ƒè·³"></a>4. å¿ƒè·³</h1><p>Collector åœ¨æ¥æ”¶åˆ° GC æŒ‡æ ‡ä¸Šä¼ åï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/JVMMetricsServiceHandler.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>JVMMetricsServiceHandler#sendToInstanceHeartBeatService(...)</code></a> æ–¹æ³•ï¼Œå‘é€å¿ƒè·³ï¼Œè®°å½•åº”ç”¨å®ä¾‹çš„æœ€åå¿ƒè·³æ—¶é—´ã€‚å› ä¸ºç›®å‰ SkyWaling ä¸»è¦ç”¨äº JVM å¹³å°ï¼Œé€šè¿‡æ¯ç§’çš„ JVM æŒ‡æ ‡æ”¶é›†çš„åŒæ—¶ï¼Œè®°å½•åº”ç”¨å®ä¾‹çš„æœ€åå¿ƒè·³æ—¶é—´ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/jvm/InstanceHeartBeatService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.jvm.InstanceHeartBeatService</code></a> ï¼Œåº”ç”¨å®ä¾‹å¿ƒè·³æœåŠ¡ï¼Œè°ƒç”¨ Instance å¯¹åº”çš„ <a href="https://github.com/YunaiV/skywalking/blob/4b7d7083ca9cd89437bcca6d0c5f67f3832d60dd/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java#L90" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph&lt;Instance&gt;</code></a> å¯¹è±¡ï¼Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆæ›´æ–° Instance çš„æœ€å<strong>å¿ƒè·³æ—¶é—´</strong>( <a href="https://github.com/YunaiV/skywalking/blob/73f4c2fb5fb7cf6eb533d61ba59afec66af2c9b6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/InstanceTable.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>heartbeat_time</code></a> )åˆ°å­˜å‚¨å™¨ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯”æƒ³è±¡ä¸­å†—é•¿çš„æ–‡ç« ï¼Œæœ‰äº›è€ƒéªŒè€å¿ƒï¼Œå¿ƒç–¼ SkyWalking å¼€å‘è€… 30 ç§’ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_20/16.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/jvm-collect/&quot;&gt;http://www.iocoder.cn/SkyWalking/jvm-collect/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-store-trace/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-store-trace/</id>
    <published>2020-10-14T16:00:00.000Z</published>
    <updated>2018-01-05T15:21:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">http://www.iocoder.cn/SkyWalking/collector-store-trace/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">2. SpanListener</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">3. GlobalTrace</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">4. InstPerformance</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">5. SegmentCost</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">6. NodeComponent</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">7. NodeMapping</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">8. NodeReference</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">9. ServiceEntry</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">10. ServiceReference</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">11. Segment</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œé“¾è·¯çš„è¿½è¸ªå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Agent æ”¶é›† Trace æ•°æ®ã€‚</li><li>Agent å‘é€ Trace æ•°æ®ç»™ Collector ã€‚</li><li>Collector æ¥æ”¶ Trace æ•°æ®ã€‚</li><li><strong>Collector å­˜å‚¨ Trace æ•°æ®åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼Œæ•°æ®åº“</strong>ã€‚</li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†äº«ã€ç¬¬å››éƒ¨åˆ†ã€‘ <strong>SkyWalking Collector å­˜å‚¨ Trace æ•°æ®</strong>ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šCollector æ¥æ”¶åˆ° TraceSegment çš„æ•°æ®ï¼Œå¯¹åº”çš„ç±»æ˜¯ Protobuf ç”Ÿæˆçš„ã€‚è€ƒè™‘åˆ°æ›´åŠ æ˜“è¯»æ˜“æ‡‚ï¼Œæœ¬æ–‡ä½¿ç”¨ TraceSegment ç›¸å…³çš„<strong>åŸå§‹ç±»</strong>ã€‚</p></blockquote><p>Collector åœ¨æ¥æ”¶åˆ° Trace æ•°æ®åï¼Œç»è¿‡<strong>æµå¼å¤„ç†</strong>ï¼Œæœ€ç»ˆ<strong>å­˜å‚¨</strong>åˆ°å­˜å‚¨å™¨ã€‚å¦‚ä¸‹å›¾ï¼Œ<strong>çº¢åœˆéƒ¨åˆ†</strong>ï¼Œä¸ºæœ¬æ–‡åˆ†äº«çš„å†…å®¹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/01.jpeg" alt=""></p><h1 id="2-SpanListener"><a href="#2-SpanListener" class="headerlink" title="2. SpanListener"></a>2. SpanListener</h1><p>åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° <a href="https://github.com/YunaiV/skywalking/blob/428190e783d887c8240546f321e76e0a6b5f5d18/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentParse#parse(UpstreamSegment, Source)</code></a> æ–¹æ³•ä¸­ï¼š</p><ul><li>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/428190e783d887c8240546f321e76e0a6b5f5d18/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>#preBuild(List&lt;UniqueId&gt;, SegmentDecorator)</code></a> æ–¹æ³•ä¸­ï¼Œé¢„æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ Span ç›‘å¬å™¨ä»¬ï¼Œä» TraceSegment è§£æå‡ºä¸åŒçš„æ•°æ®ã€‚</li><li>åœ¨<strong>é¢„æ„å»º</strong>æˆåŠŸåï¼Œé€šçŸ¥ Span ç›‘å¬å™¨ä»¬ï¼Œå»æ„å»ºå„è‡ªçš„æ•°æ®ï¼Œç»è¿‡<strong>æµå¼å¤„ç†</strong>ï¼Œæœ€ç»ˆ<strong>å­˜å‚¨</strong>åˆ°å­˜å‚¨å™¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.SpanListener</code></a> ï¼ŒSpan ç›‘å¬å™¨<strong>æ¥å£</strong>ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SpanListener.java#L28" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºæ•°æ®ï¼Œæ‰§è¡Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆå­˜å‚¨åˆ°å­˜å‚¨å™¨ã€‚</li></ul><p>SpanListener çš„å­ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/02.png" alt=""></p><ul><li>ç¬¬ä¸€å±‚ï¼Œé€šç”¨æ¥å£å±‚ï¼Œå®šä¹‰äº†ä» TraceSegment è§£ææ•°æ®çš„æ–¹æ³•ã€‚<ul><li>â‘  <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/GlobalTraceIdsListener.java" rel="external nofollow noopener noreferrer" target="_blank">GlobalTraceSpanListener</a> ï¼šè§£æé“¾è·¯è¿½è¸ªå…¨å±€ç¼–å·æ•°ç»„( <code>TraceSegment.relatedGlobalTraces</code> )ã€‚</li><li>â‘¡ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/RefsListener.java" rel="external nofollow noopener noreferrer" target="_blank">RefsListener</a> ï¼šè§£æçˆ¶ Segment æŒ‡å‘æ•°ç»„( <code>TraceSegment.refs</code> )ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/FirstSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">FirstSpanListener</a> ï¼šè§£æ<strong>ç¬¬ä¸€ä¸ª</strong> Span (<code>TraceSegment.spans[0]</code>) ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/EntrySpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">EntrySpanListener</a> ï¼šè§£æ EntrySpan (<code>TraceSegment.spans</code>)ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/LocalSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">LocalSpanListener</a> ï¼šè§£æ LocalSpan (<code>TraceSegment.spans</code>)ã€‚</li><li>â‘¢ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/ExitSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank">ExitSpanListener</a> ï¼šè§£æ ExitSpan (<code>TraceSegment.spans</code>)ã€‚</li></ul></li><li>ç¬¬äºŒå±‚ï¼Œä¸šåŠ¡å®ç°å±‚ï¼Œæ¯ä¸ªå®ç°ç±»å¯¹åº”ä¸€ä¸ªæ•°æ®å®ä½“ç±»ï¼Œä¸€ä¸ª Graph å¯¹è±¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/03.png" alt=""></li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»¥æ¯ä¸ªæ•°æ®å®ä½“ç±»ä¸ºä¸­å¿ƒï¼Œé€ä¸ªåˆ†äº«ã€‚</p><h1 id="3-GlobalTrace"><a href="#3-GlobalTrace" class="headerlink" title="3. GlobalTrace"></a>3. GlobalTrace</h1><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/global/GlobalTrace.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.global.GlobalTrace</code></a> ï¼Œå…¨å±€é“¾è·¯è¿½è¸ªï¼Œè®°å½•ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ŒåŒ…æ‹¬çš„ TraceSegment ç¼–å·ã€‚</p><ul><li>GlobalTrace : TraceSegment = N : M ï¼Œä¸€ä¸ª GlobalTrace å¯ä»¥æœ‰å¤šä¸ª TraceSegment ï¼Œä¸€ä¸ª TraceSegment å¯ä»¥å…³è”å¤šä¸ª GlobalTrace ã€‚å‚è§ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®ã€‹ã€Œ2. Traceã€</a> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/global/GlobalTraceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.global.GlobalTraceTable</code></a> ï¼Œ GlobalTrace è¡¨( <code>global_trace</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>global_trace_id</code> ï¼šå…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ã€‚</li><li><code>segment_id</code> ï¼šTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/GlobalTraceEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.GlobalTraceEsPersistenceDAO</code></a> ï¼ŒGlobalTrace çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/04.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.global.GlobalTraceSpanListener</code></a> ï¼Œ<strong>GlobalTrace çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€GlobalTraceIdsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>globalTraceIds</code> å±æ€§ï¼Œå…¨å±€é“¾è·¯è¿½è¸ªç¼–å·<strong>æ•°ç»„</strong>ã€‚</li><li><code>segmentId</code> å±æ€§ï¼ŒTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» Span ä¸­è§£æåˆ° <code>segmentId</code> ï¼Œ<code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseGlobalTraceId(UniqueId)</code></a> æ–¹æ³•ï¼Œè§£æå…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ï¼Œæ·»åŠ åˆ° <code>globalTraceIds</code> æ•°ç»„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTraceSpanListener.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– GlobalTrace å¯¹åº”çš„ <code>Graph&lt;GlobalTrace&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>globalTraceIds</code> æ•°ç»„ï¼Œåˆ›å»º GlobalTrace å¯¹è±¡ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(application)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ GlobalTrace åˆ°å­˜å‚¨å™¨ã€‚ </li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L93" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createGlobalTraceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° GlobalTrace å¯¹åº”çš„ <code>Graph&lt;GlobalTrace&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.global.GlobalTracePersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒGlobalTrace <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java#L51" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>PersistenceWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ4. PersistenceWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 120 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/global/GlobalTracePersistenceWorker.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>false</code> ï¼Œå­˜å‚¨æ—¶ï¼Œä¸éœ€è¦åˆå¹¶æ•°æ®ã€‚GlobalTrace åªæœ‰æ–°å¢æ“ä½œï¼Œæ²¡æœ‰æ›´æ–°æ“ä½œï¼Œå› æ­¤æ— éœ€åˆå¹¶æ•°æ®ã€‚</li></ul></li></ul><h1 id="4-InstPerformance"><a href="#4-InstPerformance" class="headerlink" title="4. InstPerformance"></a>4. InstPerformance</h1><blockquote><p>æ—ç™½å›ï¼šInstPerformance å’Œ GlobalTrace æ•´ä½“æ¯”è¾ƒç›¸ä¼¼ï¼Œåˆ†äº«çš„ä¼šæ¯”è¾ƒç®€æ´ä¸€äº›ã€‚</p></blockquote><p><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/instance/InstPerformance.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.instance.InstPerformance</code></a> ï¼Œåº”ç”¨å®ä¾‹æ€§èƒ½ï¼Œè®°å½•åº”ç”¨å®ä¾‹<strong>æ¯ç§’</strong>çš„è¯·æ±‚æ€»æ¬¡æ•°ï¼Œè¯·æ±‚æ€»æ—¶é•¿ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/instance/InstPerformanceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.instance.InstPerformanceTable</code></a> ï¼Œ GlobalTrace è¡¨( <code>global_trace</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>application_id</code> ï¼šåº”ç”¨ç¼–å·ã€‚</li><li><code>instance_id</code> ï¼šåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>calls</code> ï¼šè°ƒç”¨æ€»æ¬¡æ•°ã€‚</li><li><code>cost_total</code> ï¼šæ¶ˆè€—æ€»æ—¶é•¿ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstPerformanceEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.InstPerformanceEsPersistenceDAO</code></a> ï¼ŒInstPerformance çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/05.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/instance/InstPerformanceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.instance.InstPerformanceSpanListener</code></a> ï¼Œ<strong>InstPerformance çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€EntrySpanListener æ¥å£ã€‚</p><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L101" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createInstPerformanceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° InstPerformance å¯¹åº”çš„ <code>Graph&lt;InstPerformance&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/instance/InstPerformancePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.instance.InstPerformancePersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒInstPerformance <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li>ç±»ä¼¼ GlobalTracePersistenceWorker ï¼Œâ€¦ çœç•¥å…¶å®ƒç±»å’Œæ–¹æ³•ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/instance/InstPerformancePersistenceWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>true</code> ï¼Œå­˜å‚¨æ—¶ï¼Œéœ€è¦åˆå¹¶æ•°æ®ã€‚<code>calls</code> ã€<code>cost_total</code> éœ€è¦ç´¯åŠ åˆå¹¶ã€‚</li></ul></li></ul><h1 id="5-SegmentCost"><a href="#5-SegmentCost" class="headerlink" title="5. SegmentCost"></a>5. SegmentCost</h1><blockquote><p>æ—ç™½å›ï¼šSegmentCost å’Œ GlobalTrace æ•´ä½“æ¯”è¾ƒç›¸ä¼¼ï¼Œåˆ†äº«çš„ä¼šæ¯”è¾ƒç®€æ´ä¸€äº›ã€‚</p></blockquote><p><a href="https://github.com/YunaiV/skywalking/blob/b8be916ac2bf7817544d6ff77a95a624bcc3efe6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/segment/SegmentCost.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.segment.SegmentCost</code></a> ï¼ŒTraceSegment æ¶ˆè€—æ—¶é•¿ï¼Œè®°å½• TraceSegment å¼€å§‹æ—¶é—´ï¼Œç»“æŸæ—¶é—´ï¼ŒèŠ±è´¹æ—¶é•¿ç­‰ç­‰ã€‚</p><ul><li>SegmentCost : TraceSegment = 1 : 1 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/b8be916ac2bf7817544d6ff77a95a624bcc3efe6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/segment/SegmentCostTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.instance.SegmentCostTable</code></a> ï¼Œ SegmentCostTable è¡¨( <code>segment_cost</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>segment_id</code> ï¼šTraceSegment ç¼–å·ã€‚</li><li><code>application_id</code> ï¼šåº”ç”¨ç¼–å·ã€‚</li><li><code>start_time</code> ï¼šå¼€å§‹æ—¶é—´ã€‚</li><li><code>end_time</code> ï¼šç»“æŸæ—¶é—´ã€‚</li><li><code>service_name</code> ï¼šæ“ä½œåã€‚</li><li><code>cost</code> ï¼šæ¶ˆè€—æ—¶é•¿ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentCostEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.SegmentCostEsPersistenceDAO</code></a> ï¼ŒSegmentCost çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/06.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/segment/SegmentCostSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.SegmentCostSpanListener</code></a> ï¼Œ<strong>SegmentCost çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€EntrySpanListener ã€ExitSpanListener ã€LocalSpanListener æ¥å£ã€‚</p><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L172" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createSegmentCostGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° SegmentCost å¯¹åº”çš„ <code>Graph&lt;SegmentCost&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/b8be916ac2bf7817544d6ff77a95a624bcc3efe6/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/segment/SegmentCostPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.SegmentCostPersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒInstPerformance <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li>ç±»ä¼¼ GlobalTracePersistenceWorker ï¼Œâ€¦ çœç•¥å…¶å®ƒç±»å’Œæ–¹æ³•ã€‚</li></ul></li></ul><h1 id="6-NodeComponent"><a href="#6-NodeComponent" class="headerlink" title="6. NodeComponent"></a>6. NodeComponent</h1><p><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeComponent.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeComponent</code></a> ï¼ŒèŠ‚ç‚¹ç»„ä»¶ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeComponentTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeComponentTable</code></a> ï¼Œ NodeComponentTable è¡¨( <code>node_component</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>component_id</code> ï¼šç»„ä»¶ç¼–å·ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-network/src/main/java/org/skywalking/apm/network/trace/component/ComponentsDefine.java" rel="external nofollow noopener noreferrer" target="_blank">ComponentsDefine</a> çš„æšä¸¾ã€‚</li><li><code>peer_id</code> ï¼šå¯¹ç­‰ç¼–å·ã€‚æ¯ä¸ªç»„ä»¶ï¼Œæˆ–æ˜¯æœåŠ¡æä¾›è€…ï¼Œæœ‰æœåŠ¡åœ°å€ï¼›åˆæˆ–æ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œæœ‰è°ƒç”¨æœåŠ¡åœ°å€ã€‚è¿™ä¸¤è€…éƒ½è„±ç¦»ä¸å¼€<strong>æœåŠ¡åœ°å€</strong>ã€‚SkyWalking å°†<strong>æœåŠ¡åœ°å€</strong>ä½œä¸º <code>applicationCode</code> ï¼Œæ³¨å†Œåˆ° Application ã€‚å› æ­¤ï¼Œæ­¤å¤„çš„ <code>peer_id</code> å®é™…ä¸Šæ˜¯ï¼Œ<strong>æœåŠ¡åœ°å€</strong>å¯¹åº”çš„åº”ç”¨ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeComponentEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.NodeComponentEsPersistenceDAO</code></a> ï¼ŒNodeComponent çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/07.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeComponentSpanListener</code></a> ï¼Œ<strong>NodeComponent çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€EntrySpanListener ã€ExitSpanListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeComponents</code> å±æ€§ï¼ŒèŠ‚ç‚¹ç»„ä»¶<strong>æ•°ç»„</strong>ï¼Œä¸€æ¬¡ TraceSegment å¯ä»¥ç»è¿‡ä¸ªèŠ‚ç‚¹ç»„ä»¶ï¼Œä¾‹å¦‚ SpringMVC =&gt; MongoDB ã€‚</li><li><code>segmentId</code> å±æ€§ï¼ŒTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L65" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» EntrySpan ä¸­è§£æåˆ° <code>segmentId</code> ï¼Œ<code>applicationId</code> ï¼Œåˆ›å»º NodeComponent å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nodeComponents</code> ã€‚<strong>æ³¨æ„</strong>ï¼ŒEntrySpan ä½¿ç”¨ <code>applicationId</code> ä½œä¸º <code>peerId</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseExit(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» ExitSpan ä¸­è§£æåˆ° <code>segmentId</code> ï¼Œ<code>peerId</code> ï¼Œåˆ›å»º NodeComponent å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nodeComponents</code> ã€‚<strong>æ³¨æ„</strong>ï¼ŒExitSpan ä½¿ç”¨ <code>peerId</code> ä½œä¸º <code>peerId</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L78" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ° <code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/297c693e9e91200860a147ca41473f68d48d5955/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeComponentSpanListener.java#L83" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– NodeComponent å¯¹åº”çš„ <code>Graph&lt;NodeComponent&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>nodeComponents</code> æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(nodeComponent)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ NodeComponent åˆ°å­˜å‚¨å™¨ã€‚ </li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createNodeComponentGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NodeComponent å¯¹åº”çš„ <code>Graph&lt;NodeComponent&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeComponentAggregationWorker</code></a> ï¼Œç»§æ‰¿ AggregationWorker æŠ½è±¡ç±»ï¼ŒNodeComponent èšåˆ Worker ã€‚<ul><li>NodeComponent çš„ç¼–å·ç”Ÿæˆè§„åˆ™ä¸º <code>${timeBucket}_${componentId}_${peerId}</code> ï¼Œå¹¶ä¸” <code>timeBucket</code> æ˜¯<strong>åˆ†é’Ÿçº§</strong> ï¼Œå¯ä»¥ä½¿ç”¨ AggregationWorker è¿›è¡Œèšåˆï¼Œåˆå¹¶ç›¸åŒæ“ä½œï¼Œå‡å° Collector å’Œ ES çš„å‹åŠ›ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java#L40" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AggregationWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ3. AggregationWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 106 ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryRemoteWorker</code></a> ï¼Œç»§æ‰¿ AbstractRemoteWorker æŠ½è±¡ç±»ï¼Œåº”ç”¨æ³¨å†Œè¿œç¨‹ Worker ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java#L50" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractRemoteWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 AbstractRemoteWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AbstractRemoteWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 AbstractRemoteWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 10002 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#selector</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>Selector.HashCode</code> ã€‚å°†<strong>ç›¸åŒç¼–å·</strong>çš„ NodeComponent å‘ç»™åŒä¸€ä¸ª Collector èŠ‚ç‚¹ï¼Œç»Ÿä¸€å¤„ç†ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Remote è¿œç¨‹é€šä¿¡æœåŠ¡ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><p><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryPersistenceWorker</code></a> ï¼Œç»§æ‰¿ PersistenceWorker æŠ½è±¡ç±»ï¼ŒNodeComponent <strong>æ‰¹é‡</strong>ä¿å­˜ Worker ã€‚</p><ul><li>ç±»ä¼¼ GlobalTracePersistenceWorker ï¼Œâ€¦ çœç•¥å…¶å®ƒç±»å’Œæ–¹æ³•ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryPersistenceWorker.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>true</code> ï¼Œå­˜å‚¨æ—¶ï¼Œéœ€è¦åˆå¹¶æ•°æ®ã€‚</li></ul></li></ul><h1 id="7-NodeMapping"><a href="#7-NodeMapping" class="headerlink" title="7. NodeMapping"></a>7. NodeMapping</h1><p><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeComponent.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeComponent</code></a> ï¼ŒèŠ‚ç‚¹åŒ¹é…ï¼Œç”¨äºåŒ¹é…æœåŠ¡æ¶ˆè´¹è€…ä¸æä¾›è€…ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/node/NodeMappingTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.node.NodeMappingTable</code></a> ï¼Œ NodeMappingTable è¡¨( <code>node_mapping</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>application_id</code> ï¼šæœåŠ¡æ¶ˆè´¹è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>address_id</code> ï¼šæœåŠ¡æä¾›è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeMappingEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.NodeMappingEsPersistenceDAO</code></a> ï¼ŒNodeMapping çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/08.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingSpanListener</code></a> ï¼Œ<strong>NodeMapping çš„ SpanListener</strong> ï¼Œå®ç°äº† FirstSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeMappings</code> å±æ€§ï¼ŒèŠ‚ç‚¹åŒ¹é…<strong>æ•°ç»„</strong>ï¼Œä¸€æ¬¡ TraceSegment å¯ä»¥ç»è¿‡ä¸ªèŠ‚ç‚¹ç»„ä»¶ï¼Œä¾‹å¦‚è°ƒç”¨å¤šæ¬¡è¿œç¨‹æœåŠ¡ï¼Œæˆ–è€…æ•°æ®åº“ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» TraceSegmentRef ä¸­è§£æåˆ° <code>applicationId</code> ï¼Œ<code>peerId</code> ï¼Œåˆ›å»º NodeMapping å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nodeMappings</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ°<code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingSpanListener.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– NodeMapping å¯¹åº”çš„ <code>Graph&lt;NodeMapping&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>nodeMappings</code> æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(nodeMapping)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ NodeMapping åˆ°å­˜å‚¨å™¨ã€‚ </li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L120" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createNodeMappingGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NodeMapping å¯¹åº”çš„ <code>Graph&lt;NodeMapping&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/node/NodeMappingPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.node.NodeMappingPersistenceWorker</code></a></li></ul><h1 id="8-NodeReference"><a href="#8-NodeReference" class="headerlink" title="8. NodeReference"></a>8. NodeReference</h1><p><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/noderef/NodeReference.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.noderef.NodeReference</code></a> ï¼ŒèŠ‚ç‚¹è°ƒç”¨ç»Ÿè®¡ï¼Œç”¨äºè®°å½•æœåŠ¡æ¶ˆè´¹è€…å¯¹æœåŠ¡æä¾›è€…çš„è°ƒç”¨ï¼ŒåŸºäº<strong>åº”ç”¨</strong>çº§åˆ«çš„ï¼Œä»¥<strong>åˆ†é’Ÿ</strong>ä¸ºæ—¶é—´æœ€å°ç²’åº¦çš„èšåˆç»Ÿè®¡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/noderef/NodeReferenceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.noderef.NodeReference</code></a> ï¼Œ NodeReference è¡¨( <code>node_reference</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>front_application_id</code> ï¼šæœåŠ¡æ¶ˆè´¹è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>behind_application_id</code> ï¼šæœåŠ¡æä¾›è€…åº”ç”¨ç¼–å·ã€‚</li><li><code>s1_lte</code> ï¼š( 0, 1000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s3_lte</code> ï¼š( 1000, 3000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s5_lte</code> ï¼š( 3000, 5000ms ] çš„è°ƒç”¨æ¬¡æ•°</li><li><code>s5_gt</code> ï¼š( 5000, +âˆ ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>error</code> ï¼šå‘ç”Ÿå¼‚å¸¸çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>summary</code> ï¼šæ€»å…±çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/NodeReferenceEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.NodeReferenceEsPersistenceDAO</code></a> ï¼ŒNodeReference çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/09.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferenceSpanListener</code></a> ï¼Œ<strong>NodeReference çš„ SpanListener</strong> ï¼Œå®ç°äº† EntrySpanListener ã€ExitSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>references</code> å±æ€§ï¼Œ<strong>çˆ¶ TraceSegment</strong> è°ƒç”¨äº§ç”Ÿçš„ NodeReference æ•°ç»„ã€‚</li><li><code>nodeReferences</code> å±æ€§ï¼ŒNodeReference æ•°ç»„ï¼Œæœ€ç»ˆä¼šåŒ…å« <code>references</code> æ•°ç»„ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 106 è‡³ 109 è¡Œï¼šä½¿ç”¨çˆ¶ TraceSegment çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ç¼–å·ï¼Œè‡ªå·±çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æä¾›è€…</strong>åº”ç”¨ç¼–å·ï¼Œåˆ›å»º NodeReference å¯¹è±¡ã€‚</li><li>ç¬¬ 111 è¡Œï¼šå°† NodeReference å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>references</code> ã€‚<strong>æ³¨æ„</strong>ï¼Œæ˜¯ <code>references</code> ï¼Œè€Œä¸æ˜¯ <code>nodeReference</code> ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ä½œä¸ºæœåŠ¡æä¾›è€…ï¼Œ<strong>æ¥å—</strong>è°ƒç”¨ã€‚ </li><li>â€”â€”- <strong>çˆ¶ TraceSegment å­˜åœ¨</strong> â€”â€”â€“ </li><li>ç¬¬ 79 è‡³ 85 è¡Œï¼š<code>references</code> éç©ºï¼Œè¯´æ˜è¢«çˆ¶ TraceSegment è°ƒç”¨ã€‚å› æ­¤ï¼Œå¾ªç¯ <code>references</code> æ•°ç»„ï¼Œè®¾ç½® <code>id</code> ï¼Œ<code>timeBucket</code> å±æ€§( å› ä¸º <code>timeBucket</code> éœ€è¦ä» EntrySpan ä¸­è·å–ï¼Œæ‰€ä»¥ <code>#parseRef(...)</code> çš„ç›®çš„ï¼Œå°±æ˜¯ä¸´æ—¶å­˜å‚¨çˆ¶ TraceSegment çš„åº”ç”¨ç¼–å·åˆ° <code>references</code> ä¸­ )ã€‚ </li><li>ç¬¬ 87 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildserviceSum(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæ·»åŠ åˆ° <code>nodeReferences</code> ä¸­ã€‚</li><li>â€”â€”- <strong>çˆ¶ TraceSegment ä¸å­˜åœ¨</strong> â€”â€”â€“ </li><li>ç¬¬ 91 è‡³ 97 è¡Œï¼šä½¿ç”¨ <code>USER_ID</code> çš„åº”ç”¨ç¼–å·( ç‰¹æ®Šï¼Œä»£è¡¨ â€œ<strong>ç”¨æˆ·</strong>â€œ )ä½œä¸ºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ç¼–å·ï¼Œè‡ªå·±çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æä¾›è€…</strong>åº”ç”¨ç¼–å·ï¼Œåˆ›å»º NodeReference å¯¹è±¡ã€‚</li><li>ç¬¬ 99 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildserviceSum(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæ·»åŠ åˆ° <code>nodeReferences</code> ä¸­ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseExit(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ï¼Œ<strong>å‘èµ·</strong>è°ƒç”¨ã€‚  </li><li>ç¬¬ 64 è‡³ 71 è¡Œï¼šä½¿ç”¨è‡ªå·±çš„åº”ç”¨ç¼–å·ä½œä¸ºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ç¼–å·ï¼Œ<code>peerId</code> ä½œä¸ºæœåŠ¡<strong>æä¾›è€…</strong>åº”ç”¨ç¼–å·ï¼Œåˆ›å»º NodeReference å¯¹è±¡ã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildserviceSum(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæ·»åŠ åˆ° <code>nodeReferences</code> ä¸­ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceSpanListener.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 84 è¡Œï¼šè·å– NodeReference å¯¹åº”çš„ <code>Graph&lt;NodeReference&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 86 è‡³ 92 è¡Œï¼šå¾ªç¯ <code>nodeReferences</code> æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨ <code>Graph#start(nodeReference)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ NodeReference åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L131" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createNodeReferenceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NodeReference å¯¹åº”çš„ <code>Graph&lt;NodeReference&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferenceAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferenceRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferenceRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/noderef/NodeReferencePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.NodeReferencePersistenceWorker</code></a></li></ul><h1 id="9-ServiceEntry"><a href="#9-ServiceEntry" class="headerlink" title="9. ServiceEntry"></a>9. ServiceEntry</h1><p><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/service/ServiceEntry.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.service.ServiceEntry</code></a> ï¼Œå…¥å£æ“ä½œã€‚</p><ul><li>ServiceEntry <strong>åªä¿å­˜åˆ†å¸ƒå¼é“¾è·¯çš„å…¥å£æ“ä½œ</strong>ï¼Œä¸åŒäº ServiceName <strong>ä¿å­˜æ‰€æœ‰æ“ä½œ</strong>ï¼Œå³ ServiceEntry æ˜¯ ServiceName çš„<strong>å­é›†</strong>ã€‚<ul><li><strong>æ³¨æ„ï¼Œå­ TraceSegment çš„å…¥å£æ“ä½œä¹Ÿä¸è®°å½•</strong>ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/service/ServiceEntryTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.service.ServiceEntryTable</code></a> ï¼Œ ServiceEntry è¡¨( <code>service_entry</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>application_id</code> ï¼šåº”ç”¨ç¼–å·ã€‚</li><li><code>entry_service_id</code> ï¼šå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>entry_service_name</code> ï¼šå…¥å£æ“ä½œåã€‚</li><li><code>register_time</code> ï¼šæ³¨å†Œæ—¶é—´ã€‚</li><li><code>newest_time</code> ï¼šæœ€åè°ƒç”¨æ—¶é—´ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceEntryEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.ServiceEntryEsPersistenceDAO</code></a> ï¼ŒServiceEntry çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/10.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/112bcba1a7543e3c86fcbfb49718f7e4f3f4638f/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntrySpanListener</code></a> ï¼Œ<strong>ServiceEntry çš„ SpanListener</strong> ï¼Œå®ç°äº† EntrySpanListener ã€FirstSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>hasReference</code> å±æ€§ï¼Œ æ˜¯å¦æœ‰ TraceSegmentRef ã€‚</li><li><code>applicationId</code> å±æ€§ï¼Œåº”ç”¨ç¼–å·ã€‚</li><li><code>entryServiceId</code> å±æ€§ï¼Œå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>entryServiceName</code> å±æ€§ï¼Œå…¥å£æ“ä½œåã€‚</li><li><code>hasEntry</code> å±æ€§ï¼Œæ˜¯å¦æœ‰ EntrySpan ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œæ˜¯å¦æœ‰ TraceSegmentRef ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ° <code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» EntrySpan ä¸­è§£æåˆ° <code>applicationId</code> ã€<code>entryServiceId</code> ã€<code>entryServiceName</code> ã€<code>hasEntry</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d8e7d053381e7317d413188c4248be1dacf4e85a/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntrySpanListener.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 96 è¡Œï¼šåªä¿å­˜åˆ†å¸ƒå¼é“¾è·¯çš„å…¥å£æ“ä½œã€‚</li><li>ç¬¬ 98 è‡³ 103 è¡Œï¼šåˆ›å»º ServiceEntry å¯¹è±¡ã€‚</li><li>ç¬¬ 107 è¡Œï¼šè·å– ServiceEntry å¯¹åº”çš„ <code>Graph&lt;ServiceEntry&gt;</code> å¯¹è±¡ã€‚</li><li>ç¬¬ 108 è¡Œï¼šè°ƒç”¨ <code>Graph#start(serviceEntry)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜ ServiceEntry åˆ°å­˜å‚¨å™¨ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L142" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createServiceEntryGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ServiceEntry å¯¹åº”çš„ <code>Graph&lt;ServiceEntry&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/service/ServiceEntryPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.service.ServiceEntryPersistenceWorker</code></a></li></ul><h1 id="10-ServiceReference"><a href="#10-ServiceReference" class="headerlink" title="10. ServiceReference"></a>10. ServiceReference</h1><p><a href="https://github.com/YunaiV/skywalking/blob/288d70975ed1c5f1ecfb7d51e2233ec75ad8d12a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/serviceref/ServiceReference.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.serviceref.ServiceReference</code></a> ï¼Œå…¥å£æ“ä½œè°ƒç”¨ç»Ÿè®¡ï¼Œç”¨äºè®°å½•å…¥å£æ“ä½œçš„è°ƒç”¨ï¼ŒåŸºäº<strong>å…¥å£æ“ä½œ</strong>çº§åˆ«çš„ï¼Œä»¥<strong>åˆ†é’Ÿ</strong>ä¸ºæ—¶é—´æœ€å°ç²’åº¦çš„èšåˆç»Ÿè®¡ã€‚</p><ul><li>å’Œ NodeReference ç±»ä¼¼ã€‚</li><li><strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„çš„ â€œ<strong>å…¥å£æ“ä½œ</strong>â€œ ä¸åŒäº ServiceEntry ï¼Œ<strong>åŒ…å«</strong>æ¯ä¸€æ¡ TraceSegment çš„å…¥å£æ“ä½œã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/288d70975ed1c5f1ecfb7d51e2233ec75ad8d12a/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/serviceref/ServiceReferenceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.serviceref.ServiceReferenceTable</code></a> ï¼Œ ServiceReference è¡¨( <code>service_reference</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>entry_service_id</code> ï¼šå…¥å£æ“ä½œç¼–å·ã€‚ </li><li><code>front_service_id</code> ï¼šæœåŠ¡æ¶ˆè´¹è€…æ“ä½œç¼–å·ã€‚</li><li><code>behind_service_id</code> ï¼šæœåŠ¡æä¾›è€…æ“ä½œç¼–å·ã€‚</li><li><code>s1_lte</code> ï¼š( 0, 1000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s3_lte</code> ï¼š( 1000, 3000 ms ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>s5_lte</code> ï¼š( 3000, 5000ms ] çš„è°ƒç”¨æ¬¡æ•°</li><li><code>s5_gt</code> ï¼š( 5000, +âˆ ] çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>error</code> ï¼šå‘ç”Ÿå¼‚å¸¸çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>summary</code> ï¼šæ€»å…±çš„è°ƒç”¨æ¬¡æ•°ã€‚</li><li><code>cost_summary</code> ï¼šæ€»å…±çš„èŠ±è´¹æ—¶é—´ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceReference.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.ServiceReference</code></a> ï¼ŒServiceReference çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/11.png" alt=""></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.ServiceReferenceSpanListener</code></a> ï¼Œ<strong>ServiceReference çš„ SpanListener</strong> ï¼Œå®ç°äº† EntrySpanListener ã€FirstSpanListener ã€RefsListener æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>referenceServices</code> å±æ€§ï¼ŒReferenceDecorator æ•°ç»„ï¼Œè®°å½• TraceSegmentRef æ•°ç»„ã€‚</li><li><code>serviceId</code> å±æ€§ï¼Œå…¥å£æ“ä½œç¼–å·ã€‚</li><li><code>startTime</code> å±æ€§ï¼Œå¼€å§‹æ—¶é—´ã€‚</li><li><code>endTime</code> å±æ€§ï¼Œç»“æŸæ—¶é—´ã€‚</li><li><code>isError</code> å±æ€§ï¼Œæ˜¯å¦æœ‰é”™è¯¯ã€‚</li><li><code>hasEntry</code> å±æ€§ï¼Œæ˜¯å¦æœ‰ SpanEntry ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseRef(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œå°† TraceSegmentRef æ·»åŠ åˆ° <code>referenceServices</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseFirst(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä»<strong>é¦–ä¸ª</strong> Span ä¸­è§£æåˆ° <code>timeBucket</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#parseEntry(SpanDecorator, applicationId, instanceId, segmentId)</code></a> æ–¹æ³•ï¼Œä» EntrySpan ä¸­è§£æ <code>serviceId</code> ã€<code>startTime</code> ã€<code>endTime</code> ã€<code>isError</code> ã€<code>hasEntry</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L112" rel="external nofollow noopener noreferrer" target="_blank"><code>#build()</code></a> æ–¹æ³•ï¼Œæ„å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 114 è¡Œï¼šåˆ¤æ–­ <code>hasEntry = true</code> ï¼Œå­˜åœ¨ EntrySpan ã€‚</li><li>â€”â€”â€” <strong>æœ‰ TraceSegmentRef</strong> â€”â€”â€”</li><li>ç¬¬ 117 è‡³ 120 è¡Œï¼šåˆ›å»º ServiceReference å¯¹è±¡ï¼Œå…¶ä¸­ï¼š<ul><li><code>entryServiceId</code> ï¼šTraceSegmentRef çš„å…¥å£ç¼–å·ã€‚</li><li><code>frontServiceId</code> ï¼šTraceSegmentRef çš„æ“ä½œç¼–å·ã€‚</li><li><code>behindServiceId</code> ï¼š è‡ªå·± EntrySpan çš„æ“ä½œç¼–å·ã€‚</li></ul></li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#calculateCost(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ã€‚</li><li>ç¬¬ 126 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L141" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToAggregationWorker(...)</code></a> æ–¹æ³•ï¼Œå‘é€ ServiceReference ç»™ AggregationWorker ï¼Œæ‰§è¡Œæµå¼å¤„ç†ã€‚</li><li>â€”â€”â€” <strong>æ—  TraceSegmentRef</strong> â€”â€”â€”</li><li>ç¬¬ 117 è‡³ 120 è¡Œï¼šåˆ›å»º ServiceReference å¯¹è±¡ï¼Œå…¶ä¸­ï¼š<ul><li><code>entryServiceId</code> ï¼šè‡ªå·± EntrySpan çš„æ“ä½œç¼–å·ã€‚</li><li><code>frontServiceId</code> ï¼š<code>Const.NONE_SERVICE_ID</code> å¯¹åº”çš„æ“ä½œç¼–å·( ç³»ç»Ÿå†…ç½®ï¼Œä»£è¡¨ã€ç©ºã€‘ )ã€‚</li><li><code>behindServiceId</code> ï¼š è‡ªå·± EntrySpan çš„æ“ä½œç¼–å·ã€‚</li></ul></li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#calculateCost(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨æ¬¡æ•°ã€‚</li><li>ç¬¬ 126 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/33a9634fff31a299b0baab5ffba603a58d6ff371/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceSpanListener.java#L141" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToAggregationWorker(...)</code></a> æ–¹æ³•ï¼Œå‘é€ ServiceReference ç»™ AggregationWorker ï¼Œæ‰§è¡Œæµå¼å¤„ç†ã€‚</li></ul></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L153" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createServiceReferenceGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ServiceReference å¯¹åº”çš„ <code>Graph&lt;ServiceReference&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li>å’Œ NodeComponent çš„ <code>Graph&lt;NodeComponent&gt;</code> åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æºç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceAggregationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.ServiceEntryAggregationWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferenceRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.ServiceEntryRemoteWorker</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/serviceref/ServiceReferencePersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.noderef.ServiceEntryPersistenceWorker</code></a></li></ul><h1 id="11-Segment"><a href="#11-Segment" class="headerlink" title="11. Segment"></a>11. Segment</h1><p>ä¸åŒäºä¸Šè¿°æ‰€æœ‰æ•°æ®å®ä½“ï¼ŒSegment æ— éœ€<strong>è§£æ</strong>ï¼Œç›´æ¥ä½¿ç”¨ TraceSegment æ„å»ºï¼Œå‚è§å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentParse#parse(UpstreamSegment, Source)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0f8c38a8a35cbda777fa9a9bc5f51c8651ae4051/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L177" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentParse#buildSegment(id, dataBinary)</code></a></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/global/GlobalTrace.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.segment.Segment</code></a> ï¼Œå…¨å±€é“¾è·¯è¿½è¸ªï¼Œè®°å½•ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ŒåŒ…æ‹¬çš„ TraceSegment ç¼–å·ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/25a830d4fed13ee2d62adb7ad7b35ada436bd6f6/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/segment/Segment.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.global.GlobalTraceTable</code></a> ï¼Œ Segment è¡¨( <code>segment</code> )ã€‚å­—æ®µå¦‚ä¸‹ï¼š<ul><li><code>_id</code> ï¼šTraceSegment ç¼–å·ã€‚</li><li><code>data_binary</code> ï¼šTraceSegment é“¾è·¯ç¼–å·ã€‚</li><li><code>time_bucket</code> ï¼šæ—¶é—´( <code>yyyyMMddHHmm</code> )ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/3d1d1f5219205d38f58f1b59f0e81d81c038d2f1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/SegmentEsPersistenceDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.SegmentEsPersistenceDAO</code></a> ï¼ŒGlobalTrace çš„ EsDAO ã€‚</li><li>åœ¨ ES å­˜å‚¨ä¾‹å­å¦‚ä¸‹å›¾ï¼š <img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/12.png" alt=""></li></ul><hr><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/52e41bc200857d2eb1b285d046cb9d2dd646fb7b/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L164" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createSegmentGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Segment å¯¹åº”çš„ <code>Graph&lt;Segment&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ee9400fc51d6ae21b1053bb0d8cca7ad4d51efe5/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/segment/SegmentPersistenceWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.trace.segment.SegmentPersistenceWorker</code></a></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æŠ±æ­‰ï¼Œæœ¬æ–‡å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›é”™è¯¯æˆ–è€…ç»†èŠ‚æ²¡æœ‰æ‰£åˆ°ï¼Œçƒ¦è¯·è§è°…ã€‚<br>èƒ–å‹å¦‚æœæœ‰ç–‘æƒ‘ï¼Œè¯·ç»™æˆ‘çš„å…¬ä¼—å·ç•™è¨€ï¼Œä¸€èµ·æ¢è®¨ã€‚</p><p>å¤§é‡ç±»ä¼¼çš„å†…å®¹ï¼Œç¬”è€…ä¸€å¤©éƒ½å¤„äºæ˜æ˜æ²‰æ²‰çš„çŠ¶æ€ï¼Œä¸­é—´æœ‰ä¸€å—ä¸å°å¿ƒæ›¿æ¢é”™è¯¯ï¼Œå®åœ¨æ˜¯è‹¦é—·è€Œåˆå‡ åˆ†æ¯ç‡¥ï¼Œä¸å¾—ä¸ä½©æœ SkyWalking å¼€å‘è€…çš„è€å¿ƒã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_15/13.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/collector-store-trace/&quot;&gt;http://www.iocoder.cn/SkyWalking/collector-store-trace/&lt;/a&gt; ã€ŒèŠ‹
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector æ¥æ”¶ Trace æ•°æ®</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-receive-trace/</id>
    <published>2020-10-09T16:00:00.000Z</published>
    <updated>2018-01-04T15:10:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">http://www.iocoder.cn/SkyWalking/collector-receive-trace/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2. TraceSegmentServiceHandler</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2.1 TraceSegmentService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2.2 SegmentParse</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">2.3 Standardization æ ‡å‡†åŒ–</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3. Buffer æ–‡ä»¶</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3.1 åˆå§‹åŒ–</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3.2 å†™å…¥</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">3.3 è¯»å–</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-receive-trace/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œé“¾è·¯çš„è¿½è¸ªå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Agent æ”¶é›† Trace æ•°æ®ã€‚</li><li>Agent å‘é€ Trace æ•°æ®ç»™ Collector ã€‚</li><li><strong>Collector æ¥æ”¶ Trace æ•°æ®</strong>ã€‚</li><li>Collector å­˜å‚¨ Trace æ•°æ®åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼Œæ•°æ®åº“ã€‚</li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†äº«ã€ç¬¬ä¸‰éƒ¨åˆ†ã€‘ <strong>SkyWalking Collector æ¥æ”¶ Trace æ•°æ®</strong>ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šCollector æ¥æ”¶åˆ° TraceSegment çš„æ•°æ®ï¼Œå¯¹åº”çš„ç±»æ˜¯ Protobuf ç”Ÿæˆçš„ã€‚è€ƒè™‘åˆ°æ›´åŠ æ˜“è¯»æ˜“æ‡‚ï¼Œæœ¬æ–‡ä½¿ç”¨ TraceSegment ç›¸å…³çš„<strong>åŸå§‹ç±»</strong>ã€‚</p></blockquote><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/01.png" alt=""></p><ul><li>Collector æ¥æ”¶åˆ° TraceSegment æ•°æ®åï¼Œè¿›è¡Œ<strong>æ„å»º</strong>ã€‚</li><li>ã€è“è‰²æµç¨‹ã€‘æ„å»º<strong>æˆåŠŸ</strong>ï¼Œè¿›è¡Œæµå¼å¤„ç†ï¼Œæœ€ç»ˆå­˜å‚¨åˆ°å­˜å‚¨å™¨( ä¾‹å¦‚ï¼ŒES / H2 )ã€‚</li><li>ã€ç²‰è‰²æµç¨‹ã€‘æ„å»º<strong>å¤±è´¥</strong>ï¼Œå†™å…¥ Buffer æ–‡ä»¶è¿›è¡Œæš‚å­˜ã€‚</li><li>ã€ç»¿è‰²æµç¨‹ã€‘åå°çº¿ç¨‹ï¼Œå®šæ—¶è¯»å– Buffer æ–‡ä»¶ï¼Œé‡æ–°æäº¤æ„å»ºã€‚</li></ul><p><strong>ä»€ä¹ˆæ˜¯æ„å»º</strong>ï¼Ÿ</p><p>ä» TraceSegment <strong>æ•°æ®</strong>ä¸­ï¼Œä¼šæ„å»ºå‡ºæ›´å¤šçš„<strong>æ•°æ®ç»´åº¦</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/02.png" alt=""></p><p>æ„å»ºçš„è¿‡ç¨‹ï¼Œæœ¬æ–‡åªåˆ†äº«<strong>è°ƒç”¨</strong>çš„è¿‡ç¨‹ï¼Œå…·ä½“æ€ä¹ˆ<strong>ç”Ÿæˆ</strong>æ–°çš„æ•°æ®ï¼Œæ•°æ®çš„<strong>æµå¼å¤„ç†ä¸å­˜å‚¨</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/?self">ã€ŠSkyWalking æºç è§£æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®ã€‹</a> è¯¦ç»†è§£æã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ„å»ºä¼šå¤±è´¥</strong>ï¼Ÿ</p><p>åœ¨ TraceSegment é‡Œçš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚æ“ä½œå( <code>operationName</code> )å’Œæ“ä½œç¼–å·( <code>operationId</code> ) ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®ã€‹</a> ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè€ƒè™‘åˆ°ç½‘ç»œä¼ è¾“ï¼Œä¼˜å…ˆä½¿ç”¨ <code>operationId</code> ï¼Œè‹¥ä¸å­˜åœ¨( ä¾‹å¦‚æ“ä½œè¿˜æœªæ³¨å†Œï¼Œæˆ–è€…æ³¨å†Œäº† Agent æœªåŒæ­¥åˆ°æœ¬åœ° )ï¼Œåˆ™ä½¿ç”¨ <code>operationName</code> ã€‚</p><p>ä½†æ˜¯ï¼ŒCollector æ„å»ºè¿‡ç¨‹æ—¶ï¼Œè¦æ±‚çš„æ˜¯ <code>operationId</code> ï¼Œå¦‚æœä¼ é€’çš„æ˜¯ <code>operationName</code> æ—¶ï¼Œéœ€è¦å°† <code>operationName</code> è½¬æ¢æˆ <code>operationId</code> ã€‚è‹¥æ­¤æ—¶ <code>operationName</code> æœªæ³¨å†Œæ—¶ï¼Œåˆ™æ— æ³•è·å–åˆ° <code>operationId</code> ï¼Œå¯¼è‡´<strong>æ„å»ºå¤±è´¥</strong>ã€‚</p><p>é‚£ä¹ˆæœ‰èƒ–å‹å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œåœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæ³¨å†Œ <code>operationName</code> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œ<br>åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent DictionaryManager å­—å…¸ç®¡ç†ã€‹ã€Œ2.2 æ“ä½œçš„åŒæ­¥ APIã€</a> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>operationName</code> çš„æ³¨å†Œï¼Œæ˜¯<strong>å¼‚æ­¥</strong>çš„è¿‡ç¨‹ã€‚å› è€Œï¼Œå³ä½¿æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨æ³¨å†Œï¼Œä¹Ÿæ— æ³•è·å¾— <code>operationId</code> ã€‚</p><p>æ¶‰åŠçš„é€»è¾‘ç‚¹æ¯”è¾ƒå¤šï¼Œå¦‚æœèƒ–å‹ç†è§£ä¸èƒ½ï¼Œä¸‹é¢æˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹ä»£ç ã€‚</p><h1 id="2-TraceSegmentServiceHandler"><a href="#2-TraceSegmentServiceHandler" class="headerlink" title="2. TraceSegmentServiceHandler"></a>2. TraceSegmentServiceHandler</h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-network/src/main/proto/TraceSegmentService.proto#L9" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentService.proto</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/03.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/TraceSegmentServiceHandler.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentServiceHandler#collect(Application, StreamObserver&lt;ApplicationMapping&gt;)</code></a>, ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 51 è¡Œï¼šè°ƒç”¨ <code>ITraceSegmentService#send(UpstreamSegment)</code> æ–¹æ³•ï¼Œå¤„ç†<strong>ä¸€æ¡</strong> TraceSegment ã€‚</li></ul><h2 id="2-1-TraceSegmentService"><a href="#2-1-TraceSegmentService" class="headerlink" title="2.1 TraceSegmentService"></a>2.1 TraceSegmentService</h2><p><code>org.skywalking.apm.collector.agent.stream.service.trace.ITraceSegmentService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼ŒTraceSegment æœåŠ¡æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-define/src/main/java/org/skywalking/apm/collector/agent/stream/service/trace/ITraceSegmentService.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#send(UpstreamSegment)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå¤„ç†<strong>ä¸€æ¡</strong> TraceSegment ã€‚</li></ul><p><code>org.skywalking.apm.collector.agent.stream.worker.trace.ApplicationIDService</code> ï¼Œå®ç° IApplicationIDService æ¥å£ï¼ŒTraceSegment æœåŠ¡å®ç°ç±»ã€‚</p><ul><li><p>å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/trace/TraceSegmentService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#send(UpstreamSegment)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 40 è‡³ 41 è¡Œï¼šåˆ›å»º SegmentParse å¯¹è±¡ï¼Œåè°ƒç”¨ <code>SegmentParse#parse(UpstreamSegment, Source)</code> æ–¹æ³•ï¼Œè§£æå¹¶å¤„ç† TraceSegment ã€‚</li></ul></li></ul><h2 id="2-2-SegmentParse"><a href="#2-2-SegmentParse" class="headerlink" title="2.2 SegmentParse"></a>2.2 SegmentParse</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.SegmentParse</code></a> ï¼ŒSegment è§£æå™¨ã€‚å±æ€§å¦‚ä¸‹ï¼š</p><ul><li><code>spanListeners</code> å±æ€§ï¼ŒSpan ç›‘å¬å™¨é›†åˆã€‚<strong>é€šè¿‡ä¸åŒçš„ç›‘å¬å™¨ï¼Œå¯¹ TraceSegment è¿›è¡Œæ„å»ºï¼Œç”Ÿæˆä¸åŒçš„æ•°æ®</strong>ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#SegmentParse(ModuleManager)</code> æ„é€ æ–¹æ³•</a> ï¼Œä¼šçœ‹åˆ°å®ƒçš„åˆå§‹åŒ–ã€‚</li><li><code>segmentId</code> å±æ€§ï¼ŒTraceSegment ç¼–å·ï¼Œå³ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.traceSegmentId</code></a> ã€‚</li><li><code>timeBucket</code> å±æ€§ï¼Œç¬¬ä¸€ä¸ª Span çš„å¼€å§‹æ—¶é—´ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>#parse(UpstreamSegment, Source)</code></a> æ–¹æ³•ï¼Œè§£æå¹¶å¤„ç† TraceSegment ã€‚åœ¨è¯¥æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œæœ¬æ–‡å¼€å¤´æåˆ°çš„ã€<strong>æ„é€ </strong>ã€‘ã€‚æ•´ä¸ªæ„é€ çš„è¿‡ç¨‹ï¼Œå®é™…åˆ†æˆ<strong>ä¸¤æ­¥</strong>ï¼š1ï¼‰é¢„æ„å»ºï¼›2ï¼‰æ‰§è¡Œæ„å»ºã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 88 è‡³ 89 è¡Œï¼šä» <code>segment</code> å‚æ•°ä¸­ï¼Œè§£æå‡º ï¼š<ul><li><code>traceIds</code> ï¼Œå…³è”çš„é“¾è·¯è¿½è¸ª<strong>å…¨å±€ç¼–å·</strong>ã€‚</li><li><code>segmentObject</code> ï¼ŒTraceSegmentObject å¯¹è±¡ã€‚</li></ul></li><li>ç¬¬ 91 è¡Œï¼šåˆ›å»º SegmentDecorator å¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„ç”¨é€”ï¼Œåœ¨ <a href="#">ã€Œ2.3 Standardization æ ‡å‡†åŒ–ã€</a> ç»Ÿä¸€è§£æã€‚</li><li>â€”â€”â€“ æ„å»ºå¤±è´¥ â€”â€”â€“</li><li>ç¬¬ 94 è¡Œï¼šè°ƒç”¨ <code>#preBuild(List&lt;UniqueId&gt;, SegmentDecorator)</code> æ–¹æ³•ï¼Œ<strong>é¢„æ„å»º</strong>ã€‚</li><li>ç¬¬ 97 è‡³ 99 è¡Œï¼šè°ƒç”¨ <code>#writeToBufferFile()</code> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Buffer æ–‡ä»¶<strong>æš‚å­˜</strong>ã€‚ä¸ºä»€ä¹ˆä¼šåˆ¤æ–­ <code>source == Source.Agent</code> å‘¢ï¼Ÿ<code>#parse(UpstreamSegment, Source)</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œå…±æœ‰<strong>ä¸¤ä¸ª</strong> <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L256" rel="external nofollow noopener noreferrer" target="_blank">Source</a> ï¼š<ul><li>ç›®å‰æˆ‘ä»¬çœ‹åˆ° TraceSegmentService çš„è°ƒç”¨ä½¿ç”¨çš„æ˜¯ <code>Source.Agent</code> ã€‚</li><li>è€Œåå°çº¿ç¨‹ï¼Œå®šæ—¶è°ƒç”¨è¯¥æ–¹æ³•é‡æ–°æ„å»ºä½¿ç”¨çš„æ˜¯ <code>Source.Buffer</code> ï¼Œå¦‚æœä¸åŠ ç›–åˆ¤æ–­ï¼Œä¼šé¢„æ„å»ºå¤±è´¥<strong>é‡å¤</strong>å†™å…¥ã€‚</li></ul></li><li>ç¬¬ 100 è¡Œï¼šè¿”å› <code>false</code> ï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥ã€‚</li><li>â€”â€”â€“ æ„å»ºæˆåŠŸ â€”â€”â€“</li><li>ç¬¬ 106 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L199" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyListenerToBuild()</code></a> æ–¹æ³•ï¼Œé€šçŸ¥ Span ç›‘å¬å™¨ä»¬ï¼Œ<strong>æ‰§è¡Œæ„å»º</strong>å„è‡ªçš„æ•°æ®ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-store-trace/?self">ã€ŠSkyWalking æºç è§£æ â€”â€” Collector å­˜å‚¨ Trace æ•°æ®ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 109 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L177" rel="external nofollow noopener noreferrer" target="_blank"><code>buildSegment(id, dataBinary)</code></a> æ–¹æ³•ï¼Œ<strong>æ‰§è¡Œæ„å»º</strong> TraceSegment ã€‚</li><li>ç¬¬ 110 è¡Œï¼šè¿”å› <code>true</code> ï¼Œè¡¨ç¤ºæ„å»ºæˆåŠŸã€‚</li><li>ç¬¬ 112 è‡³ 115 è¡Œï¼šå‘ç”Ÿ InvalidProtocolBufferException å¼‚å¸¸ï¼Œè¿”å› <code>false</code> ï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥ã€‚</li></ul><h3 id="2-2-1-é¢„æ„å»º"><a href="#2-2-1-é¢„æ„å»º" class="headerlink" title="2.2.1 é¢„æ„å»º"></a>2.2.1 é¢„æ„å»º</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>#preBuild(List&lt;UniqueId&gt;, SegmentDecorator)</code></a> æ–¹æ³•ï¼Œå‰ç½®æ„å»ºï¼Œç”¨äº<strong>é€šè¿‡ä¸åŒçš„ç›‘å¬å™¨ï¼Œå¯¹ TraceSegment è¿›è¡Œæ„å»ºï¼Œç”Ÿæˆä¸åŒçš„æ•°æ®</strong>ã€‚åœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”Ÿæˆ‘ä»¬åœ¨æ–‡ç« å¤´æ‰€è¯´çš„ï¼Œâ€<strong>ä¸ºä»€ä¹ˆæ„å»ºä¼šå¤±è´¥</strong>â€œã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 120 è‡³ 128 è¡Œï¼šæ‹¼æ¥ç”Ÿæˆ <code>segmentId</code> ã€‚</li><li>ç¬¬ 131 è‡³ 133 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L132" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyGlobalsListener(...)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨ GlobalTraceSpanListener å¤„ç†é“¾è·¯è¿½è¸ªå…¨å±€ç¼–å·æ•°ç»„( <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.relatedGlobalTraces</code></a> )ã€‚</li><li>ç¬¬ 139 è‡³ 147 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L239" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyRefsListener(...)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨ RefsListener å¤„ç†çˆ¶ Segment æŒ‡å‘æ•°ç»„( <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.refs</code></a> )ã€‚<ul><li>ç¬¬ 140 è‡³ 144 è¡Œï¼šè°ƒç”¨ <code>ReferenceIdExchanger#exchange(ReferenceDecorator, applicationId)</code> æ–¹æ³•ï¼Œå°† TraceSegmentRef æœªç”Ÿæˆç¼–å·çš„å±æ€§ï¼Œè¿›è¡Œå…‘æ¢å¤„ç†ã€‚<strong>è‹¥å…‘æ¢å¤±è´¥ï¼Œè¿”å›æ„é€ å¤±è´¥</strong>ã€‚åœ¨ <a href="#">ã€Œ2.3 Standardization æ ‡å‡†åŒ–ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 149 è‡³ 172 è¡Œï¼šå¤„ç† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment.spans</code></a> å±æ€§ã€‚<ul><li>ç¬¬ 150 è‡³ 154 è¡Œï¼šå°† Span æœªç”Ÿæˆç¼–å·çš„å±æ€§ï¼Œè¿›è¡Œå…‘æ¢å¤„ç†ã€‚<strong>è‹¥å…‘æ¢å¤±è´¥ï¼Œè¿”å›æ„é€ å¤±è´¥</strong>ã€‚åœ¨ <a href="#">ã€Œ2.3 Standardization æ ‡å‡†åŒ–ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 157 è‡³ 160 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L230" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyFirstListener(...)</code></a> ï¼Œä½¿ç”¨ FirstSpanListener å¤„ç†<strong>ç¬¬ä¸€ä¸ª</strong> Span ã€‚</li><li>ç¬¬ 164 è¡Œï¼šè‹¥æ˜¯ ExitSpan ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L230" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyExitListener(...)</code></a> ï¼Œä½¿ç”¨ ExitSpanListener å¤„ç†ã€‚</li><li>ç¬¬ 166 è¡Œï¼šè‹¥æ˜¯ EntrySpan ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L212" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyEntryListener(...)</code></a> ï¼Œä½¿ç”¨ EntrySpanListener å¤„ç†ã€‚</li><li>ç¬¬ 168 è¡Œï¼šè‹¥æ˜¯ LocalSpan ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L221" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyLocalListener(...)</code></a> ï¼Œä½¿ç”¨ LocalSpanListener å¤„ç†ã€‚</li></ul></li><li>ç¬¬ 174 è¡Œï¼šè¿”å› <code>true</code> ï¼Œ<strong>é¢„æ„å»ºæˆåŠŸ</strong>ã€‚</li></ul><h3 id="2-2-2-å†™å…¥-Buffer-æ–‡ä»¶"><a href="#2-2-2-å†™å…¥-Buffer-æ–‡ä»¶" class="headerlink" title="2.2.2 å†™å…¥ Buffer æ–‡ä»¶"></a>2.2.2 å†™å…¥ Buffer æ–‡ä»¶</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/SegmentParse.java#L191" rel="external nofollow noopener noreferrer" target="_blank"><code>#writeToBufferFile(id, upstreamSegment)</code></a> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Buffer æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 193 è¡Œï¼šåˆ›å»º 193 è‡³ 194 è¡Œï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardization.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.standardization.SegmentStandardization</code></a> å¯¹è±¡ï¼Œå¹¶è®¾ç½® TraceSegment å±æ€§ã€‚</li><li>ç¬¬ 195 è¡Œï¼šè·å¾— <code>TraceStreamGraph.SEGMENT_STANDARDIZATION_GRAPH_ID</code> å¯¹è±¡çš„ Graph å¯¹è±¡ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceStreamGraph#createSegmentStandardizationGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ Graph å¯¹è±¡åªæœ‰ä¸€ä¸ª SegmentStandardizationWorker ã€‚</li><li>ç¬¬ 196 è¡Œï¼šè°ƒç”¨ <code>Graph#start(INPUT)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>è¯¥ Graph å®ç°çš„</strong>æµå¼å¤„ç†ï¼Œå°† TraceSegment å†™åˆ° Buffer æ–‡ä»¶ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.parser.standardization.SegmentStandardizationWorker</code></a> ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼ŒTraceSegment æ ‡å‡†åŒ– Worker ï¼Œè´Ÿè´£å°†æ¥æ”¶åˆ°çš„ TraceSegment <strong>å¼‚æ­¥</strong>å†™åˆ° Buffer æ–‡ä»¶ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L59" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AbstractLocalAsyncWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 108 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork(SegmentStandardization)</code></a> å®ç°æ–¹æ³•ï¼Œå°†æ¥æ”¶åˆ°çš„ TraceSegment <strong>å¼‚æ­¥</strong>å†™åˆ° Buffer æ–‡ä»¶ã€‚ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 52 è¡Œï¼šè°ƒç”¨ <code>SegmentBufferManager#writeBuffer(UpstreamSegment)</code> æ–¹æ³•ï¼Œå°†æ¥æ”¶åˆ°çš„ TraceSegment å†™åˆ° Buffer æ–‡ä»¶ã€‚åœ¨ <a href="#">ã€Œ3. Buffer æ–‡ä»¶ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L65" rel="external nofollow noopener noreferrer" target="_blank"><code>Factory#workerInstance(ModuleManager)</code></a> æ–¹æ³•ï¼Œåˆ›å»º SegmentStandardizationWorker åï¼Œä¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#startTimer(SegmentStandardizationWorker)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚è¯¥å®šæ—¶ä»»åŠ¡è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentStandardizationWorker.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#flushAndSwitch()</code></a> æ–¹æ³•ï¼Œå®šæ—¶å°† Buffer æ–‡ä»¶ flush ã€‚ç›®å‰ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L139" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferManager#flush()</code></a> æ˜¯ä¸ªç©ºæ–¹æ³•ã€‚ä¸ºä»€ä¹ˆä¸è¿™é‡Œä¸éœ€è¦ flush å‘¢ï¼Ÿå› ä¸º <code>SegmentBufferManager#writeBuffer(UpstreamSegment)</code> <strong>å·²ç»è¿›è¡Œ flush</strong> ã€‚</li></ul><h2 id="2-3-Standardization-æ ‡å‡†åŒ–"><a href="#2-3-Standardization-æ ‡å‡†åŒ–" class="headerlink" title="2.3 Standardization æ ‡å‡†åŒ–"></a>2.3 Standardization æ ‡å‡†åŒ–</h2><p>æœ¬å°èŠ‚æ¶‰åŠåˆ°çš„ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/04.png" alt=""></p><p>æˆ‘ä»¬å…ˆæ¥è¯´è¯´ï¼Œä»€ä¹ˆå« standardization <strong>æ ‡å‡†åŒ–</strong>ï¼Ÿå…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨æ–‡ç« å¼€å¤´è¯´çš„â€<strong>ä¾‹å¦‚å°†</strong> <code>operationName</code> <strong>è½¬æ¢æˆ</strong> <code>operationId</code>â€œã€‚</p><h3 id="2-3-1-StandardBuilder"><a href="#2-3-1-StandardBuilder" class="headerlink" title="2.3.1 StandardBuilder"></a>2.3.1 StandardBuilder</h3><p><code>org.skywalking.apm.collector.agent.stream.parser.standardization.StandardBuilder</code> ï¼Œæ ‡å‡†åŒ– Builder æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/StandardBuilder.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#toBuilder()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè½¬æ¢æˆ Builder ã€‚æ„Ÿè§‰è¿™ä¸ªæ¥å£æ–¹æ³•<strong>æ€ªæ€ªçš„</strong>ï¼Ÿä¸è¦æ‰æ€¥ï¼Œç­‰ä¼šçœ‹ä¸€ä¸ªå®ç°ç±»å°±æ˜ç™½äº†ã€‚</li></ul><p>StandardBuilder æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SegmentDecorator.java" rel="external nofollow noopener noreferrer" target="_blank">SegmentDecorator</a> ï¼ŒTraceSegment è£…é¥°è€…ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/ReferenceDecorator.java" rel="external nofollow noopener noreferrer" target="_blank">ReferenceDecorator</a> ï¼ŒReferenceDecorator è£…é¥°è€…ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java" rel="external nofollow noopener noreferrer" target="_blank">SpanDecorator</a> ï¼ŒSpan è£…é¥°è€…ã€‚</li></ul><p>æ€ä¹ˆéƒ½æ˜¯<strong>è£…é¥°è€…</strong>å‘¢ï¼Œè€Œä¸”æ°å¥½å’Œä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åº”ï¼Ÿä»¥ SpanDecorator ä¸ºä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>spanObject</code> å±æ€§ï¼ŒSpanObject ï¼ŒSpan çš„ Protobuf æ•°æ®å¯¹è±¡ã€‚</li><li><code>standardBuilder</code> å±æ€§ï¼ŒSpanObject çš„ Builder å¯¹è±¡ã€‚</li><li><code>isOrigin</code> å±æ€§ï¼Œæ˜¯å¦æ˜¯åŸå§‹å¯¹è±¡ã€‚<ul><li><code>isOrigin = true</code> ï¼Œä½¿ç”¨ <code>spanObject</code>å±æ€§ ã€‚</li><li><code>isOrigin = false</code> ï¼Œä½¿ç”¨ <code>standardBuilder</code> å±æ€§ã€‚</li></ul></li><li>åœ¨ Protobuf é‡Œï¼Œæ•°æ®ä¿®æ”¹å€¼æ—¶ï¼Œéœ€è¦ä½¿ç”¨å¯¹åº”çš„ Builder å¯¹è±¡ã€‚é€šè¿‡ä½¿ç”¨<strong>è£…é¥°è€…</strong>è®¾è®¡æ¨¡å¼ï¼Œå¯¹ä½¿ç”¨è€…å±è”½ç»†èŠ‚ï¼Œè°ƒç”¨ä¹Ÿæ›´åŠ æ–¹ä¾¿ã€‚ä¸‹é¢åœ¨æ¥çœ‹çœ‹å¦‚ä¸‹æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯å°±æ›´åŠ æ˜ç™½äº†ï¼š<ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java#L165" rel="external nofollow noopener noreferrer" target="_blank"><code>#setOperationNameId(value)</code></a> </li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java#L172" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOperationName()</code></a></li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanDecorator.java#L195" rel="external nofollow noopener noreferrer" target="_blank"><code>#toBuilder()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º SpanObject å¯¹åº”çš„ Builder ï¼Œå¹¶ä¿®æ”¹ <code>isOrigin = false</code> ã€‚å¦å¤–ï¼Œä¼šè°ƒç”¨ <code>standardBuilder</code> å±æ€§çš„ <code>#toBuilder()</code> æ–¹æ³•ï¼Œç›®å‰åœ¨é¡¹ç›®é‡Œï¼Œæ­¤å¤„çš„ <code>standardBuilder</code> å±æ€§ä¸º SegmentDecorator ã€‚</li></ul><p>SegmentDecorator ã€ReferenceDecorator å’Œ SpanDecorator ç›®çš„ä¸€è‡´ã€‚</p><h3 id="2-3-2-IdExchanger"><a href="#2-3-2-IdExchanger" class="headerlink" title="2.3.2 IdExchanger"></a>2.3.2 IdExchanger</h3><p><code>org.skywalking.apm.collector.agent.stream.parser.standardization.IdExchanger</code> ï¼Œç¼–å·å…‘æ¢å™¨<strong>æ¥å£</strong>ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/IdExchanger.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>#exchange(standardBuilder, applicationId)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå…‘æ¢ standardBuilder é‡Œçš„å±æ€§ï¼Œå¹¶è¿”å›æ˜¯å¦å…‘æ¢æˆåŠŸã€‚</li></ul><p>IdExchanger æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/ReferenceIdExchanger.java" rel="external nofollow noopener noreferrer" target="_blank">ReferenceIdExchanger</a> ï¼šTraceSegmentRef ç¼–å·å…‘æ¢å™¨ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanIdExchanger.java" rel="external nofollow noopener noreferrer" target="_blank">SpanIdExchanger</a> ï¼šSpan ç¼–å·å…‘æ¢å™¨ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/ReferenceIdExchanger.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>ReferenceIdExchanger#exchange(standardBuilder, applicationId)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 60 è‡³ 73 è¡Œï¼š<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.entryOperationId</code></a> ä¸ºç©ºï¼Œå°† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.entryOperationName</code></a> è¿›è¡Œå…‘æ¢ã€‚<ul><li>ç¬¬ 61 è¡Œï¼šè°ƒç”¨ <code>ServiceNameService#getOrCreate(applicationId, serviceName)</code> æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨ç¼–å·å’Œæ“ä½œåè·å¾—æˆ–åˆ›å»ºæ“ä½œç¼–å·ã€‚</li><li>ç¬¬ 62 è‡³ 67 è¡Œï¼šè·å¾—<strong>ä¸åˆ°</strong>ï¼Œå› ä¸ºåˆ›å»ºçš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã€‚è¿”å› <code>false</code> ã€‚</li><li>ç¬¬ 68 è‡³ 72 è¡Œï¼šè·å¾—<strong>åˆ°</strong>ï¼Œè°ƒç”¨ <code>ReferenceDecorator#toBuilder()</code> æ–¹æ³•ï¼Œåˆ›å»º Builder ï¼Œç„¶åè®¾ç½®æ“ä½œç¼–å·ã€‚</li></ul></li><li>ç¬¬ 75 è‡³ 89 è¡Œï¼š<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.parentApplicationInstanceId</code></a> ä¸ºç©ºï¼Œå°† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L90" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.parentOperationName</code></a> è¿›è¡Œå…‘æ¢ã€‚</li><li>ç¬¬ 92 è‡³ 104 è¡Œï¼š<a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.entryOperationName</code></a> ä¸ºç©ºï¼Œå°† <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef.peerHost</code></a> è¿›è¡Œå…‘æ¢ã€‚åœ¨ã€ç¬¬ 93 è¡Œã€‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>ApplicationIDService#getOrCreate(applicationCode)</code> æ–¹æ³•ï¼Œå°†<strong>æœåŠ¡åœ°å€</strong>ä½œä¸º <code>applicationCode</code> ä½¿ç”¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/parser/standardization/SpanIdExchanger.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>SpanIdExchanger#exchange(standardBuilder, applicationId)</code></a> æ–¹æ³•ï¼Œç±»ä¼¼ï¼Œå·²ç»æ·»åŠ ä»£ç æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚</p><h1 id="3-Buffer-æ–‡ä»¶"><a href="#3-Buffer-æ–‡ä»¶" class="headerlink" title="3. Buffer æ–‡ä»¶"></a>3. Buffer æ–‡ä»¶</h1><p>æœ¬å°èŠ‚æ¶‰åŠåˆ°çš„ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/05.png" alt=""></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Buffer åŒ…æ‹¬å“ªäº›æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">yunai$ pwd</div><div class="line">/Users/yunai/Java/buffer</div><div class="line">yunai$ ls</div><div class="line">data_20171205004132.swoffset_20171205004132.sw</div></pre></td></tr></table></figure><ul><li>Data æ–‡ä»¶ï¼Œè®°å½• TraceSegment å…·ä½“æ•°æ®ï¼Œé€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java" rel="external nofollow noopener noreferrer" target="_blank">SegmentBufferManager</a> ç®¡ç†ã€‚</li><li>Offset æ–‡ä»¶ï¼Œè®°å½•åç§»ï¼ŒåŒ…æ‹¬å†™å…¥æ–‡ä»¶çš„åå­—å’Œåç§»ï¼Œè¯»å–æ–‡ä»¶çš„åå­—å’Œåç§»ï¼Œé€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java" rel="external nofollow noopener noreferrer" target="_blank">OffsetManager</a> ç®¡ç†ã€‚</li><li>ä»å‘½åä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™<strong>ä¸¤ç§</strong>æ–‡ä»¶ï¼Œæ–‡ä»¶åå­—æ ¼å¼ä¸º <code>ç±»å‹_${æ—¶é—´}.sw</code> ï¼Œå¹¶ä¸”<strong>ç›¸åŒç±»å‹ï¼ŒåŒæ—¶å¯ä»¥å­˜åœ¨å¤šä¸ª</strong>ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/BufferFileConfig.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.buffer.BufferFileConfig</code></a> ï¼ŒBuffer æ–‡ä»¶é…ç½® ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/Offset.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.buffer.Offset</code></a> ï¼Œåç§» ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ Buffer æ–‡ä»¶çš„åˆå§‹åŒ–ã€å†™å…¥ã€è¯»å–çš„ä¸‰ç§æ“ä½œè¿‡ç¨‹ã€‚</p><h2 id="3-1-åˆå§‹åŒ–"><a href="#3-1-åˆå§‹åŒ–" class="headerlink" title="3.1 åˆå§‹åŒ–"></a>3.1 åˆå§‹åŒ–</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferManager#initialize(ModuleManager)</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– Offset æ–‡ä»¶ã€Data æ–‡ä»¶ã€å®šæœŸè¯»å– Buffer æ–‡ä»¶çš„ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 58 è¡Œï¼šè°ƒç”¨ <code>OffsetManager#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Offset æ–‡ä»¶ã€‚</li><li>ç¬¬ 60 è‡³ 63 è¡Œï¼šåˆ›å»º Buffer æ–‡ä»¶å¤¹æˆåŠŸ( æ„å‘³ç€è¯¥æ–‡ä»¶å¤¹ä¸å­˜åœ¨ )ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L113" rel="external nofollow noopener noreferrer" target="_blank"><code>#newDataFile()</code></a> ï¼Œåˆ›å»º Data æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 116 è‡³ 119 è¡Œï¼šåˆ›å»º<strong>æ–°</strong>çš„ Data æ–‡ä»¶ã€‚æ–‡ä»¶åæ ¼å¼ä¸ºï¼Œ<code>data_${yyyyMMddHHmmss}.sw</code> ã€‚</li><li>ç¬¬ 121 è¡Œï¼šè°ƒç”¨ <code>OffsetManager#setWriteOffset(writeFileName, writeFileOffset)</code> æ–¹æ³•ï¼Œè®¾ç½® Offset çš„<strong>å†™å…¥</strong>çš„æ–‡ä»¶åå’Œåç§»ã€‚</li><li>ç¬¬ 124 è‡³ 126 è¡Œï¼šå…³é—­<strong>è€</strong>çš„ Data æ–‡ä»¶çš„ <code>outputStream</code> ã€‚</li><li>ç¬¬ 129 è‡³ 130 è¡Œï¼šåˆ›å»º<strong>æ–°</strong>çš„ Data æ–‡ä»¶çš„ <code>outputStream</code> ã€‚</li></ul></li><li>ç¬¬ 66 è‡³ 77 è¡Œï¼šè·å¾— Offset çš„<strong>å†™å…¥</strong>çš„ Data æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ <code>outputStream</code> ã€‚</li><li>ç¬¬ 80 è¡Œï¼šè°ƒç”¨ <code>SegmentBufferReader#initialize(ModuleManager)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å®šæœŸè¯»å– Buffer æ–‡ä»¶çš„ä»»åŠ¡ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>OffsetManager#initialize()</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– Offset æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 74 è¡Œï¼šåˆ›å»º Offer å¯¹è±¡ã€‚è¯¥å¯¹è±¡åŒ…å«äº†<strong>å½“å‰</strong>åˆ†åˆ«å†™å…¥å’Œè¯»å–çš„æ–‡ä»¶åä¸åç§»é‡ã€‚</li><li>ç¬¬ 60 è‡³ 63 è¡Œï¼šåˆ›å»º Buffer æ–‡ä»¶å¤¹æˆåŠŸ( æ„å‘³ç€è¯¥æ–‡ä»¶å¤¹ä¸å­˜åœ¨ )ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L112" rel="external nofollow noopener noreferrer" target="_blank"><code>#createOffsetFile()</code></a> ï¼Œåˆ›å»º Data æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 114 è‡³ 116 è¡Œï¼šåˆ›å»º<strong>æ–°</strong>çš„ Offset æ–‡ä»¶ã€‚æ–‡ä»¶åæ ¼å¼ä¸ºï¼Œ<code>offset_${yyyyMMddHHmmss}.sw</code> ã€‚</li><li>ç¬¬ 118 è‡³ 121 è¡Œï¼šè®¾ç½® Offset å¯¹è±¡çš„å†™å…¥å’Œè¯»å–çš„æ–‡ä»¶åä¸åç§»é‡éƒ½ä¸º<strong>ç©º</strong>ã€‚åœ¨ä¸Šé¢çš„æ–¹æ³•ï¼Œæ­¤å¤„çš„ã€ç©ºã€‘ï¼Œåœ¨ Data æ–‡ä»¶åˆ›å»ºæ—¶ï¼Œä¼šé‡æ–°è®¾ç½® Offset ã€‚</li><li>ç¬¬ 123 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L129" rel="external nofollow noopener noreferrer" target="_blank"><code>#flush()</code></a> æ–¹æ³•ï¼Œå†™å…¥ Offset å¯¹è±¡åˆ° Offset æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š <ul><li>ç¬¬ 131 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/Offset.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>Offset#serialize()</code></a> æ–¹æ³•ï¼Œåºåˆ—åŒ–è¯»å†™åç§»ï¼Œæ ¼å¼ä¸º <code>${è¯»å–æ–‡ä»¶å},${è¯»å–æ–‡ä»¶åç§»é‡},${å†™å…¥æ–‡ä»¶å},${å†™å…¥æ–‡ä»¶åç§»é‡}</code> ã€‚</li><li>ç¬¬ 133 è‡³ 142 è¡Œï¼šå†™å…¥ Offset å¯¹è±¡åˆ° Offset æ–‡ä»¶ã€‚å†™å…¥æ–¹å¼ä¸º<strong>æ•´è¡Œ</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/06.png" alt=""></li></ul></li></ul></li><li>ç¬¬ 82 è‡³ 94 è¡Œï¼šè·å¾—æ‰€æœ‰ Offset æ–‡ä»¶ï¼Œåˆ é™¤è€çš„ Offset æ–‡ä»¶ï¼Œä¿ç•™æœ€åä¸€ä¸ªã€‚è‹¥ä¸å­˜åœ¨ Offset æ–‡ä»¶ï¼Œåˆ™è°ƒç”¨ <code>#createOffsetFile()</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ–°</strong>çš„ Offset æ–‡ä»¶ã€‚</li><li>ç¬¬ 98 è‡³ 99 è¡Œï¼šä» Offset æ–‡ä»¶çš„<strong>æœ€åä¸€è¡Œ</strong>è¯»å–ï¼Œååºåˆ—åŒ–åˆ° Offset å¯¹è±¡ã€‚</li><li>ç¬¬ 103 è¡Œï¼šåˆ›å»ºå®šä¹‰ä»»åŠ¡ï¼Œå»¶è¿Ÿ 10 ç§’ï¼Œé—´éš” 3 ç§’ï¼Œè°ƒç”¨ <code>#flush()</code> æ–¹æ³•ï¼Œ<strong>å®šæ—¶</strong>å†™å…¥ Offset å¯¹è±¡åˆ° Offset æ–‡ä»¶ã€‚<strong>æ³¨æ„ï¼Œæ‰€ä»¥ Offset æ”¹å˜æ—¶ï¼Œä¸æ˜¯ç«‹å³å†™å…¥ Offset æ–‡ä»¶ï¼Œè€Œæ˜¯å‘¨æœŸæ€§åˆ·ç›˜</strong>ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferReader#initialize(ModuleManager)</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ–å®šæœŸè¯»å– Buffer æ–‡ä»¶çš„ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 56 è¡Œï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå»¶è¿Ÿ 3 ç§’ï¼Œé—´éš” 3 ç§’ï¼Œè°ƒç”¨ <code>#preRead()</code> æ–¹æ³•ï¼Œè¯»å– Buffer æ–‡ä»¶ï¼Œå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚</li></ul><h2 id="3-2-å†™å…¥"><a href="#3-2-å†™å…¥" class="headerlink" title="3.2 å†™å…¥"></a>3.2 å†™å…¥</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L91" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferManager#writeBuffer(UpstreamSegment)</code></a> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Buffer æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š1ï¼‰å°† TraceSegment å†™å…¥ Data æ–‡ä»¶ï¼›2ï¼‰æ›´æ–° Offset æ–‡ä»¶çš„åç§»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 94 è‡³ 95 è¡Œï¼šè°ƒç”¨ <code>AbstractMessageLite#writeDelimitedTo(OutputStream)</code> æ–¹æ³•ï¼Œå°† TraceSegment å†™å…¥ Data æ–‡ä»¶ã€‚è¯¥æ–¹æ³•åŒ…æ‹¬ <strong>flush</strong> æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/07.png" alt=""></li><li>ç¬¬ 97 è‡³ 98 è¡Œï¼šè¶…è¿‡ Buffer <strong>å•æ–‡ä»¶å®¹é‡ä¸Šé™</strong>ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferManager.java#L113" rel="external nofollow noopener noreferrer" target="_blank"><code>#newDataFile()</code></a> ï¼Œåˆ›å»º Data æ–‡ä»¶ã€‚</li><li>ç¬¬ 99 è‡³ 102 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/OffsetManager.java#L186" rel="external nofollow noopener noreferrer" target="_blank"><code>OffsetManager#setWriteOffset(position)</code></a> æ–¹æ³•ï¼Œè®¾ç½® Offset å¯¹è±¡çš„å†™å…¥åç§»ã€‚</li></ul><h2 id="3-3-è¯»å–"><a href="#3-3-è¯»å–" class="headerlink" title="3.3 è¯»å–"></a>3.3 è¯»å–</h2><p><a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>SegmentBufferReader#preRead()</code></a> æ–¹æ³•ï¼Œè¯»å– Buffer æ–‡ä»¶ï¼Œå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚<strong>å¦å¤–è¯¥æ–¹æ³•ï¼Œä¼šåˆ é™¤å·²ç»è¯»å–å®Œæˆçš„ Data æ–‡ä»¶</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>â€”â€”â€“ è¯»å–æ–‡ä»¶å­˜åœ¨</li><li>è¯¥æƒ…å†µå‘ç”Ÿäºï¼ŒData æ–‡ä»¶æœªè¢«è¯»å–å®Œæˆ</li><li>ç¬¬ 65 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L88" rel="external nofollow noopener noreferrer" target="_blank"><code>#deleteTheDataFilesBeforeReadFile(readFileName)</code></a> æ–¹æ³•ï¼Œåˆ é™¤æ¯”æŒ‡å®šæ–‡ä»¶æ—©åˆ›å»ºçš„ Data æ–‡ä»¶ï¼Œ<strong>åŸºäºæ–‡ä»¶åå¸¦æœ‰åˆ›å»ºæ—¶é—´</strong>ã€‚</li><li>ç¬¬ 67 è‡³ 68 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L130" rel="external nofollow noopener noreferrer" target="_blank"><code>#read()</code></a> æ–¹æ³•ï¼Œè¯»å– Buffer æ–‡ä»¶ï¼Œå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚å¦å¤–ï¼Œè¿”å› <code>true</code> ï¼Œæ–‡ä»¶è¢«å…¨éƒ¨è¯»å–å®Œæˆã€å¤„ç†å¹¶åˆ é™¤ã€‚è¿”å› <code>false</code> ï¼Œæ–‡ä»¶æœªè¢«å…¨éƒ¨è¯»å–å®Œæˆã€‚<ul><li>ç¬¬ 133 è‡³ 134 è¡Œï¼šåˆ›å»º FileInputStream å¯¹è±¡ï¼Œå¹¶è·³è½¬åˆ°è¯»å–ä½ç½®ã€‚</li><li>ç¬¬ 137 è‡³ 141 è¡Œï¼šè·å–<strong>è¯»å–ç»“æŸ</strong>çš„ä½ç½®ã€‚</li><li>ç¬¬ 143 è‡³ 159 è¡Œï¼š<strong>å¾ªç¯è¯»å–å¤„ç†</strong>ï¼Œç›´åˆ°åˆ°è¾¾è¯»å–æ–‡ä»¶ä¸Šé™ä½ç½®<ul><li>ç¬¬ 144 è‡³ 146 è¡Œï¼šä» Data æ–‡ä»¶ï¼Œè¯»å–ä¸€æ¡ TraceSegment ã€‚</li><li>ç¬¬ 149 è‡³ 152 è¡Œï¼šå°† TraceSegment æäº¤ç»™ SegmentParse é‡æ–°è§£æä¸æ„å»ºå¤„ç†ã€‚è‹¥è§£æå¤„ç†å¤±è´¥ï¼Œè¿”å› <code>false</code> ï¼Œç»“æŸå¾ªç¯ï¼Œç­‰å¾…ä¸‹æ¬¡è¯»å–å¤„ç†ã€‚</li><li>ç¬¬ 155 è‡³ 158 è¡Œï¼šè®¾ç½® Offset å¯¹è±¡çš„è¯»å–åç§»ã€‚</li></ul></li><li>ç¬¬ 161 è‡³ 165 è¡Œï¼š<strong>å…¨éƒ¨è¯»å–å¤„ç†å®Œæˆï¼Œå…³é—­ InputStream ï¼ŒåŒæ—¶åˆ é™¤è¯»å–çš„ Data æ–‡ä»¶</strong>ã€‚</li><li>ç¬¬ 166 è‡³ 169 è¡Œï¼šå‘ç”Ÿ IOException å¼‚å¸¸ï¼Œè¿”å› <code>false</code> ã€‚</li><li>ç¬¬ 170 è¡Œï¼šè¿”å› <code>true</code> ï¼Œæ–‡ä»¶è¢«å…¨éƒ¨è¯»å–å®Œæˆã€å¤„ç†å¹¶åˆ é™¤ã€‚</li></ul></li><li>ç¬¬ 75 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/c15cf5e1356c7b44a23f2146b8209ab78c2009ac/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/buffer/SegmentBufferReader.java#L110" rel="external nofollow noopener noreferrer" target="_blank"><code>#readEarliestCreateDataFile()</code></a> æ–¹æ³•ï¼Œå¾ªç¯é¡ºåºè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚<ul><li>ç¬¬ 112 è‡³ 118 è¡Œï¼šè‹¥ç¬¬ä¸€ä¸ª Data æ–‡ä»¶å’Œ Offset è¯»å–çš„æ–‡ä»¶ç›¸åŒï¼Œè¿”å›ã€‚è¯´æ˜ï¼Œåœ¨ä¸Šä¸€æ¬¡ <code>#read()</code> æ–¹æ³•é‡Œï¼Œæ²¡æœ‰è¯»å®Œã€‚</li><li>ç¬¬ 121 è‡³ 127 è¡Œï¼šå¾ªç¯é¡ºåºè°ƒç”¨ <code>#read(readFile, readFileOffset)</code> æ–¹æ³•ï¼Œè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚ </li></ul></li><li>â€”â€”â€“ è¯»å–æ–‡ä»¶ä¸å­˜åœ¨ â€”â€”â€“</li><li>è¯¥æƒ…å†µå‘ç”Ÿäºï¼ŒData æ–‡ä»¶è¢«å…¨éƒ¨è¯»å–å®Œæˆï¼Œå¹¶ä¸”åˆ é™¤ã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <code>#deleteTheDataFilesBeforeReadFile(readFileName)</code> æ–¹æ³•ï¼Œåˆ é™¤æ¯”æŒ‡å®šæ–‡ä»¶æ—©åˆ›å»ºçš„ Data æ–‡ä»¶ã€‚</li><li>ç¬¬ 75 è¡Œï¼šè°ƒç”¨ <code>#readEarliestCreateDataFile()</code> æ–¹æ³•ï¼Œå¾ªç¯é¡ºåºè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚</li><li>â€”â€”â€“ æ²¡æœ‰å¯è¯»å–çš„æ–‡ä»¶ â€”â€”â€“</li><li>è¯¥æƒ…å†µå‘ç”Ÿäºï¼ŒData æ–‡ä»¶ã€Buffer æ–‡ä»¶<strong>é¦–æ¬¡</strong>åˆå§‹åŒ–åˆ›å»ºï¼Œæœªè®¾ç½®å¯è¯»æ–‡ä»¶åã€‚</li><li>ç¬¬ 79 è¡Œï¼šè°ƒç”¨ <code>#readEarliestCreateDataFile()</code> æ–¹æ³•ï¼Œå¾ªç¯é¡ºåºè¯»å– Data æ–‡ä»¶ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªæ²¡è¯»å®Œã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œå³å°†å¼€å§‹ Trace æµå¼å¤„ç†çš„æ–‡ç« ï¼Œå¾ˆå—¨çš®ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_10/08.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/collector-receive-trace/&quot;&gt;http://www.iocoder.cn/SkyWalking/collector-receive-trace/&lt;/a
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent å‘é€ Trace æ•°æ®</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-send-trace/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-send-trace/</id>
    <published>2020-10-04T16:00:00.000Z</published>
    <updated>2018-01-02T12:51:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">http://www.iocoder.cn/SkyWalking/agent-send-trace/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">2. TraceSegmentServiceClient</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">2.1 å®ç° BootService æ¥å£</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">2.2 å®ç° GRPCChannelListener æ¥å£</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">2.3 å®ç° TracingContextListener æ¥å£</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">2.4 å®ç° IConsumer æ¥å£</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-send-trace/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œé“¾è·¯çš„è¿½è¸ªå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Agent æ”¶é›† Trace æ•°æ®ã€‚</li><li><strong>Agent å‘é€ Trace æ•°æ®ç»™ Collector</strong> ã€‚</li><li>Collector æ¥æ”¶ Trace æ•°æ®ã€‚</li><li>Collector å­˜å‚¨ Trace æ•°æ®åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼Œæ•°æ®åº“ã€‚</li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†äº«ã€ç¬¬äºŒéƒ¨åˆ†ã€‘ <strong>SkyWalking Agent å‘é€ Trace æ•°æ®</strong>ã€‚</p><p>è€ƒè™‘åˆ°å‡å°‘<strong>å¤–éƒ¨ç»„ä»¶</strong>çš„ä¾èµ–ï¼ŒAgent æ”¶é›†åˆ° Trace æ•°æ®åï¼Œä¸æ˜¯å†™å…¥å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—( ä¾‹å¦‚ï¼ŒKafka )æˆ–è€…æ—¥å¿—æ–‡ä»¶ï¼Œè€Œæ˜¯ Agent å†™å…¥<strong>å†…å­˜æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼Œ<strong>åå°çº¿ç¨‹</strong>ã€<strong>å¼‚æ­¥</strong>ã€‘å‘é€ç»™ Collector ã€‚</p><p>æœ¬æ–‡æ¶‰åŠçš„ç±»éå¸¸å°‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_05/01.png" alt=""></p><h1 id="2-TraceSegmentServiceClient"><a href="#2-TraceSegmentServiceClient" class="headerlink" title="2. TraceSegmentServiceClient"></a>2. TraceSegmentServiceClient</h1><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.remote.TraceSegmentServiceClient</code></a> ï¼ŒTraceSegment å‘é€æœåŠ¡å®¢æˆ·ç«¯ã€‚å®ƒæ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œè´Ÿè´£å°† TraceSegment <strong>å¼‚æ­¥</strong>å‘é€åˆ° Collector ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ TraceSegmentServiceClient çš„<strong>å±æ€§</strong>ï¼š</p><ul><li><code>TIMEOUT</code> <strong>é™æ€</strong>å±æ€§ï¼Œå‘é€ç­‰å¾…è¶…æ—¶æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li><li><code>lastLogTime</code> å±æ€§ï¼Œæœ€åæ‰“å°æ—¥å¿—æ—¶é—´ã€‚è¯¥å±æ€§ä¸»è¦ç”¨äºå¼€å‘è°ƒè¯•ã€‚</li><li><code>segmentUplinkedCounter</code> å±æ€§ï¼ŒTraceSegment å‘é€æ•°é‡ã€‚</li><li><code>segmentAbandonedCounter</code> å±æ€§ï¼ŒTraceSegment è¢«ä¸¢å¼ƒæ•°é‡ã€‚åœ¨ Agent æœªè¿æ¥ä¸Š Collector æ—¶ï¼Œäº§ç”Ÿçš„ TraceSegment å°†è¢«ä¸¢å¼ƒã€‚</li><li><code>carrier</code> å±æ€§ï¼Œå†…å­˜é˜Ÿåˆ—ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/data-carrier/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” DataCarrier å¼‚æ­¥å¤„ç†åº“ã€‹</a> æœ‰å¯¹ DataCarrier çš„è¯¦ç»†è§£æã€‚</li><li><code>serviceStub</code> å±æ€§ï¼Œ<strong>éé˜»å¡</strong> Stub ã€‚</li><li><code>status</code> å±æ€§ï¼Œè¿æ¥çŠ¶æ€ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä»‹ç» TraceSegmentServiceClient å®ç°çš„<strong>æ¥å£</strong>ä»¥åŠå¯¹åº”çš„æ–¹æ³•ã€‚</p><h2 id="2-1-å®ç°-BootService-æ¥å£"><a href="#2-1-å®ç°-BootService-æ¥å£" class="headerlink" title="2.1 å®ç° BootService æ¥å£"></a>2.1 å®ç° BootService æ¥å£</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeBoot()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 86 è¡Œï¼šè°ƒç”¨ <code>GRPCChannelManager#addChannelListener(this)</code> æ–¹æ³•ï¼Œå°†è‡ªå·±æ·»åŠ åˆ° GRPCChannelManager ä¸­ï¼Œä½œä¸ºä¸€ä¸ªç›‘å¬å™¨ï¼Œä»è€Œè°ƒç”¨ <code>#statusChanged(GRPCChannelStatus)</code> æ–¹æ³•ï¼Œå®ç°å¯¹<strong>è¿æ¥çŠ¶æ€</strong>( <code>status</code> )çš„ç›‘å¬å¤„ç†ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L90" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 95 è‡³ 97 è¡Œï¼šåˆ›å»º DataCarrier å¯¹è±¡ï¼Œä½œä¸º<strong>å†…å­˜é˜Ÿåˆ—</strong>ï¼Œå¹¶è®¾ç½®è‡ªå·±ä½œä¸ºæ¶ˆè´¹è€…ï¼Œä»è€Œè°ƒç”¨ <code>#consume(List&lt;TraceSegment&gt; )</code> æ–¹æ³•ï¼Œå®ç°<strong>å¼‚æ­¥</strong>å‘é€ TraceSegment åˆ° Collector ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L101" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterBoot()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 102 è¡Œï¼šè°ƒç”¨ <code>TracingContext.ListenerManager#add(this)</code> æ–¹æ³•ï¼Œå°†è‡ªå·±æ·»åŠ åˆ° ListenerManager ä¸­ï¼Œä½œä¸ºä¸€ä¸ªç›‘å¬å™¨ï¼Œä»è€Œè°ƒç”¨ <code>#afterFinished(TraceSegment)</code> æ–¹æ³•ï¼Œå®ç°<strong>æ”¶é›†</strong>åˆ°æ–°çš„ TraceSegment ï¼Œæ·»åŠ åˆ°å†…å­˜é˜Ÿåˆ—ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L106" rel="external nofollow noopener noreferrer" target="_blank"><code>#shutdown()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 107 è¡Œï¼šè°ƒç”¨ <code>DataCarrier#shutdownConsumers()</code> æ–¹æ³•ï¼Œåœæ­¢æ¶ˆè´¹ã€‚</li></ul><h2 id="2-2-å®ç°-GRPCChannelListener-æ¥å£"><a href="#2-2-å®ç°-GRPCChannelListener-æ¥å£" class="headerlink" title="2.2 å®ç° GRPCChannelListener æ¥å£"></a>2.2 å®ç° GRPCChannelListener æ¥å£</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L209" rel="external nofollow noopener noreferrer" target="_blank"><code>#statusChanged(GRPCChannelStatus)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 211 è‡³ 214 è¡Œï¼šè¿æ¥æˆåŠŸï¼Œåˆ›å»º Stub å¯¹è±¡ã€‚</li><li>ç¬¬ 215 è¡Œï¼šè®°å½•è¿æ¥çŠ¶æ€ã€‚</li></ul><h2 id="2-3-å®ç°-TracingContextListener-æ¥å£"><a href="#2-3-å®ç°-TracingContextListener-æ¥å£" class="headerlink" title="2.3 å®ç° TracingContextListener æ¥å£"></a>2.3 å®ç° TracingContextListener æ¥å£</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L196" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterFinished(TraceSegment)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 197 è‡³ 199 è¡Œï¼šå½“ <code>TraceSegment.ignore = true</code> æ—¶ï¼Œå¿½ç•¥è¯¥ TraceSegment ã€‚</li><li>ç¬¬ 201 è¡Œï¼šæäº¤ TraceSegment åˆ°å†…å­˜é˜Ÿåˆ—ã€‚</li></ul><h2 id="2-4-å®ç°-IConsumer-æ¥å£"><a href="#2-4-å®ç°-IConsumer-æ¥å£" class="headerlink" title="2.4 å®ç° IConsumer æ¥å£"></a>2.4 å®ç° IConsumer æ¥å£</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L116" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume(List&lt;TraceSegment&gt;)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>â€”â€” <strong>è¿æ¥ä¸­</strong> â€”â€”</li><li>ç¬¬ 119 è¡Œï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCStreamServiceStatus.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.remoteã€‚GRPCStreamServiceStatus</code></a> å¯¹è±¡ã€‚</li><li>ç¬¬ 122 è‡³ 141 è¡Œï¼šåˆ›å»º StreamObserver å¯¹è±¡ã€‚åœ¨ä¸‹é¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Agent å‘é€ TraceSegment ç»™ Collector æ˜¯<strong>éé˜»å¡</strong>çš„æ–¹å¼ï¼Œé€šè¿‡è¯¥å¯¹è±¡ï¼Œ<strong>è§‚å¯Ÿ</strong>æ‰§è¡Œç»“æœã€‚<ul><li>ç¬¬ 130 è¡Œ || ç¬¬ 139 è¡Œï¼šå½“å‘ç”Ÿé”™è¯¯æˆ–è€…å®Œæˆæ—¶ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCStreamServiceStatus.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>GRPCStreamServiceStatus#finished()</code></a> æ–¹æ³•ï¼Œ<strong>æ ‡è®°å®Œæˆ</strong>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢ä¼šçœ‹åˆ°ã€‚</li><li>ç¬¬ 134 è¡Œï¼šè°ƒç”¨ <code>GRPCChannelManager#reportError(Throwable)</code> æ–¹æ³•ï¼Œæ±‡æŠ¥é”™è¯¯ã€‚å¦‚æœæ˜¯è¿æ¥é”™è¯¯ï¼ŒGRPCChannelManager ä¼šè´Ÿè´£æ–­å¼€é‡è¿ã€‚</li></ul></li><li>ç¬¬ 144 è‡³ 151 è¡Œï¼šé€æ¡<strong>éé˜»å¡</strong>å‘é€ TraceSegment è¯·æ±‚ã€‚<ul><li>ç¬¬ 146 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L163" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegment#transform()</code></a> æ–¹æ³•ï¼Œå°† TraceSegment è½¬æ¢æˆ <code>org.skywalking.apm.network.proto.UpstreamSegment</code> å¯¹è±¡ï¼Œç”¨äº gRPC ä¼ è¾“ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-network/src/main/proto/TraceSegmentService.proto#L14" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentService.proto</code></a> çš„æ•°æ®ç»“æ„å®šä¹‰ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/DistributedTraceId.java#L65" rel="external nofollow noopener noreferrer" target="_blank"><code>DistributedTraceId#toUniqueId()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/ID.java#L120" rel="external nofollow noopener noreferrer" target="_blank"><code>ID#transform()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/AbstractTracingSpan.java#L262" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractTracingSpan#transform()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/ExitSpan.java#L129" rel="external nofollow noopener noreferrer" target="_blank"><code>ExitSpan#transform()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/LogDataEntity.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>LogDataEntity#transform()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L160" rel="external nofollow noopener noreferrer" target="_blank"><code>TraceSegmentRef#transform()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/util/KeyValuePair.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>KeyValuePair#transform()</code></a></li></ul></li><li>ç¬¬ 154 è¡Œï¼šè°ƒç”¨ <code>StreamObserver#onCompleted()</code> æ–¹æ³•ï¼Œæ ‡è®°å…¨éƒ¨è¯·æ±‚å‘é€å®Œæˆã€‚</li><li>ç¬¬ 157 è‡³ 159 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCStreamServiceStatus.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>GRPCStreamServiceStatus#wait4Finish(maxTimeout)</code></a> æ–¹æ³•ï¼Œç­‰å¾… Collector å¤„ç†å®Œæˆã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢éœ€è¦è°ƒç”¨ <code>GRPCStreamServiceStatus#finished()</code> æ–¹æ³•ã€‚å®Œæˆåï¼Œè®°å½•æ•°é‡åˆ° <code>segmentUplinkedCounter</code> ã€‚<ul><li><strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„è‹¥ç­‰å¾…å®Œæˆè¶…æ—¶ï¼ŒTraceSegment <strong>ä¾ç„¶</strong>åœ¨å‘é€ï¼Œæˆ–è€…è¢« Collector å¤„ç†ä¸­ï¼Œç›´åˆ°æœ€ç»ˆçš„æˆåŠŸæˆ–å¤±è´¥ã€‚</li></ul></li></ul></li><li>â€”â€” <strong>æœªè¿æ¥</strong> â€”â€”</li><li>ç¬¬ 161 è¡Œï¼šè®°å½•æ•°é‡åˆ° <code>segmentAbandonedCounter</code> ã€‚</li><li>â€”â€” <strong>ALL</strong> â€”â€”</li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L170" rel="external nofollow noopener noreferrer" target="_blank"><code>#printUplinkStatus()</code></a> æ–¹æ³•ï¼Œæ¯ä¸‰åç§’ï¼Œæ‰“å°ä¸€æ¬¡ segmentUplinkedCounter å’Œ segmentAbandonedCounter æ•°æ®ã€‚ä¸»è¦ç”¨äºå¼€å‘è°ƒè¯•ã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•ä¼šé‡ç½® <code>segmentUplinkedCounter</code> å’Œ <code>segmentAbandonedCounter</code> è®¡æ•°ã€‚</li></ul><p>psï¼šç›®å‰ DataCarrier <strong>æœ€é•¿</strong>æ¯ 20 ç§’æ¶ˆè´¹ä¸€æ¬¡ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/0fe81f39054634a0b9a04fca41e6889f0e175b4a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L186" rel="external nofollow noopener noreferrer" target="_blank"><code>#onError(List&lt;TraceSegment&gt;, Throwable)</code></a> æ–¹æ³•ï¼Œå½“æ¶ˆè´¹å‘ç”Ÿ<strong>å¼‚å¸¸</strong>æ—¶ï¼Œæ‰“å°æ—¥å¿—ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>HOHO ï¼Œç®€å•æ°´æ›´ä¸€ç¯‡ï¼Œä¿æŒ Trace ç›¸å…³çš„å°ç³»åˆ—æ–‡ç« ï¼Œä¸»é¢˜æ˜ç¡®ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_05/02.jpeg" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/agent-send-trace/&quot;&gt;http://www.iocoder.cn/SkyWalking/agent-send-trace/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-collect-trace/</id>
    <published>2020-09-30T16:00:00.000Z</published>
    <updated>2018-01-02T09:13:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">http://www.iocoder.cn/SkyWalking/agent-collect-trace/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">2. Trace</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">2.1 ID</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">2.2 AbstractSpan</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">2.3 TraceSegmentRef</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">2.4 TraceSegment</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">3. Context</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">3.1 ContextManager</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">3.2 AbstractTracerContext</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">3.3 SamplingService</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œé“¾è·¯çš„è¿½è¸ªå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><strong>Agent æ”¶é›† Trace æ•°æ®</strong>ã€‚</li><li>Agent å‘é€ Trace æ•°æ®ç»™ Collector ã€‚</li><li>Collector æ¥æ”¶ Trace æ•°æ®ã€‚</li><li>Collector å­˜å‚¨ Trace æ•°æ®åˆ°å­˜å‚¨å™¨ï¼Œä¾‹å¦‚ï¼Œæ•°æ®åº“ã€‚</li></ol><p>æœ¬æ–‡ä¸»è¦åˆ†äº«ã€ç¬¬ä¸€éƒ¨åˆ†ã€‘ <strong>SkyWalking Agent æ”¶é›† Trace æ•°æ®</strong>ã€‚æ–‡ç« çš„å†…å®¹é¡ºåºå¦‚ä¸‹ï¼š</p><ul><li>Trace çš„æ•°æ®ç»“æ„</li><li>Context æ”¶é›† Trace çš„æ–¹æ³•</li></ul><p>ä¸åŒ…æ‹¬æ’ä»¶å¯¹ Context æ”¶é›†çš„æ–¹æ³•çš„<strong>è°ƒç”¨</strong>ï¼Œåç»­å•ç‹¬æ–‡ç« ä¸“é—¨åˆ†äº«ï¼Œèƒ–å‹ä¹Ÿå¯ä»¥é˜…è¯»å®Œæœ¬æ–‡åï¼Œè‡ªå·±å»çœ‹ <a href="https://github.com/YunaiV/skywalking/tree/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-sdk-plugin" rel="external nofollow noopener noreferrer" target="_blank"><code>apm-sdk-plugin</code></a> çš„å®ç°ä»£ç ã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ä»£ç å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/01.png" alt=""></p><ul><li><strong>çº¢æ¡†</strong>éƒ¨åˆ†ï¼šTrace çš„æ•°æ®ç»“æ„ï¼Œåœ¨ <a href="#">ã€Œ2. Traceã€</a> åˆ†äº«ã€‚</li><li><strong>é»„æ¡†</strong>éƒ¨åˆ†ï¼šContext æ”¶é›† Trace çš„æ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ3. Contextã€</a> åˆ†äº«ã€‚</li></ul><h1 id="2-Trace"><a href="#2-Trace" class="headerlink" title="2. Trace"></a>2. Trace</h1><blockquote><p>å‹æƒ…æç¤ºï¼šèƒ–å‹ï¼Œè¯·å…ˆè¡Œé˜…è¯» <a href="https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠOpenTracingè¯­ä¹‰æ ‡å‡†ã€‹</a> ã€‚  </p><p>æœ¬å°èŠ‚ï¼Œç¬”è€…è®¤ä¸ºèƒ–å‹å·²ç»å¯¹ OpenTracing æœ‰ä¸€å®šçš„ç†è§£ã€‚</p></blockquote><p><a href="https://github.com/YunaiV/skywalking/blob/2a75efbeddac2b9565816af0ab0873ec3d998424/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.TraceSegment</code></a> ï¼Œæ˜¯<strong>ä¸€æ¬¡</strong>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª( Distributed Trace ) çš„<strong>ä¸€æ®µ</strong>ã€‚</p><ul><li><strong>ä¸€æ¡</strong> TraceSegment ï¼Œç”¨äºè®°å½•æ‰€åœ¨<strong>çº¿ç¨‹</strong>( Thread )çš„é“¾è·¯ã€‚</li><li><strong>ä¸€æ¬¡</strong>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œå¯ä»¥åŒ…å«<strong>å¤šæ¡</strong> TraceSegment ï¼Œå› ä¸ºå­˜åœ¨<strong>è·¨è¿›ç¨‹</strong>( ä¾‹å¦‚ï¼ŒRPC ã€MQ ç­‰ç­‰)ï¼Œæˆ–è€…å®<strong>çº¿ç¨‹</strong>( ä¾‹å¦‚ï¼Œå¹¶å‘æ‰§è¡Œã€å¼‚æ­¥å›è°ƒç­‰ç­‰ )ã€‚</li></ul><p>TraceSegment å±æ€§ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><code>traceSegmentId</code> å±æ€§ï¼ŒTraceSegment çš„ç¼–å·ï¼Œå…¨å±€å”¯ä¸€ã€‚åœ¨ <a href="#">ã€Œ2.1 IDã€</a> è¯¦ç»†è§£æã€‚</li><li><code>refs</code> å±æ€§ï¼ŒTraceSegmentRef <strong>æ•°ç»„</strong>ï¼ŒæŒ‡å‘çš„<strong>çˆ¶</strong> TraceSegment æ•°ç»„ã€‚<ul><li><strong>ä¸ºä»€ä¹ˆä¼šæœ‰å¤šä¸ªçˆ¸çˆ¸</strong>ï¼Ÿä¸‹é¢ç»Ÿä¸€è®²ã€‚</li><li>TraceSegmentRef ï¼Œåœ¨ <a href="#">ã€Œ2.3 TraceSegmentRefã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><code>relatedGlobalTraces</code> å±æ€§ï¼Œå…³è”çš„ DistributedTraceId <strong>æ•°ç»„</strong>ã€‚<ul><li><strong>ä¸ºä»€ä¹ˆä¼šæœ‰å¤šä¸ªçˆ¸çˆ¸</strong>ï¼Ÿä¸‹é¢ç»Ÿä¸€è®²ã€‚</li><li>DistributedTraceId ï¼Œåœ¨ <a href="#">ã€Œ2.1.2 DistributedTraceIdã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><code>spans</code> å±æ€§ï¼ŒåŒ…å«çš„ Span <strong>æ•°ç»„</strong>ã€‚åœ¨ <a href="#">ã€Œ2.2 AbstractSpanã€</a> è¯¦ç»†è§£æã€‚è¿™æ˜¯ TraceSegment çš„<strong>ä¸»ä½“</strong>ï¼Œæ€»çš„æ¥è¯´ï¼ŒTraceSegment æ˜¯ Span æ•°ç»„çš„å°è£…ã€‚</li><li><code>ignore</code> å±æ€§ï¼Œæ˜¯å¦å¿½ç•¥è¯¥æ¡ TraceSegment ã€‚åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå¿½ç•¥ TraceSegment ï¼Œå³ä¸æ”¶é›†é“¾è·¯è¿½è¸ªï¼Œåœ¨ä¸‹é¢ <a href="#">ã€Œ3. Contextã€</a> éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°è¿™äº›æƒ…å†µã€‚</li><li><code>isSizeLimited</code> å±æ€§ï¼ŒSpan æ˜¯å¦è¶…è¿‡ä¸Šé™( <a href="https://github.com/YunaiV/skywalking/blob/2961e9f539286ef91af1ff1ef7681d0a06f156b0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/conf/Config.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>Config.Agent.SPAN_LIMIT_PER_SEGMENT</code></a> )ã€‚è¶…è¿‡ä¸Šé™ï¼Œä¸åœ¨è®°å½• Span ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆä¼šæœ‰å¤šä¸ªçˆ¸çˆ¸</strong>ï¼Ÿ</p><ul><li>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<strong>ä¸€ä¸ªçˆ¸çˆ¸</strong>çš„æƒ…å†µï¼Œå¸¸è§äº RPC è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œã€æœåŠ¡ Aã€‘è°ƒç”¨ã€æœåŠ¡ Bã€‘æ—¶ï¼Œã€æœåŠ¡ Bã€‘æ–°å»ºä¸€ä¸ª TraceSegment å¯¹è±¡ï¼š<ul><li>å°†è‡ªå·±çš„ <code>refs</code> æŒ‡å‘ã€æœåŠ¡ Aã€‘çš„ TraceSegment ã€‚</li><li>å°†è‡ªå·±çš„ <code>relatedGlobalTraces</code> è®¾ç½®ä¸º ã€æœåŠ¡ Aã€‘çš„ DistributedTraceId å¯¹è±¡ã€‚</li></ul></li><li>æˆ‘ä»¬å†æ¥çœ‹çœ‹<strong>å¤šä¸ªçˆ¸çˆ¸</strong>çš„æƒ…å†µï¼Œå¸¸è§äº MQ / Batch è°ƒç”¨ã€‚ä¾‹å¦‚ï¼ŒMQ æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯æ¥è‡ªã€å¤šä¸ªæœåŠ¡ã€‘ã€‚æ¯æ¬¡æ‰¹é‡æ¶ˆè´¹æ—¶ï¼Œã€æ¶ˆè´¹è€…ã€‘æ–°å»ºä¸€ä¸ª TraceSegment å¯¹è±¡ï¼š<ul><li>å°†è‡ªå·±çš„ <code>refs</code> æŒ‡å‘ã€å¤šä¸ªæœåŠ¡ã€‘çš„<strong>å¤šä¸ª</strong> TraceSegment ã€‚</li><li>å°†è‡ªå·±çš„ <code>relatedGlobalTraces</code> è®¾ç½®ä¸ºã€å¤šä¸ªæœåŠ¡ã€‘çš„<strong>å¤šä¸ª</strong> DistributedTraceId ã€‚</li></ul></li></ul><blockquote><p>å‹æƒ…æç¤ºï¼šå¤šä¸ªçˆ¸çˆ¸çš„æ•…äº‹ï¼Œå¯èƒ½æ¯”è¾ƒéš¾æ‡‚ï¼Œç­‰èƒ–å‹è¯»å®Œå…¨æ–‡ï¼Œåœ¨å›è¿‡å¤´æƒ³æƒ³ã€‚æˆ–è€…æ‹¿èµ·æ¥ä»£ç è°ƒè¯•è°ƒè¯•ã€‚</p></blockquote><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹ TraceSegment çš„æ¯ä¸ªå…ƒç´ ï¼Œæœ€åï¼Œæˆ‘ä»¬ä¼šå›è¿‡å¤´ï¼Œåœ¨ <a href="#">ã€Œ2.4 TraceSegmentã€</a> è¯¦ç»†è§£æå®ƒã€‚</p><h2 id="2-1-ID"><a href="#2-1-ID" class="headerlink" title="2.1 ID"></a>2.1 ID</h2><p><a href="https://github.com/YunaiV/skywalking/blob/cc27e35d69d922ba8fa38fbe4e8cc4704960f602/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/ID.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.ids.ID</code></a> ï¼Œç¼–å·ã€‚ä»ç±»çš„å®šä¹‰ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>é€šç”¨</strong>çš„ç¼–å·ï¼Œç”±ä¸‰æ®µæ•´æ•°ç»„æˆã€‚</p><p>ç›®å‰ä½¿ç”¨ GlobalIdGenerator ç”Ÿæˆï¼Œä½œä¸º<strong>å…¨å±€å”¯ä¸€ç¼–å·</strong>ã€‚å±æ€§å¦‚ä¸‹ï¼š</p><ul><li><code>part1</code> å±æ€§ï¼Œåº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>part2</code> å±æ€§ï¼Œçº¿ç¨‹ç¼–å·ã€‚</li><li><code>part3</code> å±æ€§ï¼Œæ—¶é—´æˆ³ä¸²ï¼Œç”Ÿæˆæ–¹å¼ä¸º <code>${æ—¶é—´æˆ³} * 10000 + çº¿ç¨‹è‡ªå¢åºåˆ—([0, 9999])</code> ã€‚ä¾‹å¦‚ï¼š15127007074950012 ã€‚å…·ä½“ç”Ÿæˆæ–¹æ³•çš„ä»£ç ï¼Œåœ¨ GlobalIdGenerator ä¸­è¯¦ç»†è§£æã€‚</li><li><code>encoding</code> å±æ€§ï¼Œç¼–ç åçš„å­—ç¬¦ä¸²ã€‚æ ¼å¼ä¸º <code>&quot;${part1}.${part2}.${part3}&quot;</code> ã€‚ä¾‹å¦‚ï¼Œ<code>&quot;12.35.15127007074950000&quot;</code> ã€‚<ul><li>ä½¿ç”¨ <a href="https://github.com/YunaiV/skywalking/blob/cc27e35d69d922ba8fa38fbe4e8cc4704960f602/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/ID.java#L83" rel="external nofollow noopener noreferrer" target="_blank"><code>#encode()</code></a> æ–¹æ³•ï¼Œç¼–ç ç¼–å·ã€‚</li></ul></li><li><code>isValid</code> å±æ€§ï¼Œç¼–å·æ˜¯å¦åˆæ³•ã€‚<ul><li>ä½¿ç”¨ <a href="https://github.com/YunaiV/skywalking/blob/cc27e35d69d922ba8fa38fbe4e8cc4704960f602/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/ID.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>ID(encodingString)</code></a> æ„é€ æ–¹æ³•ï¼Œè§£æå­—ç¬¦ä¸²ï¼Œç”Ÿæˆ ID ã€‚</li></ul></li></ul><h3 id="2-1-1-GlobalIdGenerator"><a href="#2-1-1-GlobalIdGenerator" class="headerlink" title="2.1.1 GlobalIdGenerator"></a>2.1.1 GlobalIdGenerator</h3><p><a href="https://github.com/YunaiV/skywalking/blob/9db53fd95e1c4c10f0f7a939e4484d7e2102ad3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/GlobalIdGenerator.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.ids.GlobalIdGenerator</code></a> ï¼Œå…¨å±€ç¼–å·ç”Ÿæˆå™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/9db53fd95e1c4c10f0f7a939e4484d7e2102ad3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/GlobalIdGenerator.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#generate()</code></a> æ–¹æ³•ï¼Œç”Ÿæˆ ID å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 67 è¡Œï¼šè·å¾—çº¿ç¨‹å¯¹åº”çš„ IDContext å¯¹è±¡ã€‚</li><li>ç¬¬ 69 è‡³ 73 è¡Œï¼šç”Ÿæˆ ID å¯¹è±¡ã€‚<ul><li>ç¬¬ 70 è¡Œï¼š<code>ID.part1</code> å±æ€§ï¼Œåº”ç”¨ç¼–å·å®ä¾‹ã€‚</li><li>ç¬¬ 71 è¡Œï¼š<code>ID.part2</code> å±æ€§ï¼Œçº¿ç¨‹ç¼–å·ã€‚</li><li>ç¬¬ 72 è¡Œï¼š<code>ID.part3</code> å±æ€§ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/9db53fd95e1c4c10f0f7a939e4484d7e2102ad3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/GlobalIdGenerator.java#L102" rel="external nofollow noopener noreferrer" target="_blank"><code>IDContext#nextSeq()</code></a> æ–¹æ³•ï¼Œç”Ÿæˆå¸¦æœ‰æ—¶é—´æˆ³çš„åºåˆ—å·ã€‚</li></ul></li><li>ps ï¼šä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œå·²ç»æ·»åŠ å®Œæˆæ³¨é‡Šã€‚</li></ul><h3 id="2-1-2-DistributedTraceId"><a href="#2-1-2-DistributedTraceId" class="headerlink" title="2.1.2 DistributedTraceId"></a>2.1.2 DistributedTraceId</h3><p><a href="https://github.com/YunaiV/skywalking/blob/5fb841b3ae5b78f07d06c6186adf9a8c08295a07/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/DistributedTraceId.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.ids.DistributedTraceId</code></a> ï¼Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç¼–å·<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><code>id</code> å±æ€§ï¼Œå…¨å±€ç¼–å·ã€‚</li></ul><p>DistributedTraceId æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5fb841b3ae5b78f07d06c6186adf9a8c08295a07/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/NewDistributedTraceId.java" rel="external nofollow noopener noreferrer" target="_blank">org.skywalking.apm.agent.core.context.ids.NewDistributedTraceId</a> ï¼Œ<strong>æ–°å»ºçš„</strong>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç¼–å·ã€‚å½“å…¨å±€é“¾è·¯è¿½è¸ªå¼€å§‹ï¼Œåˆ›å»º TraceSegment å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5fb841b3ae5b78f07d06c6186adf9a8c08295a07/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/NewDistributedTraceId.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>DistributedTraceId()</code> æ„é€ æ–¹æ³•</a>ï¼Œåˆ›å»º DistributedTraceId å¯¹è±¡ã€‚è¯¥æ„é€ æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ <code>GlobalIdGenerator#generate()</code> æ–¹æ³•ï¼Œåˆ›å»º ID å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5fb841b3ae5b78f07d06c6186adf9a8c08295a07/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/PropagatedTraceId.java" rel="external nofollow noopener noreferrer" target="_blank">org.skywalking.apm.agent.core.context.ids.PropagatedTraceId</a> ï¼Œ<strong>ä¼ æ’­çš„</strong>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç¼–å·ã€‚ä¾‹å¦‚ï¼ŒA æœåŠ¡è°ƒç”¨ B æœåŠ¡æ—¶ï¼ŒA æœåŠ¡ä¼šå°† DistributedTraceId å¯¹è±¡å¸¦ç»™ B æœåŠ¡ï¼ŒB æœåŠ¡ä¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5fb841b3ae5b78f07d06c6186adf9a8c08295a07/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/PropagatedTraceId.java#L30" rel="external nofollow noopener noreferrer" target="_blank"><code>PropagatedTraceId(String id)</code> æ„é€ æ–¹æ³•</a> ï¼Œåˆ›å»º PropagatedTraceId å¯¹è±¡ã€‚è¯¥æ„é€ æ–¹æ³•å†…éƒ¨ä¼šè§£æ id ï¼Œç”Ÿæˆ ID å¯¹è±¡ã€‚</li></ul><h3 id="2-1-3-DistributedTraceIds"><a href="#2-1-3-DistributedTraceIds" class="headerlink" title="2.1.3 DistributedTraceIds"></a>2.1.3 DistributedTraceIds</h3><p><a href="https://github.com/YunaiV/skywalking/blob/2961e9f539286ef91af1ff1ef7681d0a06f156b0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/DistributedTraceIds.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.ids.DistributedTraceIds</code></a> ï¼ŒDistributedTraceId æ•°ç»„çš„å°è£…ã€‚</p><ul><li><code>relatedGlobalTraces</code> å±æ€§ï¼Œå…³è”çš„ DistributedTraceId <strong>é“¾å¼</strong>æ•°ç»„ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ids/DistributedTraceIds.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#append(DistributedTraceId)</code></a> æ–¹æ³•ï¼Œæ·»åŠ åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç¼–å·( DistributedTraceId )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 51 è‡³ 54 è¡Œï¼šç§»é™¤<strong>é¦–ä¸ª</strong> NewDistributedTraceId å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåœ¨ <a href="#">ã€Œ2.4 TraceSegmentã€</a> çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¼šé»˜è®¤åˆ›å»º NewDistributedTraceId å¯¹è±¡ã€‚åœ¨è·¨çº¿ç¨‹ã€æˆ–è€…è·¨è¿›ç¨‹çš„æƒ…å†µä¸‹æ—¶ï¼Œåˆ›å»ºçš„ TraceSegment å¯¹è±¡ï¼Œéœ€è¦æŒ‡å‘çˆ¶ Segment çš„ DistributedTraceId ï¼Œæ‰€ä»¥éœ€è¦ç§»é™¤é»˜è®¤åˆ›å»ºçš„ã€‚</li><li>ç¬¬ 56 è‡³ 58 è¡Œï¼šæ·»åŠ  DistributedTraceId å¯¹è±¡åˆ°æ•°ç»„ã€‚</li></ul><h2 id="2-2-AbstractSpan"><a href="#2-2-AbstractSpan" class="headerlink" title="2.2 AbstractSpan"></a>2.2 AbstractSpan</h2><p><a href="https://github.com/YunaiV/skywalking/blob/96fd1f0aacb995f725c446b1cfcdc3124058e6a6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/AbstractSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.AbstractSpan</code></a> ï¼ŒSpan <strong>æ¥å£</strong>( ä¸æ˜¯æŠ½è±¡ç±» )ï¼Œå®šä¹‰äº† Span é€šç”¨å±æ€§çš„æ¥å£æ–¹æ³•ï¼š</p><ul><li><code>#getSpanId()</code> æ–¹æ³•ï¼Œè·å¾— Span ç¼–å·ã€‚ä¸€ä¸ªæ•´æ•°ï¼Œåœ¨ TraceSegment å†…<strong>å”¯ä¸€</strong>ï¼Œä» 0 å¼€å§‹è‡ªå¢ï¼Œåœ¨åˆ›å»º Span å¯¹è±¡æ—¶ç”Ÿæˆã€‚</li><li><code>#setOperationName(operationName)</code> æ–¹æ³•ï¼Œè®¾ç½®æ“ä½œåã€‚<ul><li>æ“ä½œåï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/01.png" alt=""></li><li><code>#setOperationId(operationId)</code> æ–¹æ³•ï¼Œè®¾ç½®æ“ä½œç¼–å·ã€‚è€ƒè™‘åˆ°æ“ä½œåæ˜¯å­—ç¬¦ä¸²ï¼ŒAgent å‘é€ç»™ Collector å ç”¨æµé‡è¾ƒå¤§ã€‚å› æ­¤ï¼ŒAgent ä¼šå°†æ“ä½œæ³¨å†Œåˆ° Collector ï¼Œç”Ÿæˆæ“ä½œç¼–å·ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent DictionaryManager å­—å…¸ç®¡ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><p><code>#setComponent(Component)</code> æ–¹æ³•ï¼Œè®¾ç½® <a href="https://github.com/YunaiV/skywalking/blob/a51e197a78f82400edae5c33b523ba1cb5224b8f/apm-network/src/main/java/org/skywalking/apm/network/trace/component/Component.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.network.trace.component.Component</code></a> ï¼Œä¾‹å¦‚ï¼šMongoDB / SpringMVC / Tomcat ç­‰ç­‰ã€‚ç›®å‰ï¼Œå®˜æ–¹åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/a51e197a78f82400edae5c33b523ba1cb5224b8f/apm-network/src/main/java/org/skywalking/apm/network/trace/component/ComponentsDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.network.trace.component.ComponentsDefine</code></a> å®šä¹‰äº†ç›®å‰å·²ç»æ”¯æŒçš„ Component ã€‚</p><ul><li><p><code>#setComponent(componentName)</code> æ–¹æ³•ï¼Œç›´æ¥è®¾ç½® Component åå­—ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨è¯¥æ–¹æ³•ã€‚</p><blockquote><p>Only use this method in explicit instrumentation, like opentracing-skywalking-bridge.<br>It it higher recommend donâ€™t use this for performance consideration.</p></blockquote></li></ul></li><li><p><code>#setLayer(SpanLayer)</code> æ–¹æ³•ï¼Œè®¾ç½® <a href="https://github.com/YunaiV/skywalking/blob/a51e197a78f82400edae5c33b523ba1cb5224b8f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/NoopSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.SpanLayer</code></a> ã€‚ç›®å‰æœ‰ï¼ŒDB ã€RPC_FRAMEWORK ã€HTTP ã€MQ ï¼Œæœªæ¥ä¼šå¢åŠ  CACHE ã€‚</p></li><li><p><code>#tag(key, value)</code> æ–¹æ³•ï¼Œè®¾ç½®é”®å€¼å¯¹çš„æ ‡ç­¾ã€‚å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œæ„æˆ Span çš„æ ‡ç­¾é›†åˆã€‚åœ¨ <a href="#">ã€Œ2.2.1 Tagã€</a> è¯¦ç»†è§£æã€‚</p></li><li>æ—¥å¿—ç›¸å…³<ul><li><code>#log(timestampMicroseconds, fields)</code> æ–¹æ³•ï¼Œè®°å½•ä¸€æ¡é€šç”¨æ—¥å¿—ï¼ŒåŒ…å« <code>fields</code> é”®å€¼å¯¹é›†åˆã€‚</li><li><code>#log(Throwable)</code> æ–¹æ³•ï¼Œè®°å½•ä¸€æ¡å¼‚å¸¸æ—¥å¿—ï¼ŒåŒ…å«å¼‚å¸¸ä¿¡æ¯ã€‚ </li></ul></li><li><code>#errorOccurred()</code> æ–¹æ³•ï¼Œæ ‡è®°å‘ç”Ÿå¼‚å¸¸ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé…ç½® <code>#log(Throwable)</code> æ–¹æ³•ä¸€èµ·ä½¿ç”¨ã€‚</li><li><code>#start()</code> æ–¹æ³•ï¼Œå¼€å§‹ Span ã€‚ä¸€èˆ¬æƒ…å†µçš„å®ç°ï¼Œè®¾ç½®å¼€å§‹æ—¶é—´ã€‚</li><li><code>#isEntry()</code> æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯å…¥å£ Span ï¼Œåœ¨ <a href="#">ã€Œ2.2.2.1 EntrySpanã€</a> è¯¦ç»†è§£æã€‚</li><li><code>#isExit()</code> æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯å‡ºå£ Span ï¼Œåœ¨ <a href="#">ã€Œ2.2.2.2 ExitSpanã€</a> è¯¦ç»†è§£æã€‚</li></ul><h3 id="2-2-1-Tag"><a href="#2-2-1-Tag" class="headerlink" title="2.2.1 Tag"></a>2.2.1 Tag</h3><h4 id="2-2-1-1-AbstractTag"><a href="#2-2-1-1-AbstractTag" class="headerlink" title="2.2.1.1 AbstractTag"></a>2.2.1.1 AbstractTag</h4><p><a href="https://github.com/YunaiV/skywalking/blob/e0c449745dfabe847b2e918d5352381f191a4469/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/tag/AbstractTag.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.tag.AbstractTag&lt;T&gt;</code></a> ï¼Œæ ‡ç­¾<strong>æŠ½è±¡ç±»</strong>ã€‚æ³¨æ„ï¼Œè¿™ä¸ªç±»çš„ç”¨é€”æ˜¯å°†æ ‡ç­¾å±æ€§è®¾ç½®åˆ° Span ä¸Šï¼Œæˆ–è€…è¯´ï¼Œå®ƒæ˜¯è®¾ç½® Span çš„æ ‡ç­¾çš„<strong>å·¥å…·ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>key</code> å±æ€§ï¼Œæ ‡ç­¾çš„é”®ã€‚</li><li><code>#set(AbstractSpan span, T tagValue)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè®¾ç½® Span çš„æ ‡ç­¾é”® <code>key</code> çš„å€¼ä¸º <code>tagValue</code> ã€‚</li></ul><h4 id="2-2-1-2-StringTag"><a href="#2-2-1-2-StringTag" class="headerlink" title="2.2.1.2 StringTag"></a>2.2.1.2 StringTag</h4><p><a href="https://github.com/YunaiV/skywalking/blob/e0c449745dfabe847b2e918d5352381f191a4469/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/tag/StringTag.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.tag.StringTag</code></a> ï¼Œå€¼ç±»å‹ä¸º String çš„æ ‡ç­¾<strong>å®ç°ç±»</strong>ã€‚</p><ul><li><code>#set(AbstractSpan span, String tagValue)</code> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè®¾ç½® Span çš„æ ‡ç­¾é”® <code>key</code> çš„å€¼ä¸º <code>tagValue</code> ã€‚</li></ul><h4 id="2-2-1-3-Tags"><a href="#2-2-1-3-Tags" class="headerlink" title="2.2.1.3 Tags"></a>2.2.1.3 Tags</h4><p><a href="https://github.com/YunaiV/skywalking/blob/e0c449745dfabe847b2e918d5352381f191a4469/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/tag/Tags.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.tag.Tags</code></a> ï¼Œ<strong>å¸¸ç”¨</strong> Tag <strong>æšä¸¾ç±»</strong>ï¼Œå†…éƒ¨å®šä¹‰äº†<strong>å¤šä¸ª</strong> HTTP ã€DB ç›¸å…³çš„ StringTag çš„é™æ€å˜é‡ã€‚</p><p>åœ¨ <a href="https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/semantic_conventions.md#%E6%A0%87%E5%87%86%E7%9A%84span-tag-%E5%92%8C-log-field" rel="external nofollow noopener noreferrer" target="_blank">ã€Šopentracing-specification-zh â€”â€” è¯­ä¹‰æƒ¯ä¾‹ã€‹</a> é‡Œï¼Œå®šä¹‰äº†æ ‡å‡†çš„ Span Tag ã€‚</p><h3 id="2-2-2-AbstractSpan-å®ç°ç±»"><a href="#2-2-2-AbstractSpan-å®ç°ç±»" class="headerlink" title="2.2.2 AbstractSpan å®ç°ç±»"></a>2.2.2 AbstractSpan å®ç°ç±»</h3><p>AbstractSpan å®ç°ç±»å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/03.png" alt=""></p><ul><li>å·¦åŠè¾¹çš„ Span å®ç°ç±»ï¼š<strong>æœ‰</strong>å…·ä½“æ“ä½œçš„ Span ã€‚</li><li>å³åŠè¾¹çš„ Span å®ç°ç±»ï¼š<strong>æ— </strong>å…·ä½“æ“ä½œçš„ Span ï¼Œå’Œå·¦åŠè¾¹çš„ Span å®ç°ç±»<strong>ç›¸å¯¹</strong>ï¼Œç”¨äºä¸éœ€è¦æ”¶é›† Span çš„åœºæ™¯ã€‚</li></ul><p>æŠ›å¼€å³åŠè¾¹çš„ Span å®ç°ç±»çš„ç‰¹æ®Šå¤„ç†ï¼ŒSpan åªæœ‰ä¸‰ç§å®ç°ç±»ï¼š</p><ul><li>EntrySpan ï¼šå…¥å£ Span</li><li>LocalSpan ï¼šæœ¬åœ° Span</li><li>ExitSpan ï¼šå‡ºå£ Span</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ†å°èŠ‚é€æ­¥åˆ†äº«ã€‚</p><h4 id="2-2-2-1-AbstractTracingSpan"><a href="#2-2-2-1-AbstractTracingSpan" class="headerlink" title="2.2.2.1 AbstractTracingSpan"></a>2.2.2.1 AbstractTracingSpan</h4><p><a href="https://github.com/YunaiV/skywalking/blob/11b66b8d36943d6492f51c676b455f29c9c0abc6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/AbstractTracingSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.AbstractTracingSpan</code></a> ï¼Œå®ç° AbstractSpan æ¥å£ï¼Œé“¾è·¯è¿½è¸ª Span <strong>æŠ½è±¡ç±»</strong>ã€‚</p><p>åœ¨åˆ›å»º AbstractTracingSpan æ—¶ï¼Œä¼šä¼ å…¥ <code>spanId</code> , <code>parentSpanId</code> , <code>operationName</code> / <code>operationId</code> å‚æ•°ã€‚å‚è§æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>#AbstractTracingSpan(spanId, parentSpanId, operationName)</code></li><li><code>#AbstractTracingSpan(spanId, parentSpanId, operationId)</code></li></ul><hr><p>å¤§éƒ¨åˆ†æ˜¯ setting / getting æ–¹æ³•ï¼Œæˆ–è€…ç±»ä¼¼æ–¹æ³•ï¼Œå·²ç»æ·»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/11b66b8d36943d6492f51c676b455f29c9c0abc6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/AbstractTracingSpan.java#L126" rel="external nofollow noopener noreferrer" target="_blank"><code>#finish(TraceSegment)</code></a> æ–¹æ³•ï¼Œå®Œæˆ( ç»“æŸ ) Span ï¼Œå°†å½“å‰ Span ( è‡ªå·± )æ·»åŠ åˆ° TraceSegment ã€‚ä¸ºä»€ä¹ˆä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ3. Contextã€</a> è¯¦ç»†è§£æã€‚</p><h4 id="2-2-2-2-StackBasedTracingSpan"><a href="#2-2-2-2-StackBasedTracingSpan" class="headerlink" title="2.2.2.2 StackBasedTracingSpan"></a>2.2.2.2 StackBasedTracingSpan</h4><p> <a href="https://github.com/YunaiV/skywalking/blob/c1e513b4581443e7ca720f4e9c91ad97cc6f0de1/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/StackBasedTracingSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.StackBasedTracingSpan</code></a> ï¼Œå®ç° AbstractTracingSpan æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>æ ˆ</strong>çš„é“¾è·¯è¿½è¸ª Span æŠ½è±¡ç±»ã€‚è¿™ç§ Span èƒ½å¤Ÿè¢«å¤šæ¬¡è°ƒç”¨ <code>#start(...)</code> å’Œ <code>#finish(...)</code> æ–¹æ³•ï¼Œåœ¨ç±»ä¼¼å †æ ˆçš„è°ƒç”¨ä¸­ã€‚åœ¨ <a href="#">ã€Œ2.2.2.2.1 EntrySpanã€</a> ä¸­è¯¦ç»†ä¸¾ä¾‹å­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>stackDepth</code> å±ï¼Œ<strong>æ ˆ</strong>æ·±åº¦ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/c1e513b4581443e7ca720f4e9c91ad97cc6f0de1/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/StackBasedTracingSpan.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#finish(TraceSegment)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå®Œæˆ( ç»“æŸ ) Span ï¼Œå°†å½“å‰ Span ( è‡ªå·± )æ·»åŠ åˆ° TraceSegment ã€‚<strong>å½“ä¸”ä»…å½“ <code>stackDepth == 0</code> æ—¶ï¼Œæ·»åŠ æˆåŠŸ</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 53 è‡³ 73 è¡Œï¼šæ ˆæ·±åº¦ä¸ºé›¶ï¼Œå‡ºæ ˆæˆåŠŸã€‚è°ƒç”¨ <code>super#finish(TraceSegment)</code> æ–¹æ³•ï¼Œå®Œæˆ( ç»“æŸ ) Span ï¼Œå°†å½“å‰ Span ( è‡ªå·± )æ·»åŠ åˆ° TraceSegment ã€‚<ul><li>ç¬¬ 55 è‡³ 72 è¡Œï¼šå½“æ“ä½œç¼–å·ä¸ºç©ºæ—¶ï¼Œå°è¯•ä½¿ç”¨æ“ä½œåè·å¾—æ“ä½œç¼–å·å¹¶è®¾ç½®ã€‚ç”¨äº<strong>å‡å°‘</strong> Agent å‘é€ Collector æ•°æ®çš„ç½‘ç»œæµé‡ã€‚</li></ul></li><li>ç¬¬ 74 è‡³ 76 è¡Œï¼šæ ˆæ·±åº¦éé›¶ï¼Œå‡ºæ ˆå¤±è´¥ã€‚</li></ul></li></ul><h5 id="2-2-2-2-1-EntrySpan"><a href="#2-2-2-2-1-EntrySpan" class="headerlink" title="2.2.2.2.1 EntrySpan"></a>2.2.2.2.1 EntrySpan</h5><p><strong>é‡ç‚¹</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/d36f6a47a208720f4caac9d9a8b7263bd36f2187/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/EntrySpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.EntrySpan</code></a> ï¼Œå®ç° StackBasedTracingSpan æŠ½è±¡ç±»ï¼Œ<strong>å…¥å£</strong> Span ï¼Œç”¨äºæœåŠ¡æä¾›è€…( Service Provider ) ï¼Œä¾‹å¦‚ Tomcat ã€‚</p><p>EntrySpan æ˜¯ TraceSegment çš„ç¬¬ä¸€ä¸ª Span ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç§°ä¸ºâ€<strong>å…¥å£</strong>â€œ Span çš„åŸå› ã€‚</p><p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆ EntrySpan ç»§æ‰¿ StackBasedTracingSpan</strong> ï¼Ÿ</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ SprintBoot åœºæ™¯ä¸‹ï¼ŒAgent ä¼šåœ¨ SkyWalking æ’ä»¶åœ¨ Tomcat å®šä¹‰çš„æ–¹æ³•åˆ‡é¢ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ï¼Œä¹Ÿä¼šåœ¨ SkyWalking æ’ä»¶åœ¨ SpringMVC å®šä¹‰çš„æ–¹æ³•åˆ‡é¢ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚é‚£å²‚ä¸æ˜¯å‡ºç°<strong>ä¸¤ä¸ª</strong> EntrySpan ï¼Œä¸€ä¸ª TraceSegment å‡ºç°äº†ä¸¤ä¸ªå…¥å£ Span ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯å½“ç„¶ä¸ä¼šï¼Agent åªä¼šåœ¨ç¬¬ä¸€ä¸ªæ–¹æ³•åˆ‡é¢ï¼Œç”Ÿæˆ EntrySpan å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ–¹æ³•åˆ‡é¢ï¼Œæ ˆæ·±åº¦ <strong>+ 1</strong>ã€‚è¿™ä¹Ÿæ˜¯ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ <code>#finish(TraceSegment)</code> æ–¹æ³•ï¼Œåªåœ¨æ ˆæ·±åº¦ä¸ºé›¶æ—¶ï¼Œå‡ºæ ˆæˆåŠŸã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä¿æŒä¸€ä¸ª TraceSegment æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª EntrySpan å¯¹è±¡ã€‚</p><p>å½“ç„¶ï¼Œå¤šä¸ª TraceSegment ä¼šæœ‰å¤šä¸ª EntrySpan å¯¹è±¡ ï¼Œä¾‹å¦‚ã€æœåŠ¡ Aã€‘è¿œç¨‹è°ƒç”¨ã€æœåŠ¡ Bã€‘ã€‚</p><p>å¦å¤–ï¼Œè™½ç„¶ EntrySpan åœ¨ç¬¬ä¸€ä¸ªæœåŠ¡æä¾›è€…åˆ›å»ºï¼ŒEntrySpan ä»£è¡¨çš„æ˜¯æœ€åä¸€ä¸ªæœåŠ¡æä¾›è€…ï¼Œä¾‹å¦‚ï¼Œä¸Šé¢çš„ä¾‹å­ï¼ŒEntrySpan ä»£è¡¨çš„æ˜¯ Spring MVC çš„æ–¹æ³•åˆ‡é¢ã€‚æ‰€ä»¥ï¼Œ<code>startTime</code> å’Œ <code>endTime</code> ä»¥ç¬¬ä¸€ä¸ªä¸ºå‡†ï¼Œ<code>componentId</code> ã€<code>componentName</code> ã€<code>layer</code> ã€<code>logs</code> ã€<code>tags</code> ã€<code>operationName</code> ã€<code>operationId</code> ç­‰ç­‰ä»¥æœ€åä¸€ä¸ªä¸ºå‡†ã€‚å¹¶ä¸”ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åä¸€ä¸ªæœåŠ¡æä¾›è€…çš„ä¿¡æ¯ä¹Ÿä¼š<strong>æ›´åŠ è¯¦ç»†</strong>ã€‚</p><p><strong>ps</strong>ï¼šå¦‚ä¸Šå†…å®¹ä¿¡æ¯é‡è¾ƒå¤§ï¼Œèƒ–å‹å¯ä»¥å¯¹ç…§ç€å®ç°æ–¹æ³•ï¼Œåœ¨ç†è§£ç†è§£ã€‚HOHO ï¼Œè‰¯å¿ƒç¬”è€…å½“ç„¶ä¹Ÿæ˜¯åŠ äº†æ³¨é‡Šçš„ã€‚</p><p>å¦‚ä¸‹æ˜¯ä¸€ä¸ª EntrySpan åœ¨ SkyWalking å±•ç¤ºçš„ä¾‹å­ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/04.png" alt=""></p><h5 id="2-2-2-2-2-ExitSpan"><a href="#2-2-2-2-2-ExitSpan" class="headerlink" title="2.2.2.2.2 ExitSpan"></a>2.2.2.2.2 ExitSpan</h5><p><strong>é‡ç‚¹</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/958830d8db481b5b8a70498a09bc18eb7c721737/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/ExitSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.ExitSpan</code></a> ï¼Œç»§æ‰¿ StackBasedTracingSpan æŠ½è±¡ç±»ï¼Œ<strong>å‡ºå£</strong> Span ï¼Œç”¨äºæœåŠ¡æ¶ˆè´¹è€…( Service Consumer ) ï¼Œä¾‹å¦‚ HttpClient ã€MongoDBClient ã€‚</p><hr><p>ExitSpan å®ç° <a href="https://github.com/YunaiV/skywalking/blob/958830d8db481b5b8a70498a09bc18eb7c721737/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/WithPeerInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.WithPeerInfo</code></a> æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>peer</code> å±æ€§ï¼ŒèŠ‚ç‚¹åœ°å€ã€‚</li><li><code>peerId</code> å±æ€§ï¼ŒèŠ‚ç‚¹ç¼–å·ã€‚</li></ul><p>å¦‚ä¸‹æ˜¯ä¸€ä¸ª ExitSpan åœ¨ SkyWalking å±•ç¤ºçš„ä¾‹å­ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/05.png" alt=""></p><hr><p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆ ExitSpan ç»§æ‰¿ StackBasedTracingSpan</strong> ï¼Ÿ</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½åœ¨ä½¿ç”¨çš„ Dubbox åœºæ™¯ä¸‹ï¼Œã€Dubbox æœåŠ¡ Aã€‘ä½¿ç”¨ HTTP è°ƒç”¨ã€Dubbox æœåŠ¡ Bã€‘æ—¶ï¼Œå®é™…è¿‡ç¨‹æ˜¯ï¼Œã€Dubbox æœåŠ¡ Aã€‘=ã€‹ã€HttpClientã€‘=ã€‹ã€Dubbox æœåŠ¡ Bã€‘ã€‚Agent ä¼šåœ¨ã€Dubbox æœåŠ¡ Aã€‘åˆ›å»º ExitSpan å¯¹è±¡ï¼Œä¹Ÿä¼šåœ¨ ã€HttpClientã€‘åˆ›å»º ExitSpan å¯¹è±¡ã€‚é‚£å²‚ä¸æ˜¯<strong>ä¸€æ¬¡å‡ºå£</strong>ï¼Œå‡ºç°<strong>ä¸¤ä¸ª</strong> ExitSpan ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯å½“ç„¶ä¸ä¼šï¼Agent åªä¼šåœ¨ã€Dubbox æœåŠ¡ Aã€‘ï¼Œç”Ÿæˆ EntrySpan å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ–¹æ³•åˆ‡é¢ï¼Œæ ˆæ·±åº¦ <strong>+ 1</strong>ã€‚è¿™ä¹Ÿæ˜¯ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ <code>#finish(TraceSegment)</code> æ–¹æ³•ï¼Œåªåœ¨æ ˆæ·±åº¦ä¸ºé›¶æ—¶ï¼Œå‡ºæ ˆæˆåŠŸã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä¿æŒ<strong>ä¸€æ¬¡å‡ºå£</strong>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ExitSpan å¯¹è±¡ã€‚</p><p>å½“ç„¶ï¼Œä¸€ä¸ª TraceSegment ä¼šæœ‰å¤šä¸ª ExitSpan å¯¹è±¡ ï¼Œä¾‹å¦‚ã€æœåŠ¡ Aã€‘è¿œç¨‹è°ƒç”¨ã€æœåŠ¡ Bã€‘ï¼Œç„¶åã€æœåŠ¡ Aã€‘å†æ¬¡è¿œç¨‹è°ƒç”¨ã€æœåŠ¡ Bã€‘ï¼Œæˆ–è€…ç„¶åã€æœåŠ¡ Aã€‘è¿œç¨‹è°ƒç”¨ã€æœåŠ¡ Cã€‘ã€‚</p><p>å¦å¤–ï¼Œè™½ç„¶ ExitSpan åœ¨ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…åˆ›å»ºï¼ŒExitSpan ä»£è¡¨çš„ä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªæœåŠ¡ææ¶ˆè´¹è€…ï¼Œä¾‹å¦‚ï¼Œä¸Šé¢çš„ä¾‹å­ï¼ŒExitSpan ä»£è¡¨çš„æ˜¯ã€Dubbox æœåŠ¡ Aã€‘ã€‚</p><p><strong>ps</strong>ï¼šå¦‚ä¸Šå†…å®¹ä¿¡æ¯é‡è¾ƒå¤§ï¼Œèƒ–å‹å¯ä»¥å¯¹ç…§ç€å®ç°æ–¹æ³•ï¼Œåœ¨ç†è§£ç†è§£ã€‚HOHO ï¼Œè‰¯å¿ƒç¬”è€…å½“ç„¶ä¹Ÿæ˜¯åŠ äº†æ³¨é‡Šçš„ã€‚</p><h4 id="2-2-2-3-LocalSpan"><a href="#2-2-2-3-LocalSpan" class="headerlink" title="2.2.2.3 LocalSpan"></a>2.2.2.3 LocalSpan</h4><p><a href="https://github.com/YunaiV/skywalking/blob/96fd1f0aacb995f725c446b1cfcdc3124058e6a6/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/LocalSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.LocalSpan</code></a> ï¼Œç»§æ‰¿ AbstractTracingSpan æŠ½è±¡ç±»ï¼Œæœ¬åœ° Span ï¼Œç”¨äºä¸€ä¸ªæ™®é€šæ–¹æ³•çš„é“¾è·¯è¿½è¸ªï¼Œä¾‹å¦‚æœ¬åœ°æ–¹æ³•ã€‚</p><p>å¦‚ä¸‹æ˜¯ä¸€ä¸ª EntrySpan åœ¨ SkyWalking å±•ç¤ºçš„ä¾‹å­ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/06.png" alt=""></p><h4 id="2-2-2-4-NoopSpan"><a href="#2-2-2-4-NoopSpan" class="headerlink" title="2.2.2.4 NoopSpan"></a>2.2.2.4 NoopSpan</h4><p><a href="https://github.com/YunaiV/skywalking/blob/f00d2f405ca23e89778febeb4ada7b389858f258/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/NoopSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.NoopSpan</code></a> ï¼Œå®ç° AbstractSpan æ¥å£ï¼Œ<strong>æ— æ“ä½œ</strong>çš„ Span ã€‚é…ç½® IgnoredTracerContext ä¸€èµ·ä½¿ç”¨ï¼Œåœ¨ IgnoredTracerContext å£°æ˜<a href="https://github.com/YunaiV/skywalking/blob/f00d2f405ca23e89778febeb4ada7b389858f258/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/IgnoredTracerContext.java#L37" rel="external nofollow noopener noreferrer" target="_blank">å•ä¾‹</a> ï¼Œä»¥å‡å°‘ä¸æ”¶é›† Span æ—¶çš„å¯¹è±¡åˆ›å»ºï¼Œè¾¾åˆ°å‡å°‘å†…å­˜ä½¿ç”¨å’Œ GC æ—¶é—´ã€‚</p><h5 id="2-2-2-3-1-NoopExitSpan"><a href="#2-2-2-3-1-NoopExitSpan" class="headerlink" title="2.2.2.3.1 NoopExitSpan"></a>2.2.2.3.1 NoopExitSpan</h5><p><a href="https://github.com/YunaiV/skywalking/blob/f00d2f405ca23e89778febeb4ada7b389858f258/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/ExitSpan.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.NoopExitSpan</code></a> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/958830d8db481b5b8a70498a09bc18eb7c721737/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/WithPeerInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.WithPeerInfo</code></a> æ¥å£ï¼Œç»§æ‰¿ StackBasedTracingSpan æŠ½è±¡ç±»ï¼Œ<strong>å‡ºå£</strong> Span ï¼Œæ— æ“ä½œçš„<strong>å‡ºå£</strong> Span ã€‚å’Œ ExitSpan <strong>ç›¸å¯¹</strong>ï¼Œä¸è®°å½•æœåŠ¡æ¶ˆè´¹è€…çš„å‡ºå£ Span ã€‚</p><h2 id="2-3-TraceSegmentRef"><a href="#2-3-TraceSegmentRef" class="headerlink" title="2.3 TraceSegmentRef"></a>2.3 TraceSegmentRef</h2><p><a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.trace.TraceSegmentRef</code></a> ï¼ŒTraceSegment æŒ‡å‘ï¼Œé€šè¿‡ <code>traceSegmentId</code> å’Œ <code>spanId</code> å±æ€§ï¼ŒæŒ‡å‘çˆ¶çº§ TraceSegment çš„æŒ‡å®š Span ã€‚</p><ul><li><p><code>type</code> å±æ€§ï¼ŒæŒ‡å‘ç±»å‹( <a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L206" rel="external nofollow noopener noreferrer" target="_blank">SegmentRefType</a> ) ã€‚ä¸åŒçš„æŒ‡å‘ç±»å‹ï¼Œä½¿ç”¨ä¸åŒçš„æ„é€ æ–¹æ³•ã€‚</p><ul><li><code>CROSS_PROCESS</code> ï¼Œè·¨è¿›ç¨‹ï¼Œä¾‹å¦‚è¿œç¨‹è°ƒç”¨ï¼Œå¯¹åº”æ„é€ æ–¹æ³• <a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L97" rel="external nofollow noopener noreferrer" target="_blank">#TraceSegmentRef(ContextCarrier)</a> ã€‚ </li><li><code>CROSS_THREAD</code> ï¼Œè·¨çº¿ç¨‹ï¼Œä¾‹å¦‚å¼‚æ­¥çº¿ç¨‹ä»»åŠ¡ï¼Œå¯¹åº”æ„é€ æ–¹æ³• <a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L123" rel="external nofollow noopener noreferrer" target="_blank">#TraceSegmentRef(ContextSnapshot)</a> ã€‚</li><li>æ„é€ æ–¹æ³•çš„ä»£ç ï¼Œåœ¨ <a href="#">ã€Œ3. Contextã€</a> ä¸­ï¼Œä¼´éšç€è°ƒç”¨è¿‡ç¨‹ï¼Œä¸€èµ·è§£æã€‚</li></ul></li><li><p><code>traceSegmentId</code> å±æ€§ï¼Œ<strong>çˆ¶</strong> TraceSegment ç¼–å·ã€‚<strong>é‡è¦</strong></p></li><li><code>spanId</code> å±æ€§ï¼Œ<strong>çˆ¶</strong> Span ç¼–å·ã€‚<strong>é‡è¦</strong></li><li><code>peerId</code> å±æ€§ï¼ŒèŠ‚ç‚¹ç¼–å·ã€‚<strong>æ³¨æ„ï¼Œæ­¤å¤„çš„èŠ‚ç‚¹ç¼–å·å°±æ˜¯åº”ç”¨( Application )ç¼–å·</strong>ã€‚</li><li><code>peerHost</code> å±æ€§ï¼ŒèŠ‚ç‚¹åœ°å€ã€‚</li><li><code>entryApplicationInstanceId</code> å±æ€§ï¼Œ<strong>å…¥å£</strong>åº”ç”¨å®ä¾‹ç¼–å·ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼é“¾è·¯ <code>A-&gt;B-&gt;C</code> ä¸­ï¼Œæ­¤å­—æ®µä¸º A åº”ç”¨çš„å®ä¾‹ç¼–å·ã€‚</li><li><code>parentApplicationInstanceId</code> å±æ€§ï¼Œ<strong>çˆ¶</strong>åº”ç”¨å®ä¾‹ç¼–å·ã€‚</li><li><code>entryOperationName</code> å±æ€§ï¼Œ<strong>å…¥å£</strong>æ“ä½œåã€‚</li><li><code>entryOperationId</code> å±æ€§ï¼Œ<strong>å…¥å£</strong>æ“ä½œç¼–å·ã€‚</li><li><code>parentOperationName</code> å±æ€§ï¼Œ<strong>çˆ¶</strong>æ“ä½œåã€‚</li><li><code>parentOperationId</code> å±æ€§ï¼Œ<strong>çˆ¶</strong>æ“ä½œç¼–å·ã€‚</li></ul><h2 id="2-4-TraceSegment"><a href="#2-4-TraceSegment" class="headerlink" title="2.4 TraceSegment"></a>2.4 TraceSegment</h2><p>åœ¨çœ‹å®Œäº† TraceSegment çš„å„ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ TraceSegment å†…éƒ¨å®ç°çš„æ–¹æ³•ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L79" rel="external nofollow noopener noreferrer" target="_blank">TraceSegment æ„é€ æ–¹æ³•</a>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 80 è¡Œï¼šè°ƒç”¨ <code>GlobalIdGenerator#generate()</code> æ–¹æ³•ï¼Œç”Ÿæˆ ID å¯¹è±¡ï¼Œèµ‹å€¼ç»™ <code>traceSegmentId</code> ã€‚</li><li>ç¬¬ 81 è¡Œï¼šåˆ›å»º <code>spans</code> æ•°ç»„ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>#archive(AbstractTracingSpan)</code></a> æ–¹æ³•ï¼Œè¢« <code>AbstractSpan#finish(TraceSegment)</code> æ–¹æ³•è°ƒç”¨ï¼Œæ·»åŠ åˆ° <code>spans</code> æ•°ç»„ã€‚</li></ul></li><li>ç¬¬ 83 è‡³ 84 è¡Œï¼šåˆ›å»º DistributedTraceIds å¯¹è±¡ï¼Œå¹¶æ·»åŠ  NewDistributedTraceId åˆ°å®ƒã€‚<ul><li><strong>æ³¨æ„</strong>ï¼Œå½“ TraceSegment æ˜¯ä¸€æ¬¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªçš„<strong>é¦–æ¡</strong>è®°å½•ï¼Œåˆ›å»ºçš„ NewDistributedTraceId å¯¹è±¡ï¼Œå³ä¸ºåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªçš„<strong>å…¨å±€ç¼–å·</strong>ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L104" rel="external nofollow noopener noreferrer" target="_blank"><code>#relatedGlobalTraces(DistributedTraceId)</code></a> æ–¹æ³•ï¼Œæ·»åŠ  DistributedTraceId å¯¹è±¡ã€‚è¢« <code>TracingContext#continued(ContextSnapshot)</code> æˆ–è€… <code>TracingContext#extract(ContextCarrier)</code> æ–¹æ³•è°ƒç”¨ï¼Œåœ¨ <a href="#">ã€Œ3. Contextã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegment.java#L92" rel="external nofollow noopener noreferrer" target="_blank"><code>#ref(TraceSegmentRef)</code></a> æ–¹æ³•ï¼Œæ·»åŠ  TraceSegmentRef å¯¹è±¡ï¼Œåˆ° <code>refs</code> å±æ€§ï¼Œå³<strong>æŒ‡å‘</strong>çˆ¶ Segment ã€‚</p><h1 id="3-Context"><a href="#3-Context" class="headerlink" title="3. Context"></a>3. Context</h1><p>åœ¨ <a href="#">ã€Œ2. Traceã€</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹äº† Trace çš„æ•°æ®ç»“æ„ï¼Œæœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ Context æ˜¯æ€ä¹ˆæ”¶é›† Trace æ•°æ®çš„ã€‚</p><h2 id="3-1-ContextManager"><a href="#3-1-ContextManager" class="headerlink" title="3.1 ContextManager"></a>3.1 ContextManager</h2><p><code>org.skywalking.apm.agent.core.context.ContextManager</code> ï¼Œå®ç°äº† BootService ã€TracingContextListener ã€IgnoreTracerContextListener æ¥å£ï¼Œé“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>CONTEXT</code></a> <strong>é™æ€</strong>å±æ€§ï¼Œçº¿ç¨‹å˜é‡ï¼Œå­˜å‚¨ AbstractTracerContext å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆæ˜¯<strong>çº¿ç¨‹å˜é‡</strong>å‘¢ï¼Ÿ</p><p><strong>ä¸€ä¸ª</strong> TraceSegment å¯¹è±¡ï¼Œå…³è”åˆ°<strong>ä¸€ä¸ª</strong>çº¿ç¨‹ï¼Œè´Ÿè´£æ”¶é›†è¯¥çº¿ç¨‹çš„é“¾è·¯è¿½è¸ªæ•°æ®ï¼Œå› æ­¤ä½¿ç”¨çº¿ç¨‹å˜é‡ã€‚</p><p>è€Œ<strong>ä¸€ä¸ª</strong> AbstractTracerContext ä¼šå…³è”<strong>ä¸€ä¸ª</strong> TraceSegment å¯¹è±¡ï¼ŒContextManager è´Ÿè´£è·å–ã€åˆ›å»ºã€é”€æ¯ AbstractTracerContext å¯¹è±¡ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(operationName, forceSampling)</code></a> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å– AbstractTracerContext å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œ<strong>åˆ›å»º</strong>ã€‚</p><ul><li><strong>è¦</strong>éœ€è¦æ”¶é›† Trace æ•°æ®çš„æƒ…å†µä¸‹ï¼Œåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java" rel="external nofollow noopener noreferrer" target="_blank">TracingContext</a> å¯¹è±¡ã€‚</li><li><strong>ä¸</strong>éœ€è¦æ”¶é›† Trace æ•°æ®çš„æƒ…å†µä¸‹ï¼Œåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/IgnoredTracerContext.java" rel="external nofollow noopener noreferrer" target="_blank">IgnoredTracerContext</a> å¯¹è±¡ã€‚</li></ul><p>åœ¨ä¸‹é¢çš„ <code>#createEntrySpan(...)</code> ã€<code>#createLocalSpan(...)</code> ã€<code>#createExitSpan(...)</code> ç­‰ç­‰æ–¹æ³•ä¸­ï¼Œéƒ½ä¼šè°ƒç”¨ AbstractTracerContext æä¾›çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•çš„ä»£ç ï¼Œæˆ‘ä»¬æ”¾åœ¨ <a href="#">ã€Œ3.2 AbstractTracerContextã€</a> ä¸€èµ·è§£æï¼Œä¿è¯æµç¨‹çš„æ•´ä½“æ€§ã€‚</p><p>å¦å¤–ï¼ŒContextManager å°è£…äº†<strong>æ‰€æœ‰</strong> AbstractTracerContext æä¾›çš„æ–¹æ³•ï¼Œä»è€Œå®ç°ï¼Œå¤–éƒ¨è°ƒç”¨è€…ï¼Œä¾‹å¦‚ SkyWalking çš„æ’ä»¶ï¼Œåªè°ƒç”¨ ContextManager çš„æ–¹æ³•ï¼Œè€Œä¸è°ƒç”¨ AbstractTracerContext çš„æ–¹æ³•ã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L201" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå¯åŠ¨æ—¶ï¼Œå°†è‡ªå·±æ³¨å†Œåˆ° <a href="">TracingContext.ListenerManager</a> å’Œ <a href="">IgnoredTracerContext.ListenerManager</a> ä¸­ï¼Œè¿™æ ·ä¸€æ¬¡é“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡( Context )å®Œæˆæ—¶ï¼Œä»è€Œè¢«å›è°ƒå¦‚ä¸‹æ–¹æ³•ï¼Œæ¸…ç†ä¸Šä¸‹æ–‡ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L216" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterFinished(TraceSegment)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/ad259ad680df86296036910ede262765ffb44e5e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L221" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterFinished(IgnoredTracerContext)</code></a></li></ul><h2 id="3-2-AbstractTracerContext"><a href="#3-2-AbstractTracerContext" class="headerlink" title="3.2 AbstractTracerContext"></a>3.2 AbstractTracerContext</h2><p><a href="https://github.com/YunaiV/skywalking/blob/2a75efbeddac2b9565816af0ab0873ec3d998424/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/AbstractTracerContext.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.AbstractTracerContext</code></a> ï¼Œé“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡<strong>æ¥å£</strong>ã€‚å®šä¹‰äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li><code>#getReadableGlobalTraceId()</code> æ–¹æ³•ï¼Œè·å¾—<strong>å…³è”</strong>çš„å…¨å±€é“¾è·¯è¿½è¸ªç¼–å·ã€‚</li><li><code>#createEntrySpan(operationName)</code> æ–¹æ³•ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚</li><li><code>#createLocalSpan(operationName)</code> æ–¹æ³•ï¼Œåˆ›å»º LocalSpan å¯¹è±¡ã€‚</li><li><code>#createExitSpan(operationName, remotePeer)</code> æ–¹æ³•ï¼Œåˆ›å»º ExitSpan å¯¹è±¡ã€‚</li><li><code>#activeSpan()</code> æ–¹æ³•ï¼Œè·å¾—å½“å‰<strong>æ´»è·ƒ</strong>çš„ Span å¯¹è±¡ã€‚</li><li><code>#stopSpan(AbstractSpan)</code> æ–¹æ³•ï¼Œåœæ­¢( å®Œæˆ )æŒ‡å®š AbstractSpan å¯¹è±¡ã€‚</li><li>â€”â€”â€” è·¨è¿›ç¨‹( cross-process ) â€”â€”â€”</li><li><code>#inject(ContextCarrier)</code> æ–¹æ³•ï¼Œå°† Context <strong>æ³¨å…¥</strong>åˆ° ContextCarrier ï¼Œç”¨äºè·¨è¿›ç¨‹ï¼Œ<strong>ä¼ æ’­</strong>ä¸Šä¸‹æ–‡ã€‚</li><li><code>#extract(ContextCarrier)</code> æ–¹æ³•ï¼Œå°† ContextCarrier <strong>è§£å‹</strong>åˆ° Context ï¼Œç”¨äºè·¨è¿›ç¨‹ï¼Œ<strong>æ¥æ”¶</strong>ä¸Šä¸‹æ–‡ã€‚</li><li>â€”â€”â€” è·¨çº¿ç¨‹( cross-thread ) â€”â€”â€”</li><li><code>#capture()</code> æ–¹æ³•ï¼Œå°† Context <strong>å¿«ç…§</strong>åˆ° ContextSnapshot ï¼Œç”¨äºè·¨çº¿ç¨‹ï¼Œ<strong>ä¼ æ’­</strong>ä¸Šä¸‹æ–‡ã€‚</li><li><code>#continued(ContextSnapshot)</code> æ–¹æ³•ï¼Œå°† ContextSnapshot <strong>è§£å‹</strong>åˆ° Context ï¼Œç”¨äºè·¨çº¿ç¨‹ï¼Œ<strong>æ¥æ”¶</strong>ä¸Šä¸‹æ–‡ã€‚</li></ul><h3 id="3-2-1-TracingContext"><a href="#3-2-1-TracingContext" class="headerlink" title="3.2.1 TracingContext"></a>3.2.1 TracingContext</h3><p><code>org.skywalking.apm.agent.core.context.TracingContext</code> ï¼Œå®ç° AbstractTracerContext æ¥å£ï¼Œé“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡<strong>å®ç°ç±»</strong>ã€‚</p><ul><li><code>segment</code> å±æ€§ï¼Œä¸Šä¸‹æ–‡å¯¹åº”çš„ TraceSegment å¯¹è±¡ã€‚</li><li><code>activeSpanStack</code> å±æ€§ï¼ŒAbstractSpan <strong>é“¾è¡¨</strong>æ•°ç»„ï¼Œæ”¶é›†å½“å‰<strong>æ´»è·ƒ</strong>çš„ Span å¯¹è±¡ã€‚æ­£å¦‚æ–¹æ³•çš„è°ƒç”¨ä¸æ‰§è¡Œä¸€æ ·ï¼Œåœ¨ä¸€ä¸ª<strong>è°ƒç”¨æ ˆ</strong>ä¸­ï¼Œå…ˆæ‰§è¡Œçš„æ–¹æ³•åç»“æŸã€‚</li><li><code>spanIdGenerator</code> å±æ€§ï¼ŒSpan ç¼–å·è‡ªå¢åºåˆ—ã€‚åˆ›å»ºçš„ Span çš„ç¼–å·ï¼Œé€šè¿‡è¯¥å˜é‡è‡ªå¢ç”Ÿæˆã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/2a75efbeddac2b9565816af0ab0873ec3d998424/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L79" rel="external nofollow noopener noreferrer" target="_blank">TracingContext æ„é€ æ–¹æ³•</a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 80 è¡Œï¼šåˆ›å»º TraceSegment å¯¹è±¡ã€‚</li><li>ç¬¬ 81 è¡Œï¼šè®¾ç½® <code>spanIdGenerator = 0</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#getReadableGlobalTraceId()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾— TraceSegment çš„<strong>é¦–ä¸ª</strong> DistributedTraceId ä½œä¸ºè¿”å›ã€‚</p><h4 id="3-2-1-1-åˆ›å»º-EntrySpan"><a href="#3-2-1-1-åˆ›å»º-EntrySpan" class="headerlink" title="3.2.1.1 åˆ›å»º EntrySpan"></a>3.2.1.1 åˆ›å»º EntrySpan</h4><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextManager#createEntrySpan(operationName, carrier)</code></a> æ–¹æ³•ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 121 è‡³ 131 è¡Œï¼šè°ƒç”¨ <code>#getOrCreate(operationName, forceSampling)</code> æ–¹æ³•ï¼Œè·å– AbstractTracerContext å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»ºã€‚<ul><li>ç¬¬ 122 è‡³ 125 è¡Œï¼šæœ‰<strong>ä¼ æ’­</strong> Context çš„æƒ…å†µä¸‹ï¼Œ<strong>å¼ºåˆ¶</strong>æ”¶é›† Trace æ•°æ®ã€‚</li><li>ç¬¬ 127 è¡Œï¼šè°ƒç”¨ <code>TracingContext#extract(ContextCarrier)</code> æ–¹æ³•ï¼Œå°† ContextCarrier <strong>è§£å‹</strong>åˆ° Context ï¼Œ<strong>è·¨è¿›ç¨‹</strong>ï¼Œæ¥æ”¶ä¸Šä¸‹æ–‡ã€‚åœ¨ <a href="#">ã€Œ3.2.3 ContextCarrierã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 133 è¡Œï¼šè°ƒç”¨ <code>TracingContext#createEntrySpan(operationName)</code> æ–¹æ³•ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚</li></ul><hr><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L230" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#createEntrySpan(operationName)</code></a> æ–¹æ³•ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 223 è‡³ 227 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L500" rel="external nofollow noopener noreferrer" target="_blank"><code>#isLimitMechanismWorking()</code></a> æ–¹æ³•ï¼Œåˆ¤æ–­ Span æ•°é‡<strong>è¶…è¿‡ä¸Šé™</strong>ï¼Œåˆ›å»º NoopSpan å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#push(AbstractSpan)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° <code>activeSpanStack</code> ä¸­ã€‚</li><li>ç¬¬ 229 è‡³ 231 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L489" rel="external nofollow noopener noreferrer" target="_blank"><code>#peek()</code></a> æ–¹æ³•ï¼Œè·å¾—å½“å‰æ´»è·ƒçš„ AbstractSpan å¯¹è±¡ã€‚</li><li>ç¬¬ 232 è‡³ 249 è¡Œï¼šè‹¥<strong>çˆ¶</strong> Span å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ›å»º EntrySpan å¯¹è±¡ã€‚<ul><li>ç¬¬ 235 è‡³ 244 è¡Œï¼šåˆ›å»º EntrySpan å¯¹è±¡ã€‚</li><li>ç¬¬ 247 è¡Œï¼šè°ƒç”¨ <code>EntrySpan#start()</code> æ–¹æ³•ï¼Œå¼€å§‹ EntrySpan ã€‚</li><li>ç¬¬ 249 è¡Œï¼šè°ƒç”¨ <code>#push(AbstractSpan)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° <code>activeSpanStack</code> ä¸­ã€‚</li></ul></li><li>ç¬¬ 251 è‡³ 264 è¡Œï¼šè‹¥<strong>çˆ¶</strong> EntrySpan å¯¹è±¡å­˜åœ¨ï¼Œ<strong>é‡æ–°</strong>å¼€å§‹ EntrySpan ã€‚å‚è§ <a href="#">ã€Œ2.2.2.2.1 EntrySpanã€</a> ã€‚</li><li>ç¬¬ 265 è‡³ 267 è¡Œï¼š<code>&quot;The Entry Span can&#39;t be the child of Non-Entry Span&quot;</code> ã€‚</li></ul><h4 id="3-2-1-2-åˆ›å»º-LocalSpan"><a href="#3-2-1-2-åˆ›å»º-LocalSpan" class="headerlink" title="3.2.1.2 åˆ›å»º LocalSpan"></a>3.2.1.2 åˆ›å»º LocalSpan</h4><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/97777afc4975ee3bd466fd8870d7dbbc3da9ddd0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L136" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextManager#createLocalSpan(operationName)</code></a> æ–¹æ³•ï¼Œåˆ›å»º LocalSpan å¯¹è±¡ã€‚</p><ul><li>ç¬¬ 138 è¡Œï¼šè°ƒç”¨ <code>#getOrCreate(operationName, forceSampling)</code> æ–¹æ³•ï¼Œè·å– AbstractTracerContext å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»ºã€‚</li><li>ç¬¬ 140 è¡Œï¼šè°ƒç”¨ <code>TracingContext#createLocalSpan(operationName)</code> æ–¹æ³•ï¼Œåˆ›å»º LocalSpan å¯¹è±¡ã€‚</li></ul><hr><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/97777afc4975ee3bd466fd8870d7dbbc3da9ddd0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L278" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#createLocalSpan(operationName)</code></a> æ–¹æ³•ï¼Œåˆ›å»º LocalSpan å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 280 è‡³ 283 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L500" rel="external nofollow noopener noreferrer" target="_blank"><code>#isLimitMechanismWorking()</code></a> æ–¹æ³•ï¼Œåˆ¤æ–­ Span æ•°é‡<strong>è¶…è¿‡ä¸Šé™</strong>ï¼Œåˆ›å»º NoopSpan å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#push(AbstractSpan)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° <code>activeSpanStack</code> ä¸­ã€‚</li><li>ç¬¬ 284 è‡³ 286 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L489" rel="external nofollow noopener noreferrer" target="_blank"><code>#peek()</code></a> æ–¹æ³•ï¼Œè·å¾—å½“å‰æ´»è·ƒçš„ AbstractSpan å¯¹è±¡ã€‚</li><li>ç¬¬ 288 è‡³ 300 è¡Œï¼šåˆ›å»º LocalSpan å¯¹è±¡ã€‚</li><li>ç¬¬ 302 è¡Œï¼šè°ƒç”¨ <code>LocalSpan#start()</code> æ–¹æ³•ï¼Œå¼€å§‹ LocalSpan ã€‚</li><li>ç¬¬ 304 è¡Œï¼šè°ƒç”¨ <code>#push(AbstractSpan)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° <code>activeSpanStack</code> ä¸­ã€‚</li></ul><h4 id="3-2-1-3-åˆ›å»º-ExitSpan"><a href="#3-2-1-3-åˆ›å»º-ExitSpan" class="headerlink" title="3.2.1.3 åˆ›å»º ExitSpan"></a>3.2.1.3 åˆ›å»º ExitSpan</h4><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/97777afc4975ee3bd466fd8870d7dbbc3da9ddd0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L143" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextManager#createExitSpan(operationName, carrier, remotePeer)</code></a> æ–¹æ³•ï¼Œåˆ›å»º ExitSpan å¯¹è±¡ã€‚</p><ul><li>ç¬¬ 148 è¡Œï¼šè°ƒç”¨ <code>#getOrCreate(operationName, forceSampling)</code> æ–¹æ³•ï¼Œè·å– AbstractTracerContext å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»ºã€‚</li><li>ç¬¬ 150 è¡Œï¼šè°ƒç”¨ <code>TracingContext#createExitSpan(operationName, remotePeer)</code> æ–¹æ³•ï¼Œåˆ›å»º ExitSpan å¯¹è±¡ã€‚</li><li>ç¬¬ 160 è¡Œï¼š<code>TracingContext#inject(ContextCarrier)</code> æ–¹æ³•ï¼Œå°† Context <strong>æ³¨å…¥</strong>åˆ° ContextCarrier ï¼Œ<strong>è·¨è¿›ç¨‹</strong>ï¼Œä¼ æ’­ä¸Šä¸‹æ–‡ã€‚åœ¨ <a href="#">ã€Œ3.2.3 ContextCarrierã€</a> è¯¦ç»†è§£æã€‚</li></ul><hr><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L230" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#createEntrySpan(operationName)</code></a> æ–¹æ³•ï¼Œåˆ›å»º ExitSpan å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 319 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L489" rel="external nofollow noopener noreferrer" target="_blank"><code>#peek()</code></a> æ–¹æ³•ï¼Œè·å¾—å½“å‰æ´»è·ƒçš„ AbstractSpan å¯¹è±¡ã€‚</li><li>ç¬¬ 320 è‡³ 322 è¡Œï¼šè‹¥ ExitSpan å¯¹è±¡å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ï¼Œä¸é‡æ–°åˆ›å»ºã€‚å‚è§ <a href="#">ã€Œ2.2.2.2.2 ExitSpanã€</a> ã€‚</li><li>ç¬¬ 324 è‡³ 377 è¡Œï¼šåˆ›å»º ExitSpan å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° <code>activeSpanStack</code> ä¸­ã€‚<ul><li>ç¬¬ 327 è¡Œï¼šæ ¹æ® <code>remotePeer</code> å‚æ•°ï¼ŒæŸ¥æ‰¾ <code>peerId</code> ã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„ä¼šåˆ›å»ºä¸€ä¸ª Application å¯¹è±¡ï¼Œé€šè¿‡ ServiceMapping è¡¨ï¼Œå’Œè¿œç¨‹çš„ Application è¿›è¡Œ<strong>åŒ¹é…æ˜ å°„</strong>ã€‚åç»­æœ‰æ–‡ç« ä¼šåˆ†äº«è¿™å—ã€‚</li><li>ç¬¬ 322 è‡³ 324 è¡Œ || ç¬¬ 335 è‡³ 358 è¡Œï¼šåˆ¤æ–­ Span æ•°é‡<strong>è¶…è¿‡ä¸Šé™</strong>ï¼Œåˆ›å»º NoopExitSpan å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#push(AbstractSpan)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° <code>activeSpanStack</code> ä¸­ã€‚</li></ul></li><li>ç¬¬ 380 è¡Œï¼šå¼€å§‹ ExitSpan ã€‚</li></ul><h4 id="3-2-1-4-ç»“æŸ-Span"><a href="#3-2-1-4-ç»“æŸ-Span" class="headerlink" title="3.2.1.4 ç»“æŸ Span"></a>3.2.1.4 ç»“æŸ Span</h4><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/85effa4f5752bdfe3efa43294293af0634a40626/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L316" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextManager#stopSpan()</code></a> æ–¹æ³•ï¼Œç»“æŸ Span ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 199 è¡Œï¼šè°ƒç”¨ <code>TracingContext#stopSpan(AbstractSpan)</code> æ–¹æ³•ï¼Œç»“æŸ Span ã€‚<strong>å½“æ‰€æœ‰æ´»è·ƒçš„ Span éƒ½è¢«ç»“æŸåï¼Œå½“å‰çº¿ç¨‹çš„ TraceSegment å®Œæˆ</strong>ã€‚</li></ul><hr><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L403" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#stopSpan(AbstractSpan)</code></a> æ–¹æ³•ï¼Œç»“æŸ Span ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 405 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5eb4b28e18e8a47de10ec331a9667444d16f4933/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L489" rel="external nofollow noopener noreferrer" target="_blank"><code>#peek()</code></a> æ–¹æ³•ï¼Œè·å¾—å½“å‰æ´»è·ƒçš„ AbstractSpan å¯¹è±¡ã€‚</li><li>ç¬¬ 408 è‡³ 414 è¡Œï¼šå½“ Span ä¸º AbstractTracingSpan çš„å­ç±»ï¼Œå³è®°å½•é“¾è·¯è¿½è¸ªçš„ Span ï¼Œè°ƒç”¨ <code>AbstractTracingSpan#finish(TraceSegment)</code> æ–¹æ³•ï¼Œå®Œæˆ Span ã€‚<ul><li>å½“å®Œæˆ<strong>æˆåŠŸ</strong>æ—¶ï¼Œè°ƒç”¨ <code>#pop()</code> æ–¹æ³•ï¼Œç§»é™¤å‡º <code>activeSpanStack</code> ã€‚</li><li>å½“å®Œæˆ<strong>å¤±è´¥</strong>æ—¶ï¼ŒåŸå› å‚è§ <a href="#">ã€Œ2.2.2.2 StackBasedTracingSpanã€</a> ã€‚</li></ul></li><li>ç¬¬ 416 è‡³ 419 è¡Œï¼šå½“ Span ä¸º NoopSpan çš„å­ç±»ï¼Œå³ä¸è®°å½•é“¾è·¯è¿½è¸ªçš„ Span ï¼Œè°ƒç”¨ <code>#pop()</code> æ–¹æ³•ï¼Œç§»é™¤å‡º <code>activeSpanStack</code> ã€‚</li><li>ç¬¬ 425 è‡³ 427 è¡Œï¼šå½“æ‰€æœ‰æ´»è·ƒçš„ Span éƒ½è¢«ç»“æŸåï¼Œè°ƒç”¨ <code>#finish()</code> æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹çš„ TraceSegment å®Œæˆã€‚</li></ul><hr><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L434" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#stopSpan(AbstractSpan)</code></a> æ–¹æ³•ï¼Œå®Œæˆ Context ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 436 è¡Œï¼šè°ƒç”¨ <code>TraceSegment#finish(isSizeLimited)</code> æ–¹æ³•ï¼Œå®Œæˆ TraceSegment ã€‚</li><li>ç¬¬ 444 è‡³ 448 è¡Œï¼šè‹¥æ»¡è¶³æ¡ä»¶ï¼Œè°ƒç”¨ <code>TraceSegment#setIgnore(true)</code> æ–¹æ³•ï¼Œæ ‡è®°è¯¥ TraceSegment å¿½ç•¥ï¼Œä¸å‘é€ç»™ Collector ã€‚<ul><li><code>!samplingService.trySampling()</code> ï¼šä¸é‡‡æ ·ã€‚ </li><li><code>!segment.hasRef()</code> ï¼šæ— çˆ¶ TraceSegment æŒ‡å‘ã€‚å¦‚æœæ­¤å¤„å¿½ç•¥é‡‡æ ·ï¼Œåˆ™ä¼šå¯¼è‡´æ•´æ¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª<strong>ä¸å®Œæ•´</strong>ã€‚</li><li><code>segment.isSingleSpanSegment()</code> ï¼šTraceSegment åªæœ‰<strong>ä¸€ä¸ª</strong> Span ã€‚</li><li>TODO ã€4010ã€‘</li></ul></li><li>ç¬¬ 450 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L476" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext.ListenerManager#notifyFinish(TraceSegment)</code></a> æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œä¸€æ¬¡ TraceSegment å®Œæˆã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒTraceSegment ä¼šè¢« <a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/TraceSegmentServiceClient.java#L157" rel="external nofollow noopener noreferrer" target="_blank">TraceSegmentServiceClient</a> <strong>å¼‚æ­¥</strong>å‘é€ç»™ Collector ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†äº«å‘é€çš„è¿‡ç¨‹ã€‚</li></ul><h3 id="3-2-2-IgnoredTracerContext"><a href="#3-2-2-IgnoredTracerContext" class="headerlink" title="3.2.2 IgnoredTracerContext"></a>3.2.2 IgnoredTracerContext</h3><p><a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/IgnoredTracerContext.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.IgnoredTracerContext</code></a> ï¼Œå®ç° AbstractTracerContext æ¥å£ï¼Œå¿½ç•¥( <strong>ä¸è®°å½•</strong> )é“¾è·¯è¿½è¸ªçš„ä¸Šä¸‹æ–‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>NOOP_SPAN</code> <strong>é™æ€</strong>å±æ€§ï¼ŒNoopSpan å•ä¾‹ã€‚<ul><li>æ‰€æœ‰çš„åˆ›å»º Span æ–¹æ³•ï¼Œè¿”å›çš„éƒ½æ˜¯è¯¥å¯¹è±¡ã€‚</li></ul></li><li><code>stackDepth</code> å±æ€§ï¼Œæ ˆæ·±åº¦ã€‚<ul><li>ä¸åŒäº TracingContext ä½¿ç”¨<strong>é“¾å¼æ•°ç»„</strong>æ¥å¤„ç† Span çš„<strong>å‡ºå…¥æ ˆ</strong>ï¼ŒIgnoredTracerContext ä½¿ç”¨ <code>stackDepth</code> æ¥è®¡æ•°ï¼Œä»è€Œå®ç°<strong>å‡ºå…¥æ ˆ</strong>çš„æ•ˆæœã€‚</li></ul></li><li>é€šè¿‡è¿™ä¸¤ä¸ªå±æ€§å’Œç›¸åº”<strong>ç©º</strong>æ–¹æ³•çš„å®ç°ï¼Œä»¥å‡å°‘ NoopSpan æ—¶çš„å¯¹è±¡åˆ›å»ºï¼Œè¾¾åˆ°å‡å°‘å†…å­˜ä½¿ç”¨å’Œ GC æ—¶é—´ã€‚</li></ul><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±é˜…è¯»è¯¥ç±»çš„å®ç°ã€‚</p><h3 id="3-2-3-ContextCarrier"><a href="#3-2-3-ContextCarrier" class="headerlink" title="3.2.3 ContextCarrier"></a>3.2.3 ContextCarrier</h3><p><a href="https://github.com/YunaiV/skywalking/blob/4c4c62d0d5ec2ce17e3d36cad0f6598247b582e1/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextCarrier.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.ContextCarrier</code></a> ï¼Œå®ç° <code>java.io.Serializable</code> æ¥å£ï¼Œ<strong>è·¨è¿›ç¨‹</strong> Context ä¼ è¾“<strong>è½½ä½“</strong>ã€‚</p><h4 id="3-2-3-1-è§£å‹"><a href="#3-2-3-1-è§£å‹" class="headerlink" title="3.2.3.1 è§£å‹"></a>3.2.3.1 è§£å‹</h4><p>æˆ‘ä»¬æ¥æ‰“å¼€ <a href="https://github.com/YunaiV/skywalking/blob/4c4c62d0d5ec2ce17e3d36cad0f6598247b582e1/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L97" rel="external nofollow noopener noreferrer" target="_blank"><code>#TraceSegmentRef(ContextCarrier)</code></a> <strong>æ„é€ </strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºå°† ContextCarrier è½¬æ¢æˆ TraceSegmentRef ï¼Œå¯¹æ¯”ä¸‹ä¸¤è€…çš„å±æ€§ï¼Œ<strong>åŸºæœ¬ä¸€è‡´</strong>ï¼Œå·®å¼‚å¦‚ä¸‹ï¼š</p><ul><li><code>peerHost</code> å±æ€§ï¼ŒèŠ‚ç‚¹åœ°å€ã€‚<ul><li>å½“å­—ç¬¦ä¸²<strong>ä¸</strong>ä»¥ <code>#</code> å·å¼€å¤´ï¼Œä»£è¡¨èŠ‚ç‚¹ç¼–å·ï¼Œæ ¼å¼ä¸º <code>${peerId}</code> ï¼Œä¾‹å¦‚ <code>&quot;123&quot;</code> ã€‚</li><li>å½“å­—ç¬¦ä¸²ä»¥ <code>#</code> å·å¼€å¤´ï¼Œä»£è¡¨åœ°å€ï¼Œæ ¼å¼ä¸º <code>${peerHost}</code> ï¼Œä¾‹å¦‚ <code>&quot;192.168.16.1:8080&quot;</code> ã€‚</li></ul></li><li><code>entryOperationName</code> å±æ€§ï¼Œå…¥å£æ“ä½œåã€‚<ul><li>å½“å­—ç¬¦ä¸²<strong>ä¸</strong>ä»¥ <code>#</code> å·å¼€å¤´ï¼Œä»£è¡¨å…¥å£æ“ä½œç¼–å·ï¼Œæ ¼å¼ä¸º <code>#${entryOperationId}</code> ï¼Œä¾‹å¦‚ <code>&quot;666&quot;</code> ã€‚</li><li>å½“å­—ç¬¦ä¸²ä»¥ <code>#</code> å·å¼€å¤´ï¼Œä»£è¡¨å…¥å£æ“ä½œåï¼Œæ ¼å¼ä¸º <code>#${entryOperationName}</code> ï¼Œä¾‹å¦‚ <code>&quot;#user/login&quot;</code> ã€‚</li></ul></li><li><code>parentOperationName</code> å±æ€§ï¼Œçˆ¶æ“ä½œåã€‚ç±»ä¼¼ <code>entryOperationName</code> å±ã€‚</li><li><code>primaryDistributedTraceId</code> å±æ€§ï¼Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª<strong>å…¨å±€</strong>ç¼–å·ã€‚<strong>å®ƒä¸åœ¨æ­¤å¤„å¤„ç†ï¼Œè€Œåœ¨ <code>TracingContext#extract(ContextCarrier)</code> æ–¹æ³•ä¸­</strong>ã€‚</li></ul><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L127" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextManager#createEntrySpan(operationName, carrier)</code></a> æ–¹æ³•ä¸­ï¼Œå½“<strong>å­˜åœ¨</strong> ContextCarrier ä¼ é€’æ—¶ï¼Œåˆ›å»º Context åï¼Œä¼šå°† ContextCarrier <strong>è§£å‹</strong>åˆ° Context ä¸­ï¼Œä»¥è¾¾åˆ°è·¨è¿›ç¨‹ä¼ æ’­ã€‚<a href="https://github.com/YunaiV/skywalking/blob/4c4c62d0d5ec2ce17e3d36cad0f6598247b582e1/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L147" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#extract(ContextCarrier)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 148 è¡Œï¼šå°† ContextCarrier è½¬æ¢æˆ TraceSegmentRef å¯¹è±¡ï¼Œè°ƒç”¨ <code>TraceSegment#ref(TraceSegmentRef)</code> æ–¹æ³•ï¼Œè¿›è¡ŒæŒ‡å‘çˆ¶ TraceSegmentã€‚</li><li>ç¬¬ 149 è¡Œï¼šè°ƒç”¨ <code>TraceSegment#relatedGlobalTraces(DistributedTraceId)</code> æ–¹æ³•ï¼Œå°†ä¼ æ’­çš„åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª<strong>å…¨å±€</strong>ç¼–å·ï¼Œæ·»åŠ åˆ° TraceSegment ä¸­ï¼Œè¿›è¡ŒæŒ‡å‘<strong>å…¨å±€</strong>ç¼–å·ã€‚</li></ul><p>å¦å¤–ï¼ŒContextManager <strong>å•ç‹¬</strong>æä¾› <a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L161" rel="external nofollow noopener noreferrer" target="_blank"><code>#extract(ContextCarrier)</code></a> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong> ContextCarrier æ³¨å…¥åˆ°<strong>ä¸€ä¸ª</strong> Context ä¸­ï¼Œä»è€Œè§£å†³â€<strong>å¤šä¸ªçˆ¸çˆ¸</strong>â€œçš„åœºæ™¯ï¼Œä¾‹å¦‚ RocketMQ æ’ä»¶çš„ <a href="https://github.com/YunaiV/skywalking/blob/49dc81a8bcaad1879b3a3be9917944b0b8b5a7a4/apm-sniffer/apm-sdk-plugin/rocketMQ-4.x-plugin/src/main/java/org/skywalking/apm/plugin/rocketMQ/v4/AbstractMessageConsumeInterceptor.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractMessageConsumeInterceptor#beforeMethod(...)</code></a> æ–¹æ³•ã€‚</p><h4 id="3-2-3-2-æ³¨å…¥"><a href="#3-2-3-2-æ³¨å…¥" class="headerlink" title="3.2.3.2 æ³¨å…¥"></a>3.2.3.2 æ³¨å…¥</h4><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/4c4c62d0d5ec2ce17e3d36cad0f6598247b582e1/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L152" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextManager#createExitSpan(operationName, carrier, remotePeer)</code></a> æ–¹æ³•ä¸­ï¼Œå½“<strong>éœ€è¦</strong> Context <strong>è·¨è¿›ç¨‹</strong>ä¼ é€’æ—¶ï¼Œå°† Context <strong>æ³¨å…¥</strong>åˆ° ContextCarrier ä¸­ï¼Œä¸º <a href="#">ã€Œ3.2.3.3 ä¼ è¾“ã€</a> åšå‡†å¤‡ã€‚<a href="https://github.com/YunaiV/skywalking/blob/23c2146c134e0ef0a37a43758a1e04727de7697a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L87" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#inject(ContextCarrier)</code></a> æ–¹æ³•ï¼Œä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚</p><h4 id="3-2-3-3-ä¼ è¾“"><a href="#3-2-3-3-ä¼ è¾“" class="headerlink" title="3.2.3.3 ä¼ è¾“"></a>3.2.3.3 ä¼ è¾“</h4><blockquote><p>å‹æƒ…æç¤ºï¼šèƒ–å‹ï¼Œè¯·å…ˆé˜…è¯» <a href="https://github.com/apache/incubator-skywalking/blob/master/docs/cn/Skywalking-Cross-Process-Propagation-Headers-Protocol-CN-v1.md" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSkywalking Cross Process Propagation Headers Protocolã€‹</a> ã€‚</p></blockquote><p><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/CarrierItem.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.CarrierItem</code></a> ï¼Œä¼ è¾“è½½ä½“<strong>é¡¹</strong>ã€‚ä»£ç å¦‚ï¼š</p><ul><li><code>headKey</code> å±æ€§ï¼ŒHeader é”®ã€‚</li><li><code>headValue</code> å±æ€§ï¼ŒHeader å€¼ã€‚</li><li><code>next</code> å±æ€§ï¼Œä¸‹ä¸€ä¸ªé¡¹ã€‚</li></ul><p>CarrierItem æœ‰ä¸¤ä¸ªå­ç±»ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/CarrierItemHead.java" rel="external nofollow noopener noreferrer" target="_blank">CarrierItemHead</a> ï¼šCarrier é¡¹çš„å¤´( Head )ï¼Œå³é¦–ä¸ªå…ƒç´ ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/SW3CarrierItem.java" rel="external nofollow noopener noreferrer" target="_blank">SW3CarrierItem</a> ï¼š<code>header = sw3</code> ï¼Œç”¨äºä¼ è¾“ ContextCarrier ã€‚</li></ul><p>å¦‚ä¸‹æ˜¯ Dubbo æ’ä»¶ï¼Œä½¿ç”¨ CarrierItem çš„ä»£ç ä¾‹å­ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/07.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextCarrier.java#L110" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextCarrier#serialize()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextCarrier.java#L131" rel="external nofollow noopener noreferrer" target="_blank"><code>ContextCarrier#deserialize(text)</code></a></li></ul><h3 id="3-2-4-ContextSnapshot"><a href="#3-2-4-ContextSnapshot" class="headerlink" title="3.2.4 ContextSnapshot"></a>3.2.4 ContextSnapshot</h3><p><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextSnapshot.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.context.ContextSnapshot</code></a> ï¼Œ<strong>è·¨çº¿ç¨‹</strong> Context ä¼ é€’<strong>å¿«ç…§</strong>ã€‚å’Œ ContextCarrier åŸºæœ¬ä¸€è‡´ï¼Œç”±äºä¸éœ€è¦<strong>è·¨è¿›ç¨‹ä¼ è¾“</strong>ï¼Œå¯ä»¥å°‘<strong>ä¼ é€’</strong>ä¸€äº›å±æ€§ï¼š</p><ul><li><code>parentApplicationInstanceId</code> </li><li><code>peerHost</code></li></ul><p>ContextSnapshot å’Œ ContextCarrier æ¯”è¾ƒç±»ä¼¼ï¼Œç¬”è€…å°±åˆ—ä¸¾ä¸€äº›æ–¹æ³•ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/dd6d9bff2d160f3aa60bc0be5152c49ecc9d94a4/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/trace/TraceSegmentRef.java#L126" rel="external nofollow noopener noreferrer" target="_blank"><code>#TraceSegmentRef(ContextSnapshot)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/23c2146c134e0ef0a37a43758a1e04727de7697a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L163" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#capture()</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/23c2146c134e0ef0a37a43758a1e04727de7697a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/TracingContext.java#L205" rel="external nofollow noopener noreferrer" target="_blank"><code>TracingContext#continued(ContextSnapshot)</code></a></li></ul><h2 id="3-3-SamplingService"><a href="#3-3-SamplingService" class="headerlink" title="3.3 SamplingService"></a>3.3 SamplingService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/sampling/SamplingService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.sampling.SamplingService</code></a> ï¼Œå®ç° Service æ¥å£ï¼ŒAgent æŠ½æ ·æœåŠ¡ã€‚è¯¥æœåŠ¡çš„ä½œç”¨æ˜¯ï¼Œå¦‚ä½•å¯¹ TraceSegment æŠ½æ ·æ”¶é›†ã€‚è€ƒè™‘åˆ°å¦‚æœæ¯æ¡ TraceSegment éƒ½è¿›è¡Œè¿½è¸ªï¼Œä¼šå¸¦æ¥ä¸€å®šçš„ CPU ( ç”¨äºåºåˆ—åŒ–ä¸ååºåˆ—åŒ– ) å’Œç½‘ç»œçš„å¼€é”€ã€‚é€šè¿‡é…ç½® <code>Config.Agent.SAMPLE_N_PER_3_SECS</code> å±æ€§ï¼Œè®¾ç½®<strong>æ¯ä¸‰ç§’</strong>ï¼Œæ”¶é›† TraceSegment çš„æ¡æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸å¼€å¯æŠ½æ ·æœåŠ¡ï¼Œå³å…¨éƒ¨æ”¶é›†ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>on</code> å±æ€§ï¼Œæ˜¯å¦å¼€å¯æŠ½æ ·æœåŠ¡ã€‚</li><li><code>samplingFactorHolder</code> å±æ€§ï¼ŒæŠ½æ ·è®¡æ•°å™¨ã€‚é€šè¿‡å®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸‰ç§’é‡ç½®ä¸€æ¬¡ã€‚</li><li><code>scheduledFuture</code> å±æ€§ï¼Œå®šæ—¶ä»»åŠ¡ã€‚</li><li><code>#boot()</code> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè‹¥å¼€å¯æŠ½æ ·æœåŠ¡( <code>Config.Agent.SAMPLE_N_PER_3_SECS &gt; 0</code> ) æ—¶ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸‰ç§’ï¼Œè°ƒç”¨ä¸€æ¬¡ <code>#resetSamplingFactor()</code> æ–¹æ³•ï¼Œé‡ç½®è®¡æ•°å™¨ã€‚</li><li><code>#trySampling()</code> æ–¹æ³•ï¼Œè‹¥å¼€å¯æŠ½æ ·æœåŠ¡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡æ¯ä¸‰ç§’çš„æŠ½æ ·<strong>ä¸Šé™</strong>ã€‚è‹¥ä¸æ˜¯ï¼Œè¿”å› <code>true</code> ï¼Œå¹¶å¢åŠ è®¡æ•°å™¨ã€‚å¦åˆ™ï¼Œè¿”å› <code>false</code> ã€‚</li><li><code>#forceSampled()</code> æ–¹æ³•ï¼Œ<strong>å¼ºåˆ¶</strong>å¢åŠ è®¡æ•°å™¨åŠ ä¸€ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•ç”¨äºé“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡ä¼ æ’­æ—¶ï¼Œè¢«è°ƒç”¨æœåŠ¡å¿…é¡»è®°å½•é“¾è·¯ï¼Œå‚è§è°ƒç”¨å¤„çš„<a href="https://github.com/YunaiV/skywalking/blob/7b39e952da408f722a53168e6d6a0cd7e7ff372f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/context/ContextManager.java#L123" rel="external nofollow noopener noreferrer" target="_blank">ä»£ç </a>ã€‚</li><li><code>#resetSamplingFactor()</code> æ–¹æ³•ï¼Œé‡ç½®è®¡æ•°å™¨ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å…ƒæ—¦å¾ˆè®¤çœŸ( ç¡¬æ†‹ )å‡ºä¸€ç¯‡â€ç¡¬è´§â€ã€‚å“ˆå“ˆå“ˆã€‚</p><p>ç”±äºç¯‡å¹…è¾ƒé•¿ï¼Œå†…å®¹ç•¥å¤šï¼Œå¦‚æœæœ‰é”™è¯¯çš„æˆ–è€…è§£é‡Šä¸æ¸…æ™°çš„ï¼Œçƒ¦è¯·èƒ–å‹æ–§æ­£ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_10_01/08.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/agent-collect-trace/&quot;&gt;http://www.iocoder.cn/SkyWalking/agent-collect-trace/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent DictionaryManager å­—å…¸ç®¡ç†</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-dictionary/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-dictionary/</id>
    <published>2020-09-27T16:00:00.000Z</published>
    <updated>2017-12-27T12:55:08.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">http://www.iocoder.cn/SkyWalking/agent-dictionary/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">2. Collector åŒæ­¥ç›¸å…³ API</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">2.1 åº”ç”¨çš„åŒæ­¥ API</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">2.2 æ“ä½œçš„åŒæ­¥ API</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">3. Agent è°ƒç”¨åŒæ­¥ API</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">3.1 DictionaryManager</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">3.2 PossibleFound</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Agent DictionaryManager å­—å…¸ç®¡ç†</strong>ã€‚å…ˆæ¥ç®€å•äº†è§£ä¸‹å­—å…¸çš„å®šä¹‰å’Œç”¨é€”ï¼š</p><ul><li>å­—å…¸å®é™…ä¸Šæ˜¯ä¸€ä¸ª Map æ˜ å°„ã€‚ç›®å‰ Agent ä¸Šæœ‰ä¸¤ç§å­—å…¸ï¼šåº”ç”¨ç¼–ç ä¸åº”ç”¨ç¼–å·çš„æ˜ å°„ï¼Œæ“ä½œåä¸æ“ä½œç¼–å·çš„æ˜ å°„ã€‚<ul><li>åº”ç”¨çš„å®šä¹‰ï¼šä¾‹å¦‚ï¼ŒTomcat å¯åŠ¨çš„åº”ç”¨ï¼Œæˆ–è€…ç¨‹åºé‡Œè®¿é—®çš„ MongoDB ã€MySQL éƒ½å¯ä»¥è®¤ä¸ºæ˜¯åº”ç”¨ã€‚</li><li>æ“ä½œçš„å®šä¹‰ï¼šä¾‹å¦‚ï¼Œè®¿é—®çš„ URL åœ°å€ï¼ŒMongo çš„æ‰§è¡Œæ“ä½œã€‚</li></ul></li><li>Agent åœ¨æ¯æ¬¡ä¸Šä¼ è°ƒç”¨é“¾è·¯ Segment ç»™ Collector æ—¶ï¼ŒSegment é‡Œé¢éœ€è¦åŒ…å«åº”ç”¨å’Œæ“ä½œç›¸å…³ä¿¡æ¯ã€‚è€ƒè™‘åˆ°å‡å°‘ç½‘ç»œæµé‡ï¼Œåº”ç”¨ç¼–å·å°‘äºåº”ç”¨ç¼–å·ï¼Œæ“ä½œç¼–å·å°‘äºæ“ä½œåã€‚</li></ul><p>Agent å­—å…¸ï¼Œä¼š<strong>å®šæ—¶</strong>ä» Collector ã€<strong>åŒæ­¥</strong>ã€‘<strong>éœ€è¦</strong>( <em>éœ€è¦çš„å®šä¹‰ï¼Œä¸‹æ–‡ä»£ç ä¼šçœ‹åˆ°</em> )çš„å­—å…¸ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ†æˆä¸¤ä¸ªå°èŠ‚ï¼Œåˆ†åˆ«ä» API çš„<strong>å®ç°</strong>ä¸<strong>è°ƒç”¨</strong>ï¼Œåˆ†äº«ä»£ç çš„å…·ä½“å®ç°ã€‚</p><h1 id="2-Collector-åŒæ­¥ç›¸å…³-API"><a href="#2-Collector-åŒæ­¥ç›¸å…³-API" class="headerlink" title="2. Collector åŒæ­¥ç›¸å…³ API"></a>2. Collector åŒæ­¥ç›¸å…³ API</h1><p>Collector åŒæ­¥ç›¸å…³ API ç›¸å…³æœ‰å››ä¸ªæ¥å£ï¼š</p><ul><li>2.1 åº”ç”¨çš„åŒæ­¥ API</li><li>2.2 æ“ä½œçš„åŒæ­¥ API</li></ul><p>API å¤„ç†çš„æµç¨‹å¤§ä½“å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/01.png" alt=""></p><h2 id="2-1-åº”ç”¨çš„åŒæ­¥-API"><a href="#2-1-åº”ç”¨çš„åŒæ­¥-API" class="headerlink" title="2.1 åº”ç”¨çš„åŒæ­¥ API"></a>2.1 åº”ç”¨çš„åŒæ­¥ API</h2><p>åº”ç”¨çš„åŒæ­¥ API ï¼Œå®é™…ä½¿ç”¨çš„æ˜¯<strong>åº”ç”¨çš„æ³¨å†Œ API</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/register/?self">ã€Œ2.1 åº”ç”¨çš„æ³¨å†Œ APIã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2 id="2-2-æ“ä½œçš„åŒæ­¥-API"><a href="#2-2-æ“ä½œçš„åŒæ­¥-API" class="headerlink" title="2.2 æ“ä½œçš„åŒæ­¥ API"></a>2.2 æ“ä½œçš„åŒæ­¥ API</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/DiscoveryService.proto#L11" rel="external nofollow noopener noreferrer" target="_blank"><code>DiscoveryService</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_28/01.png" alt=""></p><p>æ•´ä½“ä»£ç å’Œ <a href="#">ã€Œ2.1 åº”ç”¨çš„åŒæ­¥ APIã€</a> éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥æœ¬å°èŠ‚ï¼Œæ›´å¤šçš„æ˜¯æä¾›ä»£ç çš„é“¾æ¥åœ°å€ã€‚</p><h3 id="2-2-1-ServiceNameDiscoveryServiceHandler-discovery-â€¦"><a href="#2-2-1-ServiceNameDiscoveryServiceHandler-discovery-â€¦" class="headerlink" title="2.2.1 ServiceNameDiscoveryServiceHandler#discovery(â€¦)"></a>2.2.1 ServiceNameDiscoveryServiceHandler#discovery(â€¦)</h3><p><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/ServiceNameDiscoveryServiceHandler.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>ServiceNameDiscoveryServiceHandler#discovery(ServiceNameCollection, StreamObserver&lt;ServiceNameMappingCollection&gt;)</code></a>ï¼Œæ ¹æ®æ“ä½œåæ•°ç»„ï¼ŒæŸ¥æ‰¾æ“ä½œç¼–å·æ•°ç»„ã€‚</p><h3 id="2-2-2-IServiceNameService-getOrCreate-â€¦"><a href="#2-2-2-IServiceNameService-getOrCreate-â€¦" class="headerlink" title="2.2.2 IServiceNameService#getOrCreate(â€¦)"></a>2.2.2 IServiceNameService#getOrCreate(â€¦)</h3><p><code>org.skywalking.apm.collector.agent.stream.service.register.IServiceNameService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œæ“ä½œåæœåŠ¡æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a4db2c4dd5e2adc861e7fb9e9b7b7ffdc57dfb88/apm-collector/apm-collector-agent-stream/collector-agent-stream-define/src/main/java/org/skywalking/apm/collector/agent/stream/service/register/IInstanceIDService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(applicationId, serviceName)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨ç¼–å· + æ“ä½œåå­—ï¼Œè·å–æˆ–åˆ›å»ºæ“ä½œå( ServiceName )ï¼Œå¹¶è·å¾—æ“ä½œç¼–å·ã€‚</li></ul><p><code>org.skywalking.apm.collector.agent.stream.worker.register.ServiceNameService</code> ï¼Œå®ç° IServiceNameService æ¥å£ï¼Œæ“ä½œåæœåŠ¡å®ç°ç±»ã€‚</p><ul><li>å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ServiceNameService.java#L64" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(applicationId, serviceName)</code></a> æ–¹æ³•ã€‚</li></ul><h3 id="2-2-3-Graph-start-ServiceName"><a href="#2-2-3-Graph-start-ServiceName" class="headerlink" title="2.2.3 Graph#start(ServiceName)"></a>2.2.3 Graph#start(ServiceName)</h3><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/RegisterStreamGraph.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#createServiceNameRegisterGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ServiceName å¯¹åº”çš„ <code>Graph&lt;ServiceName&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ServiceNameRegisterRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.register.ServiceNameRegisterRemoteWorker</code></a> ï¼Œç»§æ‰¿ AbstractRemoteWorker æŠ½è±¡ç±»ï¼Œæ“ä½œåæ³¨å†Œè¿œç¨‹ Worker ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ServiceNameRegisterSerialWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.register.ServiceNameRegisterSerialWorker</code></a> ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼Œå¼‚æ­¥ä¿å­˜åº”ç”¨ Worker ã€‚<ul><li>ç›¸åŒäº Application ï¼ŒServiceName çš„æ“ä½œç¼–å·ï¼Œä» <code>&quot;1&quot;</code> <strong>åŒå‘</strong>é€’å¢ã€‚ </li><li><a href="https://github.com/YunaiV/skywalking/blob/a4db2c4dd5e2adc861e7fb9e9b7b7ffdc57dfb88/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceNameEsRegisterDAO.java#L52" rel="external nofollow noopener noreferrer" target="_blank">ServiceNameEsRegisterDAO#save(ServiceName)</a></li></ul></li></ul><h3 id="2-2-4-ServiceName"><a href="#2-2-4-ServiceName" class="headerlink" title="2.2.4 ServiceName"></a>2.2.4 ServiceName</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/ServiceName.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.ServiceName</code></a> ï¼Œæ“ä½œåã€‚ä¾‹å¦‚è®°å½•åœ¨ ES å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_28/02.png" alt=""></p><h1 id="3-Agent-è°ƒç”¨åŒæ­¥-API"><a href="#3-Agent-è°ƒç”¨åŒæ­¥-API" class="headerlink" title="3. Agent è°ƒç”¨åŒæ­¥ API"></a>3. Agent è°ƒç”¨åŒæ­¥ API</h1><p>åœ¨ <a href="#">ã€ŠSkyWalking æºç åˆ†æ â€”â€” åº”ç”¨äºåº”ç”¨å®ä¾‹çš„æ³¨å†Œã€‹ã€Œ3. Agent è°ƒç”¨æ³¨å†Œ APIã€</a> ä¸€æ–‡ä¸­ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L170" rel="external nofollow noopener noreferrer" target="_blank">ã€ç¬¬ 170 è‡³ 173 è¡Œã€‘çš„ä»£ç </a>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAppAndServiceRegisterClient ä¼šå®šæ—¶ä» Collector åŒæ­¥æ‰€æœ‰å­—å…¸ä¿¡æ¯ã€‚</p><h2 id="3-1-DictionaryManager"><a href="#3-1-DictionaryManager" class="headerlink" title="3.1 DictionaryManager"></a>3.1 DictionaryManager</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/DictionaryManager.java#L27" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.dictionary.DictionaryManager</code></a> ï¼Œå­—å…¸ç®¡ç†å™¨ã€‚ç›®å‰ç®¡ç†æœ‰ä¸¤ç§å­—å…¸ï¼š</p><ul><li>ApplicationDictionary</li><li>OperationNameDictionary</li></ul><h3 id="3-1-ApplicationDictionary"><a href="#3-1-ApplicationDictionary" class="headerlink" title="3.1 ApplicationDictionary"></a>3.1 ApplicationDictionary</h3><p><code>org.skywalking.apm.agent.core.dictionary.ApplicationDictionary</code> ï¼Œåº”ç”¨å­—å…¸ã€‚</p><ul><li><code>INSTANCE</code> æšä¸¾å±æ€§ï¼Œå•ä¾‹ã€‚</li><li><code>applicationDictionary</code> å±æ€§ï¼Œåº”ç”¨ç¼–ç ä¸åº”ç”¨ç¼–å·çš„æ˜ å°„ã€‚</li><li><code>unRegisterApplications</code> å±æ€§ï¼ŒæœªçŸ¥åº”ç”¨ç¼–ç é›†åˆã€‚Agent ä¼šå®šæ—¶ä» Collector åŒæ­¥ã€‚è¿™ä¹Ÿæ˜¯æ–‡ç« å¼€å¤´è¯´çš„ï¼Œâ€œ<strong>éœ€è¦</strong>â€çš„å®šä¹‰ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/ApplicationDictionary.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#find(applicationCode)</code></a> æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨ç¼–ç ï¼ŒæŸ¥è¯¢åº”ç”¨ç¼–å·ã€‚</p><ul><li>ç¬¬ 57 è¡Œï¼šæ ¹æ®åº”ç”¨ç¼–ç ï¼Œä» <code>applicationDictionary</code> ä¸­ï¼ŒæŸ¥è¯¢åº”ç”¨ç¼–å·ã€‚</li><li>ç¬¬ 58 è‡³ 59 è¡Œï¼šå½“åº”ç”¨ç¼–å·æŸ¥æ‰¾åˆ°æ—¶ï¼Œè¿”å› Found ã€‚Found ä¼šåœ¨ä¸‹æ–‡è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 61 è‡³ 64 è¡Œï¼šå½“åº”ç”¨ç¼–å·æŸ¥æ‰¾ä¸åˆ°æ—¶ï¼Œæ·»åŠ åˆ° <code>unRegisterApplications</code> ä¸­ï¼Œè¿”å› NotFound ã€‚NotFound ä¼šåœ¨ä¸‹æ–‡è¯¦ç»†è§£æã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/ApplicationDictionary.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>#syncRemoteDictionary(ApplicationRegisterServiceGrpc.ApplicationRegisterServiceBlockingStub)</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <a href="#">ã€Œ2.1 åº”ç”¨çš„åŒæ­¥ APIã€</a> ï¼Œä» Collector åŒæ­¥ <code>unRegisterApplications</code> å¯¹åº”çš„åº”ç”¨ç¼–å·é›†åˆã€‚</p><h3 id="3-2-OperationNameDictionary"><a href="#3-2-OperationNameDictionary" class="headerlink" title="3.2 OperationNameDictionary"></a>3.2 OperationNameDictionary</h3><p><code>org.skywalking.apm.agent.core.dictionary.OperationNameDictionary</code> ï¼Œæ“ä½œåå­—å…¸ã€‚</p><p>å’Œ ApplicationDictionary åŸºæœ¬ç±»ä¼¼ï¼Œèƒ–å‹ç‚¹å‡» <a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/OperationNameDictionary.java" rel="external nofollow noopener noreferrer" target="_blank">ä»£ç </a> ï¼Œè‡ªå·±é˜…è¯»ç†è§£ã€‚</p><h1 id="3-2-PossibleFound"><a href="#3-2-PossibleFound" class="headerlink" title="3.2 PossibleFound"></a>3.2 PossibleFound</h1><p>åœ¨åˆ†äº« PossibleFound ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼Œäº†è§£è¯¥ç±»çš„æ„å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_28/03.png" alt=""></p><ul><li>æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>XXXXDictionary#find(xxx)</code> æ–¹æ³•æ—¶ï¼Œè¿”å›çš„ä¼šæ˜¯ Found æˆ–è€… NotFound ã€‚è¿™ä¸¤ä¸ªç±»æœ¬èº«æ˜¯<strong>äº’æ–¥</strong>çš„ï¼Œå¹¶ä¸”ç»§æ‰¿ PossibleFound ã€‚åœ¨ PossibleFound æä¾› <code>#doInCondition(method01, method02)</code> æ–¹æ³•ï¼Œ<strong>ä¼˜é›…</strong>çš„å¤„ç†ä¸¤ç§æƒ…å†µã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L26" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.dictionary.PossibleFound</code></a> ï¼Œ<strong>æŠ½è±¡ç±»</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>found</code> å±æ€§ï¼Œæ˜¯å¦æ‰¾åˆ°ã€‚</li><li><code>value</code> å±æ€§ï¼Œæ‰¾åˆ°çš„ç»“æœã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/Found.java#L26" rel="external nofollow noopener noreferrer" target="_blank">org.skywalking.apm.agent.core.dictionary.Found</a> å®ç° PossibleFound ç±»ï¼Œ<code>found = true</code> å¹¶ä¸” <code>value</code> ä¸ºæ‰¾åˆ°çš„å€¼ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/NotFound.java#L26" rel="external nofollow noopener noreferrer" target="_blank">org.skywalking.apm.agent.core.dictionary.NotFound</a> å®ç° PossibleFound ç±»ï¼Œ<code>found = false</code> å¹¶ä¸” <code>value</code> ä¸èµ‹å€¼ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#doInCondition(Found, NotFound)</code></a> æ–¹æ³•ï¼Œæ ¹æ®æŸ¥æ‰¾ç»“æœï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œã€æ— è¿”å›ã€‘ã€‚<ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>PossibleFound.Found</code></a> æ¥å£ï¼ŒFound æ—¶çš„å¤„ç†é€»è¾‘æ¥å£ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>PossibleFound.NotFound</code></a> æ¥å£ï¼ŒNotFound æ—¶çš„å¤„ç†é€»è¾‘æ¥å£ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#doInCondition(FoundAndObtain, NotFoundAndObtain)</code></a> æ–¹æ³•ï¼Œæ ¹æ®æŸ¥æ‰¾ç»“æœï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œã€æœ‰è¿”å›ã€‘ã€‚<ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>PossibleFound.FoundAndObtain</code></a> æ¥å£ï¼ŒFound æ—¶çš„å¤„ç†é€»è¾‘æ¥å£ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0830d985227c42f0e0f3787ebc99a2b197486b69/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/dictionary/PossibleFound.java#L93" rel="external nofollow noopener noreferrer" target="_blank"><code>PossibleFound.NotFoundAndObtain</code></a> æ¥å£ï¼ŒNotFound æ—¶çš„å¤„ç†é€»è¾‘æ¥å£ã€‚</li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å†™æ°´æ–‡ï¼Œå¥½æ¯ç‡¥ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_28/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” åº”ç”¨äºåº”ç”¨å®ä¾‹çš„æ³¨å†Œ</title>
    <link href="http://www.iocoder.cn/SkyWalking/register/"/>
    <id>http://www.iocoder.cn/SkyWalking/register/</id>
    <published>2020-09-24T16:00:00.000Z</published>
    <updated>2018-01-01T11:45:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/register/">http://www.iocoder.cn/SkyWalking/register/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/register/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/register/">2. Collector æ³¨å†Œç›¸å…³ API</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/register/">2.1 åº”ç”¨çš„æ³¨å†Œ API</a></li><li><a href="http://www.iocoder.cn/SkyWalking/register/">2.2 åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ API</a></li><li><a href="http://www.iocoder.cn/SkyWalking/register/">2.3 åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ API</a></li><li><a href="http://www.iocoder.cn/SkyWalking/register/">2.4 åº”ç”¨å®ä¾‹çš„å¿ƒè·³ API</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/register/">3. Agent è°ƒç”¨æ³¨å†Œ API</a></li><li><a href="http://www.iocoder.cn/SkyWalking/register/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>åº”ç”¨ä¸åº”ç”¨å®ä¾‹çš„æ³¨å†Œ</strong>ã€‚å…ˆæ¥ç®€å•äº†è§£ä¸‹æ³¨å†Œçš„æ•´ä½“æµç¨‹ï¼š</p><ul><li>åº”ç”¨å¯åŠ¨ï¼ŒAgent å‘ Collector æ³¨å†Œ<strong>åº”ç”¨</strong>ã€‚</li><li>æ³¨å†Œåº”ç”¨æˆåŠŸåï¼ŒAgent å‘ Collector æ³¨å†Œåº”ç”¨<strong>å®ä¾‹</strong>ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ†æˆä¸¤ä¸ªå°èŠ‚ï¼Œåˆ†åˆ«ä» API çš„<strong>å®ç°</strong>ä¸<strong>è°ƒç”¨</strong>ï¼Œåˆ†äº«ä»£ç çš„å…·ä½“å®ç°ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šæ¨èé˜…è¯» <a href="https://github.com/apache/incubator-skywalking/blob/master/docs/cn/How-to-communicate-with-the-collector-CN.md" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ¢é’ˆä¸Collectoré—´é€šè®¯åè®®ã€‹</a> ã€‚</p></blockquote><h1 id="2-Collector-æ³¨å†Œç›¸å…³-API"><a href="#2-Collector-æ³¨å†Œç›¸å…³-API" class="headerlink" title="2. Collector æ³¨å†Œç›¸å…³ API"></a>2. Collector æ³¨å†Œç›¸å…³ API</h1><p>Collector æ³¨å†Œç›¸å…³ API ç›¸å…³æœ‰å››ä¸ªæ¥å£ï¼š</p><ul><li>2.1 åº”ç”¨çš„æ³¨å†Œ API</li><li>2.2 åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ API </li><li>2.3 åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ API</li><li>2.4 åº”ç”¨å®ä¾‹çš„å¿ƒè·³ API</li></ul><p>API å¤„ç†çš„æµç¨‹å¤§ä½“å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/01.png" alt=""></p><ul><li>ç»¿æ¡†éƒ¨åˆ†ï¼Œã€2.3ã€‘ã€2.4ã€‘ä¸¤ä¸ª API ï¼Œç›´æ¥ Service è°ƒç”¨ DAO æ–¹æ³•ï¼Œæ— éœ€ç»è¿‡ Graph / Stream ç›¸å…³æ–¹æ³•ã€‚</li></ul><h2 id="2-1-åº”ç”¨çš„æ³¨å†Œ-API"><a href="#2-1-åº”ç”¨çš„æ³¨å†Œ-API" class="headerlink" title="2.1 åº”ç”¨çš„æ³¨å†Œ API"></a>2.1 åº”ç”¨çš„æ³¨å†Œ API</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/ApplicationRegisterService.proto#L9" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationRegisterService.proto</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/02.png" alt=""></p><ul><li>å…¶ä¸­ï¼ŒKeyWithIntegerValue æ•°æ®ç±»å‹ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/KeyWithIntegerValue.proto" rel="external nofollow noopener noreferrer" target="_blank"><code>KeyWithIntegerValue.proto</code></a> ä¸­å®šä¹‰ã€‚</li></ul><h3 id="2-1-1-ApplicationRegisterServiceHandler-register-â€¦"><a href="#2-1-1-ApplicationRegisterServiceHandler-register-â€¦" class="headerlink" title="2.1.1 ApplicationRegisterServiceHandler#register(â€¦)"></a>2.1.1 ApplicationRegisterServiceHandler#register(â€¦)</h3><p><a href="https://github.com/YunaiV/skywalking/blob/b4b2ff52a7dccd000264677a7a6bbb2285a8cd53/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/ApplicationRegisterServiceHandler.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationRegisterServiceHandler#register(Application, StreamObserver&lt;ApplicationMapping&gt;)</code></a>, ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 51 è¡Œï¼šè·å¾—è¯·æ±‚çš„åº”ç”¨ç¼–ç ( <code>applicationCode</code> )<strong>æ•°ç»„</strong>ã€‚</li><li>ç¬¬ 54 è‡³ 64 è¡Œï¼šå¾ªç¯åº”ç”¨ç¼–ç æ•°ç»„ï¼Œ<strong>è·å–</strong>æˆ–<strong>åˆ›å»º</strong>åº”ç”¨ã€‚<ul><li>ç¬¬ 57 è¡Œï¼šè°ƒç”¨ <code>IApplicationIDService#getOrCreate(applicationCode)</code> æ–¹æ³•ï¼Œ<strong>è·å–</strong>æˆ–<strong>åˆ›å»º</strong>åº”ç”¨ï¼Œæœ€ç»ˆè·å¾—åº”ç”¨ç¼–å·( <code>applicationId</code> )ã€‚</li><li>ç¬¬ 60 è‡³ 63 è¡Œï¼šè·å¾—åˆ°åº”ç”¨ç¼–å·( <code>applicationId != 0</code> )ï¼Œåˆ™æ·»åŠ åˆ°å“åº”ã€‚<strong>ä¸ºä»€ä¹ˆä¼šå­˜åœ¨è·å¾—ä¸åˆ°çš„æƒ…å†µå‘¢</strong>ï¼Ÿåœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œå®é™…<strong>å¼‚æ­¥</strong>ä¿å­˜åº”ç”¨ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨è·å–å¤±è´¥çš„æƒ…å†µã€‚å½“è·å–å¤±è´¥ï¼Œè°ƒç”¨æ–¹( ä¾‹å¦‚ Agent )å¯ä»¥é‡æ–°å‘èµ·è¯¥è¯·æ±‚è¿›è¡Œæ³¨å†Œåº”ç”¨ï¼Œä»è€Œåœ¨å¼‚æ­¥ä¿å­˜åº”ç”¨ï¼Œè·å–åˆ°åº”ç”¨ç¼–å·ã€‚</li><li>ç¬¬ 67 è‡³ 68 è¡Œï¼šå“åº”ã€‚</li></ul></li></ul><h3 id="2-1-2-IApplicationIDService-getOrCreate-â€¦"><a href="#2-1-2-IApplicationIDService-getOrCreate-â€¦" class="headerlink" title="2.1.2 IApplicationIDService#getOrCreate(â€¦)"></a>2.1.2 IApplicationIDService#getOrCreate(â€¦)</h3><p><code>org.skywalking.apm.collector.agent.stream.service.register.IApplicationIDService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œåº”ç”¨ç¼–å·æœåŠ¡æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-define/src/main/java/org/skywalking/apm/collector/agent/stream/service/register/IApplicationIDService.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(applicationCode)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨ç¼–ç è·å–æˆ–åˆ›å»ºåº”ç”¨ï¼Œå¹¶è·å¾—åº”ç”¨ç¼–å·ã€‚</li></ul><p><code>org.skywalking.apm.collector.agent.stream.worker.register.ApplicationIDService</code> ï¼Œå®ç° IApplicationIDService æ¥å£ï¼Œåº”ç”¨ç¼–å·æœåŠ¡å®ç°ç±»ã€‚</p><ul><li><p>å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationIDService.java#L64" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(applicationCode)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 66 è¡Œï¼šè°ƒç”¨ <code>ApplicationCacheService#get(applicationCode)</code> æ–¹æ³•ï¼Œä»<strong>ç¼“å­˜</strong>ä¸­è·å–åº”ç”¨ç¼–å·ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cache ç¼“å­˜ç»„ä»¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 69 è‡³ 76 è¡Œï¼šå½“è·å–ä¸åˆ°åº”ç”¨ç¼–å·æ—¶ï¼Œè·å– Application å¯¹åº”çš„ <code>Graph&lt;Application&gt;</code> å¯¹è±¡ï¼Œè°ƒç”¨ <code>Graph#start(application)</code> æ–¹æ³•ï¼Œè¿›è¡Œæµå¼å¤„ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œä¼šä¿å­˜åº”ç”¨åˆ°å­˜å‚¨å™¨ã€‚</li><li>ç¬¬ 77 è¡Œï¼šè¿”å›åº”ç”¨ç¼–å·ã€‚</li></ul></li></ul><h3 id="2-1-3-Graph-start-application"><a href="#2-1-3-Graph-start-application" class="headerlink" title="2.1.3 Graph#start(application)"></a>2.1.3 Graph#start(application)</h3><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/RegisterStreamGraph.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#createApplicationRegisterGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Application å¯¹åº”çš„ <code>Graph&lt;Application&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.register.ApplicationRegisterRemoteWorker</code></a> ï¼Œç»§æ‰¿ AbstractRemoteWorker æŠ½è±¡ç±»ï¼Œåº”ç”¨æ³¨å†Œè¿œç¨‹ Worker ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L55" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractRemoteWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 AbstractRemoteWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AbstractRemoteWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 AbstractRemoteWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 10006 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>#selector</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› <code>Selector.ForeverFirst</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Remote è¿œç¨‹é€šä¿¡æœåŠ¡ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork(Application)</code></a> å®ç°æ–¹æ³•ï¼Œè°ƒç”¨ <code>Next#execute(message)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®ç»™ä¸‹é¢çš„èŠ‚ç‚¹ï¼Œç»§ç»­æµå¼å¤„ç†ã€‚</li><li>æ€»ç»“ï¼šApplicationRegisterRemoteWorker ï¼Œä½¿ç”¨ Collector é›†ç¾¤çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹( <a href="https://github.com/YunaiV/skywalking/blob/b4b2ff52a7dccd000264677a7a6bbb2285a8cd53/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L194" rel="external nofollow noopener noreferrer" target="_blank">æŒ‰ç…§ <code>ip</code> æ’åº</a> ) è¿›è¡Œåç»­çš„æµå¼å¤„ç†ï¼Œå³ï¼Œä¿å­˜åº”ç”¨ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.register.ApplicationRegisterSerialWorker</code></a> ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼Œå¼‚æ­¥ä¿å­˜åº”ç”¨ Worker ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L84" rel="external nofollow noopener noreferrer" target="_blank">Factory</a> å†…éƒ¨ç±»ï¼Œå®ç° AbstractLocalAsyncWorkerProvider æŠ½è±¡ç±»ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>AbstractLocalAsyncWorker</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.2 AbstractLocalAsyncWorkerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#id()</code></a> å®ç°æ–¹æ³•ï¼Œè¿”å› 101 ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork(Application)</code></a> å®ç°æ–¹æ³•ï¼Œä¿å­˜åº”ç”¨( Application )ã€‚ä»£ç å¦‚ä¸‹( ä»¥ ES ä½œä¸º DAO å®ç°ä¸ºä¾‹å­ )ï¼š<ul><li>ç¬¬ 58 è¡Œï¼šè°ƒç”¨ <code>ApplicationCacheService#get(applicationCode)</code> æ–¹æ³•ï¼Œä»<strong>ç¼“å­˜</strong>ä¸­è·å–åº”ç”¨ç¼–å·ã€‚</li><li>ç¬¬ 60 è¡Œï¼šå½“è·å–ä¸åˆ°åº”ç”¨ç¼–å·æ—¶ï¼Œä½¿ç”¨ <code>applicationCode</code> åˆ›å»ºåº”ç”¨å¹¶ä¿å­˜ã€‚</li><li>ç¬¬ 62 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsRegisterDAO.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationH2RegisterDAO#getMinApplicationId()</code></a> æ–¹æ³•ï¼Œè·å¾— Application è®°å½•çš„åº”ç”¨ç¼–å·çš„<strong>æœ€å°å€¼</strong>ã€‚</li><li>â€”â€”â€” åˆ†éš” â€”â€”â€”</li><li>ç¬¬ 63 è¡Œï¼šå½“ <code>min == 0</code> æ—¶ï¼Œè¯´æ˜æ²¡æœ‰ Application è®°å½•ã€‚</li><li>ç¬¬ 64 è‡³ 68 è¡Œï¼šåˆ›å»º<strong>ç¬¬ä¸€æ¡</strong>ã€<strong>ç‰¹æ®Š</strong>çš„ Application è®°å½•ã€‚è¯¥è®°å½• <code>applicationId = 1</code> ï¼Œ<code>applicationCode = User</code> ï¼Œç”¨äºè¡¨ç¤ºç”¨æˆ·å‘èµ·è¯·æ±‚ã€‚åœ¨ SkyWaling UI ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ¡ Application è®°å½•å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/03.png" alt=""></li><li>ç¬¬ 70 è‡³ 74 è¡Œï¼šåˆ›å»ºå½“å‰è¯·æ±‚çš„å¯¹åº”çš„ Application è®°å½•ï¼Œå¹¶ä¸” <code>applicationId = -1</code> ã€‚</li><li>â€”â€”â€” åˆ†éš” â€”â€”â€”</li><li>ç¬¬ 76 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsRegisterDAO.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationH2RegisterDAO#getMaxApplicationId()</code></a> æ–¹æ³•ï¼Œè·å¾— Application è®°å½•çš„åº”ç”¨ç¼–å·çš„<strong>æœ€å¤§å€¼</strong>ã€‚</li><li>ç¬¬ 77 è¡Œï¼šè°ƒç”¨ <code>IdAutoIncrement#increment(min, max)</code> æ–¹æ³•ï¼Œè·å¾—åº”ç”¨ç¼–å·ã€‚è¯¥æ–¹æ³•è¾ƒä¸ºæœ‰è¶£ï¼Œåœ¨ä¸‹æ–‡è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 79 è‡³ 82 è¡Œï¼šåˆ›å»ºå½“å‰è¯·æ±‚çš„å¯¹åº”çš„ Application è®°å½•ã€‚</li><li>â€”â€”â€” åˆ†éš” â€”â€”â€”</li><li>ç¬¬ 85 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsRegisterDAO.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationEsRegisterDAO#save(Application)</code></a> æ–¹æ³•ï¼Œä¿å­˜åº”ç”¨ã€‚</li></ul></li></ul></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/IdAutoIncrement.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>IdAutoIncrement#increment(min, max)</code></a> æ–¹æ³•ï¼Œ<strong>åŒå‘</strong>å‡åŒ€è‡ªå¢ã€‚å¯èƒ½çœ‹èµ·æ¥æ¯”è¾ƒå¥‡æ€ªï¼Œä»¥ä¸Šæ–‡ Application çš„è°ƒç”¨ä¸¾ä¾‹å­ï¼š</p><table><thead><tr><th>min</th><th>max</th><th>result</th><th>applicationCode</th></tr></thead><tbody><tr><td>0</td><td>/</td><td>1</td><td>User</td></tr><tr><td>0</td><td>/</td><td>-1</td><td>åº”ç”¨ A</td></tr><tr><td>-1</td><td>1</td><td>2</td><td>åº”ç”¨ B</td></tr><tr><td>-1</td><td>2</td><td>-2</td><td>åº”ç”¨ C</td></tr><tr><td>-2</td><td>2</td><td>3</td><td>åº”ç”¨ D</td></tr></tbody></table><ul><li>ã€Userã€‘å’Œã€åº”ç”¨ Aã€‘æ˜¯ç›´æ¥è·å¾— <code>result</code> ï¼Œä¸è°ƒç”¨ <code>#increment(min, max)</code>  æ–¹æ³•ã€‚</li><li>æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä»¥ <code>min + max = 0</code> ä¸ºä¸­å¿ƒç‚¹( å®é™…ä»¥ <code>0</code> ä¸ºä¸­å¿ƒç‚¹)ï¼Œ <strong>åŒå‘</strong>å‡åŒ€è‡ªå¢ã€‚</li></ul><p>TODO ã€4007ã€‘</p><h3 id="2-1-4-Application"><a href="#2-1-4-Application" class="headerlink" title="2.1.4 Application"></a>2.1.4 Application</h3><p><a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/Application.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.Application</code></a> ï¼Œåº”ç”¨ã€‚ä¾‹å¦‚è®°å½•åœ¨ ES å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/05.png" alt=""></p><h2 id="2-2-åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ-API"><a href="#2-2-åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ-API" class="headerlink" title="2.2 åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ API"></a>2.2 åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ API</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/InstanceDiscoveryService.proto#L11" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceDiscoveryService</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/04.png" alt=""></p><p>æ•´ä½“ä»£ç å’Œ <a href="#">ã€Œ2.1 åº”ç”¨çš„æ³¨å†Œ APIã€</a> éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥æœ¬å°èŠ‚ï¼Œæ›´å¤šçš„æ˜¯æä¾›ä»£ç çš„é“¾æ¥åœ°å€ã€‚</p><h3 id="2-2-1-InstanceDiscoveryServiceHandler-register-â€¦"><a href="#2-2-1-InstanceDiscoveryServiceHandler-register-â€¦" class="headerlink" title="2.2.1 InstanceDiscoveryServiceHandler#register(â€¦)"></a>2.2.1 InstanceDiscoveryServiceHandler#register(â€¦)</h3><p><a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/InstanceDiscoveryServiceHandler.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceDiscoveryServiceHandler#register(ApplicationInstance, StreamObserver&lt;ApplicationInstanceMapping&gt;)</code></a>ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ã€‚</p><h3 id="2-2-2-IInstanceIDService-getOrCreate-â€¦"><a href="#2-2-2-IInstanceIDService-getOrCreate-â€¦" class="headerlink" title="2.2.2 IInstanceIDService#getOrCreate(â€¦)"></a>2.2.2 IInstanceIDService#getOrCreate(â€¦)</h3><p><code>org.skywalking.apm.collector.agent.stream.service.register.IInstanceIDService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œåº”ç”¨å®ä¾‹ç¼–å·æœåŠ¡æ¥å£ã€‚</p><ul><li>å®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a4db2c4dd5e2adc861e7fb9e9b7b7ffdc57dfb88/apm-collector/apm-collector-agent-stream/collector-agent-stream-define/src/main/java/org/skywalking/apm/collector/agent/stream/service/register/IInstanceIDService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(applicationCode)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨ç¼–å· + AgentUUIDï¼Œè·å–æˆ–åˆ›å»ºåº”ç”¨å®ä¾‹ï¼Œå¹¶è·å¾—åº”ç”¨ç¼–å·ã€‚</li></ul><p><code>org.skywalking.apm.collector.agent.stream.worker.register.InstanceIDService</code> ï¼Œå®ç° IInstanceIDService æ¥å£ï¼Œåº”ç”¨ç¼–å·æœåŠ¡å®ç°ç±»ã€‚</p><ul><li>å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/a4db2c4dd5e2adc861e7fb9e9b7b7ffdc57dfb88/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/InstanceIDService.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>#getOrCreate(applicationCode)</code></a> æ–¹æ³•ã€‚</li></ul><h3 id="2-2-3-Graph-start-instance"><a href="#2-2-3-Graph-start-instance" class="headerlink" title="2.2.3 Graph#start(instance)"></a>2.2.3 Graph#start(instance)</h3><p>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/RegisterStreamGraph.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#createInstanceRegisterGraph()</code></a> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Instance å¯¹åº”çš„ <code>Graph&lt;Instance&gt;</code> å¯¹è±¡çš„åˆ›å»ºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/InstanceRegisterRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.register.InstanceRegisterRemoteWorker</code></a> ï¼Œç»§æ‰¿ AbstractRemoteWorker æŠ½è±¡ç±»ï¼Œåº”ç”¨å®ä¾‹æ³¨å†Œè¿œç¨‹ Worker ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a9873b9bf07882746bd30f29b3c64f4b44887bf2/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.stream.worker.register.ApplicationRegisterSerialWorker</code></a> ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼Œå¼‚æ­¥ä¿å­˜åº”ç”¨ Worker ã€‚<ul><li>ä¸åŒ Application ï¼ŒInstance çš„åº”ç”¨å®ä¾‹ç¼–å·ï¼Œä» <code>&quot;1&quot;</code> <strong>æ­£å‘</strong>é€’å¢ã€‚ </li><li><a href="https://github.com/YunaiV/skywalking/blob/a4db2c4dd5e2adc861e7fb9e9b7b7ffdc57dfb88/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsRegisterDAO.java#L53" rel="external nofollow noopener noreferrer" target="_blank">InstanceEsRegisterDAO#save(Instance)</a></li></ul></li></ul><h3 id="2-2-4-Instance"><a href="#2-2-4-Instance" class="headerlink" title="2.2.4 Instance"></a>2.2.4 Instance</h3><p><a href="https://github.com/YunaiV/skywalking/blob/69ec2bb309f4fe3cdbda56587a6193be933c4388/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/Instance.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.Instance</code></a> ï¼Œåº”ç”¨å®ä¾‹ã€‚ä¾‹å¦‚è®°å½•åœ¨ ES å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/06.png" alt=""></p><h2 id="2-3-åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ-API"><a href="#2-3-åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ-API" class="headerlink" title="2.3 åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ API"></a>2.3 åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ API</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/InstanceDiscoveryService.proto#L17" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceDiscoveryService.proto</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/07.png" alt=""></p><ul><li>å…¶ä¸­ï¼ŒDownstream æ•°æ®ç±»å‹ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/Downstream.proto" rel="external nofollow noopener noreferrer" target="_blank"><code>Downstream.proto</code></a> ä¸­å®šä¹‰ã€‚</li></ul><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒAgent åœ¨æ³¨å†Œåº”ç”¨æ—¶å€™æˆåŠŸåï¼Œå¦‚æœå› ä¸ºå„ç§åŸå› åŸå› å’Œ Collector æ–­å¼€äº† gRPC Channel è¿æ¥( ä¾‹å¦‚ï¼Œç½‘ç»œ )ï¼Œæ¢å¤è¿æ¥åï¼Œéœ€è¦è°ƒç”¨è¯¥ API ï¼Œè¿›è¡Œ<strong>æ¢å¤</strong>æ³¨å†Œã€‚</p><h3 id="2-3-1-InstanceDiscoveryServiceHandler-recover-â€¦"><a href="#2-3-1-InstanceDiscoveryServiceHandler-recover-â€¦" class="headerlink" title="2.3.1 InstanceDiscoveryServiceHandler#recover(â€¦)"></a>2.3.1 InstanceDiscoveryServiceHandler#recover(â€¦)</h3><p><a href="https://github.com/YunaiV/skywalking/blob/9a01c67f47efc07b9754c77198324cb2d5bb212d/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/InstanceDiscoveryServiceHandler.java#L69" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceDiscoveryServiceHandler#recover(ApplicationInstanceRecover, StreamObserver&lt;Downstream&gt;)</code></a>, ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 71 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/9a01c67f47efc07b9754c77198324cb2d5bb212d/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/util/TimeBucketUtils.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>TimeBucketUtils#getSecondTimeBucket(time)</code></a> æ–¹æ³•ï¼Œå°† <code>registerTime</code> è½¬æˆ timeBucket ã€‚</li><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <code>IInstanceIDService#recover(instanceId, applicationId, registerTime, osInfo)</code> æ–¹æ³•ï¼Œæ¢å¤æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚</li><li>ç¬¬ 75 è‡³ 76 è¡Œï¼šå“åº”ã€‚</li></ul><h3 id="2-3-2-IInstanceIDService-recover-â€¦"><a href="#2-3-2-IInstanceIDService-recover-â€¦" class="headerlink" title="2.3.2 IInstanceIDService#recover(â€¦)"></a>2.3.2 IInstanceIDService#recover(â€¦)</h3><p><a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/InstanceIDService.java#L95" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceIDService#recover(instanceId, applicationId, registerTime, osInfo)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ¢å¤æ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 96 è‡³ 103 è¡Œï¼šåˆ›å»º Instance å¯¹è±¡ï¼Œç”¨äºä¸‹é¢æ›´æ–°æ“ä½œã€‚<ul><li>ç¬¬ 99 è¡Œï¼š TODO ã€4008ã€‘</li></ul></li><li>ç¬¬ 106 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a4db2c4dd5e2adc861e7fb9e9b7b7ffdc57dfb88/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsRegisterDAO.java#L53" rel="external nofollow noopener noreferrer" target="_blank">InstanceEsRegisterDAO#save(Instance)</a> æ–¹æ³•ï¼Œæ›´æ–°åº”ç”¨å®ä¾‹ã€‚</li></ul><h2 id="2-4-åº”ç”¨å®ä¾‹çš„å¿ƒè·³-API"><a href="#2-4-åº”ç”¨å®ä¾‹çš„å¿ƒè·³-API" class="headerlink" title="2.4 åº”ç”¨å®ä¾‹çš„å¿ƒè·³ API"></a>2.4 åº”ç”¨å®ä¾‹çš„å¿ƒè·³ API</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ API çš„å®šä¹‰ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/InstanceDiscoveryService.proto#L14" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceDiscoveryService.proto</code></a> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/08.png" alt=""></p><ul><li>å…¶ä¸­ï¼ŒDownstream æ•°æ®ç±»å‹ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-network/src/main/proto/Downstream.proto" rel="external nofollow noopener noreferrer" target="_blank"><code>Downstream.proto</code></a> ä¸­å®šä¹‰ã€‚</li></ul><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒAgent åœ¨æ³¨å†Œåº”ç”¨æ—¶å€™æˆåŠŸåï¼Œå®šæ—¶å‘ Collector å‘é€<strong>å¿ƒè·³</strong>ï¼Œè®°å½•åº”ç”¨å­˜æ´»ã€‚</p><h3 id="2-4-1-InstanceDiscoveryServiceHandler-heartbeat-â€¦"><a href="#2-4-1-InstanceDiscoveryServiceHandler-heartbeat-â€¦" class="headerlink" title="2.4.1 InstanceDiscoveryServiceHandler#heartbeat(â€¦)"></a>2.4.1 InstanceDiscoveryServiceHandler#heartbeat(â€¦)</h3><p><a href="#">InstanceDiscoveryServiceHandler#heartbeat(ApplicationInstanceHeartbeat, StreamObserver<org.skywalking.apm.network.proto.downstream>)</org.skywalking.apm.network.proto.downstream></a> ï¼Œç›®å‰è¯¥æ–¹æ³•æš‚æœªå®ç°ã€‚å®ç°åï¼Œä¼šé¦–å…ˆè°ƒç”¨ä¸€ä¸ª Service æ–¹æ³•ï¼Œè€Œåè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsRegisterDAO.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>InstanceEsRegisterDAO#updateHeartbeatTime(instanceId, heartbeatTime)</code></a> æ–¹æ³•ï¼Œè®°å½•åº”ç”¨å®ä¾‹çš„å¿ƒè·³æ—¶é—´ã€‚</p><h1 id="3-Agent-è°ƒç”¨æ³¨å†Œ-API"><a href="#3-Agent-è°ƒç”¨æ³¨å†Œ-API" class="headerlink" title="3. Agent è°ƒç”¨æ³¨å†Œ API"></a>3. Agent è°ƒç”¨æ³¨å†Œ API</h1><p><a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.remote.AppAndServiceRegisterClient</code></a> ï¼Œå®ç° BootService ã€GRPCChannelListener ã€Runnable ã€TracingContextListener æ¥å£ï¼Œæ³¨å†Œåº”ç”¨ä¸å®ä¾‹çš„å®¢æˆ·ç«¯ã€‚è¯¥å®¢æˆ·ç«¯ä¼šè°ƒç”¨ä¸Šè¿°æ‰€æœ‰ API ã€‚</p><ul><li><code>PROCESS_UUID</code> <strong>é™æ€</strong>å±æ€§ï¼ŒAgent UUID ï¼Œä½¿ç”¨ <strong>UUID</strong> ç®—æ³•ç”Ÿæˆï¼Œå»é™¤å¤šä½™ <code>&quot;-&quot;</code> ã€‚</li><li>â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”-</li><li><code>status</code> å±æ€§ï¼ŒgRPC è¿æ¥çŠ¶æ€ã€‚</li><li><code>applicationRegisterServiceBlockingStub</code> / <code>instanceDiscoveryServiceBlockingStub</code> / <code>serviceNameDiscoveryServiceBlockingStub</code> å±æ€§ï¼Œå¯¹åº” gRPC æä¾› API çš„<strong>é˜»å¡</strong> Stub ã€‚</li><li><code>needRegisterRecover</code> å±æ€§ï¼Œæ˜¯å¦éœ€è¦å‘èµ·æ¢å¤çš„æ³¨å†Œã€‚</li><li>å¦‚ä¸Šäº”ä¸ªå±æ€§ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#statusChanged(GRPCChannelStatus)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ ¹æ® gRPC è¿æ¥çŠ¶æ€çš„å˜æ›´ï¼Œåˆ›å»ºæˆ–é”€æ¯ Stub ã€‚</li><li>åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå°†è‡ªå·±ä½œä¸ºç›‘å¬å™¨( å› ä¸ºå®ç°äº† GRPCChannelListener æ¥å£ )æ·»åŠ åˆ° GRPCChannelManager ä¸­ï¼Œä»è€Œç›‘å¬ gRPC Channel çš„çŠ¶æ€ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent Remote è¿œç¨‹é€šä¿¡æœåŠ¡ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”-</li><li><code>applicationRegisterFuture</code> å±æ€§ï¼Œæ³¨å†Œåº”ç”¨ä¸å®ä¾‹çš„å®šæ—¶ä»»åŠ¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º <code>applicationRegisterFuture</code> ã€‚è¯¥å®šæ—¶ä»»åŠ¡<strong>æ— åˆå§‹åŒ–å»¶è¿Ÿ</strong>ï¼Œæ¯ <code>Config.Collector.APP_AND_SERVICE_REGISTER_CHECK_INTERVAL</code> ( é»˜è®¤ï¼š3 s ) æ‰§è¡Œä¸€æ¬¡ <code>#run()</code> æ–¹æ³•ã€‚</li><li>â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”-</li><li><code>lastSegmentTime</code> å±æ€§ï¼Œæœ€åè®°å½• Segment çš„æ—¶é—´ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L186" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterFinished()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè®°å½• Segment æœ€åçš„æ—¶é—´ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterBoot()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå°†è‡ªå·±ä½œä¸ºç›‘å¬å™¨( å› ä¸ºå®ç°äº† TracingContextListener æ¥å£ )æ·»åŠ åˆ° GRPCChannelManager ä¸­ï¼Œä»è€Œç›‘å¬ Segment çš„è®°å½•ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-collect-trace/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ”¶é›† Trace æ•°æ®ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/bb8cb1b7dcb428c161f225f0b5d57441105f84c0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/AppAndServiceRegisterClient.java#L120" rel="external nofollow noopener noreferrer" target="_blank"><code>#run()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œåº”ç”¨çš„æ³¨å†Œï¼Œåº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œã€æ¢å¤æ³¨å†Œã€å¿ƒè·³çš„é€»è¾‘ã€‚</p><ul><li>ç¬¬ 123 è¡Œï¼šå¾ªç¯ï¼Œå½“ gRPC å¤„äº<strong>è¿æ¥ä¸­</strong>ï¼Œå¹¶ä¸”éœ€è¦é‡è¯•( <code>shouldTry</code> )ã€‚å¯èƒ½å¯¹ <code>shouldTry</code> ä¼šæ¯”è¾ƒç–‘æƒ‘ï¼Ÿè¯¥å˜é‡ç”¨äºï¼Œåº”ç”¨çš„æ³¨å†ŒæˆåŠŸåï¼Œé‡æ–°æ ‡è®° <code>shouldTry = true</code> ï¼Œç»§ç»­æ‰§è¡Œåº”ç”¨å®ä¾‹çš„æ³¨å†Œã€‚</li><li>ç¬¬ 126 è‡³ 135 è¡Œï¼šå½“æœ¬åœ°<strong>åº”ç”¨ç¼–å·</strong>ä¸ºç©ºæ—¶ï¼Œè¯´æ˜åº”ç”¨æš‚æœªæ³¨å†Œï¼Œè°ƒç”¨ <a href="#">ã€Œ2.1 åº”ç”¨çš„æ³¨å†Œ APIã€</a> ã€‚</li><li>ç¬¬ 138 è‡³ 148 è¡Œï¼šå½“æœ¬åœ°<strong>åº”ç”¨å®ä¾‹ç¼–å·</strong>ä¸ºç©ºæ—¶ï¼Œè¯´æ˜åº”ç”¨å®ä¾‹æš‚æœªæ³¨å†Œï¼Œè°ƒç”¨ <a href="#">ã€Œ2.2 åº”ç”¨å®ä¾‹çš„æ­£å¸¸æ³¨å†Œ APIã€</a> ã€‚</li><li>ç¬¬ 150 è‡³ 158 è¡Œï¼šå½“éœ€è¦å‘èµ·æ¢å¤æ³¨å†Œæ—¶ï¼Œå³ gRPC Channel æ–­å¼€åé‡è¿æˆåŠŸï¼Œè°ƒç”¨ <a href="#">ã€Œ2.3 åº”ç”¨å®ä¾‹çš„æ¢å¤æ³¨å†Œ APIã€</a> ã€‚</li><li>ç¬¬ 159 è‡³ 167 è¡Œï¼šå½“<strong>ç°åœ¨æ—¶é—´</strong>è¶…è¿‡ <code>lastSegmentTime</code> <strong>ä¸€åˆ†é’Ÿ</strong>ï¼Œè°ƒç”¨ <a href="#">ã€Œ2.4 åº”ç”¨å®ä¾‹çš„å¿ƒè·³ APIã€</a> ã€‚</li><li>ç¬¬ 170 è‡³ 173 è¡Œï¼šåŒæ­¥åº”ç”¨å­—å…¸ã€æ“ä½œå­—å…¸ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-dictionary/?">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent DictionaryManager å­—å…¸ç®¡ç†ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 178 è‡³ 180 è¡Œï¼šå½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ <code>GRPCChannelManager#reportError(t)</code> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ï¼Œä¾‹å¦‚è¯·æ±‚è¶…æ—¶ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ è·ç¦» Segment å·²ç»ä¸è¿œäº†ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_25/09.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/register/&quot;&gt;http://www.iocoder.cn/SkyWalking/register/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent Remote è¿œç¨‹é€šä¿¡æœåŠ¡</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-remote-manager/</id>
    <published>2020-09-19T16:00:00.000Z</published>
    <updated>2017-12-26T03:21:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/">http://www.iocoder.cn/SkyWalking/agent-remote-manager/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/">2. GRPCChannelManager</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/">3. GRPCChannelListener</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-remote-manager/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Agent Remote è¿œç¨‹é€šä¿¡æœåŠ¡</strong>ã€‚è¯¥æœåŠ¡ç”¨äº Agent å’ŒCollector é›†ç¾¤çš„é€šä¿¡ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_20/01.png" alt=""></p><p>åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Naming Server å‘½åæœåŠ¡ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼ŒAgent ä½¿ç”¨<strong>å®šæ—¶è½®è¯¢</strong>ï¼Œä» Collector Naming Server ä¸­ï¼Œè·å¾— Collector é›†ç¾¤çš„ Collector Agent gRPC Server çš„<strong>æ‰€æœ‰åœ°å€</strong>ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_20/02.jpeg" alt=""></p><ul><li><strong>çº¢æ¡†</strong>éƒ¨åˆ†ï¼Œå³ä¸º Agent å’ŒCollector é›†ç¾¤çš„é€šä¿¡éƒ¨åˆ†ã€‚</li><li>å¦å¤–ï¼ŒCollector ä¹Ÿæä¾› <a href="https://github.com/YunaiV/skywalking/tree/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-collector/apm-collector-agent-jetty" rel="external nofollow noopener noreferrer" target="_blank">Collector Agent Jetty Server</a> ï¼Œç›®å‰æš‚ä¸ä½¿ç”¨ã€‚ç›¸æ¯”æ¥è¯´ï¼Œ<a href="https://github.com/YunaiV/skywalking/tree/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-collector/apm-collector-agent-grpc" rel="external nofollow noopener noreferrer" target="_blank">Collector Agent gRPC Server</a> æ€§èƒ½æ›´ä¼˜ã€‚</li></ul><h1 id="2-GRPCChannelManager"><a href="#2-GRPCChannelManager" class="headerlink" title="2. GRPCChannelManager"></a>2. GRPCChannelManager</h1><p><code>org.skywalking.apm.agent.core.remote.GRPCChannelManager</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/ac6c98c1732d6aa62b9d244369478654411ac203/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/BootService.java" rel="external nofollow noopener noreferrer" target="_blank">BootService</a> ã€Runnable <strong>æ¥å£</strong>ï¼ŒgRPC Channel ç®¡ç†å™¨ã€‚GRPCChannelManager è´Ÿè´£ç®¡ç†ä¸ Collector Agent gRPC Server é›†ç¾¤çš„<strong>è¿æ¥çš„ç®¡ç†</strong>ï¼Œ<strong>æä¾›ç»™å…¶ä»–æœåŠ¡ä½¿ç”¨</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>managedChannel</code></a> å±æ€§ï¼Œè¿æ¥ gRPC Server çš„ Channel ã€‚<strong>åŒä¸€æ—¶é—´ï¼ŒGRPCChannelManager åªè¿æ¥ä¸€ä¸ª Collector Agent gRPC Server èŠ‚ç‚¹ï¼Œå¹¶ä¸”åœ¨ Channel ä¸å› ä¸ºå„ç§ç½‘ç»œé—®é¢˜æ–­å¼€çš„æƒ…å†µä¸‹ï¼ŒæŒç»­ä¿æŒ</strong>ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>connectCheckFuture</code></a> å±æ€§ï¼Œå®šæ—¶é‡è¿ gRPC Server çš„<strong>å®šæ—¶ä»»åŠ¡</strong>ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L63" rel="external nofollow noopener noreferrer" target="_blank"><code>reconnect</code></a> å±æ€§ï¼Œæ˜¯å¦é‡è¿ã€‚å½“ Channel æœªè¿æ¥éœ€è¦è¿æ¥ï¼Œæˆ–è€… Channel æ–­å¼€éœ€è¦é‡è¿æ—¶ï¼Œæ ‡è®° <code>reconnect = true</code> ã€‚åå°çº¿ç¨‹ä¼šæ ¹æ®è¯¥æ ‡è¯†è¿›è¡Œè¿æ¥( é‡è¿ )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>listeners</code></a> å±æ€§ï¼Œç›‘å¬å™¨( <code>org.skywalking.apm.agent.core.remote.GRPCChannelListener</code> ) æ•°ç»„ã€‚ä½¿ç”¨ Channel çš„å…¶ä»–æœåŠ¡ï¼Œæ³¨å†Œç›‘å¬å™¨åˆ° GRPCChannelManager ä¸Šï¼Œä»è€Œæ ¹æ®è¿æ¥çŠ¶æ€( <code>org.skywalking.apm.agent.core.remote.GRPCChannelStatus</code> )ï¼Œå®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚ </li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>ScheduledExecutorService#scheduleAtFixedRate(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚è¯¥å®šæ—¶ä»»åŠ¡<strong>æ— åˆå§‹åŒ–å»¶è¿Ÿ</strong>ï¼Œæ¯ <code>Config.GRPC_CHANNEL_CHECK_INTERVAL</code> ( é»˜è®¤ï¼š30 s ) æ‰§è¡Œä¸€æ¬¡ <code>#run()</code> æ–¹æ³•ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L97" rel="external nofollow noopener noreferrer" target="_blank"><code>#run()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ Channel çš„è¿æ¥( é‡è¿ )é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 99 è¡Œï¼šå½“ <code>reconnect = true</code> æ—¶ï¼Œæ‰æ‰§è¡Œè¿æ¥( é‡è¿ )ã€‚</li><li>ç¬¬ 100 è¡Œï¼šå½“æœ¬åœ°å·²ç»è·å–åˆ° Collector Agent gRPC Server é›†ç¾¤åœ°å€æ—¶ï¼Œå‚è§ <a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Naming Server å‘½åæœåŠ¡ã€‹</a> ã€‚</li><li>ç¬¬ 101 è‡³ 106 è¡Œï¼š<strong>éšæœºé€‰æ‹©</strong>å‡†å¤‡é“¾æ¥çš„ Collector Agent gRPC Server ã€‚</li><li>ç¬¬ 107 è‡³ 113 è¡Œï¼šåˆ›å»º Channel å¹¶è¿›è¡Œè¿æ¥ã€‚æ­¤å¤„ä¸»è¦æ˜¯ gRPC çš„ API ä½¿ç”¨ï¼Œä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯· Google ä¸‹è¿›è¡Œäº†è§£äº†è§£ã€‚</li><li>ç¬¬ 115 è‡³ 117 è¡Œï¼šè¿æ¥<strong>æˆåŠŸ</strong>ï¼Œæ ‡è®° <code>reconnect = false</code> ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡æ‰§è¡Œ <code>#run()</code> æ–¹æ³•ä¸ä¼šé‡è¿ã€‚è€Œåï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L160" rel="external nofollow noopener noreferrer" target="_blank"><code>#notify(GRPCChannelStatus.CONNECTED)</code></a> æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨è¿æ¥æˆåŠŸã€‚</li><li>ç¬¬ 118 è‡³ 121 è¡Œï¼šè¿æ¥<strong>æˆåŠŸ</strong>ï¼Œä¸æ ‡è®° <code>reconnect</code> ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡æ‰§è¡Œ <code>#run()</code> æ–¹æ³•ä¼šç»§ç»­é‡è¿ã€‚è€Œåï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L160" rel="external nofollow noopener noreferrer" target="_blank"><code>#notify(GRPCChannelStatus.DISCONNECT)</code></a> æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨è¿æ¥å¤„äºæ–­å¼€çŠ¶æ€ã€‚</li><li>ç¬¬ 124 è‡³ 126 è¡Œï¼šè¿æ¥<strong>å¼‚å¸¸</strong>ï¼Œä¸æ ‡è®° <code>reconnect</code> ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡æ‰§è¡Œ <code>#run()</code> æ–¹æ³•ä¼šç»§ç»­é‡è¿ã€‚è€Œåï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L160" rel="external nofollow noopener noreferrer" target="_blank"><code>#notify(GRPCChannelStatus.DISCONNECT)</code></a> æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨è¿æ¥å¤„äºæ–­å¼€çŠ¶æ€ã€‚</li></ul><p>å®é™…ä½¿ç”¨ä¸­ï¼ŒChannel å¯èƒ½å› ä¸ºå„ç§åŸå› æ–­å¼€ï¼Œé‚£ä¹ˆ GRPCChannelManager æ˜¯æ€ä¹ˆæ£€æµ‹çš„å‘¢ï¼Ÿåœ¨ä½¿ç”¨ Channel çš„<strong>å…¶ä»–æœåŠ¡</strong>ï¼Œå½“ä½¿ç”¨ Channel æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L149" rel="external nofollow noopener noreferrer" target="_blank"><code>#reportError(Throwable)</code></a> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç½‘ç»œå¼‚å¸¸( <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelManager.java#L176" rel="external nofollow noopener noreferrer" target="_blank"><code>#isNetworkError(Throwable)</code></a> ) ã€‚è‹¥æ˜¯ï¼Œæ ‡è®° <code>reconnect = true</code> ï¼Œç­‰å¾…åå°è¿›è¡Œé‡è¿ã€‚</p><h1 id="3-GRPCChannelListener"><a href="#3-GRPCChannelListener" class="headerlink" title="3. GRPCChannelListener"></a>3. GRPCChannelListener</h1><p><code>org.skywalking.apm.agent.core.remote.GRPCChannelListener</code> ï¼ŒgRPC Channel çš„ç›‘å¬å™¨<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/ba73b05b99a05bb67fd485188a6c6e0a4ad5fe57/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/GRPCChannelListener.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#statusChanged(GRPCChannelStatus)</code></a> ï¼Œé€šçŸ¥ gRPC Channel çŠ¶æ€å˜æ›´ã€‚</p><p>GRPCChannelListener å®ç°ç±»å¦‚ä¸‹å›¾ï¼Œåç»­æ–‡ç« ä¼šè¯¦ç»†è§£æã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_20/03.png" alt=""></p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>â€œæ°´â€æ–‡ä¸€ç¯‡ï¼Œå“ˆå“ˆå“ˆã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_20/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/agent-remote-manager/&quot;&gt;http://www.iocoder.cn/SkyWalking/agent-remote-manager/&lt;/a&gt; ã€ŒèŠ‹é“æº
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” DataCarrier å¼‚æ­¥å¤„ç†åº“</title>
    <link href="http://www.iocoder.cn/SkyWalking/data-carrier/"/>
    <id>http://www.iocoder.cn/SkyWalking/data-carrier/</id>
    <published>2020-09-14T16:00:00.000Z</published>
    <updated>2017-12-25T12:46:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/data-carrier/">http://www.iocoder.cn/SkyWalking/data-carrier/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">2. buffer</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">2.1 Buffer</a></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">2.2 Channels</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">3. partition</a></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">4. consumer</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">4.1 IConsumer</a></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">4.2 ConsumerThread</a></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">4.3 ConsumerPool</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">4. DataCarrier</a></li><li><a href="http://www.iocoder.cn/SkyWalking/data-carrier/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking DataCarrier å¼‚æ­¥å¤„ç†åº“</strong>ã€‚</p><p>åŸºäºç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¨¡å¼ï¼Œå¤§ä½“ç»“æ„å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_15/01.png" alt=""></p><ul><li>å®é™…é¡¹ç›®ä¸­ï¼Œæ²¡æœ‰ Producer è¿™ä¸ªç±»ã€‚æ‰€ä»¥æœ¬æ–‡æåˆ°çš„ Producer ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§<strong>è§’è‰²</strong>ã€‚</li></ul><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_15/02.png" alt=""></p><h1 id="2-buffer"><a href="#2-buffer" class="headerlink" title="2. buffer"></a>2. buffer</h1><p><code>org.skywalking.apm.commons.datacarrier.buffer</code> åŒ…ï¼Œä¸»è¦åŒ…å« Channels ã€Buffer ä¸¤ä¸ªç±»ã€‚Channels æ˜¯ Buffer æ•°ç»„çš„å°è£…ã€‚</p><h2 id="2-1-Buffer"><a href="#2-1-Buffer" class="headerlink" title="2.1 Buffer"></a>2.1 Buffer</h2><p><code>org.skywalking.apm.commons.datacarrier.buffer.Buffer</code> ï¼Œç¼“å­˜åŒºã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>buffer</code></a> å±æ€§ï¼Œç¼“å†²æ•°ç»„ã€‚Producer ä¿å­˜çš„æ•°æ®åˆ° <code>buffer</code> é‡Œã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>strategy</code></a> ï¼Œç¼“å†²ç­–ç•¥( <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/BufferStrategy.java#L26" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.commons.datacarrier.buffer.BufferStrategy</code></a> ) ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>index</code></a> å±æ€§ï¼Œé€’å¢ä½ç½®( <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/common/AtomicRangeInteger.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.commons.datacarrier.common.AtomicRangeInteger</code></a> )ã€‚</li></ul><p>Buffer åœ¨ä¿å­˜æ•°æ®æ—¶ï¼ŒæŠŠ <code>buffer</code> ä½œä¸ºä¸€ä¸ª â€œ<strong>ç¯</strong>â€œï¼Œä½¿ç”¨ <code>index</code> è®°å½•æœ€åå­˜å‚¨çš„ä½ç½®ï¼Œä¸æ–­å‘ä¸‹ï¼Œ<strong>å¾ªç¯</strong>å­˜å‚¨åˆ° <code>buffer</code> ä¸­ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¸¦æ¥è‰¯å¥½çš„å­˜å‚¨æ€§èƒ½ï¼Œé¿å…æ‰©å®¹é—®é¢˜ã€‚But ï¼Œå­˜å‚¨ä¼šå­˜åœ¨å†²çªçš„é—®é¢˜ï¼š<code>buffer</code> å†™å…¥ä½ç½®ï¼Œæš‚æœªè¢«æ¶ˆè´¹ï¼Œå·²ç»å­˜åœ¨å€¼ã€‚æ­¤æ—¶ï¼Œæ ¹æ®ä¸åŒçš„ BufferStrategy è¿›è¡Œå¤„ç†ã€‚æ•´ä½“æµç¨‹è§ <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#save(data)</code></a> æ–¹æ³•ã€‚</p><p>å½“ Buffer è¢« Consumer æ¶ˆè´¹æ—¶ï¼Œè¢«è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L88" rel="external nofollow noopener noreferrer" target="_blank"><code>#obtain(start, end)</code></a> æ–¹æ³•ï¼Œè·å¾—æ•°æ®å¹¶æ¸…ç©ºã€‚ä¸ºä»€ä¹ˆä¼šå¸¦ <code>start</code> ã€<code>end</code> æ–¹æ³•å‚æ•°å‘¢ï¼Ÿä¸‹æ–‡æ­æ™“ç­”æ¡ˆã€‚</p><h2 id="2-2-Channels"><a href="#2-2-Channels" class="headerlink" title="2.2 Channels"></a>2.2 Channels</h2><p><code>org.skywalking.apm.commons.datacarrier.buffer.Channels</code> ï¼Œå†…åµŒ<strong>å¤šä¸ª</strong> Buffer çš„é€šé“ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Channels.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>bufferChannels</code></a> å±æ€§ï¼ŒBuffer æ•°ç»„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Channels.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>dataPartitioner</code></a> å±æ€§ï¼Œæ•°æ®åˆ†åŒº( <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/partition/IDataPartitioner.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.commons.datacarrier.partition.IDataPartitioner</code></a> )ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>strategy</code></a> å±æ€§ï¼Œç¼“å†²ç­–ç•¥( <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Channels.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.commons.datacarrier.buffer.BufferStrategy</code></a> ) ã€‚</li></ul><p>Channels åœ¨ä¿å­˜æ•°æ®æ—¶ï¼Œç›¸æ¯” Buffer ï¼Œä» <code>buffer</code> å˜æˆäº†å¤š <code>buffer</code> ï¼Œå› æ­¤éœ€è¦å…ˆé€‰ä¸€ä¸ª <code>buffer</code> ã€‚é€šè¿‡ä½¿ç”¨ä¸åŒçš„ IDataPartitioner å®ç°ç±»ï¼Œè¿›è¡Œ Buffer çš„é€‰æ‹©ã€‚å½“ç¼“å†²ç­–ç•¥ä¸º <code>BufferStrategy.IF_POSSIBLE</code> æ—¶ï¼Œæ ¹æ® IDataPartitioner å®šä¹‰çš„é‡è¯•æ¬¡æ•°ï¼Œè¿›è¡Œå¤šæ¬¡ä¿å­˜æ•°æ®ç›´åˆ°æˆåŠŸã€‚æ•´ä½“æµç¨‹è§ <a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Channels.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#save(data)</code></a> æ–¹æ³•ã€‚</p><h1 id="3-partition"><a href="#3-partition" class="headerlink" title="3. partition"></a>3. partition</h1><p><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/partition/IDataPartitioner.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.commons.datacarrier.partition.IDataPartitioner</code></a> ï¼Œæ•°æ®åˆ†é…è€…<strong>æ¥å£</strong>ã€‚å®šä¹‰äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/partition/IDataPartitioner.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#partition(total, data)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè·å¾—æ•°æ®è¢«åˆ†é…çš„åˆ†åŒºä½ç½®ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/partition/IDataPartitioner.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#maxRetryCount()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè·å¾—æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚</li></ul><p>IDataPartitioner ç›®å‰æœ‰ä¸¤ä¸ªå­ç±»å®ç°ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/partition/ProducerThreadPartitioner.java" rel="external nofollow noopener noreferrer" target="_blank">ProducerThreadPartitioner</a> ï¼ŒåŸºäºçº¿ç¨‹ç¼–å·åˆ†é…ç­–ç•¥çš„æ•°æ®åˆ†é…è€…å®ç°ç±»ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/98217271d1b4d2075871b3e262c9b99bb9c1f657/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/partition/SimpleRollingPartitioner.java" rel="external nofollow noopener noreferrer" target="_blank">SimpleRollingPartitioner</a> ï¼ŒåŸºäºé¡ºåºåˆ†é…ç­–ç•¥çš„æ•°æ®åˆ†é…è€…å®ç°ç±»ã€‚</li></ul><h1 id="4-consumer"><a href="#4-consumer" class="headerlink" title="4. consumer"></a>4. consumer</h1><p><code>org.skywalking.apm.commons.datacarrier.consumer</code> åŒ…ï¼Œä¸»è¦åŒ…å« ConsumerPool ã€ConsumerThread ã€IConsumer ä¸‰ä¸ªç±»ã€‚</p><ul><li>ConsumerThread ä½¿ç”¨ IConsumer ï¼Œæ¶ˆè´¹æ•°æ®</li><li>ConsumerPool æ˜¯ ConsumerThread çš„çº¿ç¨‹æ± å°è£…</li></ul><h2 id="4-1-IConsumer"><a href="#4-1-IConsumer" class="headerlink" title="4.1 IConsumer"></a>4.1 IConsumer</h2><p><code>org.skywalking.apm.commons.datacarrier.consumer.IConsumer</code> ï¼Œæ¶ˆè´¹è€…æ¥å£ã€‚å®šä¹‰äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/IConsumer.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#init()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆå§‹åŒ–æ¶ˆè´¹è€…ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/IConsumer.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume(List&lt;T&gt;)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/IConsumer.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>#onError(List&lt;T&gt;, Throwable)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå¤„ç†å½“æ¶ˆè´¹å‘ç”Ÿå¼‚å¸¸ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/IConsumer.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#onExit()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå¤„ç†å½“æ¶ˆè´¹ç»“æŸã€‚æ­¤å¤„çš„ç»“æŸæ—¶ï¼ŒConsumerThread å…³é—­ã€‚</li></ul><p>æˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶ï¼Œè‡ªå®šä¹‰ Consumer ç±»ï¼Œå®ç° IConsumer æ¥å£ã€‚ä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L93" rel="external nofollow noopener noreferrer" target="_blank">RemoteMessageConsumer</a> ã€‚</p><h2 id="4-2-ConsumerThread"><a href="#4-2-ConsumerThread" class="headerlink" title="4.2 ConsumerThread"></a>4.2 ConsumerThread</h2><p><code>org.skywalking.apm.commons.datacarrier.consumer.ConsumerThread</code> ï¼Œç»§æ‰¿ <code>java.lang.Thread</code> ï¼Œæ¶ˆè´¹çº¿ç¨‹ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>running</code></a> å±æ€§ï¼Œæ˜¯å¦è¿è¡Œä¸­ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>consumer</code></a> å±æ€§ï¼Œæ¶ˆè´¹è€…å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>dataSources</code></a> å±æ€§ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„æ•°æ®æº( <a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L139" rel="external nofollow noopener noreferrer" target="_blank">DataSource</a> )æ•°ç»„ã€‚ä¸€ä¸ª ConsumerThread ï¼Œå¯ä»¥æ¶ˆè´¹å¤šä¸ª Buffer ï¼Œå¹¶ä¸”å•ä¸ª Buffer æ¶ˆè´¹çš„åˆ†åŒºèŒƒå›´å¯é…ç½®ï¼Œå³ä¸€ä¸ª Buffer å¯ä»¥è¢«å¤šä¸ª ConsumerThread åŒæ—¶æ— å†²çªçš„æ¶ˆè´¹ã€‚åœ¨ <a href="#">ã€Œ4.3 ConsumerPoolã€</a> è¯¦ç»†è§£æ ConsumerThread åˆ†é… Buffer çš„æ–¹å¼ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#addDataSource(sourceBuffer, start, end)</code></a> æ–¹æ³•ï¼Œæ·»åŠ  Buffer éƒ¨åˆ†èŒƒå›´ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L69" rel="external nofollow noopener noreferrer" target="_blank"><code>#addDataSource(sourceBuffer)</code></a> æ–¹æ³•ï¼Œæ·»åŠ  Buffer å…¨éƒ¨èŒƒå›´ã€‚</li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>#run()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œ<strong>ä¸æ–­</strong>ã€<strong>æ‰¹é‡</strong>çš„æ¶ˆè´¹æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 78 è‡³ 88 è¡Œï¼š<strong>ä¸æ–­</strong>æ¶ˆè´¹ï¼Œç›´åˆ°çº¿ç¨‹å…³é—­( <a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L130" rel="external nofollow noopener noreferrer" target="_blank"><code>#shutdown()</code></a> )ã€‚<ul><li>ç¬¬ 80 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume()</code></a> æ–¹æ³•ï¼Œ<strong>æ‰¹é‡</strong>æ¶ˆè´¹æ•°æ®ã€‚</li><li>ç¬¬ 82 è‡³ 87 è¡Œï¼šå½“æœªæ¶ˆè´¹åˆ°æ•°æ®ï¼Œè¯´æ˜ <code>dataSources</code> ä¸ºç©ºï¼Œç­‰å¾… 20 ms ï¼Œé¿å… CPU ç©ºè·‘ã€‚</li></ul></li><li>ç¬¬ 93 è¡Œï¼šå½“çº¿ç¨‹å…³é—­ï¼Œè°ƒç”¨ <code>#consume()</code> æ–¹æ³•ï¼Œæ¶ˆè´¹å®Œ <code>dataSources</code> å‰©ä½™çš„æ•°æ®ã€‚</li><li>ç¬¬ 95 è¡Œï¼šè°ƒç”¨ <code>IConsumer#onExit()</code> æ–¹æ³•ï¼Œå¤„ç†å½“æ¶ˆè´¹ç»“æŸã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerThread.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume()</code></a> æ–¹æ³•ï¼Œ<strong>æ‰¹é‡</strong>æ¶ˆè´¹æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 107 è‡³ 117 è¡Œï¼šä» <code>dataSources</code> ä¸­ï¼Œè·å–è¦æ¶ˆè´¹çš„æ•°æ®ã€‚</li><li>ç¬¬ 120 è‡³ 126 è¡Œï¼šå½“æœ‰æ•°æ®å¯æ¶ˆè´¹æ—¶ï¼Œè°ƒç”¨ <code>IConsumer#consume(List&lt;T&gt;)</code> æ–¹æ³•ã€‚å½“æ¶ˆè´¹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ <code>IConsumer#onError(List&lt;T&gt;, Throwable)</code> æ–¹æ³•ã€‚</li><li>ç¬¬ 127 è¡Œï¼šè¿”å›æ˜¯å¦æœ‰æ¶ˆè´¹æ•°æ®ã€‚</li></ul><h2 id="4-3-ConsumerPool"><a href="#4-3-ConsumerPool" class="headerlink" title="4.3 ConsumerPool"></a>4.3 ConsumerPool</h2><p><code>org.skywalking.apm.commons.datacarrier.consumer.ConsumerPool</code> ï¼Œæ¶ˆè´¹è€…æ± ï¼Œæä¾›äº†å¯¹ Channels å¯åŠ¨<strong>æŒ‡å®šæ•°é‡</strong>çš„ ConsumerThread è¿›è¡Œæ¶ˆè´¹ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>running</code></a> å±æ€§ï¼Œæ˜¯å¦è¿è¡Œä¸­ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>consumerThreads</code></a> å±æ€§ï¼ŒConsumerThread æ•°ç»„ï¼Œé€šè¿‡æ„é€ æ–¹æ³•çš„ <code>num</code> å‚æ•°è¿›è¡ŒæŒ‡å®šã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>channels</code></a> å±æ€§ï¼Œ<strong>æ•°æ®</strong>é€šé“ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>lock</code></a> å±æ€§ï¼Œé”ã€‚ä¿è¯ ConsumerPool å¯åŠ¨æˆ–å…³é—­æ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L96" rel="external nofollow noopener noreferrer" target="_blank"><code>#begin()</code></a> æ–¹æ³•ï¼Œå¯åŠ¨ ConsumerPool ï¼Œè¿›è¡Œæ•°æ®æ¶ˆè´¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 97 è‡³ 99 è¡Œï¼šæ­£åœ¨è¿è¡Œä¸­ï¼Œç›´æ¥è¿”å›ã€‚</li><li>ç¬¬ 101 è¡Œï¼šè·å¾—é”ã€‚</li><li>ç¬¬ 104 è¡Œï¼šè°ƒç”¨ <code>#allocateBuffer2Thread()</code> æ–¹æ³•ï¼Œå°† <code>channels</code> çš„<strong>å¤šä¸ª</strong> Buffer ï¼Œåˆ†é…ç»™ <code>consumerThreads</code> çš„<strong>å¤šä¸ª</strong> ConsumerThreadã€‚</li><li>ç¬¬ 107 è‡³ 109 è¡Œï¼šå¯åŠ¨æ¯ä¸ª ConsumerThread ï¼Œå¼€å§‹æ¶ˆè´¹ã€‚</li><li>ç¬¬ 112 è¡Œï¼šæ ‡è®°æ­£åœ¨è¿è¡Œä¸­ã€‚</li><li>ç¬¬ 114 è¡Œï¼šé‡Šæ”¾é”ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L166" rel="external nofollow noopener noreferrer" target="_blank"><code>close()</code></a> æ–¹æ³•ï¼Œå…³é—­ ConsumerPool ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 168 è¡Œï¼šè·å¾—é”ã€‚</li><li>ç¬¬ 169 è¡Œï¼šæ ‡è®°ä¸åœ¨è¿è¡Œä¸­ã€‚</li><li>ç¬¬ 170 è‡³ 172 è¡Œï¼šå…³é—­æ¯ä¸ª ConsumerThread ï¼Œç»“æŸæ¶ˆè´¹ã€‚</li><li>ç¬¬ 174 è¡Œï¼šé‡Šæ”¾é”ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/consumer/ConsumerPool.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#allocateBuffer2Thread()</code></a> æ–¹æ³•ï¼Œå°† <code>channels</code> çš„<strong>å¤šä¸ª</strong> Buffer ï¼Œåˆ†é…ç»™ <code>consumerThreads</code> çš„<strong>å¤šä¸ª</strong> ConsumerThreadã€‚ä¸€å…±ä¼šæœ‰ä¸‰ç§æƒ…å†µï¼š</p><ul><li><p>Buffer æ•°é‡<strong>ç­‰äº</strong> ConsumerThread æ•°é‡ï¼Œè¿™ä¸ªååˆ†å¥½åˆ†é…ï¼Œä¸€æ¯”ä¸€ã€‚</p></li><li><p>Buffer æ•°é‡<strong>å¤§äº</strong> ConsumerThread æ•°é‡ï¼Œé‚£ä¹ˆæŒ‰ç…§ Buffer æ•°é‡ <code>%</code> ConsumerThread æ•°é‡è¿›è¡Œåˆ†ç»„ï¼Œåˆ†é…ç»™ ConsumerThread ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_15/03.png" alt=""></p></li><li><p>Buffer æ•°é‡<strong>å¤§äº</strong> ConsumerThread æ•°é‡ï¼Œé‚£ä¹ˆæŒ‰ç…§ ConsumerThread æ•°é‡ <code>%</code> Buffer æ•°é‡è¿›è¡Œåˆ†ç»„ï¼Œåˆ†é…ç»™ Buffer ã€‚å…¶ä¸­ï¼Œä¸€ä¸ª Buffer ä¼šè¢«<strong>å‡åˆ†</strong>ç»™å¤šä¸ª ConsumerThread ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_15/04.png" alt=""></p><ul><li>è¿™ä¸ªå°±æ˜¯ä¸ºä»€ä¹ˆ Buffer é‡Œé¢ï¼Œæä¾›äº† <a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/buffer/Buffer.java#L88" rel="external nofollow noopener noreferrer" target="_blank"><code>Buffer#obtain(start, end)</code></a> æ–¹æ³•çš„åŸå› ã€‚</li></ul></li></ul><h1 id="4-DataCarrier"><a href="#4-DataCarrier" class="headerlink" title="4. DataCarrier"></a>4. DataCarrier</h1><p><code>org.skywalking.apm.commons.datacarrier.DataCarrier</code> ï¼ŒDataCarrier å¼‚æ­¥å¤„ç†åº“çš„<strong>å…¥å£ç¨‹åº</strong>ã€‚é€šè¿‡åˆ›å»º DataCarrier å¯¹è±¡ï¼Œä½¿ç”¨<strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ¨¡å¼</strong>ï¼Œæ‰§è¡Œå¼‚æ­¥æ‰§è¡Œé€»è¾‘ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L53" rel="external nofollow noopener noreferrer" target="_blank">æ„é€ æ–¹æ³•</a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>channels</code></a> å±æ€§ï¼Œ<strong>æ•°æ®</strong>é€šé“ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é»˜è®¤ä½¿ç”¨ SimpleRollingPartitioner ä½œä¸ºæ•°æ®åˆ†åŒºåˆ†é…è€…ï¼Œä½¿ç”¨ <code>BufferStrategy.BLOCKING</code> ä½œä¸ºç¼“å†²ç­–ç•¥ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#setPartitioner(IDataPartitioner)</code></a> æ–¹æ³•ï¼Œè®¾ç½®æ•°æ®åˆ†åŒºåˆ†é…è€…ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>#setBufferStrategy(BufferStrategy)</code></a> æ–¹æ³•ï¼Œè®¾ç½®ç¼“å†²ç­–ç•¥ã€‚</li></ul></li><li><p><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>channelSize</code></a> æ–¹æ³•å‚æ•°ï¼Œé€šé“å¤§å°ã€‚</p></li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>bufferSize</code></a> æ–¹æ³•å‚æ•°ï¼Œç¼“å†²åŒºå¤§å°ã€‚</li></ul><p><strong>è®¾ç½®æ¶ˆè´¹è€…å’Œæ¶ˆè´¹çº¿ç¨‹æ•°é‡</strong>ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L107" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume(Class&lt;? extends IConsumer&lt;T&gt;&gt;, num)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L124" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume(IConsumer&lt;T&gt;, num)</code></a></li></ul><p><strong>ç”Ÿäº§æ¶ˆæ¯</strong></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L88" rel="external nofollow noopener noreferrer" target="_blank"><code>#produce(data)</code></a></li></ul><p><strong>å…³é—­æ¶ˆè´¹</strong></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/fbdce6d3c0fe456629a2eef40184a3dbc9df812c/apm-commons/apm-datacarrier/src/main/java/org/skywalking/apm/commons/datacarrier/DataCarrier.java#L138" rel="external nofollow noopener noreferrer" target="_blank"><code>#shutdownConsumers()</code></a></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æœ¬æ–‡çš„å›¾ï¼Œç”»çš„çœŸéš¾çœ‹ï¼Œæ¥è‡ªè‡ªå·±çš„åæ§½ï¼Œå“ˆå“ˆå“ˆã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_15/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/data-carrier/&quot;&gt;http://www.iocoder.cn/SkyWalking/data-carrier/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Remote è¿œç¨‹é€šä¿¡æœåŠ¡</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-remote-module/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-remote-module/</id>
    <published>2020-09-09T16:00:00.000Z</published>
    <updated>2017-12-25T12:45:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">http://www.iocoder.cn/SkyWalking/collector-remote-module/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2. collector-remote-define</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.1 RemoteModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.2 RemoteSenderService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.3 RemoteClientService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.4 RemoteClient</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.5 CommonRemoteDataRegisterService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.6 RemoteSerializeService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">2.7 RemoteSerializeService</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3. collector-remote-grpc-provider</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.1 RemoteModuleGRPCProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.2 GRPCRemoteSenderService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.3 GRPCRemoteClientService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.4 GRPCRemoteClient</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.5 RemoteCommonServiceHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.6 GRPCRemoteSerializeService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">3.7 GRPCRemoteDeserializeService</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">4. collector-remote-grpc-provider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-remote-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Remote è¿œç¨‹é€šä¿¡æœåŠ¡</strong>ã€‚è¯¥æœåŠ¡ç”¨äº Collector é›†ç¾¤å†…éƒ¨é€šä¿¡ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/04.png" alt=""></p><p>ç›®å‰é›†ç¾¤å†…éƒ¨é€šä¿¡çš„ç›®çš„ï¼Œè·¨èŠ‚ç‚¹çš„æµå¼å¤„ç†ã€‚Remote Module <strong>åº”ç”¨</strong>åœ¨ SkyWalking æ¶æ„å›¾å¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM <a href="https://github.com/apache/incubating-skywalking" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubating-skywalking</a><br><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/02.png" alt=""></p><ul><li><code>collector-remote-define</code> ï¼šå®šä¹‰è¿œç¨‹é€šä¿¡æ¥å£ã€‚</li><li><code>collector-remote-kafka-provider</code> ï¼šåŸºäº Kafka çš„è¿œç¨‹é€šä¿¡å®ç°ã€‚<em>ç›®å‰æš‚æœªå®Œæˆ</em>ã€‚</li><li><code>collector-remote-grpc-provider</code> ï¼šåŸºäº <a href="https://grpc.io/" rel="external nofollow noopener noreferrer" target="_blank">Google gRPC</a> çš„è¿œç¨‹é€šä¿¡å®ç°ã€‚<strong>ç”Ÿäº§ç¯å¢ƒç›®å‰ä½¿ç”¨</strong></li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1 id="2-collector-remote-define"><a href="#2-collector-remote-define" class="headerlink" title="2. collector-remote-define"></a>2. collector-remote-define</h1><p><code>collector-remote-define</code> ï¼šå®šä¹‰è¿œç¨‹é€šä¿¡æ¥å£ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/03.png" alt=""></p><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/05.png" alt=""></p><p>æˆ‘ä»¬æŒ‰ç…§æ•´ä¸ªæµç¨‹çš„å¤„ç†é¡ºåºï¼Œé€ä¸ªè§£ææ¶‰åŠåˆ°çš„ç±»ä¸æ¥å£ã€‚</p><h2 id="2-1-RemoteModule"><a href="#2-1-RemoteModule" class="headerlink" title="2.1 RemoteModule"></a>2.1 RemoteModule</h2><p><code>org.skywalking.apm.collector.remote.RemoteModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼Œè¿œç¨‹é€šä¿¡ Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/RemoteModule.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;remote&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/RemoteModule.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šRemoteSenderService ã€RemoteDataRegisterService ã€‚</p><h2 id="2-2-RemoteSenderService"><a href="#2-2-RemoteSenderService" class="headerlink" title="2.2 RemoteSenderService"></a>2.2 RemoteSenderService</h2><p><code>org.skywalking.apm.collector.remote.service.RemoteSenderService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œè¿œç¨‹å‘é€æœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteSenderService.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#send(graphId, nodeId, data, selector)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè°ƒç”¨ RemoteClient ï¼Œå‘é€æ•°æ®ã€‚</p><ul><li><code>graphId</code> æ–¹æ³•å‚æ•°ï¼ŒGraph ç¼–å·ã€‚é€šè¿‡ <code>graphId</code> ï¼Œå¯ä»¥æŸ¥æ‰¾åˆ°å¯¹åº”çš„ Graph å¯¹è±¡ã€‚<ul><li>Graph åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ2. apm-collector-core/graphã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><code>nodeId</code> æ–¹æ³•å‚æ•°ï¼ŒWorker ç¼–å·ã€‚é€šè¿‡ <code>workerId</code> ï¼Œå¯ä»¥æŸ¥æ‰¾åœ¨ Graph å¯¹è±¡ä¸­çš„ Worker å¯¹è±¡ï¼Œä»è€Œ Graph ä¸­çš„æµå¼å¤„ç†ã€‚<ul><li>Worker åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3. apm-collector-streamã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><code>data</code> æ–¹æ³•å‚æ•°ï¼ŒData æ•°æ®å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œæµå¼å¤„ç†çš„å…·ä½“æ•°æ®å¯¹è±¡ã€‚<ul><li>Data åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶ã€‹ã€Œ2. apm-collector-coreã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><code>selector</code> æ–¹æ³•å‚æ•°ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/Selector.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.service.Selector</code></a> é€‰æ‹©å™¨å¯¹è±¡ã€‚æ ¹æ® Selector å¯¹è±¡ï¼Œä½¿ç”¨å¯¹åº”çš„<strong>è´Ÿè½½å‡è¡¡</strong>ç­–ç•¥ï¼Œé€‰æ‹©é›†ç¾¤å†…çš„ Collector èŠ‚ç‚¹ï¼Œå‘é€æ•°æ®ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteSenderService.java#L45" rel="external nofollow noopener noreferrer" target="_blank">RemoteSenderService.Mode</a> è¿”å›å€¼ï¼Œå‘é€æ¨¡å¼åˆ†æˆ <code>Remote</code> å’Œ <code>Local</code> ä¸¤ç§æ–¹å¼ã€‚å‰è€…ï¼Œå‘é€æ•°æ®åˆ°è¿œç¨‹çš„ Collector èŠ‚ç‚¹ï¼›åè€…ï¼Œå‘é€æ•°æ®åˆ°æœ¬åœ°ï¼Œå³æœ¬åœ°å¤„ç†ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/RemoteWorkerRef.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteWorkerRef#in(message)</code></a> æ–¹æ³•ã€‚</li></ul><h2 id="2-3-RemoteClientService"><a href="#2-3-RemoteClientService" class="headerlink" title="2.3 RemoteClientService"></a>2.3 RemoteClientService</h2><p><code>org.skywalking.apm.collector.remote.service.RemoteClientService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œè¿œç¨‹å®¢æˆ·ç«¯æœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteClientService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(host, port, channelSize, bufferSize)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ›å»º RemoteClient å¯¹è±¡ã€‚</p><h2 id="2-4-RemoteClient"><a href="#2-4-RemoteClient" class="headerlink" title="2.4 RemoteClient"></a>2.4 RemoteClient</h2><p><code>org.skywalking.apm.collector.remote.service.RemoteClient</code> ï¼Œç»§æ‰¿ <code>java.lang.Comparable</code> æ¥å£ï¼Œè¿œç¨‹å®¢æˆ·ç«¯<strong>æ¥å£</strong>ã€‚å®šä¹‰äº†å¦‚ä¸‹æ¥å£æ–¹æ³•ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteClient.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#push(graphId, nodeId, data, selector)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå‘é€æ•°æ®ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteClient.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#getAddress()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè¿”å›å®¢æˆ·ç«¯è¿æ¥çš„è¿œç¨‹ Collector åœ°å€ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteClient.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>#equals(address)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ¤æ–­ RemoteClient æ˜¯å¦è¿æ¥äº†æŒ‡å®šçš„åœ°å€ã€‚</li></ul><h2 id="2-5-CommonRemoteDataRegisterService"><a href="#2-5-CommonRemoteDataRegisterService" class="headerlink" title="2.5 CommonRemoteDataRegisterService"></a>2.5 CommonRemoteDataRegisterService</h2><p>åœ¨è¯´ CommonRemoteDataRegisterService ä¹‹å‰ï¼Œé¦–å…ˆæ¥è¯´ä¸‹ CommonRemoteDataRegisterService çš„æ„å›¾ã€‚</p><p>åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘é€ç»™ Collector æ˜¯ Data å¯¹è±¡ï¼Œè€Œ <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/data/Data.java" rel="external nofollow noopener noreferrer" target="_blank">Data</a> æ˜¯æ•°æ®çš„<strong>æŠ½è±¡ç±»</strong>ï¼Œåœ¨å…·ä½“ååºåˆ—åŒ– Data å¯¹è±¡ä¹‹å‰ï¼Œç¨‹åºæ˜¯æ— æ³•å¾—çŸ¥å®ƒæ˜¯ Data çš„å“ªä¸ªå®ç°å¯¹è±¡ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ Data å¯¹è±¡çš„æ¯ä¸ªå®ç°ç±»ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„<strong>æ•°æ®åè®®ç¼–å·</strong>ã€‚</p><ul><li>åœ¨å‘é€æ•°æ®ä¹‹å‰ï¼Œåºåˆ—åŒ– Data å¯¹è±¡æ—¶ï¼Œå¢åŠ è¯¥ Data å¯¹åº”çš„åè®®ç¼–å·ï¼Œä¸€èµ·å‘é€ã€‚</li><li>åœ¨æ¥æ”¶æ•°æ®ä¹‹åï¼Œååºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ ¹æ®åè®®ç¼–å·ï¼Œåˆ›å»º Data å¯¹åº”çš„å®ç°ç±»å¯¹è±¡ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.service.CommonRemoteDataRegisterService</code></a> ï¼Œé€šç”¨è¿œç¨‹æ•°æ®æ³¨å†ŒæœåŠ¡ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>id</code></a> å±æ€§ï¼Œæ•°æ®åè®®è‡ªå¢ç¼–å·ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>dataClassMapping</code></a> å±æ€§ï¼Œæ•°æ®ç±»å‹( Class&lt;? extends Data&gt; )ä¸<strong>æ•°æ®åè®®ç¼–å·</strong>çš„æ˜ å°„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>dataInstanceCreatorMapping</code></a> å±æ€§ï¼Œ<strong>æ•°æ®åè®®ç¼–å·</strong>ä¸æ•°æ®å¯¹è±¡åˆ›å»ºå™¨( RemoteDataInstanceCreator )çš„æ˜ å°„ã€‚</li></ul><h3 id="2-5-1-RemoteDataRegisterService"><a href="#2-5-1-RemoteDataRegisterService" class="headerlink" title="2.5.1 RemoteDataRegisterService"></a>2.5.1 RemoteDataRegisterService</h3><p><code>org.skywalking.apm.collector.remote.service.RemoteDataRegisterService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œè¿œç¨‹å®¢æˆ·ç«¯æœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteDataRegisterService.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(Class&lt;? extends Data&gt;, RemoteDataInstanceCreator)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ³¨å†Œæ•°æ®ç±»å‹å¯¹åº”çš„è¿œç¨‹æ•°æ®åˆ›å»ºå™¨( <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteDataRegisterService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteDataRegisterService.RemoteDataInstanceCreator</code></a> )å¯¹è±¡ã€‚</p><p>CommonRemoteDataRegisterService å®ç°äº† RemoteDataRegisterService æ¥å£ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(Class&lt;? extends Data&gt;, RemoteDataInstanceCreator)</code></a> <strong>å®ç°</strong>æ–¹æ³•ã€‚</p><p>å¦å¤–ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/AgentStreamRemoteDataRegister.java#L42" rel="external nofollow noopener noreferrer" target="_blank">AgentStreamRemoteDataRegister</a> ä¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteDataRegisterService.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteDataRegisterService#register(Class&lt;? extends Data&gt;, RemoteDataInstanceCreator)</code></a> æ–¹æ³•ï¼Œæ³¨å†Œæ¯ä¸ªæ•°æ®ç±»å‹çš„ RemoteDataInstanceCreator å¯¹è±¡ã€‚æ³¨æ„ï¼Œä¾‹å¦‚ <code>Application::new</code> æ˜¯ RemoteDataInstanceCreator çš„<strong>åŒ¿åå®ç°ç±»</strong>ã€‚</p><h3 id="2-5-2-RemoteDataIDGetter"><a href="#2-5-2-RemoteDataIDGetter" class="headerlink" title="2.5.2 RemoteDataIDGetter"></a>2.5.2 RemoteDataIDGetter</h3><p><code>org.skywalking.apm.collector.remote.service.RemoteDataIDGetter</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œè¿œç¨‹æ•°æ®åè®®ç¼–å·è·å–å™¨<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteDataIDGetter.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#getRemoteDataId(Class&lt;? extends Data&gt;)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ ¹æ®æ•°æ®ç±»å‹è·å–æ•°æ®åè®®ç¼–å·ã€‚</p><p>CommonRemoteDataRegisterService å®ç°äº† RemoteDataIDGetter æ¥å£ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java#L67" rel="external nofollow noopener noreferrer" target="_blank"><code>#getRemoteDataId(Class&lt;? extends Data&gt;)</code></a> <strong>å®ç°</strong>æ–¹æ³•ã€‚</p><h3 id="2-5-3-RemoteDataInstanceCreatorGetter"><a href="#2-5-3-RemoteDataInstanceCreatorGetter" class="headerlink" title="2.5.3 RemoteDataInstanceCreatorGetter"></a>2.5.3 RemoteDataInstanceCreatorGetter</h3><p><code>org.skywalking.apm.collector.remote.service.RemoteDataInstanceCreatorGetter</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œè¿œç¨‹æ•°æ®åˆ›å»ºå™¨çš„è·å–å™¨<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/f70019926200139f9fe235ade9aaf7724ab72c8b/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteDataInstanceCreatorGetter.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>#getInstanceCreator(remoteDataId</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ ¹æ®æ•°æ®åè®®ç¼–å·è·å¾—è¿œç¨‹æ•°æ®åˆ›å»ºå™¨( RemoteDataInstanceCreator )ã€‚</p><p>CommonRemoteDataRegisterService å®ç°äº† RemoteDataInstanceCreatorGetter æ¥å£ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/f70019926200139f9fe235ade9aaf7724ab72c8b/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/CommonRemoteDataRegisterService.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#getInstanceCreator(remoteDataId)</code></a> <strong>å®ç°</strong>æ–¹æ³•ã€‚</p><h2 id="2-6-RemoteSerializeService"><a href="#2-6-RemoteSerializeService" class="headerlink" title="2.6 RemoteSerializeService"></a>2.6 RemoteSerializeService</h2><p><code>org.skywalking.apm.collector.remote.service.RemoteSerializeService</code> ï¼Œè¿œç¨‹é€šä¿¡åºåˆ—åŒ–æœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/f70019926200139f9fe235ade9aaf7724ab72c8b/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteSerializeService.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#serialize(Data)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåºåˆ—åŒ–æ•°æ®ï¼Œç”Ÿæˆ Builder å¯¹è±¡ã€‚</p><h2 id="2-7-RemoteSerializeService"><a href="#2-7-RemoteSerializeService" class="headerlink" title="2.7 RemoteSerializeService"></a>2.7 RemoteSerializeService</h2><p><code>org.skywalking.apm.collector.remote.service.RemoteDeserializeService</code> ï¼Œè¿œç¨‹é€šä¿¡åºååˆ—åŒ–æœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/f70019926200139f9fe235ade9aaf7724ab72c8b/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteDeserializeService.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#deserialize(RemoteData, Data)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œååºåˆ—åŒ–ä¼ è¾“æ•°æ®ã€‚</p><h1 id="3-collector-remote-grpc-provider"><a href="#3-collector-remote-grpc-provider" class="headerlink" title="3. collector-remote-grpc-provider"></a>3. collector-remote-grpc-provider</h1><p><code>collector-remote-grpc-provider</code> ï¼ŒåŸºäº <a href="https://grpc.io/" rel="external nofollow noopener noreferrer" target="_blank">Google gRPC</a> çš„è¿œç¨‹é€šä¿¡å®ç°ã€‚</p><p>é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/06.png" alt=""></p><p><strong>é»˜è®¤é…ç½®</strong>ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-core/src/main/resources/application-default.yml#L14" rel="external nofollow noopener noreferrer" target="_blank"><code>application-default.yml</code></a> <strong>å·²ç»</strong>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">remote:</div><div class="line">  gRPC:</div><div class="line">    host: localhost</div><div class="line">    port: 11800</div></pre></td></tr></table></figure><h2 id="3-1-RemoteModuleGRPCProvider"><a href="#3-1-RemoteModuleGRPCProvider" class="headerlink" title="3.1 RemoteModuleGRPCProvider"></a>3.1 RemoteModuleGRPCProvider</h2><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.grpc.RemoteModuleGRPCProvider</code></a> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº gRPC çš„ç»„ä»¶æœåŠ¡æä¾›è€…å®ç°ç±»ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;gRPC&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º RemoteModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L81" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸º <code>cluster</code> ã€<code>gRPC_manager</code> ã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 53 è‡³ 56 è¡Œ ï¼šåˆ›å»º CommonRemoteDataRegisterService ã€GRPCRemoteSenderService å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation()</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>Server ç›¸å…³<ul><li>ç¬¬ 65 è¡Œï¼šåˆ›å»º gRPC Server å¯¹è±¡ã€‚ </li><li>ç¬¬ 67 è¡Œï¼šæ³¨å†Œ RemoteCommonServiceHandler å¯¹è±¡åˆ° gRPC Server ä¸Šï¼Œç”¨äºæ¥æ”¶ gRPC è¯·æ±‚åçš„å¤„ç†ã€‚</li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶ã€‹ã€Œ3. gRPC å®ç°ã€</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector gRPC Server Managerã€‹</a></li></ul></li><li>æ³¨å†Œå‘ç°ç›¸å…³<ul><li>ç¬¬ 70 è‡³ 71 è¡Œï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCRegistration.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.grpc.RemoteModuleGRPCRegistration</code></a> å¯¹è±¡ï¼Œå°†è‡ªå·±æ³¨å†Œåˆ°é›†ç¾¤ç®¡ç†ã€‚è¿™æ ·ï¼Œè‡ªå·±å¯ä»¥è¢« Collector é›†ç¾¤èŠ‚ç‚¹å‘ç°ï¼Œä»è€Œè¢«è°ƒç”¨ã€‚</li><li>ç¬¬ 73 è‡³ 74 è¡Œï¼šæ³¨å†Œ GRPCRemoteSenderService å¯¹è±¡åˆ°é›†ç¾¤ç®¡ç†ã€‚è¿™æ ·ï¼Œè‡ªå·±å¯ä»¥ç›‘å¬åˆ° Collector é›†ç¾¤èŠ‚ç‚¹çš„åŠ å…¥æˆ–ç¦»å¼€ï¼Œä»è€Œè°ƒç”¨ã€‚</li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†ã€‹</a> </li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L77" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ–¹æ³•ä¸ºç©ºã€‚</p><h2 id="3-2-GRPCRemoteSenderService"><a href="#3-2-GRPCRemoteSenderService" class="headerlink" title="3.2 GRPCRemoteSenderService"></a>3.2 GRPCRemoteSenderService</h2><p><code>org.skywalking.apm.collector.remote.grpc.service.GRPCRemoteSenderService</code> ï¼Œç»§æ‰¿ ClusterModuleListener æŠ½è±¡ç±»ï¼Œå®ç° RemoteSenderService æ¥å£ï¼ŒåŸºäº gPRC çš„è¿œç¨‹å‘é€æœåŠ¡å®ç°ç±»ã€‚</p><h3 id="3-2-1-æ³¨å†Œå‘ç°"><a href="#3-2-1-æ³¨å†Œå‘ç°" class="headerlink" title="3.2.1 æ³¨å†Œå‘ç°"></a>3.2.1 æ³¨å†Œå‘ç°</h3><p>é€šè¿‡ç»§æ‰¿ ClusterModuleListener æŠ½è±¡ç±»ï¼Œå®ç°äº†ç›‘å¬ Collector é›†ç¾¤èŠ‚ç‚¹çš„åŠ å…¥æˆ–ç¦»å¼€ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>remoteClients</code></a> å±æ€§ï¼Œè¿æ¥ Collector é›†ç¾¤èŠ‚ç‚¹çš„å®¢æˆ·ç«¯æ•°ç»„ã€‚æ¯ä¸ª Collector é›†ç¾¤èŠ‚ç‚¹ï¼Œå¯¹åº”ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L96" rel="external nofollow noopener noreferrer" target="_blank"><code>#path()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç›‘å¬çš„ç›®å½• <code>&quot;/&quot; + RemoteModule.NAME + &quot;/&quot; + RemoteModuleGRPCProvider.NAME</code> ã€‚Collector é›†ç¾¤ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ Remote Server éƒ½ä¼šæ³¨å†Œåˆ°è¯¥ç›®å½•ä¸‹ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L100" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverJoinNotify(serverAddress)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå½“æ–°çš„èŠ‚ç‚¹åŠ å…¥ï¼Œ<strong>åˆ›å»º</strong>æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverQuitNotify(serverAddress)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå½“è€çš„èŠ‚ç‚¹ç¦»å¼€ï¼Œ<strong>ç§»é™¤</strong>å¯¹åº”çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li></ul><h2 id="3-2-2-è´Ÿè½½å‡è¡¡"><a href="#3-2-2-è´Ÿè½½å‡è¡¡" class="headerlink" title="3.2.2 è´Ÿè½½å‡è¡¡"></a>3.2.2 è´Ÿè½½å‡è¡¡</h2><p>RemoteModuleGRPCProvider åŸºäºä¸åŒçš„é€‰æ‹©å™¨ ( <a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/Selector.java#L26" rel="external nofollow noopener noreferrer" target="_blank">Selector</a> ) ï¼Œæä¾›ä¸åŒçš„å®¢æˆ·ç«¯é€‰æ‹©( <a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/selector/RemoteClientSelector.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.grpc.service.selector.RemoteClientSelector</code></a> )å®ç° ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/07.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>hashCodeSelector</code></a> å±æ€§ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/selector/HashCodeSelector.java" rel="external nofollow noopener noreferrer" target="_blank">HashCodeSelector</a> ï¼ŒåŸºäºæ•°æ®çš„å“ˆå¸Œç ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>foreverFirstSelector</code></a> å±æ€§ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/selector/ForeverFirstSelector.java" rel="external nofollow noopener noreferrer" target="_blank">ForeverFirstSelector</a> ï¼ŒåŸºäºå®¢æˆ·ç«¯æ•°ç»„çš„é¡ºåºï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>rollingSelector</code></a> å±æ€§ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/selector/RollingSelector.java" rel="external nofollow noopener noreferrer" target="_blank">RollingSelector</a> ï¼ŒåŸºäºå®¢æˆ·ç«¯æ•°ç»„çš„é¡ºåºï¼Œé¡ºåºå‘ä¸‹é€‰æ‹©ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>#send(graphId, nodeId, data, selector)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 63 ã€66 ã€69 è¡Œï¼šæ ¹æ®é€‰æ‹©å™¨ï¼Œè°ƒç”¨ <code>RemoteClientSelector#select(clients, data)</code> æ–¹æ³•ï¼Œé€‰æ‹©å®¢æˆ·ç«¯ã€‚</li><li>ç¬¬ 64 ã€67 ã€70 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSenderService.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToRemoteWhenNotSelf(remoteClient, graphId, nodeId, data)</code></a> æ–¹æ³•ï¼Œå‘é€è¯·æ±‚æ•°æ®ã€‚<ul><li>ç¬¬ 76 è‡³ 77 è¡Œï¼šå½“é€‰æ‹©çš„å®¢æˆ·ç«¯è¿æ¥çš„æ˜¯æœ¬åœ°æ—¶ï¼Œä¸å‘é€æ•°æ®ï¼Œäº¤ç»™æœ¬åœ°å¤„ç†ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/5e2eb23f33136c979e5056dbe32e880b130d0901/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/RemoteWorkerRef.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteWorkerRef#in(message)</code></a> æ–¹æ³•ã€‚</li><li>ç¬¬ 78 è‡³ 81 è¡Œï¼šå½“é€‰æ‹©çš„å®¢æˆ·ç«¯è¿æ¥çš„æ˜¯è¿œç¨‹æ—¶ï¼Œè°ƒç”¨ <code>RemoteClient#push(graphId, nodeId, data)</code> æ–¹æ³•ï¼Œå‘é€æ•°æ®ã€‚</li></ul></li></ul></li></ul><h2 id="3-3-GRPCRemoteClientService"><a href="#3-3-GRPCRemoteClientService" class="headerlink" title="3.3 GRPCRemoteClientService"></a>3.3 GRPCRemoteClientService</h2><p><code>org.skywalking.apm.collector.remote.grpc.service.GRPCRemoteClientService</code> ï¼Œå®ç° RemoteClientService <strong>æ¥å£</strong>ï¼ŒåŸºäº gRPC çš„è¿œç¨‹å®¢æˆ·ç«¯æœåŠ¡å®ç°ç±»ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/0a289e159f472983a0b6f6df6bd62c675e4f0846/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClientService.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(host, port, channelSize, bufferSize)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º GRPCRemoteClient å¯¹è±¡ã€‚</p><h2 id="3-4-GRPCRemoteClient"><a href="#3-4-GRPCRemoteClient" class="headerlink" title="3.4 GRPCRemoteClient"></a>3.4 GRPCRemoteClient</h2><blockquote><p>å‹æƒ…æç¤ºï¼šæœ¬å°èŠ‚ä¼šæ¶‰åŠè¾ƒå¤š gRPC ç›¸å…³çš„çŸ¥è¯†ï¼Œå»ºè®®ä¸ç†Ÿæ‚‰çš„èƒ–å‹è‡ªå·± Google ï¼Œè¡¥å……ä¸‹å§¿åŠ¿ã€‚</p></blockquote><p><code>org.skywalking.apm.collector.remote.grpc.service.GRPCRemoteClient</code> ï¼Œå®ç° RemoteClient <strong>æ¥å£</strong>ï¼ŒåŸºäº gRPC çš„è¿œç¨‹å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/4cb80651dee25e985f974d691467a0a53d7dfbe9/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>client</code></a> å±æ€§ï¼ŒGRPCClient å¯¹è±¡ã€‚ç›¸æ¯”æ¥è¯´ï¼ŒGRPCRemoteClient åä¸šåŠ¡çš„å°è£…ï¼Œå†…éƒ¨è°ƒç”¨ GRPCClient å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/4cb80651dee25e985f974d691467a0a53d7dfbe9/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>carrier</code></a> å±æ€§ï¼ŒDataCarrier å¯¹è±¡ï¼Œæœ¬åœ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚GRPCRemoteClient åœ¨è¢«è°ƒç”¨å‘é€æ•°æ®æ—¶ï¼Œå…ˆæäº¤åˆ°æœ¬åœ°é˜Ÿåˆ—ï¼Œå¼‚æ­¥æ¶ˆè´¹è¿›è¡Œå‘é€åˆ°è¿œç¨‹ Collector èŠ‚ç‚¹ã€‚DataCarrier åœ¨ <a href="http://www.iocoder.cn/SkyWalking/data-carrier/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” DataCarrier å¼‚æ­¥å¤„ç†åº“ã€‹</a> è¯¦ç»†è§£æã€‚<ul><li>ç¬¬ 63 è¡Œï¼šè°ƒç”¨ <code>DataCarrier#consume(IConsumer, num)</code> æ–¹æ³•ï¼Œè®¾ç½®æ¶ˆè´¹è€…ä¸º RemoteMessageConsumer å¯¹è±¡ã€‚</li></ul></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/4cb80651dee25e985f974d691467a0a53d7dfbe9/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#push(graphId, nodeId, data)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œ<strong>å¼‚æ­¥</strong>å‘é€æ¶ˆæ¯åˆ°è¿œç¨‹ Collector ã€‚</p><ul><li>ç¬¬ 73 è¡Œï¼šè°ƒç”¨ <code>RemoteDataIDGetter#getRemoteDataId(Class&lt;? extends Data&gt;)</code> æ–¹æ³•ï¼Œè·å¾—<strong>æ•°æ®åè®®ç¼–å·</strong>ã€‚</li><li>ç¬¬ 76 è‡³ 80 è¡Œï¼šåˆ›å»ºä¼ è¾“æ•°æ®( RemoteMessage.Builder ) å¯¹è±¡ã€‚RemoteMessage é€šè¿‡ <a href="https://github.com/google/protobuf" rel="external nofollow noopener noreferrer" target="_blank">Protobuf</a> åˆ›å»ºå®šä¹‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/08.png" alt=""></li><li>ç¬¬ 83 è¡Œï¼šè°ƒç”¨ <code>DataCarrier#produce(data)</code> æ–¹æ³•ï¼Œå‘é€æ•°æ®åˆ°æœ¬åœ°é˜Ÿåˆ—ã€‚ </li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/4cb80651dee25e985f974d691467a0a53d7dfbe9/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L93" rel="external nofollow noopener noreferrer" target="_blank">RemoteMessageConsumer</a> ï¼Œ<strong>æ‰¹é‡</strong>æ¶ˆè´¹æœ¬åœ°é˜Ÿåˆ—çš„æ•°æ®ï¼Œé€æ¡å‘é€æ•°æ®åˆ°è¿œç¨‹ Collector èŠ‚ç‚¹ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/4cb80651dee25e985f974d691467a0a53d7dfbe9/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L98" rel="external nofollow noopener noreferrer" target="_blank"><code>#consume(List&lt;RemoteMessage&gt;)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 100 è¡Œï¼šåˆ›å»º <a href="https://github.com/YunaiV/skywalking/blob/4cb80651dee25e985f974d691467a0a53d7dfbe9/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteClient.java#L118" rel="external nofollow noopener noreferrer" target="_blank">StreamObserver</a> å¯¹è±¡ã€‚StreamObserver ä¸»è¦æ˜¯ gPRC ç›¸å…³çš„ API çš„è°ƒç”¨ã€‚</li><li>ç¬¬ 101 è‡³ 103 è¡Œï¼šè°ƒç”¨ <code>io.grpc.stub.StreamObserver#onNext(RemoteMessage)</code> æ–¹æ³•ï¼Œé€æ¡å‘é€æ•°æ®ã€‚</li><li>ç¬¬ 106 è¡Œï¼šè°ƒç”¨ <code>io.grpc.stub.StreamObserver#onCompleted()</code> æ–¹æ³•ï¼Œå…¨éƒ¨è¯·æ±‚æ•°æ®å‘é€<strong>å®Œæˆ</strong>ã€‚</li></ul></li></ul><h2 id="3-5-RemoteCommonServiceHandler"><a href="#3-5-RemoteCommonServiceHandler" class="headerlink" title="3.5 RemoteCommonServiceHandler"></a>3.5 RemoteCommonServiceHandler</h2><p><code>org.skywalking.apm.collector.remote.grpc.handler.RemoteCommonServiceHandler</code> ï¼Œå®ç° <code>org.skywalking.apm.collector.server.grpc.GRPCHandler</code> æ¥å£ï¼Œç»§æ‰¿ RemoteCommonServiceGrpc.RemoteCommonServiceImplBase <strong>æŠ½è±¡ç±»</strong>ï¼Œè¿œç¨‹é€šä¿¡é€šç”¨é€»è¾‘å¤„ç†å™¨ã€‚</p><p>å…¶ä¸­ï¼ŒRemoteCommonServiceGrpc.RemoteCommonServiceImplBase åœ¨ <code>RemoteCommonService.proto</code> æ–‡ä»¶çš„å®šä¹‰å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/09.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/ece7d2e156d4434edcc6ef08a5ed79e2a7b39fa1/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/handler/RemoteCommonServiceHandler.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#call(StreamObserver&lt;Empty&gt;)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ece7d2e156d4434edcc6ef08a5ed79e2a7b39fa1/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/handler/RemoteCommonServiceHandler.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#onNext(RemoteMessage)</code></a> æ–¹æ³•ï¼Œå¤„ç†æ¯ä¸€æ¡æ¶ˆæ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li>ç¬¬ 65 è¡Œï¼šè°ƒç”¨ <code>RemoteDataInstanceCreatorGetter#getInstanceCreator(remoteDataId)</code> æ–¹æ³•ï¼Œè·å¾—<strong>æ•°æ®åè®®ç¼–å·</strong>å¯¹åº”çš„ RemoteDataInstanceCreator å¯¹è±¡ã€‚ç„¶åï¼Œè°ƒç”¨ <code>RemoteDataInstanceCreator#createInstance(id)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ•°æ®åè®®ç¼–å·</strong>å¯¹åº”çš„ Data å®ç°ç±»å¯¹åº”çš„å¯¹è±¡ã€‚</li><li>ç¬¬ 70 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ece7d2e156d4434edcc6ef08a5ed79e2a7b39fa1/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/GraphManager.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>GraphManager#findGraph(graphId)</code></a> æ–¹æ³•ï¼Œè·å¾— <code>graphId</code> å¯¹åº”çš„ Graph å¯¹è±¡ã€‚ç„¶åï¼Œè°ƒåŠ¨ <a href="https://github.com/YunaiV/skywalking/blob/ece7d2e156d4434edcc6ef08a5ed79e2a7b39fa1/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/GraphNodeFinder.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>GraphNodeFinder#findNext(nodeId)</code></a> æ–¹æ³•ï¼Œè·å¾— Next å¯¹è±¡ã€‚</li><li>ç¬¬ 71 è¡Œï¼šè°ƒç”¨ <code>Next#execute(Data)</code> æ–¹æ³•ï¼Œç»§ç»­æµå¼å¤„ç†ã€‚</li></ul></li></ul><h2 id="3-6-GRPCRemoteSerializeService"><a href="#3-6-GRPCRemoteSerializeService" class="headerlink" title="3.6 GRPCRemoteSerializeService"></a>3.6 GRPCRemoteSerializeService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ece7d2e156d4434edcc6ef08a5ed79e2a7b39fa1/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteSerializeService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.grpc.service.GRPCRemoteSerializeService</code></a> ï¼Œå®ç° RemoteSerializeService æ¥å£ï¼ŒåŸºäº gRPC çš„è¿œç¨‹é€šä¿¡åºåˆ—åŒ–æœåŠ¡å®ç°ç±»ã€‚</p><h2 id="3-7-GRPCRemoteDeserializeService"><a href="#3-7-GRPCRemoteDeserializeService" class="headerlink" title="3.7 GRPCRemoteDeserializeService"></a>3.7 GRPCRemoteDeserializeService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ece7d2e156d4434edcc6ef08a5ed79e2a7b39fa1/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/GRPCRemoteDeserializeService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.remote.grpc.service.GRPCRemoteDeserializeService</code></a> ï¼Œå®ç° GRPCRemoteDeserializeService æ¥å£ï¼ŒåŸºäº gRPC çš„è¿œç¨‹é€šä¿¡ååºåˆ—åŒ–æœåŠ¡å®ç°ç±»ã€‚</p><h1 id="4-collector-remote-grpc-provider"><a href="#4-collector-remote-grpc-provider" class="headerlink" title="4. collector-remote-grpc-provider"></a>4. collector-remote-grpc-provider</h1><p><code>collector-remote-kafka-provider</code> ï¼šåŸºäº Kafka çš„è¿œç¨‹é€šä¿¡å®ç°ã€‚</p><p><em>ç›®å‰æš‚æœªå®Œæˆ</em>ã€‚</p><p>TODO ã€4005ã€‘collector-remote-grpc-provider</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å†™çš„æœ‰ä¸¢ä¸¢çƒ¦èºï¼Œä¸æ¸…æ™°æˆ–è€…é”™è¯¯çš„åœ°æ–¹ï¼Œèƒ–å‹æœ›è§è°…ã€‚</p><p>æ¬¢è¿å¾®ä¿¡æˆ‘ä¸€èµ·äº¤æµã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_10/10.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/collector-remote-module/&quot;&gt;http://www.iocoder.cn/SkyWalking/collector-remote-module/&lt;/a
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Cache ç¼“å­˜ç»„ä»¶</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-cache-module/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-cache-module/</id>
    <published>2020-09-04T16:00:00.000Z</published>
    <updated>2017-12-24T03:14:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">http://www.iocoder.cn/SkyWalking/collector-cache-module/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">2. collector-cache-define</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">2.1 CacheModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">2.2 ApplicationCacheService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">2.3 InstanceCacheService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">2.4 ServiceNameCacheService</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">3. collector-cache-guava-provider</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">3.1 CacheModuleGuavaProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">3.2 ApplicationCacheGuavaService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">3.3 InstanceCacheGuavaService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">3.4 ServiceNameCacheGuavaService</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cache-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Cache Module</strong>ï¼Œç¼“å­˜ç»„ä»¶ã€‚è¯¥ç»„ä»¶ç”¨äºç¼“å­˜ Application ã€Instance ã€ServiceName ç­‰<strong>å¸¸ç”¨</strong>ä¸”<strong>ä¸å˜</strong>çš„æ•°æ®ï¼Œä»¥æå‡æ€§èƒ½ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šæœ¬æ–‡å†…å®¹è¾ƒä¸ºç®€å•ï¼Œèƒ–å‹å¯å¿«é€Ÿé˜…è¯»ã€‚</p></blockquote><p>Cache Module åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM <a href="https://github.com/apache/incubating-skywalking" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubating-skywalking</a><br><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_05/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_05/02.png" alt=""></p><ul><li><code>collector-cache-define</code> ï¼šå®šä¹‰ç¼“å­˜ç»„ä»¶æ¥å£ã€‚</li><li><code>collector-cache-guava-provider</code> ï¼šåŸºäº <a href="https://github.com/google/guava" rel="external nofollow noopener noreferrer" target="_blank">Google Guava</a> çš„ç¼“å­˜ç»„ä»¶å®ç°ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1 id="2-collector-cache-define"><a href="#2-collector-cache-define" class="headerlink" title="2. collector-cache-define"></a>2. collector-cache-define</h1><p><code>collector-cache-define</code> ï¼šå®šä¹‰é˜Ÿåˆ—ç»„ä»¶æ¥å£ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_05/03.png" alt=""></p><h2 id="2-1-CacheModule"><a href="#2-1-CacheModule" class="headerlink" title="2.1 CacheModule"></a>2.1 CacheModule</h2><p><code>org.skywalking.apm.collector.cache.CacheModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼Œç¼“å­˜ Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-define/src/main/java/org/skywalking/apm/collector/cache/CacheModule.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;cache&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-define/src/main/java/org/skywalking/apm/collector/cache/CacheModule.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šApplicationCacheService ã€InstanceCacheService ã€ServiceIdCacheService ã€ServiceNameCacheService ã€‚</p><h2 id="2-2-ApplicationCacheService"><a href="#2-2-ApplicationCacheService" class="headerlink" title="2.2 ApplicationCacheService"></a>2.2 ApplicationCacheService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-define/src/main/java/org/skywalking/apm/collector/cache/service/ApplicationCacheService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.service.ApplicationCacheService</code></a> ï¼Œåº”ç”¨æ•°æ®ç¼“å­˜æœåŠ¡<strong>æ¥å£</strong>ã€‚</p><ul><li>Table ï¼š<a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/ApplicationTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.ApplicationTable</code></a></li><li>Data ï¼š<a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/Application.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.Application</code></a></li></ul><h2 id="2-3-InstanceCacheService"><a href="#2-3-InstanceCacheService" class="headerlink" title="2.3 InstanceCacheService"></a>2.3 InstanceCacheService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/a1667a9ecf4eecf77cc2390f0af709c3b1bb7e4b/apm-collector/apm-collector-cache/collector-cache-define/src/main/java/org/skywalking/apm/collector/cache/service/InstanceCacheService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.service.InstanceCacheService</code></a> ï¼Œåº”ç”¨å®ä¾‹æ•°æ®ç¼“å­˜æœåŠ¡<strong>æ¥å£</strong>ã€‚</p><ul><li>Table ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a1667a9ecf4eecf77cc2390f0af709c3b1bb7e4b/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/InstanceTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.InstanceTable</code></a></li><li>Data ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a1667a9ecf4eecf77cc2390f0af709c3b1bb7e4b/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/Instance.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.Instance</code></a></li></ul><h2 id="2-4-ServiceNameCacheService"><a href="#2-4-ServiceNameCacheService" class="headerlink" title="2.4 ServiceNameCacheService"></a>2.4 ServiceNameCacheService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-cache/collector-cache-define/src/main/java/org/skywalking/apm/collector/cache/service/ServiceNameCacheService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.service.ServiceNameCacheService</code></a> ï¼ŒæœåŠ¡åæ•°æ®ç¼“å­˜æœåŠ¡<strong>æ¥å£</strong>ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-cache/collector-cache-define/src/main/java/org/skywalking/apm/collector/cache/service/ServiceIdCacheService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.service.ServiceIdCacheService</code></a> ï¼ŒæœåŠ¡ç¼–å·æ•°æ®ç¼“å­˜æœåŠ¡<strong>æ¥å£</strong>ã€‚</p><ul><li>Table ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/ServiceNameTable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.ServiceNameTable</code></a></li><li>Data ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-storage/collector-storage-define/src/main/java/org/skywalking/apm/collector/storage/table/register/ServiceName.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.table.register.ServiceName</code></a></li></ul><h1 id="3-collector-cache-guava-provider"><a href="#3-collector-cache-guava-provider" class="headerlink" title="3. collector-cache-guava-provider"></a>3. collector-cache-guava-provider</h1><p><code>collector-cache-guava-provider</code> ï¼ŒåŸºäº <a href="https://github.com/google/guava" rel="external nofollow noopener noreferrer" target="_blank">Google Guava</a> çš„ç¼“å­˜ç»„ä»¶å®ç°ã€‚</p><p>é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_05/04.png" alt=""></p><p><strong>é»˜è®¤é…ç½®</strong>ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-core/src/main/resources/application-default.yml#L5" rel="external nofollow noopener noreferrer" target="_blank"><code>application-default.yml</code></a> <strong>å·²ç»</strong>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">cache:</div><div class="line">  guava:</div></pre></td></tr></table></figure><h2 id="3-1-CacheModuleGuavaProvider"><a href="#3-1-CacheModuleGuavaProvider" class="headerlink" title="3.1 CacheModuleGuavaProvider"></a>3.1 CacheModuleGuavaProvider</h2><p><code>org.skywalking.apm.collector.cache.guava.CacheModuleGuavaProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº Guava çš„ç¼“å­˜ç»„ä»¶æœåŠ¡æä¾›è€…ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/CacheModuleGuavaProvider.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;guava&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/CacheModuleGuavaProvider.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º CacheModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/CacheModuleGuavaProvider.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸ºç©ºã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/CacheModuleGuavaProvider.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 44 è¡Œ ï¼šåˆ›å»º ApplicationCacheGuavaService ã€InstanceCacheGuavaService ã€ServiceIdCacheGuavaService ã€ServiceNameCacheGuavaService å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation()</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/CacheModuleGuavaProvider.java#L59" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ–¹æ³•ä¸ºç©ºã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/CacheModuleGuavaProvider.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ–¹æ³•ä¸ºç©ºã€‚</p><h2 id="3-2-ApplicationCacheGuavaService"><a href="#3-2-ApplicationCacheGuavaService" class="headerlink" title="3.2 ApplicationCacheGuavaService"></a>3.2 ApplicationCacheGuavaService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/service/ApplicationCacheGuavaService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.guava.service.ApplicationCacheGuavaService</code></a> ï¼Œå®ç° ApplicationCacheService æ¥å£ï¼ŒåŸºäº Guava çš„åº”ç”¨æ•°æ®ç¼“å­˜æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><ul><li>EsDAO ï¼š<a href="https://github.com/YunaiV/skywalking/blob/ed68f92bf1f5ac397c0bb0a5cc23fa4f3e3c32d1/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ApplicationEsCacheDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.ApplicationEsCacheDAO</code></a></li></ul><h2 id="3-3-InstanceCacheGuavaService"><a href="#3-3-InstanceCacheGuavaService" class="headerlink" title="3.3 InstanceCacheGuavaService"></a>3.3 InstanceCacheGuavaService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/a1667a9ecf4eecf77cc2390f0af709c3b1bb7e4b/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/service/InstanceCacheGuavaService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.guava.service.InstanceCacheGuavaService</code></a> ï¼Œå®ç° InstanceCacheService æ¥å£ï¼ŒåŸºäº Guava çš„åº”ç”¨å®ä¾‹æ•°æ®ç¼“å­˜æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><ul><li>EsDAO ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a1667a9ecf4eecf77cc2390f0af709c3b1bb7e4b/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/InstanceEsCacheDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.InstanceEsCacheDAO</code></a></li></ul><h2 id="3-4-ServiceNameCacheGuavaService"><a href="#3-4-ServiceNameCacheGuavaService" class="headerlink" title="3.4 ServiceNameCacheGuavaService"></a>3.4 ServiceNameCacheGuavaService</h2><p><a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/service/ServiceIdCacheGuavaService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.guava.service.ServiceNameCacheGuavaService</code></a> ï¼Œå®ç° ServiceNameCacheService æ¥å£ï¼ŒåŸºäº Guava çš„æœåŠ¡åæ•°æ®ç¼“å­˜æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-cache/collector-cache-guava-provider/src/main/java/org/skywalking/apm/collector/cache/guava/service/ServiceNameCacheGuavaService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.cache.guava.service.ServiceIdCacheGuavaService</code></a> ï¼Œå®ç° ServiceNameCacheService æ¥å£ï¼ŒåŸºäº Guava çš„æœåŠ¡ç¼–å·æ•°æ®ç¼“å­˜æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><ul><li>EsDAO ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a859f4751203d73f10f30bb7c9cf2adfdecf955c/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/dao/ServiceNameEsCacheDAO.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.storage.es.dao.ServiceNameEsCacheDAO</code></a></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>çœŸçš„æ˜¯ä¸€ç¯‡æ°´æ–‡ï¼Œéƒ½å†™çš„æ— ä»ä¸‹æ‰‹ï¼Œåªå¥½ç½—åˆ—äº†ç›¸å…³çš„ç±»ã€‚è§è°…ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_05/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/collector-cache-module/&quot;&gt;http://www.iocoder.cn/SkyWalking/collector-cache-module/&lt;/a&gt; 
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-streaming-second/</id>
    <published>2020-08-31T16:00:00.000Z</published>
    <updated>2017-12-23T23:23:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">http://www.iocoder.cn/SkyWalking/collector-streaming-second/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">2. Data</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">2.1 Collection</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">2.2 DataCollection</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">2.3 Window</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">2.4 DataCache</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">3. AggregationWorker</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">4. PersistenceWorker</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">4.1 WorkerCreateListener</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">4.2 PersistenceTimer</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹</a> ï¼Œä¸»è¦åˆ†äº« <strong>Collector Streaming æµå¼å¤„ç†çš„ç¬¬äºŒéƒ¨åˆ†</strong>ã€‚ä¸»è¦åŒ…å«å¦‚ä¸‹éƒ¨åˆ†ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_01/01.png" alt=""></p><ul><li>AggregationWorker ï¼šèšåˆå¤„ç†æ•°æ®ï¼Œåæäº¤ Data åˆ° Next èŠ‚ç‚¹ä»¬å¤„ç†ã€‚</li><li>PersistenceWorker ï¼šèšåˆå¤„ç†æ•°æ®ï¼Œåå­˜å‚¨ Data ã€‚</li></ul><h1 id="2-Data"><a href="#2-Data" class="headerlink" title="2. Data"></a>2. Data</h1><p>AggregationWorker å’Œ PersistenceWorker ï¼Œéƒ½å…ˆ<strong>èšåˆ</strong>å¤„ç†æ•°æ®ï¼Œåœ¨è¿›è¡Œå„è‡ªçš„åç»­å¤„ç†ã€‚é‚£ä¹ˆèšåˆå¤„ç†çš„æ•°æ®ç»“æœï¼Œéœ€è¦æœ‰<strong>å®¹å™¨</strong>è¿›è¡Œç¼“å­˜æš‚å­˜ï¼š</p><ul><li><code>org.skywalking.apm.collector.core.cache</code> ï¼šæ¥å£</li><li><code>org.skywalking.apm.collector.stream.worker.impl.data</code> ï¼šå®ç°</li></ul><p>ç±»å›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_09_01/02.png" alt=""></p><ul><li>Collection ï¼šæ•°æ®é‡‡é›†ï¼Œæä¾›æœ‰è¯»ã€å†™<strong>ä¸¤ä¸ªçŠ¶æ€</strong>çš„æ•°æ®å®¹å™¨ã€‚</li><li>Window ï¼šçª—å£( ğŸ˜ˆè¿™ä¸ªè§£é‡Šæ€ªæ€ªçš„ )ï¼Œå†…æœ‰<strong>ä¸¤ä¸ª Collection</strong>ã€‚<ul><li>ä¸€ä¸ª Collection ï¼Œè´Ÿè´£å†™å…¥<strong>æ•°æ®</strong>æ•°æ®</li><li>ä¸€ä¸ª Collection ï¼Œè´Ÿè´£è¯»å‡º<strong>å¤„ç†</strong>æ•°æ®</li><li>å½“å†™çš„ Collection <strong>ç¬¦åˆå¤„ç†çš„æ¡ä»¶</strong>ï¼Œè¯»å†™ Collection åˆ‡æ¢</li></ul></li></ul><h2 id="2-1-Collection"><a href="#2-1-Collection" class="headerlink" title="2.1 Collection"></a>2.1 Collection</h2><p><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Collection.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.cache.Collection</code></a> ï¼Œæ•°æ®é‡‡é›†<strong>æ¥å£</strong>ã€‚</p><ul><li>æ•°æ®ç›¸å…³ ï¼š<code>#collection()</code> / <code>#size()</code> / <code>#clear()</code></li><li>è¯»ç›¸å…³ ï¼š<code>#reading()</code> / <code>#isReading()</code> / <code>#finishReading()</code></li><li>å†™ç›¸å…³ ï¼š<code>#writing()</code> / <code>#isWriting()</code> / <code>#finishWriting()</code></li></ul><h2 id="2-2-DataCollection"><a href="#2-2-DataCollection" class="headerlink" title="2.2 DataCollection"></a>2.2 DataCollection</h2><p><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCollection.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.impl.data.DataCollection</code></a> ï¼Œå®ç° Collection æ¥å£ï¼Œæ•°æ®é‡‡é›†å®ç°ç±»ï¼Œä½¿ç”¨ <a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCollection.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>Map&lt;String, Data&gt;</code></a> ä½œä¸ºæ•°æ®å®¹å™¨ã€‚</p><h2 id="2-3-Window"><a href="#2-3-Window" class="headerlink" title="2.3 Window"></a>2.3 Window</h2><p><code>org.skywalking.apm.collector.core.cache.Window</code> ï¼Œçª—å£<strong>æŠ½è±¡ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L50" rel="external nofollow noopener noreferrer" target="_blank">æ„é€ æ–¹æ³•</a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>windowDataA</code></a> å±æ€§ï¼Œçª—å£æ•°æ®A ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>windowDataB</code></a> å±æ€§ï¼Œçª—å£æ•°æ®B ã€‚</li><li>é€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#collectionInstance()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ›å»ºçª—å£æ•°æ®( Collection )å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>pointer</code></a> å±æ€§ï¼Œæ•°æ®æŒ‡å‘ <code>windowDataA</code> æˆ– <code>windowDataA</code>ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L111" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCurrent()</code></a> æ–¹æ³•ï¼Œè·å¾—<strong>ç°</strong>æ•°æ®æŒ‡å‘ï¼Œå³ <code>pointer</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>#getLast()</code></a> æ–¹æ³•ï¼Œè·å¾—<strong>åŸ</strong>æ•°æ®æŒ‡å‘ï¼Œå³<strong>é</strong> <code>pointer</code> ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>windowSwitch</code></a> å±æ€§ï¼Œçª—å£åˆ‡æ¢è®¡æ•°ã€‚</li></ul><hr><p><strong>åˆ‡æ¢ Collection ç›¸å…³</strong>ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#trySwitchPointer()</code></a> æ–¹æ³•ï¼Œè¿”å›æ˜¯å¦å¯ä»¥åˆ‡æ¢ Collection ã€‚å¯ä»¥åˆ‡æ¢éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š<ul><li>åªæœ‰<strong>ä¸€ä¸ªè°ƒç”¨æ–¹</strong>ç”³è¯·åˆ‡æ¢ï¼Œé€šè¿‡ <code>windowSwitch</code> å±æ€§è¿›è¡Œè®¡æ•°ã€‚</li><li><strong>åŸ</strong>æ•°æ®æŒ‡å‘<strong>ä¸å¤„äºæ­£åœ¨è¯»å–çŠ¶æ€</strong>ã€‚å¦‚æœåˆ‡æ¢ï¼Œä¸€è¾¹è¯»ä¸€è¾¹å†™ï¼Œå¯èƒ½ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</li><li>æ— è®ºæ˜¯å¦å¯ä»¥åˆ‡æ¢ Collection ï¼Œéœ€è¦è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#trySwitchPointerFinally()</code></a> æ–¹æ³•ï¼Œ<strong>é‡Šæ”¾</strong> <code>windowSwitch</code> çš„è®¡æ•°ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L82" rel="external nofollow noopener noreferrer" target="_blank"><code>#switchPointer()</code></a> æ–¹æ³•ï¼Œåˆ‡æ¢æ•°æ®æŒ‡å‘ï¼Œå¹¶æ ‡è®°<strong>åŸ</strong>æ•°æ®æŒ‡å‘çš„ Collection <strong>æ­£åœ¨è¯»å–ä¸­</strong>ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L129" rel="external nofollow noopener noreferrer" target="_blank"><code>#finishReadingLast()</code></a> æ–¹æ³•ï¼Œæ¸…ç©º<strong>åŸ</strong>æ•°æ®æŒ‡å‘çš„ Collection æ•°æ®ï¼Œå¹¶æ ‡è®°<strong>åŸ</strong>æ•°æ®æŒ‡å‘çš„ Collection <strong>å®Œæˆè¯»å–</strong>( <strong>ä¸åœ¨æ­£åœ¨è¯»å–ä¸­</strong> )ã€‚</li></ul><hr><p><strong>å†™ Collection ç›¸å…³</strong>ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/d6019b49d686f79d07528a19b09d4f0ccc4eca9b/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/cache/Window.java#L98" rel="external nofollow noopener noreferrer" target="_blank"><code>#getCurrentAndWriting()</code></a> æ–¹æ³•ï¼Œè·å¾—<strong>ç°</strong>æ•°æ®æŒ‡å‘ï¼Œå¹¶æ ‡è®°<strong>æ­£åœ¨å†™å…¥ä¸­</strong>ã€‚é€šè¿‡<strong>æ­£åœ¨å†™å…¥</strong>æ ‡è®°ï¼Œåˆ‡æ¢ Collection å®Œæˆåï¼Œå¯ä»¥åˆ¤æ–­è¯¥ Collection æ­£åœ¨å†™å…¥ä¸­ï¼Œ<strong>è‹¥æ˜¯ï¼Œç­‰å¾…ä¸åœ¨å†™å…¥ä¸­ï¼Œå¼€å§‹æ•°æ®è¯»å–å¹¶å¤„ç†</strong>ã€‚</li></ul><h2 id="2-4-DataCache"><a href="#2-4-DataCache" class="headerlink" title="2.4 DataCache"></a>2.4 DataCache</h2><p><code>org.skywalking.apm.collector.stream.worker.impl.data.DataCache</code> ï¼Œå®ç° Window æŠ½è±¡ç±»ï¼Œæ•°æ®ç¼“å­˜ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#collectionInstance()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º DataCollection å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L82" rel="external nofollow noopener noreferrer" target="_blank"><code>#currentCollectionSize()</code></a> æ–¹æ³•ï¼Œè·å¾—å½“å‰æ•°æ®æŒ‡å‘( å†™å…¥ Collection )çš„æ•°æ®æ•°é‡ã€‚</li></ul><hr><p><strong>å†™ Collection ç›¸å…³</strong>ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L73" rel="external nofollow noopener noreferrer" target="_blank"><code>#writing()</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>#getCurrentAndWriting()</code> æ–¹æ³•ï¼Œå¼€å§‹å†™å…¥ã€‚å³ï¼Œè·å¾—<strong>ç°</strong>æ•°æ®æŒ‡å‘ï¼Œå¹¶æ ‡è®°<strong>æ­£åœ¨å†™å…¥ä¸­</strong>ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>lockedDataCollection</code></a> å±æ€§ï¼Œå†™å…¥çš„çª—å£æ•°æ®ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#put(id, data)</code></a> æ–¹æ³•ï¼Œå‘ <code>lockedDataCollection</code> å±æ€§ï¼Œå†™å…¥ Data ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#get(id)</code></a> æ–¹æ³•ï¼Œå‘ <code>lockedDataCollection</code> å±æ€§ï¼Œæ ¹æ® ID è·å¾— Data ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#containsKey(id)</code></a> æ–¹æ³•ï¼Œå‘ <code>lockedDataCollection</code> å±æ€§ï¼Œæ ¹æ® ID åˆ¤æ–­ Data æ˜¯å¦å­˜åœ¨ ã€‚</li></ul></li><li><a href="https://github.com/YunaiV/skywalking/blob/e6e1a7899e7b0e674a61f323447d4b66cffa8136/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/data/DataCache.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#finishWriting()</code></a> æ–¹æ³•ï¼Œå®Œæˆå†™å…¥ã€‚å³ï¼Œæ ‡è®° <code>lockedDataCollection</code> <strong>ä¸åœ¨æ­£åœ¨å†™å…¥ä¸­</strong>ã€‚</li></ul><h1 id="3-AggregationWorker"><a href="#3-AggregationWorker" class="headerlink" title="3. AggregationWorker"></a>3. AggregationWorker</h1><p><code>org.skywalking.apm.collector.stream.worker.impl.AggregationWorker</code> ï¼Œå®ç° AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼Œ<strong>å¼‚æ­¥èšåˆ</strong> Workerï¼Œè´Ÿè´£èšåˆå¤„ç†æ•°æ®ï¼Œåæäº¤ Data åˆ° Next èŠ‚ç‚¹ä»¬å¤„ç†ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L41" rel="external nofollow noopener noreferrer" target="_blank"><code>dataCache</code></a> å±æ€§ï¼Œæ•°æ®ç¼“å­˜ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>messageNum</code></a> å±æ€§ï¼Œæ¶ˆæ¯è®¡æ•°ã€‚å½“è¶…è¿‡ä¸€å®šæ•°é‡( ç›®å‰æ˜¯ 100 )ï¼Œé‡ç½®è®¡æ•°å½’é›¶ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork(message)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œèšåˆå¤„ç†æ•°æ®ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶ï¼Œæäº¤ Data åˆ° Next èŠ‚ç‚¹ä»¬å¤„ç†ã€‚</p><ul><li>ç¬¬ 53 è¡Œï¼š<code>messageNum</code> è®¡æ•°å¢åŠ ã€‚</li><li>ç¬¬ 56 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L97" rel="external nofollow noopener noreferrer" target="_blank"><code>#aggregate(message)</code></a> æ–¹æ³•ï¼Œèšåˆæ¶ˆæ¯åˆ°æ•°æ®ã€‚</li><li>ç¬¬ 59 è‡³ 62 è¡Œï¼š<code>messageNum &gt;= 100</code> æ—¶ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToNext()</code></a> ï¼Œæäº¤ç¼“å­˜æ•°æ®çš„<strong>è¯» Collection çš„æ•°æ®</strong>ç»™ Next èŠ‚ç‚¹ä»¬ç»§ç»­å¤„ç†ã€‚</li><li>ç¬¬ 65 è‡³ 67 è¡Œï¼š<code>messageNum.endOfBatch == true</code> æ—¶ï¼Œå½“æ¶ˆæ¯æ˜¯æ‰¹å¤„ç†çš„æœ€åä¸€æ¡æ—¶ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToNext()</code></a> ï¼Œæäº¤ç¼“å­˜æ•°æ®çš„<strong>è¯» Collection çš„æ•°æ®</strong>ç»™ Next èŠ‚ç‚¹ä»¬ç»§ç»­å¤„ç†ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#sendToNext()</code></a> æ–¹æ³•ï¼Œæäº¤ç¼“å­˜æ•°æ®çš„<strong>è¯» Collection çš„æ•°æ®</strong>ç»™ Next èŠ‚ç‚¹ä»¬ç»§ç»­å¤„ç†ã€‚</p><ul><li>ç¬¬ 72 è¡Œï¼š<strong>ç›´æ¥</strong>è°ƒç”¨ <code>Window#switchPointer()</code> æ–¹æ³•ï¼Œåˆ‡æ¢æ•°æ®æŒ‡é’ˆï¼Œå¹¶æ ‡è®°<strong>åŸ</strong>æŒ‡å‘æ­£åœ¨è¯»å–ä¸­ã€‚è¿™é‡Œå¹¶æœªå…ˆè°ƒç”¨ <code>Window#trySwitchPointer()</code> æ–¹æ³•ï¼Œ<strong>æ˜¯å¦ä¼šæœ‰å¹¶å‘é—®é¢˜</strong>ï¼Ÿç›®å‰è¿™é‡Œæ˜¯<strong>å¼‚æ­¥å•çº¿ç¨‹</strong>ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜ï¼Œå‚è§ <a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶ã€‹</a> ã€‚å¦å¤–ï¼Œåœ¨ <a href="#">ã€Œ4. PersistenceWorkerã€</a> ä¼šçœ‹åˆ°å¹¶å‘çš„æƒ…å†µå¤„ç†ã€‚</li><li>ç¬¬ 74 è‡³ 80 è¡Œï¼šç­‰å¾…<strong>åŸ</strong>æŒ‡å‘ä¸åœ¨è¯»å–ä¸­ã€‚</li><li>ç¬¬ 82 è‡³ 85 è¡Œï¼šæäº¤æ•°æ®ç»™ Next èŠ‚ç‚¹ä»¬ç»§ç»­å¤„ç†ã€‚</li><li>ç¬¬ 87 è¡Œï¼šæ ‡è®°<strong>åŸ</strong>æŒ‡å‘å®Œæˆè¯»å–ã€‚</li></ul><h1 id="4-PersistenceWorker"><a href="#4-PersistenceWorker" class="headerlink" title="4. PersistenceWorker"></a>4. PersistenceWorker</h1><p><code>org.skywalking.apm.collector.stream.worker.impl.PersistenceWorker</code> ï¼Œå®ç° AbstractLocalAsyncWorker æŠ½è±¡ç±»ï¼Œ<strong>å¼‚æ­¥æ‰¹é‡å­˜å‚¨</strong> Workerï¼Œè´Ÿè´£èšåˆå¤„ç†æ•°æ®ï¼Œåå­˜å‚¨ Data ã€‚</p><p>è€ƒè™‘åˆ°éœ€è¦ä¿è¯å­˜å‚¨çš„æ—¶æ•ˆæ€§ï¼ŒPersistenceWorker ä½¿ç”¨ PersistenceTimer ï¼Œå®šæ—¶å­˜å‚¨ Data ï¼Œåœ¨ <a href="#">ã€Œ4.2 PersistenceWorkerã€</a> è¯¦ç»†è§£æã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ccd030f6b449954fccc7be4e19c15290e8affc77/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/AggregationWorker.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>dataCache</code></a> å±æ€§ï¼Œæ•°æ®ç¼“å­˜ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>batchDAO</code></a> å±æ€§ï¼Œæ‰¹é‡æ“ä½œ DAO ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L186" rel="external nofollow noopener noreferrer" target="_blank"><code>#needMergeDBData()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå­˜å‚¨æ—¶ï¼Œæ˜¯å¦éœ€è¦åˆå¹¶æ•°æ®ã€‚ä¸€äº› Data åªæœ‰æ–°å¢æ“ä½œï¼Œæ²¡æœ‰æ›´æ–°æ“ä½œã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L181" rel="external nofollow noopener noreferrer" target="_blank"><code>#persistenceDAO()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— Data å¯¹åº”çš„æŒä¹…åŒ– DAO æ¥å£çš„<strong>å®ç°ç±»</strong>å¯¹è±¡ã€‚</p><p>ä¸Šè¿°ä¸¤ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œç”¨äº <a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L121" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepareBatch(dataMap)</code></a> æ–¹æ³•ï¼Œç”Ÿæˆæ‰¹é‡æ“ä½œå¯¹è±¡æ•°ç»„ï¼Œæœ€ç»ˆè°ƒç”¨ <code>IBatchDAO#batchPersistence(List&lt;?&gt;)</code> æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œæ‰¹é‡æ“ä½œå¯¹è±¡æ•°ç»„ï¼Œå®ç°æ‰¹é‡æŒä¹…åŒ–æ•°æ®ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-storage-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Storage å­˜å‚¨ç»„ä»¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork(message)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶å­˜å‚¨ Data ï¼Œè€Œåèšåˆæ•°æ®ã€‚è¿™ç‚¹å’Œ AggregationWorker ç›¸åçš„ï¼Œå› ä¸ºè¦è€ƒè™‘å¹¶å‘é—®é¢˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 72 è¡Œï¼šè°ƒç”¨ <code>DataCache#currentCollectionSize()</code> æ–¹æ³•ï¼Œè·å¾—å½“å‰å†™å…¥ Collection çš„æ•°æ®æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡ 5000 ã€‚<ul><li>ç¬¬ 75 è¡Œï¼šè°ƒç”¨ <code>DataCache#trySwitchPointer()</code> æ–¹æ³•ï¼Œ<strong>åˆ¤æ–­</strong>æ˜¯å¦å¯ä»¥åˆ‡æ¢ Collection ã€‚é€šè¿‡è¯¥åˆ¤æ–­ï¼Œä¿è¯å’Œ PersistenceTimer ä¸€èµ·æ—¶ï¼Œä¸ä¼šå‡ºç°<strong>å¹¶å‘é—®é¢˜</strong>ã€‚</li><li>ç¬¬ 77 è¡Œï¼šè°ƒç”¨ <code>Window#switchPointer()</code> æ–¹æ³•ï¼Œåˆ‡æ¢æ•°æ®æŒ‡é’ˆï¼Œå¹¶æ ‡è®°<strong>åŸ</strong>æŒ‡å‘æ­£åœ¨è¯»å–ä¸­ã€‚</li><li>ç¬¬ 80 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L100" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildBatchCollection()</code></a> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡æ“ä½œå¯¹è±¡æ•°ç»„ã€‚è¯¥æ–¹æ³•å’Œ <code>AggregationWorker#sendToNext()</code> æ–¹æ³•<strong>åŸºæœ¬ç±»ä¼¼</strong>ã€‚</li><li>ç¬¬ 83 è¡Œï¼šè°ƒç”¨ <code>IBatchDAO#batchPersistence(List&lt;?&gt;)</code> æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œæ‰¹é‡æ“ä½œå¯¹è±¡æ•°ç»„ï¼Œå®ç°æ‰¹é‡æŒä¹…åŒ–æ•°æ®ã€‚</li><li>ç¬¬ 86 è¡Œï¼šè°ƒç”¨ <code>DataCache#trySwitchPointerFinally()</code> æ–¹æ³•ï¼Œ<strong>é‡Šæ”¾</strong> <code>DataCache.windowSwitch</code> çš„è®¡æ•°ã€‚</li></ul></li><li>ç¬¬ 91 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L164" rel="external nofollow noopener noreferrer" target="_blank"><code>#aggregate(message)</code></a> æ–¹æ³•ï¼Œèšåˆæ•°æ®ã€‚è¯¥æ–¹æ³•å’Œ <code>AggregationWorker#aggregate(message)</code> æ–¹æ³•<strong>åŸºæœ¬ç›¸ä¼¼</strong>ã€‚</li></ul><h2 id="4-1-WorkerCreateListener"><a href="#4-1-WorkerCreateListener" class="headerlink" title="4.1 WorkerCreateListener"></a>4.1 WorkerCreateListener</h2><p><code>org.skywalking.apm.collector.stream.worker.base.WorkerCreateListener</code> ï¼ŒWorker åˆ›å»ºç›‘å¬å™¨ã€‚</p><p>Worker åœ¨åˆ›å»ºæ—¶ï¼Œä¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/WorkerCreateListener.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>WorkerCreateListener#addWorker</code></a> æ–¹æ³•ï¼Œè®°å½•æ‰€æœ‰çš„ PersistenceWorker å¯¹è±¡ã€‚</p><p><strong>è®°å½•ä¸‹æ¥æœ‰ä»€ä¹ˆç”¨å‘¢</strong>ï¼Ÿåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/bf563461e75b6717d7b4589d7c3f579acf305541/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/AgentStreamBootStartup.java#L47" rel="external nofollow noopener noreferrer" target="_blank">AgentStreamBootStartup</a> å¯åŠ¨æ—¶ï¼Œåˆ›å»º PersistenceTimer å¯¹è±¡ï¼Œå¹¶å°† WorkerCreateListener è®°å½•çš„ PersistenceWorker å¯¹è±¡é›†åˆ<strong>ä¼ é€’</strong>ç»™ PersistenceTimer å¯¹è±¡ã€‚è¿™æ ·ï¼ŒPersistenceTimer èƒ½å¤Ÿâ€<strong>è®¿é—®</strong>â€œåˆ° PersistenceWorker å¯¹è±¡ä»¬çš„ DataCache ï¼Œ<strong>å®šæ—¶</strong>å­˜å‚¨æ•°æ®ã€‚</p><h2 id="4-2-PersistenceTimer"><a href="#4-2-PersistenceTimer" class="headerlink" title="4.2 PersistenceTimer"></a>4.2 PersistenceTimer</h2><p><code>org.skywalking.apm.collector.stream.timer.PersistenceTimer</code> ï¼ŒæŒä¹…åŒ–å®šæ—¶ä»»åŠ¡ï¼Œè´Ÿè´£<strong>å®šæ—¶</strong>ã€<strong>æ‰¹é‡</strong>å­˜å‚¨ PersistenceWorker ç¼“å­˜çš„æ•°æ®ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ec95c9966b7e013c8a44ea2e0f748ad339363ce3/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/timer/PersistenceTimer.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#start(IBatchDAO, List&lt;PersistenceWorker&gt;)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºå»¶è¿Ÿ 1 ç§’ï¼Œæ¯ 1 ç§’æ‰§è¡Œä¸€æ¬¡ <code>#extractDataAndSave()</code> æ–¹æ³•çš„å®šæ—¶ä»»åŠ¡ï¼Œç”¨äº<strong>å®šæ—¶</strong>ã€<strong>æ‰¹é‡</strong>å­˜å‚¨ PersistenceWorker ç¼“å­˜çš„æ•°æ®ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ec95c9966b7e013c8a44ea2e0f748ad339363ce3/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/timer/PersistenceTimer.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#extractDataAndSave(IBatchDAO, List&lt;PersistenceWorker&gt;)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><p>ç¬¬ 55 è‡³ 68 è¡Œï¼šè·å¾—æ‰€æœ‰ PersistenceWorker è¯» Collection ç¼“å­˜çš„æ•°æ®ã€‚</p><ul><li>ç¬¬ 60 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ec95c9966b7e013c8a44ea2e0f748ad339363ce3/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>PersistenceWorker#flushAndSwitch()</code></a> åˆ‡æ¢æ•°æ®æŒ‡é’ˆï¼Œå³åˆ‡æ¢è¯»å†™ Collection ã€‚</li><li>ç¬¬ 62 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ec95c9966b7e013c8a44ea2e0f748ad339363ce3/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/impl/PersistenceWorker.java#L100" rel="external nofollow noopener noreferrer" target="_blank"><code>PersistenceWorker#buildBatchCollection()</code></a> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡æ“ä½œå¯¹è±¡æ•°ç»„ã€‚</li><li><strong>æ€ä¹ˆä¿è¯å¹¶å‘å®‰å…¨</strong>ï¼Ÿé€šè¿‡ <code>Window#trySwitchPointer()</code> æ–¹æ³•ï¼Œä¿è¯è¯» Collection <strong>æ­£åœ¨è¢«è¯»å–ä¸­</strong>æ—¶ï¼ŒPersistenceWorker å’Œ PersistenceTimer æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªåˆ‡æ¢é˜Ÿåˆ—ï¼Œè¯»å–æ•°æ®ã€‚å½“è¯»å–å®Œæˆåï¼Œè°ƒç”¨ <code>Window#finishReadingLast()</code> æ–¹æ³•ï¼Œæ¸…ç©ºåŸæ•°æ®æŒ‡å‘ï¼Œå¹¶æ ‡è®°åŸæ•°æ®æŒ‡å‘å®Œæˆæ­£åœ¨è¯»å–ä¸­ã€‚</li></ul></li><li><p>ç¬¬ 71 è¡Œï¼šè°ƒç”¨ <code>IBatchDAO#batchPersistence(List&lt;?&gt;)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ‰¹é‡æ“ä½œï¼Œè¿›è¡Œå­˜å‚¨ã€‚</p></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œç»ˆäºæŠŠæµå¼å¤„ç†ç»™å†™å®Œäº†ï¼Œå¦‚æœå†™çš„ä¸è¯¦ç»†æˆ–è€…ä¸åˆé€‚çš„ï¼Œèƒ–å‹çœ‹åˆ°éº»çƒ¦å‘ŠçŸ¥ç¬”è€…ï¼Œè°¢è°¢ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_09_01/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/collector-streaming-second/&quot;&gt;http://www.iocoder.cn/SkyWalking/collector-streaming-seco
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-streaming-first/</id>
    <published>2020-08-24T16:00:00.000Z</published>
    <updated>2018-01-01T11:48:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">http://www.iocoder.cn/SkyWalking/collector-streaming-first/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">2. apm-collector-core/graph</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">2.1 Graph åˆ›å»º</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">2.2 Graph å¯åŠ¨</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">3. apm-collector-stream</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">3.1 WayToNode å®ç°ç±»</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">3.2 NodeProcessor å®ç°ç±»</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Collector Streaming æµå¼å¤„ç†</strong>ã€‚ä¸»è¦åŒ…å«å¦‚ä¸‹éƒ¨åˆ†ï¼š</p><ul><li><p><code>apm-collector-core</code> æ¨¡å—çš„ <code>graph</code> åŒ…ï¼Œæä¾›<strong>æœ€ç²¾ç®€</strong>ã€<strong>å•èŠ‚ç‚¹</strong>çš„æµå¼å¤„ç†çš„å°è£…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/01.png" alt=""></p></li><li><p><code>apm-collector-stream</code> æ¨¡å—ï¼Œåœ¨ <code>graph</code> åŒ…çš„åŸºç¡€ä¸Šï¼Œæä¾›<strong>å¼‚æ­¥</strong>ã€<strong>è·¨èŠ‚ç‚¹</strong>ç­‰ç­‰çš„æµå¼å¤„ç†çš„å°è£…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/02.png" alt=""></p></li></ul><blockquote><p>å…æ‰“è„¸å¤§ä¿å¥ï¼šç¬”è€…å¯¹æµå¼å¤„ç†éå¸¸ä¸äº†è§£ï¼Œæœ¬æ–‡å¯èƒ½æ˜¯ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“ã€‚è€ƒè™‘åˆ°ç¬”è€…æ˜¯é è„¸åƒé¥­ï¼ˆé¢œå€¼æˆ‘åªæœæˆ‘çº¢é›·å“¥ï¼‰ï¼Œæ‰€ä»¥è¯»è€…è€çˆ·è¯·çˆ±æŠ¤ä¸‹ç¬”è€…ã€‚</p></blockquote><p>Collector Streaming åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM <a href="https://github.com/apache/incubating-skywalking" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/apache/incubating-skywalking</a><br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/03.jpeg" alt=""></p></blockquote><p>OKï¼Œä¸‹é¢æ¥ä¸€æœ¬æ­£ç»çš„ä»£ç èµ°èµ·ï¼</p><h1 id="2-apm-collector-core-graph"><a href="#2-apm-collector-core-graph" class="headerlink" title="2. apm-collector-core/graph"></a>2. apm-collector-core/graph</h1><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/04.png" alt=""></p><p>çœ‹èµ·æ¥ç•¥å¤æ‚ï¼Œä¸è¦æ–¹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæµå¼å¤§æ•°æ®å¤„ç†æ¡†æ¶ Apache Storm çš„è¯´æ˜ï¼š</p><blockquote><p>FROM <a href="http://www.csdn.net/article/2015-03-09/2824135" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæµå¼å¤§æ•°æ®å¤„ç†çš„ä¸‰ç§æ¡†æ¶ï¼šStormï¼ŒSparkå’ŒSamzaã€‹</a><br>åœ¨ <a href="https://storm.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Storm</a> ä¸­ï¼Œå…ˆè¦è®¾è®¡ä¸€ä¸ªç”¨äºå®æ—¶è®¡ç®—çš„å›¾çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ‹“æ‰‘ï¼ˆtopologyï¼‰ã€‚è¿™ä¸ªæ‹“æ‰‘å°†ä¼šè¢«æäº¤ç»™é›†ç¾¤ï¼Œç”±é›†ç¾¤ä¸­çš„ä¸»æ§èŠ‚ç‚¹ï¼ˆmaster nodeï¼‰åˆ†å‘ä»£ç ï¼Œå°†ä»»åŠ¡åˆ†é…ç»™å·¥ä½œèŠ‚ç‚¹ï¼ˆworker nodeï¼‰æ‰§è¡Œã€‚</p></blockquote><ul><li>Graph ï¼šå®šä¹‰äº†ä¸€ä¸ª<strong>æ•°æ®</strong>åœ¨<strong>å„ä¸ª</strong> Node çš„å¤„ç†æ‹“æ‰‘å›¾ã€‚</li><li>WayToNode ï¼šæäº¤<strong>æ•°æ®</strong>ç»™ Node çš„<strong>æ–¹å¼</strong>ã€‚</li><li>Node ï¼šèŠ‚ç‚¹ï¼ŒåŒ…å«ä¸€ä¸ª NodeProcessor å’Œ ä¸€ä¸ª Next ã€‚ <ul><li>NodeProcessor ï¼šNode å¤„ç†å™¨ï¼Œå¤„ç†<strong>æ•°æ®</strong>ã€‚</li><li>Next ï¼šåŒ…å« WayToNode æ•°ç»„ï¼Œå³ Node æäº¤<strong>æ•°æ®</strong>ç»™ Next çš„ Node <strong>æ•°ç»„</strong>çš„<strong>æ–¹å¼</strong>ã€‚</li></ul></li></ul><p>æ•´ä½“äº¤äº’æµç¨‹å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/05.png" alt=""></p><ul><li><strong>ç²‰è‰²</strong>ç®­å¤´ï¼šå½“æ•°æ®è¿›æ¥æ—¶ï¼Œæäº¤ç»™ Grpah ã€‚æŒ‰ç…§å®šä¹‰çš„æ‹“æ‰‘å›¾ï¼Œä½¿ç”¨ NodeWay æäº¤ç»™ Node ï¼ŒNodeProcessor è¿›è¡Œå¤„ç†ã€‚</li><li><strong>è“è‰²</strong>ç®­å¤´ï¼šå½“ NodeProcessor å¤„ç†å®Œæˆåï¼ŒNext <strong>é€ä¸ª</strong>ä½¿ç”¨ NodeWay <strong>æ•°ç»„</strong>æäº¤ç»™ä¸‹é¢çš„ Node ï¼Œç»§ç»­å¤„ç†ã€‚<ul><li>ps ï¼š<strong>æ³¨æ„</strong>ï¼Œè¿™å—æµç¨‹ï¼Œæ ¹æ®ä¸åŒçš„ NodeProcessor çš„å®ç°ç±»ä¼šæœ‰ä¸åŒï¼Œ<strong>è“è‰²</strong>ç®­å¤´çš„è¿‡ç¨‹ï¼Œåªæ˜¯<strong>å…¶ä¸­çš„ä¸€ç§</strong>ï¼Œä¸‹é¢ä¼šè¯¦ç»†è§£æã€‚</li></ul></li></ul><p>æ•´ä½“é¡ºåºå›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/06.png" alt=""></p><ul><li>DirectWay æ˜¯ WayToNode <strong>æ¥å£</strong>çš„ä¸€ç§å®ç°ï¼Œæ­£å¦‚å…¶åï¼Œ<strong>ç›´æ¥</strong>æäº¤æ•°æ®ç»™ Node ã€‚åœ¨ <a href="#">ã€Œ3. apm-collector-streamã€</a> ä¼šçœ‹åˆ°å…¶ä»–å®ç°ï¼Œä¾‹å¦‚æäº¤åˆ°å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹çš„ Nodeï¼Œä»è€Œå®ç°è·¨æœåŠ¡å™¨èŠ‚ç‚¹çš„æµå¼å¤„ç†ã€‚</li><li>AbstractWorker åœ¨ <code>apm-collector-stream</code> æ¨¡å—ï¼Œæ˜¯ NodeProcessor <strong>æ¥å£</strong>çš„ä¸€ç§å®ç°ï¼Œå¤„ç†æäº¤ç»™ Node çš„æ•°æ®ã€‚åœ¨ <code>#onWork(message)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•é‡Œï¼Œå­ç±»å¯ä»¥å®ç°è¯¥æ–¹æ³•ï¼Œæ ¹æ®è‡ªèº«éœ€æ±‚ï¼Œæ˜¯å¦è°ƒç”¨ <code>#onNext(message)</code> æ–¹æ³•ï¼ŒNext é€ä¸ªä½¿ç”¨ NodeWay æ•°ç»„æäº¤ç»™ä¸‹é¢çš„ Node ï¼Œç»§ç»­å¤„ç†ã€‚</li></ul><hr><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†åˆ†åˆ«çœ‹çœ‹å¦‚ä¸‹é€»è¾‘çš„è¯¦ç»†ä»£ç å®ç°ï¼š</p><ul><li>Graph åˆ›å»º</li><li>Graph å¯åŠ¨</li></ul><h2 id="2-1-Graph-åˆ›å»º"><a href="#2-1-Graph-åˆ›å»º" class="headerlink" title="2.1 Graph åˆ›å»º"></a>2.1 Graph åˆ›å»º</h2><p>åˆ›å»º Graph çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/07.png" alt=""></p><ul><li>ç¬¬ä¸€æ­¥ï¼Œè°ƒç”¨ <code>GraphManager#createIfAbsent(graphId, input)</code> æ–¹æ³•( <code>input</code> å‚æ•°æ²¡ç”¨ )ï¼Œåˆ›å»ºä¸€ä¸ª Graph å¯¹è±¡ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨ <code>Graph#addNode(WayToNode)</code> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Graph çš„<strong>é¦–ä¸ª</strong> Node å¯¹è±¡ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨ <code>Node#addNext(WayToNode)</code> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Node çš„ä¸‹ä¸€ä¸ª Node å¯¹è±¡ã€‚</li></ul><p>å¦‚ä¸‹æ˜¯ <code>collector-agent-stream-provider</code> æ¨¡å—ï¼Œ<code>TraceStreamGraph#createServiceReferenceGraph()</code> æ–¹æ³•çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createServiceReferenceGraph</span><span class="params">()</span> </span>&#123;</div><div class="line">    QueueCreatorService&lt;ServiceReference&gt; queueCreatorService = moduleManager.find(QueueModule.NAME).getService(QueueCreatorService.class);</div><div class="line">    RemoteSenderService remoteSenderService = moduleManager.find(RemoteModule.NAME).getService(RemoteSenderService.class);</div><div class="line"></div><div class="line">    Graph&lt;ServiceReference&gt; graph = GraphManager.INSTANCE.createIfAbsent(SERVICE_REFERENCE_GRAPH_ID, ServiceReference.class);</div><div class="line">    graph.addNode(<span class="keyword">new</span> ServiceReferenceAggregationWorker.Factory(moduleManager, queueCreatorService).create(workerCreateListener))</div><div class="line">        .addNext(<span class="keyword">new</span> ServiceReferenceRemoteWorker.Factory(moduleManager, remoteSenderService, SERVICE_REFERENCE_GRAPH_ID).create(workerCreateListener))</div><div class="line">        .addNext(<span class="keyword">new</span> ServiceReferencePersistenceWorker.Factory(moduleManager, queueCreatorService).create(workerCreateListener));</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªæ–¹æ³•çš„å…·ä½“ä»£ç å®ç°ã€‚</p><hr><p><strong>ç¬¬ä¸€æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/GraphManager.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>GraphManager#createIfAbsent(graphId, input)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Graph å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° Graph æ˜ å°„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>INSTANCE</code> å±æ€§ï¼Œå•ä¾‹ã€‚</li><li><code>allGraphs</code> å±æ€§ï¼ŒGraph æ˜ å°„ã€‚å…¶ä¸­æ˜ å°„çš„ KEY ä¸º<strong>æ¯ä¸ª</strong> Graph å…¨å±€å”¯ä¸€ç¼–å·ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java" rel="external nofollow noopener noreferrer" target="_blank">JvmMetricStreamGraph</a> ã€<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/RegisterStreamGraph.java" rel="external nofollow noopener noreferrer" target="_blank">RegisterStreamGraph</a> ã€<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java" rel="external nofollow noopener noreferrer" target="_blank">TraceStreamGraph</a> ç±»ä¸­ï¼Œæšä¸¾äº†å®é™…ä½¿ç”¨çš„ Graph ç¼–å·ä»¬ã€‚</li><li>ç¬¬ 50 è‡³ 58 è¡Œï¼šå½“ Graph æ˜ å°„é‡Œä¸å­˜åœ¨æŒ‡å®š Graph ç¼–å·æ—¶ï¼Œåˆ›å»º Graph å¯¹è±¡ï¼Œå¹¶è¿”å›ã€‚</li></ul><hr><p><strong>ç¬¬äºŒæ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Graph.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph#addNode(WayToNode)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Graph çš„<strong>é¦–ä¸ª</strong> Node å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>id</code> å±æ€§ï¼ŒGraph ç¼–å·ã€‚</li><li><code>entryWay</code>ï¼Œ<strong>é¦–ä¸ª</strong>æäº¤æ•°æ®ç»™ Node çš„æ–¹å¼ã€‚</li><li>ç¬¬ 58 è¡Œ ï¼šå°†æ–¹æ³•å‚æ•° <code>entryWay</code> èµ‹å€¼ç»™ <code>this.entryWay</code> å±æ€§ã€‚åœ¨ä¸‹åˆ†äº«çš„ <code>Graph#start(input)</code> æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ˜¯ Graph å¯åŠ¨çš„å…¥å£ï¼Œ<strong>é¦–ä¸ª</strong>æäº¤ç»™ Node çš„æ–¹å¼ã€‚</li><li>ç¬¬ 60 è‡³ 62 è¡Œ ï¼šè°ƒç”¨ <code>WayToNode#buildDestination(Graph)</code> æ–¹æ³•ï¼Œåˆ›å»º Node å¯¹è±¡ï¼Œå¹¶<strong>è¿”å›è¯¥ Node</strong> ã€‚åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯´è¿‡åˆ›å»ºçš„ Node å¯¹è±¡ï¼Œä¸ºè¯¥ Graph çš„<strong>é¦–ä¸ª</strong> Node ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/WayToNode.java#L41" rel="external nofollow noopener noreferrer" target="_blank"><code>WayToNode#buildDestination()</code></a> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ <strong>WayToNode</strong> çš„ Node å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>destination</code> å±æ€§ï¼Œç›®æ ‡ Node ã€‚å³è¯¥ WayToNode æäº¤<strong>æ•°æ®</strong>åˆ°çš„ Node ã€‚</li><li><code>destinationHandler</code> å±æ€§ï¼Œç›®æ ‡ Node çš„å¤„ç†å™¨ã€‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/WayToNode.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#out(INPUT)</code></a> æ–¹æ³•ã€‚</li><li>ç¬¬ 42 è¡Œï¼šåˆ›å»º Node å¯¹è±¡ã€‚<ul><li>ç›®å‰ï¼Œ<code>destinationHandler</code> å±æ€§ï¼Œé™¤äº†ç”¨äºåˆ›å»º Node å¯¹è±¡ï¼Œæ— å…¶ä»–ç”¨é€”ã€‚</li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Node.java#L40" rel="external nofollow noopener noreferrer" target="_blank">Node <code>æ„é€ æ–¹æ³•</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeProcessor</code> å±æ€§ï¼ŒèŠ‚ç‚¹å¤„ç†å™¨ã€‚</li><li><code>next</code> å±æ€§ï¼ŒåŒ…å« WayToNode æ•°ç»„ï¼Œå³ Node æäº¤æ•°æ®ç»™ Next çš„ Node æ•°ç»„çš„æ–¹å¼ã€‚</li><li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨ <code>Graph#checkForNewNode(Node)</code> æ–¹æ³•ï¼Œæ ¡éªŒ Node çš„ NodeProcessor åœ¨å…¶ Graph é‡Œï¼Œ<strong>ç¼–å·å”¯ä¸€</strong>ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Graph.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph#checkForNewNode(Node)</code></a> æ–¹æ³•ï¼Œæ ¡éªŒ Node çš„ NodeProcessor åœ¨ Graph é‡Œï¼Œ<strong>ç¼–å·å”¯ä¸€</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeIndex</code> å±æ€§ï¼Œå¤„ç†å™¨ç¼–å·ä¸ Node çš„æ˜ å°„ã€‚å…¶ä¸­æ˜ å°„çš„ KEY ä¸º <code>NodeProcessor#id()</code> ã€‚ </li><li>ç¬¬ 72 è‡³ 78 è¡Œï¼šæ ¡éªŒ Node çš„ NodeProcessor åœ¨ Graph é‡Œï¼Œ<strong>ç¼–å·å”¯ä¸€</strong>ã€‚</li></ul><hr><p><strong>ç¬¬ä¸‰æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Node.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>Node#addNext(WayToNode)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Node çš„ä¸‹ä¸€ä¸ª Node å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 54 è¡Œï¼šè°ƒç”¨ <code>WayToNode#buildDestination(Graph)</code> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Node çš„ä¸‹é¢çš„ Node å¯¹è±¡ã€‚</li><li>ç¬¬ 56 è¡Œï¼šæ·»åŠ åˆ›å»ºçš„ Node å¯¹è±¡åˆ° <code>next</code> å±æ€§ã€‚</li><li>ç¬¬ 58 è¡Œï¼šè¿”å›åˆ›å»ºçš„ Node å¯¹è±¡ã€‚</li></ul><h2 id="2-2-Graph-å¯åŠ¨"><a href="#2-2-Graph-å¯åŠ¨" class="headerlink" title="2.2 Graph å¯åŠ¨"></a>2.2 Graph å¯åŠ¨</h2><p>åˆ›å»º Graph çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/08.png" alt=""></p><table><thead><tr><th>æ•°æ®æµå‘</th><th>FROM</th><th>TO</th><th>é€»è¾‘</th></tr></thead><tbody><tr><td>ç¬¬ä¸€æ­¥</td><td>Graph</td><td>WayToNode</td><td></td></tr><tr><td>ç¬¬äºŒæ­¥</td><td>WayToNode</td><td>Node</td><td></td></tr><tr><td>ç¬¬ä¸‰æ­¥</td><td>Node</td><td>NodeProcessor</td><td></td></tr><tr><td>ç¬¬å››æ­¥</td><td>NodeProcessor</td><td>Next</td><td>æ ¹æ®å…·ä½“å®ç°ï¼Œè‹¥åˆ° Next ï¼Œé‡å¤ç¬¬ä¸€æ­¥</td></tr></tbody></table><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/09.png" alt=""></p><hr><p><strong>ç¬¬ä¸€æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Graph.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph#start(input)</code></a> æ–¹æ³•ï¼Œå¯åŠ¨ Graph ï¼Œå¤„ç†æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 49 è¡Œï¼šè°ƒç”¨ <code>WayToNode#in(input)</code> æ–¹æ³•ï¼Œè¾“å…¥æ•°æ®ç»™ WayToNode ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/WayToNode.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>WayToNode#in(input)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œä»¥ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/DirectWay.java#L29" rel="external nofollow noopener noreferrer" target="_blank"><code>DirectWay#in(input)</code></a> <strong>å®ç°</strong>æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨ <code>super#out(input)</code> æ–¹æ³•ï¼Œ<strong>ç›´æ¥</strong>è¾“å‡ºæ•°æ®ï¼Œè°ƒç”¨ <code>Node#execute(input)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®ç»™ Node ï¼Œè¿›è¡Œå¤„ç†ã€‚</li></ul><hr><p><strong>ç¬¬äºŒæ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Node.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>Node#execute</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>NodeProcessor#process(input, next)</code> æ–¹æ³•ï¼Œå¤„ç†æ•°æ®ã€‚</p><hr><p><strong>ç¬¬ä¸‰æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/NodeProcessor.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>NodeProcessor#process(input, next)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œä»¥ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorker.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractWorker#process(input, next)</code></a> <strong>å®ç°</strong>æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 64 è¡Œï¼šå°†æ–¹æ³•å‚æ•° <code>next</code> èµ‹å€¼ç»™ <code>this.next</code> å±æ€§ã€‚<code>this.next</code> å±æ€§ï¼Œç”¨äºå°è£…çš„ <code>#onNext(OUTPUT)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®ç»™å½“å‰ Node çš„ Next ( ä¸‹é¢çš„ Node ä»¬ )ç»§ç»­å¤„ç†æ•°æ®ã€‚</li><li>ç¬¬ 67 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorker.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå¤„ç†æ•°æ®ã€‚å½“ AbstractWorker <strong>æŠ½è±¡ç±»</strong>çš„å®ç°ç±»éœ€è¦ç»§ç»­è®²æ•°æ®æäº¤ç»™ Next æ—¶ï¼Œéœ€è¦åœ¨ <code>#onWork</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>#onNext(OUTPUT)</code> æ–¹æ³•ï¼Œä¾‹å¦‚ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationRegisterRemoteWorker#onWork(Application)</code></a> ã€‚</li></ul><hr><p><strong>ç¬¬å››æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Next.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>Next#execute(INPUT)</code></a> æ–¹æ³•ï¼Œ<strong>å¾ªç¯</strong> WayToNode æ•°ç»„ï¼Œè¾“å…¥æ•°æ®ç»™ WayNode ï¼Œç›¸å½“äºâ€<strong>é‡å›</strong>â€œã€ç¬¬ä¸€æ­¥ã€‘ã€‚</p><h1 id="3-apm-collector-stream"><a href="#3-apm-collector-stream" class="headerlink" title="3. apm-collector-stream"></a>3. apm-collector-stream</h1><p>åœ¨æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬æåˆ°äº† <code>apm-collector-stream</code> æ¨¡å—ï¼Œåœ¨ <code>graph</code> åŒ…çš„åŸºç¡€ä¸Šï¼Œæä¾›<strong>å¼‚æ­¥</strong>ã€<strong>è·¨èŠ‚ç‚¹</strong>ç­‰ç­‰çš„æµå¼å¤„ç†çš„å°è£…ã€‚ä¸»è¦åœ¨ WayToNode ã€NodeProcessor çš„å®ç°ç±»ä¸Šåšæ–‡ç« ã€‚</p><h2 id="3-1-WayToNode-å®ç°ç±»"><a href="#3-1-WayToNode-å®ç°ç±»" class="headerlink" title="3.1 WayToNode å®ç°ç±»"></a>3.1 WayToNode å®ç°ç±»</h2><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/10.png" alt=""></p><h3 id="3-1-1-WorkerRef"><a href="#3-1-1-WorkerRef" class="headerlink" title="3.1.1 WorkerRef"></a>3.1.1 WorkerRef</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/WorkerRef.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.WorkerRef</code></a> ï¼ŒWorker å¼•ç”¨<strong>æŠ½è±¡ç±»</strong>ã€‚</p><p>åœ¨ <code>apm-collector-stream</code> æ¨¡å—é‡Œï¼Œæˆ‘ä»¬ä¼šå‘ç°ç±»çš„å‘½åä» Node / NodeProcessor è½¬å‘äº† Worker ï¼Ÿ<strong>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢</strong>ï¼Ÿå…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç‰¹æ„<del>é‡‡è®¿</del>( è¯·æ•™ )äº†å®˜æ–¹å¤§ä½¬ã€‚</p><blockquote><p>Worker æ›´å…·ä¸šåŠ¡å«ä¹‰<br>Node / Processor æ›´åæŠ€æœ¯å«ä¹‰</p></blockquote><p>ç›®å‰ï¼ŒWorkerRef æ— å…·ä½“çš„æ–¹æ³•ã€‚</p><h3 id="3-1-2-LocalAsyncWorkerRef"><a href="#3-1-2-LocalAsyncWorkerRef" class="headerlink" title="3.1.2 LocalAsyncWorkerRef"></a>3.1.2 LocalAsyncWorkerRef</h3><p><code>org.skywalking.apm.collector.stream.worker.base.LocalAsyncWorkerRef</code> ï¼Œå¼‚æ­¥ Worker å¼•ç”¨<strong>å®ç°ç±»</strong>ï¼Œæä¾›äº†<strong>å¼‚æ­¥</strong>çš„æµå¼å¤„ç†å°è£…ã€‚</p><p>æˆ‘ä»¬å›åˆ° <a href="#">ã€Œ2.2 Graph åˆ›å»ºã€</a> çš„ã€ç¬¬ä¸€æ­¥ã€‘ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/LocalAsyncWorkerRef.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>LocalAsyncWorkerRef#in(INPUT)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/LocalAsyncWorkerRef.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>queueEventHandler</code></a> å±æ€§ï¼Œé˜Ÿåˆ—äº‹ä»¶å¤„ç†å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶ã€‹</a> æˆ‘ä»¬ä¼šè¯¦ç»†è§£æå®ƒçš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªç®€å•ä»‹ç»ä¸‹ã€‚</li><li>ç¬¬ 47 è¡Œï¼šå°†è¾“å…¥çš„æ•°æ®ï¼Œä½œä¸ºâ€<strong>äº‹ä»¶</strong>â€œï¼Œæäº¤åˆ°é˜Ÿåˆ—äº‹ä»¶å¤„ç†å™¨ä¸­ï¼Œä¸å†æ‰§è¡Œåç»­é€»è¾‘ã€‚æ­¤åï¼Œé˜Ÿåˆ—äº‹ä»¶å¤„ç†å™¨ï¼Œä¼šåœ¨<strong>åå°</strong>å¤„ç†åˆ°è¯¥â€<strong>äº‹ä»¶</strong>â€œ( æ•°æ® )ï¼Œå›è°ƒ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/LocalAsyncWorkerRef.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>LocalAsyncWorkerRef#execute</code></a> æ–¹æ³•ï¼Œä»è€Œæäº¤æ•°æ®åˆ° Worker ( Node )ã€‚è¯¦ç»†å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorEventHandler.java#L54" rel="external nofollow noopener noreferrer" target="_blank">DisruptorEventHandler#onEvent(â€¦)</a> æ–¹æ³•ã€‚</li></ul><p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå›è°ƒå‘¢</strong>ï¼ŸLocalAsyncWorkerRef å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/QueueExecutor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.base.QueueExecutor</code></a> æ¥å£ï¼Œå®ƒè‡ªèº«è¢«è®¾ç½®åˆ° QueueEventHandler ä¸­ï¼Œ ä½œä¸ºâ€<strong>äº‹ä»¶</strong>â€œçš„æ‰§è¡Œå™¨ã€‚</p><p>æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/11.png" alt=""></p><h3 id="3-1-3-RemoteWorkerRef"><a href="#3-1-3-RemoteWorkerRef" class="headerlink" title="3.1.3 RemoteWorkerRef"></a>3.1.3 RemoteWorkerRef</h3><p><code>org.skywalking.apm.collector.stream.worker.base.RemoteWorkerRef</code> ï¼Œè¿œç¨‹ Worker å¼•ç”¨<strong>å®ç°ç±»</strong>ï¼Œæä¾›äº†<strong>è¿œç¨‹è·¨èŠ‚ç‚¹</strong>çš„æµå¼å¤„ç†çš„å°è£…ã€‚</p><p>æˆ‘ä»¬å†å›åˆ° <a href="#">ã€Œ2.2 Graph åˆ›å»ºã€</a> çš„ã€ç¬¬ä¸€æ­¥ã€‘ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/RemoteWorkerRef.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteWorkerRef#in(INPUT)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>remoteSenderService</code> å±æ€§ï¼Œè¿œç¨‹å‘é€æœåŠ¡ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-remote-module?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Remote è¿œç¨‹é€šä¿¡æœåŠ¡ã€‹ã€Œ3.2 GRPCRemoteSenderServiceã€</a> æˆ‘ä»¬ä¼šè¯¦ç»†è§£æå®ƒçš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªç®€å•ä»‹ç»ä¸‹ã€‚</li><li><code>remoteWorker</code> å±æ€§ï¼Œè¿œç¨‹ Worker ã€‚åœ¨ä¸‹æ–‡ä¼šè¯¦ç»†åˆ†äº«å®ƒçš„å®ç°ã€‚</li><li>ç¬¬ 56 è¡Œï¼šè°ƒç”¨ <code>RemoteSenderService#send(...)</code> æ–¹æ³•ï¼Œæ ¹æ®è¿œç¨‹ Worker çš„ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/Selector.java" rel="external nofollow noopener noreferrer" target="_blank">Selector é€‰æ‹©å™¨</a>ï¼Œé€‰æ‹©ä¸€ä¸ª Worker è¿›è¡Œå‘é€ã€‚</li><li>ç¬¬ 58 è‡³ 60 è¡Œï¼šå½“é€‰æ‹©çš„ Worker ä¸ºæœ¬åœ°æ¨¡å¼( <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteSenderService.java#L36" rel="external nofollow noopener noreferrer" target="_blank">Mode</a> )æ—¶ï¼Œè°ƒç”¨ <code>#out(INPUT)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®åˆ°æœ¬åœ°çš„ Worker ( Node )ã€‚</li></ul><h2 id="3-2-NodeProcessor-å®ç°ç±»"><a href="#3-2-NodeProcessor-å®ç°ç±»" class="headerlink" title="3.2 NodeProcessor å®ç°ç±»"></a>3.2 NodeProcessor å®ç°ç±»</h2><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/12.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/23c2146c134e0ef0a37a43758a1e04727de7697a/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/Provider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.Provider</code></a> ï¼ŒWorker ä¾›åº”è€…<strong>æ¥å£</strong>ï¼Œç”¨äºåˆ›å»º Worker å’Œ WorkerRef å¯¹è±¡çš„<strong>å·¥å‚</strong>ã€‚</li></ul><h3 id="3-2-1-AbstractWorker"><a href="#3-2-1-AbstractWorker" class="headerlink" title="3.2.1 AbstractWorker"></a>3.2.1 AbstractWorker</h3><p>AbstractWorker çš„ä»£ç å®ç°ï¼Œåœ¨ <a href="#">ã€Œ2.2 Graph å¯åŠ¨ã€</a> å·²ç»è¯¦ç»†è§£æã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorkerProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.AbstractWorkerProvider</code></a> ï¼ŒWorker ä¾›åº”è€…<strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorkerProvider.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#workerInstance(ModuleManager)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œç”¨äºåˆ›å»º Worker å¯¹è±¡ã€‚</p><h3 id="3-2-2-AbstractLocalAsyncWorker"><a href="#3-2-2-AbstractLocalAsyncWorker" class="headerlink" title="3.2.2 AbstractLocalAsyncWorker"></a>3.2.2 AbstractLocalAsyncWorker</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractLocalAsyncWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.AbstractLocalAsyncWorker</code></a> ï¼Œå¼‚æ­¥ Worker <strong>æŠ½è±¡ç±»</strong>ã€‚</p><p>ç›®å‰ï¼ŒAbstractLocalAsyncWorker æ— å…·ä½“çš„æ–¹æ³•ã€‚</p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker ç±»ï¼Œå®ç° <code>#work(INPUT)</code> æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L56" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterSerialWorker</a> ã€‚</p><hr><p><code>org.skywalking.apm.collector.stream.worker.base.AbstractLocalAsyncWorkerProvider</code> ï¼ŒLocalAsyncWorker ä¾›åº”è€…<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractLocalAsyncWorkerProvider.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>queueCreatorService</code></a> å±æ€§ï¼Œé˜Ÿåˆ—åˆ›å»ºæœåŠ¡ï¼Œç”¨äºåˆ›å»º QueueEventHandler å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractLocalAsyncWorkerProvider.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#queueSize()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå£°æ˜é˜Ÿåˆ—å¤§å°ã€‚</li><li><a href=""><code>#create(WorkerCreateListener)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º AbstractLocalAsyncWorker å’Œ LocalAsyncWorkerRef å¯¹è±¡ã€‚<ul><li>ç¬¬ 51 è¡Œï¼šåˆ›å»º AbstractLocalAsyncWorker <strong>å®ç°ç±»</strong>çš„å¯¹è±¡ã€‚å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L90" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterSerialWorker.Factory#workerInstance(ModuleManager)</a> æ–¹æ³•ã€‚</li><li>ç¬¬ 54 è¡Œï¼šæ·»åŠ  AbstractLocalAsyncWorker åˆ° WorkerCreateListener ( Worker åˆ›å»ºç›‘å¬å™¨ )ã€‚WorkerCreateListener åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ4.1 WorkerCreateListenerã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 57 è¡Œï¼šåˆ›å»º LocalAsyncWorkerRef å¯¹è±¡ã€‚</li><li>ç¬¬ 60 è¡Œï¼šè°ƒç”¨ <code>QueueCreatorService#create(...)</code> æ–¹æ³•ï¼Œåˆ›å»º QueueEventHandler å¯¹è±¡ï¼Œ<strong>å¹¶è®¾ç½® LocalAsyncWorkerRef ä½œä¸ºå®ƒçš„æ‰§è¡Œå™¨</strong>ã€‚</li><li>ç¬¬ 63 è¡Œï¼šè®¾ç½® LocalAsyncWorkerRef çš„ QueueEventHandler å±æ€§ã€‚</li></ul></li></ul><h3 id="3-2-3-AbstractRemoteWorker"><a href="#3-2-3-AbstractRemoteWorker" class="headerlink" title="3.2.3 AbstractRemoteWorker"></a>3.2.3 AbstractRemoteWorker</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.AbstractRemoteWorker</code></a> ï¼Œè¿œç¨‹ Worker <strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorker.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>#selector()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—é€‰æ‹©å™¨ã€‚RemoteSenderService æ ¹æ®é€‰æ‹©å™¨ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/selector/RemoteClientSelector.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteClientSelector#select(...)</code></a> æ–¹æ³•ï¼Œé€‰æ‹©å¥½è¿œç¨‹èŠ‚ç‚¹ï¼Œè€Œåè¿›è¡Œå‘é€æ•°æ®ã€‚</p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker ç±»ï¼Œå®ç° <code>#work(INPUT)</code> æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterRemoteWorker</a> ã€‚</p><hr><p><code>org.skywalking.apm.collector.stream.worker.base.AbstractRemoteWorkerProvider</code> ï¼ŒAbstractRemoteWorker ä¾›åº”è€…<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorkerProvider.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>remoteSenderService</code></a> å±æ€§ï¼Œè¿œç¨‹å‘é€æœåŠ¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorkerProvider.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(WorkerCreateListener)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º AbstractRemoteWorker å’Œ RemoteWorkerRef å¯¹è±¡ã€‚<ul><li>ç¬¬ 58 è¡Œï¼šåˆ›å»º AbstractRemoteWorker <strong>å®ç°ç±»</strong>çš„å¯¹è±¡ã€‚å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L61" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterRemoteWorker.Factory#workerInstance(ModuleManager)</a> æ–¹æ³•ã€‚</li><li>ç¬¬ 61 è¡Œï¼šæ·»åŠ  AbstractLocalAsyncWorker åˆ° WorkerCreateListener ( Worker åˆ›å»ºç›‘å¬å™¨ )ã€‚WorkerCreateListener åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-second/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆäºŒï¼‰ã€‹ã€Œ4.1 WorkerCreateListenerã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 64 è¡Œï¼šåˆ›å»º RemoteWorkerRef å¯¹è±¡ã€‚</li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œè›®å—¨çš®çš„ã€‚å¡äº†ä¸€ä¸ªå‘¨æœ«ï¼Œå·®ç‚¹åˆå •è½äº†ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_25/13.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/SkyWalking/collector-streaming-first/&quot;&gt;http://www.iocoder.cn/SkyWalking/collector-streaming-first
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
</feed>
