<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-11-05T03:06:40.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>èŠ‹é“æºç </name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RxJava æºç è§£æ â€”â€” Observable#lift(Operator)</title>
    <link href="http://www.iocoder.cn/RxJava/observable-lift-operator/"/>
    <id>http://www.iocoder.cn/RxJava/observable-lift-operator/</id>
    <published>2019-01-28T16:00:00.000Z</published>
    <updated>2017-11-05T03:06:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬</strong></p><p>æœ¬ç³»åˆ—å†™ä½œç›®çš„ï¼Œä¸ºäº†è¾…åŠ© Hystrix çš„ç†è§£ï¼Œå› æ­¤ä¼šè¾ƒä¸ºé›¶æ•£ä¸çç¢ï¼Œæœ›è§è°…è§è°…ã€‚</p><ul><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">2. ç¤ºä¾‹</a></li><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">3. åŸç†</a></li><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">4. æºç </a><ul><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">4.1 Operator</a></li><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">4.2 Observable#lift(Operator)</a></li><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">4.3 OnSubscribeLift</a></li></ul></li><li><a href="http://www.iocoder.cn/RxJava/observable-lift-operator/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p><code>Observable#lift(Operator)</code> æ–¹æ³•ï¼ŒRxJava ä¸­<strong>æ‰€æœ‰</strong>æ“ä½œç¬¦çš„<strong>åŸºç¡€</strong>ï¼Œä¸æ¸…æ™°çš„ç†è§£ï¼Œåé¢ä¼šæ˜¯æ‡µé€¼è„¸çŠ¶ã€‚</p><p>æ€ä¹ˆè§£é‡Šè¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿç¬”è€…æš‚æ—¶æ²¡æœ‰æƒ³å¥½ã€‚æœäº†ä¸‹äº’è”ç½‘ä¸Šç›¸å…³çš„æ–‡ç« ï¼Œä¹Ÿæ²¡æ‰¾åˆ°åˆé€‚çš„å¯¿å‘½ã€‚But ï¼Œè¿™ä¸å½±å“æˆ‘ä»¬å¯¹è¯¥æ–¹æ³•çš„ç†è§£ã€‚</p><h1>2. ç¤ºä¾‹</h1><p>ä¸‹é¢æˆ‘ä»¬å…ˆä¸€èµ·æ¥çœ‹<strong>ç¬¬ä¸€æ®µç¤ºä¾‹</strong> ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">   Observable.just(<span class="string">"1"</span>, <span class="string">"2"</span>)</div><div class="line">           .subscribe(o -&gt; System.out.println(<span class="string">"subscriber ï¼š"</span> + o));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¾“å‡ºå¦‚ä¸‹ ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">subscriber ï¼š1</div><div class="line">subscriber ï¼š2</div></pre></td></tr></table></figure></p></li></ul><p><strong>ç¬¬äºŒæ®µç¤ºä¾‹</strong> ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">   Observable.just(<span class="string">"1"</span>, <span class="string">"2"</span>)</div><div class="line">           .lift(<span class="keyword">new</span> Observable.Operator&lt;String, String&gt;() &#123;</div><div class="line">               <span class="meta">@Override</span></div><div class="line">               <span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> String&gt; call(Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber) &#123;</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"></div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">                           System.out.println(<span class="string">"operator ï¼š"</span> + s);</div><div class="line">                           subscriber.onNext(s);</div><div class="line">                       &#125;</div><div class="line">                   &#125;;</div><div class="line">               &#125;</div><div class="line">           &#125;)</div><div class="line">           .subscribe(o -&gt; System.out.println(<span class="string">"subscriber ï¼š"</span> + o));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¾“å‡ºå¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">operator ï¼š<span class="number">1</span></div><div class="line">subscriber ï¼š<span class="number">1</span></div><div class="line">operator ï¼š<span class="number">2</span></div><div class="line">subscriber ï¼š<span class="number">2</span></div></pre></td></tr></table></figure></p></li></ul><ul><li><p><code>Observable#lift(Operator)</code> æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª<strong>æ–°çš„</strong> Subscriber ï¼Œå¯¹<strong>ä¼ é€’è¿›æ¥</strong>çš„ Subscriber å½¢æˆ<strong>ä»£ç†</strong>ï¼Œå¯¹ <code>#onNext()</code> / <code>#onCompleted()</code> / <code>#onError()</code> æ–¹æ³•è¿›è¡Œæ‹¦æˆªã€‚<strong>è¿™å°±æ˜¯ <code>Observable#lift(Operator)</code> çš„å®ç°åŸç†</strong>ã€‚å¦‚æœæˆ‘ä»¬å»æ‰ <code>subscriber.onNext(s)</code> éƒ¨åˆ†ä»£ç ï¼Œåˆ™è¾“å‡ºå¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">operator ï¼š<span class="number">1</span></div><div class="line">operator ï¼š<span class="number">2</span></div></pre></td></tr></table></figure></p></li></ul><h1>3. åŸç†</h1><p>OK ï¼Œä¸‹é¢åœ¨ç”¨ä¸€å¼ å›¾æ¥ç†è§£ä¸‹ <code>Observable#lift(Operator)</code> çš„<strong>åŸç†</strong> ï¼š</p><p><img src="http://www.iocoder.cn/images/RxJava/2019_01_29/01.png" alt=""></p><h1>4. æºç </h1><p>å¼€å§‹æˆ‘ä»¬çš„æºç æ—…ç¨‹ã€‚</p><h2>4.1 Operator</h2><p><code>rx.Observable.Operator</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Func1</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">Function</span> </span>&#123;</div><div class="line">    <span class="function">R <span class="title">call</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Operator</span>&lt;<span class="title">R</span>, <span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Func1</span>&lt;<span class="title">Subscriber</span>&lt;? <span class="title">super</span> <span class="title">R</span>&gt;, <span class="title">Subscriber</span>&lt;? <span class="title">super</span> <span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="comment">// cover for generics insanity</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>T <code>t</code> ï¼šä¼ é€’æ¥çš„ Subscriber ï¼Œä¸Šå›¾<strong>ç²‰è‰²</strong>çš„ Subscriber ã€‚</li><li>R ï¼šè¿”å›ä¸€ä¸ª<strong>æ–°</strong>çš„ Subscriber ï¼Œä¸Šå›¾<strong>ç»¿è‰²</strong>çš„ Subscriber ã€‚</li></ul><h2>4.2 Observable#lift(Operator)</h2><p><code>Observable#lift(Operator)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">lift</span><span class="params">(<span class="keyword">final</span> Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> OnSubscribeLift&lt;T, R&gt;(onSubscribe, operator));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observable&lt;T&gt;(RxJavaHooks.onCreate(f));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ <code>operator</code> ( Operator ) + <code>onSubscribe</code> ( OnSubscribe )ï¼Œç”Ÿæˆ<strong>æ–°</strong>çš„ <code>onSubscribe</code> ( OnSubscribeã€OnSubscribeLiftã€‘ ) ï¼Œä»è€Œç”Ÿæˆ<strong>æ–°</strong>çš„ Observable ã€‚</li><li>OnSubscribeLift åœ¨ <a href="#">ã€Œ4.3 OnSubscribeLiftã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>4.3 OnSubscribeLift</h2><p>OnSubscribeLift ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSubscribeLift</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">R</span>&gt; </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> OnSubscribe&lt;T&gt; parent;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="keyword">final</span> Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="function"><span class="keyword">public</span> <span class="title">OnSubscribeLift</span><span class="params">(OnSubscribe&lt;T&gt; parent, Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">this</span>.parent = parent;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">this</span>.operator = operator;</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">13</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> R&gt; o)</span> </span>&#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:             Subscriber&lt;? <span class="keyword">super</span> T&gt; st = RxJavaHooks.onObservableLift(operator).call(o);</div><div class="line"><span class="number">16</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:                 <span class="comment">// new Subscriber created and being subscribed with so 'onStart' it</span></div><div class="line"><span class="number">18</span>:                 st.onStart();</div><div class="line"><span class="number">19</span>:                 parent.call(st);</div><div class="line"><span class="number">20</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="comment">// localized capture of errors rather than it skipping all operators</span></div><div class="line"><span class="number">22</span>:                 <span class="comment">// and ending up in the try/catch of the subscribe method which then</span></div><div class="line"><span class="number">23</span>:                 <span class="comment">// prevents onErrorResumeNext and other similar approaches to error handling</span></div><div class="line"><span class="number">24</span>:                 Exceptions.throwIfFatal(e);</div><div class="line"><span class="number">25</span>:                 st.onError(e);</div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">28</span>:             Exceptions.throwIfFatal(e);</div><div class="line"><span class="number">29</span>:             <span class="comment">// if the lift function failed all we can do is pass the error to the final Subscriber</span></div><div class="line"><span class="number">30</span>:             <span class="comment">// as we don't have the operator available to us</span></div><div class="line"><span class="number">31</span>:             o.onError(e);</div><div class="line"><span class="number">32</span>:         &#125;</div><div class="line"><span class="number">33</span>:     &#125;</div><div class="line"><span class="number">34</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>å¯èƒ½æœ‰èƒ–å‹å¯¹ <code>Observable#subscribe(Subscriber)</code> æ–¹æ³•çš„<strong>è°ƒç”¨é“¾</strong>ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œåœ¨<strong>ç¬¬ 15 è¡Œ</strong>æ‰“<strong>æ–­ç‚¹</strong>ï¼Œè°ƒç”¨è¿å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/RxJava/2019_01_29/02.png" alt=""></li><li>ç¬¬ 15 è¡Œ ï¼šè°ƒç”¨ <code>Operator#call()</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ–°</strong>çš„ Subscriber ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šè°ƒç”¨ <code>Subscriber#onStart()</code> æ–¹æ³•ï¼Œå› ä¸º<strong>æ–°</strong>çš„ Subscriber è¢«è®¢é˜…ã€‚</li><li>ç¬¬ 19 è¡Œ ï¼šè°ƒç”¨ <code>OnSubscribe#call(Subscriber)</code> æ–¹æ³•ï¼Œ<strong>ç»§ç»­è®¢é˜…</strong>ã€‚</li></ul><h1>666. å½©è›‹</h1><p>æ˜¯ä¸æ˜¯éå¸¸æ¸…æ™°ï¼èªæ…§å¦‚ä½ ï¼</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬&lt;/stron
      
    
    </summary>
    
      <category term="RxJava" scheme="http://www.iocoder.cn/categories/RxJava/"/>
    
    
  </entry>
  
  <entry>
    <title>RxJava æºç è§£æ â€”â€” Observable#subscribeOn(Scheduler)</title>
    <link href="http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/"/>
    <id>http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/</id>
    <published>2019-01-21T16:00:00.000Z</published>
    <updated>2017-11-02T07:50:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬</strong></p><p>æœ¬ç³»åˆ—å†™ä½œç›®çš„ï¼Œä¸ºäº†è¾…åŠ© Hystrix çš„ç†è§£ï¼Œå› æ­¤ä¼šè¾ƒä¸ºé›¶æ•£ä¸çç¢ï¼Œæœ›è§è°…è§è°…ã€‚</p><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p><code>Observable#subscribeOn(Scheduler)</code> æ–¹æ³•ï¼Œç”¨é€”å¦‚ä¸‹ ï¼š</p><blockquote><p>FROM <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/SubscribeOn.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” SubscribeOnã€‹</a><br>æŒ‡å®š Observable <strong>è‡ªèº«</strong>åœ¨å“ªä¸ªè°ƒåº¦å™¨ä¸Šæ‰§è¡Œ<br><img src="http://www.iocoder.cn/images/RxJava/2019_01_22/01.png" alt=""><br>å¾ˆå¤š ReactiveX å®ç°éƒ½ä½¿ç”¨è°ƒåº¦å™¨ <code>&quot;Scheduler&quot;</code> æ¥ç®¡ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸­Observable çš„è½¬åœºã€‚ä½ å¯ä»¥ä½¿ç”¨ SubscribeOn æ“ä½œç¬¦æŒ‡å®š Observable åœ¨ä¸€ä¸ªç‰¹å®šçš„è°ƒåº¦å™¨ä¸Šè¿è½¬ã€‚</p></blockquote><p>ä»æ¦‚å¿µä¸Šå¯èƒ½æ¯”è¾ƒæ¨¡ç³Šï¼Œæˆ–è€…æˆ‘ä»¬æ¢ä¸€ç§è¯´æ³• ï¼š</p><blockquote><p>FROM <a href="http://gank.io/post/560e15be2dca930e00da1083#toc_14" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£ã€‹ã€Œ 3. çº¿ç¨‹æ§åˆ¶ â€”â€” Scheduler (ä¸€) ã€</a><code>#subscribeOn()</code> ï¼šæŒ‡å®š <code>#subscribe()</code> æ‰€å‘ç”Ÿçš„çº¿ç¨‹ï¼Œå³ <code>Observable.OnSubscribe</code> è¢«æ¿€æ´»æ—¶æ‰€å¤„çš„çº¿ç¨‹ã€‚<strong>æˆ–è€…å«åšäº‹ä»¶äº§ç”Ÿçš„çº¿ç¨‹</strong>ã€‚</p></blockquote><p>æ¥æ¥æ¥ï¼Œä¸€èµ·ç…ç…æºç ï¼Œæ›´åŠ æ¸…ç†çš„ç†è§£ã€‚<code>Observable#subscribeOn(Scheduler)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Observable.java</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> OnSubscribe&lt;T&gt; onSubscribe;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Observable</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.onSubscribe = f;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">subscribeOn</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">instanceof</span> ScalarSynchronousObservable) &#123;</div><div class="line">        <span class="keyword">return</span> ((ScalarSynchronousObservable&lt;T&gt;)<span class="keyword">this</span>).scalarScheduleOn(scheduler);</div><div class="line">   &#125;</div><div class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> OperatorSubscribeOn&lt;T&gt;(<span class="keyword">this</span>, scheduler));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observable&lt;T&gt;(RxJavaHooks.onCreate(f));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ScalarSynchronousObservable ï¼Œè·³è¿‡ï¼Œä¸åœ¨æœ¬æ–‡èŒƒå›´å†…ã€‚</li><li>åˆ›å»º OperatorSubscribeOn å¯¹è±¡ï¼Œå°† Observable ( <code>this</code> ) å’Œ Scheduler ( <code>scheduler</code> ) ä¼ å…¥ã€‚</li></ul><hr><p>OperatorSubscribeOn ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorSubscribeOn</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> Scheduler scheduler;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> Observable&lt;T&gt; source;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="function"><span class="keyword">public</span> <span class="title">OperatorSubscribeOn</span><span class="params">(Observable&lt;T&gt; source, Scheduler scheduler)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.scheduler = scheduler;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">this</span>.source = source;</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</div><div class="line"><span class="number">13</span>:         <span class="keyword">final</span> Worker inner = scheduler.createWorker();</div><div class="line"><span class="number">14</span>:         subscriber.add(inner);</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         inner.schedule(<span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">17</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">18</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">final</span> Thread t = Thread.currentThread();</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:                 Subscriber&lt;T&gt; s = <span class="keyword">new</span> Subscriber&lt;T&gt;(subscriber) &#123;</div><div class="line"><span class="number">22</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">23</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</div><div class="line"><span class="number">24</span>:                         subscriber.onNext(t);</div><div class="line"><span class="number">25</span>:                     &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">28</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"><span class="number">29</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">30</span>:                             subscriber.onError(e);</div><div class="line"><span class="number">31</span>:                         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">32</span>:                             inner.unsubscribe();</div><div class="line"><span class="number">33</span>:                         &#125;</div><div class="line"><span class="number">34</span>:                     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">37</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">38</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">39</span>:                             subscriber.onCompleted();</div><div class="line"><span class="number">40</span>:                         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">41</span>:                             inner.unsubscribe();</div><div class="line"><span class="number">42</span>:                         &#125;</div><div class="line"><span class="number">43</span>:                     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">46</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(<span class="keyword">final</span> Producer p)</span> </span>&#123;</div><div class="line"><span class="number">47</span>:                         subscriber.setProducer(<span class="keyword">new</span> Producer() &#123;</div><div class="line"><span class="number">48</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">49</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> n)</span> </span>&#123;</div><div class="line"><span class="number">50</span>:                                 <span class="keyword">if</span> (t == Thread.currentThread()) &#123;</div><div class="line"><span class="number">51</span>:                                     p.request(n);</div><div class="line"><span class="number">52</span>:                                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">53</span>:                                     inner.schedule(<span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">54</span>:                                         <span class="meta">@Override</span></div><div class="line"><span class="number">55</span>:                                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">56</span>:                                             p.request(n);</div><div class="line"><span class="number">57</span>:                                         &#125;</div><div class="line"><span class="number">58</span>:                                     &#125;);</div><div class="line"><span class="number">59</span>:                                 &#125;</div><div class="line"><span class="number">60</span>:                             &#125;</div><div class="line"><span class="number">61</span>:                         &#125;);</div><div class="line"><span class="number">62</span>:                     &#125;</div><div class="line"><span class="number">63</span>:                 &#125;;</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:                 source.unsafeSubscribe(s);</div><div class="line"><span class="number">66</span>:             &#125;</div><div class="line"><span class="number">67</span>:         &#125;);</div><div class="line"><span class="number">68</span>:     &#125;</div><div class="line"><span class="number">69</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>scheduler</code>ï¼Œ<code>source</code> å±æ€§å°±ä¸ç”¨è¯´äº†ï¼Œä¸Šæ–‡æˆ‘ä»¬å·²ç»çœ‹åˆ°ã€‚</p></li><li><p>å¯èƒ½æœ‰åŒå­¦å¯¹ <code>OnSubscribe#call(Subscriber)</code> æ–¹æ³•çš„è°ƒç”¨é“¾è·¯ä¸å¤ªç†Ÿæ‚‰ï¼Œæˆ‘ä»¬æ‰‹æ’¸ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”æ‰“ä¸ªæ–­ç‚¹æ„Ÿå—ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxDemo11</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Observable.just(<span class="string">"1"</span>, <span class="string">"2"</span>)</div><div class="line">                .subscribeOn(Schedulers.newThread()) <span class="comment">// Scheduler å¼€å¯æ–°çº¿ç¨‹</span></div><div class="line">                .subscribe(s -&gt; System.out.println(s)); <span class="comment">// Subscriber æ‰“å°</span></div><div class="line">        Thread.sleep(Long.MAX_VALUE); <span class="comment">// Scheduler å¼‚æ­¥ï¼ŒSleep ç­‰å¾…</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨<strong>ç¬¬ 13 è¡Œ</strong>å¤„æ‰“æ–­ç‚¹ï¼Œæ–¹æ³•çš„è°ƒç”¨é“¾è·¯å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/RxJava/2019_01_22/02.png" alt=""></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šä½¿ç”¨ Scheduler åˆ›å»º Worker ã€‚åœ¨ <a href="http://www.iocoder.cn/RxJava/scheduler/?self">ã€ŠRxJava æºç è§£æ â€”â€” Schedulerã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 14 è¡Œ ï¼šå°† Worker æ·»åŠ åˆ° <code>subscriber.subscriptions</code> é‡Œã€‚Worker ç±»å®ç°äº† <code>rx.Subscription</code> <strong>æ¥å£</strong>ã€‚</p></li><li><p>ç¬¬ 16 è‡³ 66 è¡Œ ï¼šä½¿ç”¨ Worker æ‰§è¡Œæ“ä½œã€‚ä¾‹å¦‚ Scheduler ä¸º NewThreadScheduler æ—¶ï¼Œæ­¤å¤„çš„ Worker å¯¹åº” NewThreadWorker ï¼Œæ‰§è¡Œæ“ä½œæ—¶ä½¿ç”¨<strong>æ–°çº¿ç¨‹</strong>ï¼Œè€Œä¸æ˜¯å½“å‰çº¿ç¨‹ã€‚</p><ul><li>ç¬¬ 19 è¡Œ ï¼šè·å–æ‰§è¡Œæ“ä½œçš„å½“å‰çº¿ç¨‹ï¼Œç”¨äºç¬¬ 50 è¡Œçš„åˆ¤æ–­ã€‚</li><li>ç¬¬ 21 è‡³ 63 è¡Œ ï¼šåˆ›å»º<strong>æ–°çš„</strong> Subscriber ã€‚æ¯”è¾ƒå…³é”®çš„æ˜¯ <code>#setProducer()</code> æ–¹æ³•ï¼Œåˆ¤æ–­ <code>#request()</code> æ—¶ï¼Œçº¿ç¨‹æ˜¯å¦æ˜¯ <code>t</code> ( Worker çš„çº¿ç¨‹ )ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‡æ–°ä½¿ç”¨ Worker æ‰§è¡Œ <code>#request()</code> æ–¹æ³•ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè¾¾åˆ°ä¸Šæ–‡æ‰€è¯´çš„ <em>&quot;æŒ‡å®š <code>#subscribe()</code> æ‰€å‘ç”Ÿçš„çº¿ç¨‹ï¼Œå³ <code>Observable.OnSubscribe</code> è¢«æ¿€æ´»æ—¶æ‰€å¤„çš„çº¿ç¨‹ã€‚<strong>æˆ–è€…å«åšäº‹ä»¶äº§ç”Ÿçš„çº¿ç¨‹</strong>ã€‚&quot;</em>ã€‚</li></ul></li><li><p>ç¬¬ 65 è¡Œ ï¼šè°ƒç”¨ <code>Observable#unsafeSubscribe(...)</code> æ–¹æ³•ï¼Œ<strong>ç»§ç»­è®¢é˜…é€»è¾‘</strong>ã€‚</p></li><li><p>å¦å¤–ï¼Œæƒ³è¦è§¦å‘<strong>ç¬¬ 53 è¡Œ</strong>çš„æƒ…å†µï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxDemo10</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Observable.defer(() -&gt; Observable.just(<span class="string">"1"</span>, <span class="string">"2"</span>)</div><div class="line">                    .subscribeOn(Schedulers.newThread()) <span class="comment">// Scheduler</span></div><div class="line">                )</div><div class="line">                .subscribeOn(Schedulers.newThread()) <span class="comment">// Scheduler</span></div><div class="line">                .subscribe(s -&gt; System.out.println(s));</div><div class="line">        Thread.sleep(Long.MAX_VALUE); <span class="comment">// Scheduler å¼‚æ­¥ï¼ŒSleep ç­‰å¾…</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬&lt;/stron
      
    
    </summary>
    
      <category term="RxJava" scheme="http://www.iocoder.cn/categories/RxJava/"/>
    
    
  </entry>
  
  <entry>
    <title>RxJava æºç è§£æ â€”â€” Scheduler</title>
    <link href="http://www.iocoder.cn/RxJava/scheduler/"/>
    <id>http://www.iocoder.cn/RxJava/scheduler/</id>
    <published>2019-01-14T16:00:00.000Z</published>
    <updated>2017-11-01T18:55:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/scheduler/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬</strong></p><p>æœ¬ç³»åˆ—å†™ä½œç›®çš„ï¼Œä¸ºäº†è¾…åŠ© Hystrix çš„ç†è§£ï¼Œå› æ­¤ä¼šè¾ƒä¸ºé›¶æ•£ä¸çç¢ï¼Œæœ›è§è°…è§è°…ã€‚</p><ul><li><a href="http://www.iocoder.cn/RxJava/scheduler/">1. Scheduler</a></li><li><a href="http://www.iocoder.cn/RxJava/scheduler/">2. Worker</a></li><li><a href="http://www.iocoder.cn/RxJava/scheduler/">3. é»˜è®¤è°ƒåº¦å™¨å®ç°</a></li><li><a href="http://www.iocoder.cn/RxJava/scheduler/">4. æ“ä½œç¬¦ä¸è°ƒåº¦å™¨</a></li><li><a href="http://www.iocoder.cn/RxJava/scheduler/">5. ä½¿ç”¨ç¤ºä¾‹</a></li><li><a href="http://www.iocoder.cn/RxJava/scheduler/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. Scheduler</h1><p><code>rx.Scheduler</code> ï¼Œ<strong>æŠ½è±¡ç±»</strong>ï¼Œä¸€ä¸ªå¯ä»¥è°ƒåº¦å·¥ä½œå•å…ƒ( <code>rx.Scheduler.Worker</code> )<strong>ä»¬</strong>çš„å¯¹è±¡ã€‚</p><blockquote><p>FROM <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Scheduler.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” Schedulerã€‹</a><br>å¦‚æœä½ æƒ³ç»™ Observable æ“ä½œç¬¦é“¾æ·»åŠ <strong>å¤šçº¿ç¨‹</strong>åŠŸèƒ½ï¼Œä½ å¯ä»¥æŒ‡å®šæ“ä½œç¬¦( æˆ–è€…ç‰¹å®šçš„Observable )åœ¨ç‰¹å®šçš„è°ƒåº¦å™¨( Scheduler )ä¸Šæ‰§è¡Œã€‚</p></blockquote><blockquote><p>æŸäº› ReactiveX çš„ Observable æ“ä½œç¬¦æœ‰ä¸€äº›å˜ä½“ï¼Œå®ƒä»¬å¯ä»¥æ¥å—ä¸€ä¸ª Scheduler å‚æ•°ã€‚è¿™ä¸ªå‚æ•°æŒ‡å®šæ“ä½œç¬¦å°†å®ƒä»¬çš„éƒ¨åˆ†æˆ–å…¨éƒ¨ä»»åŠ¡æ”¾åœ¨ä¸€ä¸ªç‰¹å®šçš„è°ƒåº¦å™¨ä¸Šæ‰§è¡Œã€‚</p></blockquote><blockquote><p><strong>ä½¿ç”¨ ObserveOn å’Œ SubscribeOn æ“ä½œç¬¦</strong>ï¼Œä½ å¯ä»¥è®© Observable åœ¨ä¸€ä¸ªç‰¹å®šçš„è°ƒåº¦å™¨ä¸Šæ‰§è¡Œã€‚</p><ul><li>ObserveOn æŒ‡ç¤ºä¸€ä¸ª Observable åœ¨ä¸€ä¸ªç‰¹å®šçš„è°ƒåº¦å™¨ä¸Šè°ƒç”¨è§‚å¯Ÿè€…çš„ onNext , onError å’Œ onCompleted æ–¹æ³•ã€‚</li><li>SubscribeOn æ›´è¿›ä¸€æ­¥ï¼Œå®ƒæŒ‡ç¤º Observable å°†å…¨éƒ¨çš„å¤„ç†è¿‡ç¨‹( åŒ…æ‹¬å‘å°„æ•°æ®å’Œé€šçŸ¥ )æ”¾åœ¨ç‰¹å®šçš„è°ƒåº¦å™¨ä¸Šæ‰§è¡Œã€‚</li></ul></blockquote><ul><li><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Observable.java#L10404" rel="external nofollow noopener noreferrer" target="_blank"><code>Observable#subscribeOn(Scheduler)</code></a> ï¼Œåœ¨ <a href="http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/">ã€ŠRxJava æºç è§£æ â€”â€” Observable#subscribeOn(Scheduler)ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul><p>ä¸ºä»€ä¹ˆæ˜¯<strong>æŠ½è±¡ç±»</strong>ï¼Œè€Œä¸æ˜¯<strong>æ¥å£</strong>å‘¢ï¼Ÿå®˜æ–¹è¯´æ˜å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Why is this an abstract class instead of an interface?</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  : Java doesn't support extension methods and there are many overload methods needing default</span></div><div class="line"><span class="comment"> *    implementations.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  : Virtual extension methods aren't available until Java8 which RxJava will not set as a minimum target for</span></div><div class="line"><span class="comment"> *    a long time.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  : If only an interface were used Scheduler implementations would then need to extend from an</span></div><div class="line"><span class="comment"> *    AbstractScheduler pair that gives all of the functionality unless they intend on copy/pasting the</span></div><div class="line"><span class="comment"> *    functionality.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  : Without virtual extension methods even additive changes are breaking and thus severely impede library</span></div><div class="line"><span class="comment"> *    maintenance.</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure></p><ul><li>ã€ç¬¬ä¸€ã€äºŒç‚¹ã€‘Java åœ¨ 8.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œæ¥å£ä¸æ”¯æŒé»˜è®¤å®ç°æ–¹æ³•ï¼Œè€Œ Scheduler éœ€è¦å¤šä¸ªæ–¹æ³•æä¾›é»˜è®¤å®ç°ã€‚RxJava è€ƒè™‘åˆ°å…¼å®¹æ€§ï¼Œå°†é•¿æœŸä½¿ç”¨ä½ç‰ˆæœ¬çš„ Java ã€‚</li><li>ã€ç¬¬ä¸‰ã€å››ç‚¹ã€‘å¦‚æœå°† Scheduler å®šä¹‰ä¸ºæ¥å£ï¼Œé‚£ä¹ˆéœ€è¦æ·»åŠ ä¸€ä¸ª AbstractScheduler æŠ½è±¡ç±»ï¼Œå®ç°æ¥å£çš„é»˜è®¤æ–¹æ³•å®ç°ã€‚</li></ul><p>Scheduler æä¾›æ–¹æ³•å¦‚ä¸‹ ï¼š</p><ul><li><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>#createWorker()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³• ï¼šåˆ›å»º Worker ã€‚</li><li><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L129" rel="external nofollow noopener noreferrer" target="_blank"><code>#now()</code></a> <strong>é»˜è®¤</strong>æ–¹æ³• ï¼šè¿”å›å½“å‰æ—¶é—´ã€‚</li><li><s><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L208" rel="external nofollow noopener noreferrer" target="_blank"><code>#when(...)</code></a> <strong>é»˜è®¤</strong>æ–¹æ³• ï¼šè·³è¿‡ï¼ŒHystrix æš‚æœªä½¿ç”¨ã€‚</s></li></ul><h1>2. Worker</h1><p><code>rx.Scheduler.Worker</code> ï¼Œå·¥ä½œå•å…ƒå¯¹è±¡<strong>æŠ½è±¡ç±»</strong>ï¼Œæ‰§è¡Œ Scheduler è°ƒåº¦çš„æ“ä½œ( <code>rx.functions.Action0</code> )ã€‚</p><p>Worker æä¾›æ–¹æ³•å¦‚ä¸‹ ï¼š</p><ul><li><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#schedule(Action0)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³• ï¼š<strong>ç«‹å³</strong>è°ƒåº¦æ“ä½œã€‚</li><li><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L87" rel="external nofollow noopener noreferrer" target="_blank"><code>#schedulePeriodically(Action0, long, long, TimeUnit)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼š<strong>å»¶è¿Ÿ</strong>è°ƒåº¦æ“ä½œã€‚</li><li><s><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L109" rel="external nofollow noopener noreferrer" target="_blank"><code>#schedulePeriodically(Action0, long, long, TimeUnit)</code></a> <strong>é»˜è®¤</strong>æ–¹æ³• ï¼š<strong>å‘¨æœŸæ€§</strong>æ“ä½œã€‚è·³è¿‡ï¼ŒHystrix æš‚æœªä½¿ç”¨ã€‚</s></li><li><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/Scheduler.java#L119" rel="external nofollow noopener noreferrer" target="_blank"><code>#now()</code></a> <strong>é»˜è®¤</strong>æ–¹æ³• ï¼šè¿”å›å½“å‰æ—¶é—´ã€‚</li></ul><p>Worker å®ç° <code>rx.Subscription</code> <strong>æ¥å£</strong>ï¼Œä½†æ˜¯å¹¶æœªå®ç°å¯¹åº”çš„æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œç”¨äº ï¼š</p><ul><li><code>#unsubscribe()</code> ï¼š<strong>åŸæ„</strong>å–æ¶ˆè®¢é˜…ï¼Œ<strong>å®æ„</strong>å–æ¶ˆæ“ä½œã€‚</li><li><code>#isUnsubscribed()</code> ï¼š<strong>åŸæ„</strong>è®¢é˜…æ˜¯å¦å–æ¶ˆï¼Œ<strong>å®æ„</strong>æ“ä½œæ˜¯å¦å–æ¶ˆã€‚</li></ul><h1>3. é»˜è®¤è°ƒåº¦å™¨å®ç°</h1><p>åœ¨ <code>rx.internal.schedulers</code> åŒ…ä¸‹ï¼Œæä¾›äº†å¤šç§é»˜è®¤è°ƒåº¦å™¨çš„å®ç°ã€‚</p><p><img src="http://www.iocoder.cn/images/RxJava/2019_01_15/01.png" alt=""></p><p><a href="https://github.com/ReactiveX/RxJava/blob/5b2394c9ee91f298661fff5e043744c84b425808/src/main/java/rx/schedulers/Schedulers.java" rel="external nofollow noopener noreferrer" target="_blank"><code>rx.schedulers.Schedulers</code></a> ï¼Œé»˜è®¤è°ƒåº¦å™¨å•ä¾‹å·¥å‚ï¼Œåˆ›å»ºä¸Šå›¾è°ƒåº¦å™¨å·¥å‚å¹¶è¿›è¡Œç®¡ç†ã€‚</p><blockquote><p>å‚è€ƒ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Scheduler.html#%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E7%A7%8D%E7%B1%BB" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” Schedulerã€‹ã€Œè°ƒåº¦å™¨çš„ç§ç±»ã€</a></p></blockquote><table><thead><tr><th>å•ä¾‹</th><th>ç±»</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>Schedulers#io()</code></td><td>CachedThreadScheduler</td><td>ç”¨äº IO å¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚å¼‚æ­¥é˜»å¡ IO æ“ä½œï¼Œè¿™ä¸ªè°ƒåº¦å™¨çš„çº¿ç¨‹æ± ä¼šæ ¹æ®éœ€è¦å¢é•¿</td></tr><tr><td><code>Schedulers#computation()</code></td><td>EventLoopsScheduler</td><td>ç”¨äºæ™®é€šçš„è®¡ç®—ä»»åŠ¡ï¼Œé»˜è®¤çº¿ç¨‹æ•°ç­‰äºå¤„ç†å™¨çš„æ•°é‡</td></tr><tr><td><code>Schedulers#from(Executor)</code></td><td>ExecutorScheduler</td><td>ä½¿ç”¨æŒ‡å®šçš„ Executor ä½œä¸ºè°ƒåº¦å™¨</td></tr><tr><td><code>Schedulers#immediate()</code></td><td>ImmediateScheduler</td><td>åœ¨å½“å‰çº¿ç¨‹ç«‹å³å¼€å§‹æ‰§è¡Œä»»åŠ¡</td></tr><tr><td><code>Schedulers#newThread()</code></td><td>NewThreadScheduler</td><td>ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹</td></tr><tr><td><code>Schedulers#trampoline()</code></td><td>TrampolineScheduler</td><td>å½“å…¶å®ƒæ’é˜Ÿçš„ä»»åŠ¡å®Œæˆåï¼Œåœ¨å½“å‰çº¿ç¨‹æ’é˜Ÿå¼€å§‹æ‰§è¡Œ</td></tr></tbody></table><p>åœ¨ Hystrix é‡Œï¼Œç»§æ‰¿ Scheduler <strong>æŠ½è±¡ç±»</strong>ï¼Œå®ç°äº†<strong>è‡ªå®šä¹‰</strong>çš„ Scheduler ã€‚</p><p>å› æ­¤ï¼Œè·³è¿‡é»˜è®¤è°ƒåº¦å™¨çš„æºç è§£æã€‚</p><h1>4. æ“ä½œç¬¦ä¸è°ƒåº¦å™¨</h1><p>ç‚¹å‡» <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Scheduler.html#%E9%BB%98%E8%AE%A4%E8%B0%83%E5%BA%A6%E5%99%A8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” Schedulerã€‹ã€Œé»˜è®¤è°ƒåº¦å™¨ã€</a> æŸ¥çœ‹ã€‚</p><h1>5. ä½¿ç”¨ç¤ºä¾‹</h1><p>ç‚¹å‡» <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Scheduler.html#%E4%BD%BF%E7%94%A8%E8%B0%83%E5%BA%A6%E5%99%A8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” Schedulerã€‹ã€Œä½¿ç”¨è°ƒåº¦å™¨ã€</a> æŸ¥çœ‹ã€‚</p><p>å¯èƒ½ä½ ä¼šè§‰å¾—ç¤ºä¾‹æœ‰ä¸¢ä¸¢â€œå¥‡æ€ªâ€ï¼Œåœ¨ <a href="http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/">ã€ŠRxJava æºç è§£æ â€”â€” Observable#subscribeOn(Scheduler)ã€‹</a> ä½ å°†è·å¾—ç­”æ¡ˆã€‚</p><h1>666. å½©è›‹</h1><p>æœ¬æ–‡åä»‹ç»æ€§ï¼Œå¤§é‡å†…å®¹å¼•ç”¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Scheduler.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” Schedulerã€‹</a> ã€‚</p><p>åç»­æ ¹æ®éœ€è¦ï¼Œå¯èƒ½è§£æé»˜è®¤è°ƒåº¦å™¨çš„æºç å®ç°ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/scheduler/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æœ¬ç³»åˆ—å†™ä½œç›®çš„ï¼Œä¸ºäº†è¾…åŠ© H
      
    
    </summary>
    
      <category term="RxJava" scheme="http://www.iocoder.cn/categories/RxJava/"/>
    
    
  </entry>
  
  <entry>
    <title>RxJava æºç è§£æ â€”â€” BlockingObservable</title>
    <link href="http://www.iocoder.cn/RxJava/blocking-observable/"/>
    <id>http://www.iocoder.cn/RxJava/blocking-observable/</id>
    <published>2019-01-07T16:00:00.000Z</published>
    <updated>2017-11-01T18:48:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/blocking-observable/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬</strong></p><p>æœ¬ç³»åˆ—å†™ä½œç›®çš„ï¼Œä¸ºäº†è¾…åŠ© Hystrix çš„ç†è§£ï¼Œå› æ­¤ä¼šè¾ƒä¸ºé›¶æ•£ä¸çç¢ï¼Œæœ›è§è°…è§è°…ã€‚</p><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><blockquote><p><a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Blocking-Observable-Operators.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” é˜»å¡æ“ä½œã€‹</a><br>BlockingObservable çš„æ–¹æ³•ä¸æ˜¯å°†ä¸€ä¸ª Observable å˜æ¢ä¸ºå¦ä¸€ä¸ªï¼Œä¹Ÿä¸æ˜¯è¿‡æ»¤Observablesï¼Œå®ƒä»¬ä¼šæ‰“æ–­ Observable çš„è°ƒç”¨é“¾ï¼Œä¼šé˜»å¡ç­‰å¾…ç›´åˆ° Observable å‘å°„äº†æƒ³è¦çš„æ•°æ®ï¼Œç„¶åè¿”å›è¿™ä¸ªæ•°æ®ï¼ˆè€Œä¸æ˜¯ä¸€ä¸ª Observable ï¼‰ã€‚</p></blockquote><h1>1. toBlocking</h1><p>è°ƒç”¨ <code>Observable#toBlocking()</code> æˆ– <code>BlockingObservable#from(Observable)</code> æ–¹æ³•ï¼Œå°† Observable è½¬æ¢æˆ BlockingObservable ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BlockingObservable.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingObservable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Observable&lt;? extends T&gt; o;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BlockingObservable</span><span class="params">(Observable&lt;? extends T&gt; o)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.o = o;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">BlockingObservable&lt;T&gt; <span class="title">from</span><span class="params">(<span class="keyword">final</span> Observable&lt;? extends T&gt; o)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BlockingObservable&lt;T&gt;(o);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Observable.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> BlockingObservable&lt;T&gt; <span class="title">toBlocking</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> BlockingObservable.from(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä»ä»£ç ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒBlockingObservable å¹¶æœªå°† Observable è½¬æ¢æˆæ–°çš„ï¼Œè€Œæ˜¯ç®€å•çš„åŒ…äº†ä¸€å±‚ã€‚</li></ul><h1>2. toFuture</h1><blockquote><p><a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/To.html#tofuture" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” TOã€‹</a><br><img src="http://www.iocoder.cn/images/Hystrix/2018_10_08/04.png" alt=""><code>#toFuture()</code> æ“ä½œç¬¦ä¹Ÿæ˜¯åªèƒ½ç”¨äº BlockingObservable ã€‚è¿™ä¸ªæ“ä½œç¬¦å°†Observable è½¬æ¢ä¸ºä¸€ä¸ªè¿”å›<strong>å•ä¸ªæ•°æ®é¡¹</strong>çš„ Future ã€‚</p><ul><li>å¦‚æœåŸå§‹ Observable å‘å°„å¤šä¸ªæ•°æ®é¡¹ï¼ŒFutureä¼šæ”¶åˆ°ä¸€ä¸ªIllegalArgumentExceptionï¼›</li><li>å¦‚æœåŸå§‹ Observable æ²¡æœ‰å‘å°„ä»»ä½•æ•°æ®ï¼ŒFutureä¼šæ”¶åˆ°ä¸€ä¸ªNoSuchElementExceptionã€‚</li></ul><p>å¦‚æœä½ æƒ³å°†å‘å°„å¤šä¸ªæ•°æ®é¡¹çš„ Observable è½¬æ¢ä¸º Future ï¼Œå¯ä»¥è¿™æ ·ç”¨ï¼š<code>myObservable.toList().toBlocking().toFuture()</code> ã€‚</p></blockquote><p>ç‚¹å‡»<a href="https://github.com/ReactiveX/RxJava/blob/396b6104e419b80002c45faf76ac38f00d2ff64a/src/main/java/rx/internal/operators/BlockingOperatorToFuture.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#toFuture()</code> çš„ä»£ç å®ç°ï¼š</p><ul><li>é€šè¿‡å‘ä¼ å…¥ Observable è®¢é˜… Subscriber ï¼Œæ‰“æ–­ Observable çš„è°ƒç”¨é“¾ï¼Œä¼šé˜»å¡ç­‰å¾…ç›´åˆ° Observable å‘å°„äº†æƒ³è¦çš„æ•°æ®ã€‚<ul><li><code>#onNext()</code> æ–¹æ³•ï¼Œè®¾ç½®æ‰§è¡Œçš„è¿”å›å€¼( <code>value</code> )ã€‚</li><li><code>#onCompleted()</code> æ–¹æ³•ï¼ŒCountDownLatch (<code>finished</code>) å‡ä¸€ã€‚</li><li><code>#onError()</code> æ–¹æ³•ï¼Œè®¾ç½®æ‰§è¡Œæ—¶å‘ç”Ÿçš„å¼‚å¸¸( <code>error</code> )ï¼Œå¹¶ CountDownLatch (<code>finished</code>) å‡ä¸€ã€‚</li></ul></li><li>è¿”å›çš„ Future ï¼Œé€šè¿‡ CountDownLatch ( <code>error</code> ) åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæˆï¼›é€šè¿‡ <code>value</code> ï¼Œ <code>error</code> è·å¾—æ‰§è¡Œçš„ç»“æœã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/blocking-observable/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æœ¬ç³»åˆ—å†™
      
    
    </summary>
    
      <category term="RxJava" scheme="http://www.iocoder.cn/categories/RxJava/"/>
    
    
  </entry>
  
  <entry>
    <title>RxJava æºç è§£æ â€”â€” Observable#defer(...)</title>
    <link href="http://www.iocoder.cn/RxJava/observable-defer/"/>
    <id>http://www.iocoder.cn/RxJava/observable-defer/</id>
    <published>2018-12-31T16:00:00.000Z</published>
    <updated>2017-11-01T18:47:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/observable-defer/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬</strong></p><p>æœ¬ç³»åˆ—å†™ä½œç›®çš„ï¼Œä¸ºäº†è¾…åŠ© Hystrix çš„ç†è§£ï¼Œå› æ­¤ä¼šè¾ƒä¸ºé›¶æ•£ä¸çç¢ï¼Œæœ›è§è°…è§è°…ã€‚</p><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p>åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ Observable æ˜¯<strong>åŠ¨æ€</strong>çš„ï¼Œä¾‹å¦‚è¯´ï¼Œ<a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹</a> åˆ†äº«çš„ç¼“å­˜ Observable ï¼Œæ— æ³•åœ¨åˆ›å»º Observable é˜¶æ®µå°±çŸ¥é“æ˜¯å¦æœ‰ç¼“å­˜ï¼Œé€šè¿‡ <code>Observable#defer(...)</code> æ–¹æ³•ï¼Œå£°æ˜<strong>åŠ¨æ€</strong>çš„ Observable ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">   Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;String&gt;&gt;() &#123; <span class="comment">// #defer(...)</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> Observable&lt;String&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">           String name = Math.random() &gt; <span class="number">0.5</span> ? <span class="string">"å°æ˜"</span> : <span class="string">"å°è´¾"</span>; <span class="comment">// éšæœºåå­—</span></div><div class="line">           <span class="keyword">return</span> Observable.just(name);</div><div class="line">       &#125;</div><div class="line">   &#125;).subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123; <span class="comment">// #subscribe(...)</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">           System.out.println(s);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><hr><p><code>Observable#defer(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Observable.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">defer</span><span class="params">(Func0&lt;Observable&lt;T&gt;&gt; observableFactory)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> create(<span class="keyword">new</span> OnSubscribeDefer&lt;T&gt;(observableFactory));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Observable&lt;T&gt;(RxJavaHooks.onCreate(f));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ä¼ å…¥ <code>observableFactory</code> å‚æ•°ï¼Œç”Ÿæˆ<strong>åŠ¨æ€</strong>çš„ Observable ã€‚</li></ul><hr><p>OnSubscribeDefer ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSubscribeDefer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> Func0&lt;? extends Observable&lt;? extends T&gt;&gt; observableFactory;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnSubscribeDefer</span><span class="params">(Func0&lt;? extends Observable&lt;? extends T&gt;&gt; observableFactory)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.observableFactory = observableFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</div><div class="line">        Observable&lt;? extends T&gt; o;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            o = observableFactory.call();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            Exceptions.throwOrReport(t, s);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        o.unsafeSubscribe(Subscribers.wrap(s));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <code>Observable#subscribe(...)</code> æ–¹æ³•è°ƒç”¨æ—¶ï¼Œè°ƒç”¨ <code>OnSubscribeDefer#call(...)</code> æ–¹æ³• ï¼š<ul><li>è°ƒç”¨ <code>Func0#call()</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>åŠ¨æ€</strong>çš„ Observable ã€‚</li><li>è°ƒç”¨ <code>Observable#unsafeSubscribe(...)</code> æ–¹æ³•ï¼Œ<strong>ç»§ç»­è®¢é˜…é€»è¾‘</strong>ã€‚</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/RxJava/observable-defer/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº RxJava 1.2.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æœ¬ç³»åˆ—å†™ä½œç›®çš„
      
    
    </summary>
    
      <category term="RxJava" scheme="http://www.iocoder.cn/categories/RxJava/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” å‘½ä»¤åˆå¹¶æ‰§è¡Œ</title>
    <link href="http://www.iocoder.cn/Hystrix/command-collapser-execute/"/>
    <id>http://www.iocoder.cn/Hystrix/command-collapser-execute/</id>
    <published>2018-11-03T16:00:00.000Z</published>
    <updated>2017-11-08T12:23:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-collapser-execute/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2. HystrixCollapser</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2.1 æ„é€ æ–¹æ³•</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2.2 æ‰§è¡Œå‘½ä»¤æ–¹å¼</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">2.3 æ ¸å¿ƒæ–¹æ³•</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">3. RequestCollapserFactory</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4. RequestCollapser</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.1 æ„é€ æ–¹æ³•</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.2 RequestBatch</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.3 #submitRequest(arg)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">5. CollapserTimer</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">5.1 RealCollapserTimer</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">5.2 CollapsedTask</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-collapser-execute/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix å‘½ä»¤åˆå¹¶æ‰§è¡Œ</strong>ã€‚</p><p>åœ¨ <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E8%AF%B7%E6%B1%82%E5%90%88%E5%B9%B6" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œè¯·æ±‚åˆå¹¶ã€</a> ä¸­ï¼Œå¯¹ Hystrix å‘½ä»¤åˆå¹¶æ‰§è¡Œçš„<strong>æ¦‚å¿µ</strong>ã€<strong>åŸç†</strong>ã€<strong>ä½¿ç”¨åœºæ™¯</strong>ã€<strong>ä¼˜ç¼ºç‚¹</strong>å·²ç»åšäº†éå¸¸è¯¦ç»†é€å½»çš„åˆ†äº«ï¼Œæ‰€ä»¥èƒ–å‹å¯ä»¥å…ˆè®¤çœŸé˜…è¯»å­¦ä¹ ä¸‹ã€‚</p><p>å‘½ä»¤åˆå¹¶æ‰§è¡Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ ï¼š</p><blockquote><p>FROM <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E8%AF%B7%E6%B1%82%E5%90%88%E5%B9%B6" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œè¯·æ±‚åˆå¹¶ã€</a><br><img src="http://www.iocoder.cn/images/Hystrix/2018_11_04/01.jpeg" alt=""></p></blockquote><ul><li>ç¬¬ä¸€æ­¥ï¼Œæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—( RequestQueue )</li><li>ç¬¬äºŒéƒ¨ï¼Œå®šæ—¶ä»»åŠ¡( TimerTask ) <strong>å›ºå®šå‘¨æœŸ</strong>ä»è¯·æ±‚é˜Ÿåˆ—è·å–<strong>å¤šä¸ª</strong>å‘½ä»¤æ‰§è¡Œï¼Œåˆå¹¶æ‰§è¡Œã€‚</li></ul><p>åœ¨å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandCollapserGetValueForKey.java" rel="external nofollow noopener noreferrer" target="_blank">CommandCollapserGetValueForKey</a> ç†Ÿæ‚‰å‘½ä»¤åˆå¹¶æ‰§è¡Œçš„ä½¿ç”¨ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. HystrixCollapser</h1><p><code>com.netflix.hystrix.HystrixCollapser</code> ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨<strong>æŠ½è±¡çˆ¶ç±»</strong>ã€‚</p><blockquote><p>NOTE ï¼š<code>com.netflix.hystrix.HystrixObservableCollapser</code> ï¼Œ<strong>å¦ä¸€ç§</strong>å‘½ä»¤åˆå¹¶å™¨<strong>æŠ½è±¡çˆ¶ç±»</strong>ï¼Œæœ¬æ–‡æš‚ä¸è§£æã€‚</p></blockquote><h2>2.1 æ„é€ æ–¹æ³•</h2><p>HystrixCollapser <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCollapser</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt;</span></div><div class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">HystrixExecutable</span>&lt;<span class="title">ResponseType</span>&gt;, <span class="title">HystrixObservable</span>&lt;<span class="title">ResponseType</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestCollapserFactory&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; collapserFactory;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixRequestCache requestCache;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; collapserInstanceWrapper;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserMetrics metrics;</div><div class="line">    </div><div class="line">    <span class="comment">/* package for tests */</span> HystrixCollapser(HystrixCollapserKey collapserKey, Scope scope, CollapserTimer timer, HystrixCollapserProperties.Setter propertiesBuilder, HystrixCollapserMetrics metrics) &#123;</div><div class="line">        <span class="keyword">if</span> (collapserKey == <span class="keyword">null</span> || collapserKey.name().trim().equals(<span class="string">""</span>)) &#123;</div><div class="line">            String defaultKeyName = getDefaultNameFromClass(getClass());</div><div class="line">            collapserKey = HystrixCollapserKey.Factory.asKey(defaultKeyName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        HystrixCollapserProperties properties = HystrixPropertiesFactory.getCollapserProperties(collapserKey, propertiesBuilder);</div><div class="line">        <span class="keyword">this</span>.collapserFactory = <span class="keyword">new</span> RequestCollapserFactory&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;(collapserKey, scope, timer, properties);</div><div class="line">        <span class="keyword">this</span>.requestCache = HystrixRequestCache.getInstance(collapserKey, HystrixPlugins.getInstance().getConcurrencyStrategy());</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (metrics == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.metrics = HystrixCollapserMetrics.getInstance(collapserKey, properties);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.metrics = metrics;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> HystrixCollapser&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">         <span class="comment">/* strategy: HystrixMetricsPublisherCollapser */</span></div><div class="line">        HystrixMetricsPublisherFactory.createOrRetrievePublisherForCollapser(collapserKey, <span class="keyword">this</span>.metrics, properties);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * Used to pass public method invocation to the underlying implementation in a separate package while leaving the methods 'protected' in this class.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        collapserInstanceWrapper = <span class="keyword">new</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shardRequests(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests) &#123;</div><div class="line">                Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shards = self.shardRequests(requests);</div><div class="line">                self.metrics.markShards(shards.size());</div><div class="line">                <span class="keyword">return</span> shards;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;BatchReturnType&gt; <span class="title">createObservableCommand</span><span class="params">(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span> </span>&#123;</div><div class="line">                <span class="keyword">final</span> HystrixCommand&lt;BatchReturnType&gt; command = self.createCommand(requests);</div><div class="line"></div><div class="line">                command.markAsCollapsedCommand(<span class="keyword">this</span>.getCollapserKey(), requests.size());</div><div class="line">                self.metrics.markBatch(requests.size());</div><div class="line"></div><div class="line">                <span class="keyword">return</span> command.toObservable();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;Void&gt; <span class="title">mapResponseToRequests</span><span class="params">(Observable&lt;BatchReturnType&gt; batchResponse, <span class="keyword">final</span> Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> batchResponse.single().doOnNext(<span class="keyword">new</span> Action1&lt;BatchReturnType&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(BatchReturnType batchReturnType)</span> </span>&#123;</div><div class="line">                        <span class="comment">// this is a blocking call in HystrixCollapser</span></div><div class="line">                        self.mapResponseToRequests(batchReturnType, requests);</div><div class="line">                    &#125;</div><div class="line">                &#125;).ignoreElements().cast(Void.class);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> HystrixCollapserKey <span class="title">getCollapserKey</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> self.getCollapserKey();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>BatchReturnType <strong>æ³›å‹</strong>ï¼Œ<strong>å¤šä¸ª</strong>å‘½ä»¤åˆå¹¶æ‰§è¡Œè¿”å›ç»“æœç±»å‹ã€‚</li><li>ResponseType <strong>æ³›å‹</strong>ï¼Œ<strong>å•ä¸ª</strong>å‘½ä»¤æ‰§è¡Œè¿”å›ç»“æœç±»å‹ã€‚</li><li>RequestArgumentType <strong>æ³›å‹</strong>ï¼Œ<strong>å•ä¸ª</strong>å‘½ä»¤å‚æ•°ç±»å‹ã€‚</li><li><code>collapserFactory</code> å±æ€§ï¼ŒRequestCollapser <strong>å·¥å‚</strong>ï¼Œåœ¨ <a href="#">ã€Œ3. RequestCollapserFactoryã€</a> è¯¦ç»†è§£æã€‚</li><li><code>requestCache</code> å±æ€§ï¼ŒTODO ã€2012ã€‘ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘</li><li><code>collapserInstanceWrapper</code> å±æ€§ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨åŒ…è£…å™¨ã€‚<ul><li><code>com.netflix.hystrix.collapser.HystrixCollapserBridge</code> <strong>æ¥å£</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/HystrixCollapserBridge.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>HystrixCollapserBridge ï¼Œä¸º RequestBatch <strong>é€æ˜</strong>è°ƒç”¨ HystrixCollapser æˆ– HystrixObservableCollapser çš„æ–¹æ³•ä¸åŒçš„å®ç°ã€‚å‚è§ <a href="http://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/bridge.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ¡¥æ¥æ¨¡å¼ã€‹</a> ã€‚</li></ul></li><li><code>metrics</code> å±æ€§ï¼ŒTODO ã€2002ã€‘ã€metricsã€‘</li></ul><h2>2.2 æ‰§è¡Œå‘½ä»¤æ–¹å¼</h2><p>åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-mode/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œå‘½ä»¤æ–¹å¼ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹äº† HystrixCommand æä¾›çš„<strong>å››ç§</strong>æ‰§è¡Œå‘½ä»¤æ–¹å¼ã€‚</p><p>HystrixCollapser ç±»ä¼¼äº HystrixCommand ï¼Œä¹Ÿæä¾›<strong>å››ç§</strong>ç›¸åŒçš„æ‰§è¡Œå‘½ä»¤æ–¹å¼ï¼Œå…¶ä¸­å¦‚ä¸‹ä¸‰ç§æ–¹å¼ä»£ç åŸºæœ¬<strong>ç±»ä¼¼</strong>ï¼Œæˆ‘ä»¬å°±ç»™ä¸‹<strong>ä¼ é€é—¨</strong>ï¼Œå°±ä¸é‡å¤å•°å—¦äº† ï¼š</p><ul><li><code>#observe()</code> æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L336" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ã€‚</li><li><code>#queue()</code> æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L456" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ã€‚</li><li><code>#execute()</code> æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L426" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ã€‚</li></ul><p>ä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹ <code>#toObservable()</code> æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// when we callback with the data we want to do the work</span></div><div class="line"> <span class="number">3</span>:     <span class="comment">// on a separate thread than the one giving us the callback</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">return</span> toObservable(Schedulers.computation());</div><div class="line"> <span class="number">5</span>: &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">toObservable</span><span class="params">(Scheduler observeOn)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;ResponseType&gt;&gt;() &#123;</div><div class="line"> <span class="number">9</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">10</span>:         <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">11</span>:             <span class="comment">// // ç¼“å­˜å¼€å…³ã€ç¼“å­˜KEY</span></div><div class="line"><span class="number">12</span>:             <span class="keyword">final</span> <span class="keyword">boolean</span> isRequestCacheEnabled = getProperties().requestCacheEnabled().get();</div><div class="line"><span class="number">13</span>:             <span class="keyword">final</span> String cacheKey = getCacheKey();</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:             <span class="comment">// ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–</span></div><div class="line"><span class="number">16</span>:             <span class="comment">/* try from cache first */</span></div><div class="line"><span class="number">17</span>:             <span class="keyword">if</span> (isRequestCacheEnabled) &#123;</div><div class="line"><span class="number">18</span>:                 HystrixCachedObservable&lt;ResponseType&gt; fromCache = requestCache.get(cacheKey);</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (fromCache != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:                     metrics.markResponseFromCache();</div><div class="line"><span class="number">21</span>:                     <span class="keyword">return</span> fromCache.toObservable();</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:             &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:             <span class="comment">// è·å¾— RequestCollapser</span></div><div class="line"><span class="number">26</span>:             RequestCollapser&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; requestCollapser = collapserFactory.getRequestCollapser(collapserInstanceWrapper);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:             <span class="comment">// æäº¤ å‘½ä»¤è¯·æ±‚</span></div><div class="line"><span class="number">29</span>:             Observable&lt;ResponseType&gt; response = requestCollapser.submitRequest(getRequestArgument());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:             <span class="comment">// è·å¾— ç¼“å­˜Observable</span></div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (isRequestCacheEnabled &amp;&amp; cacheKey != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">33</span>:                 HystrixCachedObservable&lt;ResponseType&gt; toCache = HystrixCachedObservable.from(response);</div><div class="line"><span class="number">34</span>:                 HystrixCachedObservable&lt;ResponseType&gt; fromCache = requestCache.putIfAbsent(cacheKey, toCache);</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (fromCache == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">36</span>:                     <span class="keyword">return</span> toCache.toObservable();</div><div class="line"><span class="number">37</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>:                     toCache.unsubscribe(); <span class="comment">// å–æ¶ˆè®¢é˜…</span></div><div class="line"><span class="number">39</span>:                     <span class="keyword">return</span> fromCache.toObservable();</div><div class="line"><span class="number">40</span>:                 &#125;</div><div class="line"><span class="number">41</span>:             &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:             <span class="comment">// è·å¾— éç¼“å­˜Observable</span></div><div class="line"><span class="number">44</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">45</span>:         &#125;</div><div class="line"><span class="number">46</span>:     &#125;);</div><div class="line"><span class="number">47</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>observeOn</code> æ–¹æ³•å‚æ•°ï¼Œå®é™…æ–¹æ³•æš‚æœªç”¨åˆ°ï¼Œè·³è¿‡æ— è§†ã€‚</li><li>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šç¼“å­˜å­˜å¼€å…³ã€KEY ã€‚</li><li>ã€<em>åå‘</em>ã€‘ç¬¬ 32 è‡³ 41 è¡Œ ï¼šè·å¾—ã€ç¼“å­˜ Observableã€‘ã€‚è¿™å—ä»£ç å’Œ <code>AbstractCommand#toObservavle(...)</code> ç±»ä¼¼ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹ã€Œ4. AbstractCommand#toObservavle(...)ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ã€<em>åå‘</em>ã€‘ç¬¬ 44 è¡Œ ï¼šè·å¾—ã€éç¼“å­˜ Observableã€‘ã€‚</li><li>æ³¨æ„ ï¼šè¿”å›çš„ Observable ï¼Œå¾ˆå¯èƒ½å‘½ä»¤å®é™…å¹¶æœªæ‰§è¡Œï¼Œæˆ–è€…è¯´å¹¶æœªæ‰§è¡Œå®Œæˆï¼Œæ­¤æ—¶åœ¨ <code>#queue()</code> / <code>#execute()</code> æ–¹æ³•ï¼Œé€šè¿‡ BlockingObservable <strong>é˜»å¡</strong>ç­‰å¾…æ‰§è¡Œå®Œæˆã€‚BlockingObservable åœ¨ <a href="http://www.iocoder.cn/RxJava/blocking-observable/?self">ã€ŠRxJava æºç è§£æ â€”â€” BlockingObservableã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>RequestCollapserFactory#getRequestCollapser()</code> ï¼Œè·å¾— RequestCollapser ã€‚åœ¨ <a href="#">ã€Œ3. RequestCollapserFactoryã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 29 è¡Œ ï¼šæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—( RequestQueue )ï¼Œå³<strong>å‘½ä»¤åˆå¹¶æ‰§è¡Œæ•´ä½“æµç¨‹ç¬¬ä¸€æ­¥</strong>ã€‚åœ¨ <a href="#">ã€Œ4. RequestCollapserã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>2.3 æ ¸å¿ƒæ–¹æ³•</h2><ul><li><p><code>#getRequestArgument(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—<strong>å•ä¸ª</strong>å‘½ä»¤å‚æ•°ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> RequestArgumentType <span class="title">getRequestArgument</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p></li></ul><hr><ul><li><p><code>#createCommand(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆå¹¶</strong>ï¼Œåˆ›å»º<strong>ä¸€ä¸ª</strong> HystrixCommand ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> HystrixCommand&lt;BatchReturnType&gt; <span class="title">createCommand</span><span class="params">(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span></span>;</div></pre></td></tr></table></figure></p></li></ul><hr><ul><li><p><code>#mapResponseToRequests(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå°†<strong>ä¸€ä¸ª</strong> HystrixCommand çš„æ‰§è¡Œç»“æœï¼Œ<strong>æ˜ å°„</strong>å›å¯¹åº”çš„å‘½ä»¤è¯·æ±‚ä»¬ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">mapResponseToRequests</span><span class="params">(BatchReturnType batchResponse, Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests)</span></span>;</div></pre></td></tr></table></figure></p></li></ul><hr><ul><li><p><code>#shardRequests(...)</code> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆ†ç‰‡</strong>æˆ <strong>N</strong> ä¸ªã€<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‘ã€‚é»˜è®¤å®ç°ä¸‹ï¼Œä¸è¿›è¡Œåˆ†ç‰‡ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shardRequests(Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; requests) &#123;</div><div class="line">    <span class="keyword">return</span> Collections.singletonList(requests);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><ul><li><p>åœ¨<strong>æœªé‡å†™</strong> <code>#shardRequests(...)</code> çš„æƒ…å†µä¸‹ï¼Œæ•´ä½“æ–¹æ³•æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_11_04/02.png" alt=""></p></li><li><p>åœ¨<strong>é‡å†™</strong> <code>#shardRequests(...)</code> çš„æƒ…å†µä¸‹ï¼Œæ•´ä½“æ–¹æ³•æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_11_04/03.png" alt=""></p><ul><li>æœ¬å›¾ä¸­å‘½ä»¤è¯·æ±‚åˆ†ç‰‡ä»…ä»…æ˜¯ä¾‹å­ï¼Œå®é™…æ ¹æ®é‡å†™çš„é€»è¾‘ä¸åŒè€Œä¸åŒã€‚</li></ul></li></ul><h1>3. RequestCollapserFactory</h1><p><code>com.netflix.hystrix.collapser.RequestCollapserFactory</code> ï¼ŒRequestCollapser <strong>å·¥å‚</strong>ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCollapserFactory</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt; </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CollapserTimer timer;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserKey collapserKey;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserProperties properties;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixConcurrencyStrategy concurrencyStrategy;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scope scope;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestCollapserFactory</span><span class="params">(HystrixCollapserKey collapserKey, Scope scope, CollapserTimer timer, HystrixCollapserProperties properties)</span> </span>&#123;</div><div class="line">         <span class="comment">/* strategy: ConcurrencyStrategy */</span></div><div class="line">        <span class="keyword">this</span>.concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</div><div class="line">        <span class="keyword">this</span>.timer = timer;</div><div class="line">        <span class="keyword">this</span>.scope = scope;</div><div class="line">        <span class="keyword">this</span>.collapserKey = collapserKey;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p><ul><li><code>timer</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨ï¼Œåœ¨ <a href="#">ã€Œ5. CollapserTimerã€</a> è¯¦ç»†è§£æã€‚</li><li><code>collapserKey</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨æ ‡è¯†ï¼Œå®ç°ç±»ä¼¼ HystrixThreadPoolKey ã€‚<ul><li>HystrixCollapserKey ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapserKey.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>HystrixThreadPoolKey ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹ã€Œ3. HystrixThreadPoolKeyã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><code>properties</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨å±æ€§é…ç½®ã€‚</li><li><code>concurrencyStrategy</code> å±æ€§ï¼Œå¹¶å‘ç­–ç•¥ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹ã€Œ4. HystrixConcurrencyStrategyã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>scope</code> å±æ€§ï¼Œå‘½ä»¤è¯·æ±‚ä½œç”¨åŸŸã€‚ç›®å‰æœ‰ä¸¤ç§ä½œç”¨åŸŸ ï¼š<ul><li><p><code>REQUEST</code> ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡( HystrixRequestContext )ã€‚</p><blockquote><p>Typically this means that requests within a single user-request (ie. HTTP request) are collapsed.<br>No interaction with other user requests.<br>1 queue per user request.* <code>GLOBAL</code> ï¼šå…¨å±€ã€‚</p></blockquote><blockquote><p>Requests from any thread (ie. all HTTP requests) within the JVM will be collapsed.<br>1 queue for entire app.</p></blockquote></li></ul></li></ul><hr><p>è°ƒç”¨ <code>#getRequestCollapser()</code> æ–¹æ³•ï¼Œè·å¾— RequestCollapser ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestCollapser&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; <span class="title">getRequestCollapser</span><span class="params">(HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (Scopes.REQUEST == Scopes.valueOf(getScope().name())) &#123;</div><div class="line">       <span class="keyword">return</span> getCollapserForUserRequest(commandCollapser);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Scopes.GLOBAL == Scopes.valueOf(getScope().name())) &#123;</div><div class="line">       <span class="keyword">return</span> getCollapserForGlobalScope(commandCollapser);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.warn(<span class="string">"Invalid Scope: &#123;&#125;  Defaulting to REQUEST scope."</span>, getScope());</div><div class="line">       <span class="keyword">return</span> getCollapserForUserRequest(commandCollapser);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ ¹æ® <code>scope</code> ä¸åŒï¼Œè°ƒç”¨ä¸¤ä¸ªä¸åŒæ–¹æ³•ï¼Œè·å¾— RequestCollapser ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•å¤§ä½“é€»è¾‘ç›¸åŒï¼Œä¼˜å…ˆä»<strong>ç¼“å­˜</strong>ä¸­æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„ RequestCollapser è¿”å›ï¼›è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ»¡è¶³æ¡ä»¶çš„ RequestCollapser æ·»åŠ åˆ°<strong>ç¼“å­˜</strong>å¹¶è¿”å›ã€‚<ul><li><code>REQUEST</code> ï¼šè°ƒç”¨ <code>#getCollapserForUserRequest()</code> æ–¹æ³•ï¼ŒTODO ã€2012ã€‘ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘ã€‚</li><li><code>GLOBAL</code> ï¼šè°ƒç”¨ <code>#getCollapserForGlobalScope()</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/RequestCollapserFactory.java#L97" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹<strong>ä¸­æ–‡æ³¨é‡Š</strong>çš„ä»£ç ã€‚</li></ul></li></ul><h1>4. RequestCollapser</h1><p><code>com.netflix.hystrix.collapser.RequestCollapser</code> ï¼Œ<strong>å‘½ä»¤è¯·æ±‚</strong>åˆå¹¶å™¨ã€‚ä¸»è¦ç”¨äº ï¼š</p><ul><li>æäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ°è¯·æ±‚é˜Ÿåˆ—( RequestQueue )ã€‚</li><li>æ¥æ”¶<strong>æ¥è‡ªå®šæ—¶ä»»åŠ¡</strong>æäº¤çš„<strong>å¤šä¸ª</strong>å‘½ä»¤ï¼Œåˆå¹¶æ‰§è¡Œã€‚</li></ul><h2>4.1 æ„é€ æ–¹æ³•</h2><p>RequestCollapser <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCollapser</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser;</div><div class="line">    <span class="comment">// batch can be null once shutdown</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;&gt; batch = <span class="keyword">new</span> AtomicReference&lt;RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Reference&lt;TimerListener&gt;&gt; timerListenerReference = <span class="keyword">new</span> AtomicReference&lt;Reference&lt;TimerListener&gt;&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean timerListenerRegistered = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CollapserTimer timer;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserProperties properties;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixConcurrencyStrategy concurrencyStrategy;</div><div class="line">    </div><div class="line">    RequestCollapser(HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser, HystrixCollapserProperties properties, CollapserTimer timer, HystrixConcurrencyStrategy concurrencyStrategy) &#123;</div><div class="line">        <span class="keyword">this</span>.commandCollapser = commandCollapser; <span class="comment">// the command with implementation of abstract methods we need </span></div><div class="line">        <span class="keyword">this</span>.concurrencyStrategy = concurrencyStrategy;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">        <span class="keyword">this</span>.timer = timer;</div><div class="line">        batch.set(<span class="keyword">new</span> RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;(properties, commandCollapser, properties.maxRequestsInBatch().get()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>commandCollapser</code> å±æ€§ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨åŒ…è£…å™¨ã€‚</li><li><code>batch</code> å±æ€§ï¼ŒRequestBatchï¼Œ<strong>å³æ˜¯æœ¬æ–‡ä¸€ç›´è¯´çš„è¯·æ±‚é˜Ÿåˆ—</strong>ã€‚åœ¨ <a href="#">ã€Œ4.2 RequestBatchã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li><li><code>timerListenerReference</code> å±æ€§ï¼Œ<strong>æ³¨å†Œ</strong>åœ¨å‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨çš„ç›‘å¬å™¨ã€‚æ¯ä¸ª  RequestCollapser <strong>ç‹¬æœ‰ä¸€ä¸ª</strong>ç›‘å¬å™¨ã€‚è¯¥ç›‘å¬å™¨( å®é™…ä¸Šä¼šä½¿ç”¨è¯¥ç›‘å¬å™¨åˆ›å»ºå®šæ—¶ä»»åŠ¡ )<strong>å›ºå®šå‘¨æœŸ</strong>ä»è¯·æ±‚é˜Ÿåˆ—è·å–<strong>å¤šä¸ª</strong>å‘½ä»¤æ‰§è¡Œï¼Œæäº¤ RequestCollapser åˆå¹¶æ‰§è¡Œã€‚åœ¨ <a href="#">ã€Œ5. CollapserTimerã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li><li><code>timerListenerRegistered</code> å±æ€§ï¼Œ<code>timerListenerReference</code> æ˜¯å¦å·²ç»æ³¨å†Œã€‚</li><li><code>timer</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨ã€‚</li><li><code>properties</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨å±æ€§é…ç½®ã€‚</li><li><code>concurrencyStrategy</code> å±æ€§ï¼Œå¹¶å‘ç­–ç•¥ã€‚</li></ul><h2>4.2 RequestBatch</h2><p><code>com.netflix.hystrix.collapser.RequestBatch</code> ï¼Œå‘½ä»¤è¯·æ±‚é˜Ÿåˆ—ã€‚æä¾›å¦‚ä¸‹åŠŸèƒ½ ï¼š</p><ul><li>å‘½ä»¤è¯·æ±‚çš„æ·»åŠ </li><li>å‘½ä»¤è¯·æ±‚çš„ç§»é™¤</li><li>å‘½ä»¤è¯·æ±‚çš„<strong>æ‰¹é‡æ‰§è¡Œ</strong>ã€‚ç¬”è€…æŠŠ RequestBatch è§£é‡Šæˆ &quot;å‘½ä»¤è¯·æ±‚é˜Ÿåˆ—&quot;ï¼Œä¸»è¦æ–¹ä¾¿å¤§å®¶ç†è§£ã€‚<ul><li>é‚£å¯èƒ½æœ‰èƒ–å‹æœ‰ç–‘é—®ï¼Œä¸ºå•¥è¯¥åŠŸèƒ½ä¸åœ¨ RequestCollapser ç›´æ¥å®ç°ï¼Œè¿™æ · RequestBatch æˆä¸ºçº¯ç²¹çš„é˜Ÿåˆ—å‘¢ï¼Ÿåœ¨ <a href="#">ã€Œ4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><p>RequestBatch <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBatch</span>&lt;<span class="title">BatchReturnType</span>, <span class="title">ResponseType</span>, <span class="title">RequestArgumentType</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBatchSize;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean batchStarted = <span class="keyword">new</span> AtomicBoolean();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;RequestArgumentType, CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; argumentMap =</div><div class="line">            <span class="keyword">new</span> ConcurrentHashMap&lt;RequestArgumentType, CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixCollapserProperties properties;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ReentrantReadWriteLock batchLock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestBatch</span><span class="params">(HystrixCollapserProperties properties, HystrixCollapserBridge&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; commandCollapser, <span class="keyword">int</span> maxBatchSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.properties = properties;</div><div class="line">        <span class="keyword">this</span>.commandCollapser = commandCollapser;</div><div class="line">        <span class="keyword">this</span>.maxBatchSize = maxBatchSize;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>commandCollapser</code> å±æ€§ï¼Œ<strong>å‘½ä»¤</strong>åˆå¹¶å™¨åŒ…è£…å™¨ã€‚</li><li><code>maxBatchSize</code> å±æ€§ï¼Œé˜Ÿåˆ—æœ€å¤§é•¿åº¦ã€‚</li><li><code>batchStarted</code> å±æ€§ï¼Œæ‰§è¡Œæ˜¯å¦å¼€å§‹ã€‚</li><li><code>argumentMap</code> å±æ€§ï¼Œå‘½ä»¤è¯·æ±‚å‚æ•°æ˜ å°„( <strong>é˜Ÿåˆ—</strong> )ã€‚</li><li><code>properties</code> å±æ€§ï¼Œå‘½ä»¤åˆå¹¶å™¨å±æ€§é…ç½®ã€‚</li><li><code>batchLock</code> å±æ€§ï¼Œ<code>argumentMap</code> æ“ä½œçš„<strong>è¯»å†™é”</strong>ã€‚</li></ul><p>RequestBatch å®ç°é˜Ÿåˆ—å…·ä½“çš„æ“ä½œæ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ4.3 #submitRequest(arg)ã€</a>/<a href="#">ã€Œ4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)ã€</a> ä¸€èµ·è§£æã€‚</p><h2>4.3 #submitRequest(arg)</h2><p>åœ¨ <code>#toObservable()</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>#submitRequest(arg)</code> æ–¹æ³•ï¼Œæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ° RequestBatch ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt; <span class="title">submitRequest</span><span class="params">(<span class="keyword">final</span> RequestArgumentType arg)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/*</span></div><div class="line"><span class="comment"> 3:      * We only want the timer ticking if there are actually things to do so we register it the first time something is added.</span></div><div class="line"><span class="comment"> 4:      */</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (!timerListenerRegistered.get() &amp;&amp; timerListenerRegistered.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">/* schedule the collapsing task to be executed every x milliseconds (x defined inside CollapsedTask) */</span></div><div class="line"> <span class="number">7</span>:         timerListenerReference.set(timer.addListener(<span class="keyword">new</span> CollapsedTask()));</div><div class="line"> <span class="number">8</span>:     &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="comment">// loop until succeed (compare-and-set spin-loop)</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// è·å¾— RequestBatch</span></div><div class="line"><span class="number">13</span>:         <span class="keyword">final</span> RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; b = batch.get();</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (b == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"Submitting requests after collapser is shutdown"</span>));</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         <span class="comment">// æ·»åŠ åˆ° RequestBatch</span></div><div class="line"><span class="number">19</span>:         <span class="keyword">final</span> Observable&lt;ResponseType&gt; response;</div><div class="line"><span class="number">20</span>:         <span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:             response = b.offer(arg);</div><div class="line"><span class="number">22</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">23</span>:             response = b.offer( (RequestArgumentType) NULL_SENTINEL);</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="comment">// æ·»åŠ æˆåŠŸï¼Œè¿”å› Observable</span></div><div class="line"><span class="number">27</span>:         <span class="comment">// it will always get an Observable unless we hit the max batch size</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">30</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:             <span class="comment">// æ·»åŠ å¤±è´¥ï¼Œæ‰§è¡Œ RequestBatch ï¼Œå¹¶åˆ›å»ºæ–°çš„ RequestBatch</span></div><div class="line"><span class="number">32</span>:             <span class="comment">// this batch can't accept requests so create a new one and set it if another thread doesn't beat us</span></div><div class="line"><span class="number">33</span>:             createNewBatchAndExecutePreviousIfNeeded(b);</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šå½“ RequestCollapser çš„ç›‘å¬ä»»åŠ¡( CollapsedTask )è¿˜æœªåˆ›å»ºï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>ç¬¬ 11 è‡³ 35 è¡Œ ï¼š<strong>æ­»å¾ªç¯</strong>ï¼Œç›´åˆ°æäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ° RequestBatch <strong>æˆåŠŸ</strong>ã€‚<ul><li>ç¬¬ 13 è‡³ 16 è¡Œ ï¼šè·å¾— RequestBatch ã€‚ä»ç›®å‰ä»£ç çœ‹ä¸‹æ¥ï¼Œé™¤é RequestCollapser è¢« <code>#shutdown()</code> åæ‰ä¼šå‡ºç°ä¸º <code>null</code> çš„æƒ…å†µã€‚</li><li>ç¬¬ 19 è‡³ 24 è¡Œ ï¼šè°ƒåŠ¨ <code>RequestBatch#offer(...)</code> æ–¹æ³•ï¼Œæäº¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚åˆ° RequestBatch ï¼Œå¹¶è·å¾— Observable ã€‚è¿™é‡Œå¯¹ <code>arg == null</code> åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸º <code>RequestBatch.argumentMap</code> æ˜¯ ConcurrentHashMap ï¼Œä¸å…è®¸å€¼ä¸º <code>null</code> ã€‚å¦å¤–ï¼Œ<code>RequestBatch#offer(...)</code> æ–¹æ³•çš„å®ç°ä»£ç ï¼Œåœ¨ç»“æŸäº†å½“å‰æ–¹æ³•ï¼Œè¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šæ·»åŠ æˆåŠŸï¼Œè¿”å› Observable ã€‚</li><li>ç¬¬ 30 è‡³ 34 è¡Œ ï¼šæ·»åŠ å¤±è´¥ï¼Œæ‰§è¡Œå½“å‰ RequestBatch çš„<strong>å¤šä¸ª</strong>å‘½ä»¤åˆå¹¶æ‰§è¡Œï¼Œå¹¶åˆ›å»º<strong>æ–°çš„</strong> RequestBatch ã€‚åœ¨ <a href="#">ã€Œ4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)ã€</a>   è¯¦ç»†è§£æã€‚</li></ul></li></ul><hr><p><code>RequestBatch#offer(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;ResponseType&gt;  <span class="title">offer</span><span class="params">(RequestArgumentType arg)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// æ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥</span></div><div class="line"> <span class="number">3</span>:     <span class="comment">/* short-cut - if the batch is started we reject the offer */</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">/*</span></div><div class="line"><span class="comment"> 9:      * The 'read' just means non-exclusive even though we are writing.</span></div><div class="line"><span class="comment">10:      */</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (batchLock.readLock().tryLock()) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="comment">// æ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥</span></div><div class="line"><span class="number">14</span>:             <span class="comment">/* double-check now that we have the lock - if the batch is started we reject the offer */</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:             <span class="comment">// è¶…è¿‡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œæ·»åŠ å¤±è´¥</span></div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (argumentMap.size() &gt;= maxBatchSize) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">22</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">23</span>:                 <span class="comment">// åˆ›å»º CollapsedRequestSubject ï¼Œå¹¶æ·»åŠ åˆ°é˜Ÿåˆ—</span></div><div class="line"><span class="number">24</span>:                 CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt; collapsedRequest = <span class="keyword">new</span> CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;(arg, <span class="keyword">this</span>);</div><div class="line"><span class="number">25</span>:                 <span class="keyword">final</span> CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt; existing = (CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;) argumentMap.putIfAbsent(arg, collapsedRequest);</div><div class="line"><span class="number">26</span>:                 <span class="comment">/**</span></div><div class="line"><span class="comment">27:                  * If the argument already exists in the batch, then there are 2 options:</span></div><div class="line"><span class="comment">28:                  * A) If request caching is ON (the default): only keep 1 argument in the batch and let all responses</span></div><div class="line"><span class="comment">29:                  * be hooked up to that argument</span></div><div class="line"><span class="comment">30:                  * B) If request caching is OFF: return an error to all duplicate argument requests</span></div><div class="line"><span class="comment">31:                  *</span></div><div class="line"><span class="comment">32:                  * This maintains the invariant that each batch has no duplicate arguments.  This prevents the impossible</span></div><div class="line"><span class="comment">33:                  * logic (in a user-provided mapResponseToRequests for HystrixCollapser and the internals of HystrixObservableCollapser)</span></div><div class="line"><span class="comment">34:                  * of trying to figure out which argument of a set of duplicates should get attached to a response.</span></div><div class="line"><span class="comment">35:                  *</span></div><div class="line"><span class="comment">36:                  * See https://github.com/Netflix/Hystrix/pull/1176 for further discussion.</span></div><div class="line"><span class="comment">37:                  */</span></div><div class="line"><span class="number">38</span>:                 <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">39</span>:                     <span class="keyword">boolean</span> requestCachingEnabled = properties.requestCacheEnabled().get();</div><div class="line"><span class="number">40</span>:                     <span class="keyword">if</span> (requestCachingEnabled) &#123;</div><div class="line"><span class="number">41</span>:                         <span class="keyword">return</span> existing.toObservable();</div><div class="line"><span class="number">42</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">43</span>:                         <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalArgumentException(<span class="string">"Duplicate argument in collapser batch : ["</span> + arg + <span class="string">"]  This is not supported.  Please turn request-caching on for HystrixCollapser:"</span> + commandCollapser.getCollapserKey().name() + <span class="string">" or prevent duplicates from making it into the batch!"</span>));</div><div class="line"><span class="number">44</span>:                     &#125;</div><div class="line"><span class="number">45</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">46</span>:                     <span class="keyword">return</span> collapsedRequest.toObservable();</div><div class="line"><span class="number">47</span>:                 &#125;</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:             &#125;</div><div class="line"><span class="number">50</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">51</span>:             batchLock.readLock().unlock();</div><div class="line"><span class="number">52</span>:         &#125;</div><div class="line"><span class="number">53</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">54</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 6 è¡Œ ï¼šæ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥ã€‚åœ¨ <code>RequestBatch#executeBatchIfNotAlreadyStarted(...)</code> æ–¹æ³•çš„å¼€å¤´ï¼Œä¼˜å…ˆ <strong>CAS</strong> ä½¿ <code>batchStarted = true</code> ã€‚</p></li><li><p>ç¬¬ 11 è¡Œ ï¼šè·å¾—<strong>è¯»é”</strong>ã€‚<code>The 'read' just means non-exclusive even though we are writing.</code> ï¼Œå³ä½¿è¯¥æ–¹æ³•å®é™…åœ¨åš**&quot;å†™æ“ä½œ&quot;**ï¼Œä¸æ’ä»–ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨è¯»é”ã€‚</p></li><li><p>ç¬¬ 15 è‡³ 17 è¡Œ ï¼š<code>double-check</code>ï¼Œæ‰§è¡Œå·²ç»å¼€å§‹ï¼Œæ·»åŠ å¤±è´¥ã€‚åœ¨ <code>RequestBatch#executeBatchIfNotAlreadyStarted(...)</code> æ–¹æ³•ï¼Œä¼˜å…ˆ <strong>CAS</strong> ä½¿ <code>batchStarted = true</code>ï¼Œå†è·å–<strong>å†™é”</strong>ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¯¥æƒ…å†µã€‚</p></li><li><p>ç¬¬ 20 è‡³ 21 è¡Œ ï¼šè¶…è¿‡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œæ·»åŠ å¤±è´¥ã€‚</p></li><li><p>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º <code>com.netflix.hystrix.collapser.CollapsedRequestSubject</code> ï¼Œå¹¶å°†<strong>å®ƒ</strong>æ·»åŠ åˆ°é˜Ÿåˆ—( <code>argumentMap</code> ) ã€‚</p><ul><li><p>CollapsedRequestSubject å®ç° <code>com.netflix.hystrix.HystrixCollapser.CollapsedRequest</code> <strong>æ¥å£</strong>ï¼Œå®šä¹‰äº†æ‰¹é‡å‘½ä»¤æ‰§è¡Œçš„<strong>è¯·æ±‚</strong>ï¼Œä¸ä»…é™äºè·å¾—è¯·æ±‚å‚æ•°( <code>#getArgument()</code> æ–¹æ³• )ï¼Œä¹ŸåŒ…æ‹¬å¯¹æ‰¹é‡å‘½ä»¤æ‰§è¡Œç»“æŸåï¼Œæ¯ä¸ª<strong>è¯·æ±‚</strong>çš„ç»“æœè®¾ç½®( <code>#setResponse(...)</code>/<code>#emitResponse(...)</code>/<code>#setException(...)</code>/<code>#setComplete()</code> æ–¹æ³• )ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L512" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ¥å£çš„ä»£ç ã€‚</p></li><li><p>CollapsedRequestSubject <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package */</span><span class="class"><span class="keyword">class</span> <span class="title">CollapsedRequestSubject</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">CollapsedRequest</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> R argument;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç»“æœ( response ) æ˜¯å¦è®¾ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> AtomicBoolean valueSet = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯å›æ”¾çš„ ReplaySubject</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReplaySubject&lt;T&gt; subject = ReplaySubject.create();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¸¦è®¢é˜…æ•°é‡çš„ ReplaySubject</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Observable&lt;T&gt; subjectWithAccounting;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢é˜…æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> outstandingSubscriptions = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CollapsedRequestSubject</span><span class="params">(<span class="keyword">final</span> R arg, <span class="keyword">final</span> RequestBatch&lt;?, T, R&gt; containingBatch)</span> </span>&#123;</div><div class="line">        <span class="comment">// è®¾ç½® argument</span></div><div class="line">        <span class="keyword">if</span> (arg == RequestCollapser.NULL_SENTINEL) &#123;</div><div class="line">            <span class="keyword">this</span>.argument = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.argument = arg;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¾ç½® å¸¦è®¢é˜…æ•°é‡çš„ ReplaySubject</span></div><div class="line">        <span class="keyword">this</span>.subjectWithAccounting = subject</div><div class="line">                .doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">                        outstandingSubscriptions++;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .doOnUnsubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">                        outstandingSubscriptions--;</div><div class="line">                        <span class="keyword">if</span> (outstandingSubscriptions == <span class="number">0</span>) &#123;</div><div class="line">                            containingBatch.remove(arg);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>argument</code> å±æ€§ï¼Œ<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚å‚æ•°ã€‚</li><li><code>valueSet</code> å±æ€§ï¼Œç»“æœ( Response ) æ˜¯å¦è®¾ç½®ï¼Œé€šè¿‡ <code>#setResponse()</code>/<code>#emitResponse()</code> æ–¹æ³•è®¾ç½®ã€‚</li><li><code>subject</code> å±æ€§ï¼Œ<strong>å¯å›æ”¾æ‰§è¡Œç»“æœ</strong>çš„ Subject ã€‚æ­¤å¤„ä½¿ç”¨ ReplaySubject çš„ä¸»è¦ç›®çš„ï¼Œå½“ HystrixCollapser å¼€å¯<strong>ç¼“å­˜</strong>åŠŸèƒ½æ—¶ï¼Œé€šè¿‡å›æ”¾æ‰§è¡Œç»“æœï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹ã€Œ5. HystrixCachedObservableã€</a> ä¹Ÿæœ‰ç›¸åŒçš„å®ç°ã€‚å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼ŒReplaySubject å¹¶<strong>æ²¡æœ‰</strong>å‘ä»»ä½• Observable è®¢é˜…ç»“æœï¼Œ<strong>è€Œæ˜¯é€šè¿‡ <code>#setResponse()</code>/<code>#emitResponse()</code> æ–¹æ³•è®¾ç½®ç»“æœ</strong>ã€‚</li><li><code>outstandingSubscriptions</code> å±æ€§ï¼Œè®¢é˜…æ•°é‡ã€‚</li><li><code>subjectWithAccounting</code> å±æ€§ï¼Œå¸¦è®¢é˜…æ•°é‡çš„ ReplaySubject ã€‚å½“å–æ¶ˆè®¢é˜…æ—¶ï¼Œè°ƒç”¨ <code>RequestBatch#remove(arg)</code> æ–¹æ³•ï¼Œç§»é™¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 38 è‡³ 47 è¡Œ ï¼šè¿”å› Observable ã€‚</p><ul><li>å½“ <code>argumentMap</code> å·²ç»å­˜åœ¨ <code>arg</code> å¯¹åº”çš„ Observable æ—¶ï¼Œå¿…é¡»å¼€å¯ç¼“å­˜ ( <code>HystrixCollapserProperties.requestCachingEnabled = true</code> ) åŠŸèƒ½ã€‚åŸå› æ˜¯ï¼Œå¦‚æœåœ¨<strong>ç›¸åŒçš„</strong> <code>arg</code> ï¼Œå¹¶ä¸”æœªå¼€å¯ç¼“å­˜ï¼ŒåŒæ—¶<strong>ç¬¬ 43 è¡Œ</strong>å®ç°çš„æ˜¯ <code>collapsedRequest.toObservable()</code> ï¼Œé‚£ä¹ˆ<strong>ç›¸åŒçš„</strong> <code>arg</code> å°†æœ‰<strong>å¤šä¸ª</strong> Observable æ‰§è¡Œå‘½ä»¤ï¼Œæ­¤æ—¶ <code>HystrixCollapserBridge#mapResponseToRequests(...)</code> æ–¹æ³•æ— æ³•å°†æ‰§è¡Œ( Response )èµ‹å€¼åˆ° <code>arg</code> å¯¹åº”çš„å‘½ä»¤è¯·æ±‚( CollapsedRequestSubject ) ã€‚æ›´å¤šè®¨è®ºï¼Œè§ <a href="https://github.com/Netflix/Hystrix/pull/1176" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/Hystrix/pull/1176</a> ã€‚</li><li>å›è¿‡å¤´çœ‹ <code>HystrixCollapser#toObservable()</code> æ–¹æ³•çš„<strong>ç¬¬ 32 è‡³ 41 è¡Œçš„ä»£ç </strong>ï¼Œè¿™é‡Œä¹Ÿæœ‰å¯¹<strong>ç¼“å­˜</strong>åŠŸèƒ½ï¼Œæ˜¯ä¸æ˜¯<strong>é‡å¤</strong>äº†å‘¢ï¼Ÿ<code>argumentMap</code> é’ˆå¯¹çš„æ˜¯ RequestBatch çº§çš„ç¼“å­˜ï¼ŒHystrixCollapser : RequestCollapser : RequestBatch æ˜¯ <code>1 : 1 : N</code> çš„å…³ç³»ï¼Œé€šè¿‡ <code>HystrixCollapser#toObservable()</code> å¯¹ç¼“å­˜çš„å¤„ç†é€»è¾‘ï¼Œä¿è¯ RequestBatch åˆ‡æ¢åï¼Œ<strong>ä¾ç„¶æœ‰ç¼“å­˜</strong>ã€‚</li></ul></li></ul><hr><p><code>RequestBatch#remove()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package-private */</span> <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(RequestArgumentType arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line">        <span class="comment">//nothing we can do</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (batchLock.readLock().tryLock()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">/* double-check now that we have the lock - if the batch is started, deleting is useless */</span></div><div class="line">            <span class="keyword">if</span> (batchStarted.get()) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            argumentMap.remove(arg);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            batchLock.readLock().unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“ RequestBatch å¼€å§‹æ‰§è¡Œï¼Œä¸å…è®¸ç§»é™¤<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‚</li></ul><h2>4.4 #createNewBatchAndExecutePreviousIfNeeded(previousBatch)</h2><p>æœ¬å°èŠ‚å»ºè®®åœ¨ <a href="#">ã€Œ5. CollapserTimerã€</a> åï¼Œå†å›è¿‡å¤´çœ‹ã€‚</p><p><code>#createNewBatchAndExecutePreviousIfNeeded(previousBatch)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createNewBatchAndExecutePreviousIfNeeded</span><span class="params">(RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt; previousBatch)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">if</span> (previousBatch == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Trying to start null batch which means it was shutdown already."</span>);</div><div class="line"><span class="number">4</span>:     &#125;</div><div class="line"><span class="number">5</span>:     <span class="keyword">if</span> (batch.compareAndSet(previousBatch, <span class="keyword">new</span> RequestBatch&lt;BatchReturnType, ResponseType, RequestArgumentType&gt;(properties, commandCollapser, properties.maxRequestsInBatch().get()))) &#123;</div><div class="line"><span class="number">6</span>:         <span class="comment">// this thread won so trigger the previous batch</span></div><div class="line"><span class="number">7</span>:         previousBatch.executeBatchIfNotAlreadyStarted();</div><div class="line"><span class="number">8</span>:     &#125;</div><div class="line"><span class="number">9</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿®æ”¹ <code>batch</code> ï¼Œä¿è¯å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹å®‰å…¨ã€‚åŒæ—¶æ³¨æ„ï¼Œæ­¤å¤„ä¹Ÿè¿›è¡Œäº†<strong>æ–°çš„</strong> RequestBatch ï¼Œåˆ‡æ¢æ‰<strong>è€çš„</strong> RequestBatch ã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šä½¿ç”¨<strong>è€çš„</strong> RequestBatch ï¼Œè°ƒç”¨ <code>RequestBatch#executeBatchIfNotAlreadyStarted()</code> æ–¹æ³•ï¼Œå‘½ä»¤åˆå¹¶æ‰§è¡Œã€‚</li></ul><hr><p><code>RequestBatch#executeBatchIfNotAlreadyStarted()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchIfNotAlreadyStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">/*</span></div><div class="line"><span class="comment">  3:      * - check that we only execute once since there's multiple paths to do so (timer, waiting thread or max batch size hit)</span></div><div class="line"><span class="comment">  4:      * - close the gate so 'offer' can no longer be invoked and we turn those threads away so they create a new batch</span></div><div class="line"><span class="comment">  5:      */</span></div><div class="line">  <span class="number">6</span>:     <span class="comment">// è®¾ç½® æ‰§è¡Œå·²ç»å¼€å§‹</span></div><div class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (batchStarted.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">  <span class="number">8</span>:         <span class="comment">// è·å¾— å†™é”</span></div><div class="line">  <span class="number">9</span>:         <span class="comment">/* wait for 'offer'/'remove' threads to finish before executing the batch so 'requests' is complete */</span></div><div class="line"> <span class="number">10</span>:         batchLock.writeLock().lock();</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">13</span>:             <span class="comment">// å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚åˆ†ç‰‡æˆ N ä¸ªã€å¤šä¸ªå‘½ä»¤è¯·æ±‚ã€‘ã€‚</span></div><div class="line"> <span class="number">14</span>:             <span class="comment">// shard batches</span></div><div class="line"> <span class="number">15</span>:             Collection&lt;Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt;&gt; shards = commandCollapser.shardRequests(argumentMap.values());</div><div class="line"> <span class="number">16</span>:             <span class="comment">// for each shard execute its requests </span></div><div class="line"> <span class="number">17</span>:             <span class="keyword">for</span> (<span class="keyword">final</span> Collection&lt;CollapsedRequest&lt;ResponseType, RequestArgumentType&gt;&gt; shardRequests : shards) &#123;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:                     <span class="comment">// å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚åˆå¹¶ï¼Œåˆ›å»ºä¸€ä¸ª HystrixCommand</span></div><div class="line"> <span class="number">20</span>:                     <span class="comment">// create a new command to handle this batch of requests</span></div><div class="line"> <span class="number">21</span>:                     Observable&lt;BatchReturnType&gt; o = commandCollapser.createObservableCommand(shardRequests);</div><div class="line"> <span class="number">22</span>: </div><div class="line"> <span class="number">23</span>:                     <span class="comment">// å°†ä¸€ä¸ª HystrixCommand çš„æ‰§è¡Œç»“æœï¼Œæ˜ å°„å›å¯¹åº”çš„å‘½ä»¤è¯·æ±‚ä»¬</span></div><div class="line"> <span class="number">24</span>:                     commandCollapser.mapResponseToRequests(o, shardRequests).doOnError(<span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:                         <span class="comment">/**</span></div><div class="line"><span class="comment"> 27:                          * This handles failed completions</span></div><div class="line"><span class="comment"> 28:                          */</span></div><div class="line"> <span class="number">29</span>:                         <span class="meta">@Override</span></div><div class="line"> <span class="number">30</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"> <span class="number">31</span>:                             <span class="comment">// handle Throwable in case anything is thrown so we don't block Observers waiting for onError/onCompleted</span></div><div class="line"> <span class="number">32</span>:                             Exception ee;</div><div class="line"> <span class="number">33</span>:                             <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Exception) &#123;</div><div class="line"> <span class="number">34</span>:                                 ee = (Exception) e;</div><div class="line"> <span class="number">35</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">36</span>:                                 ee = <span class="keyword">new</span> RuntimeException(<span class="string">"Throwable caught while executing batch and mapping responses."</span>, e);</div><div class="line"> <span class="number">37</span>:                             &#125;</div><div class="line"> <span class="number">38</span>:                             logger.debug(<span class="string">"Exception mapping responses to requests."</span>, e);</div><div class="line"> <span class="number">39</span>:                             <span class="comment">// if a failure occurs we want to pass that exception to all of the Futures that we've returned</span></div><div class="line"> <span class="number">40</span>:                             <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : argumentMap.values()) &#123;</div><div class="line"> <span class="number">41</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">42</span>:                                     ((CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;) request).setExceptionIfResponseNotReceived(ee);</div><div class="line"> <span class="number">43</span>:                                 &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">44</span>:                                     <span class="comment">// if we have partial responses set in mapResponseToRequests</span></div><div class="line"> <span class="number">45</span>:                                     <span class="comment">// then we may get IllegalStateException as we loop over them</span></div><div class="line"> <span class="number">46</span>:                                     <span class="comment">// so we'll log but continue to the rest</span></div><div class="line"> <span class="number">47</span>:                                     logger.error(<span class="string">"Partial success of 'mapResponseToRequests' resulted in IllegalStateException while setting Exception. Continuing ... "</span>, e2);</div><div class="line"> <span class="number">48</span>:                                 &#125;</div><div class="line"> <span class="number">49</span>:                             &#125;</div><div class="line"> <span class="number">50</span>:                         &#125;</div><div class="line"> <span class="number">51</span>: </div><div class="line"> <span class="number">52</span>:                     &#125;).doOnCompleted(<span class="keyword">new</span> Action0() &#123;</div><div class="line"> <span class="number">53</span>: </div><div class="line"> <span class="number">54</span>:                         <span class="comment">/**</span></div><div class="line"><span class="comment"> 55:                          * This handles successful completions</span></div><div class="line"><span class="comment"> 56:                          */</span></div><div class="line"> <span class="number">57</span>:                         <span class="meta">@Override</span></div><div class="line"> <span class="number">58</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">59</span>:                             <span class="comment">// check that all requests had setResponse or setException invoked in case 'mapResponseToRequests' was implemented poorly</span></div><div class="line"> <span class="number">60</span>:                             Exception e = <span class="keyword">null</span>;</div><div class="line"> <span class="number">61</span>:                             <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : shardRequests) &#123;</div><div class="line"> <span class="number">62</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">63</span>:                                    e = ((CollapsedRequestSubject&lt;ResponseType, RequestArgumentType&gt;) request).setExceptionIfResponseNotReceived(e,<span class="string">"No response set by "</span> + commandCollapser.getCollapserKey().name() + <span class="string">" 'mapResponseToRequests' implementation."</span>);</div><div class="line"> <span class="number">64</span>:                                 &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">65</span>:                                     logger.debug(<span class="string">"Partial success of 'mapResponseToRequests' resulted in IllegalStateException while setting 'No response set' Exception. Continuing ... "</span>, e2);</div><div class="line"> <span class="number">66</span>:                                 &#125;</div><div class="line"> <span class="number">67</span>:                             &#125;</div><div class="line"> <span class="number">68</span>:                         &#125;</div><div class="line"> <span class="number">69</span>: </div><div class="line"> <span class="number">70</span>:                     &#125;).subscribe();</div><div class="line"> <span class="number">71</span>:                     </div><div class="line"> <span class="number">72</span>:                 &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">73</span>:                     <span class="comment">// å¼‚å¸¸</span></div><div class="line"> <span class="number">74</span>:                     logger.error(<span class="string">"Exception while creating and queueing command with batch."</span>, e);</div><div class="line"> <span class="number">75</span>:                     <span class="comment">// if a failure occurs we want to pass that exception to all of the Futures that we've returned</span></div><div class="line"> <span class="number">76</span>:                     <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : shardRequests) &#123;</div><div class="line"> <span class="number">77</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">78</span>:                             request.setException(e);</div><div class="line"> <span class="number">79</span>:                         &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">80</span>:                             logger.debug(<span class="string">"Failed trying to setException on CollapsedRequest"</span>, e2);</div><div class="line"> <span class="number">81</span>:                         &#125;</div><div class="line"> <span class="number">82</span>:                     &#125;</div><div class="line"> <span class="number">83</span>:                 &#125;</div><div class="line"> <span class="number">84</span>:             &#125;</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">87</span>:             <span class="comment">// å¼‚å¸¸</span></div><div class="line"> <span class="number">88</span>:             logger.error(<span class="string">"Exception while sharding requests."</span>, e);</div><div class="line"> <span class="number">89</span>:             <span class="comment">// same error handling as we do around the shards, but this is a wider net in case the shardRequest method fails</span></div><div class="line"> <span class="number">90</span>:             <span class="keyword">for</span> (CollapsedRequest&lt;ResponseType, RequestArgumentType&gt; request : argumentMap.values()) &#123;</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">92</span>:                     request.setException(e);</div><div class="line"> <span class="number">93</span>:                 &#125; <span class="keyword">catch</span> (IllegalStateException e2) &#123;</div><div class="line"> <span class="number">94</span>:                     logger.debug(<span class="string">"Failed trying to setException on CollapsedRequest"</span>, e2);</div><div class="line"> <span class="number">95</span>:                 &#125;</div><div class="line"> <span class="number">96</span>:             &#125;</div><div class="line"> <span class="number">97</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">98</span>:             batchLock.writeLock().unlock();</div><div class="line"> <span class="number">99</span>:         &#125;</div><div class="line"><span class="number">100</span>:     &#125;</div><div class="line"><span class="number">101</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ä»£ç çœ‹èµ·æ¥æ˜¯æœ‰ç‚¹é•¿å“ˆï¼Œè¯·å¯¹ç…§ç€å®˜æ–¹ç¤ºä¾‹ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandCollapserGetValueForKey.java" rel="external nofollow noopener noreferrer" target="_blank">CommandCollapserGetValueForKey</a> ä¸€èµ·çœ‹ï¼Œä¸´é—¨ä¸€è„šäº†ï¼Œèƒ–å‹ï¼</li><li>ç¬¬ 7 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿®æ”¹ <code>batchStarted</code> ï¼Œä¿è¯å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹å®‰å…¨ã€‚</li><li>ç¬¬ 10 è¡Œ ï¼šè·å¾—<strong>å†™é”</strong>ã€‚ç­‰å¾…è°ƒç”¨ <code>#offer(...)</code>/<code>#remove(...)</code> æ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œä»¥ä¿è¯å‘½ä»¤åˆå¹¶æ‰§è¡Œæ—¶ï¼Œä¸å†æœ‰æ–°çš„è¯·æ±‚æ·»åŠ æˆ–ç§»é™¤ã€‚</li><li>ç¬¬ 15 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCollapserBridge#shardRequests(...)</code> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆ†ç‰‡</strong>æˆ <strong>N</strong> ä¸ªã€<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‘ã€‚é»˜è®¤å®ç°ä¸‹ï¼Œä¸è¿›è¡Œåˆ†ç‰‡ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L146" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>ç¬¬ 17 è¡Œ ï¼šå¾ªç¯ <strong>N</strong> ä¸ªã€<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚ã€‘ã€‚</li><li>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCollapserBridge#createObservableCommand(...)</code> æ–¹æ³•ï¼Œå°†<strong>å¤šä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>åˆå¹¶</strong>ï¼Œåˆ›å»º<strong>ä¸€ä¸ª</strong> HystrixCommand ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L156" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li><li>ç¬¬ 24 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCollapserBridge#mapResponseToRequests(...)</code> æ–¹æ³•ï¼Œå°†<strong>ä¸€ä¸ª</strong> HystrixCommand çš„æ‰§è¡Œç»“æœï¼Œ<strong>æ˜ å°„</strong>å›å¯¹åº”çš„å‘½ä»¤è¯·æ±‚ä»¬ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCollapser.java#L166" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚<ul><li><code>Observable#single()</code> æ–¹æ³•ï¼Œå¦‚æœ Observable ç»ˆæ­¢æ—¶åªå‘å°„äº†ä¸€ä¸ªå€¼ï¼Œè¿”å›é‚£ä¸ªå€¼ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚åœ¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/First.html#single" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€Œsingleã€</a> æœ‰ç›¸å…³åˆ†äº«ã€‚</li><li><code>Observable#ignoreElements()</code> æ–¹æ³•ï¼ŒæŠ‘åˆ¶åŸå§‹ Observable å‘å°„çš„æ‰€æœ‰æ•°æ®ï¼Œåªå…è®¸å®ƒçš„ç»ˆæ­¢é€šçŸ¥ï¼ˆ<code>#onError()</code> æˆ– <code>#onCompleted()</code>ï¼‰é€šè¿‡ã€‚åœ¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/IgnoreElements.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€ŒIgnoreElementsã€</a> æœ‰ç›¸å…³åˆ†äº«ã€‚ä¹Ÿæ¨èç‚¹å‡» <a href="https://github.com/ReactiveX/RxJava/blob/6db98f8750f580995657f83b5620b579c97e6a06/src/main/java/rx/internal/operators/OperatorIgnoreElements.java" rel="external nofollow noopener noreferrer" target="_blank"><code>rx.internal.operators.OperatorIgnoreElements</code></a> çœ‹ä¸‹æºç ï¼Œå¯èƒ½æ›´åŠ æ˜“æ‡‚ã€‚</li><li><code>Observable#cast()</code> æ–¹æ³•ï¼Œå°†åŸå§‹ Observable å‘å°„çš„æ¯ä¸€é¡¹æ•°æ®éƒ½å¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ªæŒ‡å®šçš„ç±»å‹ï¼Œç„¶åå†å‘å°„æ•°æ®ï¼Œå®ƒæ˜¯ <code>map</code> çš„ä¸€ä¸ªç‰¹æ®Šç‰ˆæœ¬ã€‚åœ¨ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Map.html#cast" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€Œcastã€</a> æœ‰ç›¸å…³åˆ†äº«ã€‚ä¹Ÿæ¨èç‚¹å‡» <a href="https://github.com/ReactiveX/RxJava/blob/6db98f8750f580995657f83b5620b579c97e6a06/src/main/java/rx/internal/operators/OperatorCast.java" rel="external nofollow noopener noreferrer" target="_blank"><code>rx.internal.operators.OperatorCast</code></a> çœ‹ä¸‹æºç ï¼Œå¯èƒ½æ›´åŠ æ˜“æ‡‚ã€‚</li><li>ä½¿ç”¨ <code>Observable#ignoreElements()</code>/<code>Observable#cast()</code> æ–¹æ³•ï¼Œç”¨äºå°† Observable å˜æˆä¸å†ç»§ç»­å‘ä¸‹å‘å°„æ•°æ®é¡¹ï¼Œåªç»™ç°æœ‰æ–¹æ³•é‡Œ <code>Observable#doNext()</code> å¤„ç†æ•°æ®é¡¹ï¼Œè°ƒç”¨ <code>HystrixCollapser#mapResponseToRequests(...)</code> æ–¹æ³•ã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/CollapsedRequestSubject.java#L101" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> ï¼ŒæŸ¥çœ‹ <code>CollapsedRequestSubject#setResponse(response)</code> æ–¹æ³•çš„ä»£ç ã€‚</li></ul></li><li>ç¬¬ 24 è‡³ 50 è¡Œ ï¼šè°ƒç”¨ <code>Observable#doError(Action1)</code> æ–¹æ³•ï¼Œå½“å‘½ä»¤åˆå¹¶æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè®¾ç½®<strong>æ¯ä¸ª</strong> CollapsedRequestSubject çš„æ‰§è¡Œç»“æœä¸ºå¼‚å¸¸ã€‚<ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/CollapsedRequestSubject.java#L137" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ï¼ŒæŸ¥çœ‹ <code>CollapsedRequestSubject#setResponse(response)</code> æ–¹æ³•çš„ä»£ç ã€‚</li></ul></li><li>ç¬¬ 52 è‡³ 68 è¡Œ ï¼šè°ƒç”¨ <code>Observable#doOnCompleted(Action0)</code> æ–¹æ³•ï¼Œå½“å‘½ä»¤åˆå¹¶æ‰§è¡Œå®Œæˆæ—¶ï¼Œæ£€æŸ¥<strong>æ¯ä¸ª</strong> CollapsedRequestSubject æ˜¯å¦éƒ½æœ‰è¿”å›ç»“æœã€‚è®¾ç½®æ²¡æœ‰è¿”å›ç»“æœçš„ CollapsedRequestSubject çš„æ‰§è¡Œç»“æœä¸ºå¼‚å¸¸ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯ç”¨æˆ·å®ç° <code>HystrixCollapser#mapResponseToRequests(...)</code> æ–¹æ³•å­˜åœ¨ BUG ã€‚å¦å¤–ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œå°†å¯¼è‡´æ— ç»“æœçš„<strong>å•ä¸ª</strong>å‘½ä»¤è¯·æ±‚<strong>æ— é™é˜»å¡</strong>ã€‚</li><li>ç¬¬ 70 è¡Œ ï¼šè°ƒç”¨ <code>Observable#subscribe()</code> æ–¹æ³•ï¼Œ<strong>è§¦å‘</strong> HystrixCommand æ‰§è¡Œã€‚</li><li>ç¬¬ 72 è‡³ 96 è¡Œ ï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè®¾ç½®<strong>æ¯ä¸ª</strong> CollapsedRequestSubject çš„æ‰§è¡Œç»“æœä¸ºå¼‚å¸¸ã€‚<ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/CollapsedRequestSubject.java#L170" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ï¼ŒæŸ¥çœ‹ <code>CollapsedRequestSubject#setException(response)</code> æ–¹æ³•çš„ä»£ç ã€‚</li></ul></li><li>ç¬¬ 97 è‡³ 99 è¡Œ ï¼šé‡Šæ”¾<strong>å†™é”</strong>ã€‚</li></ul><h1>5. CollapserTimer</h1><p><code>com.netflix.hystrix.collapser.CollapserTimer</code> ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº†<strong>æäº¤å®šæ—¶ç›‘å¬å™¨ï¼Œç”Ÿæˆå®šæ—¶ä»»åŠ¡</strong>çš„æ¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CollapserTimer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Reference&lt;TimerListener&gt; <span class="title">addListener</span><span class="params">(TimerListener collapseTask)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>5.1 RealCollapserTimer</h2><p><code>com.netflix.hystrix.collapser.RealCollapserTimer</code> ï¼Œå‘½ä»¤åˆå¹¶å™¨çš„å®šæ—¶å™¨<strong>å®ç°ç±»</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealCollapserTimer</span> <span class="keyword">implements</span> <span class="title">CollapserTimer</span> </span>&#123;</div><div class="line">    <span class="comment">/* single global timer that all collapsers will schedule their tasks on */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> HystrixTimer timer = HystrixTimer.getInstance();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Reference&lt;TimerListener&gt; <span class="title">addListener</span><span class="params">(TimerListener collapseTask)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> timer.addTimerListener(collapseTask);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å®é™…ä¸Šï¼Œä½¿ç”¨çš„æ˜¯ HystrixTimer æä¾›çš„å•ä¾‹ã€‚åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹ã€Œ3. HystrixTimerã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h2>5.2 CollapsedTask</h2><p><code>com.netflix.hystrix.collapser.RequestCollapser.CollapsedTask</code> ï¼Œå®šæ—¶ä»»åŠ¡ï¼Œå›ºå®šå‘¨æœŸ( å¯é…ï¼Œé»˜è®¤ <code>HystrixCollapserProperties.timerDelayInMilliseconds = 10ms</code> ) è½®è¯¢å…¶å¯¹åº”çš„<strong>ä¸€ä¸ª</strong> RequestCollapser <strong>å½“å‰</strong> RequestBatch ã€‚è‹¥æœ‰å‘½ä»¤éœ€è¦æ‰§è¡Œï¼Œåˆ™æäº¤ RequestCollapser åˆå¹¶æ‰§è¡Œã€‚</p><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/dc176978c2beb2465ba4edb37d0024e388f15d5d/hystrix-core/src/main/java/com/netflix/hystrix/collapser/RequestCollapser.java#L138" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> ç›´æ¥çœ‹ä»£ç ã€‚</p><h1>666. å½©è›‹</h1><p>T T ä¸€å¼€å§‹æŠŠå‘½ä»¤åˆå¹¶æ‰§è¡Œï¼Œç†è§£æˆç±»ä¼¼çº¿ç¨‹æ± æ‰¹é‡æ‰§è¡Œä»»åŠ¡ï¼Œæ€ä¹ˆçœ‹å®˜æ–¹ç¤ºä¾‹ï¼Œæ€ä¹ˆå¥‡æ€ªã€‚æœ‰ä¸€æ ·çš„åŒå­¦ï¼Œä¸€èµ·æ³ªç›® + æ¡çˆªä¸‹ã€‚</p><p>æœ¬æ–‡æœ‰ç‚¹ç‚¹é•¿ï¼Œå®åœ¨ä¸æƒ³æ‹†åˆ†æˆå¤šç¯‡ã€‚</p><p>æ©ï¼Œå¦å¤–éƒ¨åˆ†åœ°æ–¹å†™çš„ä¸å¤Ÿæ¸…æ™°ï¼Œæ¬¢è¿ä¸€èµ·è®¨è®ºå’Œä¼˜åŒ–ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-collapser-execute/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” è¯·æ±‚æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘</title>
    <link href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/"/>
    <id>http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/</id>
    <published>2018-10-30T16:00:00.000Z</published>
    <updated>2017-11-06T10:48:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">2. handleFallback</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">3. #handleShortCircuitViaFallback()</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">4. #handleSemaphoreRejectionViaFallback()</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">5. #handleThreadPoolRejectionViaFallback()</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">6. #handleTimeoutViaFallback()</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">7. #handleFailureViaFallback()</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">8. #getFallbackOrThrowException(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix å‘½ä»¤æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘</strong>ã€‚</p><p>å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚</p><p>Hystrix æ‰§è¡Œå‘½ä»¤æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><blockquote><p>FROM <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E6%B5%81%E7%A8%8B%E5%9B%BE" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œæµç¨‹å›¾ã€</a><br><img src="http://www.iocoder.cn/images/Hystrix/2018_10_31/01.jpeg" alt=""></p></blockquote><ul><li><strong>çº¢</strong>åœˆ ï¼šHystrix å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ‰§è¡Œå›é€€é€»è¾‘ã€‚<strong>ä¹Ÿå°±æ˜¯å¤§å®¶ç»å¸¸åœ¨æ–‡ç« ä¸­çœ‹åˆ°çš„â€œæœåŠ¡é™çº§â€</strong>ã€‚</li><li><strong>ç»¿</strong>åœˆ ï¼šå››ç§æƒ…å†µä¼šè§¦å‘å¤±è´¥å›é€€é€»è¾‘( fallback )ã€‚<ul><li>ç¬¬ä¸€ç§ ï¼š<code>short-circuit</code> ï¼Œå¤„ç†<strong>é“¾è·¯å¤„äºç†”æ–­</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ3. #handleShortCircuitViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬äºŒç§ ï¼š<code>semaphore-rejection</code> ï¼Œå¤„ç†<strong>ä¿¡å·é‡è·å¾—å¤±è´¥</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4. #handleShortCircuitViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ä¸‰ç§ ï¼š<code>thread-pool-rejection</code> ï¼Œå¤„ç†<strong>çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ5. #handleThreadPoolRejectionViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬å››ç§ ï¼š<code>execution-timeout</code> ï¼Œå¤„ç†<strong>å‘½ä»¤æ‰§è¡Œè¶…æ—¶</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ6. #handleTimeoutViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬äº”ç§ ï¼š<code>execution-failure</code> ï¼Œå¤„ç†<strong>å‘½ä»¤æ‰§è¡Œå¼‚å¸¸</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ7. #handleFailureViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬å…­ç§ ï¼š<code>bad-request</code> ï¼ŒTODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘ï¼Œå’Œ <code>hystrix-javanica</code> å­é¡¹ç›®ç›¸å…³ã€‚</li></ul></li></ul><p>å¦å¤–ï¼Œ<code>#handleXXXX()</code> æ–¹æ³•ï¼Œæ•´ä½“ä»£ç æ¯”è¾ƒç±»ä¼¼ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ <code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ8. #getFallbackOrThrowException(...)ã€</a> è¯¦ç»†è§£æã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. handleFallback</h1><p>åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ4. #executeCommandAndObserve(...)ã€</a> ä¸­ï¼Œ<code>#executeCommandAndObserve(...)</code> çš„<strong>ç¬¬ 82 è¡Œ</strong> <code>onErrorResumeNext(handleFallback)</code> ä»£ç ï¼Œé€šè¿‡è°ƒç”¨ <code>Observable#onErrorResumeNext(...)</code> æ–¹æ³•ï¼Œå®ç°ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œè¿”å›ã€å›é€€é€»è¾‘ Observableã€‘ï¼Œæ‰§è¡Œå¤±è´¥å›é€€é€»è¾‘ã€‚</p><blockquote><p>FROM <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Catch.html#onerrorreturn" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€ŒonErrorResumeNextã€</a><br>onErrorResumeNext æ–¹æ³•è¿”å›ä¸€ä¸ªé•œåƒåŸæœ‰ Observable è¡Œä¸ºçš„æ–° Observable ï¼Œåè€…ä¼šå¿½ç•¥å‰è€…çš„ onError è°ƒç”¨ï¼Œä¸ä¼šå°†é”™è¯¯ä¼ é€’ç»™è§‚å¯Ÿè€…ï¼Œä½œä¸ºæ›¿ä»£ï¼Œå®ƒä¼šå¼€å§‹é•œåƒå¦ä¸€ä¸ªï¼Œå¤‡ç”¨çš„ Observable ã€‚</p><ul><li>Javadoc: <a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#onErrorResumeNext-rx.functions.Func1-" rel="external nofollow noopener noreferrer" target="_blank">onErrorResumeNext(Func1))</a></li><li>Javadoc: <a href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#onErrorResumeNext-rx.Observable-" rel="external nofollow noopener noreferrer" target="_blank">onErrorResumeNext(Observable))</a></li></ul></blockquote><p><a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L602" rel="external nofollow noopener noreferrer" target="_blank"><code>handleFallback</code></a> å˜é‡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">final</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt; handleFallback = <span class="keyword">new</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt;() &#123;</div><div class="line"> <span class="number">2</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>:     <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:         <span class="comment">// TODO ã€2015ã€‘ã€é“¾è·¯ç†”æ–­ã€‘</span></div><div class="line"> <span class="number">5</span>:         circuitBreaker.markNonSuccess();</div><div class="line"> <span class="number">6</span>:         <span class="comment">// æ ‡è®° executionResult æ‰§è¡Œå¼‚å¸¸</span></div><div class="line"> <span class="number">7</span>:         Exception e = getExceptionFromThrowable(t);</div><div class="line"> <span class="number">8</span>:         executionResult = executionResult.setExecutionException(e);</div><div class="line"> <span class="number">9</span>:         <span class="comment">// è¿”å› ã€å›é€€é€»è¾‘ Observableã€‘</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RejectedExecutionException) &#123; <span class="comment">// çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»å¼‚å¸¸</span></div><div class="line"><span class="number">11</span>:             <span class="keyword">return</span> handleThreadPoolRejectionViaFallback(e);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HystrixTimeoutException) &#123; <span class="comment">// æ‰§è¡Œå‘½ä»¤è¶…æ—¶å¼‚å¸¸</span></div><div class="line"><span class="number">13</span>:             <span class="keyword">return</span> handleTimeoutViaFallback();</div><div class="line"><span class="number">14</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HystrixBadRequestException) &#123; <span class="comment">// TODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">return</span> handleBadRequestByEmittingError(e);</div><div class="line"><span class="number">16</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">17</span>:             <span class="comment">/*</span></div><div class="line"><span class="comment">18:              * Treat HystrixBadRequestException from ExecutionHook like a plain HystrixBadRequestException.</span></div><div class="line"><span class="comment">19:              */</span></div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (e <span class="keyword">instanceof</span> HystrixBadRequestException) &#123; <span class="comment">// TODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘</span></div><div class="line"><span class="number">21</span>:                 eventNotifier.markEvent(HystrixEventType.BAD_REQUEST, commandKey);</div><div class="line"><span class="number">22</span>:                 <span class="keyword">return</span> Observable.error(e);</div><div class="line"><span class="number">23</span>:             &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> handleFailureViaFallback(e);</div><div class="line"><span class="number">26</span>:         &#125;</div><div class="line"><span class="number">27</span>:     &#125;</div><div class="line"><span class="number">28</span>: &#125;;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è¡Œ ï¼šTODO ã€2015ã€‘ã€é“¾è·¯ç†”æ–­ã€‘</li><li>ç¬¬ 7 è‡³ 8 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> <strong>æ‰§è¡Œå¼‚å¸¸</strong>ã€‚</li><li>ç¬¬ 10 è‡³ 11 è¡Œ ï¼š<code>thread-pool-rejection</code> ï¼Œå¤„ç†<strong>çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ5. #handleThreadPoolRejectionViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 12 è‡³ 13 è¡Œ ï¼š<code>execution-timeout</code> ï¼Œå¤„ç†<strong>å‘½ä»¤æ‰§è¡Œè¶…æ—¶</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="">ã€Œ6. #handleTimeoutViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 14 è‡³ 23 è¡Œ ï¼šï¼Œ<code>bad-request</code> ï¼ŒTODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘ï¼Œå’Œ <code>hystrix-javanica</code> å­é¡¹ç›®ç›¸å…³ã€‚</li><li>ç¬¬ 25 è¡Œ ï¼š<code>execution-failure</code> å¤„ç†<strong>å‘½ä»¤æ‰§è¡Œå¼‚å¸¸</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ7. #handleFailureViaFallback()ã€</a> è¯¦ç»†è§£æã€‚</li></ul><h1>3. #handleShortCircuitViaFallback()</h1><p><code>#handleShortCircuitViaFallback()</code> æ–¹æ³•ï¼Œ<code>short-circuit</code> ï¼Œå¤„ç†<strong>é“¾è·¯å¤„äºç†”æ–­</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L558" rel="external nofollow noopener noreferrer" target="_blank">æ­¤å¤„</a> è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"> 1: private Observable&lt;R&gt; handleShortCircuitViaFallback() &#123;</div><div class="line"> 2:     // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</div><div class="line"> 3:     // record that we are returning a short-circuited fallback</div><div class="line"> 4:     eventNotifier.markEvent(HystrixEventType.SHORT_CIRCUITED, commandKey);</div><div class="line"> 5:     // æ ‡è®° executionResult æ‰§è¡Œå¼‚å¸¸</div><div class="line"> 6:     // short-circuit and go directly to fallback (or throw an exception if no fallback implemented)</div><div class="line"> 7:     Exception shortCircuitException = new RuntimeException(&quot;Hystrix circuit short-circuited and is OPEN&quot;);</div><div class="line"> 8:     executionResult = executionResult.setExecutionException(shortCircuitException);</div><div class="line"> 9:     try &#123;</div><div class="line">10:         // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘</div><div class="line">11:         return getFallbackOrThrowException(this, HystrixEventType.SHORT_CIRCUITED, FailureType.SHORTCIRCUIT,</div><div class="line">12:                 &quot;short-circuited&quot;, shortCircuitException);</div><div class="line">13:     &#125; catch (Exception e) &#123;</div><div class="line">14:         return Observable.error(e);</div><div class="line">15:     &#125;</div><div class="line">16: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</li><li>ç¬¬ 7 è‡³ 8 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> <strong>æ‰§è¡Œå¼‚å¸¸</strong>ã€‚</li><li>ç¬¬ 11 è‡³ 12 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ8. #getFallbackOrThrowException(...)ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 14 è¡Œ ï¼šè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚</li></ul><h1>4. #handleSemaphoreRejectionViaFallback()</h1><p><code>#handleSemaphoreRejectionViaFallback()</code> æ–¹æ³•ï¼Œ<code>semaphore-rejection</code> ï¼Œå¤„ç†<strong>ä¿¡å·é‡è·å¾—å¤±è´¥</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L555" rel="external nofollow noopener noreferrer" target="_blank">æ­¤å¤„</a> è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">handleSemaphoreRejectionViaFallback</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// æ ‡è®° executionResult æ‰§è¡Œå¼‚å¸¸</span></div><div class="line"> <span class="number">3</span>:     Exception semaphoreRejectionException = <span class="keyword">new</span> RuntimeException(<span class="string">"could not acquire a semaphore for execution"</span>);</div><div class="line"> <span class="number">4</span>:     executionResult = executionResult.setExecutionException(semaphoreRejectionException);</div><div class="line"> <span class="number">5</span>:     <span class="comment">// TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</span></div><div class="line"> <span class="number">6</span>:     eventNotifier.markEvent(HystrixEventType.SEMAPHORE_REJECTED, commandKey);</div><div class="line"> <span class="number">7</span>:     logger.debug(<span class="string">"HystrixCommand Execution Rejection by Semaphore."</span>); <span class="comment">// debug only since we're throwing the exception and someone higher will do something with it</span></div><div class="line"> <span class="number">8</span>:     <span class="comment">// retrieve a fallback or throw an exception if no fallback available</span></div><div class="line"> <span class="number">9</span>:     <span class="comment">// è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">return</span> getFallbackOrThrowException(<span class="keyword">this</span>, HystrixEventType.SEMAPHORE_REJECTED, FailureType.REJECTED_SEMAPHORE_EXECUTION,</div><div class="line"><span class="number">11</span>:             <span class="string">"could not acquire a semaphore for execution"</span>, semaphoreRejectionException);</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è‡³ 4 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> <strong>æ‰§è¡Œå¼‚å¸¸</strong>ã€‚</li><li>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</li><li>ç¬¬ 10 è‡³ 11 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ8. #getFallbackOrThrowException(...)ã€</a> è¯¦ç»†è§£æã€‚</li></ul><h1>5. #handleThreadPoolRejectionViaFallback()</h1><p><code>#handleThreadPoolRejectionViaFallback()</code> æ–¹æ³•ï¼Œ<code>thread-pool-rejection</code> ï¼Œå¤„ç†<strong>çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L990" rel="external nofollow noopener noreferrer" target="_blank">æ­¤å¤„</a> è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">handleThreadPoolRejectionViaFallback</span><span class="params">(Exception underlying)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</span></div><div class="line"> <span class="number">3</span>:     eventNotifier.markEvent(HystrixEventType.THREAD_POOL_REJECTED, commandKey);</div><div class="line"> <span class="number">4</span>:     <span class="comment">// TODO ã€2002ã€‘ã€metricsã€‘</span></div><div class="line"> <span class="number">5</span>:     threadPool.markThreadRejection();</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘</span></div><div class="line"> <span class="number">7</span>:     <span class="comment">// use a fallback instead (or throw exception if not implemented)</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">return</span> getFallbackOrThrowException(<span class="keyword">this</span>, HystrixEventType.THREAD_POOL_REJECTED, FailureType.REJECTED_THREAD_EXECUTION,</div><div class="line"> <span class="number">9</span>:             <span class="string">"could not be queued for execution"</span>, underlying);</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</li><li>ç¬¬ 5 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘</li><li>ç¬¬ 8 è‡³ 9 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ8. #getFallbackOrThrowException(...)ã€</a> è¯¦ç»†è§£æã€‚</li></ul><h1>6. #handleTimeoutViaFallback()</h1><p><code>#handleTimeoutViaFallback()</code> æ–¹æ³•ï¼Œ<code>execution-timeout</code> ï¼Œå¤„ç†<strong>å‘½ä»¤æ‰§è¡Œè¶…æ—¶</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L611" rel="external nofollow noopener noreferrer" target="_blank">æ­¤å¤„</a> è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">handleTimeoutViaFallback</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="comment">// è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘</span></div><div class="line"><span class="number">3</span>:     <span class="keyword">return</span> getFallbackOrThrowException(<span class="keyword">this</span>, HystrixEventType.TIMEOUT, FailureType.TIMEOUT,</div><div class="line"><span class="number">4</span>:             <span class="string">"timed-out"</span>, <span class="keyword">new</span> TimeoutException());</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è‡³ 4 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ8. #getFallbackOrThrowException(...)ã€</a> è¯¦ç»†è§£æã€‚</li></ul><h1>7. #handleFailureViaFallback()</h1><p><code>#handleFailureViaFallback()</code> æ–¹æ³•ï¼Œ<code>execution-failure</code> ï¼Œå¤„ç†<strong>å‘½ä»¤æ‰§è¡Œå¼‚å¸¸</strong>çš„å›é€€é€»è¾‘ï¼Œåœ¨ <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L623" rel="external nofollow noopener noreferrer" target="_blank">æ­¤å¤„</a> è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">handleFailureViaFallback</span><span class="params">(Exception underlying)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</span></div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * All other error handling</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>:     logger.debug(<span class="string">"Error executing HystrixCommand.run(). Proceeding to fallback logic ..."</span>, underlying);</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// report failure</span></div><div class="line"> <span class="number">9</span>:     eventNotifier.markEvent(HystrixEventType.FAILURE, commandKey);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// æ ‡è®° executionResult å¼‚å¸¸ TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€” ä¸ºå•¥ä¸æ˜¯æ‰§è¡Œå¼‚å¸¸</span></div><div class="line"><span class="number">12</span>:     <span class="comment">// record the exception</span></div><div class="line"><span class="number">13</span>:     executionResult = executionResult.setException(underlying);</div><div class="line"><span class="number">14</span>:     <span class="comment">// è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘</span></div><div class="line"><span class="number">15</span>:     <span class="keyword">return</span> getFallbackOrThrowException(<span class="keyword">this</span>, HystrixEventType.FAILURE, FailureType.COMMAND_EXCEPTION, <span class="string">"failed"</span>, underlying);</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ 9 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</li><li>ç¬¬ 13 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> <strong>å¼‚å¸¸</strong>ã€‚</li><li>ç¬¬ 15 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ8. #getFallbackOrThrowException(...)ã€</a> è¯¦ç»†è§£æã€‚</li></ul><h1>8. #getFallbackOrThrowException(...)</h1><p><code>#getFallbackOrThrowException()</code> æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">getFallbackOrThrowException</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd, <span class="keyword">final</span> HystrixEventType eventType, <span class="keyword">final</span> FailureType failureType, <span class="keyword">final</span> String message, <span class="keyword">final</span> Exception originalException)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">// è®°å½• HystrixRequestContext</span></div><div class="line">  <span class="number">3</span>:     <span class="keyword">final</span> HystrixRequestContext requestContext = HystrixRequestContext.getContextForCurrentThread();</div><div class="line">  <span class="number">4</span>:     <span class="comment">// æ ‡è®° executionResult æ·»åŠ ( è®°å½• )äº‹ä»¶</span></div><div class="line">  <span class="number">5</span>:     <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</div><div class="line">  <span class="number">6</span>:     <span class="comment">// record the executionResult</span></div><div class="line">  <span class="number">7</span>:     <span class="comment">// do this before executing fallback so it can be queried from within getFallback (see See https://github.com/Netflix/Hystrix/pull/144)</span></div><div class="line">  <span class="number">8</span>:     executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, eventType);</div><div class="line">  <span class="number">9</span>: </div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (isUnrecoverable(originalException)) &#123; <span class="comment">// æ— æ³•æ¢å¤çš„å¼‚å¸¸</span></div><div class="line"> <span class="number">11</span>:         logger.error(<span class="string">"Unrecoverable Error for HystrixCommand so will throw HystrixRuntimeException and not apply fallback. "</span>, originalException);</div><div class="line"> <span class="number">12</span>: </div><div class="line"> <span class="number">13</span>:         <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"> <span class="number">14</span>:         <span class="comment">/* executionHook for all errors */</span></div><div class="line"> <span class="number">15</span>:         Exception e = wrapWithOnErrorHook(failureType, originalException);</div><div class="line"> <span class="number">16</span>:         <span class="comment">// è¿”å› ã€å¼‚å¸¸ Observableã€‘</span></div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> HystrixRuntimeException(failureType, <span class="keyword">this</span>.getClass(), getLogMessagePrefix() + <span class="string">" "</span> + message + <span class="string">" and encountered unrecoverable error."</span>, e, <span class="keyword">null</span>));</div><div class="line"> <span class="number">18</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">if</span> (isRecoverableError(originalException)) &#123; <span class="comment">// å¯æ¢å¤çš„å¼‚å¸¸</span></div><div class="line"> <span class="number">20</span>:             logger.warn(<span class="string">"Recovered from java.lang.Error by serving Hystrix fallback"</span>, originalException);</div><div class="line"> <span class="number">21</span>:         &#125;</div><div class="line"> <span class="number">22</span>: </div><div class="line"> <span class="number">23</span>:         <span class="keyword">if</span> (properties.fallbackEnabled().get()) &#123;</div><div class="line"> <span class="number">24</span>:             <span class="comment">/* fallback behavior is permitted so attempt */</span></div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:             <span class="comment">// è®¾ç½® HystrixRequestContext çš„ Action</span></div><div class="line"> <span class="number">27</span>:             <span class="keyword">final</span> Action1&lt;Notification&lt;? <span class="keyword">super</span> R&gt;&gt; setRequestContext = <span class="keyword">new</span> Action1&lt;Notification&lt;? <span class="keyword">super</span> R&gt;&gt;() &#123;</div><div class="line"> <span class="number">28</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">29</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Notification&lt;? <span class="keyword">super</span> R&gt; rNotification)</span> </span>&#123;</div><div class="line"> <span class="number">30</span>:                     setRequestContextIfNeeded(requestContext);</div><div class="line"> <span class="number">31</span>:                 &#125;</div><div class="line"> <span class="number">32</span>:             &#125;;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="comment">// TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</span></div><div class="line"> <span class="number">35</span>:             <span class="keyword">final</span> Action1&lt;R&gt; markFallbackEmit = <span class="keyword">new</span> Action1&lt;R&gt;() &#123;</div><div class="line"> <span class="number">36</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">37</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(R r)</span> </span>&#123;</div><div class="line"> <span class="number">38</span>:                     <span class="keyword">if</span> (shouldOutputOnNextEvents()) &#123;</div><div class="line"> <span class="number">39</span>:                         executionResult = executionResult.addEvent(HystrixEventType.FALLBACK_EMIT);</div><div class="line"> <span class="number">40</span>:                         eventNotifier.markEvent(HystrixEventType.FALLBACK_EMIT, commandKey);</div><div class="line"> <span class="number">41</span>:                     &#125;</div><div class="line"> <span class="number">42</span>:                 &#125;</div><div class="line"> <span class="number">43</span>:             &#125;;</div><div class="line"> <span class="number">44</span>: </div><div class="line"> <span class="number">45</span>:             <span class="comment">// TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</span></div><div class="line"> <span class="number">46</span>:             <span class="keyword">final</span> Action0 markFallbackCompleted = <span class="keyword">new</span> Action0() &#123;</div><div class="line"> <span class="number">47</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">48</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">49</span>:                     <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</div><div class="line"> <span class="number">50</span>:                     eventNotifier.markEvent(HystrixEventType.FALLBACK_SUCCESS, commandKey);</div><div class="line"> <span class="number">51</span>:                     executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.FALLBACK_SUCCESS);</div><div class="line"> <span class="number">52</span>:                 &#125;</div><div class="line"> <span class="number">53</span>:             &#125;;</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:             <span class="comment">// å¤„ç†å¼‚å¸¸ çš„ Func</span></div><div class="line"> <span class="number">56</span>:             <span class="keyword">final</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt; handleFallbackError = <span class="keyword">new</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt;() &#123;</div><div class="line"> <span class="number">57</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">58</span>:                 <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line"> <span class="number">59</span>:                     <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"> <span class="number">60</span>:                     <span class="comment">/* executionHook for all errors */</span></div><div class="line"> <span class="number">61</span>:                     Exception e = wrapWithOnErrorHook(failureType, originalException);</div><div class="line"> <span class="number">62</span>:                     <span class="comment">// è·å¾— Exception</span></div><div class="line"> <span class="number">63</span>:                     Exception fe = getExceptionFromThrowable(t);</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:                     <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</div><div class="line"> <span class="number">66</span>:                     Exception toEmit;</div><div class="line"> <span class="number">67</span>: </div><div class="line"> <span class="number">68</span>:                     <span class="keyword">if</span> (fe <span class="keyword">instanceof</span> UnsupportedOperationException) &#123;</div><div class="line"> <span class="number">69</span>:                         <span class="comment">// TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</span></div><div class="line"> <span class="number">70</span>:                         logger.debug(<span class="string">"No fallback for HystrixCommand. "</span>, fe); <span class="comment">// debug only since we're throwing the exception and someone higher will do something with it</span></div><div class="line"> <span class="number">71</span>:                         eventNotifier.markEvent(HystrixEventType.FALLBACK_MISSING, commandKey);</div><div class="line"> <span class="number">72</span>:                         <span class="comment">// æ ‡è®° executionResult æ·»åŠ ( è®°å½• )äº‹ä»¶ HystrixEventType.FALLBACK_MISSING</span></div><div class="line"> <span class="number">73</span>:                         executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.FALLBACK_MISSING);</div><div class="line"> <span class="number">74</span>: </div><div class="line"> <span class="number">75</span>:                         <span class="comment">// åˆ›å»º HystrixRuntimeException</span></div><div class="line"> <span class="number">76</span>:                         toEmit = <span class="keyword">new</span> HystrixRuntimeException(failureType, _cmd.getClass(), getLogMessagePrefix() + <span class="string">" "</span> + message + <span class="string">" and no fallback available."</span>, e, fe);</div><div class="line"> <span class="number">77</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">78</span>:                         <span class="comment">// TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</span></div><div class="line"> <span class="number">79</span>:                         logger.debug(<span class="string">"HystrixCommand execution "</span> + failureType.name() + <span class="string">" and fallback failed."</span>, fe);</div><div class="line"> <span class="number">80</span>:                         eventNotifier.markEvent(HystrixEventType.FALLBACK_FAILURE, commandKey);</div><div class="line"> <span class="number">81</span>:                         <span class="comment">// æ ‡è®° executionResult æ·»åŠ ( è®°å½• )äº‹ä»¶ HystrixEventType.FALLBACK_FAILURE</span></div><div class="line"> <span class="number">82</span>:                         executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.FALLBACK_FAILURE);</div><div class="line"> <span class="number">83</span>: </div><div class="line"> <span class="number">84</span>:                         <span class="comment">// åˆ›å»º HystrixRuntimeException</span></div><div class="line"> <span class="number">85</span>:                         toEmit = <span class="keyword">new</span> HystrixRuntimeException(failureType, _cmd.getClass(), getLogMessagePrefix() + <span class="string">" "</span> + message + <span class="string">" and fallback failed."</span>, e, fe);</div><div class="line"> <span class="number">86</span>:                     &#125;</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:                     <span class="comment">// <span class="doctag">NOTE:</span> we're suppressing fallback exception here</span></div><div class="line"> <span class="number">89</span>:                     <span class="keyword">if</span> (shouldNotBeWrapped(originalException)) &#123;</div><div class="line"> <span class="number">90</span>:                         <span class="keyword">return</span> Observable.error(e);</div><div class="line"> <span class="number">91</span>:                     &#125;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:                     <span class="keyword">return</span> Observable.error(toEmit);</div><div class="line"> <span class="number">94</span>:                 &#125;</div><div class="line"> <span class="number">95</span>:             &#125;;</div><div class="line"> <span class="number">96</span>: </div><div class="line"> <span class="number">97</span>:             <span class="comment">// è·å¾— TryableSemaphore</span></div><div class="line"> <span class="number">98</span>:             <span class="keyword">final</span> TryableSemaphore fallbackSemaphore = getFallbackSemaphore();</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:             <span class="comment">// ä¿¡å·é‡é‡Šæ”¾Action</span></div><div class="line"><span class="number">101</span>:             <span class="keyword">final</span> AtomicBoolean semaphoreHasBeenReleased = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="number">102</span>:             <span class="keyword">final</span> Action0 singleSemaphoreRelease = <span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">103</span>:                 <span class="meta">@Override</span></div><div class="line"><span class="number">104</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">105</span>:                     <span class="keyword">if</span> (semaphoreHasBeenReleased.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"><span class="number">106</span>:                         fallbackSemaphore.release();</div><div class="line"><span class="number">107</span>:                     &#125;</div><div class="line"><span class="number">108</span>:                 &#125;</div><div class="line"><span class="number">109</span>:             &#125;;</div><div class="line"><span class="number">110</span>: </div><div class="line"><span class="number">111</span>:             Observable&lt;R&gt; fallbackExecutionChain;</div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:             <span class="comment">// acquire a permit</span></div><div class="line"><span class="number">114</span>:             <span class="keyword">if</span> (fallbackSemaphore.tryAcquire()) &#123;</div><div class="line"><span class="number">115</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">116</span>:                     <span class="keyword">if</span> (isFallbackUserDefined()) &#123;</div><div class="line"><span class="number">117</span>:                         executionHook.onFallbackStart(<span class="keyword">this</span>);</div><div class="line"><span class="number">118</span>:                         fallbackExecutionChain = getFallbackObservable();</div><div class="line"><span class="number">119</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">120</span>:                         <span class="comment">//same logic as above without the hook invocation</span></div><div class="line"><span class="number">121</span>:                         fallbackExecutionChain = getFallbackObservable();</div><div class="line"><span class="number">122</span>:                     &#125;</div><div class="line"><span class="number">123</span>:                 &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line"><span class="number">124</span>:                     <span class="comment">//If hook or user-fallback throws, then use that as the result of the fallback lookup</span></div><div class="line"><span class="number">125</span>:                     fallbackExecutionChain = Observable.error(ex);</div><div class="line"><span class="number">126</span>:                 &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>:                 <span class="comment">// è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘</span></div><div class="line"><span class="number">129</span>:                 <span class="keyword">return</span> fallbackExecutionChain</div><div class="line"><span class="number">130</span>:                         .doOnEach(setRequestContext)</div><div class="line"><span class="number">131</span>:                         .lift(<span class="keyword">new</span> FallbackHookApplication(_cmd)) <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"><span class="number">132</span>:                         .lift(<span class="keyword">new</span> DeprecatedOnFallbackHookApplication(_cmd))</div><div class="line"><span class="number">133</span>:                         .doOnNext(markFallbackEmit)</div><div class="line"><span class="number">134</span>:                         .doOnCompleted(markFallbackCompleted)</div><div class="line"><span class="number">135</span>:                         .onErrorResumeNext(handleFallbackError) <span class="comment">//</span></div><div class="line"><span class="number">136</span>:                         .doOnTerminate(singleSemaphoreRelease)</div><div class="line"><span class="number">137</span>:                         .doOnUnsubscribe(singleSemaphoreRelease);</div><div class="line"><span class="number">138</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">139</span>:                <span class="keyword">return</span> handleFallbackRejectionByEmittingError();</div><div class="line"><span class="number">140</span>:             &#125;</div><div class="line"><span class="number">141</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">142</span>:             <span class="keyword">return</span> handleFallbackDisabledByEmittingError(originalException, failureType, message);</div><div class="line"><span class="number">143</span>:         &#125;</div><div class="line"><span class="number">144</span>:     &#125;</div><div class="line"><span class="number">145</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>è€å¿ƒï¼Œè¿™ä¸ªæ–¹æ³•çœ‹èµ·æ¥ç°å¸¸é•¿ï¼Œä¹Ÿä»…é™äºé•¿ï¼Œç†è§£æˆéš¾åº¦å¾ˆå°ã€‚</p></li><li><p>ç¬¬ 3 è¡Œ ï¼šè®°å½• HystrixRequestContext ã€‚</p></li><li><p>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> æ·»åŠ ( è®°å½• )äº‹ä»¶ã€‚</p></li><li><p>ç¬¬ 10 è‡³ 17 è¡Œ ï¼šè°ƒç”¨ <code>#isUnrecoverable(Exception)</code> æ–¹æ³•ï¼Œè‹¥å¼‚å¸¸<strong>ä¸å¯æ¢å¤</strong>ï¼Œç›´æ¥è¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1077" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 21 è¡Œ ï¼šè°ƒç”¨ <code>#isRecoverableError(Exception)</code> æ–¹æ³•ï¼Œè‹¥å¼‚å¸¸<strong>å¯æ¢å¤</strong>ï¼Œæ‰“å° <code>WARN</code> æ—¥å¿—ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1093" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚ä¸»è¦é’ˆå¯¹ <code>java.lang.Error</code> æƒ…å†µï¼Œæ‰“å° <code>#isUnrecoverable(Exception)</code> æ’é™¤æ‰çš„ Errorã€‚</p></li><li><p>ã€<em>åå‘</em>ã€‘ç¬¬ 141 è‡³ 143 è¡Œ ï¼šå½“é…ç½® <code>HystrixCommandProperties.fallbackEnabled = false</code> ( é»˜è®¤å€¼ ï¼š<code>true</code> ) ï¼Œå³å¤±è´¥å›é€€åŠŸèƒ½<strong>å…³é—­</strong>ï¼Œè°ƒç”¨ <code>#handleFallbackDisabledByEmittingError()</code> ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1047" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚</p></li><li><p>ã€<em>åå‘</em>ã€‘ç¬¬ 138 è‡³ 140 è¡Œ ï¼š<strong>å¤±è´¥å›é€€</strong>ä¿¡å·é‡( TryableSemaphore )ã€æ³¨æ„ï¼Œä¸æ˜¯<strong>æ­£å¸¸æ‰§è¡Œ</strong>ä¿¡å·é‡ã€‘ä½¿ç”¨å¤±è´¥ï¼Œè°ƒç”¨ <code>#handleFallbackRejectionByEmittingError()</code> ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1038" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 23 è¡Œ ï¼šå½“é…ç½® <code>HystrixCommandProperties.fallbackEnabled = true</code> ( é»˜è®¤å€¼ ï¼š<code>true</code> ) ï¼Œå³å¤±è´¥å›é€€åŠŸèƒ½<strong>å¼€å¯</strong>ã€‚</p></li><li><p>ç¬¬ 27 è‡³ 32 è¡Œ ï¼šè®¾ç½® HystrixRequestContext çš„ Action ï¼Œä½¿ç”¨<strong>ç¬¬ 3 è¡Œ</strong>è®°å½•çš„ HystrixRequestContext ã€‚</p></li><li><p>ç¬¬ 35 è‡³ 43 è¡Œ ï¼šTODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</p></li><li><p>ç¬¬ 46 è‡³ 53 è¡Œ ï¼šTODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</p></li><li><p>ç¬¬ 56 è‡³ 95 è¡Œ ï¼šå¤„ç†å›é€€é€»è¾‘æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸çš„ Func1 ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚</p><ul><li>ç¬¬ 61 è¡Œ ï¼šTODO ã€2003ã€‘ã€HOOKã€‘</li><li>ç¬¬ 63 è¡Œ ï¼šè°ƒç”¨ <code>#getExceptionFromThrowable(Throwable)</code> æ–¹æ³•ï¼Œè·å¾— Exception ã€‚è‹¥ <code>t</code> çš„<strong>ç±»å‹</strong>ä¸º Throwable æ—¶ï¼ŒåŒ…è£…æˆ Exception ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1978" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚</li><li>ç¬¬ 68 è‡³ 76 è¡Œ ï¼šå½“ <code>fe</code> çš„<strong>ç±»å‹</strong>ä¸º UnsupportedOperationException æ—¶ï¼Œä½¿ç”¨ <code>e</code> + <code>fe</code> åˆ›å»º HystrixRuntimeException ã€‚è¯¥å¼‚å¸¸å‘ç”Ÿäº <code>HystrixCommand#getFallback()</code> <strong>æŠ½è±¡æ–¹æ³•</strong>æœªè¢«è¦†å†™ã€‚</li><li>ç¬¬ 77 è‡³ 86 è¡Œ ï¼šå½“ <code>fe</code> çš„<strong>ç±»å‹</strong>ä¸ºå…¶ä»–å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ <code>e</code> + <code>fe</code> åˆ›å»º HystrixRuntimeException ã€‚è¯¥å¼‚å¸¸å‘ç”Ÿäº <code>HystrixCommand#getFallback()</code> æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ã€‚</li><li>ç¬¬ 89 è‡³ 91 è¡Œ ï¼šè°ƒç”¨ <code>#shouldNotBeWrapped()</code> æ–¹æ³•ï¼Œåˆ¤æ–­ <code>originalException</code> æ˜¯ ExceptionNotWrappedByHystrix çš„<strong>å®ç°</strong>æ—¶ï¼Œå³<strong>è¦æ±‚</strong>è¿”å›çš„ã€å¼‚å¸¸ Observableã€‘ä¸ä½¿ç”¨ HystrixRuntimeException åŒ…è£…ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1057" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚</li><li>ç¬¬ 93 è¡Œ ï¼šè¿”å›ã€å¼‚å¸¸ Observableã€‘ï¼Œä½¿ç”¨ <code>toEmit</code> ( HystrixRuntimeException ) ä¸ºå¼‚å¸¸ã€‚</li></ul></li><li><p>ç¬¬ 98 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackSemaphore()</code> æ–¹æ³•ï¼Œè·å¾—<strong>å¤±è´¥å›é€€</strong>ä¿¡å·é‡( TryableSemaphore )å¯¹è±¡ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1241" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚TryableSemaphore åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ3. TryableSemaphoreã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 100 è‡³ 109 è¡Œ ï¼šä¿¡å·é‡<strong>é‡Šæ”¾</strong>çš„ Actionã€‚</p></li><li><p>ç¬¬ 114 è‡³ 137 è¡Œ ï¼š<strong>å¤±è´¥å›é€€</strong>ä¿¡å·é‡( TryableSemaphore )ä½¿ç”¨æˆåŠŸï¼Œè¿”å›ã€å›é€€é€»è¾‘ Observableã€‘ã€‚</p><ul><li>ã€é‡è¦ã€‘ç¬¬ 116 è‡³ 122 è¡Œ ï¼šè°ƒç”¨ <code>#getFallbackObservable()</code> æ–¹æ³•ï¼Œåˆ›å»ºã€å›é€€é€»è¾‘ Observableã€‘ã€‚å°†å­ç±»å¯¹ <code>HystrixCommand#getFallback()</code> <strong>æŠ½è±¡æ–¹æ³•</strong>çš„æ‰§è¡Œç»“æœï¼Œä½¿ç”¨ <code>Observable#just(...)</code> åŒ…è£…è¿”å›ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java#L314" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•çš„ä»£ç ã€‚<ul><li>ç¬¬ 116 è¡Œ ï¼šè°ƒç”¨ <code>#isFallbackUserDefined()</code> æ–¹æ³•ï¼Œè¿”å›<strong>å‘½ä»¤å­ç±»</strong>æ˜¯å¦å®ç° <code>HystrixCommand#getFallback()</code> <strong>æŠ½è±¡æ–¹æ³•</strong>ã€‚åªæœ‰å·²å®ç°( <code>true</code> ) çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ HOOK TODO ã€2003ã€‘ã€HOOKã€‘ã€‚</li></ul></li><li>ç¬¬ 129 è‡³ 137 è¡Œ ï¼šè·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ã€‚<ul><li>ç¬¬ 131 è¡Œ ï¼š// TODO ã€2003ã€‘ã€HOOKã€‘</li><li>ç¬¬ 135 è¡Œ ï¼šè°ƒç”¨ <code>Observable#onErrorResumeNext(...)</code> æ–¹æ³•ï¼Œå®ç°ã€å¤±è´¥å›é€€ Observableã€‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚</li></ul></li></ul></li></ul><hr><p>æœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹ï¼š</p><ul><li>å½“å‘½ä»¤æ‰§è¡Œ<strong>è¶…æ—¶</strong>æ—¶ï¼Œå¤±è´¥å›é€€é€»è¾‘ä½¿ç”¨çš„æ˜¯ <strong>HystrixTimer çš„çº¿ç¨‹æ± </strong>ã€‚</li><li>å¤±è´¥å›é€€é€»è¾‘ï¼Œæ— è¶…æ—¶æ—¶é—´ï¼Œä½¿ç”¨è¦å°å¿ƒã€‚</li></ul><h1>666. å½©è›‹</h1><p>æ¯”æƒ³è±¡ä¸­â€œè‡­é•¿â€çš„é€»è¾‘ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œé€»è¾‘å’Œ <a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹</a> æ˜¯å¾ˆç±»ä¼¼çš„ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/stron
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸‰ï¼‰ä¹‹æ‰§è¡Œè¶…æ—¶</title>
    <link href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/"/>
    <id>http://www.iocoder.cn/Hystrix/command-execute-third-timeout/</id>
    <published>2018-10-27T16:00:00.000Z</published>
    <updated>2017-11-08T09:55:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-third-timeout/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">2. HystrixObservableTimeoutOperator</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">3. HystrixTimer</a><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">3.1 ScheduledExecutor</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">3.2 TimerListener</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">3.3 TimerReference</a></li></ul></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix å‘½ä»¤æ‰§è¡Œï¼ˆä¸‰ï¼‰ä¹‹æ‰§è¡Œè¶…æ—¶</strong>ã€‚</p><p>å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚</p><p>å¼€å¯<strong>æ‰§è¡Œè¶…æ—¶</strong>åŠŸèƒ½ï¼Œéœ€è¦é…ç½® ï¼š</p><ul><li><code>HystrixCommandProperties.executionTimeoutEnabled</code> ï¼šæ‰§è¡Œå‘½ä»¤è¶…æ—¶åŠŸèƒ½å¼€å…³ã€‚<ul><li>å€¼ ï¼šBoolean</li><li>é»˜è®¤å€¼ ï¼š<code>true</code></li></ul></li><li><code>HystrixCommandProperties.executionTimeoutInMilliseconds</code> ï¼šæ‰§è¡Œå‘½ä»¤è¶…æ—¶æ—¶é•¿ã€‚<ul><li>å€¼ ï¼šInteger</li><li>å•ä½ ï¼šæ¯«ç§’</li><li>é»˜è®¤å€¼ ï¼š1000 æ¯«ç§’</li></ul></li></ul><p>åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ4. #executeCommandAndObserve(â€¦)ã€</a> ä¸­ï¼Œ<code>#executeCommandAndObserve(...)</code> æ–¹æ³•çš„<strong>ç¬¬ 75 è¡Œ</strong> <code>lift(new HystrixObservableTimeoutOperator&lt;R&gt;(_cmd))</code> ï¼Œå®ç°äº†å¯¹æ‰§è¡Œå‘½ä»¤è¶…æ—¶çš„ç›‘æ§ã€‚</p><ul><li>å¯¹ <code>Observable#lift(Operator)</code> æ–¹æ³•ä¸ç†Ÿæ‚‰çš„åŒå­¦ï¼Œåœ¨ <a href="http://www.iocoder.cn/RxJava/observable-lift-operator/?self">ã€ŠRxJava æºç è§£æ â€”â€” Observable#lift(Operator)ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. HystrixObservableTimeoutOperator</h1><p>HystrixObservableTimeoutOperator ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixObservableTimeoutOperator</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Operator</span>&lt;<span class="title">R</span>, <span class="title">R</span>&gt; </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="keyword">final</span> AbstractCommand&lt;R&gt; originalCommand;</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="title">HystrixObservableTimeoutOperator</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; originalCommand)</span> </span>&#123;</div><div class="line">  <span class="number">6</span>:         <span class="keyword">this</span>.originalCommand = originalCommand;</div><div class="line">  <span class="number">7</span>:     &#125;</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> R&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> R&gt; child) &#123;</div><div class="line"> <span class="number">11</span>:         <span class="comment">// åˆ›å»º è®¢é˜…</span></div><div class="line"> <span class="number">12</span>:         <span class="keyword">final</span> CompositeSubscription s = <span class="keyword">new</span> CompositeSubscription();</div><div class="line"> <span class="number">13</span>:         <span class="comment">// æ·»åŠ  è®¢é˜…</span></div><div class="line"> <span class="number">14</span>:         <span class="comment">// if the child unsubscribes we unsubscribe our parent as well</span></div><div class="line"> <span class="number">15</span>:         child.add(s);</div><div class="line"> <span class="number">16</span>: </div><div class="line"> <span class="number">17</span>:         <span class="comment">//capture the HystrixRequestContext upfront so that we can use it in the timeout thread later</span></div><div class="line"> <span class="number">18</span>:         <span class="keyword">final</span> HystrixRequestContext hystrixRequestContext = HystrixRequestContext.getContextForCurrentThread();</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:         TimerListener listener = <span class="keyword">new</span> TimerListener() &#123;</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">23</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tick</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:                 <span class="comment">// if we can go from NOT_EXECUTED to TIMED_OUT then we do the timeout codepath</span></div><div class="line"> <span class="number">25</span>:                 <span class="comment">// otherwise it means we lost a race and the run() execution completed or did not start</span></div><div class="line"> <span class="number">26</span>:                 <span class="keyword">if</span> (originalCommand.isCommandTimedOut.compareAndSet(TimedOutStatus.NOT_EXECUTED, TimedOutStatus.TIMED_OUT)) &#123;</div><div class="line"> <span class="number">27</span>:                     <span class="comment">// report timeout failure</span></div><div class="line"> <span class="number">28</span>:                     originalCommand.eventNotifier.markEvent(HystrixEventType.TIMEOUT, originalCommand.commandKey);</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:                     <span class="comment">// shut down the original request</span></div><div class="line"> <span class="number">31</span>:                     s.unsubscribe();</div><div class="line"> <span class="number">32</span>: </div><div class="line"> <span class="number">33</span>:                     <span class="keyword">final</span> HystrixContextRunnable timeoutRunnable = <span class="keyword">new</span> HystrixContextRunnable(originalCommand.concurrencyStrategy, hystrixRequestContext, <span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:                         <span class="meta">@Override</span></div><div class="line"> <span class="number">36</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">37</span>:                             child.onError(<span class="keyword">new</span> HystrixTimeoutException());</div><div class="line"> <span class="number">38</span>:                         &#125;</div><div class="line"> <span class="number">39</span>:                     &#125;);</div><div class="line"> <span class="number">40</span>: </div><div class="line"> <span class="number">41</span>:                     timeoutRunnable.run();</div><div class="line"> <span class="number">42</span>:                     <span class="comment">//if it did not start, then we need to mark a command start for concurrency metrics, and then issue the timeout</span></div><div class="line"> <span class="number">43</span>:                 &#125;</div><div class="line"> <span class="number">44</span>:             &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">47</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntervalTimeInMilliseconds</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">48</span>:                 <span class="keyword">return</span> originalCommand.properties.executionTimeoutInMilliseconds().get();</div><div class="line"> <span class="number">49</span>:             &#125;</div><div class="line"> <span class="number">50</span>:         &#125;;</div><div class="line"> <span class="number">51</span>: </div><div class="line"> <span class="number">52</span>:         <span class="keyword">final</span> Reference&lt;TimerListener&gt; tl = HystrixTimer.getInstance().addTimerListener(listener);</div><div class="line"> <span class="number">53</span>: </div><div class="line"> <span class="number">54</span>:         <span class="comment">// set externally so execute/queue can see this</span></div><div class="line"> <span class="number">55</span>:         originalCommand.timeoutTimer.set(tl);</div><div class="line"> <span class="number">56</span>: </div><div class="line"> <span class="number">57</span>:         <span class="comment">/**</span></div><div class="line"><span class="comment"> 58:          * If this subscriber receives values it means the parent succeeded/completed</span></div><div class="line"><span class="comment"> 59:          */</span></div><div class="line"> <span class="number">60</span>:         Subscriber&lt;R&gt; parent = <span class="keyword">new</span> Subscriber&lt;R&gt;() &#123;</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">63</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">64</span>:                 <span class="keyword">if</span> (isNotTimedOut()) &#123;</div><div class="line"> <span class="number">65</span>:                     <span class="comment">// stop timer and pass notification through</span></div><div class="line"> <span class="number">66</span>:                     tl.clear();</div><div class="line"> <span class="number">67</span>:                     <span class="comment">// å®Œæˆ</span></div><div class="line"> <span class="number">68</span>:                     child.onCompleted();</div><div class="line"> <span class="number">69</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">70</span>:                     System.out.println(<span class="string">"timeout: "</span> + <span class="string">"onCompleted"</span>); <span class="comment">// ç¬”è€…è°ƒè¯•ç”¨</span></div><div class="line"> <span class="number">71</span>:                 &#125; </div><div class="line"> <span class="number">72</span>:             &#125;</div><div class="line"> <span class="number">73</span>: </div><div class="line"> <span class="number">74</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">75</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"> <span class="number">76</span>:                 <span class="keyword">if</span> (isNotTimedOut()) &#123;</div><div class="line"> <span class="number">77</span>:                     <span class="comment">// stop timer and pass notification through</span></div><div class="line"> <span class="number">78</span>:                     tl.clear();</div><div class="line"> <span class="number">79</span>:                     <span class="comment">// å¼‚å¸¸</span></div><div class="line"> <span class="number">80</span>:                     child.onError(e);</div><div class="line"> <span class="number">81</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">82</span>:                     System.out.println(<span class="string">"timeout: "</span> + <span class="string">"onError"</span>); <span class="comment">// ç¬”è€…è°ƒè¯•ç”¨</span></div><div class="line"> <span class="number">83</span>:                 &#125; </div><div class="line"> <span class="number">84</span>:             &#125;</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">87</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(R v)</span> </span>&#123;</div><div class="line"> <span class="number">88</span>:                 <span class="keyword">if</span> (isNotTimedOut()) &#123;</div><div class="line"> <span class="number">89</span>:                     <span class="comment">// ç»§ç»­æ‰§è¡Œ</span></div><div class="line"> <span class="number">90</span>:                     child.onNext(v);</div><div class="line"> <span class="number">91</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">92</span>:                     System.out.println(<span class="string">"timeout: "</span> + <span class="string">"onNext"</span>); <span class="comment">// ç¬”è€…è°ƒè¯•ç”¨</span></div><div class="line"> <span class="number">93</span>:                 &#125;</div><div class="line"> <span class="number">94</span>:             &#125;</div><div class="line"> <span class="number">95</span>: </div><div class="line"> <span class="number">96</span>:             <span class="comment">/**</span></div><div class="line"><span class="comment"> 97:              * é€šè¿‡ CAS åˆ¤æ–­æ˜¯å¦è¶…æ—¶</span></div><div class="line"><span class="comment"> 98:              *</span></div><div class="line"><span class="comment"> 99:              * <span class="doctag">@return</span> æ˜¯å¦è¶…æ—¶</span></div><div class="line"><span class="comment">100:              */</span></div><div class="line"><span class="number">101</span>:             <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNotTimedOut</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">102</span>:                 <span class="comment">// if already marked COMPLETED (by onNext) or succeeds in setting to COMPLETED</span></div><div class="line"><span class="number">103</span>:                 <span class="keyword">return</span> originalCommand.isCommandTimedOut.get() == TimedOutStatus.COMPLETED ||</div><div class="line"><span class="number">104</span>:                         originalCommand.isCommandTimedOut.compareAndSet(TimedOutStatus.NOT_EXECUTED, TimedOutStatus.COMPLETED);</div><div class="line"><span class="number">105</span>:             &#125;</div><div class="line"><span class="number">106</span>: </div><div class="line"><span class="number">107</span>:         &#125;;</div><div class="line"><span class="number">108</span>: </div><div class="line"><span class="number">109</span>:         <span class="comment">// æ·»åŠ  è®¢é˜…</span></div><div class="line"><span class="number">110</span>:         <span class="comment">// if s is unsubscribed we want to unsubscribe the parent</span></div><div class="line"><span class="number">111</span>:         s.add(parent);</div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:         <span class="keyword">return</span> parent;</div><div class="line"><span class="number">114</span>:     &#125;</div><div class="line"><span class="number">115</span>: </div><div class="line"><span class="number">116</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 12 è¡Œ ï¼šåˆ›å»ºè®¢é˜… <code>s</code> ã€‚</p></li><li><p>ç¬¬ 15 è¡Œ ï¼šæ·»åŠ è®¢é˜… <code>s</code> åˆ° <code>child</code> çš„è®¢é˜…ã€‚</p></li><li><p>ç¬¬ 18 è¡Œ ï¼šè·å¾— HystrixRequestContext ã€‚å› ä¸ºä¸‹é¢ <code>listener</code> çš„æ‰§è¡Œä¸åœ¨å½“å‰çº¿ç¨‹ï¼ŒHystrixRequestContext åŸºäº ThreadLocal å®ç°ã€‚</p></li><li><p>ç¬¬ 20 è‡³ 50 è¡Œ ï¼šåˆ›å»ºæ‰§è¡Œå‘½ä»¤è¶…æ—¶<strong>ç›‘å¬å™¨</strong> <code>listener</code> ( TimerListener ) ã€‚å½“è¶…è¿‡æ‰§è¡Œå‘½ä»¤çš„æ—¶é•¿( <code>TimerListener#getIntervalTimeInMilliseconds()</code> )æ—¶ï¼Œ<code>TimerListener#tick()</code> æ–¹æ³•<strong>è§¦å‘</strong>è°ƒç”¨ã€‚</p><ul><li>ç¬¬ 26 è¡Œ ï¼šé€šè¿‡ <code>AbstractCommand.isCommandTimedOut</code> å˜é‡ CAS æ“ä½œï¼Œä¿è¯å’Œä¸‹é¢<strong>ç¬¬ 60 è¡Œ</strong>çš„ <code>parent</code> æœ‰ä¸”åªæœ‰ä¸€æ–¹æ“ä½œæˆåŠŸã€‚TimedOutStatus çŠ¶æ€å˜è¿å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/Hystrix/2018_10_28/01.png" alt=""></li><li>ç¬¬ 28 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</li><li>ç¬¬ 31 è¡Œ ï¼šå–æ¶ˆè®¢é˜… <code>s</code> ã€‚<strong>æ³¨æ„ ï¼šä¸åŒæ‰§è¡Œéš”ç¦»ç­–ç•¥æ­¤å¤„çš„è¡¨ç°ä¸åŒ</strong>ã€‚<ul><li><code>ExecutionIsolationStrategy.THREAD</code> ï¼šè¯¥ç­–ç•¥ä¸‹æä¾›å–æ¶ˆè®¢é˜…( <code>#unsubscribe()</code> )ï¼Œå¹¶ä¸”å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œ<strong>å¼ºåˆ¶</strong>å–æ¶ˆå‘½ä»¤çš„æ‰§è¡Œã€‚åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹ã€Œ6.5 FutureCompleterWithConfigurableInterruptã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>ExecutionIsolationStrategy.SEMAPHORE</code> ï¼šè¯¥ç­–ç•¥ä¸‹<strong>æœª</strong>æä¾›å–æ¶ˆè®¢é˜…( <code>#unsubscribe()</code> )æ—¶ï¼Œå¯¹è¶…æ—¶æ‰§è¡Œå‘½ä»¤çš„å–æ¶ˆã€‚<strong>æ‰€ä»¥ï¼Œåœ¨é€‰æ‹©æ‰§è¡Œéš”ç¦»ç­–ç•¥ï¼Œè¦æ³¨æ„è¿™å—</strong>ã€‚</li></ul></li><li>ç¬¬ 34 è‡³ 41 è¡Œ ï¼šæ‰§è¡Œ <code>child#onError(e) ã€Subscriber#onError(Throwable)ã€‘</code> æ–¹æ³•ï¼Œå¤„ç† HystrixTimeoutException å¼‚å¸¸ã€‚è¯¥å¼‚å¸¸ä¼šè¢« <code>handleFallback</code> å¤„ç†ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L602" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/?self">ã€ŠHystrix æºç è§£æ â€”â€” è¯·æ±‚æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘ã€‹</a> è¯¦ç»†è§£æã€‚<ul><li>HystrixContextRunnable ï¼Œè®¾ç½®<strong>ç¬¬ 18 è¡Œ</strong>è·å¾—çš„ HystrixRequestContext åˆ° <code>Callable#run()</code> æ‰€åœ¨çº¿ç¨‹çš„ HystrixRequestContext ï¼Œå¹¶ç»§ç»­æ‰§è¡Œã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextRunnable.java#L27" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚å¦å¤–ï¼ŒHystrixContextRunnable åªæœ‰æ­¤å¤„ä½¿ç”¨ï¼Œç‹¬ç«‹æˆç±»çš„åŸå› æ˜¯æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨åˆ°ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 52 è¡Œ ï¼šä½¿ç”¨ TimerListener åˆ°å®šæ—¶å™¨ï¼Œç›‘å¬å‘½ä»¤çš„è¶…æ—¶æ‰§è¡Œã€‚</p></li><li><p>ç¬¬ 55 è¡Œ ï¼šè®¾ç½® TimerListener åˆ° <code>AbstractCommand.timeoutTimer</code> å±æ€§ã€‚ç”¨äºæ‰§è¡Œè¶…æ—¶ç­‰ç­‰åœºæ™¯ä¸‹çš„ TimerListener çš„æ¸…ç†( <code>tl#clear()</code> )ã€‚å¦‚ä¸‹æ–¹æ³•æœ‰é€šè¿‡è¯¥å±æ€§å¯¹ TimerListener çš„æ¸…ç† ï¼š</p><ul><li><a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L947" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractCommand#handleCommandEnd()</code></a></li><li><a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L930" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractCommand#cleanUpAfterResponseFromCache()</code></a></li></ul></li><li><p>ç¬¬ 60 è‡³ 107 è¡Œ ï¼šåˆ›å»º<strong>æ–°</strong>çš„ Subscriber ( <code>parent</code> )ã€‚åœ¨ä¼ å‚çš„ <code>child</code> çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¯¹æ˜¯å¦æ‰§è¡Œè¶…æ—¶çš„åˆ¤æ–­( <code>#isNotTimedOut()</code> )å’ŒTimerListenerçš„æ¸…ç†ã€‚</p></li><li><p>ç¬¬ 111 è¡Œ ï¼šæ·»åŠ æ·»åŠ è®¢é˜… <code>parent</code> åˆ° <code>s</code> çš„è®¢é˜…ã€‚æ•´ä½“è®¢é˜…å…³ç³»å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/Hystrix/2018_10_28/02.png" alt=""></p><ul><li>è¿™é‡Œçœ‹èµ·æ¥ <code>s</code> æœ‰äº›â€œå¤šä½™â€ ï¼Ÿå› ä¸º <code>parent</code> å’Œ <code>listener</code> å­˜åœ¨äº’ç›¸å¼•ç”¨çš„æƒ…å†µï¼Œé€šè¿‡ <code>s</code> è§£å†³ã€‚</li></ul></li><li><p>ç¬¬ 113 è¡Œ ï¼šè¿”å› <code>parent</code> ã€‚<strong>æ³¨æ„</strong>ã€‚å¦‚æœä¸èƒ½ç†è§£ï¼Œå»ºè®®é˜…è¯»ä¸‹ <a href="http://www.iocoder.cn/RxJava/observable-lift-operator/?self">ã€ŠRxJava æºç è§£æ â€”â€” Observable#lift(Operator)ã€‹</a> ã€‚</p></li></ul><h1>3. HystrixTimer</h1><p><code>com.netflix.hystrix.util.HystrixTimer</code> ï¼ŒHystrix å®šæ—¶å™¨ã€‚</p><p>ç›®å‰æœ‰å¦‚ä¸‹åœºæ™¯ä½¿ç”¨ ï¼š</p><ul><li>æ‰§è¡Œå‘½ä»¤è¶…æ—¶ä»»åŠ¡ï¼Œæœ¬æ–‡è¯¦ç»†è§£æã€‚</li><li>å‘½ä»¤æ‰¹é‡æ‰§è¡Œï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-collapser-execute?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤åˆå¹¶æ‰§è¡Œã€‹ã€Œ5. CollapsedTaskã€</a> è¯¦ç»†è§£æã€‚</li></ul><p>HystrixTimer <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixTimer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HystrixTimer INSTANCE = <span class="keyword">new</span> HystrixTimer();</div><div class="line"></div><div class="line">    <span class="comment">/* package */</span> AtomicReference&lt;ScheduledExecutor&gt; executor = <span class="keyword">new</span> AtomicReference&lt;ScheduledExecutor&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HystrixTimer</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// private to prevent public instantiation</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HystrixTimer <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>INSTANCE</code> <strong>é™æ€</strong>å±æ€§ï¼Œå•ä¾‹ã€‚</li><li><code>executor</code> å±æ€§ï¼Œå®šæ—¶ä»»åŠ¡<strong>æ‰§è¡Œå™¨</strong>( ScheduledExecutor )ã€‚</li></ul><hr><p>è°ƒç”¨ <code>HystrixTimer#addTimerListener(TimerListener)</code> æ–¹æ³•ï¼Œæäº¤å®šæ—¶<strong>ç›‘å¬å™¨</strong>ï¼Œç”Ÿæˆå®šæ—¶<strong>ä»»åŠ¡</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Reference&lt;TimerListener&gt; <span class="title">addTimerListener</span><span class="params">(<span class="keyword">final</span> TimerListener listener)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     startThreadIfNeeded();</div><div class="line"> <span class="number">3</span>:     <span class="comment">// add the listener</span></div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">8</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">10</span>:                 listener.tick();</div><div class="line"><span class="number">11</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">12</span>:                 logger.error(<span class="string">"Failed while ticking TimerListener"</span>, e);</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125;;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     ScheduledFuture&lt;?&gt; f = executor.get().getThreadPool().scheduleAtFixedRate(r, listener.getIntervalTimeInMilliseconds(), listener.getIntervalTimeInMilliseconds(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">18</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TimerReference(listener, f);</div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>#startThreadIfNeeded()</code> æ–¹æ³•ï¼Œä¿è¯ <code>executor</code> <strong>å»¶è¿Ÿ</strong>åˆå§‹åŒ–å·²å®Œæˆã€‚<ul><li><code>#startThreadIfNeeded()</code> æ–¹æ³• ï¼Œæ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/util/HystrixTimer.java#L133" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</li><li>ScheduledExecutor åœ¨ <a href="#">ã€Œ3.1 ScheduledExecutorã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 5 è‡³ 15 è¡Œ ï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ Runnable ã€‚åœ¨ <code>Runnable#run()</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>TimerListener#tick()</code> æ–¹æ³•ã€‚åœ¨ <a href="#">ã€Œ3.2 TimerListenerã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 17 è¡Œ ï¼šæäº¤å®šæ—¶<strong>ç›‘å¬å™¨</strong>ï¼Œç”Ÿæˆå®šæ—¶<strong>ä»»åŠ¡</strong> <code>f</code> ( ScheduledFuture )ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šä½¿ç”¨ <code>listener</code> + <code>f</code> åˆ›å»º TimerReference è¿”å›ã€‚åœ¨ <a href="#">ã€Œ3.3 TimerReferenceã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>3.1 ScheduledExecutor</h2><p><code>com.netflix.hystrix.util.HystrixTimer.ScheduledExecutor</code> ï¼ŒHystrix å®šæ—¶ä»»åŠ¡<strong>æ‰§è¡Œå™¨</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package */</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledExecutor</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="comment">/* package */</span> <span class="keyword">volatile</span> ScheduledThreadPoolExecutor executor;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦åˆå§‹åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * We want this only done once when created in compareAndSet so use an initialize method</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// coreSize</span></div><div class="line">        HystrixPropertiesStrategy propertiesStrategy = HystrixPlugins.getInstance().getPropertiesStrategy();</div><div class="line">        <span class="keyword">int</span> coreSize = propertiesStrategy.getTimerThreadPoolProperties().getCorePoolSize().get();</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»º ThreadFactory</span></div><div class="line">        ThreadFactory threadFactory = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (!PlatformSpecific.isAppEngineStandardEnvironment()) &#123;</div><div class="line">            threadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">                <span class="keyword">final</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">                    Thread thread = <span class="keyword">new</span> Thread(r, <span class="string">"HystrixTimer-"</span> + counter.incrementAndGet());</div><div class="line">                    thread.setDaemon(<span class="keyword">true</span>);</div><div class="line">                    <span class="keyword">return</span> thread;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            threadFactory = PlatformSpecific.getAppEngineThreadFactory();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»º ScheduledThreadPoolExecutor</span></div><div class="line">        executor = <span class="keyword">new</span> ScheduledThreadPoolExecutor(coreSize, threadFactory);</div><div class="line"></div><div class="line">        <span class="comment">// å·²åˆå§‹åŒ–</span></div><div class="line">        initialized = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> ScheduledThreadPoolExecutor <span class="title">getThreadPool</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> executor;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInitialized</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> initialized;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>çº¿ç¨‹æ± å¤§å°( <code>coreSize</code> )ï¼Œé€šè¿‡ <code>HystrixTimerThreadPoolProperties.corePoolSize</code> é…ç½®ã€‚</li></ul><h2>3.2 TimerListener</h2><p><code>com.netflix.hystrix.util.HystrixTimer.TimerListener</code> ï¼ŒHystrix å®šæ—¶ä»»åŠ¡<strong>ç›‘å¬å™¨</strong><strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">TimerListener</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * The 'tick' is called each time the interval occurs.</span></div><div class="line"><span class="comment">    * &lt;p&gt;</span></div><div class="line"><span class="comment">    * This method should NOT block or do any work but instead fire its work asynchronously to perform on another thread otherwise it will prevent the Timer from functioning.</span></div><div class="line"><span class="comment">    * &lt;p&gt;</span></div><div class="line"><span class="comment">    * This contract is used to keep this implementation single-threaded and simplistic.</span></div><div class="line"><span class="comment">    * &lt;p&gt;</span></div><div class="line"><span class="comment">    * If you need a ThreadLocal set, you can store the state in the TimerListener, then when tick() is called, set the ThreadLocal to your desired value.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">tick</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * How often this TimerListener should 'tick' defined in milliseconds.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">int</span> <span class="title">getIntervalTimeInMilliseconds</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#tick()</code> æ–¹æ³• ï¼šæ—¶é—´åˆ°è¾¾( <strong>è¶…æ—¶</strong> )æ‰§è¡Œçš„é€»è¾‘ã€‚</li><li><code>#getIntervalTimeInMilliseconds()</code> æ–¹æ³• ï¼šè¿”å›åˆ°è¾¾( <strong>è¶…æ—¶</strong> )æ—¶é—´æ—¶é•¿ã€‚</li></ul><h2>3.3 TimerReference</h2><p><code>com.netflix.hystrix.util.HystrixTimer.TimerReference</code> ï¼ŒHystrix å®šæ—¶ä»»åŠ¡<strong>å¼•ç”¨</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerReference</span> <span class="keyword">extends</span> <span class="title">SoftReference</span>&lt;<span class="title">TimerListener</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledFuture&lt;?&gt; f;</div><div class="line"></div><div class="line">    TimerReference(TimerListener referent, ScheduledFuture&lt;?&gt; f) &#123;</div><div class="line">        <span class="keyword">super</span>(referent);</div><div class="line">        <span class="keyword">this</span>.f = f;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.clear();</div><div class="line">        <span class="comment">// stop this ScheduledFuture from any further executions</span></div><div class="line">        f.cancel(<span class="keyword">false</span>); <span class="comment">// éå¼ºåˆ¶</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡ <code>#clear()</code> æ–¹æ³•ï¼Œå¯ä»¥å–æ¶ˆå®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œã€‚</li></ul><h1>666. å½©è›‹</h1><p>é¡ºç•…~åˆšå¼€å§‹çœ‹ Hystrix æ‰§è¡Œå‘½ä»¤è¶…æ—¶é€»è¾‘ï¼Œä¸€ç›´æƒ³ä¸é€šã€‚ç°åœ¨æ•´ç†å¹²å‡€äº†ã€‚</p><p>å–µäº†ä¸ªå’ª~</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-third-timeout/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/strong&gt;
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥</title>
    <link href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/"/>
    <id>http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/</id>
    <published>2018-10-24T16:00:00.000Z</published>
    <updated>2017-11-06T10:40:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">2. HystrixThreadPoolProperties</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">3. HystrixThreadPoolKey</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">4. HystrixConcurrencyStrategy</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">5. HystrixThreadPool</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">6. HystrixScheduler</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>ã€‚</p><p>å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚</p><p>Hystrix æä¾›ä¸¤ç§æ‰§è¡Œéš”ç¦»ç­–ç•¥( ExecutionIsolationStrategy ) ï¼š</p><ul><li><code>SEMAPHORE</code> ï¼šä¿¡å·é‡ï¼Œå‘½ä»¤åœ¨<strong>è°ƒç”¨çº¿ç¨‹</strong>æ‰§è¡Œã€‚åœ¨<a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ3. TryableSemaphoreã€</a> å·²ç»è¯¦ç»†è§£æã€‚</li><li><code>THREAD</code> ï¼šçº¿ç¨‹æ± ï¼Œå‘½ä»¤åœ¨<strong>çº¿ç¨‹æ± </strong>æ‰§è¡Œã€‚åœ¨<a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ5. #executeCommandWithSpecifiedIsolation(...)ã€</a> çš„ <code>#executeCommandWithSpecifiedIsolation(...)</code> æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>Observable#subscribeOn(Scheduler)</code> æ–¹æ³•ï¼ŒæŒ‡å®šåœ¨ RxJava Scheduler æ‰§è¡Œã€‚<ul><li>å¦‚æœä½ æš‚æ—¶ä¸äº†è§£ Scheduler ï¼Œå¯ä»¥é˜…è¯» <a href="http://www.iocoder.cn/RxJava/scheduler/?self">ã€ŠRxJava æºç è§£æ â€”â€” Schedulerã€‹</a> ã€‚</li><li>å¦‚æœä½ æš‚æ—¶ä¸äº†è§£ <code>Observable#subscribeOn(Scheduler)</code> ï¼Œå¯ä»¥é˜…è¯» <a href="http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/?self">ã€ŠRxJava æºç è§£æ â€”â€” Observable#subscribeOn(Scheduler)ã€‹</a> ã€‚</li></ul></li></ul><p>ä¸¤ç§æ–¹å¼çš„<strong>ä¼˜ç¼ºç‚¹æ¯”è¾ƒ</strong>ï¼Œæ¨èé˜…è¯» <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E4%BE%9D%E8%B5%96%E9%9A%94%E7%A6%BB" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œä¾èµ–éš”ç¦»ã€</a>ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. HystrixThreadPoolProperties</h1><p><code>com.netflix.hystrix.HystrixThreadPoolProperties</code> ï¼ŒHystrix çº¿ç¨‹æ± å±æ€§é…ç½®<strong>æŠ½è±¡ç±»</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/ba86690747b365482c306ec3a0725e0be4bab739/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPoolProperties.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ï¼Œå·²æ·»åŠ ä¸­æ–‡æ³¨é‡Šè¯´æ˜ã€‚</p><p><code>com.netflix.hystrix.strategy.properties.HystrixPropertiesThreadPoolDefault</code> ï¼ŒHystrix çº¿ç¨‹æ± é…ç½®<strong>å®ç°ç±»</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/ba86690747b365482c306ec3a0725e0be4bab739/hystrix-core/src/main/java/com/netflix/hystrix/strategy/properties/HystrixPropertiesThreadPoolDefault.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚å®é™…ä¸Šæ²¡ä»€ä¹ˆå†…å®¹ï¼Œå®˜æ–¹å¦‚æ˜¯è¯´ ï¼š</p><blockquote><p>Default implementation of {@link HystrixThreadPoolProperties} using Archaius (https://github.com/Netflix/archaius)</p></blockquote><h1>3. HystrixThreadPoolKey</h1><p><code>com.netflix.hystrix.HystrixThreadPoolKey</code> ï¼ŒHystrix çº¿ç¨‹æ± æ ‡è¯†<strong>æ¥å£</strong>ã€‚</p><blockquote><p>FROM HystrixThreadPoolKey æ¥å£æ³¨é‡Š<br>A key to represent a {@link HystrixThreadPool} for monitoring, metrics publishing, caching and other such uses.<br>This interface is intended to work natively with Enums so that implementing code can be an enum that implements this interface.</p></blockquote><ul><li>ç›´ç™½çš„è¯´ ï¼Œå¸Œæœ›é€šè¿‡ç›¸åŒçš„ <code>name</code> ( æ ‡è¯† ) è·å¾—åŒ HystrixThreadPoolKey å¯¹è±¡ã€‚é€šè¿‡åœ¨å†…éƒ¨ç»´æŒä¸€ä¸ª <code>name</code> ä¸ HystrixThreadPoolKey å¯¹è±¡çš„æ˜ å°„ï¼Œä»¥è¾¾åˆ°<strong>æšä¸¾</strong>çš„æ•ˆæœã€‚</li></ul><p>HystrixThreadPoolKey ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HystrixThreadPoolKey</span> <span class="keyword">extends</span> <span class="title">HystrixKey</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:         <span class="function"><span class="keyword">private</span> <span class="title">Factory</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:         &#125;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:         <span class="comment">// used to intern instances so we don't keep re-creating them millions of times for the same key</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InternMap&lt;String, HystrixThreadPoolKey&gt; intern</div><div class="line"> <span class="number">8</span>:                 = <span class="keyword">new</span> InternMap&lt;String, HystrixThreadPoolKey&gt;(</div><div class="line"> <span class="number">9</span>:                 <span class="keyword">new</span> InternMap.ValueConstructor&lt;String, HystrixThreadPoolKey&gt;() &#123;</div><div class="line"><span class="number">10</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>:                     <span class="function"><span class="keyword">public</span> HystrixThreadPoolKey <span class="title">create</span><span class="params">(String key)</span> </span>&#123;</div><div class="line"><span class="number">12</span>:                         <span class="keyword">return</span> <span class="keyword">new</span> HystrixThreadPoolKeyDefault(key);</div><div class="line"><span class="number">13</span>:                     &#125;</div><div class="line"><span class="number">14</span>:                 &#125;);</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HystrixThreadPoolKey <span class="title">asKey</span><span class="params">(String name)</span> </span>&#123;</div><div class="line"><span class="number">17</span>:            <span class="keyword">return</span> intern.interned(name);</div><div class="line"><span class="number">18</span>:         &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:         <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixThreadPoolKeyDefault</span> <span class="keyword">extends</span> <span class="title">HystrixKeyDefault</span> <span class="keyword">implements</span> <span class="title">HystrixThreadPoolKey</span> </span>&#123;</div><div class="line"><span class="number">21</span>:             <span class="function"><span class="keyword">public</span> <span class="title">HystrixThreadPoolKeyDefault</span><span class="params">(String name)</span> </span>&#123;</div><div class="line"><span class="number">22</span>:                 <span class="keyword">super</span>(name);</div><div class="line"><span class="number">23</span>:             &#125;</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="comment">/* package-private */</span> <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getThreadPoolCount</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">27</span>:             <span class="keyword">return</span> intern.size();</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>HystrixThreadPoolKey å®ç° <code>com.netflix.hystrix.HystrixKey</code> <strong>æ¥å£</strong>ï¼Œç‚¹å‡» <a href="https://github.com/Netflix/Hystrix/blob/d838f4d1ba65ce55755ab1c73f74c980f04572bf/hystrix-core/src/main/java/com/netflix/hystrix/HystrixKey.java#L6" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚è¯¥æ¥å£å®šä¹‰çš„ <code>#name()</code> æ–¹æ³•ï¼Œå³æ˜¯ä¸Šæ–‡æˆ‘ä»¬æ‰€è¯´çš„æ ‡è¯†( Key )ã€‚</li><li><code>intern</code> å±æ€§ï¼Œ<code>name</code> ä¸ HystrixThreadPoolKey å¯¹è±¡çš„æ˜ å°„ï¼Œä»¥è¾¾åˆ°<strong>æšä¸¾</strong>çš„æ•ˆæœã€‚<ul><li><code>com.netflix.hystrix.util.InternMap</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/util/InternMap.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ä»£ç ã€‚</li></ul></li><li><code>#asKey(name)</code> æ–¹æ³•ï¼Œä» <code>intern</code> è·å¾— HystrixThreadPoolKey å¯¹è±¡ã€‚</li><li><code>#getThreadPoolCount()</code> æ–¹æ³•ï¼Œè·å¾— HystrixThreadPoolKey æ•°é‡ã€‚</li></ul><hr><p>åœ¨ AbstractCommand <strong>æ„é€ æ–¹æ³•</strong>é‡Œï¼Œåˆå§‹åŒ–å‘½ä»¤çš„ <code>threadPoolKey</code> å±æ€§ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HystrixThreadPoolKey threadPoolKey;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractCommand</span><span class="params">(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">   <span class="keyword">this</span>.commandGroup = initGroupKey(group);</div><div class="line">   <span class="keyword">this</span>.commandKey = initCommandKey(key, getClass());</div><div class="line">   <span class="keyword">this</span>.properties = initCommandProperties(<span class="keyword">this</span>.commandKey, propertiesStrategy, commandPropertiesDefaults);</div><div class="line">   <span class="comment">// åˆå§‹åŒ– threadPoolKey</span></div><div class="line">   <span class="keyword">this</span>.threadPoolKey = initThreadPoolKey(threadPoolKey, <span class="keyword">this</span>.commandGroup, <span class="keyword">this</span>.properties.executionIsolationThreadPoolKeyOverride().get());</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#initThreadPoolKey(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæœ€ç»ˆçš„ <code>threadPoolKey</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HystrixThreadPoolKey <span class="title">initThreadPoolKey</span><span class="params">(HystrixThreadPoolKey threadPoolKey, HystrixCommandGroupKey groupKey, String threadPoolKeyOverride)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (threadPoolKeyOverride == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// we don't have a property overriding the value so use either HystrixThreadPoolKey or HystrixCommandGroup</span></div><div class="line">       <span class="keyword">if</span> (threadPoolKey == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">/* use HystrixCommandGroup if HystrixThreadPoolKey is null */</span></div><div class="line">           <span class="keyword">return</span> HystrixThreadPoolKey.Factory.asKey(groupKey.name());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">return</span> threadPoolKey;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// threadPoolKeyOverride å¯è¦†ç›–å±æ€§</span></div><div class="line">       <span class="comment">// we have a property defining the thread-pool so use it instead</span></div><div class="line">       <span class="keyword">return</span> HystrixThreadPoolKey.Factory.asKey(threadPoolKeyOverride);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä¼˜å…ˆçº§ ï¼š<code>threadPoolKeyOverride</code> &gt; <code>threadPoolKey</code> &gt; <code>groupKey</code></li></ul></li></ul><h1>4. HystrixConcurrencyStrategy</h1><p><code>com.netflix.hystrix.strategy.concurrency.HystrixConcurrencyStrategy</code> ï¼ŒHystrix å¹¶å‘ç­–ç•¥<strong>æŠ½è±¡ç±»</strong>ã€‚</p><p><code>HystrixConcurrencyStrategy#getThreadPool(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> ThreadPoolExecutor <span class="title">getThreadPool</span><span class="params">(<span class="keyword">final</span> HystrixThreadPoolKey threadPoolKey, HystrixThreadPoolProperties threadPoolProperties)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">final</span> ThreadFactory threadFactory = getThreadFactory(threadPoolKey);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> allowMaximumSizeToDivergeFromCoreSize = threadPoolProperties.getAllowMaximumSizeToDivergeFromCoreSize().get();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">final</span> <span class="keyword">int</span> dynamicCoreSize = threadPoolProperties.coreSize().get();</div><div class="line"> <span class="number">6</span>:     <span class="keyword">final</span> <span class="keyword">int</span> keepAliveTime = threadPoolProperties.keepAliveTimeMinutes().get();</div><div class="line"> <span class="number">7</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxQueueSize = threadPoolProperties.maxQueueSize().get();</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue = getBlockingQueue(maxQueueSize);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (allowMaximumSizeToDivergeFromCoreSize) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">final</span> <span class="keyword">int</span> dynamicMaximumSize = threadPoolProperties.maximumSize().get();</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (dynamicCoreSize &gt; dynamicMaximumSize) &#123;</div><div class="line"><span class="number">14</span>:             logger.error(<span class="string">"Hystrix ThreadPool configuration at startup for : "</span> + threadPoolKey.name() + <span class="string">" is trying to set coreSize = "</span> +</div><div class="line"><span class="number">15</span>:                     dynamicCoreSize + <span class="string">" and maximumSize = "</span> + dynamicMaximumSize + <span class="string">".  Maximum size will be set to "</span> +</div><div class="line"><span class="number">16</span>:                     dynamicCoreSize + <span class="string">", the coreSize value, since it must be equal to or greater than the coreSize value"</span>);</div><div class="line"><span class="number">17</span>:             <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(dynamicCoreSize, dynamicCoreSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);</div><div class="line"><span class="number">18</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(dynamicCoreSize, dynamicMaximumSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);</div><div class="line"><span class="number">20</span>:         &#125;</div><div class="line"><span class="number">21</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">22</span>:         <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(dynamicCoreSize, dynamicCoreSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>#getThreadFactory(...)</code> æ–¹æ³•ï¼Œè·å¾— ThreadFactory ã€‚ç‚¹å‡» <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixConcurrencyStrategy.java#L118" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚<ul><li><code>PlatformSpecific#getAppEngineThreadFactory()</code> æ–¹æ³•ï¼Œæ— éœ€ç»†çœ‹ï¼Œé€‚ç”¨äº Google App Engine åœºæ™¯ã€‚</li></ul></li><li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼š<a href="#">ã€Œ2. HystrixThreadPoolPropertiesã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 9 è¡Œ ï¼šè°ƒç”¨ <code>#getBlockingQueue()</code> æ–¹æ³•ï¼Œè·å¾—çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—ã€‚ç‚¹å‡» <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixConcurrencyStrategy.java#L150" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚<ul><li>å½“ <code>maxQueueSize &lt;= 0</code> æ—¶( é»˜è®¤å€¼ ï¼š<code>-1</code> ) æ—¶ï¼Œä½¿ç”¨ SynchronousQueue ã€‚è¶…è¿‡çº¿ç¨‹æ± çš„ <code>maximumPoolSize</code> æ—¶ï¼Œæäº¤ä»»åŠ¡<strong>è¢«æ‹’ç»</strong>ã€‚<ul><li><a href="http://ifeve.com/java-synchronousqueue/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå¹¶å‘åŒ…ä¸­çš„åŒæ­¥é˜Ÿåˆ—SynchronousQueueå®ç°åŸç†ã€‹</a></li></ul></li><li>å½“ <code>SynchronousQueue &gt; 0</code> æ—¶ï¼Œä½¿ç”¨ LinkedBlockingQueue ã€‚è¶…è¿‡çº¿ç¨‹æ± çš„ <code>maximumPoolSize</code> æ—¶ï¼Œä»»åŠ¡è¢«æ‹’ç»ã€‚è¶…è¿‡çº¿ç¨‹æ± çš„ <code>maximumPoolSize</code> + çº¿ç¨‹æ± é˜Ÿåˆ—çš„ <code>maxQueueSize</code> æ—¶ï¼Œæäº¤ä»»åŠ¡<strong>è¢«é˜»å¡ç­‰å¾…</strong>ã€‚<ul><li><a href="https://fangjian0423.github.io/2016/05/10/java-arrayblockingqueue-linkedblockingqueue-analysis/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaé˜»å¡é˜Ÿåˆ—ArrayBlockingQueueå’ŒLinkedBlockingQueueå®ç°åŸç†åˆ†æã€‹</a></li></ul></li><li>æ¨è ï¼š<a href="http://www.infoq.com/cn/articles/java-threadPool" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠèŠèŠå¹¶å‘ï¼ˆä¸‰ï¼‰â€”â€”JAVAçº¿ç¨‹æ± çš„åˆ†æå’Œä½¿ç”¨ã€‹</a></li><li>æ¨è ï¼š<a href="http://www.infoq.com/cn/articles/java-blocking-queue" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠèŠèŠå¹¶å‘ï¼ˆä¸ƒï¼‰â€”â€”Javaä¸­çš„é˜»å¡é˜Ÿåˆ—ã€‹</a></li></ul></li><li>ç¬¬ 11 è‡³ 23 è¡Œ ï¼šåˆ›å»º ThreadPoolExecutor ã€‚çœ‹èµ·æ¥ä»£ç æ¯”è¾ƒå¤šï¼Œæ ¹æ® <code>allowMaximumSizeToDivergeFromCoreSize</code> çš„æƒ…å†µï¼Œè®¡ç®—çº¿ç¨‹æ± çš„ <code>maximumPoolSize</code> å±æ€§ã€‚è®¡ç®—çš„æ–¹å¼å’Œ <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPoolProperties.java#L138" rel="external nofollow noopener noreferrer" target="_blank"><code>HystrixThreadPoolProperties#actualMaximumSize()</code></a> æ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚</li></ul><hr><p><code>com.netflix.hystrix.strategy.concurrency.HystrixConcurrencyStrategyDefault</code> ï¼ŒHystrix å¹¶å‘ç­–ç•¥<strong>å®ç°ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹( åŸºæœ¬æ²¡åšå•¥ ) ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixConcurrencyStrategyDefault</span> <span class="keyword">extends</span> <span class="title">HystrixConcurrencyStrategy</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HystrixConcurrencyStrategyDefault INSTANCE = <span class="keyword">new</span> HystrixConcurrencyStrategyDefault();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HystrixConcurrencyStrategy <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HystrixConcurrencyStrategyDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><hr><p>åœ¨ AbstractCommand <strong>æ„é€ æ–¹æ³•</strong>é‡Œï¼Œåˆå§‹åŒ–å‘½ä»¤çš„ <code>threadPoolKey</code> å±æ€§ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HystrixConcurrencyStrategy concurrencyStrategy;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractCommand</span><span class="params">(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   </div><div class="line">    <span class="comment">// åˆå§‹åŒ– å¹¶å‘ç­–ç•¥</span></div><div class="line">    <span class="keyword">this</span>.concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>HystrixPlugins ï¼ŒHystrix <strong>æ’ä»¶</strong>ä½“ç³»ï¼Œ<a href="https://github.com/Netflix/Hystrix/wiki/Plugins" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/Hystrix/wiki/Plugins</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>è°ƒç”¨ <code>HystrixPlugins#getConcurrencyStrategy()</code> è·å¾— HystrixConcurrencyStrategy å¯¹è±¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ HystrixConcurrencyStrategyDefault ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å‚è€ƒ Hystrix æ’ä»¶ä½“ç³»ï¼Œå®ç°<strong>è‡ªå®šä¹‰</strong>çš„ HystrixConcurrencyStrategy å®ç°ï¼Œä»¥è¾¾åˆ°<strong>è¦†å†™</strong> <code>#getThreadPool()</code>ï¼Œ<code>#getBlockingQueue()</code> ç­‰æ–¹æ³•ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/HystrixPlugins.java#L164" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚</li></ul><h1>5. HystrixThreadPool</h1><p><code>com.netflix.hystrix.HystrixThreadPool</code> ï¼ŒHystrix çº¿ç¨‹æ± <strong>æ¥å£</strong>ã€‚å½“ Hystrix å‘½ä»¤ä½¿ç”¨ <code>THREAD</code> æ‰§è¡Œéš”ç¦»ç­–ç•¥æ—¶ï¼Œ<code>HystrixCommand#run()</code> æ–¹æ³•åœ¨<strong>çº¿ç¨‹æ± æ‰§è¡Œ</strong>ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPool.java#L47" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚HystrixThreadPool å®šä¹‰æ¥å£å¦‚ä¸‹ ï¼š</p><ul><li><code>#getExecutor()</code> ï¼šè·å¾— ExecutorService ã€‚</li><li><code>#getScheduler()</code> / <code>#getScheduler(Func0&lt;Boolean&gt;)</code> ï¼šè·å¾— RxJava Scheduler ã€‚</li><li><code>#isQueueSpaceAvailable()</code> ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ˜¯å¦æœ‰<strong>ç©ºä½™</strong>ã€‚</li><li><code>#markThreadExecution()</code> / <code>#markThreadCompletion()</code> / <code>#markThreadRejection()</code> ï¼šTODO ã€2002ã€‘ã€metricsã€‘</li></ul><h2>5.1 HystrixThreadPoolDefault</h2><p><code>com.netflix.hystrix.HystrixThreadPool.HystrixThreadPoolDefault</code> ï¼ŒHystrix çº¿ç¨‹æ± <strong>å®ç°ç±»</strong>ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">final</span> HystrixThreadPoolProperties properties;</div><div class="line"> <span class="number">2</span>: <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; queue;</div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor threadPool;</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> HystrixThreadPoolMetrics metrics;</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> queueSize;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="title">HystrixThreadPoolDefault</span><span class="params">(HystrixThreadPoolKey threadPoolKey, HystrixThreadPoolProperties.Setter propertiesDefaults)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="comment">// åˆå§‹åŒ– HystrixThreadPoolProperties</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">this</span>.properties = HystrixPropertiesFactory.getThreadPoolProperties(threadPoolKey, propertiesDefaults);</div><div class="line"><span class="number">10</span>:     <span class="comment">// è·å¾— HystrixConcurrencyStrategy</span></div><div class="line"><span class="number">11</span>:     HystrixConcurrencyStrategy concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</div><div class="line"><span class="number">12</span>:     <span class="comment">// é˜Ÿåˆ—å¤§å°</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">this</span>.queueSize = properties.maxQueueSize().get();</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="comment">// TODO ã€2002ã€‘ã€metricsã€‘</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.metrics = HystrixThreadPoolMetrics.getInstance(threadPoolKey,</div><div class="line"><span class="number">17</span>:             concurrencyStrategy.getThreadPool(threadPoolKey, properties), <span class="comment">// åˆå§‹åŒ– ThreadPoolExecutor</span></div><div class="line"><span class="number">18</span>:             properties);</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="comment">// è·å¾— ThreadPoolExecutor</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">this</span>.threadPool = <span class="keyword">this</span>.metrics.getThreadPool();</div><div class="line"><span class="number">22</span>:     <span class="keyword">this</span>.queue = <span class="keyword">this</span>.threadPool.getQueue(); <span class="comment">// é˜Ÿåˆ—</span></div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     <span class="comment">// TODO ã€2002ã€‘ã€metricsã€‘</span></div><div class="line"><span class="number">25</span>:     <span class="comment">/* strategy: HystrixMetricsPublisherThreadPool */</span></div><div class="line"><span class="number">26</span>:     HystrixMetricsPublisherFactory.createOrRetrievePublisherForThreadPool(threadPoolKey, <span class="keyword">this</span>.metrics, <span class="keyword">this</span>.properties);</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 9 è¡Œ ï¼šåˆå§‹åŒ– HystrixThreadPoolProperties ã€‚</li><li>ç¬¬ 11 è¡Œ ï¼šåˆå§‹åŒ– HystrixConcurrencyStrategy ã€‚</li><li>ç¬¬ 13 è¡Œ ï¼šåˆå§‹åŒ– <code>queueSize</code> ã€‚</li><li>ç¬¬ 16 è‡³ 18 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘<ul><li>ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ <code>HystrixConcurrencyStrategy#getThreadPool(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– ThreadPoolExecutor ã€‚</li></ul></li><li>ç¬¬ 21 è¡Œ ï¼š<strong>è·å¾—</strong> ThreadPoolExecutor ã€‚</li><li>ç¬¬ 22 è¡Œ ï¼š<strong>è·å¾—</strong> ThreadPoolExecutor çš„é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 26 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘</li></ul><hr><p><code>#getExecutor()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ThreadPoolExecutor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">    touchConfig();</div><div class="line">    <span class="keyword">return</span> threadPool;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#touchConfig()</code> æ–¹æ³•ï¼Œ<strong>åŠ¨æ€</strong>è°ƒæ•´ <code>threadPool</code> çš„ <code>coreSize</code> / <code>maximumSize</code> / <code>keepAliveTime</code> å‚æ•°ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPool.java#L188" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚</li></ul><hr><p><code>#getScheduler()</code> / <code>#getScheduler(Func0&lt;Boolean&gt;)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Scheduler <span class="title">getScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//by default, interrupt underlying threads on timeout</span></div><div class="line">    <span class="keyword">return</span> getScheduler(<span class="keyword">new</span> Func0&lt;Boolean&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Scheduler <span class="title">getScheduler</span><span class="params">(Func0&lt;Boolean&gt; shouldInterruptThread)</span> </span>&#123;</div><div class="line">    touchConfig();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HystrixContextScheduler(HystrixPlugins.getInstance().getConcurrencyStrategy(), <span class="keyword">this</span>, shouldInterruptThread);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>HystrixContextScheduler å’Œ <code>shouldInterruptThread</code> éƒ½åœ¨ <a href="#">ã€Œ6. HystrixContextSchedulerã€</a> è¯¦ç»†è§£æã€‚</li></ul><hr><p><code>#isQueueSpaceAvailable()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isQueueSpaceAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (queueSize &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// we don't have a queue so we won't look for space but instead</span></div><div class="line">        <span class="comment">// let the thread-pool reject or not</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> threadPool.getQueue().size() &lt; properties.queueSizeRejectionThreshold().get();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç”±äºçº¿ç¨‹æ± çš„é˜Ÿåˆ—å¤§å°ä¸èƒ½<strong>åŠ¨æ€</strong>è°ƒæ•´ï¼Œè¯¥æ–¹æ³•çš„<strong>å®ç°</strong>é€šè¿‡ <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPoolProperties.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>HystrixThreadPoolProperties.queueSizeRejectionThreshold</code></a> å±æ€§æ§åˆ¶ã€‚</li><li>æ³¨æ„ <code>queueSize</code> å±æ€§ï¼Œå†³å®šäº†çº¿ç¨‹æ± çš„é˜Ÿåˆ—ç±»å‹ã€‚<ul><li><code>queueSize &lt;= 0</code> æ—¶ï¼Œ<code>#isQueueSpaceAvailable()</code> éƒ½è¿”å› <code>true</code> çš„åŸå› æ˜¯ï¼Œçº¿ç¨‹æ± ä½¿ç”¨ SynchronousQueue ä½œä¸ºé˜Ÿåˆ—ï¼Œä¸æ”¯æŒ<strong>æ–°</strong>ä»»åŠ¡æ’é˜Ÿï¼Œä»»åŠ¡è¶…è¿‡çº¿ç¨‹æ± çš„ <code>maximumPoolSize</code> æ—¶ï¼Œæ–°ä»»åŠ¡è¢«æ‹’ç»ã€‚</li><li><code>queueSize &gt; 0</code> æ—¶ï¼Œ<code>#isQueueSpaceAvailable()</code> æ ¹æ®æƒ…å†µ<code>true</code>/<code>false</code> çš„åŸå› æ˜¯ï¼Œçº¿ç¨‹æ± ä½¿ç”¨ LinkedBlockingQueue ä½œä¸ºé˜Ÿåˆ—ï¼Œæ”¯æŒ<strong>ä¸€å®šæ•°é‡</strong>çš„<strong>é˜»å¡</strong>æ’é˜Ÿï¼Œä½†æ˜¯è¿™ä¸ªæ•°é‡æ— æ³•è°ƒæ•´ã€‚é€šè¿‡ <code>#isQueueSpaceAvailable()</code> æ–¹æ³•çš„åˆ¤æ–­ï¼Œ<strong>åŠ¨æ€</strong>è°ƒæ•´ã€‚å¦å¤–ï¼Œåˆå§‹<strong>é…ç½®</strong>çš„ <code>queueSize</code> è¦<strong>ç›¸å¯¹å¤§</strong>ï¼Œå¦åˆ™å³ä½¿ <code>queueSizeRejectionThreshold</code> é…ç½®çš„å¤§äº <code>queueSize</code> ï¼Œå®é™…æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œä¹Ÿä¼šè¢«<strong>æ‹’ç»</strong>ã€‚</li></ul></li></ul><h2>5.2 Factory</h2><p><code>com.netflix.hystrix.HystrixThreadPool.Factory</code> ï¼ŒHystrixThreadPool å·¥å‚ç±»ï¼Œä¸ä»…é™äº HystrixThreadPool çš„åˆ›å»ºï¼Œä¹Ÿæä¾›äº† HystrixThreadPool çš„ç®¡ç†( HystrixThreadPool çš„å®¹å™¨ )ã€‚</p><p><code>threadPools</code> å±æ€§ï¼Œç»´æŠ¤åˆ›å»ºçš„ HystrixThreadPool å¯¹åº”çš„æ˜ å°„ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, HystrixThreadPool&gt; threadPools = <span class="keyword">new</span> ConcurrentHashMap&lt;String, HystrixThreadPool&gt;();</div></pre></td></tr></table></figure></p><ul><li>Key ä¸º <code>HystrixThreadPoolKey#name()</code> ï¼Œæ¯ä¸ª HystrixThreadPoolKey å¯¹åº”ä¸€ä¸ª HystrixThreadPool å¯¹è±¡ã€‚</li></ul><hr><p><code>#getInstance(...)</code> æ–¹æ³•ï¼Œè·å¾— HystrixThreadPool å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package */</span><span class="function"><span class="keyword">static</span> HystrixThreadPool <span class="title">getInstance</span><span class="params">(HystrixThreadPoolKey threadPoolKey, HystrixThreadPoolProperties.Setter propertiesBuilder)</span> </span>&#123;</div><div class="line">    <span class="comment">// get the key to use instead of using the object itself so that if people forget to implement equals/hashcode things will still work</span></div><div class="line">    String key = threadPoolKey.name();</div><div class="line"></div><div class="line">    <span class="comment">// this should find it for all but the first time</span></div><div class="line">    HystrixThreadPool previouslyCached = threadPools.get(key);</div><div class="line">    <span class="keyword">if</span> (previouslyCached != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">return</span> previouslyCached;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// if we get here this is the first time so we need to initialize</span></div><div class="line">     <span class="keyword">synchronized</span> (HystrixThreadPool.class) &#123;</div><div class="line">        <span class="keyword">if</span> (!threadPools.containsKey(key)) &#123;</div><div class="line">            threadPools.put(key, <span class="keyword">new</span> HystrixThreadPoolDefault(threadPoolKey, propertiesBuilder));</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> threadPools.get(key);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ ¹æ® <code>threadPoolKey</code> å…ˆä» <code>threadPool</code> è·å–å·²åˆ›å»ºçš„ HystrixThreadPool ï¼›è·å–ä¸åˆ°ï¼Œåˆ›å»ºå¯¹åº”çš„ HystrixThreadPool è¿”å›ï¼Œå¹¶æ·»åŠ åˆ° <code>threadPool</code> ã€‚</li></ul><hr><p><code>#shutdown()</code> / <code>#shutdown(timeout, unit)</code> æ–¹æ³•ï¼Œæ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPool.java#L128" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h2>5.3 åˆå§‹åŒ–</h2><p>åœ¨ AbstractCommand <strong>æ„é€ æ–¹æ³•</strong>é‡Œï¼Œåˆå§‹åŒ–å‘½ä»¤çš„ <code>threadPool</code> å±æ€§ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HystrixThreadPool threadPool;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractCommand</span><span class="params">(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,</span></span></div><div class="line"><span class="function"><span class="params">       HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line"></div><div class="line">    <span class="comment">// åˆå§‹åŒ– threadPoolKey</span></div><div class="line">    <span class="keyword">this</span>.threadPoolKey = initThreadPoolKey(threadPoolKey, <span class="keyword">this</span>.commandGroup, <span class="keyword">this</span>.properties.executionIsolationThreadPoolKeyOverride().get());</div><div class="line">    <span class="comment">// åˆå§‹åŒ– threadPool</span></div><div class="line">    <span class="keyword">this</span>.threadPool = initThreadPool(threadPool, <span class="keyword">this</span>.threadPoolKey, threadPoolPropertiesDefaults);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#initThreadPool(...)</code> æ–¹æ³•ï¼Œè·å¾— HystrixThreadPool ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L286" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</li></ul><h1>6. HystrixScheduler</h1><p>Hystrix å®ç°äº†<strong>è‡ªå®šä¹‰çš„</strong> RxJava Scheduler ï¼Œæ•´ä½“ç±»å›¾å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_25/01.png" alt=""></p><ul><li>HystrixContextScheduler ( å®ç° RxJava Scheduler <strong>æŠ½è±¡ç±»</strong> )ï¼Œå†…åµŒç±»å‹ä¸º ThreadPoolScheduler ( å®ç° RxJava Scheduler <strong>æŠ½è±¡ç±»</strong> )çš„ <code>actualScheduler</code> å±æ€§ã€‚</li><li>HystrixContextWorker ( å®ç° RxJava Worker <strong>æŠ½è±¡ç±»</strong> )ï¼Œå†…åµŒç±»å‹ä¸º ThreadPoolWorker ( å®ç° RxJava Worker <strong>æŠ½è±¡ç±»</strong> )çš„ <code>worker</code> å±æ€§ã€‚</li></ul><h2>6.1 HystrixContextScheduler</h2><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixContextScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixConcurrencyStrategy concurrencyStrategy;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler actualScheduler;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixThreadPool threadPool;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixContextScheduler</span><span class="params">(HystrixConcurrencyStrategy concurrencyStrategy, HystrixThreadPool threadPool, Func0&lt;Boolean&gt; shouldInterruptThread)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.concurrencyStrategy = concurrencyStrategy;</div><div class="line">        <span class="keyword">this</span>.threadPool = threadPool;</div><div class="line">        <span class="keyword">this</span>.actualScheduler = <span class="keyword">new</span> ThreadPoolScheduler(threadPool, shouldInterruptThread);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>actualScheduler</code> å±æ€§ï¼Œç±»å‹ä¸º ThreadPoolScheduler ã€‚</li></ul><hr><p><code>#createWorker()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HystrixContextSchedulerWorker(actualScheduler.createWorker());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ <code>actualScheduler</code> åˆ›å»º ThreadPoolWorker ï¼Œä¼ å‚ç»™ HystrixContextSchedulerWorker ã€‚</li></ul><h2>6.2 HystrixContextSchedulerWorker</h2><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixContextSchedulerWorker</span> <span class="keyword">extends</span> <span class="title">Worker</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Worker worker;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HystrixContextSchedulerWorker</span><span class="params">(Worker actualWorker)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.worker = actualWorker;</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>worker</code> å±æ€§ï¼Œç±»å‹ä¸º ThreadPoolWorker ã€‚</li></ul><hr><p><code>#schedule(Action0)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Subscription <span class="title">schedule</span><span class="params">(Action0 action)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (threadPool != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!threadPool.isQueueSpaceAvailable()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"Rejected command because thread-pool queueSize is at rejection threshold."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> worker.schedule(<span class="keyword">new</span> HystrixContexSchedulerAction(concurrencyStrategy, action));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>ThreadPool#isQueueSpaceAvailable()</code> æ–¹æ³•ï¼Œåˆ¤æ–­çº¿ç¨‹æ± é˜Ÿåˆ—æ˜¯å¦æœ‰<strong>ç©ºä½™</strong>ã€‚è¿™ä¸ªå°±æ˜¯ HystrixContextScheduler çš„<strong>å®é™…</strong>ç”¨é€”ã€‚</li></ul><hr><p><code>#unsubscribe()</code> / <code>#isUnsubscribed()</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>worker</code> åˆ¤æ–­ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextScheduler.java#L80" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ã€‚</p><h2>6.3 ThreadPoolScheduler</h2><p>ThreadPoolScheduler æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextScheduler.java#L111" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h2>6.4 ThreadPoolWorker</h2><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolWorker</span> <span class="keyword">extends</span> <span class="title">Worker</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HystrixThreadPool threadPool;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CompositeSubscription subscription = <span class="keyword">new</span> CompositeSubscription();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Func0&lt;Boolean&gt; shouldInterruptThread;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolWorker</span><span class="params">(HystrixThreadPool threadPool, Func0&lt;Boolean&gt; shouldInterruptThread)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.threadPool = threadPool;</div><div class="line">        <span class="keyword">this</span>.shouldInterruptThread = shouldInterruptThread;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>subscription</code> å±æ€§ï¼Œè®¢é˜…ä¿¡æ¯ã€‚</li></ul><hr><p><code>#schedule(Action0)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Subscription <span class="title">schedule</span><span class="params">(<span class="keyword">final</span> Action0 action)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// æœªè®¢é˜…ï¼Œè¿”å›</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (subscription.isUnsubscribed()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="comment">// don't schedule, we are unsubscribed</span></div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span> Subscriptions.unsubscribed();</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="comment">// åˆ›å»º ScheduledAction</span></div><div class="line"><span class="number">10</span>:     <span class="comment">// This is internal RxJava API but it is too useful.</span></div><div class="line"><span class="number">11</span>:     ScheduledAction sa = <span class="keyword">new</span> ScheduledAction(action);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:     <span class="comment">// æ·»åŠ åˆ° è®¢é˜…</span></div><div class="line"><span class="number">14</span>:     subscription.add(sa);</div><div class="line"><span class="number">15</span>:     sa.addParent(subscription);</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     <span class="comment">// æäº¤ ä»»åŠ¡</span></div><div class="line"><span class="number">18</span>:     ThreadPoolExecutor executor = (ThreadPoolExecutor) threadPool.getExecutor();</div><div class="line"><span class="number">19</span>:     FutureTask&lt;?&gt; f = (FutureTask&lt;?&gt;) executor.submit(sa);</div><div class="line"><span class="number">20</span>:     sa.add(<span class="keyword">new</span> FutureCompleterWithConfigurableInterrupt(f, shouldInterruptThread, executor));</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>:     <span class="keyword">return</span> sa;</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šæœªè®¢é˜…ï¼Œè¿”å›ã€‚</li><li>ç¬¬ 11 è¡Œ ï¼š åˆ›å»º ScheduledAction ã€‚åœ¨ <a href="">TODO ã€2013ã€‘ã€ScheduledActionã€‘</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 14 è‡³ 15 è¡Œ ï¼šæ·»åŠ åˆ°è®¢é˜…( <code>subscription</code> )ã€‚</li><li>ç¬¬ 18 è‡³ 20 è¡Œ ï¼šä½¿ç”¨ <code>threadPool</code> ï¼Œæäº¤ä»»åŠ¡ï¼Œå¹¶åˆ›å»º FutureCompleterWithConfigurableInterrupt æ·»åŠ åˆ°è®¢é˜…( <code>sa</code> )ã€‚</li><li>ç¬¬ 22 è¡Œ ï¼šè¿”å›è®¢é˜…( <code>sa</code> )ã€‚æ•´ä½“è®¢é˜…å…³ç³»å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/Hystrix/2018_10_25/02.png" alt=""></li></ul><hr><p><code>#unsubscribe()</code> / <code>#isUnsubscribed()</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>subscription</code> åˆ¤æ–­ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextScheduler.java#L149" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ã€‚</p><h2>6.5 FutureCompleterWithConfigurableInterrupt</h2><p><code>com.netflix.hystrix.strategy.concurrency.HystrixContextScheduler.FutureCompleterWithConfigurableInterrupt</code> ï¼Œå®ç°ç±»ä¼¼ <code>rx.internal.schedulers.ScheduledAction.FutureCompleter</code> ï¼Œåœ¨å®ƒçš„åŸºç¡€ä¸Šï¼Œæ”¯æŒé…ç½® <code>FutureTask#cancel(Boolean)</code> æ˜¯å¦å¯<strong>æ‰“æ–­</strong>è¿è¡Œ( <code>mayInterruptIfRunning</code> )ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureCompleterWithConfigurableInterrupt</span> <span class="keyword">implements</span> <span class="title">Subscription</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FutureTask&lt;?&gt; f;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Func0&lt;Boolean&gt; shouldInterruptThread;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor executor;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">FutureCompleterWithConfigurableInterrupt</span><span class="params">(FutureTask&lt;?&gt; f, Func0&lt;Boolean&gt; shouldInterruptThread, ThreadPoolExecutor executor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.f = f;</div><div class="line">        <span class="keyword">this</span>.shouldInterruptThread = shouldInterruptThread;</div><div class="line">        <span class="keyword">this</span>.executor = executor;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><hr><p><strong>å½“å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œæˆ–æ˜¯ä¸»åŠ¨å–æ¶ˆå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>#unsubscribe()</code> æ–¹æ³•ï¼Œå–æ¶ˆæ‰§è¡Œ</strong>ã€‚<br><strong>å½“å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œæˆ–æ˜¯ä¸»åŠ¨å–æ¶ˆå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>#unsubscribe()</code> æ–¹æ³•ï¼Œå–æ¶ˆæ‰§è¡Œ</strong>ã€‚<br><strong>å½“å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œæˆ–æ˜¯ä¸»åŠ¨å–æ¶ˆå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>#unsubscribe()</code> æ–¹æ³•ï¼Œå–æ¶ˆæ‰§è¡Œ</strong>ã€‚</p><p><code>#unsubscribe()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ä» çº¿ç¨‹æ±  ç§»é™¤ ä»»åŠ¡</span></div><div class="line">    executor.remove(f);</div><div class="line">    <span class="comment">// æ ¹æ® shouldInterruptThread é…ç½®ï¼Œæ˜¯å¦å¼ºåˆ¶å–æ¶ˆ</span></div><div class="line">    <span class="keyword">if</span> (shouldInterruptThread.call()) &#123;</div><div class="line">        f.cancel(<span class="keyword">true</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        f.cancel(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ ¹æ® <code>shouldInterruptThread</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦<strong>å¼ºåˆ¶</strong>å–æ¶ˆã€‚</li><li><code>shouldInterruptThread</code> å¯¹åº”çš„æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ ï¼š</li></ul><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">subscribeOn(threadPool.getScheduler(<span class="keyword">new</span> Func0&lt;Boolean&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> properties.executionIsolationThreadInterruptOnTimeout().get() &amp;&amp; _cmd.isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT;</div><div class="line">    &#125;</div><div class="line">&#125;));</div></pre></td></tr></table></figure></p><ul><li>å½“ <code>executionIsolationThreadInterruptOnTimeout = true</code> æ—¶ï¼Œå‘½ä»¤å¯æ‰§è¡Œ<strong>è¶…æ—¶</strong>ã€‚å½“å‘½ä»¤å¯æ‰§è¡Œ<strong>è¶…æ—¶</strong>æ—¶ï¼Œ<strong>å¼ºåˆ¶</strong>å–æ¶ˆã€‚</li><li>å½“ä½¿ç”¨ <code>HystrixCommand.queue()</code> è¿”å›çš„ Future ï¼Œå¯ä»¥ä½¿ç”¨ <code>Future#cancel(Boolean)</code> å–æ¶ˆå‘½ä»¤æ‰§è¡Œã€‚ä» <code>shouldInterruptThread</code> å¯¹åº”çš„æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ­¤æ—¶ä¸æ»¡è¶³å‘½ä»¤æ‰§è¡Œ<strong>è¶…æ—¶</strong>çš„æ¡ä»¶ï¼Œå‘½ä»¤æ‰§è¡Œå–æ¶ˆçš„æ–¹å¼æ˜¯<strong>éå¼ºåˆ¶</strong>çš„ã€‚æ­¤æ—¶å½“ <code>executionIsolationThreadInterruptOnFutureCancel = true</code> æ—¶ï¼Œå¹¶ä¸”è°ƒç”¨ <code>Future#cancel(Boolean)</code> ä¼ é€’ <code>mayInterruptIfRunning = true</code> ï¼Œå¼ºåˆ¶å–æ¶ˆå‘½ä»¤æ‰§è¡Œã€‚<ul><li>æ¨¡æ‹Ÿæµ‹è¯•ç”¨ä¾‹ ï¼š<a href="https://github.com/YunaiV/Hystrix/blob/HEAD/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>CommandHelloWorld#testAsynchronous3()</code></a></li><li><code>HystrixCommand#queue()</code> ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/ba86690747b365482c306ec3a0725e0be4bab739/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java#L378" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>Future#cancel(Boolean)</code> æ–¹æ³•ã€‚</li></ul></li></ul><h1>666. å½©è›‹</h1><p>ä¸€è¾¹å†™ä¸€è¾¹æƒ³æ˜ç™½äº† RxJava çš„ä¸€äº›ä¸œè¥¿ï¼ŒæŒºèˆ’æœçš„èµ¶è„šã€‚</p><p>ç»§ç»­ Go On ~ å‘¨æœ«å—¨ä¸åœã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘</title>
    <link href="http://www.iocoder.cn/Hystrix/command-execute-first-run/"/>
    <id>http://www.iocoder.cn/Hystrix/command-execute-first-run/</id>
    <published>2018-10-21T16:00:00.000Z</published>
    <updated>2017-11-08T10:02:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-first-run/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">2. #applyHystrixSemantics(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">3. TryableSemaphore</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">4. #executeCommandAndObserve(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">5. #executeCommandWithSpecifiedIsolation(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">6. #getUserExecutionObservable(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">7. #getExecutionObservable()</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">8. CommandState</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">9. ThreadState</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘</strong>ã€‚</p><p>å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚</p><p>Hystrix æ‰§è¡Œå‘½ä»¤æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><blockquote><p>FROM <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E6%B5%81%E7%A8%8B%E5%9B%BE" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œæµç¨‹å›¾ã€</a><br><img src="http://www.iocoder.cn/images/Hystrix/2018_10_22/01.jpeg" alt=""></p></blockquote><ul><li><strong>çº¢</strong>æ¡† ï¼šHystrix å‘½ä»¤æ‰§è¡Œçš„è¿‡ç¨‹ã€‚</li><li><strong>è“</strong>åœˆ ï¼šæœ¬æ–‡åˆ†äº«çš„éƒ¨åˆ† â€”â€” æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. #applyHystrixSemantics(...)</h1><p>åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜ã€‹</a> é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ° <code>#toObservable()</code> æ–¹æ³•é‡Œçš„<strong>ç¬¬ 11 è‡³ 19 è¡Œ</strong>ï¼Œå½“ç¼“å­˜ç‰¹æ€§<strong>æœªå¼€å¯</strong>ï¼Œæˆ–è€…ç¼“å­˜<strong>æœªå‘½ä¸­</strong>æ—¶ï¼Œä½¿ç”¨ <code>applyHystrixSemantics</code> ä¼ å…¥ <code>Observable#defer(...)</code> æ–¹æ³•ï¼Œå£°æ˜<strong>æ‰§è¡Œå‘½ä»¤</strong>çš„ Observableã€‚</p><p>åˆ›å»º <code>applyHystrixSemantics</code> å˜é‡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// `AbstractCommand#toObservable()` æ–¹æ³•</span></div><div class="line">  <span class="number">1</span>: <span class="keyword">final</span> Func0&lt;Observable&lt;R&gt;&gt; applyHystrixSemantics = <span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line">  <span class="number">2</span>:     <span class="meta">@Override</span></div><div class="line">  <span class="number">3</span>:     <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">4</span>:         <span class="comment">// commandState å¤„äº UNSUBSCRIBED æ—¶ï¼Œä¸æ‰§è¡Œå‘½ä»¤</span></div><div class="line">  <span class="number">5</span>:         <span class="keyword">if</span> (commandState.get().equals(CommandState.UNSUBSCRIBED)) &#123;</div><div class="line">  <span class="number">6</span>:             <span class="keyword">return</span> Observable.never();</div><div class="line">  <span class="number">7</span>:         &#125;</div><div class="line">  <span class="number">8</span>:         <span class="comment">// è·å¾— æ‰§è¡ŒObservable</span></div><div class="line">  <span class="number">9</span>:         <span class="keyword">return</span> applyHystrixSemantics(_cmd);</div><div class="line"> <span class="number">10</span>:     &#125;</div><div class="line"> <span class="number">11</span>: &#125;;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è‡³ 7 è¡Œ ï¼šå½“ <code>commandState</code> å¤„äº <code>UNSUBSCRIBED</code> æ—¶ï¼Œä¸æ‰§è¡Œå‘½ä»¤ã€‚</li><li>ç¬¬ 9 è¡Œ ï¼šè°ƒç”¨ <code>#applyHystrixSemantics(...)</code> æ–¹æ³•ï¼Œè·å¾—æ‰§è¡Œ Observable ã€‚</li></ul><hr><p><code>#applyHystrixSemantics(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">applyHystrixSemantics</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"> <span class="number">3</span>:     <span class="comment">// mark that we're starting execution on the ExecutionHook</span></div><div class="line"> <span class="number">4</span>:     <span class="comment">// if this hook throws an exception, then a fast-fail occurs with no fallback.  No state is left inconsistent</span></div><div class="line"> <span class="number">5</span>:     executionHook.onStart(_cmd);</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">/* determine if we're allowed to execute */</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (circuitBreaker.attemptExecution()) &#123;</div><div class="line"> <span class="number">9</span>:         <span class="comment">// è·å¾— ä¿¡å·é‡</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">final</span> TryableSemaphore executionSemaphore = getExecutionSemaphore();</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:         <span class="comment">// ä¿¡å·é‡é‡Šæ”¾Action</span></div><div class="line"><span class="number">13</span>:         <span class="keyword">final</span> AtomicBoolean semaphoreHasBeenReleased = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="number">14</span>:         <span class="keyword">final</span> Action0 singleSemaphoreRelease = <span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">15</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">16</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">17</span>:                 <span class="keyword">if</span> (semaphoreHasBeenReleased.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"><span class="number">18</span>:                     executionSemaphore.release();</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:         &#125;;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:         <span class="comment">// TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</span></div><div class="line"><span class="number">24</span>:         <span class="keyword">final</span> Action1&lt;Throwable&gt; markExceptionThrown = <span class="keyword">new</span> Action1&lt;Throwable&gt;() &#123;</div><div class="line"><span class="number">25</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">26</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line"><span class="number">27</span>:                 eventNotifier.markEvent(HystrixEventType.EXCEPTION_THROWN, commandKey);</div><div class="line"><span class="number">28</span>:             &#125;</div><div class="line"><span class="number">29</span>:         &#125;;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:         <span class="comment">// ä¿¡å·é‡ è·å¾—</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (executionSemaphore.tryAcquire()) &#123;</div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">34</span>:                 <span class="comment">// æ ‡è®° executionResult è°ƒç”¨å¼€å§‹æ—¶é—´</span></div><div class="line"><span class="number">35</span>:                 <span class="comment">/* used to track userThreadExecutionTime */</span></div><div class="line"><span class="number">36</span>:                 executionResult = executionResult.setInvocationStartTime(System.currentTimeMillis());</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:                 <span class="comment">// è·å¾— æ‰§è¡ŒObservable</span></div><div class="line"><span class="number">39</span>:                 <span class="keyword">return</span> executeCommandAndObserve(_cmd)</div><div class="line"><span class="number">40</span>:                         .doOnError(markExceptionThrown)</div><div class="line"><span class="number">41</span>:                         .doOnTerminate(singleSemaphoreRelease)</div><div class="line"><span class="number">42</span>:                         .doOnUnsubscribe(singleSemaphoreRelease);</div><div class="line"><span class="number">43</span>:             &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">44</span>:                 <span class="keyword">return</span> Observable.error(e);</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">47</span>:             <span class="keyword">return</span> handleSemaphoreRejectionViaFallback();</div><div class="line"><span class="number">48</span>:         &#125;</div><div class="line"><span class="number">49</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">50</span>:         <span class="keyword">return</span> handleShortCircuitViaFallback();</div><div class="line"><span class="number">51</span>:     &#125;</div><div class="line"><span class="number">52</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è¡Œ ï¼šTODO ã€2003ã€‘ã€HOOKã€‘</li><li>ç¬¬ 8 è¡Œ ï¼šTODO ã€2012ã€‘ã€é“¾è·¯å¥åº·åº¦ã€‘</li><li>ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ <code>#getExecutionSemaphore()</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¿¡å·é‡</strong>( TryableSemaphore )å¯¹è±¡ï¼Œåœ¨ <a href="#">ã€Œ3. TryableSemaphoreã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 13 è‡³ 21 è¡Œ ï¼šä¿¡å·é‡é‡Šæ”¾ Action ï¼Œç”¨äºä¸‹é¢ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘çš„ <code>#doOnTerminate(Action)</code> å’Œ <code>#doOnUnsubscribe(Action)</code> æ–¹æ³•( è§ç¬¬ 41 è‡³ 42 è¡Œ )ã€‚</li><li>ç¬¬ 24 è‡³ 29 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘</li><li>ç¬¬ 32 è¡Œ ï¼šè°ƒç”¨ <code>TryableSemaphore#tryAcquire()</code> æ–¹æ³•ï¼Œ<strong>ä¿¡å·é‡</strong>( TryableSemaphore )ä½¿ç”¨æˆåŠŸï¼Œåœ¨ <a href="#">ã€Œ3. TryableSemaphoreã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 36 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> çš„<strong>è°ƒç”¨</strong>å¼€å§‹æ—¶é—´ã€‚</li><li>ç¬¬ 39 è¡Œ ï¼šè°ƒç”¨ <code>#executeCommandAndObserve()</code> æ–¹æ³•ï¼Œè·å¾—ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚åœ¨ <a href="#">ã€Œ4. #executeCommandAndObserve(...)ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 43 è‡³ 45 è¡Œ ï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <code>Observable#error(Exception)</code> æ–¹æ³•è¿”å› Observable ã€‚</li><li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼š<strong>ä¿¡å·é‡</strong>( TryableSemaphore )ä½¿ç”¨å¤±è´¥ï¼Œè°ƒç”¨ <code>#handleSemaphoreRejectionViaFallback()</code> æ–¹æ³•ï¼Œå¤„ç†ä¿¡å·é‡æ‹’ç»çš„å¤±è´¥å›é€€é€»è¾‘ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 49 è‡³ 51 è¡Œ ï¼šé“¾è·¯å¤„äº<strong>ç†”æ–­</strong>çŠ¶æ€ï¼Œè°ƒç”¨ <code>#handleShortCircuitViaFallback()</code> æ–¹æ³•ï¼Œå¤„ç†é“¾è·¯ç†”æ–­çš„å¤±è´¥å›é€€é€»è¾‘ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul><h1>3. TryableSemaphore</h1><p><code>com.netflix.hystrix.AbstractCommand.TryableSemaphore</code> ï¼ŒHystrix å®šä¹‰çš„ä¿¡å·é‡<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TryableSemaphore</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getNumberOfPermitsUsed</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä» API ä¸Šï¼ŒJava è‡ªå¸¦çš„ <code>java.util.concurrent.Semaphore</code> éƒ½èƒ½æ»¡è¶³ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨å®ƒå‘¢ï¼Ÿç»§ç»­ä¸€èµ·å¾€ä¸‹çœ‹ã€‚</li></ul><p>TryableSemaphore å…±æœ‰ä¸¤ä¸ªå­ç±»å®ç° ï¼š</p><ul><li>TryableSemaphoreNoOp</li><li>TryableSemaphoreActual</li></ul><h2>3.1 TryableSemaphoreNoOp</h2><p><code>com.netflix.hystrix.AbstractCommand.TryableSemaphoreNoOp</code> ï¼Œ<strong>æ— æ“ä½œ</strong>çš„ä¿¡å·é‡ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package */</span><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TryableSemaphoreNoOp</span> <span class="keyword">implements</span> <span class="title">TryableSemaphore</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> TryableSemaphore DEFAULT = <span class="keyword">new</span> TryableSemaphoreNoOp();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumberOfPermitsUsed</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä»å®ç°ä¸Šçœ‹ï¼Œ<code>#tryAcquire()</code> æ–¹æ³•ï¼Œæ¯æ¬¡éƒ½è¿”å›çš„æ˜¯ <code>true</code> ï¼›<code>#release()</code> æ–¹æ³•ï¼Œæ— ä»»ä½•æ“ä½œã€‚è¿™ä¸ªæ˜¯<strong>ä¸ºä»€ä¹ˆ</strong>ï¼Ÿåœ¨ Hystrix é‡Œæä¾›äº†ä¸¤ç§<strong>æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>  ï¼š<ul><li><code>Thread</code> ï¼Œè¯¥æ–¹å¼ä¸ä½¿ç”¨ä¿¡å·é‡ï¼Œå› æ­¤ä½¿ç”¨ TryableSemaphoreNoOp ï¼Œè¿™æ ·æ¯æ¬¡è°ƒç”¨ <code>#tryAcquire()</code> éƒ½èƒ½è¿”å› <code>true</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹</a> è¯¦ç»†è§£æè¯¥æ–¹å¼ã€‚</li><li><code>Semaphore</code> ï¼Œè¯¥æ–¹å¼ä½¿ç”¨ä¿¡å·é‡ï¼Œå› æ­¤ä½¿ç”¨ TryableSemaphoreActual ï¼Œè¿™æ ·æ¯æ¬¡è°ƒç”¨ <code>#tryAcquire()</code> æ ¹æ®æƒ…å†µè¿”å› <code>true / false</code> ã€‚åœ¨ <a href="#">ã€Œ3.2 TryableSemaphoreActualã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>3.2 TryableSemaphoreActual</h2><p><code>com.netflix.hystrix.AbstractCommand.TryableSemaphoreActual</code> ï¼Œ<strong>çœŸæ­£çš„</strong>çš„ä¿¡å·é‡å®ç°ã€‚ä¸è¿‡å®é™…ä¸Šï¼ŒTryableSemaphoreActual æ›´åŠ åƒä¸€ä¸ª<strong>è®¡æ•°å™¨</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/* package */</span><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TryableSemaphoreActual</span> <span class="keyword">implements</span> <span class="title">TryableSemaphore</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> HystrixProperty&lt;Integer&gt; numberOfPermits;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TryableSemaphoreActual</span><span class="params">(HystrixProperty&lt;Integer&gt; numberOfPermits)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.numberOfPermits = numberOfPermits;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> currentCount = count.incrementAndGet();</div><div class="line">        <span class="keyword">if</span> (currentCount &gt; numberOfPermits.get()) &#123;</div><div class="line">            count.decrementAndGet();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">        count.decrementAndGet();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumberOfPermitsUsed</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> count.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>numberOfPermits</code> å±æ€§ï¼Œä¿¡å·é‡<strong>ä¸Šé™</strong>ã€‚<code>com.netflix.hystrix.strategy.properties.HystrixProperty</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå½“å…¶ä½¿ç”¨ç±»ä¼¼ <code>com.netflix.hystrix.strategy.properties.archaius.IntegerDynamicProperty</code> <strong>åŠ¨æ€</strong>å±æ€§çš„å®ç°æ—¶ï¼Œå¯ä»¥å®ç°åŠ¨æ€è°ƒæ•´ä¿¡å·é‡çš„<strong>ä¸Šé™</strong>ï¼Œè¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ <code>java.util.concurrent.Semaphore</code> çš„åŸå› ä¹‹ä¸€ã€‚</li><li><code>count</code> å±æ€§ï¼Œä¿¡å·é‡ä½¿ç”¨æ•°é‡ã€‚ğŸ™‚ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆè¯´ TryableSemaphoreActual æ›´åŠ åƒä¸€ä¸ª<strong>è®¡æ•°å™¨</strong> çš„åŸå› ã€‚</li><li>å¦ä¸€ä¸ªä¸ä½¿ç”¨ <code>java.util.concurrent.Semaphore</code> çš„åŸå› ï¼ŒTryableSemaphoreActual æ— <strong>é˜»å¡</strong>è·å–ä¿¡å·é‡çš„éœ€æ±‚ï¼Œä½¿ç”¨ AtomicInteger å¯ä»¥è¾¾åˆ°æ›´è½»é‡çº§çš„å®ç°ã€‚</li></ul><h2>3.3 #getExecutionSemaphore()</h2><p>è°ƒç”¨ <code>#getExecutionSemaphore()</code> æ–¹æ³•ï¼Œè·å¾—ä¿¡å·é‡å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰§è¡Œå‘½ä»¤ï¼ˆæ­£å¸¸æ‰§è¡Œï¼‰ä¿¡å·é‡æ˜ å°„</span></div><div class="line"><span class="comment">* KEY ï¼šå‘½ä»¤å &#123;<span class="doctag">@link</span> #commandKey&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="comment">/* each circuit has a semaphore to restrict concurrent fallback execution */</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, TryableSemaphore&gt; executionSemaphorePerCircuit = <span class="keyword">new</span> ConcurrentHashMap&lt;String, TryableSemaphore&gt;();</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">protected</span> TryableSemaphore <span class="title">getExecutionSemaphore</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (properties.executionIsolationStrategy().get() == ExecutionIsolationStrategy.SEMAPHORE) &#123;</div><div class="line">        <span class="keyword">if</span> (executionSemaphoreOverride == <span class="keyword">null</span>) &#123;</div><div class="line">            TryableSemaphore _s = executionSemaphorePerCircuit.get(commandKey.name());</div><div class="line">            <span class="keyword">if</span> (_s == <span class="keyword">null</span>) &#123; <span class="comment">// ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»º TryableSemaphoreActual</span></div><div class="line">                <span class="comment">// we didn't find one cache so setup</span></div><div class="line">               executionSemaphorePerCircuit.putIfAbsent(commandKey.name(), <span class="keyword">new</span> TryableSemaphoreActual(properties.executionIsolationSemaphoreMaxConcurrentRequests()));</div><div class="line">                <span class="comment">// assign whatever got set (this or another thread)</span></div><div class="line">                <span class="keyword">return</span> executionSemaphorePerCircuit.get(commandKey.name());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> _s;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> executionSemaphoreOverride;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// return NoOp implementation since we're not using SEMAPHORE isolation</span></div><div class="line">        <span class="keyword">return</span> TryableSemaphoreNoOp.DEFAULT;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ ¹æ®<strong>æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>ä¸åŒè·å–ä¸åŒçš„ä¿¡å·é‡å®ç° ï¼š<ul><li><code>Thread</code> ï¼Œè¯¥æ–¹å¼ä¸ä½¿ç”¨ä¿¡å·é‡ï¼Œå› æ­¤ä½¿ç”¨ TryableSemaphoreNoOp ã€‚</li><li><code>Semaphore</code> ï¼Œè¯¥æ–¹å¼ä½¿ç”¨ä¿¡å·é‡ï¼Œå› æ­¤ä½¿ç”¨ TryableSemaphoreActual ã€‚<ul><li>ç›¸åŒçš„ <code>commandKey</code> ï¼Œä½¿ç”¨ç›¸åŒçš„ TryableSemaphoreActual ã€‚</li></ul></li></ul></li></ul><h1>4. #executeCommandAndObserve(...)</h1><p>è°ƒç”¨ <code>#executeCommandAndObserve(...)</code> æ–¹æ³•ï¼Œè·å¾—ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">executeCommandAndObserve</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// TODO ã€ã€‘</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> HystrixRequestContext currentRequestContext = HystrixRequestContext.getContextForCurrentThread();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">// TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">final</span> Action1&lt;R&gt; markEmits = <span class="keyword">new</span> Action1&lt;R&gt;() &#123;</div><div class="line"> <span class="number">7</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">8</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(R r)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (shouldOutputOnNextEvents()) &#123;</div><div class="line"><span class="number">10</span>:                 executionResult = executionResult.addEvent(HystrixEventType.EMIT);</div><div class="line"><span class="number">11</span>:                 eventNotifier.markEvent(HystrixEventType.EMIT, commandKey);</div><div class="line"><span class="number">12</span>:             &#125;</div><div class="line"><span class="number">13</span>:             <span class="keyword">if</span> (commandIsScalar()) &#123;</div><div class="line"><span class="number">14</span>:                 <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</div><div class="line"><span class="number">15</span>:                 eventNotifier.markEvent(HystrixEventType.SUCCESS, commandKey);</div><div class="line"><span class="number">16</span>:                 executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.SUCCESS);</div><div class="line"><span class="number">17</span>:                 eventNotifier.markCommandExecution(getCommandKey(), properties.executionIsolationStrategy().get(), (<span class="keyword">int</span>) latency, executionResult.getOrderedList());</div><div class="line"><span class="number">18</span>:                 circuitBreaker.markSuccess();</div><div class="line"><span class="number">19</span>:             &#125;</div><div class="line"><span class="number">20</span>:         &#125;</div><div class="line"><span class="number">21</span>:     &#125;;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:     <span class="comment">// TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</span></div><div class="line"><span class="number">24</span>:     <span class="keyword">final</span> Action0 markOnCompleted = <span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">25</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">26</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">27</span>:             <span class="keyword">if</span> (!commandIsScalar()) &#123;</div><div class="line"><span class="number">28</span>:                 <span class="keyword">long</span> latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</div><div class="line"><span class="number">29</span>:                 eventNotifier.markEvent(HystrixEventType.SUCCESS, commandKey);</div><div class="line"><span class="number">30</span>:                 executionResult = executionResult.addEvent((<span class="keyword">int</span>) latency, HystrixEventType.SUCCESS);</div><div class="line"><span class="number">31</span>:                 eventNotifier.markCommandExecution(getCommandKey(), properties.executionIsolationStrategy().get(), (<span class="keyword">int</span>) latency, executionResult.getOrderedList());</div><div class="line"><span class="number">32</span>:                 circuitBreaker.markSuccess();</div><div class="line"><span class="number">33</span>:             &#125;</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:     &#125;;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:     <span class="comment">// å¤±è´¥å›é€€é€»è¾‘ Func1</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">final</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt; handleFallback = <span class="keyword">new</span> Func1&lt;Throwable, Observable&lt;R&gt;&gt;() &#123;</div><div class="line"><span class="number">39</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">40</span>:         <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line"><span class="number">41</span>:             circuitBreaker.markNonSuccess();</div><div class="line"><span class="number">42</span>:             Exception e = getExceptionFromThrowable(t);</div><div class="line"><span class="number">43</span>:             executionResult = executionResult.setExecutionException(e);</div><div class="line"><span class="number">44</span>:             <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RejectedExecutionException) &#123;</div><div class="line"><span class="number">45</span>:                 <span class="keyword">return</span> handleThreadPoolRejectionViaFallback(e);</div><div class="line"><span class="number">46</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HystrixTimeoutException) &#123;</div><div class="line"><span class="number">47</span>:                 <span class="keyword">return</span> handleTimeoutViaFallback();</div><div class="line"><span class="number">48</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> HystrixBadRequestException) &#123;</div><div class="line"><span class="number">49</span>:                 <span class="keyword">return</span> handleBadRequestByEmittingError(e);</div><div class="line"><span class="number">50</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">51</span>:                 <span class="comment">/*</span></div><div class="line"><span class="comment">52:                  * Treat HystrixBadRequestException from ExecutionHook like a plain HystrixBadRequestException.</span></div><div class="line"><span class="comment">53:                  */</span></div><div class="line"><span class="number">54</span>:                 <span class="keyword">if</span> (e <span class="keyword">instanceof</span> HystrixBadRequestException) &#123;</div><div class="line"><span class="number">55</span>:                     eventNotifier.markEvent(HystrixEventType.BAD_REQUEST, commandKey);</div><div class="line"><span class="number">56</span>:                     <span class="keyword">return</span> Observable.error(e);</div><div class="line"><span class="number">57</span>:                 &#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:                 <span class="keyword">return</span> handleFailureViaFallback(e);</div><div class="line"><span class="number">60</span>:             &#125;</div><div class="line"><span class="number">61</span>:         &#125;</div><div class="line"><span class="number">62</span>:     &#125;;</div><div class="line"><span class="number">63</span>: </div><div class="line"><span class="number">64</span>:     <span class="comment">// TODO ã€2008ã€‘ã€è¯·æ±‚ç¼“å­˜ã€‘</span></div><div class="line"><span class="number">65</span>:     <span class="keyword">final</span> Action1&lt;Notification&lt;? <span class="keyword">super</span> R&gt;&gt; setRequestContext = <span class="keyword">new</span> Action1&lt;Notification&lt;? <span class="keyword">super</span> R&gt;&gt;() &#123;</div><div class="line"><span class="number">66</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">67</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Notification&lt;? <span class="keyword">super</span> R&gt; rNotification)</span> </span>&#123;</div><div class="line"><span class="number">68</span>:             setRequestContextIfNeeded(currentRequestContext);</div><div class="line"><span class="number">69</span>:         &#125;</div><div class="line"><span class="number">70</span>:     &#125;;</div><div class="line"><span class="number">71</span>: </div><div class="line"><span class="number">72</span>:     Observable&lt;R&gt; execution;</div><div class="line"><span class="number">73</span>:     <span class="keyword">if</span> (properties.executionTimeoutEnabled().get()) &#123;</div><div class="line"><span class="number">74</span>:         execution = executeCommandWithSpecifiedIsolation(_cmd)</div><div class="line"><span class="number">75</span>:                 .lift(<span class="keyword">new</span> HystrixObservableTimeoutOperator&lt;R&gt;(_cmd)); <span class="comment">// è¶…æ—¶</span></div><div class="line"><span class="number">76</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">77</span>:         execution = executeCommandWithSpecifiedIsolation(_cmd);</div><div class="line"><span class="number">78</span>:     &#125;</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:     <span class="keyword">return</span> execution.doOnNext(markEmits)</div><div class="line"><span class="number">81</span>:             .doOnCompleted(markOnCompleted)</div><div class="line"><span class="number">82</span>:             .onErrorResumeNext(handleFallback)</div><div class="line"><span class="number">83</span>:             .doOnEach(setRequestContext);</div><div class="line"><span class="number">84</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è¡Œ ï¼šTODO ã€2012ã€‘ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘</li><li>ç¬¬ 6 è‡³ 21 è¡Œ ï¼šTODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</li><li>ç¬¬ 24 è‡³ 35 è¡Œ ï¼šTODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</li><li>ç¬¬ 38 è‡³ 62 è¡Œ ï¼šå¤±è´¥å›é€€é€»è¾‘ Func1 ï¼Œåœ¨ <a href="http://www.iocoder.cn/categories/Hystrix/?self">ã€ŠHystrix æºç è§£æ â€”â€” è¯·æ±‚æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 65 è‡³ 70 è¡Œ ï¼šTODO ã€2012ã€‘ã€è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘</li><li>ç¬¬ 72 è‡³ 78 è¡Œ ï¼šè°ƒç”¨ <code>#executeCommandWithSpecifiedIsolation(...)</code> æ–¹æ³•ï¼Œè·å¾—ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ï¼Œåœ¨ <a href="#">ã€Œ5. #executeCommandWithSpecifiedIsolation(...)ã€</a> è¯¦ç»†è§£æã€‚<ul><li>è‹¥æ‰§è¡Œå‘½ä»¤è¶…æ—¶ç‰¹æ€§<strong>å¼€å¯</strong>ï¼Œè°ƒç”¨ <code>Observable#lift(HystrixObservableTimeoutOperator)</code> æ–¹æ³•ï¼Œå®ç°æ‰§è¡Œå‘½ä»¤è¶…æ—¶åŠŸèƒ½ã€‚åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-third-timeout/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸‰ï¼‰ä¹‹æ‰§è¡Œè¶…æ—¶ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 80 è‡³ 83 è¡Œ ï¼šè¿”å›ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚</li></ul><h1>5. #executeCommandWithSpecifiedIsolation(...)</h1><p>è°ƒç”¨ <code>#executeCommandWithSpecifiedIsolation(...)</code> æ–¹æ³•ï¼Œè·å¾—ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">executeCommandWithSpecifiedIsolation</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">if</span> (properties.executionIsolationStrategy().get() == ExecutionIsolationStrategy.THREAD) &#123;</div><div class="line">  <span class="number">3</span>:         <span class="comment">// mark that we are executing in a thread (even if we end up being rejected we still were a THREAD execution and not SEMAPHORE)</span></div><div class="line">  <span class="number">4</span>:         <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line">  <span class="number">5</span>:             <span class="meta">@Override</span></div><div class="line">  <span class="number">6</span>:             <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:                 <span class="comment">// æ ‡è®° executionResult æ‰§è¡Œå·²å‘ç”Ÿ</span></div><div class="line">  <span class="number">9</span>:                 executionResult = executionResult.setExecutionOccurred();</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:                 <span class="comment">// è®¾ç½® commandState ä¸º USER_CODE_EXECUTED</span></div><div class="line"> <span class="number">12</span>:                 <span class="keyword">if</span> (!commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.USER_CODE_EXECUTED)) &#123;</div><div class="line"> <span class="number">13</span>:                     <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"execution attempted while in state : "</span> + commandState.get().name()));</div><div class="line"> <span class="number">14</span>:                 &#125;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:                 <span class="comment">// TODO ã€2002ã€‘ã€metricsã€‘</span></div><div class="line"> <span class="number">17</span>:                 metrics.markCommandStart(commandKey, threadPoolKey, ExecutionIsolationStrategy.THREAD);</div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:                 <span class="comment">// TODO ã€2009ã€‘ã€æ‰§è¡Œè¶…æ—¶ã€‘</span></div><div class="line"> <span class="number">20</span>:                 <span class="keyword">if</span> (isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT) &#123;</div><div class="line"> <span class="number">21</span>:                     <span class="comment">// the command timed out in the wrapping thread so we will return immediately</span></div><div class="line"> <span class="number">22</span>:                     <span class="comment">// and not increment any of the counters below or other such logic</span></div><div class="line"> <span class="number">23</span>:                     <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> RuntimeException(<span class="string">"timed out before executing run()"</span>));</div><div class="line"> <span class="number">24</span>:                 &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:                 <span class="comment">// è®¾ç½® çº¿ç¨‹çŠ¶æ€ ä¸º ThreadState.STARTED</span></div><div class="line"> <span class="number">27</span>:                 <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.STARTED)) &#123;</div><div class="line"> <span class="number">28</span>:                     <span class="comment">// TODO ã€2002ã€‘ã€metricsã€‘</span></div><div class="line"> <span class="number">29</span>:                     <span class="comment">//we have not been unsubscribed, so should proceed</span></div><div class="line"> <span class="number">30</span>:                     HystrixCounters.incrementGlobalConcurrentThreads();</div><div class="line"> <span class="number">31</span>:                     threadPool.markThreadExecution();</div><div class="line"> <span class="number">32</span>: </div><div class="line"> <span class="number">33</span>:                     <span class="comment">// TODO ã€2010ã€‘ã€endCurrentThreadExecutingCommandã€‘</span></div><div class="line"> <span class="number">34</span>:                     <span class="comment">// store the command that is being run</span></div><div class="line"> <span class="number">35</span>:                     endCurrentThreadExecutingCommand = Hystrix.startCurrentThreadExecutingCommand(getCommandKey());</div><div class="line"> <span class="number">36</span>: </div><div class="line"> <span class="number">37</span>:                     <span class="comment">// æ ‡è®° executionResult ä½¿ç”¨çº¿ç¨‹æ‰§è¡Œ</span></div><div class="line"> <span class="number">38</span>:                     executionResult = executionResult.setExecutedInThread();</div><div class="line"> <span class="number">39</span>:                     <span class="comment">/**</span></div><div class="line"><span class="comment"> 40:                      * If any of these hooks throw an exception, then it appears as if the actual execution threw an error</span></div><div class="line"><span class="comment"> 41:                      */</span></div><div class="line"> <span class="number">42</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">43</span>:                         <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"> <span class="number">44</span>:                         executionHook.onThreadStart(_cmd);</div><div class="line"> <span class="number">45</span>:                         executionHook.onRunStart(_cmd);</div><div class="line"> <span class="number">46</span>:                         executionHook.onExecutionStart(_cmd);</div><div class="line"> <span class="number">47</span>: </div><div class="line"> <span class="number">48</span>:                         <span class="comment">// è·å¾— æ‰§è¡ŒObservable</span></div><div class="line"> <span class="number">49</span>:                         <span class="keyword">return</span> getUserExecutionObservable(_cmd);</div><div class="line"> <span class="number">50</span>:                     &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line"> <span class="number">51</span>:                         <span class="keyword">return</span> Observable.error(ex);</div><div class="line"> <span class="number">52</span>:                     &#125;</div><div class="line"> <span class="number">53</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">54</span>:                     <span class="comment">//command has already been unsubscribed, so return immediately</span></div><div class="line"> <span class="number">55</span>:                     <span class="keyword">return</span> Observable.empty();</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>:             &#125;</div><div class="line"> <span class="number">58</span>:         &#125;).doOnTerminate(<span class="keyword">new</span> Action0() &#123;</div><div class="line"> <span class="number">59</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">60</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">61</span>:                 <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.STARTED, ThreadState.TERMINAL)) &#123;</div><div class="line"> <span class="number">62</span>:                     handleThreadEnd(_cmd);</div><div class="line"> <span class="number">63</span>:                 &#125;</div><div class="line"> <span class="number">64</span>:                 <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.TERMINAL)) &#123;</div><div class="line"> <span class="number">65</span>:                     <span class="comment">//if it was never started and received terminal, then no need to clean up (I don't think this is possible)</span></div><div class="line"> <span class="number">66</span>:                 &#125;</div><div class="line"> <span class="number">67</span>:                 <span class="comment">//if it was unsubscribed, then other cleanup handled it</span></div><div class="line"> <span class="number">68</span>:             &#125;</div><div class="line"> <span class="number">69</span>:         &#125;).doOnUnsubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line"> <span class="number">70</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">71</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">72</span>:                 <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.STARTED, ThreadState.UNSUBSCRIBED)) &#123;</div><div class="line"> <span class="number">73</span>:                     handleThreadEnd(_cmd);</div><div class="line"> <span class="number">74</span>:                 &#125;</div><div class="line"> <span class="number">75</span>:                 <span class="keyword">if</span> (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.UNSUBSCRIBED)) &#123;</div><div class="line"> <span class="number">76</span>:                     <span class="comment">//if it was never started and was cancelled, then no need to clean up</span></div><div class="line"> <span class="number">77</span>:                 &#125;</div><div class="line"> <span class="number">78</span>:                 <span class="comment">//if it was terminal, then other cleanup handled it</span></div><div class="line"> <span class="number">79</span>:             &#125;</div><div class="line"> <span class="number">80</span>:         &#125;).subscribeOn(threadPool.getScheduler(<span class="keyword">new</span> Func0&lt;Boolean&gt;() &#123; <span class="comment">// TODO èŠ‹è‰¿ï¼šScheduler</span></div><div class="line"> <span class="number">81</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">82</span>:             <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">83</span>:                 <span class="keyword">return</span> properties.executionIsolationThreadInterruptOnTimeout().get() &amp;&amp; _cmd.isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT;</div><div class="line"> <span class="number">84</span>:             &#125;</div><div class="line"> <span class="number">85</span>:         &#125;));</div><div class="line"> <span class="number">86</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">87</span>:         <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line"> <span class="number">88</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">89</span>:             <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">90</span>:                 <span class="comment">// æ ‡è®° executionResult æ‰§è¡Œå·²å‘ç”Ÿ</span></div><div class="line"> <span class="number">91</span>:                 executionResult = executionResult.setExecutionOccurred();</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:                 <span class="comment">// è®¾ç½® commandState ä¸º USER_CODE_EXECUTED</span></div><div class="line"> <span class="number">94</span>:                 <span class="keyword">if</span> (!commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.USER_CODE_EXECUTED)) &#123;</div><div class="line"> <span class="number">95</span>:                     <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"execution attempted while in state : "</span> + commandState.get().name()));</div><div class="line"> <span class="number">96</span>:                 &#125;</div><div class="line"> <span class="number">97</span>: </div><div class="line"> <span class="number">98</span>:                 <span class="comment">// TODO ã€2002ã€‘ã€metricsã€‘</span></div><div class="line"> <span class="number">99</span>:                 metrics.markCommandStart(commandKey, threadPoolKey, ExecutionIsolationStrategy.SEMAPHORE);</div><div class="line"><span class="number">100</span>: </div><div class="line"><span class="number">101</span>:                 <span class="comment">// TODO ã€2010ã€‘ã€endCurrentThreadExecutingCommandã€‘</span></div><div class="line"><span class="number">102</span>:                 <span class="comment">// semaphore isolated</span></div><div class="line"><span class="number">103</span>:                 <span class="comment">// store the command that is being run</span></div><div class="line"><span class="number">104</span>:                 endCurrentThreadExecutingCommand = Hystrix.startCurrentThreadExecutingCommand(getCommandKey());</div><div class="line"><span class="number">105</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">106</span>:                     <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"><span class="number">107</span>:                     executionHook.onRunStart(_cmd);</div><div class="line"><span class="number">108</span>:                     executionHook.onExecutionStart(_cmd);</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                     <span class="comment">// è·å¾— æ‰§è¡ŒObservable</span></div><div class="line"><span class="number">111</span>:                     <span class="keyword">return</span> getUserExecutionObservable(_cmd);  <span class="comment">//the getUserExecutionObservable method already wraps sync exceptions, so this shouldn't throw</span></div><div class="line"><span class="number">112</span>:                 &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line"><span class="number">113</span>:                     <span class="comment">//If the above hooks throw, then use that as the result of the run method</span></div><div class="line"><span class="number">114</span>:                     <span class="keyword">return</span> Observable.error(ex);</div><div class="line"><span class="number">115</span>:                 &#125;</div><div class="line"><span class="number">116</span>:             &#125;</div><div class="line"><span class="number">117</span>:         &#125;);</div><div class="line"><span class="number">118</span>:     &#125;</div><div class="line"><span class="number">119</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>æ ¹æ®<strong>æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>ä¸åŒï¼Œåˆ›å»º<strong>ä¸åŒ</strong>çš„ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚ä»”ç»†å¯¹æ¯”ä¸‹ï¼Œå¤§ä½“é€»è¾‘éƒ½æ˜¯ç›¸åŒçš„ï¼Œå·®åˆ«åœ¨äº<strong>æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>ä¸º <code>Thread</code> æ—¶ï¼Œä½¿ç”¨ RxJava Scheduler ä»¥åŠå¯¹<strong>çº¿ç¨‹</strong>çš„å¤„ç†ã€‚</p></li><li><p>ç¬¬ 2 è‡³ 85 è¡Œ ï¼š<strong>æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>ä¸º <code>Thread</code> ï¼š</p><ul><li>ç¬¬ 9 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> æ‰§è¡Œå·²å‘ç”Ÿã€‚</li><li>ç¬¬ 12 è‡³ 14 è¡Œ ï¼šè®¾ç½® <code>commandState</code> ä¸º <code>USER_CODE_EXECUTED</code> ã€‚è‹¥è®¾ç½®å¤±è´¥ï¼Œè°ƒç”¨ <code>Observable#error(Exception)</code> æ–¹æ³•è¿”å› Observable ã€‚</li><li>ç¬¬ 17 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘</li><li>ç¬¬ 20 è‡³ 24 è¡Œ ï¼šTODO ã€2009ã€‘ã€æ‰§è¡Œè¶…æ—¶ã€‘</li><li>ç¬¬ 27 è¡Œ ï¼šè®¾ç½® <code>threadState</code> ä¸º <code>ThreadState.STARTED</code> æˆåŠŸã€‚<ul><li>ç¬¬ 30 è‡³ 31 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘</li><li>ç¬¬ 35 è¡Œ ï¼šTODO ã€2010ã€‘ã€endCurrentThreadExecutingCommandã€‘</li><li>ç¬¬ 38 è¡Œ ï¼šæ ‡è®° <code>executionResult</code> ä½¿ç”¨<strong>çº¿ç¨‹</strong>æ‰§è¡Œã€‚</li><li>ç¬¬ 44 è‡³ 46 è¡Œ ï¼šTODO ã€2003ã€‘ã€HOOKã€‘</li><li>ç¬¬ 49 è¡Œ ï¼šè°ƒç”¨ <code>#getUserExecutionObservable(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ›å»º</strong>ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚</li><li>ç¬¬ 50 è‡³ 52 è¡Œ ï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <code>Observable#error(Exception)</code> æ–¹æ³•è¿”å› Observable ã€‚</li></ul></li><li>ç¬¬ 53 è‡³ 56 è¡Œ ï¼šè®¾ç½® <code>threadState</code> ä¸º <code>ThreadState.STARTED</code> å¤±è´¥ï¼Œæ‰§è¡Œå‘½ä»¤æ­¤æ—¶å·²ç»è¢«<strong>å–æ¶ˆ</strong>ï¼Œè°ƒç”¨ <code>Observable#empty()</code> æ–¹æ³•è¿”å› Observable ã€‚</li><li>ç¬¬ 58 è‡³ 68 è¡Œ ï¼šè°ƒç”¨ <code>Observable#doOnTerminate(...)</code> æ–¹æ³•ï¼Œæ·»åŠ  Action0 ã€‚<code>#handleThreadEnd(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1103" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</li><li>ç¬¬ 69 è‡³ 79 è¡Œ ï¼šè°ƒç”¨ <code>Observable#doOnUnsubscribe(...)</code> æ–¹æ³•ï¼Œæ·»åŠ  Action0 ã€‚</li><li>ç¬¬ 80 è‡³ 85 è¡Œ ï¼šè°ƒç”¨ <code>Observable#subscribeOn(Scheduler)</code> æ–¹æ³•ï¼ŒæŒ‡å®š Observable <strong>è‡ªèº«</strong>åœ¨å“ªä¸ªè°ƒåº¦å™¨ä¸Šæ‰§è¡Œã€‚<ul><li>RxJava Scheduler ï¼Œåœ¨ <a href="http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/?self">ã€ŠRxJava æºç è§£æ â€”â€” Schedulerã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>Observable#subscribeOn(Scheduler)</code> ï¼Œåœ¨ <a href="http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/?self">ã€ŠRxJava æºç è§£æ â€”â€” Observable#subscribeOn(Scheduler)ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>è°ƒç”¨ <code>ThreadPool#getScheduler(Func0&lt;Boolean&gt;)</code> æ–¹æ³•ï¼Œè·å¾— Hystrix è‡ªå®šä¹‰å®ç°çš„ RxJava Scheduler ï¼Œåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul></li><li><p>ç¬¬ 86 è‡³ 118 è¡Œ ï¼š<strong>æ‰§è¡Œéš”ç¦»ç­–ç•¥</strong>ä¸º <code>SEMAPHORE</code> ï¼š</p><ul><li>ç¬¬ 91 è¡Œ ï¼š[ ä¸ç¬¬ 9 è¡Œ<strong>ç›¸åŒ</strong> ]ã€‚</li><li>ç¬¬ 94 è‡³ 96 è¡Œ ï¼š[ ä¸ç¬¬ 12 è‡³ 14è¡Œ<strong>ç›¸åŒ</strong> ]ã€‚</li><li>ç¬¬ 99 è¡Œ ï¼š[ ä¸ç¬¬ 17 è¡Œ<strong>ç±»ä¼¼</strong> ]ã€‚</li><li>ç¬¬ 104 è¡Œ ï¼š[ ä¸ç¬¬ 35 è¡Œ<strong>ç›¸åŒ</strong> ]ã€‚</li><li>ç¬¬ 107 è‡³ 108 è¡Œ ï¼š[ ä¸ç¬¬ 45 è‡³ 46 è¡Œ<strong>ç›¸åŒ</strong> ]ã€‚</li><li>ç¬¬ 111 è¡Œ ï¼š[ ä¸ç¬¬ 49 è¡Œ<strong>ç›¸åŒ</strong> ]ã€‚</li><li>ç¬¬ 112 è‡³ 115 è¡Œ ï¼š[ ä¸ç¬¬ 50 è‡³ 52 è¡Œ<strong>ç›¸åŒ</strong> ]ã€‚</li></ul></li></ul><h1>6. #getUserExecutionObservable(...)</h1><p>è°ƒç”¨ <code>#getUserExecutionObservable(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Observable&lt;R&gt; <span class="title">getUserExecutionObservable</span><span class="params">(<span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     Observable&lt;R&gt; userObservable;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:         userObservable = getExecutionObservable();</div><div class="line"> <span class="number">6</span>:     &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// the run() method is a user provided implementation so can throw instead of using Observable.onError</span></div><div class="line"> <span class="number">8</span>:         <span class="comment">// so we catch it here and turn it into Observable.error</span></div><div class="line"> <span class="number">9</span>:         userObservable = Observable.error(ex);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="keyword">return</span> userObservable</div><div class="line"><span class="number">13</span>:             .lift(<span class="keyword">new</span> ExecutionHookApplication(_cmd)) <span class="comment">// TODO ã€2003ã€‘ã€HOOKã€‘</span></div><div class="line"><span class="number">14</span>:             .lift(<span class="keyword">new</span> DeprecatedOnRunHookApplication(_cmd)); <span class="comment">// å·²åºŸå¼ƒ</span></div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>#getExecutionObservable()</code> æ–¹æ³•ï¼Œåˆ›å»ºã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚<code>#getExecutionObservable()</code> æ˜¯ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Observable&lt;R&gt; <span class="title">getExecutionObservable</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p><ul><li>HystrixCommand å®ç°äº†è¯¥æ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ7. #getExecutionObservableã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><p>ç¬¬ 6 è‡³ 10 è¡Œ ï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <code>Observable#error(Exception)</code> æ–¹æ³•è¿”å› Observable ã€‚</p></li><li><p>ç¬¬ 12 è‡³ 14 è¡Œ ï¼šè¿”å›ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚</p><ul><li>ç¬¬ 13 è¡Œ ï¼šTODO ã€2003ã€‘ã€HOOKã€‘</li></ul></li></ul><h1>7. #getExecutionObservable()</h1><p>è°ƒç”¨ <code>HystrixCommand#getExecutionObservable()</code> æ–¹æ³•ï¼Œåˆ›å»ºã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">final</span> <span class="keyword">protected</span> Observable&lt;R&gt; <span class="title">getExecutionObservable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line"> <span class="number">4</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:         <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:                 <span class="keyword">return</span> Observable.just(run());</div><div class="line"> <span class="number">8</span>:             &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line"> <span class="number">9</span>:                 <span class="keyword">return</span> Observable.error(ex);</div><div class="line"><span class="number">10</span>:             &#125;</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;).doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">13</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">14</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">15</span>:             <span class="comment">// è®°å½• æ‰§è¡Œçº¿ç¨‹</span></div><div class="line"><span class="number">16</span>:             <span class="comment">// Save thread on which we get subscribed so that we can interrupt it later if needed</span></div><div class="line"><span class="number">17</span>:             executionThread.set(Thread.currentThread());</div><div class="line"><span class="number">18</span>:         &#125;</div><div class="line"><span class="number">19</span>:     &#125;);</div><div class="line"><span class="number">20</span>: &#125;</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> R <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è‡³ 11 è¡Œ ï¼šè°ƒç”¨ <code>Observable#defer(Func0&lt;Observable&lt;R&gt;)</code> æ–¹æ³•ï¼Œåˆ›å»ºã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚<ul><li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>#run()</code> æ–¹æ³•ï¼Œ<strong>è¿è¡Œæ­£å¸¸æ‰§é€»è¾‘</strong>ã€‚é€šè¿‡ <code>Observable#just(...)</code> æ–¹æ³•ï¼Œè¿”å›åˆ›å»ºã€æ‰§è¡Œå‘½ä»¤ Observableã€‘ã€‚</li></ul></li><li>ç¬¬ 12 è‡³ 19 è¡Œ ï¼šè°ƒç”¨ <code>#doOnSubscribe(...)</code> æ–¹æ³•ï¼Œæ·»åŠ  Action ã€‚è¯¥æ“ä½œè®°å½•æ‰§è¡Œçº¿ç¨‹( <code>executionThread</code> ) ã€‚<code>executionThread</code> ç”¨äº <code>HystrixCommand#queue()</code> æ–¹æ³•ï¼Œè¿”å›çš„ Future ç»“æœï¼Œå¯ä»¥è°ƒç”¨ <code>Future#cancel(Boolean)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java#L380" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚</li><li>ç¬¬ 22 è¡Œ ï¼š<code>#run()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®ç°è¯¥æ–¹æ³•ï¼Œ<strong>è¿è¡Œæ­£å¸¸æ‰§é€»è¾‘</strong>ã€‚</li></ul><h1>8. CommandState</h1><p><code>com.netflix.hystrix.AbstractCommand.CommandState</code> ï¼Œå‘½ä»¤çŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">enum</span> CommandState &#123;</div><div class="line">    NOT_STARTED, OBSERVABLE_CHAIN_CREATED, USER_CODE_EXECUTED, UNSUBSCRIBED, TERMINAL</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>çŠ¶æ€å˜è¿å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_22/02.png" alt=""></p><h1>9. ThreadState</h1><p><code>com.netflix.hystrix.AbstractCommand.ThreadState</code> ï¼Œçº¿ç¨‹çŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">enum</span> ThreadState &#123;</div><div class="line">   NOT_USING_THREAD, STARTED, UNSUBSCRIBED, TERMINAL</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>çŠ¶æ€å˜è¿å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_22/03.png" alt=""></p><h1>666. å½©è›‹</h1><p>å¯¹ Hystrix å’Œ RxJava æ…¢æ…¢æ›´æœ‰æ„Ÿè§‰äº†ã€‚</p><p>æŸ³æš—èŠ±æ˜åˆä¸€æ‘ã€‚</p><p>ç»§ç»­åŠ æ²¹ï¼</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-first-run/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜</title>
    <link href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/"/>
    <id>http://www.iocoder.cn/Hystrix/command-execute-result-cache/</id>
    <published>2018-10-14T16:00:00.000Z</published>
    <updated>2017-11-08T09:51:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-result-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">2. å¥½å¤„</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">3. Observable#defer(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">4. AbstractCommand#toObservavle(...)</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">5. HystrixCachedObservable</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">6. HystrixCommandResponseFromCache</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-result-cache/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix æ‰§è¡Œå‘½ä»¤çš„ç»“æœç¼“å­˜</strong>ã€‚</p><p>å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚</p><p>Hystrix æ‰§è¡Œå‘½ä»¤æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><blockquote><p>FROM <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E6%B5%81%E7%A8%8B%E5%9B%BE" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œæµç¨‹å›¾ã€</a><br><img src="http://www.iocoder.cn/images/Hystrix/2018_10_15/01.jpeg" alt=""></p></blockquote><ul><li>çº¢åœˆ ï¼šåœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-mode/?self">ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œå‘½ä»¤æ–¹å¼ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç´«åœˆ ï¼šåœ¨ <code>#toObservable()</code> æ–¹æ³•é‡Œï¼Œå¦‚æœè¯·æ±‚ç»“æœç¼“å­˜è¿™ä¸ªç‰¹æ€§è¢«<strong>å¯ç”¨</strong>ï¼Œå¹¶ä¸”<strong>ç¼“å­˜å‘½ä¸­</strong>ï¼Œåˆ™ç¼“å­˜çš„å›åº”ä¼šç«‹å³é€šè¿‡ä¸€ä¸ª Observable å¯¹è±¡çš„å½¢å¼è¿”å›ï¼›å¦‚æœ<strong>ç¼“å­˜æœªå‘½ä¸­</strong>ï¼Œåˆ™è¿”å›ã€<strong>è®¢é˜…äº†æ‰§è¡Œå‘½ä»¤çš„ Observable</strong>ã€‘çš„ ReplySubject å¯¹è±¡ç¼“å­˜æ‰§è¡Œç»“æœã€‚<ul><li>ReplySubject èƒ½å¤Ÿ<strong>é‡æ”¾</strong>æ‰§è¡Œç»“æœï¼Œä»è€Œå®ç°ç¼“å­˜çš„åŠŸæ•ˆã€‚æœ¬æ–‡ä¸å¯¹ ReplySubject åšå¤ªå¤šæ‹“å±•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” Subjectã€‹</a> ã€‚</li></ul></li></ul><p>åœ¨å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingRequestCache.java" rel="external nofollow noopener noreferrer" target="_blank">CommandUsingRequestCache</a> è¿›è¡Œè°ƒè¯• ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. å¥½å¤„</h1><p>ç‚¹å‡» <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œè¯·æ±‚ç¼“å­˜ã€</a> ï¼ŒæŸ¥çœ‹å¯¹<strong>è¯·æ±‚ç¼“å­˜</strong>çš„å¥½å¤„åˆ†äº«ï¼Œå†™çš„çœŸçš„å¾ˆèµã€‚</p><h1>3. Observable#defer(...)</h1><p>æœ¬å°èŠ‚ä¸º<strong>æ‹“å±•å†…å®¹</strong>ï¼Œæºç è§£æ RxJava ( é Hystrix ) çš„ <code>Observable#defer(...)</code> çš„æ–¹æ³•å®ç°ã€‚è€ƒè™‘åˆ° Hystrix å¤§é‡ä½¿ç”¨ï¼Œä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œè§£æä¸‹æºç ã€‚</p><p><a href="http://www.iocoder.cn/RxJava/observable-defer/">ã€ŠRxJava æºç è§£æ â€”â€” Observable#defer(...)ã€‹</a></p><h1>4. AbstractCommand#toObservavle(...)</h1><p><code>AbstractCommand#toObservavle(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">final</span> AbstractCommand&lt;R&gt; _cmd = <span class="keyword">this</span>;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="comment">//doOnCompleted handler already did all of the SUCCESS work</span></div><div class="line"> <span class="number">5</span>:     <span class="comment">//doOnError handler already did all of the FAILURE/TIMEOUT/REJECTION/BAD_REQUEST work</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">final</span> Action0 terminateCommandCleanup = <span class="keyword">new</span> Action0() &#123;&#125; <span class="comment">// ... çœç•¥</span></div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">//mark the command as CANCELLED and store the latency (in addition to standard cleanup)</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> Action0 unsubscribeCommandCleanup = <span class="keyword">new</span> Action0() &#123;&#125; <span class="comment">// ... çœç•¥</span></div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> Func0&lt;Observable&lt;R&gt;&gt; applyHystrixSemantics = <span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line"><span class="number">12</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">13</span>:         <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (commandState.get().equals(CommandState.UNSUBSCRIBED)) &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">return</span> Observable.never();</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>:             <span class="keyword">return</span> applyHystrixSemantics(_cmd);</div><div class="line"><span class="number">18</span>:         &#125;</div><div class="line"><span class="number">19</span>:     &#125;;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:     <span class="keyword">final</span> Func1&lt;R, R&gt; wrapWithAllOnNextHooks = <span class="keyword">new</span> Func1&lt;R, R&gt;() &#123;&#125; <span class="comment">// ... çœç•¥ </span></div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> Action0 fireOnCompletedHook = <span class="keyword">new</span> Action0() &#123;&#125; <span class="comment">// ... çœç•¥ </span></div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:     <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line"><span class="number">26</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">27</span>:         <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">28</span>:             <span class="comment">/* this is a stateful object so can only be used once */</span></div><div class="line"><span class="number">29</span>:             <span class="keyword">if</span> (!commandState.compareAndSet(CommandState.NOT_STARTED, CommandState.OBSERVABLE_CHAIN_CREATED)) &#123;</div><div class="line"><span class="number">30</span>:                 IllegalStateException ex = <span class="keyword">new</span> IllegalStateException(<span class="string">"This instance can only be executed once. Please instantiate a new instance."</span>);</div><div class="line"><span class="number">31</span>:                 <span class="comment">//TODO make a new error type for this</span></div><div class="line"><span class="number">32</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> HystrixRuntimeException(FailureType.BAD_REQUEST_EXCEPTION, _cmd.getClass(), getLogMessagePrefix() + <span class="string">" command executed multiple times - this is not permitted."</span>, ex, <span class="keyword">null</span>);</div><div class="line"><span class="number">33</span>:             &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:             <span class="comment">// å‘½ä»¤å¼€å§‹æ—¶é—´æˆ³</span></div><div class="line"><span class="number">36</span>:             commandStartTimestamp = System.currentTimeMillis();</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:             <span class="comment">// TODOã€2001ã€‘ã€æ‰“å°æ—¥å¿—ã€‘</span></div><div class="line"><span class="number">39</span>:             <span class="keyword">if</span> (properties.requestLogEnabled().get()) &#123;</div><div class="line"><span class="number">40</span>:                 <span class="comment">// log this command execution regardless of what happened</span></div><div class="line"><span class="number">41</span>:                 <span class="keyword">if</span> (currentRequestLog != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">42</span>:                     currentRequestLog.addExecutedCommand(_cmd);</div><div class="line"><span class="number">43</span>:                 &#125;</div><div class="line"><span class="number">44</span>:             &#125;</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:             <span class="comment">// ç¼“å­˜å¼€å…³ã€ç¼“å­˜KEY</span></div><div class="line"><span class="number">47</span>:             <span class="keyword">final</span> <span class="keyword">boolean</span> requestCacheEnabled = isRequestCachingEnabled();</div><div class="line"><span class="number">48</span>:             <span class="keyword">final</span> String cacheKey = getCacheKey();</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:             <span class="comment">// ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–</span></div><div class="line"><span class="number">51</span>:             <span class="comment">/* try from cache first */</span></div><div class="line"><span class="number">52</span>:             <span class="keyword">if</span> (requestCacheEnabled) &#123;</div><div class="line"><span class="number">53</span>:                 HystrixCommandResponseFromCache&lt;R&gt; fromCache = (HystrixCommandResponseFromCache&lt;R&gt;) requestCache.get(cacheKey);</div><div class="line"><span class="number">54</span>:                 <span class="keyword">if</span> (fromCache != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">55</span>:                     isResponseFromCache = <span class="keyword">true</span>; <span class="comment">// æ ‡è®° ä»ç¼“å­˜ä¸­ç»“æœ</span></div><div class="line"><span class="number">56</span>:                     <span class="keyword">return</span> handleRequestCacheHitAndEmitValues(fromCache, _cmd);</div><div class="line"><span class="number">57</span>:                 &#125;</div><div class="line"><span class="number">58</span>:             &#125;</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:             <span class="comment">// è·å¾— æ‰§è¡Œå‘½ä»¤Observable</span></div><div class="line"><span class="number">61</span>:             Observable&lt;R&gt; hystrixObservable =</div><div class="line"><span class="number">62</span>:                     Observable.defer(applyHystrixSemantics)</div><div class="line"><span class="number">63</span>:                             .map(wrapWithAllOnNextHooks);</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:             <span class="comment">// è·å¾— ç¼“å­˜Observable</span></div><div class="line"><span class="number">66</span>:             Observable&lt;R&gt; afterCache;</div><div class="line"><span class="number">67</span>:             <span class="comment">// put in cache</span></div><div class="line"><span class="number">68</span>:             <span class="keyword">if</span> (requestCacheEnabled &amp;&amp; cacheKey != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">69</span>:                 <span class="comment">// wrap it for caching</span></div><div class="line"><span class="number">70</span>:                 HystrixCachedObservable&lt;R&gt; toCache = HystrixCachedObservable.from(hystrixObservable, _cmd);</div><div class="line"><span class="number">71</span>:                 <span class="comment">// å¹¶å‘è‹¥ä¸å­˜åœ¨</span></div><div class="line"><span class="number">72</span>:                 HystrixCommandResponseFromCache&lt;R&gt; fromCache = (HystrixCommandResponseFromCache&lt;R&gt;) requestCache.putIfAbsent(cacheKey, toCache);</div><div class="line"><span class="number">73</span>:                 <span class="keyword">if</span> (fromCache != <span class="keyword">null</span>) &#123; <span class="comment">// æ·»åŠ å¤±è´¥</span></div><div class="line"><span class="number">74</span>:                     <span class="comment">// another thread beat us so we'll use the cached value instead</span></div><div class="line"><span class="number">75</span>:                     toCache.unsubscribe();</div><div class="line"><span class="number">76</span>:                     isResponseFromCache = <span class="keyword">true</span>; <span class="comment">// æ ‡è®° ä»ç¼“å­˜ä¸­ç»“æœ</span></div><div class="line"><span class="number">77</span>:                     <span class="keyword">return</span> handleRequestCacheHitAndEmitValues(fromCache, _cmd);</div><div class="line"><span class="number">78</span>:                 &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ·»åŠ æˆåŠŸ</span></div><div class="line"><span class="number">79</span>:                     <span class="comment">// we just created an ObservableCommand so we cast and return it</span></div><div class="line"><span class="number">80</span>:                     afterCache = toCache.toObservable();</div><div class="line"><span class="number">81</span>:                 &#125;</div><div class="line"><span class="number">82</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">83</span>:                 afterCache = hystrixObservable;</div><div class="line"><span class="number">84</span>:             &#125;</div><div class="line"><span class="number">85</span>: </div><div class="line"><span class="number">86</span>:             <span class="comment">//</span></div><div class="line"><span class="number">87</span>:             <span class="keyword">return</span> afterCache</div><div class="line"><span class="number">88</span>:                     .doOnTerminate(terminateCommandCleanup)     <span class="comment">// perform cleanup once (either on normal terminal state (this line), or unsubscribe (next line))</span></div><div class="line"><span class="number">89</span>:                     .doOnUnsubscribe(unsubscribeCommandCleanup) <span class="comment">// perform cleanup once</span></div><div class="line"><span class="number">90</span>:                     .doOnCompleted(fireOnCompletedHook);</div><div class="line"><span class="number">91</span>:         &#125;</div><div class="line"><span class="number">92</span>:     &#125;);</div><div class="line"><span class="number">93</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ ï¼š<code>_cmd</code> æŒ‡å‘å½“å‰å‘½ä»¤å¯¹è±¡ï¼Œç”¨äºä¸‹é¢å®ç° FuncX ï¼ŒActionX å†…éƒ¨ç±»ä½¿ç”¨ã€‚</p></li><li><p>ç¬¬ 11 è‡³ 19 è¡Œ ï¼šå½“ç¼“å­˜ç‰¹æ€§<strong>æœªå¼€å¯</strong>ï¼Œæˆ–è€…ç¼“å­˜<strong>æœªå‘½ä¸­</strong>æ—¶ï¼Œä½¿ç”¨ <code>applyHystrixSemantics</code> ä¼ å…¥ <code>Observable#defer(...)</code> æ–¹æ³•ï¼Œå£°æ˜<strong>æ‰§è¡Œå‘½ä»¤</strong>çš„ Observableã€‚</p></li><li><p>ç¬¬ 25 è¡Œ ï¼šå£°æ˜ç¼“å­˜ Observable ã€‚Hystrix æ‰§è¡Œå‘½ä»¤çš„ Observable å£°æ˜å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_15/02.png" alt=""></p></li><li><p>ç¬¬ 29 è‡³ 33 è¡Œ ï¼š<strong>ä¸€æ¡å‘½ä»¤åªèƒ½æ‰§è¡Œä¸€æ¬¡</strong>ã€‚</p></li><li><p>ç¬¬ 36 è¡Œ ï¼šè®°å½•å‘½ä»¤<strong>å¼€å§‹</strong>æ—¶é—´æˆ³ã€‚</p></li><li><p>ç¬¬ 38 è‡³ 44 è¡Œ ï¼šTODOã€2001ã€‘ã€æ‰“å°æ—¥å¿—ã€‘</p></li><li><p>ç¬¬ 47 è‡³ 48 è¡Œ ï¼šç¼“å­˜å­˜å¼€å…³ã€KEY ã€‚</p></li><li><p>ç¬¬ 52 è‡³ 58 è¡Œ ï¼šå¦‚æœè¯·æ±‚ç»“æœç¼“å­˜è¿™ä¸ªç‰¹æ€§è¢«<strong>å¯ç”¨</strong>ï¼Œå¹¶ä¸”<strong>ç¼“å­˜å‘½ä¸­</strong>ï¼Œåˆ™ç¼“å­˜çš„å›åº”ä¼šç«‹å³é€šè¿‡ä¸€ä¸ª Observable å¯¹è±¡çš„å½¢å¼è¿”å›ã€‚</p><ul><li>ç¬¬ 53 è¡Œ ï¼š<code>requestCache</code> ç¼“å­˜ï¼Œåœ¨ <a href="#">TODO ã€2008ã€‘ã€è¯·æ±‚ç¼“å­˜ã€‘</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 53 è¡Œ ï¼š<a href="#">ã€Œ6. HystrixCommandResponseFromCacheã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 56 è¡Œ ï¼š<code>#handleRequestCacheHitAndEmitValues(...)</code> æ–¹æ³•ï¼Œåœ¨<strong>ç¬¬ 78 è¡Œ</strong>è¯¦ç»†è§£æã€‚</li></ul></li><li><p>ç¬¬ 61 è‡³ 63 è¡Œ ï¼šè·å–<strong>æ‰§è¡Œå‘½ä»¤</strong>çš„ Observable ã€‚åœ¨ <a href="http://www.iocoder.cn/Hystrix/command-execute-first-run/?self">ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 68 è‡³ 81 è¡Œ ï¼šå½“ç¼“å­˜ç‰¹æ€§<strong>å¼€å¯</strong>ï¼Œå¹¶ä¸”ç¼“å­˜<strong>æœªå‘½ä¸­</strong>æ—¶ï¼Œåˆ›å»ºã€<strong>è®¢é˜…äº†æ‰§è¡Œå‘½ä»¤çš„ Observable</strong>ã€‘çš„ HystrixCommandResponseFromCache ã€‚</p><ul><li>ç¬¬ 69 è‡³ 72 è¡Œ ï¼šåˆ›å»º HystrixCommandResponseFromCache ï¼Œå¹¶æ·»åŠ åˆ° <code>requestCache</code> ã€‚å“Ÿï¼Œ<code>HystrixRequestCache#putIfAbsent(...)</code> æ–¹æ³•ï¼Œ<strong>å¤šä¸ªçº¿ç¨‹</strong>æ·»åŠ æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ·»åŠ æˆåŠŸã€‚</li><li>ç¬¬ 73 è‡³ 77 è¡Œ ï¼šæ·»åŠ <strong>å¤±è´¥</strong>çš„çº¿ç¨‹( <strong>ä»¬</strong> )ï¼š<ul><li>ç¬¬ 75 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCommandResponseFromCache#unsubscribe()</code> æ–¹æ³•ï¼Œå–æ¶ˆ HystrixCommandResponseFromCache çš„è®¢é˜…ã€‚è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œå› ä¸ºæˆ‘ä»¬<strong>ä¸å¸Œæœ›ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹å»æ‰§è¡Œå‘½ä»¤ï¼Œæœ€å¥½æœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå‘½ä»¤</strong>ã€‚åœ¨ <a href="#">ã€Œ5. HystrixCachedObservableã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 77 è¡Œ ï¼š<a href="#">ã€Œ6. HystrixCommandResponseFromCacheã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 80 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCommandResponseFromCachetoObservable()</code> æ–¹æ³•ï¼Œè·å¾—ç¼“å­˜ Observable ã€‚</li></ul></li><li><p>ç¬¬ 82 è‡³ 84 è¡Œ ï¼šå½“ç¼“å­˜ç‰¹æ€§<strong>æœªå¼€å¯</strong>ï¼Œä½¿ç”¨æ‰§è¡Œå‘½ä»¤ Observable ã€‚</p></li><li><p>ç¬¬ 87 è‡³ 91 è¡Œ ï¼šåœ¨è¿”å›çš„ Observable ä¸Šï¼Œè®¢é˜…ä¸€äº›æ¸…ç†çš„å¤„ç†é€»è¾‘ã€‚å¯¹è¿™å‡ ä¸ªæ–¹æ³•æœ‰ç–‘æƒ‘çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯» <a href="http://gank.io/post/560e15be2dca930e00da1083#toc_10" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£ã€‹ã€Œ 3) Subscribe (è®¢é˜…) ã€</a> ã€‚</p></li></ul><h1>5. HystrixCachedObservable</h1><p><code>com.netflix.hystrix.HystrixCachedObservable</code> ï¼Œç¼“å­˜ Observable ã€‚</p><p>HystrixCachedObservable <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCachedObservable</span>&lt;<span class="title">R</span>&gt; </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 3:  * è®¢é˜…</span></div><div class="line"><span class="comment"> 4:  */</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">protected</span> <span class="keyword">final</span> Subscription originalSubscription;</div><div class="line"> <span class="number">6</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 7:  * ç¼“å­˜ cachedObservable</span></div><div class="line"><span class="comment"> 8:  */</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">protected</span> <span class="keyword">final</span> Observable&lt;R&gt; cachedObservable;</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">11:  * TODO ã€2006ã€‘ã€outstandingSubscriptionsã€‘</span></div><div class="line"><span class="comment">12:  */</span></div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> outstandingSubscriptions = <span class="number">0</span>;</div><div class="line"><span class="number">14</span>: <span class="comment">//private AtomicInteger outstandingSubscriptions2 = new AtomicInteger(0);</span></div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="function"><span class="keyword">protected</span> <span class="title">HystrixCachedObservable</span><span class="params">(<span class="keyword">final</span> Observable&lt;R&gt; originalObservable)</span> </span>&#123;</div><div class="line"><span class="number">17</span>:     ReplaySubject&lt;R&gt; replaySubject = ReplaySubject.create();</div><div class="line"><span class="number">18</span>:     <span class="keyword">this</span>.originalSubscription = originalObservable</div><div class="line"><span class="number">19</span>:             .subscribe(replaySubject);</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:     <span class="keyword">this</span>.cachedObservable = replaySubject</div><div class="line"><span class="number">22</span>:             .doOnUnsubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">23</span>:                 <span class="meta">@Override</span></div><div class="line"><span class="number">24</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">25</span>:                     outstandingSubscriptions--;</div><div class="line"><span class="number">26</span>:                     <span class="keyword">if</span> (outstandingSubscriptions == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">27</span>:                         originalSubscription.unsubscribe();</div><div class="line"><span class="number">28</span>:                     &#125;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;)</div><div class="line"><span class="number">31</span>:             .doOnSubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line"><span class="number">32</span>:                 <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:                     outstandingSubscriptions++;</div><div class="line"><span class="number">35</span>:                 &#125;</div><div class="line"><span class="number">36</span>:             &#125;);</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 17 è‡³ 19 è¡Œ ï¼šå®é™…ä¸Šï¼Œ<strong>HystrixCachedObservable ä¸æ˜¯ä¸€ä¸ª Observable çš„å­ç±»</strong>ï¼Œè€Œæ˜¯å¯¹ä¼ å…¥çš„ Observable <strong>å°è£…</strong> ï¼šä½¿ç”¨ ReplaySubject å‘ä¼ å…¥çš„ Observable å‘èµ·è®¢é˜…ï¼Œé€šè¿‡ ReplaySubject èƒ½å¤Ÿ<strong>é‡æ”¾</strong>æ‰§è¡Œç»“æœï¼Œä»è€Œå®ç°ç¼“å­˜çš„åŠŸæ•ˆã€‚è¿™é‡Œæœ‰å‡ ä¸ªå¡åˆ°ç¬”è€…çš„å¹¶ä¸”å¾ˆæœ‰è¶£çš„ç‚¹ï¼Œæˆ‘ä»¬ä¸€ä¸€é“æ¥ ï¼šä»ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥çš„ <code>originalObservable</code> ä¸º <code>hystrixObservable</code> æ‰§è¡Œå‘½ä»¤ Observable ã€‚åœ¨ Hystrix é‡Œï¼Œæä¾›äº†ä¸¤ç§æ‰§è¡Œå‘½ä»¤çš„éš”ç¦»æ–¹å¼ ï¼šçº¿ç¨‹æ± ( <code>THREAD</code> ) å’Œä¿¡å·é‡( <code>SEMAPHORE</code> )ã€‚</p><ul><li><p>å½“ä½¿ç”¨ <code>THREAD</code> éš”ç¦»æ—¶ï¼Œ<code>#subscribe(replaySubject)</code> è°ƒç”¨å®Œæˆæ—¶ï¼Œ<strong>å®é™…å‘½ä»¤å¹¶æœªå¼€å§‹æ‰§è¡Œ</strong>ï¼Œæˆ–è€…è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>å¼‚æ­¥</strong>çš„æ‰§è¡Œå‘½ä»¤çš„è¿‡ç¨‹ã€‚é‚£ä¹ˆï¼Œ<strong>ä¼šä¸ä¼šå½±å“è¿”å›æ‰§è¡Œç»“æœå‘¢</strong>ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯ä¸ä¼šï¼ŒBlockingObservable åœ¨å¾—åˆ°æ‰§è¡Œå®Œæˆæ‰ä¼š<strong>ç»“æŸé˜»å¡</strong>ï¼Œæ­¤æ—¶å·²ç»æœ‰æ‰§è¡Œç»“æœã€‚</p></li><li><p>å½“ä½¿ç”¨ <code>SEMAPHORE</code> éš”ç¦»æ—¶ï¼Œ<code>#subscribe(replaySubject)</code> è°ƒç”¨å®Œæˆæ—¶ï¼Œ<strong>å®é™…å‘½ä»¤å·²ç»æ‰§è¡Œå®Œæˆ</strong>ï¼Œæ‰€ä»¥å³ä½¿ <code>AbstractCommand#toObservavle(...)</code> çš„ç¬¬ 75 è¡Œ ï¼šè°ƒç”¨ <code>HystrixCommandResponseFromCache#unsubscribe()</code> æ–¹æ³•ï¼Œä¹Ÿä¼šæµªè´¹ï¼Œ<strong>é‡å¤</strong>æ‰§è¡Œå‘½ä»¤ã€‚è€Œå¯¹äº <code>THREAD</code> éš”ç¦»çš„æƒ…å†µï¼Œé€šè¿‡å–æ¶ˆè®¢é˜…çš„æ–¹å¼ï¼Œåªä¼šæ‰§è¡Œ<strong>ä¸€æ¬¡</strong>å‘½ä»¤ã€‚å½“ç„¶ï¼Œå¦‚æœâ€œæ¶æâ€ <code>THREAD</code> éš”ç¦»çš„æƒ…å†µï¼Œå¢åŠ  <code>sleep</code> çš„è°ƒç”¨å¦‚ä¸‹ï¼Œå°±èƒ½è¾¾åˆ°<strong>é‡å¤</strong>æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœã€‚</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_15/03.png" alt=""></p></li></ul></li><li><p>ç¬¬ 21 è‡³ 36 è¡Œ ï¼šTODO ã€2006ã€‘ã€outstandingSubscriptionsã€‘åŸå­æ€§æ²¡é—®é¢˜ä¹ˆï¼Ÿå†å²ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ AtomicInteger ã€‚</p></li></ul><hr><p>HystrixCachedObservable çš„å…¶ä»–æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCachedObservable.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h1>6. HystrixCommandResponseFromCache</h1><p><code>com.netflix.hystrix.HystrixCommandResponseFromCache</code> ï¼Œæ˜¯ HystrixCachedObservable çš„å­ç±»ã€‚åœ¨çˆ¶ç±»çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¯¹ <code>AbstractCommand.executionResult</code> çš„å…³æ³¨ã€‚</p><p><code>HystrixCachedObservable#from(Observable, AbstractCommand)</code> æ–¹æ³•ï¼Œåˆ›å»º HystrixCommandResponseFromCache å¯¹è±¡ï¼Œç‚¹å‡» <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCachedObservable.java#L36" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><hr><p><code>HystrixCommandResponseFromCache#toObservableWithStateCopiedInto(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommandResponseFromCache.java#L17" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><ul><li>é€šè¿‡ <code>completionLogicRun</code> å±æ€§ï¼Œä¿è¯ <code>#doOnError()</code> ï¼Œ<code>#doOnCompleted()</code> ï¼Œ<code>#doOnUnsubscribe()</code> æ–¹æ³•æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå…·ä½“é€»è¾‘ã€‚<ul><li><code>#doOnError()</code> ï¼Œ<code>#doOnCompleted()</code> æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>#commandCompleted()</code> æ–¹æ³•ï¼Œä»ç¼“å­˜å‘½ä»¤( <code>HystrixCommandResponseFromCache.originalCommand</code> ) å¤åˆ¶ <code>executionResult</code> å±æ€§ç»™å½“å‰å‘½ä»¤( <code>commandToCopyStateInto</code> ) ã€‚</li><li><code>#doOnUnsubscribe()</code> æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ <code>#commandUnsubscribed()</code> æ–¹æ³•ï¼Œä½¿ç”¨å½“å‰å‘½ä»¤( <code>commandToCopyStateInto</code> )<strong>è‡ªå·±</strong>çš„ <code>executionResult</code> ï¼Œä¸è¿›è¡Œå¤åˆ¶ã€‚</li></ul></li><li>TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”</li></ul><h1>666. å½©è›‹</h1><p>å¦‚é² åœ¨å–‰çš„æ„Ÿè§‰ï¼Œä»å‘¨å…­å¼€å§‹ç£¨äº†å››å¤©å¤šï¼Œä¸€ç›´æ²¡å†™åˆ°ä¸€ä¸ªæ¯”è¾ƒèˆ’æœçš„çŠ¶æ€ã€‚</p><p>å…ˆå‘ç°å‘ï¼Œå¦‚æœæœ‰ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œçƒ¦è¯·æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-result-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/strong&gt;&lt;
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” æ‰§è¡Œå‘½ä»¤æ–¹å¼</title>
    <link href="http://www.iocoder.cn/Hystrix/command-execute-mode/"/>
    <id>http://www.iocoder.cn/Hystrix/command-execute-mode/</id>
    <published>2018-10-09T16:00:00.000Z</published>
    <updated>2017-11-06T10:40:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-mode/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/command-execute-mode/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-mode/">2. å®ç°</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-mode/">3. BlockingObservable</a></li><li><a href="http://www.iocoder.cn/Hystrix/command-execute-mode/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Hystrix æ‰§è¡Œå‘½ä»¤æ–¹æ³•</strong>ã€‚</p><p>å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚</p><p>åœ¨å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° <a href="https://github.com/Netflix/Hystrix/blob/d838f4d1ba65ce55755ab1c73f74c980f04572bf/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java" rel="external nofollow noopener noreferrer" target="_blank">CommandHelloWorld</a> é€šè¿‡ç»§æ‰¿ <a href="https://github.com/Netflix/Hystrix/blob/d838f4d1ba65ce55755ab1c73f74c980f04572bf/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java" rel="external nofollow noopener noreferrer" target="_blank">HystrixCommand</a> æŠ½è±¡ç±»ï¼Œæœ‰å››ç§è°ƒç”¨æ–¹å¼ï¼š</p><table><thead><tr><th style="text-align:left">æ–¹æ³•</th><th style="text-align:left"></th></tr></thead><tbody><tr><td style="text-align:left"><code>#execute()</code></td><td style="text-align:left"><strong>åŒæ­¥</strong>è°ƒç”¨ï¼Œè¿”å›<strong>ç›´æ¥</strong>ç»“æœ</td></tr><tr><td style="text-align:left"><code>#queue()</code></td><td style="text-align:left"><strong>å¼‚æ­¥</strong>è°ƒç”¨ï¼Œè¿”å› <code>java.util.concurrent.Future</code></td></tr><tr><td style="text-align:left"><code>#observe()</code></td><td style="text-align:left"><strong>å¼‚æ­¥</strong>è°ƒç”¨ï¼Œè¿”å› <code>rx.Observable</code> ã€‚å‘ Observable æ³¨å†Œ <code>rx.Subscriber</code> å¤„ç†ç»“æœ</td></tr><tr><td style="text-align:left"><code>#toObservable()</code></td><td style="text-align:left"><strong>æœªè°ƒç”¨</strong>ï¼Œè¿”å› <code>rx.Observable</code> ã€‚å‘ Observable æ³¨å†Œ <code>rx.Subscriber</code> å¤„ç†ç»“æœ</td></tr></tbody></table><ul><li>ç¬¬å››ç§æ–¹å¼ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java#L165" rel="external nofollow noopener noreferrer" target="_blank"><code>#testToObservable()</code></a> æŸ¥çœ‹ç¬”è€…è¡¥å……çš„ç¤ºä¾‹ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_08/01.jpeg" alt=""></p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. å®ç°</h1><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractCommand.java</span></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCommand</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">HystrixInvokableInfo</span>&lt;<span class="title">R</span>&gt;, <span class="title">HystrixObservable</span>&lt;<span class="title">R</span>&gt; </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³å±æ€§ä¸æ–¹æ³•</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="keyword">return</span> Observable.defer(<span class="keyword">new</span> Func0&lt;Observable&lt;R&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">// ....</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;R&gt; <span class="title">observe</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// us a ReplaySubject to buffer the eagerly subscribed-to Observable</span></div><div class="line">        ReplaySubject&lt;R&gt; subject = ReplaySubject.create();</div><div class="line">        <span class="comment">// eagerly kick off subscription</span></div><div class="line">        <span class="keyword">final</span> Subscription sourceSubscription = toObservable().subscribe(subject);</div><div class="line">        <span class="comment">// return the subject that can be subscribed to later while the execution has already started</span></div><div class="line">        <span class="keyword">return</span> subject.doOnUnsubscribe(<span class="keyword">new</span> Action0() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">                sourceSubscription.unsubscribe();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HystrixCommand.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCommand</span>&lt;<span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractCommand</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">HystrixExecutable</span>&lt;<span class="title">R</span>&gt;, <span class="title">HystrixInvokableInfo</span>&lt;<span class="title">R</span>&gt;, <span class="title">HystrixObservable</span>&lt;<span class="title">R</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³å±æ€§ä¸æ–¹æ³•</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Future&lt;R&gt; <span class="title">queue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Future&lt;R&gt; delegate = toObservable().toBlocking().toFuture();</div><div class="line">        <span class="keyword">final</span> Future&lt;R&gt; f = <span class="keyword">new</span> Future&lt;R&gt;() &#123;</div><div class="line">            <span class="comment">// ... åŒ…è£… delegate</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        <span class="keyword">return</span> f;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> queue().get();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> Exceptions.sneakyThrow(decomposeException(e));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> R <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>#toObservable()</code> æ–¹æ³• ï¼š<strong>æœª</strong>åšè®¢é˜…ï¼Œè¿”å›å¹²å‡€çš„ Observable ã€‚<strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šæ–‡è¯´â€œæœªè°ƒç”¨â€</strong> ã€‚</p></li><li><p><code>#observe()</code> æ–¹æ³• ï¼šè°ƒç”¨ <code>#toObservable()</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œå‘ Observable æ³¨å†Œ <code>rx.subjects.ReplaySubject</code> <strong>å‘èµ·è®¢é˜…</strong> ã€‚</p><ul><li>ReplaySubject ä¼šå‘å°„æ‰€æœ‰æ¥è‡ªåŸå§‹ Observable çš„æ•°æ®ç»™è§‚å¯Ÿè€…ï¼Œæ— è®ºå®ƒä»¬æ˜¯ä½•æ—¶è®¢é˜…çš„ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” Subjectã€‹</a> ã€‚</li></ul></li><li><p><code>#queue()</code> æ–¹æ³• ï¼šè°ƒç”¨ <code>#toObservable()</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ï¼š</p><ul><li><code>Observable#toBlocking()</code> æ–¹æ³• ï¼šå°† Observable è½¬æ¢æˆ<strong>é˜»å¡</strong>çš„ <code>rx.observables.BlockingObservable</code> ã€‚</li><li><code>BlockingObservable#toFuture()</code> æ–¹æ³• ï¼šè¿”å›å¯è·å¾— <code>#run()</code> <strong>æŠ½è±¡æ–¹æ³•</strong>æ‰§è¡Œç»“æœçš„ Future ã€‚<ul><li><code>#run()</code> æ–¹æ³• ï¼šå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘</strong>ã€‚</li></ul></li><li>BlockingObservable åœ¨ <a href="#">ã€Œ3. BlockingObservableã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li><p><code>#execute()</code> æ–¹æ³• ï¼šè°ƒç”¨ <code>#queue()</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ <code>Future#get()</code> æ–¹æ³•ï¼Œ<strong>åŒæ­¥</strong>è¿”å› <code>#run()</code> çš„æ‰§è¡Œç»“æœã€‚</p></li><li><p>æ•´ç†å››ç§è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_08/02.png" alt=""></p><blockquote><p>FROM <a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#problem9" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹</a><img src="http://www.iocoder.cn/images/Hystrix/2018_10_08/03.png" alt=""></p></blockquote></li></ul><h1>3. BlockingObservable</h1><p>æœ¬å°èŠ‚ä¸º<strong>æ‹“å±•å†…å®¹</strong>ï¼Œæºç è§£æ RxJava ( é Hystrix ) çš„ <code>rx.observables.BlockingObservable</code> çš„å®ç°ï¼Œæ‰€ä»¥ä½ å¯ä»¥é€‰æ‹©ï¼š</p><ul><li>1 ) è·³è¿‡æœ¬å°èŠ‚ï¼Œä¸å½±å“å¯¹æœ¬æ–‡çš„ç†è§£ã€‚</li><li>2 ) é€‰æ‹©é˜…è¯» <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Blocking-Observable-Operators.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” é˜»å¡æ“ä½œã€‹</a> ï¼Œç†è§£ BlockingObservable çš„åŸç†ã€‚</li><li>3 ) é€‰æ‹©é˜…è¯»æœ¬å°èŠ‚ï¼Œç†è§£ BlockingObservable çš„åŸç†ä»¥åŠå®ç°ã€‚</li></ul><p><a href="http://www.iocoder.cn/RxJava/blocking-observable/">ã€ŠRxJava æºç è§£æ â€”â€” BlockingObservableã€‹</a></p><h1>666. å½©è›‹</h1><p>ç¬¬ä¸€ç¯‡ Hystrix æ­£å¼çš„æºç è§£æã€‚</p><p>æ¢³ç† Hystrix çš„æºç è¿˜æ˜¯è›®ç—›è‹¦çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºå¯¹ RxJava ä¸å¤Ÿç†Ÿæ‚‰ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-mode/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/Hystrix/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/Hystrix/build-debugging-environment/</id>
    <published>2018-09-30T16:00:00.000Z</published>
    <updated>2017-11-06T10:40:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">1. ä¾èµ–å·¥å…·</a></li><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">2. æºç æ‹‰å–</a></li><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">3. è¿è¡Œç¤ºä¾‹</a></li><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">4. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. ä¾èµ–å·¥å…·</h1><ul><li>Gradle</li><li>JDK</li><li>IntelliJ IDEA</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/Netflix/Hystrix.git" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/Hystrix.git</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚åœ¨é¡¹ç›®è·¯å¾„ä¸‹ï¼Œåœ¨<strong>å‘½ä»¤è¡Œ</strong>æ‰§è¡Œ <code>./gradlew</code> å‘½ä»¤ï¼Œ<code>Gradle</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚å…¶é—´å¯èƒ½ä¼šå‡ºç°å› ä¸ºç½‘ç»œåŸå› ( æˆ‘ç›¸ä¿¡ä½ æ‡‚çš„ )ï¼Œå¯èƒ½ä¼šå‡ºç°å¤±è´¥çš„æƒ…å†µï¼Œæ·¡å®šï¼Œé‡æ–°æ‰§è¡Œä¸Šè¿°å‘½ä»¤ç›´åˆ°æˆåŠŸã€‚æ­¤åˆ»ï¼Œä½ å°±æ˜¯ä¸€ä¸ª <code>while(true)</code> çš„å°å¼ºã€‚</p><p>æœ¬æ–‡åŸºäº <code>master</code> åˆ†æ”¯ã€‚</p><h1>3. è¿è¡Œç¤ºä¾‹</h1><p>åœ¨ <code>hystrix-examples</code> å­é¡¹ç›®ä¸‹ï¼Œæä¾›äº†<strong>å¤§é‡</strong>çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_01/01.png" alt=""></p><ul><li><code>basic</code> åŒ… ï¼šé’ˆå¯¹ Hystrix æ¯ä¸ªç‰¹æ€§æä¾›å°çš„å•å…ƒæµ‹è¯•ç¤ºä¾‹ã€‚ä½ å¯ä»¥ä» CommandHelloWorld å¼€å§‹å°è¯•ã€‚</li><li><code>demo</code> åŒ… ï¼šç»“åˆå®é™…åœºæ™¯çš„å®æˆ˜å°ä¾‹å­ã€‚è¿è¡Œå…¥å£ä¸º HystrixCommandDemo æˆ–è€… HystrixCommandAsyncDemo ã€‚æ©ï¼Œèªæ…§å¦‚ä½ ï¼Œä»åå­—èƒ½çœ‹å‡ºå®ƒä»¬çš„åŒºåˆ«ç‚¹ã€‚</li></ul><p>å¯èƒ½æœ‰éƒ¨åˆ†åŒå­¦å¯¹ Hystrix çš„ç‰¹æ€§äº†è§£çš„ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œç¬”è€…æ¨èå¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li><a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrix æ–‡æ¡£ - å®ç°åŸç†ã€‹</a></li><li><a href="http://tech.lede.com/2017/06/15/rd/server/hystrix/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šhystrix åœ¨ spring mvc çš„ä½¿ç”¨ã€‹</a></li></ul><p>å¦å¤–ï¼Œç¬”è€…ä¹Ÿæ•´ç†äº†ä¸‹ Hystrix çš„ç‰¹æ€§å¦‚ä¸‹( å¯èƒ½ä¸æ˜¯å¾ˆä¸¥è°¨ï¼Œä¸»è¦è¾…åŠ©ç†è§£ ) ï¼š</p><ul><li>æ–­è·¯å™¨æœºåˆ¶<ul><li>è®¡ç®—çº¿è·¯å¥åº·åº¦</li></ul></li><li>Fallback ( å¤±è´¥å›é€€ )</li><li>èµ„æºéš”ç¦»<ul><li>æ–¹å¼<ul><li>çº¿ç¨‹æ± </li><li>ä¿¡å·é‡</li></ul></li><li>ä¾èµ–éš”ç¦»</li></ul></li><li>æ‰§è¡Œæ¨¡å‹<ul><li>åŒæ­¥æ‰§è¡Œ</li><li>å¼‚æ­¥æ‰§è¡Œ</li><li>Reactiveæ¨¡å¼æ‰§è¡Œ<ul><li>observe</li><li>toObservable</li></ul></li></ul></li><li>è¿ç»´å¹³å°<ul><li>åŸºç¡€ Dashboard</li><li>æ•´åˆ Turbine</li></ul></li><li>ç¼“å­˜</li><li>è¯·æ±‚åˆå¹¶( HystrixCollapser )</li></ul><h1>4. å½©è›‹</h1><p>ä¸ºäº†æ˜¾å¾—æœ¬æ–‡çš„è¯šæ„( çœŸçš„ä¸æ˜¯æ°´æ›´ )ï¼Œå‹æƒ…æç¤ºå¦‚ä¸‹ï¼š</p><p>Hystrix åŸºäº RxJava å®ç°ï¼Œæ‰€ä»¥ç¬”è€…æ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç«  ï¼š</p><ul><li><a href="http://gank.io/post/560e15be2dca930e00da1083" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£ã€‹</a></li><li><a href="http://www.jianshu.com/p/856297523728" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¤§è¯ RxJavaã€‹ç³»åˆ—</a></li><li><a href="https://www.gitbook.com/book/mcxiaoke/rxdocs/details" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆã€‹</a></li></ul><p>å¯èƒ½ä¸€å¼€å§‹ç†è§£ä¼šæ¯”è¾ƒå›°éš¾ï¼Œä¿æŒè€å¿ƒï¼Œä½ å³å°†æ‰“å¼€ä¸€ä¸ªæ–°çš„ä¸–ç•Œã€‚å¯¹äº†ï¼Œ<strong>å˜æ¢</strong>( <code>#lift(Operator)</code> ) ä¼šæ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œæˆ‘ç›¸ä¿¡ä½ å¯ä»¥ç†è§£ã€‚</p><hr><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p><p>å¯¹äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»åˆ—æ–‡ï¼Œæ‰€ä»¥ï¼Œåƒä¸‡ä¸è¦é”™è¿‡ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” StringCache</title>
    <link href="http://www.iocoder.cn/Eureka/string-cache/"/>
    <id>http://www.iocoder.cn/Eureka/string-cache/</id>
    <published>2018-08-20T16:00:00.000Z</published>
    <updated>2017-10-19T15:47:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/string-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/string-cache/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/string-cache/">2. StringCache</a></li><li><a href="http://www.iocoder.cn/Eureka/string-cache/">3. ä½¿ç”¨åœºæ™¯</a></li><li><a href="http://www.iocoder.cn/Eureka/string-cache/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka è‡ªå·±å®ç°çš„ StringCache</strong>ã€‚</p><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹ç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿå¯¹ <code>String#intern(...)</code> çš„åˆ†äº«ï¼š</p><blockquote><p>FROM <a href="https://tech.meituan.com/in_depth_understanding_string_intern.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥è§£æString#internã€‹ã€Œ å¼•è¨€ ã€</a><br>åœ¨ JAVA è¯­è¨€ä¸­æœ‰8ä¸­åŸºæœ¬ç±»å‹å’Œä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ <code>String</code>ã€‚è¿™äº›ç±»å‹ä¸ºäº†ä½¿ä»–ä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€Ÿåº¦æ›´å¿«ï¼Œæ›´èŠ‚çœå†…å­˜ï¼Œéƒ½æä¾›äº†ä¸€ç§å¸¸é‡æ± çš„æ¦‚å¿µã€‚å¸¸é‡æ± å°±ç±»ä¼¼ä¸€ä¸ª JAVA ç³»ç»Ÿçº§åˆ«æä¾›çš„ç¼“å­˜ã€‚<br>8 ç§åŸºæœ¬ç±»å‹çš„å¸¸é‡æ± éƒ½æ˜¯ç³»ç»Ÿåè°ƒçš„ï¼Œ<code>String</code> ç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p><ul><li>ç›´æ¥ä½¿ç”¨åŒå¼•å·å£°æ˜å‡ºæ¥çš„ <code>String</code> å¯¹è±¡ä¼šç›´æ¥å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­</li><li>å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„ <code>String</code> å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Stringæä¾›çš„ <code>intern</code> æ–¹æ³•ã€‚<code>intern</code> æ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥è¯¢å½“å‰å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­</li></ul></blockquote><ul><li>å­—ç¬¦ä¸²å¸¸é‡æ± èƒ½å¸¦æ¥é€Ÿåº¦æ›´å¿«ï¼Œæ›´èŠ‚çœå†…å­˜çš„å¥½å¤„</li><li><strong>éåŒå¼•å·å£°æ˜</strong>çš„ String å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ <code>String#intern()</code> æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²å­˜å‚¨åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ã€‚</li></ul><p>çœ‹èµ·æ¥ä¸€åˆ‡éƒ½éå¸¸éå¸¸éå¸¸ç¾å¥½ï¼Œé‚£ä¸ºä»€ä¹ˆ Eureka è‡ªå·±å®ç°äº† StringCache ï¼Ÿ</p><p>ç»§ç»­å‚è§ç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿå¯¹ <code>String#intern(...)</code> çš„åˆ†äº«ï¼š</p><blockquote><p>FROM <a href="https://tech.meituan.com/in_depth_understanding_string_intern.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥è§£æString#internã€‹ã€Œ native ä»£ç  ã€</a><br>JAVA ä½¿ç”¨ JNI è°ƒç”¨ c++ å®ç°çš„ StringTable çš„ <code>intern</code> æ–¹æ³•, StringTableçš„ <code>intern</code> æ–¹æ³•è·Ÿ Java ä¸­çš„ HashMap çš„å®ç°æ˜¯å·®ä¸å¤šçš„, åªæ˜¯ä¸èƒ½è‡ªåŠ¨æ‰©å®¹ã€‚<strong>é»˜è®¤å¤§å°æ˜¯1009</strong>ã€‚</p></blockquote><blockquote><p>è¦æ³¨æ„çš„æ˜¯ï¼ŒString çš„ String Pool æ˜¯ä¸€ä¸ª<strong>å›ºå®šå¤§å°</strong>çš„ Hashtableï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯ 1009ï¼Œå¦‚æœæ”¾è¿› String Pool çš„ String éå¸¸å¤šï¼Œå°±ä¼šé€ æˆ<strong>Hashå†²çªä¸¥é‡</strong>ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨ä¼šå¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†åç›´æ¥ä¼šé€ æˆçš„å½±å“å°±æ˜¯å½“è°ƒç”¨String.internæ—¶æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ï¼ˆå› ä¸ºè¦ä¸€ä¸ªä¸€ä¸ªæ‰¾ï¼‰ã€‚</p></blockquote><blockquote><p>åœ¨ JDK6 ä¸­ StringTable æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯ 1009 çš„é•¿åº¦ï¼Œæ‰€ä»¥å¦‚æœå¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿«ã€‚åœ¨jdk7ä¸­ï¼ŒStringTableçš„é•¿åº¦å¯ä»¥é€šè¿‡ä¸€ä¸ªå‚æ•°æŒ‡å®šï¼š</p></blockquote><blockquote><ul><li>-XX:StringTableSize=99991</li></ul></blockquote><ul><li>JDK è‡ªå¸¦çš„ String Pool å›ºå®šå¤§å°( å³ä½¿å¯é… )ï¼Œä¸æ”¯æŒè‡ªåŠ¨æ‰©å®¹ï¼Œå¤§é‡ä½¿ç”¨ <code>String#intern(...)</code> åï¼Œä¼šå¯¼è‡´æ€§èƒ½å¤§å¹…åº¦ä¸‹é™ã€‚</li><li>Eureka çš„åº”ç”¨å®ä¾‹( InstanceInfo ) çš„ <code>appName</code>ã€<code>appGroupName</code>ã€<code>vipAddress</code>ã€<code>secureVipAddress</code>ã€<code>metadata</code> å’Œåº”ç”¨( Application )çš„ <code>name</code> ç­‰å±æ€§éœ€è¦ä½¿ç”¨åˆ° String Pool ï¼Œä¸ºäº†åœ¨å¤§é‡çš„ç½‘ç»œé€šä¿¡åºåˆ—åŒ–ååºåˆ—çš„è¿‡ç¨‹ä¸­ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæ›´èŠ‚çœå†…å®¹ã€‚</li></ul><p>å¦å¤–ï¼ŒFastJSON åœ¨ 1.124 ç‰ˆæœ¬<strong>ä¹‹å‰</strong>ä¹Ÿä½¿ç”¨ <code>String#intern(...)</code> æ–¹æ³•ï¼Œä¼˜åŒ– JSON Key çš„é€Ÿåº¦å’Œç©ºé—´ï¼Œä½†æ˜¯åœ¨å¤§é‡åŠ¨æ€ JSON Key çš„åœºæ™¯ä¸‹ï¼Œåè€Œä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚æ‰€ä»¥ FastJSON 1.124 ä¿®å¤äº†è¯¥é—®é¢˜ã€‚å‚è§å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="https://tech.meituan.com/in_depth_understanding_string_intern.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥è§£æString#internã€‹ã€Œ fastjson ä¸å½“ä½¿ç”¨ ã€</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_08_21/01.png" alt=""></p></blockquote><ul><li>But ï¼ŒFastJSON 1.124 ç‰ˆæœ¬<strong>ä¹‹å‰</strong>æ°å¥½é€‚åˆ Eureka ï¼Œå› ä¸º <code>appName</code>ã€<code>appGroupName</code> <strong>ç›¸å¯¹ä¸é‚£ä¹ˆåŠ¨æ€</strong>ã€‚è€ƒè™‘åˆ°å¯èƒ½è¿˜æ˜¯æœ‰å¤§é‡çš„å­—ç¬¦ä¸²å­˜åœ¨ï¼Œå› è€Œå®ç°è‡ªå®šä¹‰çš„ StringCache ç±»ï¼Œä»¥è§£å†³ StringPool çš„ HashTable ä¸æ”¯æŒåŠ¨æ€æ‰©å®¹çš„æƒ…å†µã€‚</li></ul><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ Eureka æ˜¯å¦‚ä½•å®ç°è‡ªå®šä¹‰çš„ StringCache ç±»ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. StringCache</h1><p><code>com.netflix.discovery.util.StringCache</code> ï¼Œå­—ç¬¦ä¸²ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringCache</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LENGTH_LIMIT = <span class="number">38</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StringCache INSTANCE = <span class="keyword">new</span> StringCache();</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"> <span class="number">8</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, WeakReference&lt;String&gt;&gt; cache = <span class="keyword">new</span> WeakHashMap&lt;String, WeakReference&lt;String&gt;&gt;();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> lengthLimit;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> <span class="title">StringCache</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">this</span>(LENGTH_LIMIT);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> <span class="title">StringCache</span><span class="params">(<span class="keyword">int</span> lengthLimit)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">this</span>.lengthLimit = lengthLimit;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">cachedValueOf</span><span class="params">(<span class="keyword">final</span> String str)</span> </span>&#123;</div><div class="line"><span class="number">20</span>:         <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; (lengthLimit &lt; <span class="number">0</span> || str.length() &lt;= lengthLimit)) &#123;</div><div class="line"><span class="number">21</span>:             <span class="comment">// Return value from cache if available</span></div><div class="line"><span class="number">22</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">23</span>:                 lock.readLock().lock();</div><div class="line"><span class="number">24</span>:                 WeakReference&lt;String&gt; ref = cache.get(str);</div><div class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">26</span>:                     <span class="keyword">return</span> ref.get();</div><div class="line"><span class="number">27</span>:                 &#125;</div><div class="line"><span class="number">28</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">29</span>:                 lock.readLock().unlock();</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// Update cache with new content</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">34</span>:                 lock.writeLock().lock();</div><div class="line"><span class="number">35</span>:                 WeakReference&lt;String&gt; ref = cache.get(str);</div><div class="line"><span class="number">36</span>:                 <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">37</span>:                     <span class="keyword">return</span> ref.get();</div><div class="line"><span class="number">38</span>:                 &#125;</div><div class="line"><span class="number">39</span>:                 cache.put(str, <span class="keyword">new</span> WeakReference&lt;&gt;(str));</div><div class="line"><span class="number">40</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">41</span>:                 lock.writeLock().unlock();</div><div class="line"><span class="number">42</span>:             &#125;</div><div class="line"><span class="number">43</span>:             <span class="keyword">return</span> str;</div><div class="line"><span class="number">44</span>:         &#125;</div><div class="line"><span class="number">45</span>:         <span class="keyword">return</span> str;</div><div class="line"><span class="number">46</span>:     &#125;</div><div class="line"><span class="number">47</span>: </div><div class="line"><span class="number">48</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">49</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">50</span>:             lock.readLock().lock();</div><div class="line"><span class="number">51</span>:             <span class="keyword">return</span> cache.size();</div><div class="line"><span class="number">52</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">53</span>:             lock.readLock().unlock();</div><div class="line"><span class="number">54</span>:         &#125;</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">intern</span><span class="params">(String original)</span> </span>&#123;</div><div class="line"><span class="number">58</span>:         <span class="keyword">return</span> INSTANCE.cachedValueOf(original);</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>INSTANCE</code> å±æ€§ï¼Œå­—ç¬¦ä¸²ç¼“å­˜<strong>å•ä¾‹</strong>ã€‚</li><li><code>lock</code> å±æ€§ï¼Œ<strong>è¯»å†™é”</strong>ï¼Œä¿è¯è¯»å†™äº’æ–¥ã€‚</li><li><code>cache</code> å±æ€§ï¼Œç¼“å­˜å“ˆå¸Œè¡¨ã€‚<ul><li>ä½¿ç”¨ WeakHashMapï¼Œå½“ StringCache è¢«å›æ”¶æ—¶ï¼Œå…¶å¯¹åº”çš„å€¼ä¸€èµ·è¢«ç§»é™¤ã€‚</li><li><a href="http://blog.csdn.net/yangzl2008/article/details/6980709" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠWeakHashMapå’ŒHashMapçš„åŒºåˆ«ã€‹</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3311092.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava é›†åˆç³»åˆ—13ä¹‹ WeakHashMapè¯¦ç»†ä»‹ç»(æºç è§£æ)å’Œä½¿ç”¨ç¤ºä¾‹ã€‹</a></li></ul></li><li><code>lengthLimit</code> å±æ€§ï¼Œç¼“å­˜å­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ã€‚é»˜è®¤å€¼ï¼š38 ã€‚</li><li><code>#cachedValueOf(...)</code> æ–¹æ³•ï¼Œè·å¾—å­—ç¬¦ä¸²ç¼“å­˜ã€‚è‹¥ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œç¼“å­˜ã€‚å’Œ <code>String#intern()</code> çš„é€»è¾‘ç›¸åŒï¼ŒåŒºåˆ«åœ¨äº <code>cache</code> æ”¯æŒè‡ªåŠ¨æ‰©å®¹ã€‚<ul><li>ç¬¬ 22 è‡³ 30 è¡Œ ï¼šè¯»é”ï¼Œè¯»å–ç¼“å­˜ã€‚</li><li>ç¬¬ 32 è‡³ 42 è¡Œ ï¼šç¼“å­˜ä¸å­˜åœ¨ï¼Œå†™é”ï¼Œå†™å…¥ç¼“å­˜ã€‚</li></ul></li><li><code>#size()</code> æ–¹æ³•ï¼Œç¼“å­˜å¤§å°ã€‚</li><li><code>#intern()</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œä½¿ç”¨ <code>INSTANCE</code> è·å–ç¼“å­˜å­—ç¬¦ä¸²ã€‚</li></ul><h1>3. ä½¿ç”¨åœºæ™¯</h1><p>åœ¨ InstanceInfo ä¸‹çš„ä½¿ç”¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java#L233" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><p>åœ¨ Application ä¸‹çš„ä½¿ç”¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-client/src/main/java/com/netflix/discovery/shared/Application.java#L95" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h1>666. å½©è›‹</h1><p>åˆ Get æ–°å§¿åŠ¿äº†ï¼Œå¥½å¼€æ£®ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆï¼Œå¯å¥½ï¼Ÿï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/string-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka/string-cache/&quot;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiter</title>
    <link href="http://www.iocoder.cn/Eureka/rate-limiter/"/>
    <id>http://www.iocoder.cn/Eureka/rate-limiter/</id>
    <published>2018-08-13T16:00:00.000Z</published>
    <updated>2017-10-19T05:48:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/rate-limiter/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">2. RateLimiter</a><ul><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">2.1 refillToken</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">2.2 consumeToken</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">3. RateLimitingFilter</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">4. InstanceInfoReplicator</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RateLimiter çš„ä»£ç å®ç°å’Œ RateLimiter åœ¨ Eureka ä¸­çš„åº”ç”¨</strong>ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. RateLimiter</h1><p><code>com.netflix.discovery.util.RateLimiter</code> ï¼ŒåŸºäº**Token Bucket Algorithm ( ä»¤ç‰Œæ¡¶ç®—æ³• )**çš„é€Ÿç‡é™åˆ¶å™¨ã€‚</p><blockquote><p>FROM <a href="http://www.cnblogs.com/LBSer/p/4083131.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ¥å£é™æµå®è·µã€‹</a><br>ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†æ˜¯ç³»ç»Ÿä¼šä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡ã€‚<br><img src="http://www.iocoder.cn/images/Eureka/2018_08_14/01.png" alt=""></p></blockquote><p>RateLimiter ç›®å‰æ”¯æŒ<strong>åˆ†é’Ÿçº§</strong>å’Œ<strong>ç§’çº§</strong>ä¸¤ç§é€Ÿç‡é™åˆ¶ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é€Ÿç‡å•ä½è½¬æ¢æˆæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> rateToMsConversion;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RateLimiter</span><span class="params">(TimeUnit averageRateUnit)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (averageRateUnit) &#123;</div><div class="line">            <span class="keyword">case</span> SECONDS: <span class="comment">// ç§’çº§</span></div><div class="line">                rateToMsConversion = <span class="number">1000</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MINUTES: <span class="comment">// åˆ†é’Ÿçº§</span></div><div class="line">                rateToMsConversion = <span class="number">60</span> * <span class="number">1000</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"TimeUnit of "</span> + averageRateUnit + <span class="string">" is not supported"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>averageRateUnit</code> å‚æ•°ï¼Œé€Ÿç‡<strong>å•ä½</strong>ã€‚æ„é€ æ–¹æ³•é‡Œå°† <code>averageRateUnit</code> è½¬æ¢æˆ <code>rateToMsConversion</code> ã€‚</li></ul><p>è°ƒç”¨ <code>#acquire(...)</code> æ–¹æ³•ï¼Œè·å–ä»¤ç‰Œï¼Œå¹¶è¿”å›<strong>æ˜¯å¦è·å–æˆåŠŸ</strong></p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// RateLimiter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–ä»¤ç‰Œ( Token )</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> burstSize ä»¤ç‰Œæ¡¶ä¸Šé™</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> averageRate ä»¤ç‰Œå†è£…å¹³å‡é€Ÿç‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ˜¯å¦è·å–æˆåŠŸ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> burstSize, <span class="keyword">long</span> averageRate)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> acquire(burstSize, averageRate, System.currentTimeMillis());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> burstSize, <span class="keyword">long</span> averageRate, <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (burstSize &lt;= <span class="number">0</span> || averageRate &lt;= <span class="number">0</span>) &#123; <span class="comment">// Instead of throwing exception, we just let all the traffic go</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// å¡«å…… ä»¤ç‰Œ</span></div><div class="line">   refillToken(burstSize, averageRate, currentTimeMillis);</div><div class="line">   <span class="comment">// æ¶ˆè´¹ ä»¤ç‰Œ</span></div><div class="line">   <span class="keyword">return</span> consumeToken(burstSize);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>burstSize</code> å‚æ•° ï¼šä»¤ç‰Œæ¡¶ä¸Šé™ã€‚</p></li><li><p><code>averageRate</code> å‚æ•° ï¼šä»¤ç‰Œå¡«å……<strong>å¹³å‡</strong>é€Ÿç‡ã€‚</p></li><li><p>æˆ‘ä»¬ä¸¾ä¸ª ğŸŒ° æ¥ç†è§£è¿™ä¸¤ä¸ªå‚æ•° + æ„é€ æ–¹æ³•é‡Œçš„ä¸€ä¸ªå‚æ•°ï¼š</p><ul><li><code>averageRateUnit = SECONDS</code></li><li><code>averageRate = 2000</code></li><li><code>burstSize = 10</code></li><li>æ¯<strong>ç§’</strong>å¯è·å– <code>2000</code> ä¸ªä»¤ç‰Œã€‚ä¾‹å¦‚ï¼Œæ¯ç§’å…è®¸è¯·æ±‚ <code>2000</code> æ¬¡ã€‚</li><li>æ¯<strong>æ¯«ç§’</strong>å¯å¡«å…… <code>2000 / 1000 = 2</code> ä¸ª<strong>æ¶ˆè€—</strong>çš„ä»¤ç‰Œã€‚</li><li>æ¯<strong>æ¯«ç§’</strong>å¯è·å– <code>10</code> ä¸ªä»¤ç‰Œã€‚ä¾‹å¦‚ï¼Œæ¯æ¯«ç§’å…è®¸è¯·æ±‚ä¸Šé™ä¸º <code>10</code> æ¬¡ï¼Œå¹¶ä¸”è¯·æ±‚<strong>æ¶ˆè€—</strong>æ‰çš„ä»¤ç‰Œï¼Œéœ€è¦é€æ­¥å¡«å……ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œè™½ç„¶æ¯æ¯«ç§’å…è®¸è¯·æ±‚ä¸Šé™ä¸º <code>10</code> æ¬¡ï¼Œè¿™æ˜¯åœ¨æ²¡æœ‰ä»»ä½•ä»¤ç‰Œè¢«<strong>æ¶ˆè€—</strong>çš„æƒ…å†µä¸‹ï¼Œå®é™…æ¯ç§’å…è®¸è¯·æ±‚ä¾ç„¶æ˜¯ <code>2000</code> æ¬¡ã€‚</li><li><strong>è¿™å°±æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„é™æµçš„ç‰¹ç‚¹ï¼šè®©æµé‡å¹³ç¨³ï¼Œè€Œä¸æ˜¯ç¬é—´æµé‡ã€‚1000 QPS ç›¸å¯¹å¹³å‡çš„åˆ†æ‘Šåœ¨è¿™ä¸€ç§’å†…ï¼Œè€Œä¸æ˜¯ç¬¬ 1 ms 999 è¯·æ±‚ï¼Œåé¢ 999 ms 0 è¯·æ±‚</strong>ã€‚</li></ul></li><li><p>ä»ä»£ç ä¸Šçœ‹ï¼Œ<code>#acquire(...)</code> åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆ†åˆ«è§£æï¼Œæ•´ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_14/02.png" alt=""></p></li></ul><h2>2.1 refillToken</h2><p>è°ƒç”¨ <code>#refillToken(...)</code> æ–¹æ³•ï¼Œå¡«å……<strong>å·²æ¶ˆè€—</strong>çš„ä»¤ç‰Œã€‚å¯èƒ½å¾ˆå¤šåŒå­¦å¼€å§‹å’Œæˆ‘æƒ³çš„ä¸€æ ·ï¼Œä¸€ä¸ªåå°æ¯æ¯«ç§’æ‰§è¡Œå¡«å……ã€‚<strong>ä¸ºä»€ä¹ˆä¸é€‚åˆè¿™æ ·å‘¢ï¼Ÿ<strong>ä¸€æ–¹é¢ï¼Œå®é™…é¡¹ç›®é‡Œæ¯ä¸ªæ¥å£éƒ½ä¼šæœ‰ç›¸åº”çš„ RateLimiter ï¼Œå¯¼è‡´</strong>å¤ªå¤š</strong>æ‰§è¡Œé¢‘ç‡<strong>æé«˜</strong>çš„åå°ä»»åŠ¡ï¼›å¦ä¸€æ–¹é¢ï¼Œè·å–ä»¤ç‰Œæ—¶æ‰è®¡ç®—ï¼Œå¤šæ¬¡ä»¤ç‰Œå¡«å……å¯ä»¥åˆå¹¶æˆä¸€æ¬¡ï¼Œå‡å°‘å†—ä½™å’Œæ— æ•ˆçš„è®¡ç®—ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * é€Ÿç‡å•ä½è½¬æ¢æˆæ¯«ç§’</span></div><div class="line"><span class="comment"> 3:  */</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> rateToMsConversion;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 7:  * æ¶ˆè€—ä»¤ç‰Œæ•°</span></div><div class="line"><span class="comment"> 8:  */</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger consumedTokens = <span class="keyword">new</span> AtomicInteger();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">11:  * æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´</span></div><div class="line"><span class="comment">12:  */</span></div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastRefillTime = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refillToken</span><span class="params">(<span class="keyword">int</span> burstSize, <span class="keyword">long</span> averageRate, <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     <span class="comment">// è·å¾— æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">long</span> refillTime = lastRefillTime.get();</div><div class="line"><span class="number">18</span>:     <span class="comment">// è·å¾— è¿‡å»å¤šå°‘æ¯«ç§’</span></div><div class="line"><span class="number">19</span>:     <span class="keyword">long</span> timeDelta = currentTimeMillis - refillTime;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:     <span class="comment">// è®¡ç®— å¯å¡«å……æœ€å¤§ä»¤ç‰Œæ•°é‡</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">long</span> newTokens = timeDelta * averageRate / rateToMsConversion;</div><div class="line"><span class="number">23</span>:     <span class="keyword">if</span> (newTokens &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">24</span>:         <span class="comment">// è®¡ç®— æ–°çš„å¡«å……ä»¤ç‰Œçš„æ—¶é—´</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">long</span> newRefillTime = refillTime == <span class="number">0</span></div><div class="line"><span class="number">26</span>:                 ? currentTimeMillis</div><div class="line"><span class="number">27</span>:                 : refillTime + newTokens * rateToMsConversion / averageRate;</div><div class="line"><span class="number">28</span>:         <span class="comment">// CAS ä¿è¯æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥å¡«å……</span></div><div class="line"><span class="number">29</span>:         <span class="keyword">if</span> (lastRefillTime.compareAndSet(refillTime, newRefillTime)) &#123;</div><div class="line"><span class="number">30</span>:             <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="comment">// æ­»å¾ªç¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"><span class="number">31</span>:                 <span class="comment">// è®¡ç®— å¡«å……ä»¤ç‰Œåçš„å·²æ¶ˆè€—ä»¤ç‰Œæ•°é‡</span></div><div class="line"><span class="number">32</span>:                 <span class="keyword">int</span> currentLevel = consumedTokens.get();</div><div class="line"><span class="number">33</span>:                 <span class="keyword">int</span> adjustedLevel = Math.min(currentLevel, burstSize); <span class="comment">// In case burstSize decreased</span></div><div class="line"><span class="number">34</span>:                 <span class="keyword">int</span> newLevel = (<span class="keyword">int</span>) Math.max(<span class="number">0</span>, adjustedLevel - newTokens);</div><div class="line"><span class="number">35</span>:                 <span class="comment">// CAS é¿å…å’Œæ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œçš„çº¿ç¨‹å†²çª</span></div><div class="line"><span class="number">36</span>:                 <span class="keyword">if</span> (consumedTokens.compareAndSet(currentLevel, newLevel)) &#123;</div><div class="line"><span class="number">37</span>:                     <span class="keyword">return</span>;</div><div class="line"><span class="number">38</span>:                 &#125;</div><div class="line"><span class="number">39</span>:             &#125;</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 17 è¡Œ ï¼šè·å–æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´( <code>refillTime</code> ) ã€‚æ¯æ¬¡å¡«å……ä»¤ç‰Œï¼Œä¼šè®¾ç½® <code>currentTimeMillis</code> åˆ° <code>refillTime</code> ã€‚</li><li>ç¬¬ 19 è¡Œ ï¼šè·å¾—è·ç¦»æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´å·®( <code>timeDelta</code> )ï¼Œç”¨äºè®¡ç®—éœ€è¦å¡«å……çš„ä»¤ç‰Œæ•°ã€‚</li><li>ç¬¬ 22 è¡Œ ï¼šè®¡ç®—<strong>å¯å¡«å……çš„</strong>æœ€å¤§ä»¤ç‰Œæ•°é‡( <code>newTokens</code> )ã€‚<code>newTokens</code> å¯èƒ½è¶…è¿‡ <code>burstSize</code> ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šæœ‰é€»è¾‘è°ƒæ•´ <code>newTokens</code> ã€‚</li><li>ç¬¬ 25 è‡³ 27 è¡Œ ï¼šè®¡ç®—<strong>æ–°çš„</strong>å¡«å……ä»¤ç‰Œçš„æ—¶é—´ã€‚<strong>ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ <code>currentTimeMillis</code> å‘¢</strong>ï¼Ÿä¾‹å¦‚ï¼Œ<code>averageRate = 500 &amp;&amp; averageRateUnit = SECONDS</code> æ—¶ï¼Œ æ¯ 2 æ¯«ç§’æ‰å¡«å……ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœè®¾ç½® <code>currentTimeMillis</code> ï¼Œ<strong>ä¼šå¯¼è‡´ä¸è¶³ä»¥å¡«å……ä¸€ä¸ªä»¤ç‰Œçš„æ—¶é•¿è¢«åäº†</strong>ã€‚</li><li>ç¬¬ 29 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿è¯æœ‰ä¸”<strong>ä»…æœ‰ä¸€ä¸ª</strong>çº¿ç¨‹è¿›å…¥å¡«å……é€»è¾‘ã€‚</li><li>ç¬¬ 30 è¡Œ ï¼š<strong>æ­»å¾ªç¯ç›´åˆ°æˆåŠŸ</strong>ã€‚</li><li>ç¬¬ 32 è‡³ 34 è¡Œ ï¼šè®¡ç®—<strong>æ–°çš„</strong>å¡«å……ä»¤ç‰Œåçš„<strong>å·²æ¶ˆè€—</strong>çš„ä»¤ç‰Œæ•°é‡ã€‚<ul><li>ç¬¬ 33 è¡Œ ï¼š<code>burstSize</code> å¯èƒ½è°ƒå°ï¼Œä¾‹å¦‚ï¼Œç³»ç»Ÿæ¥å…¥åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œå¯ä»¥è¿œç¨‹è°ƒæ•´è¯¥æ•°å€¼ã€‚å¦‚æœæ­¤æ—¶ <code>burstSize</code> æ›´å°ï¼Œä»¥å®ƒä½œä¸º<strong>å·²æ¶ˆè€—</strong>çš„ä»¤ç‰Œæ•°é‡ã€‚</li></ul></li><li>ç¬¬ 36 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿è¯é¿å…è¦†ç›–è®¾ç½®æ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œçš„çº¿ç¨‹ã€‚</li></ul><h2>2.2 consumeToken</h2><p>ç”¨ <code>#refillToken(...)</code> æ–¹æ³•ï¼Œå¡«å……**æ¶ˆè€—( è·å– )**çš„ä»¤ç‰Œã€‚</p><p>ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">consumeToken</span><span class="params">(<span class="keyword">int</span> burstSize)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="comment">// æ­»å¾ªç¯ï¼Œç›´åˆ°æ²¡æœ‰ä»¤ç‰Œï¼Œæˆ–è€…è·å–ä»¤ç‰ŒæˆåŠŸ</span></div><div class="line"> <span class="number">3</span>:         <span class="comment">// æ²¡æœ‰ä»¤ç‰Œ</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">int</span> currentLevel = consumedTokens.get();</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (currentLevel &gt;= burstSize) &#123;</div><div class="line"> <span class="number">6</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>:         <span class="comment">// CAS é¿å…å’Œæ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œæˆ–è€…å¡«å……ä»¤ç‰Œçš„çº¿ç¨‹å†²çª</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (consumedTokens.compareAndSet(currentLevel, currentLevel + <span class="number">1</span>)) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è¡Œ ï¼š<strong>æ­»å¾ªç¯ç›´åˆ°æ²¡æœ‰ä»¤ç‰Œæˆ–è€…ç«äº‰è·å–ä»¤ç‰ŒæˆåŠŸ</strong>ã€‚</li><li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šæ²¡æœ‰ä»¤ç‰Œã€‚</li><li>ç¬¬ 9 è‡³ 11 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> é¿å…å’Œæ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œæˆ–è€…å¡«å……ä»¤ç‰Œçš„çº¿ç¨‹å†²çªã€‚</li></ul><h1>3. RateLimitingFilter</h1><p><code>com.netflix.eureka.RateLimitingFilter</code> ï¼ŒEureka-Server é™æµè¿‡æ»¤å™¨ã€‚ä½¿ç”¨ RateLimiting ï¼Œä¿è¯ Eureka-Server ç¨³å®šæ€§ã€‚</p><p><code>#doFilter(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾— Target</span></div><div class="line"> <span class="number">4</span>:     Target target = getTarget(request);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// Other Target ï¼Œä¸åšé™æµ</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (target == Target.Other) &#123;</div><div class="line"> <span class="number">8</span>:         chain.doFilter(request, response);</div><div class="line"> <span class="number">9</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     HttpServletRequest httpRequest = (HttpServletRequest) request;</div><div class="line"><span class="number">13</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¢«é™æµ</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">if</span> (isRateLimited(httpRequest, target)) &#123;</div><div class="line"><span class="number">15</span>:         <span class="comment">// TODO[0012]ï¼šç›‘æ§ç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line"><span class="number">16</span>:         incrementStats(target);</div><div class="line"><span class="number">17</span>:         <span class="comment">// å¦‚æœå¼€å¯é™æµï¼Œè¿”å› 503 çŠ¶æ€ç </span></div><div class="line"><span class="number">18</span>:         <span class="keyword">if</span> (serverConfig.isRateLimiterEnabled()) &#123;</div><div class="line"><span class="number">19</span>:             ((HttpServletResponse) response).setStatus(HttpServletResponse.SC_SERVICE_UNAVAILABLE);</div><div class="line"><span class="number">20</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>:     chain.doFilter(request, response);</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šè°ƒç”¨ <code>#getTarget()</code> æ–¹æ³•ï¼Œè·å– Targetã€‚RateLimitingFilter åªå¯¹ç¬¦åˆæ­£åœ¨è¡¨è¾¾å¼ <code>^.*/apps(/[^/]*)?$</code> çš„æ¥å£åšé™æµï¼Œå…¶ä¸­ä¸åŒ…å« Eureka-Server é›†ç¾¤æ‰¹é‡åŒæ­¥æ¥å£ã€‚</p><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/RateLimitingFilter.java#L98" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ Target æšä¸¾ç±»ä»£ç ã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/RateLimitingFilter.java#L150" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#getTarget(...)</code> æ–¹æ³•ä»£ç ã€‚</li></ul></li><li><p>ç¬¬ 14 è¡Œ ï¼šè°ƒç”¨ <code>#isRateLimited(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¢«é™æµã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRateLimited</span><span class="params">(HttpServletRequest request, Target target)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦ç‰¹æƒåº”ç”¨</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (isPrivileged(request)) &#123;</div><div class="line"> <span class="number">4</span>:         logger.debug(<span class="string">"Privileged &#123;&#125; request"</span>, target);</div><div class="line"> <span class="number">5</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¢«è¶…è½½( é™æµ )</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (isOverloaded(target)) &#123;</div><div class="line"> <span class="number">9</span>:         logger.debug(<span class="string">"Overloaded &#123;&#125; request; discarding it"</span>, target);</div><div class="line"><span class="number">10</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>:     logger.debug(<span class="string">"&#123;&#125; request admitted"</span>, target);</div><div class="line"><span class="number">13</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šè°ƒç”¨ <code>#isPrivileged()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒåº”ç”¨ï¼Œå¯¹ç‰¹æƒåº”ç”¨ä¸å¼€å¯é™æµé€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPrivileged</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">    <span class="comment">// æ˜¯å¦å¯¹æ ‡å‡†å®¢æˆ·ç«¯å¼€å¯é™æµ</span></div><div class="line">    <span class="keyword">if</span> (serverConfig.isRateLimiterThrottleStandardClients()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ä»¥è¯·æ±‚å¤´( "DiscoveryIdentity-Name" ) åˆ¤æ–­æ˜¯å¦åœ¨æ ‡å‡†å®¢æˆ·ç«¯åé›†åˆå†…</span></div><div class="line">    Set&lt;String&gt; privilegedClients = serverConfig.getRateLimiterPrivilegedClients();</div><div class="line">    String clientName = request.getHeader(AbstractEurekaIdentity.AUTH_NAME_HEADER_KEY);</div><div class="line">    <span class="keyword">return</span> privilegedClients.contains(clientName) || DEFAULT_PRIVILEGED_CLIENTS.contains(clientName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šè°ƒç”¨ <code>#isOverloaded(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è½½( é™æµ )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Includes both full and delta fetches.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RateLimiter registryFetchRateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.SECONDS);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Only full registry fetches.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RateLimiter registryFullFetchRateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.SECONDS);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isOverloaded</span><span class="params">(Target target)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> maxInWindow = serverConfig.getRateLimiterBurstSize(); <span class="comment">// 10</span></div><div class="line">    <span class="keyword">int</span> fetchWindowSize = serverConfig.getRateLimiterRegistryFetchAverageRate(); <span class="comment">// 500</span></div><div class="line">    <span class="keyword">boolean</span> overloaded = !registryFetchRateLimiter.acquire(maxInWindow, fetchWindowSize);</div><div class="line">    <span class="keyword">if</span> (target == Target.FullFetch) &#123;</div><div class="line">        <span class="keyword">int</span> fullFetchWindowSize = serverConfig.getRateLimiterFullFetchAverageRate(); <span class="comment">// 100</span></div><div class="line">            overloaded |= !registryFullFetchRateLimiter.acquire(maxInWindow, fullFetchWindowSize);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> overloaded;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šè‹¥ <code>eureka.rateLimiter.enabled = true</code>( é»˜è®¤å€¼ ï¼š<code>false</code> ï¼Œå¯é… )ï¼Œè¿”å› 503 çŠ¶æ€ç ã€‚</p></li></ul><h1>4. InstanceInfoReplicator</h1><p><code>com.netflix.discovery.InstanceInfoReplicator</code> ï¼ŒEureka-Client åº”ç”¨å®ä¾‹å¤åˆ¶å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><p>åº”ç”¨å®ä¾‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨ <code>#onDemandUpdate()</code> æ–¹æ³•ï¼Œå‘ Eureka-Server å‘èµ·æ³¨å†Œï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚InstanceInfoReplicator ä½¿ç”¨ RateLimiter ï¼Œé¿å…çŠ¶æ€<strong>é¢‘ç¹</strong>å‘ç”Ÿå˜åŒ–ï¼Œå‘ Eureka-Server <strong>é¢‘ç¹</strong>åŒæ­¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * RateLimiter</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»¤ç‰Œæ¡¶ä¸Šé™ï¼Œé»˜è®¤ï¼š2</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> burstSize;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»¤ç‰Œå†è£…å¹³å‡é€Ÿç‡ï¼Œé»˜è®¤ï¼š60 * 2 / 30 = 4</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> allowedRatePerMinute;</div><div class="line">    </div><div class="line">    InstanceInfoReplicator(DiscoveryClient discoveryClient, InstanceInfo instanceInfo, <span class="keyword">int</span> replicationIntervalSeconds, <span class="keyword">int</span> burstSize) &#123;</div><div class="line">        <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">        </div><div class="line">        <span class="keyword">this</span>.rateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.MINUTES);</div><div class="line">        <span class="keyword">this</span>.replicationIntervalSeconds = replicationIntervalSeconds;</div><div class="line">        <span class="keyword">this</span>.burstSize = burstSize;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.allowedRatePerMinute = <span class="number">60</span> * <span class="keyword">this</span>.burstSize / <span class="keyword">this</span>.replicationIntervalSeconds;</div><div class="line">        logger.info(<span class="string">"InstanceInfoReplicator onDemand update allowed rate per min is &#123;&#125;"</span>, allowedRatePerMinute);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDemandUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (rateLimiter.acquire(burstSize, allowedRatePerMinute)) &#123; <span class="comment">// é™æµ</span></div><div class="line">            scheduler.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    logger.debug(<span class="string">"Executing on-demand update of local InstanceInfo"</span>);</div><div class="line">                    <span class="comment">// å–æ¶ˆä»»åŠ¡</span></div><div class="line">                    Future latestPeriodic = scheduledPeriodicRef.get();</div><div class="line">                    <span class="keyword">if</span> (latestPeriodic != <span class="keyword">null</span> &amp;&amp; !latestPeriodic.isDone()) &#123;</div><div class="line">                        logger.debug(<span class="string">"Canceling the latest scheduled update, it will be rescheduled at the end of on demand update"</span>);</div><div class="line">                        latestPeriodic.cancel(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// å†æ¬¡è°ƒç”¨</span></div><div class="line">                    InstanceInfoReplicator.<span class="keyword">this</span>.run();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.warn(<span class="string">"Ignoring onDemand update due to rate limiter"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <code>#onDemandUpdate()</code> æ–¹æ³•ï¼Œè°ƒç”¨ <code>RateLimiter#acquire(...)</code> æ–¹æ³•ï¼Œè·å–ä»¤ç‰Œã€‚<ul><li>è‹¥è·å–æˆåŠŸï¼Œå‘ Eureka-Server å‘èµ·æ³¨å†Œï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li><li>è‹¥è·å–å¤±è´¥ï¼Œ<strong>ä¸</strong>å‘ Eureka-Server å‘èµ·æ³¨å†Œï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚<strong>è¿™æ ·ä¼šä¸ä¼šæœ‰é—®é¢˜</strong>ï¼Ÿç­”æ¡ˆæ˜¯<strong>ä¸ä¼š</strong>ã€‚<ul><li>InstanceInfoReplicator ä¼š<strong>å›ºå®šå‘¨æœŸ</strong>æ£€æŸ¥æœ¬åœ°åº”ç”¨å®ä¾‹æ˜¯å¦æœ‰æ²¡å‘ Eureka-Server ï¼Œè‹¥æœªåŒæ­¥ï¼Œåˆ™å‘èµ·åŒæ­¥ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>Eureka-Client å‘ Eureka-Server å¿ƒè·³æ—¶ï¼ŒEureka-Server ä¼šå¯¹æ¯”åº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> ï¼Œè‹¥ Eureka-Client çš„æ›´å¤§ï¼Œåˆ™ Eureka-Server è¿”å› 404 çŠ¶æ€ç ã€‚Eureka-Client æ¥æ”¶åˆ° 404 çŠ¶æ€ç åï¼Œå‘èµ·æ³¨å†ŒåŒæ­¥ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹ã€Œ2.2 HeartbeatThreadã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul></li></ul><h1>666. å½©è›‹</h1><p>åé¢æ‰¾æ—¶é—´ç ”ç©¶ä¸‹ Google Guava RateLimiter çš„æºç å®ç°ï¼Œä»åŠŸèƒ½ä¸Šæ›´åŠ å¼ºå¤§ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥ç…ç…å‘€ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/rate-limiter/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a hr
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥</title>
    <link href="http://www.iocoder.cn/Eureka/server-cluster/"/>
    <id>http://www.iocoder.cn/Eureka/server-cluster/</id>
    <published>2018-08-06T16:00:00.000Z</published>
    <updated>2017-10-19T05:48:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/server-cluster/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</a><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.3 é›†ç¾¤èŠ‚ç‚¹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4. åŒæ­¥æ³¨å†Œä¿¡æ¯</a><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.1 åŒæ­¥æ“ä½œç±»å‹</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</a></li></ul></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server é›†ç¾¤åŒæ­¥æ³¨å†Œä¿¡æ¯</strong>ã€‚</p><p>Eureka-Server é›†ç¾¤å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/01.png" alt=""></p><ul><li>Eureka-Server é›†ç¾¤ä¸åŒºåˆ†<strong>ä¸»ä»èŠ‚ç‚¹</strong>æˆ–è€… <strong>Primary &amp; Secondary èŠ‚ç‚¹</strong>ï¼Œæ‰€æœ‰èŠ‚ç‚¹<strong>ç›¸åŒè§’è‰²( ä¹Ÿå°±æ˜¯æ²¡æœ‰è§’è‰² )ï¼Œå®Œå…¨å¯¹ç­‰</strong>ã€‚</li><li>Eureka-Client å¯ä»¥å‘<strong>ä»»æ„</strong> Eureka-Client å‘èµ·ä»»æ„<strong>è¯»å†™</strong>æ“ä½œï¼ŒEureka-Server å°†æ“ä½œå¤åˆ¶åˆ°å¦å¤–çš„ Eureka-Server ä»¥è¾¾åˆ°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚æ³¨æ„ï¼ŒEureka-Server æ˜¯é€‰æ‹©äº† AP çš„ç»„ä»¶ã€‚</li></ul><p>Eureka-Server å¯ä»¥ä½¿ç”¨ç›´æ¥é…ç½®æ‰€æœ‰èŠ‚ç‚¹çš„æœåŠ¡åœ°å€ï¼Œæˆ–è€…åŸºäº DNS é…ç½®ã€‚æ¨èé˜…è¯»ï¼š<a href="http://blog.didispace.com/springcloud6/?from=http://www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudæ„å»ºå¾®æœåŠ¡æ¶æ„ï¼ˆå…­ï¼‰é«˜å¯ç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‹</a> ã€‚</p><p>æœ¬æ–‡ä¸»è¦ç±»åœ¨ <code>com.netflix.eureka.cluster</code> åŒ…ä¸‹ã€‚</p><p>OKï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„é¨æ¸¸åœ¨ä»£ç çš„æµ·æ´‹ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><p>ps ï¼š<strong>æ³¨æ„</strong>ï¼Œæœ¬æ–‡æåˆ°çš„<strong>åŒæ­¥</strong>ï¼Œå‡†ç¡®æ¥è¯´æ˜¯<strong>å¤åˆ¶( Replication )</strong>ã€‚</p><h1>2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</h1><p><code>com.netflix.eureka.cluster.PeerEurekaNodes</code> ï¼ŒEureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeerEurekaNodes</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(PeerEurekaNodes.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹æ³¨å†Œè¡¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaServerConfig serverConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Client é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaClientConfig clientConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server ç¼–è§£ç </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ServerCodecs serverCodecs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯ç®¡ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é›†ç¾¤èŠ‚ç‚¹æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;PeerEurekaNode&gt; peerEurekaNodes = Collections.emptyList();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server æœåŠ¡åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Set&lt;String&gt; peerEurekaNodeUrls = Collections.emptySet();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ScheduledExecutorService taskExecutor;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PeerEurekaNodes</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">            PeerAwareInstanceRegistry registry,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaServerConfig serverConfig,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">            ServerCodecs serverCodecs,</span></span></div><div class="line"><span class="function"><span class="params">            ApplicationInfoManager applicationInfoManager)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.registry = registry;</div><div class="line">        <span class="keyword">this</span>.serverConfig = serverConfig;</div><div class="line">        <span class="keyword">this</span>.clientConfig = clientConfig;</div><div class="line">        <span class="keyword">this</span>.serverCodecs = serverCodecs;</div><div class="line">        <span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>peerEurekaNodes</code>, <code>peerEurekaNodeUrls</code>, <code>taskExecutor</code> å±æ€§ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­<strong>æœªè®¾ç½®å’Œåˆå§‹åŒ–</strong>ï¼Œè€Œæ˜¯åœ¨ <code>PeerEurekaNodes#start()</code> æ–¹æ³•ï¼Œè®¾ç½®å’Œåˆå§‹åŒ–ï¼Œä¸‹æ–‡æˆ‘ä»¬ä¼šè§£æè¿™ä¸ªæ–¹æ³•ã€‚</li><li>Eureka-Server åœ¨åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>EurekaBootStrap#getPeerEurekaNodes(...)</code> æ–¹æ³•ï¼Œåˆ›å»º PeerEurekaNodes ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/EurekaBootStrap.java#L245" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ã€‚</li></ul><h2>2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</h2><p>è°ƒç”¨ <code>PeerEurekaNodes#start()</code> æ–¹æ³•ï¼Œé›†ç¾¤èŠ‚ç‚¹å¯åŠ¨ï¼Œä¸»è¦å®Œæˆä¸¤ä¸ªé€»è¾‘ï¼š</p><ul><li>åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</li><li>åˆå§‹åŒ–å›ºå®šå‘¨æœŸ( é»˜è®¤ï¼š10 åˆ†é’Ÿï¼Œå¯é…ç½® )æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯çš„ä»»åŠ¡</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»º å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"> <span class="number">3</span>:     taskExecutor = Executors.newSingleThreadScheduledExecutor(</div><div class="line"> <span class="number">4</span>:             <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line"> <span class="number">5</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:                 <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:                     Thread thread = <span class="keyword">new</span> Thread(r, <span class="string">"Eureka-PeerNodesUpdater"</span>);</div><div class="line"> <span class="number">8</span>:                     thread.setDaemon(<span class="keyword">true</span>);</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> thread;</div><div class="line"><span class="number">10</span>:                 &#125;</div><div class="line"><span class="number">11</span>:             &#125;</div><div class="line"><span class="number">12</span>:     );</div><div class="line"><span class="number">13</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>:         <span class="comment">// åˆå§‹åŒ– é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line"><span class="number">15</span>:         updatePeerEurekaNodes(resolvePeerUrls());</div><div class="line"><span class="number">16</span>:         <span class="comment">// åˆå§‹åŒ– åˆå§‹åŒ–å›ºå®šå‘¨æœŸæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯çš„ä»»åŠ¡</span></div><div class="line"><span class="number">17</span>:         Runnable peersUpdateTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">18</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">19</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">20</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:                     updatePeerEurekaNodes(resolvePeerUrls());</div><div class="line"><span class="number">22</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:                     logger.error(<span class="string">"Cannot update the replica Nodes"</span>, e);</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:         &#125;;</div><div class="line"><span class="number">28</span>:         taskExecutor.scheduleWithFixedDelay(</div><div class="line"><span class="number">29</span>:                 peersUpdateTask,</div><div class="line"><span class="number">30</span>:                 serverConfig.getPeerEurekaNodesUpdateIntervalMs(),</div><div class="line"><span class="number">31</span>:                 serverConfig.getPeerEurekaNodesUpdateIntervalMs(),</div><div class="line"><span class="number">32</span>:                 TimeUnit.MILLISECONDS</div><div class="line"><span class="number">33</span>:         );</div><div class="line"><span class="number">34</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">35</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>:     <span class="comment">// æ‰“å° é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">for</span> (PeerEurekaNode node : peerEurekaNodes) &#123;</div><div class="line"><span class="number">39</span>:         logger.info(<span class="string">"Replica node URL:  "</span> + node.getServiceUrl());</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 15 è¡Œ &amp;&amp; ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#updatePeerEurekaNodes()</code> æ–¹æ³•ï¼Œæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ã€‚</li></ul><h2>2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>#resolvePeerUrls()</code> æ–¹æ³•ï¼Œè·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">resolvePeerUrls</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„</span></div><div class="line"> <span class="number">3</span>:     InstanceInfo myInfo = applicationInfoManager.getInfo();</div><div class="line"> <span class="number">4</span>:     String zone = InstanceInfo.getZone(clientConfig.getAvailabilityZones(clientConfig.getRegion()), myInfo);</div><div class="line"> <span class="number">5</span>:     List&lt;String&gt; replicaUrls = EndpointUtils.getDiscoveryServiceUrls(clientConfig, zone, <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(myInfo));</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// ç§»é™¤è‡ªå·±ï¼ˆé¿å…å‘è‡ªå·±åŒæ­¥ï¼‰</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">while</span> (idx &lt; replicaUrls.size()) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (isThisMyUrl(replicaUrls.get(idx))) &#123;</div><div class="line"><span class="number">11</span>:             replicaUrls.remove(idx);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:             idx++;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>:     <span class="keyword">return</span> replicaUrls;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šè·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„ã€‚<code>EndpointUtils#getDiscoveryServiceUrls(...)</code> æ–¹æ³•ï¼Œé€»è¾‘ä¸ <a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/?self">ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹ã€Œ3.4 ConfigClusterResolverã€</a> åŸºæœ¬ç±»ä¼¼ã€‚EndpointUtils æ­£åœ¨é€æ­¥ï¼ŒçŒœæµ‹æœªæ¥è¿™é‡Œä¼šæ›¿æ¢ã€‚</li><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šç§»é™¤è‡ªèº«èŠ‚ç‚¹ï¼Œé¿å…å‘è‡ªå·±åŒæ­¥ã€‚</li></ul><hr><p>è°ƒç”¨ <code>#updatePeerEurekaNodes()</code> æ–¹æ³•ï¼Œæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸»è¦å®Œæˆä¸¤éƒ¨åˆ†é€»è¾‘ï¼š</p><ul><li>æ·»åŠ æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹</li><li>å…³é—­åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updatePeerEurekaNodes</span><span class="params">(List&lt;String&gt; newPeerUrls)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (newPeerUrls.isEmpty()) &#123;</div><div class="line"> <span class="number">3</span>:         logger.warn(<span class="string">"The replica size seems to be empty. Check the route 53 DNS Registry"</span>);</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// è®¡ç®— æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></div><div class="line"> <span class="number">8</span>:     Set&lt;String&gt; toShutdown = <span class="keyword">new</span> HashSet&lt;&gt;(peerEurekaNodeUrls);</div><div class="line"> <span class="number">9</span>:     toShutdown.removeAll(newPeerUrls);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// è®¡ç®— åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></div><div class="line"><span class="number">12</span>:     Set&lt;String&gt; toAdd = <span class="keyword">new</span> HashSet&lt;&gt;(newPeerUrls);</div><div class="line"><span class="number">13</span>:     toAdd.removeAll(peerEurekaNodeUrls);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (toShutdown.isEmpty() &amp;&amp; toAdd.isEmpty()) &#123; <span class="comment">// No change</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// å…³é—­åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// Remove peers no long available</span></div><div class="line"><span class="number">21</span>:     List&lt;PeerEurekaNode&gt; newNodeList = <span class="keyword">new</span> ArrayList&lt;&gt;(peerEurekaNodes);</div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (!toShutdown.isEmpty()) &#123;</div><div class="line"><span class="number">23</span>:         logger.info(<span class="string">"Removing no longer available peer nodes &#123;&#125;"</span>, toShutdown);</div><div class="line"><span class="number">24</span>:         <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="number">25</span>:         <span class="keyword">while</span> (i &lt; newNodeList.size()) &#123;</div><div class="line"><span class="number">26</span>:             PeerEurekaNode eurekaNode = newNodeList.get(i);</div><div class="line"><span class="number">27</span>:             <span class="keyword">if</span> (toShutdown.contains(eurekaNode.getServiceUrl())) &#123;</div><div class="line"><span class="number">28</span>:                 newNodeList.remove(i);</div><div class="line"><span class="number">29</span>:                 eurekaNode.shutDown(); <span class="comment">// å…³é—­</span></div><div class="line"><span class="number">30</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                 i++;</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="comment">// æ·»åŠ æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹</span></div><div class="line"><span class="number">37</span>:     <span class="comment">// Add new peers</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (!toAdd.isEmpty()) &#123;</div><div class="line"><span class="number">39</span>:         logger.info(<span class="string">"Adding new peer nodes &#123;&#125;"</span>, toAdd);</div><div class="line"><span class="number">40</span>:         <span class="keyword">for</span> (String peerUrl : toAdd) &#123;</div><div class="line"><span class="number">41</span>:             newNodeList.add(createPeerEurekaNode(peerUrl));</div><div class="line"><span class="number">42</span>:         &#125;</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// èµ‹å€¼</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">this</span>.peerEurekaNodes = newNodeList;</div><div class="line"><span class="number">47</span>:     <span class="keyword">this</span>.peerEurekaNodeUrls = <span class="keyword">new</span> HashSet&lt;&gt;(newPeerUrls);</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 7 è‡³ 9 è¡Œ ï¼š<strong>è®¡ç®—</strong>æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€ã€‚</p></li><li><p>ç¬¬ 11 è‡³ 13 è¡Œ ï¼š<strong>è®¡ç®—</strong>åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 34 è¡Œ ï¼š<strong>å…³é—­</strong>åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹ã€‚</p></li><li><p>ç¬¬ 36 è‡³ 43 è¡Œ ï¼š<strong>æ·»åŠ </strong>æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹ã€‚è°ƒç”¨ <code>#createPeerEurekaNode(peerUrl)</code> æ–¹æ³•ï¼Œåˆ›å»ºé›†ç¾¤èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">protected</span> PeerEurekaNode <span class="title">createPeerEurekaNode</span><span class="params">(String peerEurekaNodeUrl)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     HttpReplicationClient replicationClient = JerseyReplicationClient.createReplicationClient(serverConfig, serverCodecs, peerEurekaNodeUrl);</div><div class="line"><span class="number">3</span>:     String targetHost = hostFromUrl(peerEurekaNodeUrl);</div><div class="line"><span class="number">4</span>:     <span class="keyword">if</span> (targetHost == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">5</span>:         targetHost = <span class="string">"host"</span>;</div><div class="line"><span class="number">6</span>:     &#125;</div><div class="line"><span class="number">7</span>:     <span class="keyword">return</span> <span class="keyword">new</span> PeerEurekaNode(registry, targetHost, peerEurekaNodeUrl, replicationClient, serverConfig);</div><div class="line"><span class="number">8</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è¡Œ ï¼šåˆ›å»º Eureka-Server é›†ç¾¤é€šä¿¡å®¢æˆ·ç«¯ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/transport/?self">ã€ŠEureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡ã€‹ã€Œ4.2 JerseyReplicationClientã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 7 è¡Œ ï¼šåˆ›å»º PeerEurekaNode ï¼Œåœ¨ <a href="#">ã€Œ2.3 PeerEurekaNodeã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>2.3 é›†ç¾¤èŠ‚ç‚¹</h2><p><code>com.netflix.eureka.cluster.PeerEurekaNode</code> ï¼Œå•ä¸ªé›†ç¾¤èŠ‚ç‚¹ã€‚</p><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/fcc9027a197783a23e7cb72ad0f617b7dc63d221/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L111" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹<strong>æ„é€ æ–¹æ³•</strong></p><ul><li>ç¬¬ 129 è¡Œ ï¼šåˆ›å»º ReplicationTaskProcessor ã€‚åœ¨ <a href="#">ã€Œ4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨ã€</a> è¯¦ç»†è§£æ</li><li>ç¬¬ 131 è‡³ 140 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡ä»»åŠ¡</strong>åˆ†å‘å™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 142 è‡³ 151 è¡Œ ï¼šåˆ›å»º<strong>å•ä»»åŠ¡</strong>åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( <code>Autoscaling Group</code> ) åŒæ­¥çŠ¶æ€ã€‚æš‚æ—¶è·³è¿‡ã€‚</li></ul><h1>3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</h1><p>Eureka-Server å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#syncUp()</code> æ–¹æ³•ï¼Œä»é›†ç¾¤çš„ä¸€ä¸ª Eureka-Server èŠ‚ç‚¹è·å–<strong>åˆå§‹</strong>æ³¨å†Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">syncUp</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// Copy entire entry from neighboring DS node</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ((i &lt; serverConfig.getRegistrySyncRetries()) &amp;&amp; (count == <span class="number">0</span>)); i++) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æœªè¯»å–åˆ°æ³¨å†Œä¿¡æ¯ï¼Œsleep ç­‰å¾…</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">10</span>:                 Thread.sleep(serverConfig.getRegistrySyncRetryWaitMs());</div><div class="line"><span class="number">11</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Interrupted during registry transfer.."</span>);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:         <span class="comment">// è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="number">18</span>:         Applications apps = eurekaClient.getApplications();</div><div class="line"><span class="number">19</span>:         <span class="keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (isRegisterable(instance)) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ³¨å†Œ</span></div><div class="line"><span class="number">23</span>:                         register(instance, instance.getLeaseInfo().getDurationInSecs(), <span class="keyword">true</span>); <span class="comment">// æ³¨å†Œ</span></div><div class="line"><span class="number">24</span>:                         count++;</div><div class="line"><span class="number">25</span>:                     &#125;</div><div class="line"><span class="number">26</span>:                 &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">27</span>:                     logger.error(<span class="string">"During DS init copy"</span>, t);</div><div class="line"><span class="number">28</span>:                 &#125;</div><div class="line"><span class="number">29</span>:             &#125;</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>:     <span class="keyword">return</span> count;</div><div class="line"><span class="number">33</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šæœªè·å–åˆ°æ³¨å†Œä¿¡æ¯ï¼Œ<code>sleep</code> ç­‰å¾…å†æ¬¡é‡è¯•ã€‚</li><li>ç¬¬ 17 è‡³ 30 è¡Œ ï¼šè·å–æ³¨å†Œä¿¡æ¯ï¼Œè‹¥è·å–åˆ°ï¼Œæ³¨å†Œåˆ°è‡ªèº«èŠ‚ç‚¹ã€‚<ul><li>ç¬¬ 22 è¡Œ ï¼šåˆ¤æ–­åº”ç”¨å®ä¾‹æ˜¯å¦èƒ½å¤Ÿæ³¨å†Œåˆ°è‡ªèº«èŠ‚ç‚¹ã€‚ä¸»è¦ç”¨äºäºšé©¬é€Š AWS ç¯å¢ƒä¸‹çš„åˆ¤æ–­ï¼Œè‹¥ééƒ¨ç½²åœ¨äºšé©¬é€Šé‡Œï¼Œéƒ½è¿”å› <code>true</code> ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/registry/PeerAwareInstanceRegistryImpl.java#L593" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#register()</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹åˆ°è‡ªèº«èŠ‚ç‚¹ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><hr><p>è‹¥è°ƒç”¨ <code>#syncUp()</code> æ–¹æ³•ï¼Œæœªè·å–åˆ°åº”ç”¨å®ä¾‹ï¼Œåˆ™ Eureka-Server ä¼šæœ‰ä¸€æ®µæ—¶é—´( é»˜è®¤ï¼š5 åˆ†é’Ÿï¼Œå¯é… )ä¸å…è®¸è¢« Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œé¿å…å½±å“ Eureka-Client ã€‚</p><ul><li><p>æ ‡è®° Eureka-Server å¯åŠ¨æ—¶ï¼Œæœªè·å–åˆ°åº”ç”¨å®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> peerInstancesTransferEmptyOnStartup = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.peerInstancesTransferEmptyOnStartup = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>åˆ¤æ–­ Eureka-Server æ˜¯å¦å…è®¸è¢« Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldAllowAccess</span><span class="params">(<span class="keyword">boolean</span> remoteRegionRequired)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.peerInstancesTransferEmptyOnStartup) &#123;</div><div class="line">       <span class="comment">// è®¾ç½®å¯åŠ¨æ—¶é—´</span></div><div class="line">       <span class="keyword">this</span>.startupTime = System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (!(System.currentTimeMillis() &gt; <span class="keyword">this</span>.startupTime + serverConfig.getWaitTimeInMsWhenSyncEmpty())) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>4. åŒæ­¥æ³¨å†Œä¿¡æ¯</h1><p>Eureka-Server é›†ç¾¤åŒæ­¥æ³¨å†Œä¿¡æ¯å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/02.png" alt=""></p><ul><li>Eureka-Server æ¥æ”¶åˆ° Eureka-Client çš„ Registerã€Heartbeatã€Cancelã€StatusUpdateã€DeleteStatusOverride æ“ä½œï¼Œå›ºå®šé—´éš”( é»˜è®¤å€¼ ï¼š500 æ¯«ç§’ï¼Œå¯é… )å‘ Eureka-Server é›†ç¾¤å†…å…¶ä»–èŠ‚ç‚¹åŒæ­¥( <strong>å‡†å®æ—¶ï¼Œéå®æ—¶</strong> )ã€‚</li></ul><h2>4.1 åŒæ­¥æ“ä½œç±»å‹</h2><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl.Action</code> ï¼ŒåŒæ­¥æ“ä½œç±»å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Action &#123;</div><div class="line">   Heartbeat, Register, Cancel, StatusUpdate, DeleteStatusOverride;</div><div class="line"></div><div class="line">   <span class="comment">// ... çœç•¥ç›‘æ§ç›¸å…³å±æ€§</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Register ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>Heartbeat ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>Cancel ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸‰ï¼‰ä¹‹ä¸‹çº¿ã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>StatusUpdate ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>DeleteStatusOverride ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æ</li></ul><h2>4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</h2><p>Eureka-Server åœ¨å®Œæˆ Eureka-Client å‘èµ·çš„ä¸Šè¿°æ“ä½œåœ¨<strong>è‡ªèº«èŠ‚ç‚¹çš„æ‰§è¡Œå</strong>ï¼Œå‘é›†ç¾¤å†…å…¶ä»– Eureka-Server å‘èµ·åŒæ­¥æ“ä½œã€‚ä»¥ Register æ“ä½œä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´</span></div><div class="line">   <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</div><div class="line">   <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</div><div class="line">       leaseDuration = info.getLeaseInfo().getDurationInSecs();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">   <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</div><div class="line">   <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">   replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æœ€åä¸€è¡Œï¼Œè°ƒç”¨ <code>#replicateToPeers(...)</code> æ–¹æ³•ï¼Œä¼ é€’<strong>å¯¹åº”çš„åŒæ­¥æ“ä½œç±»å‹</strong>ï¼Œå‘èµ·åŒæ­¥æ“ä½œã€‚</li></ul><hr><p><code>#replicateToPeers(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">2</span>:                               InstanceInfo info <span class="comment">/* optional */</span>,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                               InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     Stopwatch tracer = action.getTimer().start();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (isReplication) &#123;</div><div class="line"> <span class="number">7</span>:             numberOfReplicationsLastMin.increment();</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:         <span class="comment">// Eureka-Server å‘èµ·çš„è¯·æ±‚ æˆ–è€… é›†ç¾¤ä¸ºç©º</span></div><div class="line"><span class="number">11</span>:         <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</div><div class="line"><span class="number">17</span>:             <span class="comment">// If the url represents this host, do not replicate to yourself.</span></div><div class="line"><span class="number">18</span>:             <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:             replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">24</span>:         tracer.stop();</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 10 è‡³ 14 è¡Œ ï¼šEureka-Server åœ¨å¤„ç†ä¸Šè¿°æ“ä½œ( Action )ï¼Œæ— è®ºæ¥è‡ª Eureka-Client å‘èµ·è¯·æ±‚ï¼Œè¿˜æ˜¯ Eureka-Server å‘èµ·åŒæ­¥ï¼Œè°ƒç”¨çš„å†…éƒ¨æ–¹æ³•ç›¸åŒï¼Œé€šè¿‡ <code>isReplication=true</code> å‚æ•°ï¼Œé¿å…æ­»å¾ªç¯åŒæ­¥ã€‚</li><li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼š<strong>å¾ªç¯</strong>é›†ç¾¤å†…<strong>æ¯ä¸ª</strong>èŠ‚ç‚¹ï¼Œè°ƒç”¨ <code>#replicateInstanceActionsToPeers(...)</code> æ–¹æ³•ï¼Œå‘èµ·åŒæ­¥æ“ä½œã€‚</li></ul><hr><p><code>#replicateInstanceActionsToPeers(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateInstanceActionsToPeers</span><span class="params">(Action action, String appName,</span></span></div><div class="line"><span class="function"><span class="params">                                            String id, InstanceInfo info, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                                            PeerEurekaNode node)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       InstanceInfo infoFromRegistry;</div><div class="line">       CurrentRequestVersion.set(Version.V2);</div><div class="line">       <span class="keyword">switch</span> (action) &#123;</div><div class="line">           <span class="keyword">case</span> Cancel:</div><div class="line">               node.cancel(appName, id);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Heartbeat:</div><div class="line">               InstanceStatus overriddenStatus = overriddenInstanceStatusMap.get(id);</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.heartbeat(appName, id, infoFromRegistry, overriddenStatus, <span class="keyword">false</span>);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Register:</div><div class="line">               node.register(info);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> StatusUpdate:</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.statusUpdate(appName, id, newStatus, infoFromRegistry);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> DeleteStatusOverride:</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.deleteStatusOverride(appName, id, infoFromRegistry);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot replicate information to &#123;&#125; for action &#123;&#125;"</span>, node.getServiceUrl(), action.name(), t);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><strong>Cancel</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#cancel(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L157" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>Heartbeat</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#heartbeat(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L194" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>Register</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#register(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L134" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>StatusUpdate</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#statusUpdate(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L243" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>DeleteStatusOverride</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#deleteStatusOverride(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L294" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p>ä¸Šé¢çš„æ¯ä¸ªæ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬<strong>éƒ½</strong>ä¼šçœ‹åˆ°ç±»ä¼¼è¿™ä¹ˆä¸€æ®µä»£ç  ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">batchingDispatcher.process(</div><div class="line">    taskId(<span class="string">"$&#123;action&#125;"</span>, appName, id), <span class="comment">// id</span></div><div class="line">    <span class="keyword">new</span> InstanceReplicationTask(targetHost, Action.Cancel, appName, id) &#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> replicationClient.doString(...);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">// do Something...</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;, <span class="comment">// ReplicationTask å­ç±»</span></div><div class="line">    expiryTime</div><div class="line">)</div></pre></td></tr></table></figure></p><ul><li><p><code>#task(...)</code> æ–¹æ³•ï¼Œç”ŸæˆåŒæ­¥æ“ä½œä»»åŠ¡<strong>ç¼–å·</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">taskId</span><span class="params">(String requestType, String appName, String id)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> requestType + <span class="string">'#'</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>ç›¸åŒåº”ç”¨å®ä¾‹çš„ç›¸åŒåŒæ­¥æ“ä½œä½¿ç”¨ç›¸åŒä»»åŠ¡ç¼–å·</strong>ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ2. æ•´ä½“æµç¨‹ã€</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°&quot; æ¥æ”¶çº¿ç¨‹( Runner )åˆå¹¶ä»»åŠ¡ï¼Œå°†ç›¸åŒä»»åŠ¡ç¼–å·çš„ä»»åŠ¡åˆå¹¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚ &quot;ï¼Œå› æ­¤ï¼Œç›¸åŒåº”ç”¨å®ä¾‹çš„ç›¸åŒåŒæ­¥æ“ä½œå°±èƒ½è¢«åˆå¹¶ï¼Œå‡å°‘æ“ä½œé‡ã€‚ä¾‹å¦‚ï¼ŒEureka-Server åŒæ­¥æŸä¸ªåº”ç”¨å®ä¾‹çš„ Heartbeat æ“ä½œï¼Œæ¥æ”¶åŒæ­¥çš„ Eureak-Server æŒ‚äº†ï¼Œä¸€æ–¹é¢è¿™ä¸ªåº”ç”¨çš„è¿™æ¬¡æ“ä½œä¼š<strong>é‡è¯•</strong>ï¼Œå¦ä¸€æ–¹é¢ï¼Œè¿™ä¸ªåº”ç”¨å®ä¾‹ä¼šå‘èµ·<strong>æ–°çš„</strong> Heartbeat æ“ä½œï¼Œé€šè¿‡ä»»åŠ¡ç¼–å·åˆå¹¶ï¼Œæ¥æ”¶åŒæ­¥çš„ Eureka-Server æ¢å¤åï¼Œå‡å°‘æ”¶åˆ°<strong>é‡å¤ç§¯å‹</strong>çš„ä»»åŠ¡ã€‚</li></ul></li><li><p>InstanceReplicationTask ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡ï¼Œåœ¨ <a href="#">ã€Œ4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡ã€</a> è¯¦ç»†è§£æã€‚</p></li><li><p><code>expiryTime</code> ï¼Œä»»åŠ¡è¿‡æœŸæ—¶é—´ã€‚</p></li></ul></li></ul><h3>4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡</h3><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/03.png" alt=""></p><ul><li><code>com.netflix.eureka.cluster.ReplicationTask</code> ï¼ŒåŒæ­¥ä»»åŠ¡<strong>æŠ½è±¡ç±»</strong><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTask.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ ReplicationTask ä»£ç ã€‚</li><li>å®šä¹‰äº† <code>#getTaskName()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ã€‚</li><li>å®šä¹‰äº† <code>#execute()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€‚</li><li>å®ç°äº† <code>#handleSuccess()</code> æ–¹æ³•ï¼Œå¤„ç†æˆåŠŸæ‰§è¡ŒåŒæ­¥ç»“æœã€‚</li><li>å®ç°äº† <code>#handleFailure(...)</code> æ–¹æ³•ï¼Œå¤„ç†å¤±è´¥æ‰§è¡ŒåŒæ­¥ç»“æœã€‚</li></ul></li><li><code>com.netflix.eureka.cluster.InstanceReplicationTask</code> ï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä»»åŠ¡<strong>æŠ½è±¡ç±»</strong><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/InstanceReplicationTask.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ InstanceReplicationTask ä»£ç ã€‚</li><li>å®ç°äº†çˆ¶ç±» <code>#getTaskName()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ã€‚</li></ul></li><li><code>com.netflix.eureka.cluster.AsgReplicationTask</code> ï¼Œäºšé©¬é€Š AWS ä½¿ç”¨ï¼Œæš‚æ—¶è·³è¿‡ã€‚</li></ul><p>ä»ä¸Šé¢ <code>PeerEurekaNode#åŒæ­¥æ“ä½œ(...)</code> æ–¹æ³•ï¼Œ<strong>å…¨éƒ¨</strong>å®ç°äº† InstanceReplicationTask ç±»çš„ <code>#execute()</code> æ–¹æ³•ï¼Œ<strong>éƒ¨åˆ†</strong>é‡å†™äº† <code>#handleFailure(...)</code> æ–¹æ³•ã€‚</p><h3>4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨</h3><p><code>com.netflix.eureka.cluster.InstanceReplicationTask</code> ï¼Œå®ç° TaskProcessor <strong>æ¥å£</strong>ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨ã€‚</p><ul><li>TaskProcessor ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ InstanceReplicationTask ä»£ç ã€‚</li></ul><p><code>ReplicationTaskProcessor#process(task)</code> ï¼Œ<strong>å¤„ç†å•ä»»åŠ¡</strong>ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( <code>Autoscaling Group</code> ) åŒæ­¥çŠ¶æ€ï¼Œæš‚æ—¶è·³è¿‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L38" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚</p><p><code>ReplicationTaskProcessor#process(tasks)</code> ï¼Œ<strong>å¤„ç†æ‰¹é‡ä»»åŠ¡</strong>ï¼Œç”¨äº Eureka-Server é›†ç¾¤æ³¨å†Œä¿¡æ¯çš„åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œé€šè¿‡è°ƒç”¨è¢«åŒæ­¥çš„ Eureka-Server çš„ <code>peerreplication/batch/</code> æ¥å£ï¼Œä¸€æ¬¡æ€§å°†æ‰¹é‡( å¤šä¸ª )çš„åŒæ­¥æ“ä½œä»»åŠ¡å‘èµ·è¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ProcessingResult <span class="title">process</span><span class="params">(List&lt;ReplicationTask&gt; tasks)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡</span></div><div class="line"> <span class="number">4</span>:     ReplicationList list = createReplicationListOf(tasks);</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å‘èµ· æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚</span></div><div class="line"> <span class="number">7</span>:         EurekaHttpResponse&lt;ReplicationListResponse&gt; response = replicationClient.submitBatchUpdates(list);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç† æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!isSuccess(statusCode)) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (statusCode == <span class="number">503</span>) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Server busy (503) HTTP status code received from the peer &#123;&#125;; rescheduling tasks after delay"</span>, peerId);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">return</span> ProcessingResult.Congestion;</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="comment">// Unexpected error returned from the server. This should ideally never happen.</span></div><div class="line"><span class="number">16</span>:                 logger.error(<span class="string">"Batch update failure with HTTP status code &#123;&#125;; discarding &#123;&#125; replication tasks"</span>, statusCode, tasks.size());</div><div class="line"><span class="number">17</span>:                 <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             handleBatchResponse(tasks, response.getEntity().getResponseList());</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:         <span class="keyword">if</span> (isNetworkConnectException(e)) &#123;</div><div class="line"><span class="number">24</span>:             logNetworkErrorSample(<span class="keyword">null</span>, e);</div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> ProcessingResult.TransientError;</div><div class="line"><span class="number">26</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:             logger.error(<span class="string">"Not re-trying this exception because it does not seem to be a network exception"</span>, e);</div><div class="line"><span class="number">28</span>:             <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> ProcessingResult.Success;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šåˆ›å»ºæ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡( ReplicationList ) ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œå’±å°±ä¸å•°å—¦è´´ä»£ç äº†ã€‚<ul><li>ReplicationList ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationList.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li>ReplicationInstance ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationInstance.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li><code>#createReplicationListOf(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L142" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li><code>#createReplicationInstanceOf(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L173" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li></ul></li><li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>JerseyReplicationClient#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œè¯·æ±‚ <code>peerreplication/batch/</code> æ¥å£ï¼Œä¸€æ¬¡æ€§å°†æ‰¹é‡( å¤šä¸ª )çš„åŒæ­¥æ“ä½œä»»åŠ¡å‘èµ·è¯·æ±‚ã€‚<ul><li><code>JerseyReplicationClient#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/transport/JerseyReplicationClient.java#L109" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li>ReplicationListResponse ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationListResponse.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li>ReplicationInstanceResponse ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationInstanceResponse.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li></ul></li><li>ç¬¬ 9 è‡³ 31 è¡Œ ï¼šå¤„ç†æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”ï¼Œåœ¨ <a href="#">ã€Œ4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</h2><p><code>com.netflix.eureka.resources.PeerReplicationResource</code> ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡ Resource ( Controller )ã€‚</p><p><code>peerreplication/batch/</code> æ¥å£ï¼Œæ˜ å°„ <code>PeerReplicationResource#batchReplication(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Path</span>(<span class="string">"batch"</span>)</div><div class="line"> <span class="number">2</span>: <span class="meta">@POST</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">batchReplication</span><span class="params">(ReplicationList replicationList)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:         ReplicationListResponse batchResponse = <span class="keyword">new</span> ReplicationListResponse();</div><div class="line"> <span class="number">6</span>:         <span class="comment">// é€ä¸ªåŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœ( ReplicationInstanceResponse ) åˆå¹¶åˆ° ReplicationListResponse ã€‚</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">for</span> (ReplicationInstance instanceInfo : replicationList.getReplicationList()) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:                 batchResponse.addResponse(dispatch(instanceInfo));</div><div class="line"><span class="number">10</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">11</span>:                 batchResponse.addResponse(<span class="keyword">new</span> ReplicationInstanceResponse(Status.INTERNAL_SERVER_ERROR.getStatusCode(), <span class="keyword">null</span>));</div><div class="line"><span class="number">12</span>:                 logger.error(instanceInfo.getAction() + <span class="string">" request processing failed for batch item "</span></div><div class="line"><span class="number">13</span>:                         + instanceInfo.getAppName() + <span class="string">'/'</span> + instanceInfo.getId(), e);</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> Response.ok(batchResponse).build();</div><div class="line"><span class="number">17</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">18</span>:         logger.error(<span class="string">"Cannot execute batch Request"</span>, e);</div><div class="line"><span class="number">19</span>:         <span class="keyword">return</span> Response.status(Status.INTERNAL_SERVER_ERROR).build();</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="function"><span class="keyword">private</span> ReplicationInstanceResponse <span class="title">dispatch</span><span class="params">(ReplicationInstance instanceInfo)</span> </span>&#123;</div><div class="line"><span class="number">24</span>:     ApplicationResource applicationResource = createApplicationResource(instanceInfo);</div><div class="line"><span class="number">25</span>:     InstanceResource resource = createInstanceResource(instanceInfo, applicationResource);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:     String lastDirtyTimestamp = toString(instanceInfo.getLastDirtyTimestamp());</div><div class="line"><span class="number">28</span>:     String overriddenStatus = toString(instanceInfo.getOverriddenStatus());</div><div class="line"><span class="number">29</span>:     String instanceStatus = toString(instanceInfo.getStatus());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     Builder singleResponseBuilder = <span class="keyword">new</span> Builder();</div><div class="line"><span class="number">32</span>:     <span class="keyword">switch</span> (instanceInfo.getAction()) &#123;</div><div class="line"><span class="number">33</span>:         <span class="keyword">case</span> Register:</div><div class="line"><span class="number">34</span>:             singleResponseBuilder = handleRegister(instanceInfo, applicationResource);</div><div class="line"><span class="number">35</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> Heartbeat:</div><div class="line"><span class="number">37</span>:             singleResponseBuilder = handleHeartbeat(serverConfig, resource, lastDirtyTimestamp, overriddenStatus, instanceStatus);</div><div class="line"><span class="number">38</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">39</span>:         <span class="keyword">case</span> Cancel:</div><div class="line"><span class="number">40</span>:             singleResponseBuilder = handleCancel(resource);</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> StatusUpdate:</div><div class="line"><span class="number">43</span>:             singleResponseBuilder = handleStatusUpdate(instanceInfo, resource);</div><div class="line"><span class="number">44</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">45</span>:         <span class="keyword">case</span> DeleteStatusOverride:</div><div class="line"><span class="number">46</span>:             singleResponseBuilder = handleDeleteStatusOverride(instanceInfo, resource);</div><div class="line"><span class="number">47</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">48</span>:     &#125;</div><div class="line"><span class="number">49</span>:     <span class="keyword">return</span> singleResponseBuilder.build();</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šé€ä¸ªå¤„ç†<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œå¹¶å°†å¤„ç†ç»“æœ( ReplicationInstanceResponse ) æ·»åŠ åˆ° ReplicationListResponse ã€‚</li><li>ç¬¬ 23 è‡³ 50 è¡Œ ï¼šå¤„ç†<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œè¿”å›å¤„ç†ç»“æœ( ReplicationInstanceResponse )ã€‚<ul><li>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º ApplicationResource , InstanceResource ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…è¯¥æ–¹æ³•æ˜¯æŠŠ<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡æäº¤åˆ°å…¶ä»– Resource ( Controller ) å¤„ç†ï¼ŒEureka-Server æ”¶åˆ° Eureka-Client è¯·æ±‚å“åº”çš„ Resource ( Controller ) æ˜¯<strong>ç›¸åŒçš„é€»è¾‘</strong>ã€‚</li><li>Register ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L137" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleRegister(...)</code> æ–¹æ³•ã€‚</li><li>Heartbeat ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L147" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleHeartbeat(...)</code> æ–¹æ³•ã€‚</li><li>Cancel ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L142" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleCancel(...)</code> æ–¹æ³•ã€‚</li><li>StatusUpdate ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L165" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleStatusUpdate(...)</code> æ–¹æ³•ã€‚</li><li>DeleteStatusOverride ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L170" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleDeleteStatusOverride(...)</code> æ–¹æ³•ã€‚</li></ul></li></ul><h2>4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</h2><p>ğŸ˜ˆ æƒ³æƒ³å°±æœ‰å°æ¿€åŠ¨ï¼Œç»ˆäºå†™åˆ°è¿™é‡Œäº†ã€‚</p><p>æ¥ <code>ReplicationTaskProcessor#process(tasks)</code> æ–¹æ³•ï¼Œå¤„ç†æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ProcessingResult <span class="title">process</span><span class="params">(List&lt;ReplicationTask&gt; tasks)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡</span></div><div class="line"> <span class="number">4</span>:     ReplicationList list = createReplicationListOf(tasks);</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å‘èµ· æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚</span></div><div class="line"> <span class="number">7</span>:         EurekaHttpResponse&lt;ReplicationListResponse&gt; response = replicationClient.submitBatchUpdates(list);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç† æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!isSuccess(statusCode)) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (statusCode == <span class="number">503</span>) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Server busy (503) HTTP status code received from the peer &#123;&#125;; rescheduling tasks after delay"</span>, peerId);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">return</span> ProcessingResult.Congestion;</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="comment">// Unexpected error returned from the server. This should ideally never happen.</span></div><div class="line"><span class="number">16</span>:                 logger.error(<span class="string">"Batch update failure with HTTP status code &#123;&#125;; discarding &#123;&#125; replication tasks"</span>, statusCode, tasks.size());</div><div class="line"><span class="number">17</span>:                 <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             handleBatchResponse(tasks, response.getEntity().getResponseList());</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:         <span class="keyword">if</span> (isNetworkConnectException(e)) &#123;</div><div class="line"><span class="number">24</span>:             logNetworkErrorSample(<span class="keyword">null</span>, e);</div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> ProcessingResult.TransientError;</div><div class="line"><span class="number">26</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:             logger.error(<span class="string">"Not re-trying this exception because it does not seem to be a network exception"</span>, e);</div><div class="line"><span class="number">28</span>:             <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> ProcessingResult.Success;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 10 è¡Œ ï¼Œè°ƒç”¨ <code>#isSuccess(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå“åº”çŠ¶æ€ç æ˜¯å¦åœ¨  [200, 300) èŒƒå›´å†…ã€‚</p></li><li><p>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šçŠ¶æ€ç  503 ï¼Œç›®å‰ Eureka-Server è¿”å› 503 çš„åŸå› æ˜¯è¢«é™æµã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a> è¯¦ç»†è§£æã€‚<strong>è¯¥æƒ…å†µä¸ºç¬æ—¶é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šé<strong>é¢„æœŸ</strong>çŠ¶æ€ç ï¼Œç›®å‰ Eureka-Server åœ¨ä»£ç ä¸Šçœ‹ä¸‹æ¥ï¼Œä¸ä¼šè¿”å›è¿™æ ·çš„çŠ¶æ€ç ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 20 è¡Œ ï¼šè¯·æ±‚æˆåŠŸï¼Œè°ƒç”¨ <code>#handleBatchResponse(...)</code> æ–¹æ³•ï¼Œé€ä¸ªå¤„ç†<strong>æ¯ä¸ª</strong> ReplicationTask å’Œ ReplicationInstanceResponse ã€‚<strong>è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œè¯·æ±‚æˆåŠŸæŒ‡çš„æ˜¯æ•´ä¸ªè¯·æ±‚æˆåŠŸï¼Œå®é™…æ¯ä¸ª ReplicationInstanceResponse å¯èƒ½è¿”å›çš„çŠ¶æ€ç ä¸åœ¨ [200, 300) èŒƒå›´å†…</strong>ã€‚è¯¥æ–¹æ³•ä¸‹æ–‡è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 23 è‡³ 25 è¡Œ ï¼šè¯·æ±‚å‘ç”Ÿç½‘ç»œå¼‚å¸¸ï¼Œä¾‹å¦‚ç½‘ç»œè¶…æ—¶ï¼Œæ‰“å°ç½‘ç»œå¼‚å¸¸æ—¥å¿—ã€‚ç›®å‰æ—¥å¿—çš„æ‰“å°ä¸ºéƒ¨åˆ†é‡‡æ ·ï¼Œæ¡ä»¶ä¸ºç½‘ç»œå‘ç”Ÿå¼‚å¸¸æ¯é—´éš” 10 ç§’æ‰“å°ä¸€æ¡ï¼Œé¿å…ç½‘ç»œå‘ç”Ÿå¼‚å¸¸æ‰“å°è¶…çº§å¤§é‡çš„æ—¥å¿—ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><ul><li><code>#isNetworkConnectException(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L163" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li><code>#logNetworkErrorSample(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L103" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li></ul></li><li><p>ç¬¬ 26 è‡³ 29 è¡Œ ï¼šé<strong>é¢„æœŸ</strong>å¼‚å¸¸ï¼Œç›®å‰ Eureka-Server åœ¨ä»£ç ä¸Šçœ‹ä¸‹æ¥ï¼Œä¸ä¼šæŠ›å‡ºè¿™æ ·çš„å¼‚å¸¸ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><hr><p><code>#handleBatchResponse(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBatchResponse</span><span class="params">(List&lt;ReplicationTask&gt; tasks, List&lt;ReplicationInstanceResponse&gt; responseList)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (tasks.size() != responseList.size()) &#123;</div><div class="line">       <span class="comment">// This should ideally never happen unless there is a bug in the software.</span></div><div class="line">       logger.error(<span class="string">"Batch response size different from submitted task list (&#123;&#125; != &#123;&#125;); skipping response analysis"</span>, responseList.size(), tasks.size());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.size(); i++) &#123;</div><div class="line">       handleBatchResponse(tasks.get(i), responseList.get(i));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBatchResponse</span><span class="params">(ReplicationTask task, ReplicationInstanceResponse response)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‰§è¡ŒæˆåŠŸ</span></div><div class="line">   <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line">   <span class="keyword">if</span> (isSuccess(statusCode)) &#123;</div><div class="line">       task.handleSuccess();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// æ‰§è¡Œå¤±è´¥</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       task.handleFailure(response.getStatusCode(), response.getResponseEntity());</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Replication task "</span> + task.getTaskName() + <span class="string">" error handler failure"</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>ReplicationTask#handleSuccess()</code> æ–¹æ³•ï¼Œæ— ä»»åŠ¡åŒæ­¥æ“ä½œä»»åŠ¡é‡å†™ï¼Œæ˜¯ä¸ª<strong>ç©ºæ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// ReplicationTask.java</div><div class="line">public void handleSuccess() &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>ReplicationTask#handleFailure()</code> æ–¹æ³•ï¼Œæœ‰<strong>ä¸¤ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡é‡å†™ï¼š</p><ul><li><p>Cancel ï¼šå½“ Eureka-Server ä¸å­˜åœ¨ä¸‹çº¿çš„åº”ç”¨å®ä¾‹æ—¶ï¼Œè¿”å› 404 çŠ¶æ€ç ï¼Œæ­¤æ—¶æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerEurekaNode#cancel(...)</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="keyword">super</span>.handleFailure(statusCode, responseEntity);</div><div class="line">    <span class="keyword">if</span> (statusCode == <span class="number">404</span>) &#123;</div><div class="line">        logger.warn(<span class="string">"&#123;&#125;: missing entry."</span>, getTaskName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>Heartbeat ï¼šæƒ…å†µè¾ƒä¸ºå¤æ‚ï¼Œæˆ‘ä»¬æ¢ä¸€è¡Œç»§ç»­è¯´ï¼Œé¿å…æ’ç‰ˆæœ‰é—®é¢˜ï¼Œå½±å“é˜…è¯»ã€‚</p></li></ul></li></ul><p>å™”å™”å™”æ°ï¼Œæœ¬æ–‡çš„é‡è¦å¤´æˆæ¥å•¦ï¼Last But Very Importment ï¼ï¼ï¼</p><p>Eureka-Server æ˜¯å…è®¸<strong>åŒä¸€æ—¶åˆ»</strong>å…è®¸åœ¨ä»»æ„èŠ‚ç‚¹è¢« Eureka-Client å‘èµ·<strong>å†™å…¥</strong>ç›¸å…³çš„æ“ä½œï¼Œç½‘ç»œæ˜¯ä¸å¯é çš„èµ„æºï¼ŒEureka-Client å¯èƒ½å‘ä¸€ä¸ª Eureka-Server æ³¨å†ŒæˆåŠŸï¼Œä½†æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼Œå¯¼è‡´ Eureka-Client è¯¯ä»¥ä¸ºå¤±è´¥ï¼Œæ­¤æ—¶æ°å¥½ Eureka-Client å˜æ›´äº†åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œé‡è¯•å‘å¦ä¸€ä¸ª Eureka-Server æ³¨å†Œï¼Œé‚£ä¹ˆä¸¤ä¸ª Eureka-Server å¯¹è¯¥åº”ç”¨å®ä¾‹çš„çŠ¶æ€äº§ç”Ÿå†²çªã€‚</p><p>å†ä¾‹å¦‚...... æˆ‘ä»¬ä¸è¦ç»§ç»­ä¸¾ä¾‹å­ï¼Œç½‘ç»œæ³¢åŠ¨çœŸçš„å¾ˆå¤æ‚ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ Eureka æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>åº”ç”¨å®ä¾‹( InstanceInfo ) çš„ <code>lastDirtyTimestamp</code> å±æ€§ï¼Œä½¿ç”¨<strong>æ—¶é—´æˆ³</strong>ï¼Œè¡¨ç¤ºåº”ç”¨å®ä¾‹çš„<strong>ç‰ˆæœ¬å·</strong>ï¼Œå½“è¯·æ±‚æ–¹( ä¸ä»…ä»…æ˜¯ Eureka-Client ï¼Œä¹Ÿå¯èƒ½æ˜¯åŒæ­¥æ³¨å†Œæ“ä½œçš„ Eureka-Server ) å‘ Eureka-Server å‘èµ·æ³¨å†Œæ—¶ï¼Œè‹¥ Eureka-Server å·²å­˜åœ¨æ‹¥æœ‰æ›´å¤§ <code>lastDirtyTimestamp</code> è¯¥å®ä¾‹( <strong>ç›¸åŒåº”ç”¨å¹¶ä¸”ç›¸åŒåº”ç”¨å®ä¾‹ç¼–å·è¢«è®¤ä¸ºæ˜¯ç›¸åŒå®ä¾‹</strong> )ï¼Œåˆ™è¯·æ±‚æ–¹æ³¨å†Œçš„åº”ç”¨å®ä¾‹( InstanceInfo ) æ— æ³•è¦†ç›–æ³¨å†Œæ­¤ Eureka-Server çš„è¯¥å®ä¾‹( è§ <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³• )ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢ä¸¾çš„ä¾‹å­ï¼Œç¬¬ä¸€ä¸ª Eureka-Server å‘ ç¬¬äºŒä¸ª Eureka-Server åŒæ­¥æ³¨å†Œåº”ç”¨å®ä¾‹æ—¶ï¼Œä¸ä¼šæ³¨å†Œè¦†ç›–ï¼Œåå€’æ˜¯ç¬¬äºŒä¸ª Eureka-Server åŒæ­¥æ³¨å†Œåº”ç”¨åˆ°ç¬¬ä¸€ä¸ª Eureka-Server ï¼Œæ³¨å†Œè¦†ç›–æˆåŠŸï¼Œå› ä¸º <code>lastDirtyTimestamp</code> ( åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´æ—¶ï¼Œå¯ä»¥è®¾ç½® <code>lastDirtyTimestamp</code> ä¸ºå½“å‰æ—¶é—´ï¼Œè§ <code>ApplicationInfoManager#setInstanceStatus(status)</code> æ–¹æ³• )ã€‚</p><p>ä½†æ˜¯å…‰é <strong>æ³¨å†Œ</strong>è¯·æ±‚åˆ¤æ–­ <code>lastDirtyTimestamp</code> æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹æ—¶ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡å¤šæ¬¡æ‰§è¡Œå¤±è´¥åˆ°è¾¾è¿‡æœŸæ—¶é—´åï¼Œæ­¤æ—¶åœ¨ Eureka-Server é›†ç¾¤åŒæ­¥èµ·åˆ°æœ€ç»ˆä¸€è‡´æ€§<strong>æœ€æœ€æœ€</strong>å…³é”®æ€§å‡ºç°äº†ï¼šHeartbeat ã€‚å› ä¸º Heartbeat ä¼šå‘¨æœŸæ€§çš„æ‰§è¡Œï¼Œé€šè¿‡å®ƒä¸€æ–¹é¢å¯ä»¥åˆ¤æ–­ Eureka-Server æ˜¯å¦å­˜åœ¨å¿ƒè·³å¯¹åº”çš„åº”ç”¨å®ä¾‹ï¼Œå¦å¤–ä¸€æ–¹é¢å¯ä»¥æ¯”è¾ƒåº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> ã€‚å½“æ»¡è¶³ä¸‹é¢ä»»æ„æ¡ä»¶ï¼ŒEureka-Server è¿”å› 404 çŠ¶æ€ç ï¼š</p><ul><li>1ï¼‰Eureka-Server åº”ç”¨å®ä¾‹ä¸å­˜åœ¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/registry/AbstractInstanceRegistry.java#L438" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li><li>2ï¼‰Eureka-Server åº”ç”¨å®ä¾‹çŠ¶æ€ä¸º <code>UNKNOWN</code>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/registry/AbstractInstanceRegistry.java#L450" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚ä¸ºä»€ä¹ˆä¼šæ˜¯ <code>UNKNOWN</code> ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹ã€Œ 4.3 ç»­ç§Ÿåœºæ™¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>**3ï¼‰**è¯·æ±‚çš„ <code>lastDirtyTimestamp</code> æ›´å¤§ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L306" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li></ul><p>è¯·æ±‚æ–¹æ¥æ”¶åˆ° 404 çŠ¶æ€ç è¿”å›åï¼Œ<strong>è®¤ä¸º Eureka-Server åº”ç”¨å®ä¾‹å®é™…æ˜¯ä¸å­˜åœ¨çš„</strong>ï¼Œé‡æ–°å‘èµ·åº”ç”¨å®ä¾‹çš„æ³¨å†Œã€‚ä»¥æœ¬æ–‡çš„ Heartbeat ä¸ºä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerEurekaNode#heartbeat(...)</span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">super</span>.handleFailure(statusCode, responseEntity);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (statusCode == <span class="number">404</span>) &#123;</div><div class="line">  <span class="number">5</span>:         logger.warn(<span class="string">"&#123;&#125;: missing entry."</span>, getTaskName());</div><div class="line">  <span class="number">6</span>:         <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">7</span>:             logger.warn(<span class="string">"&#123;&#125;: cannot find instance id &#123;&#125; and hence replicating the instance with status &#123;&#125;"</span>,</div><div class="line">  <span class="number">8</span>:                     getTaskName(), info.getId(), info.getStatus());</div><div class="line">  <span class="number">9</span>:             register(info);</div><div class="line"> <span class="number">10</span>:         &#125;</div><div class="line"> <span class="number">11</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.shouldSyncWhenTimestampDiffers()) &#123;</div><div class="line"> <span class="number">12</span>:         InstanceInfo peerInstanceInfo = (InstanceInfo) responseEntity;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (peerInstanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">14</span>:             syncInstancesIfTimestampDiffers(appName, id, info, peerInstanceInfo);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:     &#125;</div><div class="line"> <span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 10 è¡Œ ï¼šæ¥æ”¶åˆ° 404 çŠ¶æ€ç ï¼Œè°ƒç”¨ <code>#register(...)</code> æ–¹æ³•ï¼Œå‘è¯¥è¢«å¿ƒè·³åŒæ­¥æ“ä½œå¤±è´¥çš„ Eureka-Server å‘èµ·æ³¨å†Œ<strong>æœ¬åœ°çš„åº”ç”¨å®ä¾‹</strong>çš„è¯·æ±‚ã€‚</p><ul><li>ä¸Šè¿° <strong>3ï¼‰</strong> ï¼Œä¼šä½¿ç”¨è¯·æ±‚å‚æ•° <code>overriddenStatus</code> å­˜å‚¨åˆ° Eureka-Server çš„åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€é›†åˆ( <code>AbstractInstanceRegistry.overriddenInstanceStatusMap</code> )ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L123" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 16 è¡Œ ï¼šæ°å¥½æ˜¯ <strong>3ï¼‰</strong> åè¿‡æ¥çš„æƒ…å†µï¼Œæœ¬åœ°çš„åº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> å°äº Eureka-Server è¯¥åº”ç”¨å®ä¾‹çš„ï¼Œæ­¤æ—¶ Eureka-Server è¿”å› 409 çŠ¶æ€ç ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L314" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚è°ƒç”¨ <code>#syncInstancesIfTimestampDiffers()</code> æ–¹æ³•ï¼Œè¦†ç›–æ³¨å†Œæœ¬åœ°åº”ç”¨å®ä¾‹ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L387" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</p></li></ul><p>OKï¼Œæ’’èŠ±ï¼è®°ä½ï¼šEureka é€šè¿‡ Heartbeat å®ç° Eureka-Server é›†ç¾¤åŒæ­¥çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h1>666. å½©è›‹</h1><p>å†™çš„æ¯”è¾ƒå—¨çš®ï¼Œæ‰€ä»¥å°±é€èƒ–å‹ä¸€åªèƒ–å‹</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p><p>ä»¥ä¸‹æ˜¯è‰ç¨¿ï¼Œå¯ä»¥å‡‘åˆçœ‹</p><p>eureka server é›†ç¾¤å‡å®šæ˜¯ s1 s2</p><p>1ï¼‰client å‘ s1 æ³¨å†Œï¼Œæœ‰ä¸€ä¸ª lastDirtyTime ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆåŠŸï¼Œ s1 ä¼šå‘ s2 åŒæ­¥<br>2ï¼‰client å‘ s1 æ³¨å†Œï¼ˆæˆåŠŸï¼Œä½†æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼‰ï¼Œç„¶å client å‘ç”ŸçŠ¶æ€çš„å˜åŒ–ï¼ŒlastDirtyTime å˜åŒ–ï¼Œå‘ s2 æ³¨å†Œã€‚<br>è¿™ä¸ªæ—¶å€™ï¼Œs1 s2 æ˜¯å†²çªçš„ï¼Œä½†æ˜¯ä»–ä»¬ä¼šäº’ç›¸åŒæ­¥ï¼Œå®é™… s2 =&gt; s1 çš„æ³¨å†Œä¼šçœŸæ­£æˆåŠŸï¼Œs1 =&gt; s2 çš„æ³¨å†Œä¸ä¼šè¿”å›å¤±è´¥ï¼Œä½†æ˜¯å®é™… s2 å¤„ç†çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯è‡ªèº«çš„ã€‚</p><p>å¿ƒè·³åªæ˜¯æœ€ç»ˆå»æ ¡éªŒã€‚</p><p>ç†è®ºæ¥è¯´ï¼Œå¿ƒè·³ä¸åº”è¯¥å¸¦ lastDirtyTime å‚æ•°ã€‚å¸¦çš„åŸå› å°±æ˜¯ä¸ºäº†åšå›ºå®šå‘¨æœŸçš„æ¯”è¾ƒã€‚</p><p>æœ€ä¼˜è§£æ˜¯ æ³¨å†Œ å°±å¤„ç†æ‰æ•°æ®ä¸ä¸€è‡´<br>æ¬¡ä¼˜è§£æ˜¯ å¿ƒè·³ å¤„ç†æ‰æ•°æ®ä¸ä¸€è‡´</p><p>å¦‚æœåœ¨ç±»æ¯”ï¼Œ</p><p>æ³¨å†Œï¼Œç›¸å½“äº insertOrUpdate<br>å¿ƒè·³ï¼Œé™„åŠ äº†æ ¡éªŒæ˜¯å¦è¦å‘èµ·ã€æ³¨å†Œã€‘</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/server-cluster/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a 
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡</title>
    <link href="http://www.iocoder.cn/Eureka/transport/"/>
    <id>http://www.iocoder.cn/Eureka/transport/</id>
    <published>2018-07-30T16:00:00.000Z</published>
    <updated>2017-10-18T15:23:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/transport/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">2. EurekaHttpClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">2.1 EurekaJerseyClientImpl</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">2.2 EurekaJerseyClientBuilder</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">3. EurekaHttpClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">3.1 EurekaHttpResponse</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">3.2 TransportClientFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">4. AbstractJerseyEurekaHttpClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">4.1 JerseyApplicationClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">4.2 JerseyReplicationClient</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5. EurekaHttpClientDecorator</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">5.1 MetricsCollectingEurekaHttpClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5.2 RedirectingEurekaHttpClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5.3 RetryableEurekaHttpClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5.4 SessionedEurekaHttpClient</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka çš„ç½‘ç»œé€šä¿¡éƒ¨åˆ†</strong>ã€‚åœ¨ä¸è€ƒè™‘ Eureka 2.x çš„å…¼å®¹çš„æƒ…å†µä¸‹ï¼ŒEureka 1.x ä¸»è¦ä¸¤éƒ¨åˆ†çš„ç½‘ç»œé€šä¿¡ï¼š</p><ul><li>Eureka-Client è¯·æ±‚ Eureka-Server çš„ç½‘ç»œé€šä¿¡</li><li>Eureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ <strong>å…¶å®ƒçš„Eureka-Server</strong> çš„ç½‘ç»œé€šä¿¡</li></ul><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.discovery.shared.transport</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/01.png" alt=""></p><ul><li>ç²‰è‰²éƒ¨åˆ† â€”â€” EurekaJerseyClient ï¼Œå¯¹åŸºäº Jersey Server çš„ Eureka-Server çš„ Jersey å®¢æˆ·ç«¯å°è£…ã€‚</li><li>ç»¿è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient ï¼ŒEureka-Server HTTP è®¿é—®å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚å¦‚æœæŠŠ DiscoveryClient ç±»æ¯”æˆ Service ï¼Œé‚£ä¹ˆ EurekaHttpClient å¯ä»¥ç±»æ¯”åŸ Dao ã€‚</li><li>ç»¼è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient å®ç°ç±»ï¼Œ<strong>çœŸæ­£</strong>å®ç°äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚</li><li>çº¢è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient å§”æ‰˜ç±»ï¼Œæä¾›äº†<strong>ä¼šè¯ã€é‡è¯•ã€é‡å®šå‘ã€ç›‘æ§æŒ‡æ ‡æ”¶é›†</strong>ç­‰ç‰¹æ€§ã€‚</li><li>é»„è‰²éƒ¨åˆ† â€”â€” EurekaHttpClientFactoryï¼Œç”¨äºåˆ›å»º EurekaHttpClient ã€‚</li></ul><p>ç±»å›¾çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œæ•´ä½“è°ƒç”¨å…³ç³»å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/02.png" alt=""></p><p>OK ï¼Œæˆ‘ä»¬é€å±‚è§£æï¼Œå—¨èµ·æ¥ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaHttpClient</h1><p><code>com.netflix.discovery.shared.transport.jersey.EurekaJerseyClient</code> ï¼ŒEurekaHttpClient <strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaJerseyClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">ApacheHttpClient4 <span class="title">getClient</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroyResources</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.sun.jersey.client.apache4.ApacheHttpClient4</code> ï¼ŒåŸºäº Apache HttpClient4 å®ç°çš„ Jersey Client ã€‚</li></ul><h2>2.1 EurekaJerseyClientImpl</h2><p><code>com.netflix.discovery.shared.transport.jersey.EurekaJerseyClientImpl</code> ï¼ŒEurekaHttpClient <strong>å®ç°ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaJerseyClientImpl</span> <span class="keyword">implements</span> <span class="title">EurekaJerseyClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åŸºäº Apache HttpClient4 å®ç°çš„ Jersey Client</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClient4 apacheHttpClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Apache HttpClient ç©ºé—²è¿æ¥æ¸…ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClientConnectionCleaner apacheHttpClientConnectionCleaner;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey Client é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ClientConfig jerseyClientConfig;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EurekaJerseyClientImpl</span><span class="params">(<span class="keyword">int</span> connectionTimeout, <span class="keyword">int</span> readTimeout, <span class="keyword">final</span> <span class="keyword">int</span> connectionIdleTimeout,</span></span></div><div class="line"><span class="function"><span class="params">                                  ClientConfig clientConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            jerseyClientConfig = clientConfig;</div><div class="line">            <span class="comment">// åˆ›å»º  ApacheHttpClient</span></div><div class="line">            apacheHttpClient = ApacheHttpClient4.create(jerseyClientConfig);</div><div class="line"></div><div class="line">            <span class="comment">// è®¾ç½® è¿æ¥å‚æ•°</span></div><div class="line">            HttpParams params = apacheHttpClient.getClientHandler().getHttpClient().getParams();</div><div class="line">            HttpConnectionParams.setConnectionTimeout(params, connectionTimeout);</div><div class="line">            HttpConnectionParams.setSoTimeout(params, readTimeout);</div><div class="line"></div><div class="line">            <span class="comment">// åˆ›å»º ApacheHttpClientConnectionCleaner</span></div><div class="line">            <span class="keyword">this</span>.apacheHttpClientConnectionCleaner = <span class="keyword">new</span> ApacheHttpClientConnectionCleaner(apacheHttpClient, connectionIdleTimeout);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create Jersey client"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ApacheHttpClient4 <span class="title">getClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> apacheHttpClient;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyResources</span><span class="params">()</span> </span>&#123;</div><div class="line">        apacheHttpClientConnectionCleaner.shutdown();</div><div class="line">        apacheHttpClient.destroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.discovery.shared.transport.jersey.ApacheHttpClientConnectionCleaner</code> ï¼ŒApache HttpClient ç©ºé—²è¿æ¥æ¸…ç†å™¨ï¼Œè´Ÿè´£<strong>å‘¨æœŸæ€§</strong>å…³é—­å¤„äº <code>half-close</code> çŠ¶æ€çš„ç©ºé—²è¿æ¥ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/ApacheHttpClientConnectionCleaner.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ ApacheHttpClientConnectionCleanerã€‚æ¨èé˜…è¯»ï¼š<a href="http://seanhe.iteye.com/blog/234759" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHttpClientå®¹æ˜“å¿½è§†çš„ç»†èŠ‚â€”â€”è¿æ¥å…³é—­ã€‹</a> ã€‚</li></ul><h2>2.2 EurekaJerseyClientBuilder</h2><p>EurekaJerseyClientBuilder ï¼ŒEurekaJerseyClientImpl <strong>å†…éƒ¨ç±»</strong>ï¼Œç”¨äºåˆ›å»º EurekaJerseyClientImpl ã€‚</p><p>è°ƒç”¨ <code>#build()</code> æ–¹æ³•ï¼Œåˆ›å»º EurekaJerseyClientImpl ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaJerseyClientBuilder.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaJerseyClient <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">    MyDefaultApacheHttpClient4Config config = <span class="keyword">new</span> MyDefaultApacheHttpClient4Config();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EurekaJerseyClientImpl(connectionTimeout, readTimeout, connectionIdleTimeout, config);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create Jersey client "</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>MyDefaultApacheHttpClient4Config ï¼Œç»§æ‰¿è‡ª <code>com.sun.jersey.client.apache4.config.DefaultApacheHttpClient4Config</code> ï¼Œå®ç°<strong>è‡ªå®šä¹‰é…ç½®</strong>ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/EurekaJerseyClientImpl.java#L199" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ MyDefaultApacheHttpClient4Configã€‚ä¾‹å¦‚ ï¼š<ul><li>è‡ªå®šä¹‰çš„<strong>è¯·æ±‚ã€å“åº”çš„ç¼–è§£ç å™¨</strong> <code>com.netflix.discovery.provider.DiscoveryJerseyProvider</code> ã€‚</li><li>ç¦ç”¨<strong>é‡å®šå‘</strong>ï¼Œä½¿ç”¨ RedirectingEurekaHttpClient å®ç°è¯¥ç‰¹æ€§ã€‚</li><li>è‡ªå®šä¹‰ UserAgent ã€‚</li><li>è‡ªå®šä¹‰ Http Proxy ã€‚</li><li>SSL åŠŸèƒ½çš„å¢å¼ºã€‚ApacheHttpClient4 ä½¿ç”¨çš„æ˜¯ Apache HttpClient 4.1.1 ç‰ˆæœ¬ï¼Œ<code>com.netflix.discovery.shared.transport.jersey.SSLSocketFactoryAdapter</code> å°† Apache HttpClient 4.3.4 å¯¹ SSL åŠŸèƒ½çš„å¢å¼ºé€‚é…åˆ°è€ç‰ˆæœ¬ API ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/SSLSocketFactoryAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ SSLSocketFactoryAdapterã€‚</li></ul></li></ul><h1>3. EurekaHttpClient</h1><p><code>com.netflix.discovery.shared.transport.EurekaHttpClient</code> ï¼ŒEureka-Server HTTP è®¿é—®å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³• ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/EurekaHttpClient.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ EurekaHttpClientã€‚</p><h2>3.1 EurekaHttpResponse</h2><p><code>com.netflix.discovery.shared.transport.EurekaHttpResponse</code> ï¼Œè¯·æ±‚å“åº”å¯¹è±¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHttpResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿”å›çŠ¶æ€ç </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> statusCode;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿”å›å¯¹è±¡( Entity )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T entity;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿”å› header</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; headers;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡å®šå‘åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URI location;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ setting / getting å’Œ Builder</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 TransportClientFactory</h2><p><code>com.netflix.discovery.shared.transport.TransportClientFactory</code> ï¼Œåˆ›å»º EurekaHttpClient çš„å·¥å‚<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»º EurekaHttpClient</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> serviceUrl Eureka-Server åœ°å€</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> EurekaHttpClient</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…³é—­å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><strong>å¤§å¤šæ•° EurekaHttpClient å®ç°ç±»éƒ½æœ‰å…¶å¯¹åº”çš„å·¥å‚å®ç°ç±»</strong>ã€‚</p><h1>4. AbstractJerseyEurekaHttpClient</h1><p><code>com.netflix.discovery.shared.transport.jersey.AbstractJerseyEurekaHttpClient</code> ï¼Œå®ç° EurekaHttpClient çš„<strong>æŠ½è±¡ç±»</strong>ï¼Œ<strong>çœŸæ­£</strong>å®ç°äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractJerseyEurekaHttpClient</span> <span class="keyword">implements</span> <span class="title">EurekaHttpClient</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AbstractJerseyEurekaHttpClient.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:  * Jersey Client</span></div><div class="line"><span class="comment"> 7:  */</span></div><div class="line"> <span class="number">8</span>: <span class="keyword">protected</span> <span class="keyword">final</span> Client jerseyClient;</div><div class="line"> <span class="number">9</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">10:  * è¯·æ±‚çš„ Eureka-Server åœ°å€</span></div><div class="line"><span class="comment">11:  */</span></div><div class="line"><span class="number">12</span>: <span class="keyword">protected</span> <span class="keyword">final</span> String serviceUrl;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="function"><span class="keyword">protected</span> <span class="title">AbstractJerseyEurekaHttpClient</span><span class="params">(Client jerseyClient, String serviceUrl)</span> </span>&#123;</div><div class="line"><span class="number">15</span>:     <span class="keyword">this</span>.jerseyClient = jerseyClient;</div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.serviceUrl = serviceUrl;</div><div class="line"><span class="number">17</span>:     logger.debug(<span class="string">"Created client for url: &#123;&#125;"</span>, serviceUrl);</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(InstanceInfo info)</span> </span>&#123;</div><div class="line"><span class="number">22</span>:     <span class="comment">// è®¾ç½® è¯·æ±‚åœ°å€</span></div><div class="line"><span class="number">23</span>:     String urlPath = <span class="string">"apps/"</span> + info.getAppName();</div><div class="line"><span class="number">24</span>:     ClientResponse response = <span class="keyword">null</span>;</div><div class="line"><span class="number">25</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">26</span>:         Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</div><div class="line"><span class="number">27</span>:         <span class="comment">// è®¾ç½® è¯·æ±‚å¤´</span></div><div class="line"><span class="number">28</span>:         addExtraHeaders(resourceBuilder);</div><div class="line"><span class="number">29</span>:         <span class="comment">// è¯·æ±‚ Eureka-Server</span></div><div class="line"><span class="number">30</span>:         response = resourceBuilder</div><div class="line"><span class="number">31</span>:                 .header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>) <span class="comment">// GZIP</span></div><div class="line"><span class="number">32</span>:                 .type(MediaType.APPLICATION_JSON_TYPE) <span class="comment">// è¯·æ±‚å‚æ•°æ ¼å¼ JSON</span></div><div class="line"><span class="number">33</span>:                 .accept(MediaType.APPLICATION_JSON) <span class="comment">// å“åº”ç»“æœæ ¼å¼ JSON</span></div><div class="line"><span class="number">34</span>:                 .post(ClientResponse.class, info); <span class="comment">// è¯·æ±‚å‚æ•°</span></div><div class="line"><span class="number">35</span>:         <span class="comment">// åˆ›å»º EurekaHttpResponse</span></div><div class="line"><span class="number">36</span>:         <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</div><div class="line"><span class="number">37</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">38</span>:         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">39</span>:             logger.debug(<span class="string">"Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, info.getId(),</div><div class="line"><span class="number">40</span>:                     response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:         <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">43</span>:             response.close();</div><div class="line"><span class="number">44</span>:         &#125;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>jerseyClient</code> å±æ€§ï¼ŒJersey Client ï¼Œä½¿ç”¨ä¸Šæ–‡çš„ <code>EurekaHttpClient#getClient(...)</code> æ–¹æ³•ï¼Œè·å– ApacheHttpClient4 ã€‚</li><li><code>serviceUrl</code> å±æ€§ï¼Œè¯·æ±‚çš„ Eureka-Server åœ°å€ã€‚</li><li><code>#register()</code> æ–¹æ³•ï¼Œå®ç°å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚<strong>å…¶ä»–æ–¹æ³•ä»£ç ç±»ä¼¼</strong>ã€‚<ul><li><p>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šè®¾ç½®è¯·æ±‚åœ°å€ã€‚</p></li><li><p>ç¬¬ 28 è¡Œ ï¼šè°ƒç”¨ <code>#addExtraHeaders(...)</code> æ–¹æ³•ï¼Œè®¾ç½®è¯·æ±‚å¤´( header  )ã€‚è¯¥æ–¹æ³•æ˜¯<strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œæä¾›å­ç±»å®ç°è‡ªå®šä¹‰çš„è¯·æ±‚å¤´ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addExtraHeaders</span><span class="params">(Builder webResource)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 29 è‡³ 34 è¡Œ ï¼šè¯·æ±‚ Eureka-Server ã€‚</p></li><li><p>ç¬¬ 35 è‡³ 36 è¡Œ ï¼šè§£æå“åº”ç»“æœï¼Œåˆ›å»º EurekaHttpResponse ã€‚</p></li></ul></li></ul><h2>4.1 JerseyApplicationClient</h2><p><code>com.netflix.discovery.shared.transport.jersey.JerseyApplicationClient</code> ï¼Œå®ç° Eureka-Client è¯·æ±‚ Eureka-Server çš„ç½‘ç»œé€šä¿¡ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/JerseyApplicationClient.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ JerseyApplicationClientã€‚</p><h3>4.1.1 JerseyEurekaHttpClientFactory</h3><p><code>com.netflix.discovery.shared.transport.jersey.JerseyEurekaHttpClientFactory</code> ï¼Œåˆ›å»º JerseyApplicationClient çš„<strong>å·¥å‚ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JerseyEurekaHttpClientFactory</span> <span class="keyword">implements</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaJerseyClient jerseyClient;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClient4 apacheClient;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClientConnectionCleaner cleaner;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; additionalHeaders;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JerseyEurekaHttpClientFactory</span><span class="params">(ApacheHttpClient4 apacheClient, <span class="keyword">long</span> connectionIdleTimeout, Map&lt;String, String&gt; additionalHeaders)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, apacheClient, connectionIdleTimeout, additionalHeaders);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JerseyEurekaHttpClientFactory</span><span class="params">(EurekaJerseyClient jerseyClient,</span></span></div><div class="line"><span class="function"><span class="params">                                          ApacheHttpClient4 apacheClient,</span></span></div><div class="line"><span class="function"><span class="params">                                          <span class="keyword">long</span> connectionIdleTimeout,</span></span></div><div class="line"><span class="function"><span class="params">                                          Map&lt;String, String&gt; additionalHeaders)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jerseyClient = jerseyClient;</div><div class="line">        <span class="keyword">this</span>.apacheClient = jerseyClient != <span class="keyword">null</span> ? jerseyClient.getClient() : apacheClient;</div><div class="line">        <span class="keyword">this</span>.additionalHeaders = additionalHeaders;</div><div class="line">        <span class="keyword">this</span>.cleaner = <span class="keyword">new</span> ApacheHttpClientConnectionCleaner(<span class="keyword">this</span>.apacheClient, connectionIdleTimeout);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint endpoint)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JerseyApplicationClient(apacheClient, endpoint.getServiceUrl(), additionalHeaders);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        cleaner.shutdown();</div><div class="line">        <span class="keyword">if</span> (jerseyClient != <span class="keyword">null</span>) &#123;</div><div class="line">            jerseyClient.destroyResources();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            apacheClient.destroy();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>4.1.2 JerseyEurekaHttpClientFactoryBuilder</h3><p>JerseyEurekaHttpClientFactoryBuilder ï¼ŒJerseyEurekaHttpClientFactory <strong>å†…éƒ¨ç±»</strong>ï¼Œç”¨äºåˆ›å»º JerseyEurekaHttpClientFactory ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/ff48fa728c7085ad8116517ede88398b0fd693c7/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/JerseyEurekaHttpClientFactory.java#L152" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ JerseyEurekaHttpClientFactoryã€‚</p><p>è°ƒç”¨ <code>JerseyEurekaHttpClientFactory#create(...)</code> æ–¹æ³•ï¼Œåˆ›å»º JerseyEurekaHttpClientFactory ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JerseyEurekaHttpClientFactory <span class="title">create</span><span class="params">(EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                  Collection&lt;ClientFilter&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                  InstanceInfo myInstanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                                  AbstractEurekaIdentity clientIdentity)</span> </span>&#123;</div><div class="line">   JerseyEurekaHttpClientFactoryBuilder clientBuilder = newBuilder()</div><div class="line">           .withAdditionalFilters(additionalFilters) <span class="comment">// å®¢æˆ·ç«¯é™„åŠ è¿‡æ»¤å™¨</span></div><div class="line">           .withMyInstanceInfo(myInstanceInfo) <span class="comment">// åº”ç”¨å®ä¾‹</span></div><div class="line">           .withUserAgent(<span class="string">"Java-EurekaClient"</span>) <span class="comment">// UA</span></div><div class="line">           .withClientConfig(clientConfig)</div><div class="line">           .withClientIdentity(clientIdentity);</div><div class="line"></div><div class="line">   <span class="comment">// è®¾ç½® Client Name</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">"true"</span>.equals(System.getProperty(<span class="string">"com.netflix.eureka.shouldSSLConnectionsUseSystemSocketFactory"</span>))) &#123;</div><div class="line">       clientBuilder.withClientName(<span class="string">"DiscoveryClient-HTTPClient-System"</span>).withSystemSSLConfiguration();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clientConfig.getProxyHost() != <span class="keyword">null</span> &amp;&amp; clientConfig.getProxyPort() != <span class="keyword">null</span>) &#123;</div><div class="line">       clientBuilder.withClientName(<span class="string">"Proxy-DiscoveryClient-HTTPClient"</span>)</div><div class="line">               .withProxy(</div><div class="line">                       clientConfig.getProxyHost(), Integer.parseInt(clientConfig.getProxyPort()),</div><div class="line">                       clientConfig.getProxyUserName(), clientConfig.getProxyPassword()</div><div class="line">               ); <span class="comment">// http proxy</span></div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       clientBuilder.withClientName(<span class="string">"DiscoveryClient-HTTPClient"</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> clientBuilder.build();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JerseyEurekaHttpClientFactoryBuilder <span class="title">newBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JerseyEurekaHttpClientFactoryBuilder().withExperimental(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.2 JerseyReplicationClient</h2><p><code>com.netflix.eureka.transport.JerseyReplicationClient</code> ï¼ŒEureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ <strong>å…¶å®ƒçš„Eureka-Server</strong> çš„ç½‘ç»œé€šä¿¡ã€‚</p><ul><li><p>å®ç° <code>AbstractJerseyEurekaHttpClient#addExtraHeaders()</code> æ–¹æ³•ï¼Œæ·»åŠ è‡ªå®šä¹‰å¤´ <code>x-netflix-discovery-replication=true</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addExtraHeaders</span><span class="params">(Builder webResource)</span> </span>&#123;</div><div class="line">   webResource.header(PeerEurekaNode.HEADER_REPLICATION, <span class="string">"true"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>é‡å†™äº† <code>#sendHeartBeat(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>å®ç° <code>com.netflix.eureka.cluster.HttpReplicationClient</code> æ¥å£ï¼Œå®ç°äº† <code>#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><h3>4.2.1 æ²¡æœ‰å·¥å‚</h3><p>JerseyReplicationClient <strong>æ²¡æœ‰ä¸“å±çš„å·¥å‚</strong>ã€‚</p><p>è°ƒç”¨ <code>JerseyReplicationClient#createReplicationClient(...)</code> <strong>é™æ€æ–¹æ³•</strong>ï¼Œåˆ›å»º JerseyReplicationClient ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/transport/JerseyReplicationClient.java#L135" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„æ–¹æ³•ä»£ç ã€‚</p><h1>5. EurekaHttpClientDecorator</h1><p><code>com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator</code>ï¼ŒEurekaHttpClient å§”æ‰˜è€…<strong>æŠ½è±¡ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHttpClientDecorator</span> <span class="keyword">implements</span> <span class="title">EurekaHttpClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œè¯·æ±‚</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> requestExecutor è¯·æ±‚æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt; è¯·æ±‚æ³›å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å“åº”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span></span>;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> execute(<span class="keyword">new</span> RequestExecutor&lt;Void&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> delegate.register(info);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> RequestType <span class="title">getRequestType</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> RequestType.Register;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>#execute(...)</code> <strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œå®ç°è‡ªå·±çš„ç‰¹æ€§ã€‚</p></li><li><p><code>#register()</code> æ–¹æ³•ï¼Œå®ç°å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚<strong>å…¶ä»–æ–¹æ³•ä»£ç ç±»ä¼¼</strong>ã€‚</p><ul><li>è°ƒç”¨ <code>#execute(...)</code> æ–¹æ³•ï¼Œå¹¶å°†åŸæœ‰çš„æ³¨å†Œå®ç°é€šè¿‡ RequestExecutor ä¼ é€’è¿›å»ã€‚</li><li>å­ç±»åœ¨å®ç°çš„ <code>#execute(...)</code> æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ <code>RequestExecutor#execute(...)</code> æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡ŒåŸæœ‰é€»è¾‘ã€‚</li><li>å‚è€ƒè®¾è®¡æ¨¡å¼ï¼š<a href="http://blog.csdn.net/hguisu/article/details/7564039" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè®¾è®¡æ¨¡å¼ ( åä¹ ) æ¨¡æ¿æ–¹æ³•æ¨¡å¼Template methodï¼ˆç±»è¡Œä¸ºå‹ï¼‰ã€‹</a> ã€‚</li></ul></li><li><p>RequestType ï¼Œè¯·æ±‚ç±»å‹<strong>æšä¸¾ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClientDecorator.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> RequestType &#123;</div><div class="line">   Register,</div><div class="line">   Cancel,</div><div class="line">   SendHeartBeat,</div><div class="line">   StatusUpdate,</div><div class="line">   DeleteStatusOverride,</div><div class="line">   GetApplications,</div><div class="line">   GetDelta,</div><div class="line">   GetVip,</div><div class="line">   GetSecureVip,</div><div class="line">   GetApplication,</div><div class="line">   GetInstance,</div><div class="line">   GetApplicationInstance</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>RequestExecutor ï¼Œè¯·æ±‚æ‰§è¡Œå™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClientDecorator.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestExecutor</span>&lt;<span class="title">R</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ‰§è¡Œè¯·æ±‚</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> delegate å§”æ‰˜çš„ EurekaHttpClient</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> å“åº”</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span></span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> è¯·æ±‚ç±»å‹</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function">RequestType <span class="title">getRequestType</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p>EurekaHttpClientDecorator çš„<strong>æ¯ä¸ªå®ç°ç±»å®ç°ä¸€ä¸ªç‰¹æ€§</strong>ï¼Œä»£ç éå¸¸éå¸¸éå¸¸æ¸…æ™°ã€‚</p><blockquote><p>FROM <a href="https://zh.wikipedia.org/wiki/%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå§”æ‰˜æ¨¡å¼ã€‹</a><br>å§”æ‰˜æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€é¡¹åŸºæœ¬æŠ€å·§ã€‚åœ¨å§”æ‰˜æ¨¡å¼ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¯¹è±¡å‚ä¸å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—è¯·æ±‚çš„å¯¹è±¡å°†è¯·æ±‚å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡æ¥å¤„ç†ã€‚å§”æ‰˜æ¨¡å¼æ˜¯ä¸€é¡¹åŸºæœ¬æŠ€å·§ï¼Œè®¸å¤šå…¶ä»–çš„æ¨¡å¼ï¼Œå¦‚çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯åœ¨æ›´ç‰¹æ®Šçš„åœºåˆé‡‡ç”¨äº†å§”æ‰˜æ¨¡å¼ã€‚å§”æ‰˜æ¨¡å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨èšåˆæ¥æ›¿ä»£ç»§æ‰¿ï¼Œå®ƒè¿˜ä½¿æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿmixinã€‚</p></blockquote><p>æˆ‘ä»¬åœ¨ä¸Šå›¾çš„åŸºç¡€ä¸Šï¼Œ<strong>å¢åŠ å§”æ‰˜çš„å…³ç³»</strong>ï¼Œå¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/03.jpeg">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/03.jpeg" alt=""></p><ul><li>è¯·æ³¨æ„ï¼Œæ¯ä¸ªå§”æ‰˜ç€å®ç°ç±»ï¼Œä¸Šé¢å¯èƒ½æœ‰ç±»å‹ä¸º EurekaHttpClientFactory çš„å±æ€§ï¼Œç”¨äºåˆ›å»ºå…¶å§”æ‰˜çš„ EurekaHttpClient ã€‚<strong>ä¸ºä»€ä¹ˆä¼šæœ‰ Factory</strong> ï¼Ÿä¾‹å¦‚ï¼ŒRetryableEurekaHttpClient é‡è¯•è¯·æ±‚å¤šä¸ª Eureka-Server åœ°å€æ—¶ï¼Œæ¯ä¸ª Eureka-Server åœ°å€ä¼šåˆ›å»ºä¸€ä¸ª EurekaHttpClient ã€‚æ‰€ä»¥ï¼Œä¸‹æ–‡æ¶‰åŠåˆ° EurekaHttpClientFactory å’Œ<strong>å§”æ‰˜çš„</strong> EurekaHttpClient çš„åœ°æ–¹ï¼Œä½ éƒ½éœ€è¦ä»”ç»†ç†è§£ã€‚</li></ul><h2>5.1 MetricsCollectingEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.MetricsCollectingEurekaHttpClient</code> ï¼Œç›‘æ§æŒ‡æ ‡æ”¶é›† EurekaHttpClient ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p><p><code>#execute()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾— è¯·æ±‚ç±»å‹ çš„ è¯·æ±‚æŒ‡æ ‡</span></div><div class="line"> <span class="number">4</span>:     EurekaHttpClientRequestMetrics requestMetrics = metricsByRequestType.get(requestExecutor.getRequestType());</div><div class="line"> <span class="number">5</span>:     Stopwatch stopwatch = requestMetrics.latencyTimer.start();</div><div class="line"> <span class="number">6</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></div><div class="line"> <span class="number">8</span>:         EurekaHttpResponse&lt;R&gt; httpResponse = requestExecutor.execute(delegate);</div><div class="line"> <span class="number">9</span>:         <span class="comment">// å¢åŠ  è¯·æ±‚æŒ‡æ ‡</span></div><div class="line"><span class="number">10</span>:         requestMetrics.countersByStatus.get(mappedStatus(httpResponse)).increment();</div><div class="line"><span class="number">11</span>:         <span class="keyword">return</span> httpResponse;</div><div class="line"><span class="number">12</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">13</span>:         requestMetrics.connectionErrors.increment();</div><div class="line"><span class="number">14</span>:         exceptionsMetric.count(e);</div><div class="line"><span class="number">15</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">17</span>:         stopwatch.stop();</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ <code>RequestExecutor#execute(...)</code> æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚<ul><li><code>delegate</code> å±æ€§ï¼Œå¯¹åº” JerseyApplicationClient ã€‚</li></ul></li></ul><h2>5.2 RedirectingEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.RedirectingEurekaHttpClient</code> ï¼Œ<strong>å¯»æ‰¾é 302 é‡å®šå‘</strong>çš„ Eureka-Server çš„ EurekaHttpClient ã€‚</p><p><code>#execute()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     EurekaHttpClient currentEurekaClient = delegateRef.get();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (currentEurekaClient == <span class="keyword">null</span>) &#123; <span class="comment">// æœªæ‰¾åˆ°é 302 çš„ Eureka-Server</span></div><div class="line"> <span class="number">5</span>:         AtomicReference&lt;EurekaHttpClient&gt; currentEurekaClientRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(factory.newClient(serviceEndpoint));</div><div class="line"> <span class="number">6</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:             EurekaHttpResponse&lt;R&gt; response = executeOnNewServer(requestExecutor, currentEurekaClientRef);</div><div class="line"> <span class="number">8</span>:             <span class="comment">// å…³é—­åŸæœ‰çš„å§”æ‰˜ EurekaHttpClient ï¼Œå¹¶è®¾ç½®å½“å‰æˆåŠŸé 302 è¯·æ±‚çš„ EurekaHttpClient</span></div><div class="line"> <span class="number">9</span>:             TransportUtils.shutdown(delegateRef.getAndSet(currentEurekaClientRef.get()));</div><div class="line"><span class="number">10</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">11</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">12</span>:             logger.error(<span class="string">"Request execution error"</span>, e);</div><div class="line"><span class="number">13</span>:             TransportUtils.shutdown(currentEurekaClientRef.get());</div><div class="line"><span class="number">14</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// å·²ç»æ‰¾åˆ°é 302 çš„ Eureka-Server</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">return</span> requestExecutor.execute(currentEurekaClient);</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">20</span>:             logger.error(<span class="string">"Request execution error"</span>, e);</div><div class="line"><span class="number">21</span>:             delegateRef.compareAndSet(currentEurekaClient, <span class="keyword">null</span>);</div><div class="line"><span class="number">22</span>:             currentEurekaClient.shutdown();</div><div class="line"><span class="number">23</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼šå’Œæˆ‘ä»¬ç†è§£çš„å¸¸è§„çš„ 302 çŠ¶æ€è¿”å›å¤„ç†ä¸åŒï¼ï¼ï¼</li><li>æ•´ä¸ªåˆ†æˆä¸¤éƒ¨åˆ†ï¼šã€ç¬¬ 4 è‡³ 15 è¡Œã€‘ã€ã€ç¬¬ 16 è‡³ 24 è¡Œã€‘ã€‚<ul><li>å‰è€…ï¼Œæ„å‘³ç€æœªæ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œæ­¤æ—¶é€šè¿‡åœ¨åŸå§‹ä¼ é€’è¿›æ¥çš„ <code>serviceUrls</code> æ‰§è¡Œè¯·æ±‚ï¼Œå¯»æ‰¾é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Serverã€‚<ul><li>å½“è¿”å›é 302 çŠ¶æ€ç æ—¶ï¼Œæ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ã€‚</li><li>å½“è¿”å› 302 çŠ¶æ€ç æ—¶ï¼Œå‘æ–°çš„é‡å®šå‘çš„ Eureka-Server æ‰§è¡Œè¯·æ±‚ç›´åˆ°æˆåŠŸæ‰¾åˆ°æˆ–è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚</li></ul></li><li>åè€…ï¼Œæ„å‘³ç€å½“å‰å·²ç»æ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚ã€‚<strong>æ³¨æ„</strong> ï¼šæ­¤æ—¶ Eureka-Server å†è¿”å› 302 çŠ¶æ€ç ï¼Œä¸å†å¤„ç†ã€‚</li><li>ç›®å‰ Eureka 1.x çš„ Eureka-Server ä¸å­˜åœ¨è¿”å› 302 çŠ¶æ€ç ï¼ŒçŒœæµ‹å’Œ Eureka 2.X TODO[0028]ï¼šå†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤ æœ‰å…³ã€‚</li></ul></li><li>ã€å‰è€…ã€‘ç¬¬ 5 è¡Œ ï¼šä½¿ç”¨åˆå§‹çš„ <code>serviceEndpoint</code> ( ç›¸å½“äº <code>serviceUrls</code> ) åˆ›å»º<strong>å§”æ‰˜</strong> EurekaHttpClient ã€‚</li><li>ã€å‰è€…ã€‘ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>#executeOnNewServer(...)</code> æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œè¯·æ±‚çš„æ–¹å¼ï¼Œå¯»æ‰¾é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Serverã€‚å®ç°ä»£ç ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/ed9a4241e60e3b558f939754f71188d3063771e2/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RedirectingEurekaHttpClient.java#L111" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ä»£ç å®ç°ã€‚</li><li>ã€å‰è€…ã€‘ã€å‰è€…ã€‘ç¬¬ 9 è¡Œ ï¼šå…³é—­åŸæœ‰çš„ <code>delegateRef</code> ( å› ä¸ºæ­¤å¤„å¯èƒ½å­˜åœ¨å¹¶å‘ï¼Œå¤šä¸ªçº¿ç¨‹éƒ½æ‰¾åˆ°é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Server )ï¼Œå¹¶è®¾ç½®å½“å‰æˆåŠŸé 302 è¯·æ±‚çš„ EurekaHttpClient åˆ° <code>delegateRef</code>ã€‚</li><li>ã€å‰è€…ã€‘ç¬¬ 13 è¡Œ ï¼šå…³é—­ <code>currentEurekaClientRef</code> ï¼Œå½“è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æˆ–è€…è¶…è¿‡æœ€å¤§é‡å®šå‘æ¬¡æ•°ã€‚</li><li>ã€åè€…ã€‘ç¬¬ 18 è¡Œ ï¼šæ„å‘³ç€å½“å‰å·²ç»æ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚ã€‚</li><li>ã€åè€…ã€‘ç¬¬ 21 è‡³ 22 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚å‘ç”Ÿå¼‚å¸¸ï¼Œå…³é—­ <code>currentEurekaClient</code> ï¼Œåé¢è¦é‡æ–°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ã€‚</li></ul><h3>5.2.1 å·¥å‚</h3><p>RedirectingEurekaHttpClient æä¾› <code>#createFactory(...)</code> <strong>é™æ€æ–¹æ³•</strong>è·å¾—åˆ›å»ºå…¶çš„å·¥å‚ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/ed9a4241e60e3b558f939754f71188d3063771e2/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RedirectingEurekaHttpClient.java#L96" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h2>5.3 RetryableEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.RetryableEurekaHttpClient</code> ï¼Œæ”¯æŒå‘å¤šä¸ª Eureka-Server è¯·æ±‚é‡è¯•çš„ EurekaHttpClient ã€‚</p><p><code>#execute()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     List&lt;EurekaEndpoint&gt; candidateHosts = <span class="keyword">null</span>;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">int</span> endpointIdx = <span class="number">0</span>;</div><div class="line"> <span class="number">5</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> retry = <span class="number">0</span>; retry &lt; numberOfRetries; retry++) &#123;</div><div class="line"> <span class="number">6</span>:         EurekaHttpClient currentHttpClient = delegate.get();</div><div class="line"> <span class="number">7</span>:         EurekaEndpoint currentEndpoint = <span class="keyword">null</span>;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:         <span class="comment">// å½“å‰å§”æ‰˜çš„ EurekaHttpClient ä¸å­˜åœ¨</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (currentHttpClient == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">11</span>:             <span class="comment">// è·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„</span></div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (candidateHosts == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">13</span>:                 candidateHosts = getHostCandidates();</div><div class="line"><span class="number">14</span>:                 <span class="keyword">if</span> (candidateHosts.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:                     <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"There is no known eureka server; cluster server list is empty"</span>);</div><div class="line"><span class="number">16</span>:                 &#125;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:             <span class="comment">// è¶…è¿‡å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„ä¸Šé™</span></div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (endpointIdx &gt;= candidateHosts.size()) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"Cannot execute request on any known server"</span>);</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:             <span class="comment">// åˆ›å»ºå€™é€‰çš„ EurekaHttpClient</span></div><div class="line"><span class="number">25</span>:             currentEndpoint = candidateHosts.get(endpointIdx++);</div><div class="line"><span class="number">26</span>:             currentHttpClient = clientFactory.newClient(currentEndpoint);</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">30</span>:             <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></div><div class="line"><span class="number">31</span>:             EurekaHttpResponse&lt;R&gt; response = requestExecutor.execute(currentHttpClient);</div><div class="line"><span class="number">32</span>:             <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¯æ¥å—çš„ç›¸åº”ï¼Œè‹¥æ˜¯ï¼Œè¿”å›ã€‚</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">if</span> (serverStatusEvaluator.accept(response.getStatusCode(), requestExecutor.getRequestType())) &#123;</div><div class="line"><span class="number">34</span>:                 delegate.set(currentHttpClient);</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (retry &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:                     logger.info(<span class="string">"Request execution succeeded on retry #&#123;&#125;"</span>, retry);</div><div class="line"><span class="number">37</span>:                 &#125;</div><div class="line"><span class="number">38</span>:                 <span class="keyword">return</span> response;</div><div class="line"><span class="number">39</span>:             &#125;</div><div class="line"><span class="number">40</span>:             logger.warn(<span class="string">"Request execution failure with status code &#123;&#125;; retrying on another server if available"</span>, response.getStatusCode());</div><div class="line"><span class="number">41</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">42</span>:             logger.warn(<span class="string">"Request execution failed with message: &#123;&#125;"</span>, e.getMessage());  <span class="comment">// just log message as the underlying client should log the stacktrace</span></div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         <span class="comment">// è¯·æ±‚å¤±è´¥ï¼Œè‹¥æ˜¯ currentHttpClient ï¼Œæ¸…é™¤ delegate</span></div><div class="line"><span class="number">46</span>:         <span class="comment">// Connection error or 5xx from the server that must be retried on another server</span></div><div class="line"><span class="number">47</span>:         delegate.compareAndSet(currentHttpClient, <span class="keyword">null</span>);</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:         <span class="comment">// è¯·æ±‚å¤±è´¥ï¼Œå°† currentEndpoint æ·»åŠ åˆ°éš”ç¦»é›†åˆ</span></div><div class="line"><span class="number">50</span>:         <span class="keyword">if</span> (currentEndpoint != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">51</span>:             quarantineSet.add(currentEndpoint);</div><div class="line"><span class="number">52</span>:         &#125;</div><div class="line"><span class="number">53</span>:     &#125;</div><div class="line"><span class="number">54</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"Retry limit reached; giving up on completing the request"</span>);</div><div class="line"><span class="number">55</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 10 è¡Œ ï¼šå½“å‰ <code>currentHttpClient</code> ä¸å­˜åœ¨ï¼Œæ„å‘³ç€åŸæœ‰ <code>delegate</code> ä¸å­˜åœ¨å‘ Eureka-Server æˆåŠŸè¯·æ±‚çš„ EurekaHttpClient ã€‚</p><ul><li>æ­¤æ—¶éœ€è¦ä»é…ç½®ä¸­çš„ Eureka-Server æ•°ç»„é‡è¯•è¯·æ±‚ï¼Œè·å¾—å¯ä»¥è¯·æ±‚çš„ Eureka-Server ã€‚</li><li>å¦‚æœå·²ç»å­˜åœ¨è¯·æ±‚æˆåŠŸçš„ <code>delegate</code> ï¼Œç›´æ¥ä½¿ç”¨å®ƒè¿›è¡Œæ‰§è¡Œè¯·æ±‚ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 17 è¡Œ ï¼šè°ƒç”¨ <code>#getHostCandidates()</code> æ–¹æ³•ï¼Œè·å¾—å€™é€‰çš„ Eureka-Server <code>serviceUrls</code> æ•°ç»„ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> List&lt;EurekaEndpoint&gt; <span class="title">getHostCandidates</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„</span></div><div class="line"> <span class="number">3</span>:     List&lt;EurekaEndpoint&gt; candidateHosts = clusterResolver.getClusterEndpoints();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">// ä¿ç•™äº¤é›†ï¼ˆç§»é™¤ quarantineSet ä¸åœ¨ candidateHosts çš„å…ƒç´ ï¼‰</span></div><div class="line"> <span class="number">6</span>:     quarantineSet.retainAll(candidateHosts);</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// åœ¨ä¿è¯æœ€å°å¯ç”¨çš„å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„ï¼Œç§»é™¤åœ¨éš”ç¦»é›†åˆå†…çš„å…ƒç´ </span></div><div class="line"> <span class="number">9</span>:     <span class="comment">// If enough hosts are bad, we have no choice but start over again</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">int</span> threshold = (<span class="keyword">int</span>) (candidateHosts.size() * transportConfig.getRetryableClientQuarantineRefreshPercentage()); <span class="comment">// 0.66</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (quarantineSet.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// no-op</span></div><div class="line"><span class="number">13</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (quarantineSet.size() &gt;= threshold) &#123;</div><div class="line"><span class="number">14</span>:         logger.debug(<span class="string">"Clearing quarantined list of size &#123;&#125;"</span>, quarantineSet.size());</div><div class="line"><span class="number">15</span>:         quarantineSet.clear();</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">17</span>:         List&lt;EurekaEndpoint&gt; remainingHosts = <span class="keyword">new</span> ArrayList&lt;&gt;(candidateHosts.size());</div><div class="line"><span class="number">18</span>:         <span class="keyword">for</span> (EurekaEndpoint endpoint : candidateHosts) &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (!quarantineSet.contains(endpoint)) &#123;</div><div class="line"><span class="number">20</span>:                 remainingHosts.add(endpoint);</div><div class="line"><span class="number">21</span>:             &#125;</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:         candidateHosts = remainingHosts;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> candidateHosts;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>ClusterResolver#getClusterEndpoints()</code> æ–¹æ³•ï¼Œè·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„( <code>candidateHosts</code> )ã€‚<strong>æ³¨æ„</strong>ï¼šè¯¥æ–¹æ³•è¿”å›çš„ Eureka-Server åœ°å€æ•°ç»„ï¼Œä½¿ç”¨ä»¥æœ¬æœº IP ä¸º<strong>éšæœºç§å­</strong>ï¼Œè¾¾åˆ°ä¸åŒ IP çš„åº”ç”¨å®ä¾‹è·å¾—çš„æ•°ç»„é¡ºåºä¸åŒï¼Œè€Œç›¸åŒ IP çš„åº”ç”¨å®ä¾‹è·å¾—çš„æ•°ç»„é¡ºåºä¸€è‡´ï¼Œ<strong>æ•ˆæœç±»ä¼¼åŸºäº IP HASH çš„è´Ÿè½½å‡è¡¡ç®—æ³•</strong>ã€‚å®ç°è¯¥åŠŸèƒ½çš„ä»£ç ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/?self">ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹æœç´¢å…³é”®å­—ã€ResolverUtils#randomize(...)ã€‘</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>Set#retainAll()</code> æ–¹æ³•ï¼Œç§»é™¤éš”ç¦»çš„æ•…éšœ Eureka-Server åœ°å€æ•°ç»„( <code>quarantineSet</code> ) ä¸­ä¸åœ¨ <code>candidateHosts</code> çš„å…ƒç´ ã€‚</li><li>ç¬¬ 8 è‡³ 24 è¡Œ ï¼šåœ¨ä¿è¯æœ€å°å¯ç”¨çš„ <code>candidateHosts</code>ï¼Œç§»é™¤åœ¨ <code>quarantineSet</code> çš„å…ƒç´ ã€‚<ul><li>ç¬¬ 10 è¡Œ ï¼šæœ€å°å¯ç”¨çš„é˜€å€¼ï¼Œé…ç½® <code>eureka.retryableClientQuarantineRefreshPercentage</code> æ¥è®¾ç½®ç™¾åˆ†æ¯”ï¼Œé»˜è®¤å€¼ï¼š<code>0.66</code> ã€‚</li><li>æœ€ 13 è‡³ 15 è¡Œ ï¼š<code>quarantineSet</code> æ•°é‡è¶…è¿‡é˜€å€¼ï¼Œæ¸…ç©º <code>quarantineSet</code> ï¼Œå…¨éƒ¨ <code>candidateHosts</code> é‡è¯•ã€‚</li><li>ç¬¬ 17 è‡³ 24 è¡Œ ï¼š<code>quarantineSet</code> æ•°é‡æœªè¶…è¿‡é˜€å€¼ï¼Œç§»é™¤ <code>candidateHosts</code> ä¸­åœ¨ <code>quarantineSet</code> çš„å…ƒç´ ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 19 è‡³ 22 è¡Œ ï¼šè¶…è¿‡ <code>candidateHosts</code> ä¸Šé™ï¼Œå…¨éƒ¨ Eureka-Server è¯·æ±‚å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p></li><li><p>ç¬¬ 24 è‡³ 26 è¡Œ ï¼šåˆ›å»ºå§”æ‰˜çš„ EurekaHttpClient ï¼Œç”¨äºä¸‹é¢è¯·æ±‚æ‰§è¡Œã€‚</p></li><li><p>ç¬¬ 31 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚ã€‚</p></li><li><p>ç¬¬ 33 è¡Œ ï¼šè°ƒç”¨ <code>ServerStatusEvaluator#accept()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å“åº”çŠ¶æ€ç å’Œè¯·æ±‚ç±»å‹æ˜¯å¦èƒ½å¤Ÿæ¥å—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerStatusEvaluators.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ServerStatusEvaluator LEGACY_EVALUATOR = <span class="keyword">new</span> ServerStatusEvaluator() &#123;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> statusCode, RequestType requestType)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (statusCode &gt;= <span class="number">200</span> &amp;&amp; statusCode &lt; <span class="number">300</span> || statusCode == <span class="number">302</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.Register &amp;&amp; statusCode == <span class="number">404</span>) &#123; <span class="comment">// æ³¨å†Œï¼Œ404 å¯æ¥å—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.SendHeartBeat &amp;&amp; statusCode == <span class="number">404</span>) &#123; <span class="comment">// å¿ƒè·³ï¼Œ404 å¯æ¥å—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.Cancel) &#123;  <span class="comment">// cancel is best effort ä¸‹çº¿ï¼Œæ¥å—å…¨éƒ¨</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.GetDelta &amp;&amp; (statusCode == <span class="number">403</span> || statusCode == <span class="number">404</span>)) &#123; <span class="comment">// å¢é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œ403 404 å¯æ¥å—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 34 è¡Œ ï¼šè¯·æ±‚æˆåŠŸï¼Œè®¾ç½® <code>delegate</code> ã€‚ä¸‹æ¬¡è¯·æ±‚ï¼Œä¼˜å…ˆä½¿ç”¨ <code>delegate</code> ï¼Œå¤±è´¥æ‰è¿›è¡Œå€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„é‡è¯•ã€‚</p></li><li><p>ç¬¬ 47 è¡Œ ï¼šè¯·æ±‚å¤±è´¥ï¼Œ<code>delegate</code> è‹¥ç­‰äº <code>currentHttpClient</code> ï¼Œè¿›è¡Œæ¸…é™¤ã€‚</p></li><li><p>ç¬¬ 50 è‡³ 52 è¡Œ ï¼šè¯·æ±‚å¤±è´¥ï¼Œå°†è¯·æ±‚çš„ Eureka-Server åœ°å€æ·»åŠ åˆ° <code>quarantineSet</code> ã€‚</p></li><li><p>æ€»ç»“æ¥è¯´ï¼š</p><ul><li>ã€ç¬¬ä¸€æ­¥ã€‘è‹¥å½“å‰æœ‰è¯·æ±‚æˆåŠŸçš„ EurekaHttpClient ï¼Œç»§ç»­ä½¿ç”¨ã€‚è‹¥è¯·æ±‚å¤±è´¥ï¼Œæ‰§è¡Œã€ç¬¬äºŒæ­¥ã€‘ã€‚</li><li>ã€ç¬¬äºŒæ­¥ã€‘è‹¥å½“å‰æ— è¯·æ±‚æˆåŠŸçš„ EurekaHttpClient ï¼Œè·å–å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„<strong>é¡ºåº</strong>åˆ›å»ºæ–°çš„ EurekaHttpClientï¼Œç›´åˆ°æˆåŠŸï¼Œæˆ–è€…è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚å½“è¯·æ±‚æˆåŠŸï¼Œä¿å­˜è¯¥ EurekaHttpClient ï¼Œä¸‹æ¬¡ç»§ç»­ä½¿ç”¨ï¼Œç›´åˆ°è¯·æ±‚å¤±è´¥ã€‚</li></ul></li></ul><h3>5.3.1 å·¥å‚</h3><p>RetryableEurekaHttpClient æä¾› <code>#createFactory(...)</code> <strong>é™æ€æ–¹æ³•</strong>è·å¾—åˆ›å»ºå…¶çš„å·¥å‚ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RetryableEurekaHttpClient.java#L135" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h2>5.4 SessionedEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.SessionedEurekaHttpClient</code> ï¼Œæ”¯æŒä¼šè¯çš„ EurekaHttpClient ã€‚æ‰§è¡Œå®šæœŸçš„é‡å»ºä¼šè¯ï¼Œé˜²æ­¢ä¸€ä¸ª Eureka-Client æ°¸è¿œåªè¿æ¥ä¸€ä¸ªç‰¹å®šçš„ Eureka-Server ã€‚åè¿‡æ¥ï¼Œè¿™ä¹Ÿä¿è¯äº† Eureka-Server é›†ç¾¤å˜æ›´æ—¶ï¼ŒEureka-Client å¯¹ Eureka-Server è¿æ¥çš„è´Ÿè½½å‡è¡¡ã€‚</p><p><code>#execute(...)</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">long</span> delay = now - lastReconnectTimeStamp;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// è¶…è¿‡ å½“å‰ä¼šè¯æ—¶é—´ï¼Œå…³é—­å½“å‰å§”æ‰˜çš„ EurekaHttpClient ã€‚</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (delay &gt;= currentSessionDurationMs) &#123;</div><div class="line"> <span class="number">8</span>:         logger.debug(<span class="string">"Ending a session and starting anew"</span>);</div><div class="line"> <span class="number">9</span>:         lastReconnectTimeStamp = now;</div><div class="line"><span class="number">10</span>:         currentSessionDurationMs = randomizeSessionDuration(sessionDurationMs);</div><div class="line"><span class="number">11</span>:         TransportUtils.shutdown(eurekaHttpClientRef.getAndSet(<span class="keyword">null</span>));</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="comment">// è·å¾—å§”æ‰˜çš„ EurekaHttpClient ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°çš„å§”æ‰˜çš„ EurekaHttpClient ã€‚</span></div><div class="line"><span class="number">15</span>:     EurekaHttpClient eurekaHttpClient = eurekaHttpClientRef.get();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (eurekaHttpClient == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">17</span>:         eurekaHttpClient = TransportUtils.getOrSetAnotherClient(eurekaHttpClientRef, clientFactory.newClient());</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>:     <span class="keyword">return</span> requestExecutor.execute(eurekaHttpClient);</div><div class="line"><span class="number">20</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 7 è‡³ 12 è¡Œ ï¼šè¶…è¿‡å½“å‰ä¼šè¯æ—¶é—´ï¼Œå…³é—­å½“å‰å§”æ‰˜çš„ EurekaHttpClient ã€‚</p><ul><li><p>ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ <code>#randomizeSessionDuration(...)</code> æ–¹æ³•ï¼Œè®¡ç®—è®¡ç®—ä¸‹ä¸€æ¬¡ä¼šè¯è¶…æ—¶æ—¶é•¿ï¼Œå…¬å¼ä¸º <code>sessionDurationMs * (0.5, 1.5)</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">randomizeSessionDuration</span><span class="params">(<span class="keyword">long</span> sessionDurationMs)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> delta = (<span class="keyword">long</span>) (sessionDurationMs * (random.nextDouble() - <span class="number">0.5</span>));</div><div class="line">   <span class="keyword">return</span> sessionDurationMs + delta;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å¢åŠ ä¼šè¯è¿‡æœŸçš„éšæœºæ€§ï¼Œå®ç°æ‰€æœ‰ Eureka-Client çš„ä¼šè¯è¿‡æœŸé‡è¿çš„å‘ç”Ÿæ—¶é—´æ›´åŠ ç¦»æ•£ï¼Œé¿å…é›†ä¸­æ—¶é—´è¿‡æœŸã€‚ç›®å‰çŒœæµ‹è¿™ä¹ˆåšçš„ç›®çš„å’Œ TODO[0028]ï¼šå†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤ æœ‰å…³ï¼Œå³è¿”å› 302 ã€‚å…³è” <a href="https://github.com/Netflix/eureka/pull/687" rel="external nofollow noopener noreferrer" target="_blank">1.x new transport enhancements</a> ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 15 è‡³ 18 è¡Œ ï¼šè·å¾—å§”æ‰˜çš„ EurekaHttpClient ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„å§”æ‰˜çš„ EurekaHttpClient ã€‚<code>TransportUtils#getOrSetAnotherClient(...)</code> æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClient <span class="title">getOrSetAnotherClient</span><span class="params">(AtomicReference&lt;EurekaHttpClient&gt; eurekaHttpClientRef, EurekaHttpClient another)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     EurekaHttpClient existing = eurekaHttpClientRef.get();</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ä¸ºç©ºæ‰è®¾ç½®</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (eurekaHttpClientRef.compareAndSet(<span class="keyword">null</span>, another)) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">return</span> another;</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// è®¾ç½®å¤±è´¥ï¼Œæ„å‘³ç€å¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç»è®¾ç½®</span></div><div class="line"> <span class="number">8</span>:     another.shutdown();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">return</span> existing;</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¯¥æ–¹æ³•å®ç°ï¼Œè·å¾— <code>eurekaHttpClientRef</code> é‡Œçš„ EurekaHttpClient ã€‚è‹¥è·å–ä¸åˆ°ï¼Œå°† <code>another</code> è®¾ç½®åˆ° <code>eurekaHttpClientRef</code> ã€‚å½“æœ‰å¤šä¸ªçº¿ç¨‹è®¾ç½®æ—¶ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆåŠŸï¼Œå¦å¤–çš„è®¾ç½®å¤±è´¥çš„çº¿ç¨‹ä»¬ï¼Œæ„å‘³ç€å½“å‰ <code>eurekaHttpClientRef</code> æœ‰ EurekaHttpClient ï¼Œè¿”å› <code>eurekaHttpClientRef</code> ã€‚</p></li><li><p>ç›®å‰è¯¥æ–¹æ³•å­˜åœ¨ BUG ï¼Œå¤±è´¥çš„çº¿ç¨‹ç›´æ¥è¿”å› <code>existing</code> çš„æ˜¯ <code>null</code> ï¼Œéœ€è¦ä¿®æ”¹æˆ <code>return eurekaHttpClientRef.get()</code> ã€‚æ¨¡æ‹Ÿé‡ç°è¯¥ BUG ä»£ç å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/04.png" alt=""></p></li></ul></li><li><p>ç¬¬ 19 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚ã€‚</p></li></ul><h3>5.4.1 æ²¡æœ‰å·¥å‚</h3><p>åœ¨ SessionedEurekaHttpClient ç±»é‡Œï¼Œæ²¡æœ‰å®ç°åˆ›å»ºå…¶çš„å·¥å‚ã€‚åœ¨ <a href="#">ã€Œ6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯ã€æœç´¢ <code>canonicalClientFactory</code></a> ï¼Œå¯ä»¥çœ‹åˆ° <code>EurekaHttpClients#canonicalClientFactory(...)</code> æ–¹æ³•ï¼Œå†…éƒ¨æœ‰ SessionedEurekaHttpClient çš„åˆ›å»ºå·¥å‚ã€‚</p><h1>6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯</h1><p>å¯¹äº Eureka-Server æ¥è¯´ï¼Œè°ƒç”¨ <code>JerseyReplicationClient#createReplicationClient(...)</code> <strong>é™æ€æ–¹æ³•</strong>å³å¯åˆ›å»ºç”¨äº Eureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ <strong>å…¶å®ƒçš„Eureka-Server</strong> çš„ç½‘ç»œé€šä¿¡å®¢æˆ·ç«¯ã€‚</p><p>å¯¹äº Eureka-Client æ¥è¯´ï¼Œåˆ†æˆç”¨äº<strong>æ³¨å†Œåº”ç”¨å®ä¾‹( <code>registrationClient</code> )<strong>å’Œ</strong>æŸ¥è¯¢æ³¨å†Œä¿¡æ¯( <code>newQueryClient</code> )<strong>çš„</strong>ä¸¤ä¸ªä¸åŒ</strong>ç½‘ç»œé€šä¿¡å®¢æˆ·ç«¯ã€‚åœ¨ DiscoveryClient åˆå§‹åŒ–æ—¶è¿›è¡Œåˆ›å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.class</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleServerEndpointTask</span><span class="params">(EurekaTransport eurekaTransport,</span></span></div><div class="line"><span class="function"><span class="params">  <span class="number">2</span>:                                         AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:         </div><div class="line">  <span class="number">4</span>:     Collection&lt;?&gt; additionalFilters = args == <span class="keyword">null</span></div><div class="line">  <span class="number">5</span>:             ? Collections.emptyList()</div><div class="line">  <span class="number">6</span>:             : args.additionalFilters;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     EurekaJerseyClient providedJerseyClient = args == <span class="keyword">null</span></div><div class="line">  <span class="number">9</span>:             ? <span class="keyword">null</span></div><div class="line"> <span class="number">10</span>:             : args.eurekaJerseyClient;</div><div class="line"> <span class="number">11</span>:     </div><div class="line"> <span class="number">12</span>:     TransportClientFactories argsTransportClientFactories = <span class="keyword">null</span>;</div><div class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.getTransportClientFactories() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">14</span>:         argsTransportClientFactories = args.getTransportClientFactories();</div><div class="line"> <span class="number">15</span>:     &#125;</div><div class="line"> <span class="number">16</span>:     </div><div class="line"> <span class="number">17</span>:     <span class="comment">// Ignore the raw types warnings since the client filter interface changed between jersey 1/2</span></div><div class="line"> <span class="number">18</span>:     <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line"> <span class="number">19</span>:     TransportClientFactories transportClientFactories = argsTransportClientFactories == <span class="keyword">null</span></div><div class="line"> <span class="number">20</span>:             ? <span class="keyword">new</span> Jersey1TransportClientFactories()</div><div class="line"> <span class="number">21</span>:             : argsTransportClientFactories;</div><div class="line"> <span class="number">22</span>: </div><div class="line"> <span class="number">23</span>:     <span class="comment">// If the transport factory was not supplied with args, assume they are using jersey 1 for passivity</span></div><div class="line"> <span class="number">24</span>:     <span class="comment">// noinspection unchecked</span></div><div class="line"> <span class="number">25</span>:     eurekaTransport.transportClientFactory = providedJerseyClient == <span class="keyword">null</span></div><div class="line"> <span class="number">26</span>:             ? transportClientFactories.newTransportClientFactory(clientConfig, additionalFilters, applicationInfoManager.getInfo())</div><div class="line"> <span class="number">27</span>:             : transportClientFactories.newTransportClientFactory(additionalFilters, providedJerseyClient);</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:     <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰åˆå§‹åŒ– åº”ç”¨è§£æå™¨çš„åº”ç”¨å®ä¾‹æ•°æ®æº TODO[0028]å†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤</span></div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:     <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰åˆ›å»º EndPoint è§£æå™¨</span></div><div class="line"> <span class="number">32</span>:     eurekaTransport.bootstrapResolver = EurekaHttpClients.newBootstrapResolver(...)</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:     <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line"> <span class="number">35</span>:         EurekaHttpClientFactory newRegistrationClientFactory = <span class="keyword">null</span>;</div><div class="line"> <span class="number">36</span>:         EurekaHttpClient newRegistrationClient = <span class="keyword">null</span>;</div><div class="line"> <span class="number">37</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">38</span>:             newRegistrationClientFactory = EurekaHttpClients.registrationClientFactory(</div><div class="line"> <span class="number">39</span>:                     eurekaTransport.bootstrapResolver,</div><div class="line"> <span class="number">40</span>:                     eurekaTransport.transportClientFactory,</div><div class="line"> <span class="number">41</span>:                     transportConfig</div><div class="line"> <span class="number">42</span>:             );</div><div class="line"> <span class="number">43</span>:             newRegistrationClient = newRegistrationClientFactory.newClient();</div><div class="line"> <span class="number">44</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">45</span>:             logger.warn(<span class="string">"Transport initialization failure"</span>, e);</div><div class="line"> <span class="number">46</span>:         &#125;</div><div class="line"> <span class="number">47</span>:         eurekaTransport.registrationClientFactory = newRegistrationClientFactory;</div><div class="line"> <span class="number">48</span>:         eurekaTransport.registrationClient = newRegistrationClient;</div><div class="line"> <span class="number">49</span>:     &#125;</div><div class="line"> <span class="number">50</span>: </div><div class="line"> <span class="number">51</span>:     <span class="comment">// new method (resolve from primary servers for read)</span></div><div class="line"> <span class="number">52</span>:     <span class="comment">// Configure new transport layer (candidate for injecting in the future)</span></div><div class="line"> <span class="number">53</span>:     <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line"> <span class="number">54</span>:         EurekaHttpClientFactory newQueryClientFactory = <span class="keyword">null</span>;</div><div class="line"> <span class="number">55</span>:         EurekaHttpClient newQueryClient = <span class="keyword">null</span>;</div><div class="line"> <span class="number">56</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">57</span>:             newQueryClientFactory = EurekaHttpClients.queryClientFactory(</div><div class="line"> <span class="number">58</span>:                     eurekaTransport.bootstrapResolver,</div><div class="line"> <span class="number">59</span>:                     eurekaTransport.transportClientFactory,</div><div class="line"> <span class="number">60</span>:                     clientConfig,</div><div class="line"> <span class="number">61</span>:                     transportConfig,</div><div class="line"> <span class="number">62</span>:                     applicationInfoManager.getInfo(),</div><div class="line"> <span class="number">63</span>:                     applicationsSource</div><div class="line"> <span class="number">64</span>:             );</div><div class="line"> <span class="number">65</span>:             newQueryClient = newQueryClientFactory.newClient();</div><div class="line"> <span class="number">66</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">67</span>:             logger.warn(<span class="string">"Transport initialization failure"</span>, e);</div><div class="line"> <span class="number">68</span>:         &#125;</div><div class="line"> <span class="number">69</span>:         eurekaTransport.queryClientFactory = newQueryClientFactory;</div><div class="line"> <span class="number">70</span>:         eurekaTransport.queryClient = newQueryClient;</div><div class="line"> <span class="number">71</span>:     &#125;</div><div class="line"> <span class="number">72</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 18 è‡³ 27 è¡Œ ï¼šè°ƒç”¨ <code>Jersey1TransportClientFactories#newTransportClientFactory(...)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>registrationClient</code> å’Œ <code>queryClient</code> å…¬ç”¨çš„å§”æ‰˜çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Jersey1TransportClientFactories.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                              <span class="keyword">final</span> Collection&lt;ClientFilter&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                              <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span> </span>&#123;</div><div class="line">   <span class="comment">// JerseyEurekaHttpClientFactory</span></div><div class="line">   <span class="keyword">final</span> TransportClientFactory jerseyFactory = JerseyEurekaHttpClientFactory.create(</div><div class="line">           clientConfig,</div><div class="line">           additionalFilters,</div><div class="line">           myInstanceInfo,</div><div class="line">           <span class="keyword">new</span> EurekaClientIdentity(myInstanceInfo.getIPAddr())</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// TransportClientFactory</span></div><div class="line">   <span class="keyword">final</span> TransportClientFactory metricsFactory = MetricsCollectingEurekaHttpClient.createFactory(jerseyFactory); <span class="comment">// å§”æ‰˜ TransportClientFactory</span></div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TransportClientFactory() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> metricsFactory.newClient(serviceUrl);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">           metricsFactory.shutdown();</div><div class="line">           jerseyFactory.shutdown();</div><div class="line">       &#125;</div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ TransportClientFactory é‡Œ<strong>å§”æ‰˜</strong> JerseyEurekaHttpClientFactory ã€‚</li></ul></li><li><p>ç¬¬ 34 è‡³ 49 è¡Œ ï¼šè°ƒç”¨ <code>EurekaHttpClients#registrationClientFactory(...)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>registrationClient</code> çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClients.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClientFactory <span class="title">registrationClientFactory</span><span class="params">(ClusterResolver bootstrapResolver,</span></span></div><div class="line"><span class="function"><span class="params">                                                                TransportClientFactory transportClientFactory,</span></span></div><div class="line"><span class="function"><span class="params">                                                                EurekaTransportConfig transportConfig)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> canonicalClientFactory(EurekaClientNames.REGISTRATION, transportConfig, bootstrapResolver, transportClientFactory);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> EurekaHttpClientFactory <span class="title">canonicalClientFactory</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> EurekaTransportConfig transportConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> ClusterResolver&lt;EurekaEndpoint&gt; clusterResolver,</span></span></div><div class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> TransportClientFactory transportClientFactory)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> EurekaHttpClientFactory() &#123; <span class="comment">// SessionedEurekaHttpClientFactory</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SessionedEurekaHttpClient(</div><div class="line">                   name,</div><div class="line">                   RetryableEurekaHttpClient.createFactory( <span class="comment">// RetryableEurekaHttpClient</span></div><div class="line">                           name,</div><div class="line">                           transportConfig,</div><div class="line">                           clusterResolver,</div><div class="line">                           RedirectingEurekaHttpClient.createFactory(transportClientFactory), <span class="comment">// RedirectingEurekaHttpClient</span></div><div class="line">                           ServerStatusEvaluators.legacyEvaluator()),</div><div class="line">                   transportConfig.getSessionedClientReconnectIntervalSeconds() * <span class="number">1000</span></div><div class="line">           );</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">           wrapClosable(clusterResolver).shutdown();</div><div class="line">       &#125;</div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 51 è‡³ 71 è¡Œ ï¼šè°ƒç”¨ <code>EurekaHttpClients#queryClientFactory(...)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>queryClient</code> çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClients.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClientFactory <span class="title">queryClientFactory</span><span class="params">(ClusterResolver bootstrapResolver,</span></span></div><div class="line"><span class="function"><span class="params">                                                        TransportClientFactory transportClientFactory,</span></span></div><div class="line"><span class="function"><span class="params">                                                        EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                        EurekaTransportConfig transportConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                        InstanceInfo myInstanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                                        ApplicationsResolver.ApplicationsSource applicationsSource)</span> </span>&#123;</div><div class="line"></div><div class="line">   ClosableResolver queryResolver = transportConfig.useBootstrapResolverForQuery()</div><div class="line">           ? wrapClosable(bootstrapResolver)</div><div class="line">           : queryClientResolver(bootstrapResolver, transportClientFactory,</div><div class="line">           clientConfig, transportConfig, myInstanceInfo, applicationsSource);</div><div class="line">   <span class="keyword">return</span> canonicalClientFactory(EurekaClientNames.QUERY, transportConfig, queryResolver, transportClientFactory); <span class="comment">// è¯¥æ–¹æ³•ä¸Šé¢æœ‰</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>è¿™æ¬¡çœŸçš„æ˜¯å½©è›‹ï¼Œæˆ‘ä»¬å°†æ•´ä½“è°ƒç”¨å…³ç³»è°ƒæ•´å¦‚ä¸‹å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/05.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/05.png" alt=""></p><p>èƒ–å‹ï¼Œä½ å­¦ä¼šäº†ä¹ˆï¼Ÿ</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/transport/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨</title>
    <link href="http://www.iocoder.cn/Eureka/end-point-and-resolver/"/>
    <id>http://www.iocoder.cn/Eureka/end-point-and-resolver/</id>
    <published>2018-07-23T16:00:00.000Z</published>
    <updated>2017-10-16T11:13:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/end-point-and-resolver/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2. EndPoint</a><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2.1 EurekaEndpoint</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2.2 DefaultEndpoint</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2.3 AwsEndpoint</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3. è§£æå™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.1 ClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.2 ClosableResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.3 DnsTxtRecordClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.4 ConfigClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.5 ZoneAffinityClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.6 AsyncResolver</a><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.6.1 å®šæ—¶ä»»åŠ¡</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.6.2 è§£æ EndPoint é›†ç¾¤</a></li></ul></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">4. åˆå§‹åŒ–è§£æå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>EndPoint ä¸ è§£æå™¨</strong>ã€‚</p><ul><li>EndPoint ï¼ŒæœåŠ¡ç«¯ç‚¹ã€‚ä¾‹å¦‚ï¼ŒEureka-Server çš„è®¿é—®åœ°å€ã€‚</li><li>EndPoint è§£æå™¨ï¼Œå°†é…ç½®çš„ Eureka-Server çš„è®¿é—®åœ°å€è§£ææˆ EndPoint ã€‚</li></ul><p>ç›®å‰æœ‰å¤šç§ Eureka-Server è®¿é—®åœ°å€çš„é…ç½®æ–¹å¼ï¼Œ<strong>æœ¬æ–‡åªåˆ†äº« Eureka 1.x çš„é…ç½®</strong>ï¼Œä¸åŒ…å« Eureka 1.x å¯¹ Eureka 2.x çš„å…¼å®¹é…ç½®ï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼Œç›´æ¥é…ç½®å®é™…è®¿é—®åœ°å€ã€‚ä¾‹å¦‚ï¼Œ<code>eureka.serviceUrl.defaultZone=http://127.0.0.1:8080/v2</code> ã€‚</li><li>ç¬¬äºŒç§ï¼ŒåŸºäº DNS è§£æå‡ºè®¿é—®åœ°å€ã€‚ä¾‹å¦‚ï¼Œ<code>eureka.shouldUseDns=true</code> å¹¶ä¸”  <code>eureka.eurekaServer.domainName=eureka.iocoder.cn</code> ã€‚</li></ul><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.discovery.shared.resolver</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_24/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_24/01.png" alt=""></p><ul><li>çº¢è‰²éƒ¨åˆ† â€”â€” EndPoint</li><li>é»„è‰²éƒ¨åˆ† â€”â€” EndPoint è§£æå™¨</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EndPoint</h1><h2>2.1 EurekaEndpoint</h2><p><code>com.netflix.discovery.shared.resolver.EurekaEndpoint</code> ï¼ŒEureka æœåŠ¡ç«¯ç‚¹<strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEndpoint</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å®Œæ•´çš„æœåŠ¡ URL</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getServiceUrl</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use &#123;<span class="doctag">@link</span> #getNetworkAddress()&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    <span class="function">String <span class="title">getHostName</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ç½‘ç»œåœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getNetworkAddress</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦å®‰å…¨( https )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSecure</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ç›¸å¯¹è·¯å¾„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getRelativeUri</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>2.2 DefaultEndpoint</h2><p><code>com.netflix.discovery.shared.resolver.DefaultEndpoint</code> ï¼Œé»˜è®¤ Eureka æœåŠ¡ç«¯ç‚¹<strong>å®ç°ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEndpoint</span> <span class="keyword">implements</span> <span class="title">EurekaEndpoint</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç½‘ç»œåœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String networkAddress;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å®‰å…¨( https )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSecure;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›¸å¯¹åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String relativeUri;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®Œæ•´çš„æœåŠ¡ URL</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String serviceUrl;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEndpoint</span><span class="params">(String serviceUrl)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.serviceUrl = serviceUrl;</div><div class="line"></div><div class="line">        <span class="comment">// å°† serviceUrl åˆ†è§£æˆ å‡ ä¸ªå±æ€§</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            URL url = <span class="keyword">new</span> URL(serviceUrl);</div><div class="line">            <span class="keyword">this</span>.networkAddress = url.getHost();</div><div class="line">            <span class="keyword">this</span>.port = url.getPort();</div><div class="line">            <span class="keyword">this</span>.isSecure = <span class="string">"https"</span>.equals(url.getProtocol());</div><div class="line">            <span class="keyword">this</span>.relativeUri = url.getPath();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Malformed serviceUrl: "</span> + serviceUrl);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEndpoint</span><span class="params">(String networkAddress, <span class="keyword">int</span> port, <span class="keyword">boolean</span> isSecure, String relativeUri)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.networkAddress = networkAddress;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.isSecure = isSecure;</div><div class="line">        <span class="keyword">this</span>.relativeUri = relativeUri;</div><div class="line"></div><div class="line">        <span class="comment">// å‡ ä¸ªå±æ€§ æ‹¼æ¥æˆ serviceUrl</span></div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder().append(isSecure ? <span class="string">"https"</span> : <span class="string">"http"</span>).append(<span class="string">"://"</span>).append(networkAddress);</div><div class="line"><span class="keyword">if</span> (port &gt;= <span class="number">0</span>) &#123;</div><div class="line">sb.append(<span class="string">':'</span>).append(port);</div><div class="line">&#125;</div><div class="line">        <span class="keyword">if</span> (relativeUri != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!relativeUri.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                sb.append(<span class="string">'/'</span>);</div><div class="line">            &#125;</div><div class="line">            sb.append(relativeUri);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.serviceUrl = sb.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é‡å†™äº† <code>#equals(...)</code> å’Œ <code>#hashCode(...)</code> æ–¹æ³•ï¼Œæ ‡å‡†å®ç°æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚</li><li>é‡å†™äº† <code>#compareTo(...)</code> æ–¹æ³•ï¼ŒåŸºäº <code>serviceUrl</code> å±æ€§åšæ¯”è¾ƒã€‚</li></ul><h2>2.3 AwsEndpoint</h2><p><code>com.netflix.discovery.shared.resolver.aws.AwsEndpoint</code> ï¼ŒåŸºäº <code>region</code>ã€<code>zone</code> çš„ Eureka æœåŠ¡ç«¯ç‚¹<strong>å®ç°ç±»</strong> ( è¯·ä¸è¦åœ¨æ„ AWS å¼€å¤´ )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AwsEndpoint</span> <span class="keyword">extends</span> <span class="title">DefaultEndpoint</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åŒºåŸŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String region;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯ç”¨åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String zone;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é‡å†™äº† <code>#equals(...)</code> å’Œ <code>#hashCode(...)</code> æ–¹æ³•ï¼Œæ ‡å‡†å®ç°æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚</li></ul><h1>3. è§£æå™¨</h1><p>EndPoint è§£æå™¨ä½¿ç”¨<strong>å§”æ‰˜è®¾è®¡æ¨¡å¼</strong>å®ç°ã€‚æ‰€ä»¥ï¼Œä¸Šæ–‡å›¾ç‰‡ä¸­æˆ‘ä»¬çœ‹åˆ°å¥½å¤šä¸ªè§£æå™¨ï¼Œ<strong>å®é™…ä»£ç éå¸¸éå¸¸éå¸¸æ¸…æ™°</strong>ã€‚</p><blockquote><p>FROM <a href="https://zh.wikipedia.org/wiki/%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå§”æ‰˜æ¨¡å¼ã€‹</a><br>å§”æ‰˜æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€é¡¹åŸºæœ¬æŠ€å·§ã€‚åœ¨å§”æ‰˜æ¨¡å¼ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¯¹è±¡å‚ä¸å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—è¯·æ±‚çš„å¯¹è±¡å°†è¯·æ±‚å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡æ¥å¤„ç†ã€‚å§”æ‰˜æ¨¡å¼æ˜¯ä¸€é¡¹åŸºæœ¬æŠ€å·§ï¼Œè®¸å¤šå…¶ä»–çš„æ¨¡å¼ï¼Œå¦‚çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯åœ¨æ›´ç‰¹æ®Šçš„åœºåˆé‡‡ç”¨äº†å§”æ‰˜æ¨¡å¼ã€‚å§”æ‰˜æ¨¡å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨èšåˆæ¥æ›¿ä»£ç»§æ‰¿ï¼Œå®ƒè¿˜ä½¿æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿmixinã€‚</p></blockquote><p>æˆ‘ä»¬åœ¨ä¸Šå›¾çš„åŸºç¡€ä¸Šï¼Œ<strong>å¢åŠ å§”æ‰˜çš„å…³ç³»</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_24/02.png" alt=""></p><h2>3.1 ClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.ClusterResolver</code> ï¼Œé›†ç¾¤è§£æå™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClusterResolver</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">EurekaEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> åœ°åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getRegion</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> EndPoint é›†ç¾¤( æ•°ç»„ )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;T&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 ClosableResolver</h2><p><code>com.netflix.discovery.shared.resolver.ClosableResolver</code> ï¼Œ<strong>å¯å…³é—­</strong>çš„è§£æå™¨<strong>æ¥å£</strong>ï¼Œç»§æ‰¿è‡ª ClusterResolver <strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClosableResolver</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">EurekaEndpoint</span>&gt; <span class="keyword">extends</span> <span class="title">ClusterResolver</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.3 DnsTxtRecordClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.aws.DnsTxtRecordClusterResolver</code> ï¼ŒåŸºäº DNS <strong>TXT</strong> è®°å½•ç±»å‹çš„é›†ç¾¤è§£æå™¨ã€‚<strong>ç±»å±æ€§</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DnsTxtRecordClusterResolver</span> <span class="keyword">implements</span> <span class="title">ClusterResolver</span>&lt;<span class="title">AwsEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åœ°åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String region;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é›†ç¾¤æ ¹åœ°å€ï¼Œä¾‹å¦‚ txt.default.eureka.iocoder.cn</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String rootClusterDNS;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦è§£æå¯ç”¨åŒº( zone )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> extractZoneFromDNS;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å®‰å…¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSecure;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›¸å¯¹åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String relativeUri;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>DnsTxtRecordClusterResolver é€šè¿‡é›†ç¾¤æ ¹åœ°å€( <code>rootClusterDNS</code> ) è§£æå‡º EndPoint é›†ç¾¤ã€‚éœ€è¦åœ¨ DNS é…ç½®<strong>ä¸¤å±‚</strong>è§£æè®°å½•ï¼š</p><ul><li>ç¬¬ä¸€å±‚ ï¼š<ul><li>ä¸»æœºè®°å½• ï¼šæ ¼å¼ä¸º <code>TXT.${REGION}.${è‡ªå®šä¹‰äºŒçº§åŸŸå}</code> ã€‚</li><li>è®°å½•ç±»å‹ ï¼š<strong>TXT è®°å½•ç±»å‹</strong>ã€‚</li><li>è®°å½•å€¼ ï¼šç¬¬äºŒå±‚çš„<strong>ä¸»æœºè®°å½•</strong>ã€‚å¦‚æœ‰å¤šä¸ªç¬¬äºŒå±‚çº§ï¼Œä½¿ç”¨<strong>ç©ºæ ¼</strong>åˆ†éš”ã€‚</li></ul></li><li>ç¬¬äºŒå±‚ï¼š<ul><li>ä¸»æœºè®°å½• ï¼šæ ¼å¼ä¸º <code>TXT.${ZONE}.${è‡ªå®šä¹‰äºŒçº§åŸŸå}</code> æˆ–è€… <code>${ZONE}.${è‡ªå®šä¹‰äºŒçº§åŸŸå}</code>ã€‚</li><li>è®°å½•ç±»å‹ ï¼š<strong>TXT è®°å½•ç±»å‹</strong>ã€‚</li><li>è®°å½•å€¼ ï¼šEndPoint çš„ç½‘ç»œåœ°å€ã€‚å¦‚æœ‰å¤šä¸ª EndPointï¼Œä½¿ç”¨<strong>ç©ºæ ¼</strong>åˆ†éš”ã€‚</li></ul></li><li>ä¸¾ä¸ªä¾‹å­ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_24/03.png" alt=""></li></ul></li><li><p><code>rootClusterDNS</code> ï¼Œé›†ç¾¤æ ¹åœ°å€ã€‚ä¾‹å¦‚ï¼š<code>txt.default.eureka.iocoder.cn</code>ï¼Œå…¶Â· <code>txt.default.eureka</code> ä¸º DNS è§£æè®°å½•çš„ç¬¬ä¸€å±‚çš„<strong>ä¸»æœºè®°å½•</strong>ã€‚</p></li><li><p><code>region</code> ï¼šåœ°åŒºã€‚éœ€è¦å’Œ <code>rootClusterDNS</code> çš„ <code>${REGION}</code> ä¸€è‡´ã€‚</p></li><li><p><code>extractZoneFromDNS</code> ï¼šæ˜¯å¦è§£æ DNS è§£æè®°å½•çš„ç¬¬äºŒå±‚çº§çš„<strong>ä¸»æœºè®°å½•</strong>çš„ <code>${ZONE}</code> å¯ç”¨åŒºã€‚</p></li></ul><hr><p><code>#getClusterEndpoints(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     List&lt;AwsEndpoint&gt; eurekaEndpoints = resolve(region, rootClusterDNS, extractZoneFromDNS, port, isSecure, relativeUri);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">5</span>:         logger.debug(<span class="string">"Resolved &#123;&#125; to &#123;&#125;"</span>, rootClusterDNS, eurekaEndpoints);</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">return</span> eurekaEndpoints;</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AwsEndpoint&gt; <span class="title">resolve</span><span class="params">(String region, String rootClusterDNS, <span class="keyword">boolean</span> extractZone, <span class="keyword">int</span> port, <span class="keyword">boolean</span> isSecure, String relativeUri)</span> </span>&#123;</div><div class="line"><span class="number">11</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// è§£æ ç¬¬ä¸€å±‚ DNS è®°å½•</span></div><div class="line"><span class="number">13</span>:         Set&lt;String&gt; zoneDomainNames = resolve(rootClusterDNS);</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (zoneDomainNames.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> ClusterResolverException(<span class="string">"Cannot resolve Eureka cluster addresses; there are no data in TXT record for DN "</span> + rootClusterDNS);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>:         <span class="comment">// è®°å½• ç¬¬äºŒå±‚ DNS è®°å½•</span></div><div class="line"><span class="number">18</span>:         List&lt;AwsEndpoint&gt; endpoints = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">for</span> (String zoneDomain : zoneDomainNames) &#123;</div><div class="line"><span class="number">20</span>:             String zone = extractZone ? ResolverUtils.extractZoneFromHostName(zoneDomain) : <span class="keyword">null</span>; <span class="comment">// </span></div><div class="line"><span class="number">21</span>:             Set&lt;String&gt; zoneAddresses = resolve(zoneDomain);</div><div class="line"><span class="number">22</span>:             <span class="keyword">for</span> (String address : zoneAddresses) &#123;</div><div class="line"><span class="number">23</span>:                 endpoints.add(<span class="keyword">new</span> AwsEndpoint(address, port, isSecure, relativeUri, region, zone));</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> endpoints;</div><div class="line"><span class="number">27</span>:     &#125; <span class="keyword">catch</span> (NamingException e) &#123;</div><div class="line"><span class="number">28</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> ClusterResolverException(<span class="string">"Cannot resolve Eureka cluster addresses for root: "</span> + rootClusterDNS, e);</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 12 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>#resolve(rootClusterDNS)</code> è§£æ<strong>ç¬¬ä¸€å±‚</strong> DNS è®°å½•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">resolve</span><span class="params">(String rootClusterDNS)</span> <span class="keyword">throws</span> NamingException </span>&#123;</div><div class="line"> <span class="number">2</span>:     Set&lt;String&gt; result;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         result = DnsResolver.getCNamesFromTxtRecord(rootClusterDNS);</div><div class="line"> <span class="number">5</span>:         <span class="comment">// TODO èŠ‹è‰¿ï¼šè¿™å—æ˜¯bugï¼Œä¸éœ€è¦è¿™ä¸€æ®µ</span></div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (!rootClusterDNS.startsWith(<span class="string">"txt."</span>)) &#123;</div><div class="line"> <span class="number">7</span>:             result = DnsResolver.getCNamesFromTxtRecord(<span class="string">"txt."</span> + rootClusterDNS);</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">catch</span> (NamingException e) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!rootClusterDNS.startsWith(<span class="string">"txt."</span>)) &#123;</div><div class="line"><span class="number">11</span>:             result = DnsResolver.getCNamesFromTxtRecord(<span class="string">"txt."</span> + rootClusterDNS);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼š è°ƒç”¨ <code>DnsResolver#getCNamesFromTxtRecord(...)</code> æ–¹æ³•ï¼Œè§£æ TXT ä¸»æœºè®°å½•ã€‚ç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/endpoint/DnsResolver.java#L126" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ DnsResolver çš„ä»£ç ï¼Œæ¯”è¾ƒè§£æï¼Œç¬”è€…å°±ä¸å•°å—¦äº†ã€‚</li><li>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šå½“ä¼ é€’å‚æ•° <code>rootClusterDNS</code> ä¸ä»¥ <code>txt.</code> å¼€å¤´æ—¶ï¼Œå³ä½¿ç¬¬ 4 è¡Œè§£ææˆåŠŸï¼Œä¹Ÿä¼šæŠ¥é”™ï¼Œæ­¤æ—¶æ˜¯ä¸ª Eureka çš„ BUG ã€‚å› æ­¤ï¼Œé…ç½® DNS è§£æè®°å½•æ—¶ï¼Œä¸»æœºè®°å½•æš‚æ—¶å¿…é¡»ä»¥ <code>txt.</code> å¼€å¤´ã€‚</li></ul></li><li><p>ç¬¬ 17 è‡³ 25 è¡Œ ï¼šå¾ªç¯ç¬¬ä¸€å±‚ DNS è®°å½•çš„è§£æç»“æœï¼Œè¿›ä¸€æ­¥è§£æç¬¬äºŒå±‚ DNS è®°å½•ã€‚</p><ul><li>ç¬¬ 20 è¡Œ ï¼šè§£æå¯ç”¨åŒº( <code>zone</code> )ã€‚</li><li>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#resolve(rootClusterDNS)</code> è§£æ<strong>ç¬¬äºŒå±‚</strong> DNS è®°å½•ã€‚</li></ul></li></ul><h2>3.4 ConfigClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.aws.ConfigClusterResolver</code> ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„é›†ç¾¤è§£æå™¨ã€‚<strong>ç±»å±æ€§</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClusterResolver</span> <span class="keyword">implements</span> <span class="title">ClusterResolver</span>&lt;<span class="title">AwsEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaClientConfig clientConfig;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo myInstanceInfo;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfigClusterResolver</span><span class="params">(EurekaClientConfig clientConfig, InstanceInfo myInstanceInfo)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.clientConfig = clientConfig;</div><div class="line">        <span class="keyword">this</span>.myInstanceInfo = myInstanceInfo;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><hr><p><code>#getClusterEndpoints(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ä½¿ç”¨ DNS è·å– EndPoint</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line"> <span class="number">6</span>:             logger.info(<span class="string">"Resolving eureka endpoints via DNS: &#123;&#125;"</span>, getDNSName());</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">return</span> getClusterEndpointsFromDns();</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:     <span class="comment">// ç›´æ¥é…ç½®å®é™…è®¿é—®åœ°å€</span></div><div class="line"><span class="number">11</span>:         logger.info(<span class="string">"Resolving eureka endpoints via configuration"</span>);</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> getClusterEndpointsFromConfig();</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 8 è¡Œ ï¼šåŸºäº DNS è·å– EndPoint é›†ç¾¤ï¼Œè°ƒç”¨ <code>#getClusterEndpointsFromDns()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpointsFromDns</span><span class="params">()</span> </span>&#123;</div><div class="line">   String discoveryDnsName = getDNSName(); <span class="comment">// è·å– é›†ç¾¤æ ¹åœ°å€</span></div><div class="line">   <span class="keyword">int</span> port = Integer.parseInt(clientConfig.getEurekaServerPort()); <span class="comment">// ç«¯å£</span></div><div class="line"></div><div class="line">   <span class="comment">// cheap enough so just re-use</span></div><div class="line">   DnsTxtRecordClusterResolver dnsResolver = <span class="keyword">new</span> DnsTxtRecordClusterResolver(</div><div class="line">           getRegion(),</div><div class="line">           discoveryDnsName,</div><div class="line">           <span class="keyword">true</span>, <span class="comment">// è§£æ zone</span></div><div class="line">           port,</div><div class="line">           <span class="keyword">false</span>,</div><div class="line">           clientConfig.getEurekaServerURLContext()</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// è°ƒç”¨ DnsTxtRecordClusterResolver è§£æ EndPoint</span></div><div class="line">   List&lt;AwsEndpoint&gt; endpoints = dnsResolver.getClusterEndpoints();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (endpoints.isEmpty()) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot resolve to any endpoints for the given dnsName: &#123;&#125;"</span>, discoveryDnsName);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> endpoints;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDNSName</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"txt."</span> + getRegion() + <span class="string">'.'</span> + clientConfig.getEurekaServerDNSName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å¿…é¡»é…ç½® <code>eureka.shouldUseDns=true</code> ï¼Œå¼€å¯åŸºäº DNS è·å– EndPoint é›†ç¾¤ã€‚</li><li>å¿…é¡»é…ç½® <code>eureka.eurekaServer.domainName=${xxxxx}</code> ï¼Œé…ç½®é›†ç¾¤æ ¹åœ°å€ã€‚</li><li>é€‰å¡«é… <code>eureka.eurekaServer.port</code> ï¼Œ<code>eureka.eurekaServer.context</code> ã€‚</li><li>ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ DnsTxtRecordClusterResolver è§£æå‡º EndPoint é›†ç¾¤ã€‚</li></ul></li><li><p>ç¬¬ 9 è‡³ 13 è¡Œ ï¼šç›´æ¥<strong>é…ç½®æ–‡ä»¶</strong>å¡«å†™å®é™… EndPoint é›†ç¾¤ï¼Œè°ƒç”¨ <code>#getClusterEndpointsFromConfig()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p></li></ul><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpointsFromConfig</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— å¯ç”¨åŒº</span></div><div class="line"> <span class="number">3</span>:     String[] availZones = clientConfig.getAvailabilityZones(clientConfig.getRegion());</div><div class="line"> <span class="number">4</span>:     <span class="comment">// è·å– åº”ç”¨å®ä¾‹è‡ªå·± çš„ å¯ç”¨åŒº</span></div><div class="line"> <span class="number">5</span>:     String myZone = InstanceInfo.getZone(availZones, myInstanceInfo);</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— å¯ç”¨åŒºä¸ serviceUrls çš„æ˜ å°„</span></div><div class="line"> <span class="number">7</span>:     Map&lt;String, List&lt;String&gt;&gt; serviceUrls = EndpointUtils.getServiceUrlsMapFromConfig(clientConfig, myZone, clientConfig.shouldPreferSameZoneEureka());</div><div class="line"> <span class="number">8</span>:     <span class="comment">// æ‹¼è£… EndPoint é›†ç¾¤ç»“æœ</span></div><div class="line"> <span class="number">9</span>:     List&lt;AwsEndpoint&gt; endpoints = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">10</span>:     <span class="keyword">for</span> (String zone : serviceUrls.keySet()) &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">for</span> (String url : serviceUrls.get(zone)) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                 endpoints.add(<span class="keyword">new</span> AwsEndpoint(url, getRegion(), zone));</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</div><div class="line"><span class="number">15</span>:                 logger.warn(<span class="string">"Invalid eureka server URI: &#123;&#125;; removing from the server pool"</span>, url);</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="comment">// æ‰“å°æ—¥å¿—ï¼ŒEndPoint é›†ç¾¤</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">22</span>:         logger.debug(<span class="string">"Config resolved to &#123;&#125;"</span>, endpoints);</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>:     <span class="comment">// æ‰“å°æ—¥å¿—ï¼Œè§£æç»“æœä¸ºç©º</span></div><div class="line"><span class="number">25</span>:     <span class="keyword">if</span> (endpoints.isEmpty()) &#123;</div><div class="line"><span class="number">26</span>:         logger.error(<span class="string">"Cannot resolve to any endpoints from provided configuration: &#123;&#125;"</span>, serviceUrls);</div><div class="line"><span class="number">27</span>:     &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:     <span class="keyword">return</span> endpoints;</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šè·å¾—å¯ç”¨åŒºæ•°ç»„ã€‚é€šè¿‡ <code>eureka.${REGION}.availabilityZones</code> é…ç½®ã€‚</p></li><li><p>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>InstanceInfo#getZone(...)</code> æ–¹æ³•ï¼Œè·å¾—<strong>åº”ç”¨å®ä¾‹è‡ªå·±æ‰€åœ¨çš„å¯ç”¨åŒº</strong>( <code>zone</code> )ã€‚éäºšé©¬é€Š AWS ç¯å¢ƒä¸‹ï¼Œå¯ç”¨åŒºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯<strong>åº”ç”¨å®ä¾‹è‡ªå·±æ‰€åœ¨çš„å¯ç”¨åŒº</strong>ã€‚</p></li><li><p>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>EndpointUtils#getServiceUrlsMapFromConfig(...)</code> æ–¹æ³•ï¼Œè·å¾—å¯ç”¨åŒºä¸ <code>serviceUrls</code> çš„æ˜ å°„ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EndpointUtils.java</span></div><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; getServiceUrlsMapFromConfig(EurekaClientConfig clientConfig, String instanceZone, <span class="keyword">boolean</span> preferSameZone) &#123;</div><div class="line">  <span class="number">2</span>:     Map&lt;String, List&lt;String&gt;&gt; orderedUrls = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(); <span class="comment">// keyï¼šzoneï¼›valueï¼šserviceUrls</span></div><div class="line">  <span class="number">3</span>:     <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çš„ åœ°åŒº( region )</span></div><div class="line">  <span class="number">4</span>:     String region = getRegion(clientConfig);</div><div class="line">  <span class="number">5</span>:     <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çš„ å¯ç”¨åŒº</span></div><div class="line">  <span class="number">6</span>:     String[] availZones = clientConfig.getAvailabilityZones(clientConfig.getRegion());</div><div class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (availZones == <span class="keyword">null</span> || availZones.length == <span class="number">0</span>) &#123;</div><div class="line">  <span class="number">8</span>:         availZones = <span class="keyword">new</span> String[<span class="number">1</span>];</div><div class="line">  <span class="number">9</span>:         availZones[<span class="number">0</span>] = DEFAULT_ZONE;</div><div class="line"> <span class="number">10</span>:     &#125;</div><div class="line"> <span class="number">11</span>:     logger.debug(<span class="string">"The availability zone for the given region &#123;&#125; are &#123;&#125;"</span>, region, Arrays.toString(availZones));</div><div class="line"> <span class="number">12</span>:     <span class="comment">// è·å¾— å¼€å§‹ä½ç½®</span></div><div class="line"> <span class="number">13</span>:     <span class="keyword">int</span> myZoneOffset = getZoneOffset(instanceZone, preferSameZone, availZones);</div><div class="line"> <span class="number">14</span>:     <span class="comment">// å°† å¼€å§‹ä½ç½® çš„ serviceUrls æ·»åŠ åˆ°ç»“æœ</span></div><div class="line"> <span class="number">15</span>:     String zone = availZones[myZoneOffset];</div><div class="line"> <span class="number">16</span>:     List&lt;String&gt; serviceUrls = clientConfig.getEurekaServerServiceUrls(zone);</div><div class="line"> <span class="number">17</span>:     <span class="keyword">if</span> (serviceUrls != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">18</span>:         orderedUrls.put(zone, serviceUrls);</div><div class="line"> <span class="number">19</span>:     &#125;</div><div class="line"> <span class="number">20</span>:     <span class="comment">// ä»å¼€å§‹ä½ç½®é¡ºåºéå†å‰©ä½™çš„ serviceUrls æ·»åŠ åˆ°ç»“æœ</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">int</span> currentOffset = myZoneOffset == (availZones.length - <span class="number">1</span>) ? <span class="number">0</span> : (myZoneOffset + <span class="number">1</span>);</div><div class="line"> <span class="number">22</span>:     <span class="keyword">while</span> (currentOffset != myZoneOffset) &#123;</div><div class="line"> <span class="number">23</span>:         zone = availZones[currentOffset];</div><div class="line"> <span class="number">24</span>:         serviceUrls = clientConfig.getEurekaServerServiceUrls(zone);</div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (serviceUrls != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">26</span>:             orderedUrls.put(zone, serviceUrls);</div><div class="line"> <span class="number">27</span>:         &#125;</div><div class="line"> <span class="number">28</span>:         <span class="keyword">if</span> (currentOffset == (availZones.length - <span class="number">1</span>)) &#123;</div><div class="line"> <span class="number">29</span>:             currentOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">30</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">31</span>:             currentOffset++;</div><div class="line"> <span class="number">32</span>:         &#125;</div><div class="line"> <span class="number">33</span>:     &#125;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="comment">// ä¸ºç©ºï¼ŒæŠ¥é”™</span></div><div class="line"> <span class="number">36</span>:     <span class="keyword">if</span> (orderedUrls.size() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">37</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"DiscoveryClient: invalid serviceUrl specified!"</span>);</div><div class="line"> <span class="number">38</span>:     &#125;</div><div class="line"> <span class="number">39</span>:     <span class="keyword">return</span> orderedUrls;</div><div class="line"> <span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 13 è¡Œ ï¼šè·å¾—<strong>å¼€å§‹ä½ç½®</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getZoneOffset</span><span class="params">(String myZone, <span class="keyword">boolean</span> preferSameZone, String[] availZones)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; availZones.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (myZone != <span class="keyword">null</span> &amp;&amp; (availZones[i].equalsIgnoreCase(myZone.trim()) == preferSameZone)) &#123;</div><div class="line">           <span class="keyword">return</span> i;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   logger.warn(<span class="string">"DISCOVERY: Could not pick a zone based on preferred zone settings. My zone - &#123;&#125;,"</span> +</div><div class="line">           <span class="string">" preferSameZone- &#123;&#125;. Defaulting to "</span> + availZones[<span class="number">0</span>], myZone, preferSameZone);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“æ–¹æ³•å‚æ•° <code>preferSameZone=true</code> ï¼Œå³ <code>eureka.preferSameZone=true</code>( é»˜è®¤å€¼ ï¼š<code>true</code> ) æ—¶ï¼Œ<strong>å¼€å§‹ä½ç½®</strong>ä¸ºå¯ç”¨åŒºæ•°ç»„( <code>availZones</code> )çš„<strong>ç¬¬ä¸€ä¸ª</strong>å’Œåº”ç”¨å®ä¾‹æ‰€åœ¨çš„å¯ç”¨åŒº( <code>myZone</code> )ã€<strong>ç›¸ç­‰</strong>ã€‘å…ƒç´ çš„ä½ç½®ã€‚</li><li>å½“æ–¹æ³•å‚æ•° <code>preferSameZone=false</code> ï¼Œå³ <code>eureka.preferSameZone=false</code>( é»˜è®¤å€¼ ï¼š<code>true</code> ) æ—¶ï¼Œ<strong>å¼€å§‹ä½ç½®</strong>ä¸ºå¯ç”¨åŒºæ•°ç»„( <code>availZones</code> )çš„<strong>ç¬¬ä¸€ä¸ª</strong>å’Œåº”ç”¨å®ä¾‹æ‰€åœ¨çš„å¯ç”¨åŒº( <code>myZone</code> )ã€<strong>ä¸ç›¸ç­‰</strong>ã€‘å…ƒç´ çš„ä½ç½®ã€‚</li></ul></li><li><p>ç¬¬ 20 è‡³ 33 è¡Œ ï¼šä»å¼€å§‹ä½ç½®<strong>é¡ºåº</strong>å°†å‰©ä½™çš„å¯ç”¨åŒºçš„ <code>serviceUrls</code> æ·»åŠ åˆ°ç»“æœã€‚<strong>é¡ºåº</strong>ç†è§£å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_24/04.png" alt=""></p></li></ul></li><li><p>ç¬¬ 9 è‡³ 18 è¡Œ ï¼šæ‹¼è£… EndPoint é›†ç¾¤ç»“æœã€‚</p></li></ul><h2>3.5 ZoneAffinityClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.aws.ZoneAffinityClusterResolver</code> ï¼Œä½¿ç”¨å¯ç”¨åŒºäº²å’Œçš„é›†ç¾¤è§£æå™¨ã€‚<strong>ç±»å±æ€§</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZoneAffinityClusterResolver</span> <span class="keyword">implements</span> <span class="title">ClusterResolver</span>&lt;<span class="title">AwsEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ZoneAffinityClusterResolver.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å§”æ‰˜çš„è§£æå™¨</span></div><div class="line"><span class="comment">     * ç›®å‰ä»£ç é‡Œä¸º &#123;<span class="doctag">@link</span> ConfigClusterResolver&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClusterResolver&lt;AwsEndpoint&gt; delegate;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹çš„å¯ç”¨åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String myZone;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å¯ç”¨åŒºäº²å’Œ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> zoneAffinity;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZoneAffinityClusterResolver</span><span class="params">(ClusterResolver&lt;AwsEndpoint&gt; delegate, String myZone, <span class="keyword">boolean</span> zoneAffinity)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        <span class="keyword">this</span>.myZone = myZone;</div><div class="line">        <span class="keyword">this</span>.zoneAffinity = zoneAffinity;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å±æ€§ <code>delegate</code> ï¼Œå§”æ‰˜çš„è§£æå™¨ã€‚ç›®å‰ä»£ç é‡Œä½¿ç”¨çš„æ˜¯ ConfigClusterResolver ã€‚</li><li>å±æ€§ <code>zoneAffinity</code> ï¼Œæ˜¯å¦å¯ç”¨åŒºäº²å’Œã€‚<ul><li><code>true</code> ï¼šEndPoint å¯ç”¨åŒºä¸º<strong>æœ¬åœ°</strong>çš„ä¼˜å…ˆè¢«æ”¾åœ¨å‰é¢ã€‚</li><li><code>false</code> ï¼šEndPoint å¯ç”¨åŒº<strong>éæœ¬åœ°</strong>çš„ä¼˜å…ˆè¢«æ”¾åœ¨å‰é¢ã€‚</li></ul></li></ul><p><code>#getClusterEndpoints(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// æ‹†åˆ†æˆ æœ¬åœ°çš„å¯ç”¨åŒºå’Œéæœ¬åœ°çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤</span></div><div class="line"> <span class="number">4</span>:     List&lt;AwsEndpoint&gt;[] parts = ResolverUtils.splitByZone(delegate.getClusterEndpoints(), myZone);</div><div class="line"> <span class="number">5</span>:     List&lt;AwsEndpoint&gt; myZoneEndpoints = parts[<span class="number">0</span>];</div><div class="line"> <span class="number">6</span>:     List&lt;AwsEndpoint&gt; remainingEndpoints = parts[<span class="number">1</span>];</div><div class="line"> <span class="number">7</span>:     <span class="comment">// éšæœºæ‰“ä¹± EndPoint é›†ç¾¤å¹¶è¿›è¡Œåˆå¹¶</span></div><div class="line"> <span class="number">8</span>:     List&lt;AwsEndpoint&gt; randomizedList = randomizeAndMerge(myZoneEndpoints, remainingEndpoints);</div><div class="line"> <span class="number">9</span>:     <span class="comment">// éå¯ç”¨åŒºäº²å’Œï¼Œå°†éæœ¬åœ°çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤æ”¾åœ¨å‰é¢</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">if</span> (!zoneAffinity) &#123;</div><div class="line"><span class="number">11</span>:         Collections.reverse(randomizedList);</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">15</span>:         logger.debug(<span class="string">"Local zone=&#123;&#125;; resolved to: &#123;&#125;"</span>, myZone, randomizedList);</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="keyword">return</span> randomizedList;</div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>ClusterResolver#getClusterEndpoints()</code> æ–¹æ³•ï¼Œè·å¾— EndPoint é›†ç¾¤ã€‚å†è°ƒç”¨ <code>ResolverUtils#splitByZone(...)</code> æ–¹æ³•ï¼Œæ‹†åˆ†æˆ<strong>æœ¬åœ°</strong>å’Œ<strong>éæœ¬åœ°</strong>çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/resolver/ResolverUtils.java#L55" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ã€‚</p></li><li><p>ç¬¬ 8 è¡Œ ï¼šè°ƒç”¨ <code>#randomizeAndMerge(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ†åˆ«</strong>éšæœºæ‰“ä¹±<strong>æ¯ä¸ª</strong> EndPoint é›†ç¾¤ï¼Œå¹¶è¿›è¡Œ<strong>åˆå¹¶</strong>æ•°ç»„ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZoneAffinityClusterResolver.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AwsEndpoint&gt; <span class="title">randomizeAndMerge</span><span class="params">(List&lt;AwsEndpoint&gt; myZoneEndpoints, List&lt;AwsEndpoint&gt; remainingEndpoints)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (myZoneEndpoints.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> ResolverUtils.randomize(remainingEndpoints); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (remainingEndpoints.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> ResolverUtils.randomize(myZoneEndpoints); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   &#125;</div><div class="line">   List&lt;AwsEndpoint&gt; mergedList = ResolverUtils.randomize(myZoneEndpoints); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   mergedList.addAll(ResolverUtils.randomize(remainingEndpoints)); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   <span class="keyword">return</span> mergedList;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ResolverUtils.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends EurekaEndpoint&gt; <span class="function">List&lt;T&gt; <span class="title">randomize</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ•°ç»„å¤§å°ä¸º 0 æˆ–è€… 1 ï¼Œä¸è¿›è¡Œæ‰“ä¹±</span></div><div class="line">   List&lt;T&gt; randomList = <span class="keyword">new</span> ArrayList&lt;&gt;(list);</div><div class="line">   <span class="keyword">if</span> (randomList.size() &lt; <span class="number">2</span>) &#123;</div><div class="line">       <span class="keyword">return</span> randomList;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»¥æœ¬åœ°IPä¸ºéšæœºç§å­ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š</span></div><div class="line">   <span class="comment">// å¤šä¸ªä¸»æœºï¼Œå®ç°å¯¹åŒä¸€ä¸ª EndPoint é›†ç¾¤è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</span></div><div class="line">   <span class="comment">// å•ä¸ªä¸»æœºï¼ŒåŒä¸€ä¸ª EndPoint é›†ç¾¤æŒ‰ç…§å›ºå®šé¡ºåºè®¿é—®ã€‚Eureka-Server ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„æ³¨å†Œä¸­å¿ƒï¼ŒEureka-Client å¯¹åŒä¸€ä¸ª Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œä¿è¯ä¸¤è€…ä¹‹é—´å¢é‡åŒæ­¥çš„ä¸€è‡´æ€§ã€‚</span></div><div class="line">   Random random = <span class="keyword">new</span> Random(LOCAL_IPV4_ADDRESS.hashCode());</div><div class="line">   <span class="keyword">int</span> last = randomList.size() - <span class="number">1</span>;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; last; i++) &#123;</div><div class="line">       <span class="keyword">int</span> pos = random.nextInt(randomList.size() - i);</div><div class="line">       <span class="keyword">if</span> (pos != i) &#123;</div><div class="line">           Collections.swap(randomList, i, pos);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> randomList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„ï¼Œ<code>ResolverUtils#randomize(...)</code> ä½¿ç”¨ä»¥æœ¬æœºIPä¸ºéšæœºç§å­</strong>ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š<ul><li>å¤šä¸ªä¸»æœºï¼Œå®ç°å¯¹åŒä¸€ä¸ª EndPoint é›†ç¾¤è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</li><li>å•ä¸ªä¸»æœºï¼ŒåŒä¸€ä¸ª EndPoint é›†ç¾¤æŒ‰ç…§å›ºå®šé¡ºåºè®¿é—®ã€‚Eureka-Server ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„æ³¨å†Œä¸­å¿ƒï¼ŒEureka-Client å¯¹åŒä¸€ä¸ª Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œä¿è¯ä¸¤è€…ä¹‹é—´å¢é‡åŒæ­¥çš„ä¸€è‡´æ€§ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 10 è‡³ 12 è¡Œ ï¼šéå¯ç”¨åŒºäº²å’Œï¼Œå°†éæœ¬åœ°çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤æ”¾åœ¨å‰é¢ã€‚</p></li></ul><h2>3.6 AsyncResolver</h2><p><code>com.netflix.discovery.shared.resolver.AsyncResolver</code> ï¼Œ<strong>å¼‚æ­¥æ‰§è¡Œ</strong>è§£æçš„é›†ç¾¤è§£æå™¨ã€‚AsyncResolver å±æ€§è¾ƒå¤šï¼Œè€Œä¸”å¤æ‚çš„å¤šï¼Œæˆ‘ä»¬æ‹†åˆ†åˆ°å…·ä½“æ–¹æ³•é‡Œåˆ†äº«ã€‚</p><h3>3.6.1 å®šæ—¶ä»»åŠ¡</h3><p>AsyncResolver å†…ç½®å®šæ—¶ä»»åŠ¡ï¼Œ<strong>å®šæ—¶</strong>åˆ·æ–° EndPoint é›†ç¾¤è§£æç»“æœã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦åˆ·æ–°</strong>ï¼Ÿä¾‹å¦‚ï¼ŒEureka-Server çš„ <code>serviceUrls</code> åŸºäº DNS é…ç½®ã€‚</p><p><strong>å®šæ—¶ä»»åŠ¡ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ˜¯å¦å·²ç»è°ƒåº¦å®šæ—¶ä»»åŠ¡ &#123;<span class="doctag">@link</span> #updateTask&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean scheduled = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å§”æ‰˜çš„è§£æå™¨</span></div><div class="line"><span class="comment">* ç›®å‰ä»£ç ä¸º &#123;<span class="doctag">@link</span> com.netflix.discovery.shared.resolver.aws.ZoneAffinityClusterResolver&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClusterResolver&lt;T&gt; delegate;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å®šæ—¶æœåŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executorService;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* çº¿ç¨‹æ± æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor threadPoolExecutor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åå°ä»»åŠ¡</span></div><div class="line"><span class="comment">* å®šæ—¶è§£æ EndPoint é›†ç¾¤</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TimedSupervisorTask backgroundTask;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è§£æ EndPoint é›†ç¾¤ç»“æœ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;List&lt;T&gt;&gt; resultsRef;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å®šæ—¶è§£æ EndPoint é›†ç¾¤çš„é¢‘ç‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> refreshIntervalMs;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* é¢„çƒ­è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> warmUpTimeoutMs;</div><div class="line"></div><div class="line"><span class="comment">// Metric timestamp, tracking last time when data were effectively changed.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastLoadTimestamp = -<span class="number">1</span>;</div><div class="line"></div><div class="line">AsyncResolver(String name,</div><div class="line">             ClusterResolver&lt;T&gt; delegate,</div><div class="line">             List&lt;T&gt; initialValue,</div><div class="line">             <span class="keyword">int</span> executorThreadPoolSize,</div><div class="line">             <span class="keyword">int</span> refreshIntervalMs,</div><div class="line">             <span class="keyword">int</span> warmUpTimeoutMs) &#123;</div><div class="line">   <span class="keyword">this</span>.name = name;</div><div class="line">   <span class="keyword">this</span>.delegate = delegate;</div><div class="line">   <span class="keyword">this</span>.refreshIntervalMs = refreshIntervalMs;</div><div class="line">   <span class="keyword">this</span>.warmUpTimeoutMs = warmUpTimeoutMs;</div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– å®šæ—¶æœåŠ¡</span></div><div class="line">   <span class="keyword">this</span>.executorService = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="comment">// çº¿ç¨‹å¤§å°=1</span></div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                   .setNameFormat(<span class="string">"AsyncResolver-"</span> + name + <span class="string">"-%d"</span>)</div><div class="line">                   .setDaemon(<span class="keyword">true</span>)</div><div class="line">                   .build());</div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– çº¿ç¨‹æ± æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">this</span>.threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">           <span class="number">1</span>, <span class="comment">// çº¿ç¨‹å¤§å°=1</span></div><div class="line">           executorThreadPoolSize, <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">           <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),  <span class="comment">// use direct handoff</span></div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                   .setNameFormat(<span class="string">"AsyncResolver-"</span> + name + <span class="string">"-executor-%d"</span>)</div><div class="line">                   .setDaemon(<span class="keyword">true</span>)</div><div class="line">                   .build()</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– åå°ä»»åŠ¡</span></div><div class="line">   <span class="keyword">this</span>.backgroundTask = <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">           <span class="keyword">this</span>.getClass().getSimpleName(),</div><div class="line">           executorService,</div><div class="line">           threadPoolExecutor,</div><div class="line">           refreshIntervalMs,</div><div class="line">           TimeUnit.MILLISECONDS,</div><div class="line">           <span class="number">5</span>,</div><div class="line">           updateTask</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.resultsRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(initialValue);</div><div class="line">   Monitors.registerObject(name, <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>backgroundTask</code> ï¼Œåå°ä»»åŠ¡ï¼Œå®šæ—¶è§£æ EndPoint é›†ç¾¤ã€‚<ul><li><p>TimedSupervisorTask ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹ã€Œ2.3 TimedSupervisorTaskã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>updateTask</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable updateTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            List&lt;T&gt; newList = delegate.getClusterEndpoints(); <span class="comment">// è°ƒç”¨ å§”æ‰˜çš„è§£æå™¨ è§£æ EndPoint é›†ç¾¤</span></div><div class="line">            <span class="keyword">if</span> (newList != <span class="keyword">null</span>) &#123;</div><div class="line">                resultsRef.getAndSet(newList);</div><div class="line">                lastLoadTimestamp = System.currentTimeMillis();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                logger.warn(<span class="string">"Delegate returned null list of cluster endpoints"</span>);</div><div class="line">            &#125;</div><div class="line">            logger.debug(<span class="string">"Resolved to &#123;&#125;"</span>, newList);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.warn(<span class="string">"Failed to retrieve cluster endpoints from the delegate"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><ul><li><code>delegate</code> ï¼Œå§”æ‰˜çš„è§£æå™¨ï¼Œç›®å‰ä»£ç ä¸º ZoneAffinityClusterResolverã€‚</li></ul></li><li><p>åå°ä»»åŠ¡çš„<strong>å‘èµ·</strong>åœ¨ <code>#getClusterEndpoints()</code> æ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ3.6.2 è§£æ EndPoint é›†ç¾¤ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h3>3.6.2 è§£æ EndPoint é›†ç¾¤</h3><p>è°ƒç”¨ <code>#getClusterEndpoints()</code> æ–¹æ³•ï¼Œè§£æ EndPoint é›†ç¾¤ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> delay = refreshIntervalMs;</div><div class="line"> <span class="number">4</span>:     <span class="comment">// è‹¥æœªé¢„çƒ­è§£æ EndPoint é›†ç¾¤ç»“æœï¼Œè¿›è¡Œé¢„çƒ­</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (warmedUp.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (!doWarmUp()) &#123;</div><div class="line"> <span class="number">7</span>:             delay = <span class="number">0</span>; <span class="comment">// é¢„çƒ­å¤±è´¥ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡çš„ç¬¬ä¸€æ¬¡å»¶è¿Ÿ</span></div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>:     <span class="comment">// è‹¥æœªè°ƒåº¦å®šæ—¶ä»»åŠ¡ï¼Œè¿›è¡Œè°ƒåº¦</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (scheduled.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"><span class="number">12</span>:         scheduleTask(delay);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>:     <span class="comment">// è¿”å› EndPoint é›†ç¾¤</span></div><div class="line"><span class="number">15</span>:     <span class="keyword">return</span> resultsRef.get();</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è‡³ 9 è¡Œ ï¼š<strong>è‹¥æœªé¢„çƒ­è§£æ EndPoint é›†ç¾¤ç»“æœ</strong>ï¼Œè°ƒç”¨ <code>#doWarmUp()</code> æ–¹æ³•ï¼Œè¿›è¡Œé¢„çƒ­ã€‚è‹¥é¢„çƒ­å¤±è´¥ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡çš„ç¬¬ä¸€æ¬¡å»¶è¿Ÿã€‚<code>#doWarmUp()</code> æ–¹æ³•å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">doWarmUp</span><span class="params">()</span> </span>&#123;</div><div class="line">   Future future = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       future = threadPoolExecutor.submit(updateTask);</div><div class="line">       future.get(warmUpTimeoutMs, TimeUnit.MILLISECONDS);  <span class="comment">// block until done or timeout</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.warn(<span class="string">"Best effort warm up failed"</span>, e);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (future != <span class="keyword">null</span>) &#123;</div><div class="line">           future.cancel(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>updateTask</code> ï¼Œè§£æ EndPoint é›†ç¾¤ã€‚</li></ul></li><li><p>ç¬¬ 10 è‡³ 13 è¡Œ ï¼š <strong>è‹¥æœªè°ƒåº¦å®šæ—¶ä»»åŠ¡ï¼Œè¿›è¡Œè°ƒåº¦</strong>ï¼Œè°ƒç”¨ <code>#scheduleTask()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTask</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</div><div class="line">   executorService.schedule(backgroundTask, delay, TimeUnit.MILLISECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 15 è¡Œ ï¼šè¿”å› EndPoint é›†ç¾¤ã€‚<strong>å½“ç¬¬ä¸€æ¬¡é¢„çƒ­å¤±è´¥ï¼Œä¼šè¿”å›ç©ºï¼Œç›´åˆ°å®šæ—¶ä»»åŠ¡è·å¾—åˆ°ç»“æœ</strong>ã€‚</p></li></ul><h1>4. åˆå§‹åŒ–è§£æå™¨</h1><p>Eureka-Client åœ¨åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>DiscoveryClient#scheduleServerEndpointTask()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– AsyncResolver è§£æå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleServerEndpointTask</span><span class="params">(EurekaTransport eurekaTransport,</span></span></div><div class="line"><span class="function"><span class="params">                                            AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</div><div class="line">                                            </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">   <span class="comment">// åˆ›å»º EndPoint è§£æå™¨</span></div><div class="line">   eurekaTransport.bootstrapResolver = EurekaHttpClients.newBootstrapResolver(</div><div class="line">           clientConfig,</div><div class="line">           transportConfig,</div><div class="line">           eurekaTransport.transportClientFactory,</div><div class="line">           applicationInfoManager.getInfo(),</div><div class="line">           applicationsSource</div><div class="line">   );</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>EurekaHttpClients#newBootstrapResolver(...)</code> æ–¹æ³•ï¼Œåˆ›å»º EndPoint è§£æå™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String COMPOSITE_BOOTSTRAP_STRATEGY = <span class="string">"composite"</span>;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClosableResolver&lt;AwsEndpoint&gt; <span class="title">newBootstrapResolver</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">4</span>:         <span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">5</span>:         <span class="keyword">final</span> EurekaTransportConfig transportConfig,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">6</span>:         <span class="keyword">final</span> TransportClientFactory transportClientFactory,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">7</span>:         <span class="keyword">final</span> InstanceInfo myInstanceInfo,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">8</span>:         <span class="keyword">final</span> ApplicationsResolver.ApplicationsSource applicationsSource)</span></span></div><div class="line"><span class="function"> 9: </span>&#123;</div><div class="line"><span class="number">10</span>:     <span class="keyword">if</span> (COMPOSITE_BOOTSTRAP_STRATEGY.equals(transportConfig.getBootstrapResolverStrategy())) &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">return</span> compositeBootstrapResolver(</div><div class="line"><span class="number">13</span>:                     clientConfig,</div><div class="line"><span class="number">14</span>:                     transportConfig,</div><div class="line"><span class="number">15</span>:                     transportClientFactory,</div><div class="line"><span class="number">16</span>:                     myInstanceInfo,</div><div class="line"><span class="number">17</span>:                     applicationsSource</div><div class="line"><span class="number">18</span>:             );</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             logger.warn(<span class="string">"Cannot create a composite bootstrap resolver if registry fetch is disabled."</span> +</div><div class="line"><span class="number">21</span>:                     <span class="string">" Falling back to using a default bootstrap resolver."</span>);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:     <span class="comment">// if all else fails, return the default</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> defaultBootstrapResolver(clientConfig, myInstanceInfo);</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">30:  * <span class="doctag">@return</span> a bootstrap resolver that resolves eureka server endpoints based on either DNS or static config,</span></div><div class="line"><span class="comment">31:  *         depending on configuration for one or the other. This resolver will warm up at the start.</span></div><div class="line"><span class="comment">32:  */</span></div><div class="line"><span class="number">33</span>: <span class="function"><span class="keyword">static</span> ClosableResolver&lt;AwsEndpoint&gt; <span class="title">defaultBootstrapResolver</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">34</span>:                                                               <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span> </span>&#123;</div><div class="line"><span class="number">35</span>:     <span class="comment">// è·å¾— å¯ç”¨åŒºé›†åˆ</span></div><div class="line"><span class="number">36</span>:     String[] availZones = clientConfig.getAvailabilityZones(clientConfig.getRegion());</div><div class="line"><span class="number">37</span>:     <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çš„ å¯ç”¨åŒº</span></div><div class="line"><span class="number">38</span>:     String myZone = InstanceInfo.getZone(availZones, myInstanceInfo);</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="comment">// åˆ›å»º ZoneAffinityClusterResolver</span></div><div class="line"><span class="number">41</span>:     ClusterResolver&lt;AwsEndpoint&gt; delegateResolver = <span class="keyword">new</span> ZoneAffinityClusterResolver(</div><div class="line"><span class="number">42</span>:             <span class="keyword">new</span> ConfigClusterResolver(clientConfig, myInstanceInfo),</div><div class="line"><span class="number">43</span>:             myZone,</div><div class="line"><span class="number">44</span>:             <span class="keyword">true</span></div><div class="line"><span class="number">45</span>:     );</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="comment">// ç¬¬ä¸€æ¬¡ EndPoint è§£æ</span></div><div class="line"><span class="number">48</span>:     List&lt;AwsEndpoint&gt; initialValue = delegateResolver.getClusterEndpoints();</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:     <span class="comment">// è§£æä¸åˆ° Eureka-Server EndPoint ï¼Œå¿«é€Ÿå¤±è´¥</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">if</span> (initialValue.isEmpty()) &#123;</div><div class="line"><span class="number">52</span>:         String msg = <span class="string">"Initial resolution of Eureka server endpoints failed. Check ConfigClusterResolver logs for more info"</span>;</div><div class="line"><span class="number">53</span>:         logger.error(msg);</div><div class="line"><span class="number">54</span>:         failFastOnInitCheck(clientConfig, msg);</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="comment">// åˆ›å»º AsyncResolver</span></div><div class="line"><span class="number">58</span>:     <span class="keyword">return</span> <span class="keyword">new</span> AsyncResolver&lt;&gt;(</div><div class="line"><span class="number">59</span>:             EurekaClientNames.BOOTSTRAP,</div><div class="line"><span class="number">60</span>:             delegateResolver,</div><div class="line"><span class="number">61</span>:             initialValue,</div><div class="line"><span class="number">62</span>:             <span class="number">1</span>,</div><div class="line"><span class="number">63</span>:             clientConfig.getEurekaServiceUrlPollIntervalSeconds() * <span class="number">1000</span></div><div class="line"><span class="number">64</span>:     );</div><div class="line"><span class="number">65</span>: &#125;</div></pre></td></tr></table></figure></p></li></ul><pre><code>* ç¬¬ 10 è‡³ 23 è¡Œ ï¼šç»„åˆè§£æå™¨ï¼Œç”¨äº Eureka 1.x å¯¹ Eureka 2.x çš„å…¼å®¹é…ç½®ï¼Œæš‚æ—¶ä¸éœ€è¦äº†è§£ã€‚TODO[0028]å†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤* ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ `#defaultBootstrapResolver()` æ–¹æ³•ï¼Œåˆ›å»ºé»˜è®¤çš„è§£æå™¨ AsyncResolver ã€‚* ç¬¬ 40 è‡³ 45 è¡Œ ï¼šåˆ›å»º ZoneAffinityClusterResolver ã€‚åœ¨ ZoneAffinityClusterResolver æ„é€ æ–¹æ³•çš„å‚æ•°ï¼Œæˆ‘ä»¬çœ‹åˆ°åˆ›å»º ConfigClusterResolver ä½œä¸º `delegate` å‚æ•°ã€‚* ç¬¬ 48 è¡Œ ï¼šè°ƒç”¨ `ZoneAffinityClusterResolver#getClusterEndpoints()` æ–¹æ³•ï¼Œ**ç¬¬ä¸€æ¬¡ Eureka-Server EndPoint é›†ç¾¤è§£æ**ã€‚* ç¬¬ 51 è‡³ 55 è¡Œ ï¼šè§£æä¸åˆ° Eureka-Server EndPoint é›†ç¾¤æ—¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®( `eureka.experimental.clientTransportFailFastOnInit=true` )ï¼Œä½¿ Eureka-Client åˆå§‹åŒ–å¤±è´¥ã€‚`#failFastOnInitCheck(...)` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š    <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// potential future feature, guarding with experimental flag for now</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">failFastOnInitCheck</span><span class="params">(EurekaClientConfig clientConfig, String msg)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="string">"true"</span>.equals(clientConfig.getExperimental(<span class="string">"clientTransportFailFastOnInit"</span>))) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>    * x</code></pre><ul><li><p>ç¬¬ 58 è‡³ 64 è¡Œ ï¼šåˆ›å»º AsyncResolver ã€‚ä»ä»£ç ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>AsyncResolver.resultsRef</code> å±æ€§ä¸€å¼€å§‹å·²ç»ç”¨ <code>initialValue</code> ä¼ é€’ç»™ AsyncResolver æ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncResolver</span><span class="params">(String name,</span></span></div><div class="line"><span class="function"><span class="params">                      ClusterResolver&lt;T&gt; delegate,</span></span></div><div class="line"><span class="function"><span class="params">                      List&lt;T&gt; initialValues,</span></span></div><div class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> executorThreadPoolSize,</span></span></div><div class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> refreshIntervalMs)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(</div><div class="line">             name,</div><div class="line">             delegate,</div><div class="line">             initialValues,</div><div class="line">             executorThreadPoolSize,</div><div class="line">             refreshIntervalMs,</div><div class="line">             <span class="number">0</span></div><div class="line">     );</div><div class="line">    </div><div class="line">     <span class="comment">// è®¾ç½®å·²ç»é¢„çƒ­</span></div><div class="line">     warmedUp.set(<span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul><h1>666. å½©è›‹</h1><p>T T  ä¸€å¼€å§‹çœ‹è§£æå™¨ï¼Œæ²¡ååº”è¿‡æ¥æ˜¯å§”æ‰˜è®¾è®¡æ¨¡å¼ï¼Œä¸€è„¸æ‡µé€¼+ä¸€è„¸æ‡µé€¼+ä¸€è„¸æ‡µé€¼ã€‚åé¢ç†é¡ºäº†ï¼Œå‘ç°è¶…çº§å¥ˆæ–¯( Nice ) å•Š ï¼ï¼ï¼ï¼</p><p>èƒ–å‹ï¼Œä½ å­¦ä¼šäº†ä¹ˆï¼Ÿ</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/end-point-and-resolver/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†</title>
    <link href="http://www.iocoder.cn/Eureka/batch-tasks/"/>
    <id>http://www.iocoder.cn/Eureka/batch-tasks/</id>
    <published>2018-07-16T16:00:00.000Z</published>
    <updated>2017-10-17T14:06:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/batch-tasks/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">2. æ•´ä½“æµç¨‹</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">3. ä»»åŠ¡å¤„ç†å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>ä»»åŠ¡æ‰¹å¤„ç†</strong>ã€‚Eureka-Server é›†ç¾¤é€šè¿‡ä»»åŠ¡æ‰¹å¤„ç†åŒæ­¥åº”ç”¨å®ä¾‹æ³¨å†Œå®ä¾‹ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿæ˜¯ä¸º Eureka-Server é›†ç¾¤åŒæ­¥çš„åˆ†äº«åšé“ºå«ã€‚</p><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.eureka.util.batcher</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_17/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_17/02.png" alt=""></p><ul><li>ç´«è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡åˆ†å‘å™¨</li><li>è“è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æ¥æ”¶å™¨</li><li>çº¢è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æ‰§è¡Œå™¨</li><li>ç»¿è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡å¤„ç†å™¨</li><li>é»„è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æŒæœ‰è€…( ä»»åŠ¡ )</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. æ•´ä½“æµç¨‹</h1><p>ä»»åŠ¡æ‰§è¡Œçš„æ•´ä½“æµç¨‹å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_17/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_17/01.png" alt=""></p><ul><li><p>ç»†ç®­å¤´ â€”â€” ä»»åŠ¡æ‰§è¡Œç»å†çš„æ“ä½œ</p></li><li><p>ç²—ç®­å¤´ â€”â€” ä»»åŠ¡é˜Ÿåˆ—æµè½¬çš„æ–¹å‘</p></li><li><p><strong>ä¸åŒäº</strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»»åŠ¡æäº¤äº†<strong>ç«‹å³</strong>åŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œï¼Œä»»åŠ¡çš„æ‰§è¡Œæ‹†åˆ†äº†<strong>ä¸‰å±‚é˜Ÿåˆ—</strong>ï¼š</p><ul><li><p>ç¬¬ä¸€å±‚ï¼Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ï¼Œé‡æ–°å¤„ç†é˜Ÿåˆ—( <code>reprocessQueue</code> )ã€‚</p><ul><li>è“çº¿ï¼šåˆ†å‘å™¨åœ¨æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œè¯·æ±‚åï¼Œæäº¤åˆ°æ¥æ”¶é˜Ÿåˆ—ï¼Œ<strong>ä»»åŠ¡å®é™…æœªæ‰§è¡Œ</strong>ã€‚</li><li>é»„çº¿ï¼šæ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹å¤„ç†ä»»åŠ¡å¤±è´¥ï¼Œå°†ç¬¦åˆæ¡ä»¶( è§ <a href="#">ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> )çš„å¤±è´¥ä»»åŠ¡æäº¤åˆ°é‡æ–°æ‰§è¡Œé˜Ÿåˆ—ã€‚</li></ul></li><li><p>ç¬¬äºŒå±‚ï¼Œå¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )</p><ul><li>ç²‰çº¿ï¼šæ¥æ”¶çº¿ç¨‹( Runner )å°†é‡æ–°æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ¥æ”¶é˜Ÿåˆ—æäº¤åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚</li></ul></li><li><p>ç¬¬ä¸‰å±‚ï¼Œå·¥ä½œé˜Ÿåˆ—( <code>workQueue</code> )</p><ul><li>ç²‰çº¿ï¼šæ¥æ”¶çº¿ç¨‹( Runner )å°†å¾…æ‰§è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡æ ¹æ®å‚æ•°( <code>maxBatchingSize</code> )å°†ä»»åŠ¡åˆå¹¶æˆ<strong>æ‰¹é‡ä»»åŠ¡</strong>ï¼Œè°ƒåº¦( æäº¤ )åˆ°å·¥ä½œé˜Ÿåˆ—ã€‚</li><li>é»„çº¿ï¼šæ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹<strong>æ± </strong>ï¼Œä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¯ä»¥æ‹‰å–ä¸€ä¸ª<strong>æ‰¹é‡ä»»åŠ¡</strong>è¿›è¡Œæ‰§è¡Œã€‚</li></ul></li></ul></li><li><p><strong>ä¸‰å±‚é˜Ÿåˆ—çš„å¥½å¤„</strong>ï¼š</p><ul><li>æ¥æ”¶é˜Ÿåˆ—ï¼Œé¿å…å¤„ç†ä»»åŠ¡çš„é˜»å¡ç­‰å¾…ã€‚</li><li>æ¥æ”¶çº¿ç¨‹( Runner )åˆå¹¶ä»»åŠ¡ï¼Œå°†ç›¸åŒä»»åŠ¡ç¼–å·( <strong>æ˜¯çš„ï¼Œä»»åŠ¡æ˜¯å¸¦æœ‰ç¼–å·çš„</strong> )çš„ä»»åŠ¡åˆå¹¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>Eureka-Server ä¸ºé›†ç¾¤åŒæ­¥æä¾›æ‰¹é‡æ“ä½œ<strong>å¤šä¸ª</strong>åº”ç”¨å®ä¾‹çš„<strong>æ¥å£</strong>ï¼Œä¸€ä¸ª<strong>æ‰¹é‡ä»»åŠ¡</strong>å¯ä»¥ä¸€æ¬¡è°ƒåº¦æ¥å£å®Œæˆï¼Œé¿å…å¤šæ¬¡è°ƒç”¨çš„å¼€é”€ã€‚å½“ç„¶ï¼Œè¿™æ ·åšçš„å‰ææ˜¯åˆå¹¶ä»»åŠ¡ï¼Œè¿™ä¹Ÿå¯¼è‡´ Eureka-Server é›†ç¾¤ä¹‹é—´å¯¹åº”ç”¨å®ä¾‹çš„æ³¨å†Œå’Œä¸‹çº¿å¸¦æ¥æ›´å¤§çš„å»¶è¿Ÿã€‚<strong>æ¯•ç«Ÿï¼ŒEureka æ˜¯åœ¨ CAP ä¹‹é—´ï¼Œé€‰æ‹©äº† AP</strong>ã€‚</li></ul></li></ul><h1>3. ä»»åŠ¡å¤„ç†å™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskProcessor</code> ï¼Œä»»åŠ¡å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskProcessor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * A processed task/task list ends up in one of the following states:</span></div><div class="line"><span class="comment">     * &lt;ul&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> Success&#125; processing finished successfully&lt;/li&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> TransientError&#125; processing failed, but shall be retried later&lt;/li&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> PermanentError&#125; processing failed, and is non recoverable&lt;/li&gt;</span></div><div class="line"><span class="comment">     * &lt;/ul&gt;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">enum</span> ProcessingResult &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æˆåŠŸ</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Success,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æ‹¥æŒ¤é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Congestion,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * ç¬æ—¶é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        TransientError,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æ°¸ä¹…é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        PermanentError</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤„ç†å•ä»»åŠ¡</span></div><div class="line"><span class="comment">     * In non-batched mode a single task is processed at a time.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ProcessingResult <span class="title">process</span><span class="params">(T task)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤„ç†æ‰¹é‡ä»»åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * For batched mode a collection of tasks is run at a time. The result is provided for the aggregated result,</span></div><div class="line"><span class="comment">     * and all tasks are handled in the same way according to what is returned (for example are rescheduled, if the</span></div><div class="line"><span class="comment">     * error is transient).</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ProcessingResult <span class="title">process</span><span class="params">(List&lt;T&gt; tasks)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ProcessingResult ï¼Œå¤„ç†ä»»åŠ¡ç»“æœã€‚<ul><li><code>Success</code> ï¼ŒæˆåŠŸã€‚</li><li><code>Congestion</code> ï¼Œæ‹¥æŒ¤é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«é‡è¯•</strong>ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚è¢«é™æµã€‚</li><li><code>TransientError</code> ï¼Œç¬æ—¶é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«é‡è¯•</strong>ã€‚ä¾‹å¦‚ï¼Œç½‘ç»œè¯·æ±‚è¶…æ—¶ã€‚</li><li><code>PermanentError</code> ï¼Œæ°¸ä¹…é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«ä¸¢å¼ƒ</strong>ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œæ—¶å‘ç”Ÿç¨‹åºå¼‚å¸¸ã€‚</li></ul></li><li><code>#process(task)</code> æ–¹æ³•ï¼Œå¤„ç†å•ä»»åŠ¡ã€‚</li><li><code>#process(tasks)</code> æ–¹æ³•ï¼Œå¤„ç†æ‰¹é‡ä»»åŠ¡ã€‚</li></ul><h1>4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskDispatcher</code> ï¼Œä»»åŠ¡åˆ†å‘å™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskDispatcher</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#process(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç¼–å·ï¼Œä»»åŠ¡ï¼Œä»»åŠ¡è¿‡æœŸæ—¶é—´ç»™ä»»åŠ¡åˆ†å‘å™¨å¤„ç†ã€‚</li></ul><p><code>com.netflix.eureka.util.batcher.TaskDispatchers</code> ï¼Œä»»åŠ¡åˆ†å‘å™¨<strong>å·¥å‚ç±»</strong>ï¼Œç”¨äºåˆ›å»ºä»»åŠ¡åˆ†å‘å™¨ã€‚å…¶å†…éƒ¨æä¾›ä¸¤ç§ä»»åŠ¡åˆ†å‘å™¨çš„å®ç°ï¼š</p><ul><li><strong>æ‰¹é‡ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server é›†ç¾¤æ³¨å†Œä¿¡æ¯çš„åŒæ­¥ä»»åŠ¡ã€‚</li><li><strong>å•ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( Autoscaling Group ) åŒæ­¥çŠ¶æ€ã€‚è™½ç„¶æœ¬ç³»åˆ—æš‚æ—¶å¯¹ AWS ç›¸å…³çš„ä¸åšè§£æï¼Œä»å·¥å…·ç±»çš„è§’åº¦æ¥è¯´ï¼Œæœ¬æ–‡ä¼šå¯¹è¯¥åˆ†å‘å™¨è¿›è¡Œåˆ†äº«ã€‚</li></ul><p><code>com.netflix.eureka.cluster.ReplicationTaskProcessor</code> ï¼Œå®ç° TaskDispatcher ï¼ŒEureka-Server é›†ç¾¤ä»»åŠ¡å¤„ç†å™¨ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/6e1b694898aa2f4c155936420c2ce5850f142742/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>è‡ªå·±ç ”ç©¶ï¼Œæˆ‘ä»¬å°†åœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2>4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</h2><p>è°ƒç”¨ <code>TaskDispatchers#createBatchingTaskDispatcher(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ‰¹é‡ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskDispatchers.java</span></div><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">  2:  * åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment">  3:  *</span></div><div class="line"><span class="comment">  4:  * <span class="doctag">@param</span> id ä»»åŠ¡æ‰§è¡Œå™¨ç¼–å·</span></div><div class="line"><span class="comment">  5:  * <span class="doctag">@param</span> maxBufferSize å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">  6:  * <span class="doctag">@param</span> workloadSize å•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">  7:  * <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">  8:  * <span class="doctag">@param</span> maxBatchingDelay æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">  9:  * <span class="doctag">@param</span> congestionRetryDelayMs è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 10:  * <span class="doctag">@param</span> networkFailureRetryMs ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 11:  * <span class="doctag">@param</span> taskProcessor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment"> 12:  * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment"> 13:  * <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment"> 14:  * <span class="doctag">@return</span> æ‰¹é‡ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment"> 15:  */</span></div><div class="line"> <span class="number">16</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskDispatcher&lt;ID, T&gt; <span class="title">createBatchingTaskDispatcher</span><span class="params">(String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">17</span>:                                                                          <span class="keyword">int</span> maxBufferSize,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">18</span>:                                                                          <span class="keyword">int</span> workloadSize,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">19</span>:                                                                          <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">20</span>:                                                                          <span class="keyword">long</span> maxBatchingDelay,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">21</span>:                                                                          <span class="keyword">long</span> congestionRetryDelayMs,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">22</span>:                                                                          <span class="keyword">long</span> networkFailureRetryMs,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">23</span>:                                                                          TaskProcessor&lt;T&gt; taskProcessor)</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:     <span class="comment">// åˆ›å»º ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"> <span class="number">25</span>:     <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor = <span class="keyword">new</span> AcceptorExecutor&lt;&gt;(</div><div class="line"> <span class="number">26</span>:             id, maxBufferSize, workloadSize, maxBatchingDelay, congestionRetryDelayMs, networkFailureRetryMs</div><div class="line"> <span class="number">27</span>:     );</div><div class="line"> <span class="number">28</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"> <span class="number">29</span>:     <span class="keyword">final</span> TaskExecutors&lt;ID, T&gt; taskExecutor = TaskExecutors.batchExecutors(id, workerCount, taskProcessor, acceptorExecutor);</div><div class="line"> <span class="number">30</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡ä»»åŠ¡åˆ†å‘å™¨</span></div><div class="line"> <span class="number">31</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TaskDispatcher&lt;ID, T&gt;() &#123;</div><div class="line"> <span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line"> <span class="number">34</span>:             acceptorExecutor.process(id, task, expiryTime);</div><div class="line"> <span class="number">35</span>:         &#125;</div><div class="line"> <span class="number">36</span>: </div><div class="line"> <span class="number">37</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">38</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">39</span>:             acceptorExecutor.shutdown();</div><div class="line"> <span class="number">40</span>:             taskExecutor.shutdown();</div><div class="line"> <span class="number">41</span>:         &#125;</div><div class="line"> <span class="number">42</span>:     &#125;;</div><div class="line"> <span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 1 è‡³ 23 è¡Œ ï¼šæ–¹æ³•å‚æ•°ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li><code>workloadSize</code> å‚æ•°ï¼Œå•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡ã€‚</li><li><code>taskProcessor</code> å‚æ•°ï¼Œ<strong>è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨å®ç°</strong>ã€‚</li></ul></li><li>ç¬¬ 24 è‡³ 27 è¡Œ ï¼šåˆ›å»ºä»»åŠ¡<strong>æ¥æ”¶</strong>æ‰§è¡Œå™¨ã€‚åœ¨ <a href="#">ã€Œ5. åˆ›å»ºä»»åŠ¡æ¥æ”¶å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡</strong>ä»»åŠ¡æ‰§è¡Œå™¨ã€‚åœ¨ <a href="#">ã€Œ6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 30 è‡³ 42 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡</strong>ä»»åŠ¡åˆ†å‘å™¨ã€‚<ul><li>ç¬¬ 32 è‡³ 35 è¡Œ ï¼š<code>#process()</code> æ–¹æ³•çš„å®ç°ï¼Œè°ƒç”¨ <code>AcceptorExecutor#process(...)</code> æ–¹æ³•ï¼Œæäº¤ [ ä»»åŠ¡ç¼–å· , ä»»åŠ¡ , ä»»åŠ¡è¿‡æœŸæ—¶é—´ ] ç»™ä»»åŠ¡åˆ†å‘å™¨å¤„ç†ã€‚</li></ul></li></ul><h2>4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</h2><p>è°ƒç”¨ <code>TaskDispatchers#createNonBatchingTaskDispatcher(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> id ä»»åŠ¡æ‰§è¡Œå™¨ç¼–å·</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> maxBufferSize å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> maxBatchingDelay æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> congestionRetryDelayMs è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 9:  * <span class="doctag">@param</span> networkFailureRetryMs ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">10:  * <span class="doctag">@param</span> taskProcessor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">11:  * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">12:  * <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">13:  * <span class="doctag">@return</span> å•ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment">14:  */</span></div><div class="line"><span class="number">15</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskDispatcher&lt;ID, T&gt; <span class="title">createNonBatchingTaskDispatcher</span><span class="params">(String id,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">16</span>:                                                                             <span class="keyword">int</span> maxBufferSize,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">17</span>:                                                                             <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">18</span>:                                                                             <span class="keyword">long</span> maxBatchingDelay,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">19</span>:                                                                             <span class="keyword">long</span> congestionRetryDelayMs,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>:                                                                             <span class="keyword">long</span> networkFailureRetryMs,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">21</span>:                                                                             TaskProcessor&lt;T&gt; taskProcessor)</span> </span>&#123;</div><div class="line"><span class="number">22</span>:     <span class="comment">// åˆ›å»º ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor = <span class="keyword">new</span> AcceptorExecutor&lt;&gt;(</div><div class="line"><span class="number">24</span>:             id, maxBufferSize, <span class="comment">/* workloadSize = 1 */</span><span class="number">1</span>, maxBatchingDelay, congestionRetryDelayMs, networkFailureRetryMs</div><div class="line"><span class="number">25</span>:     );</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> TaskExecutors&lt;ID, T&gt; taskExecutor = TaskExecutors.singleItemExecutors(id, workerCount, taskProcessor, acceptorExecutor);</div><div class="line"><span class="number">27</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TaskDispatcher&lt;ID, T&gt;() &#123;</div><div class="line"><span class="number">28</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">29</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line"><span class="number">30</span>:             acceptorExecutor.process(id, task, expiryTime);</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">34</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">35</span>:             acceptorExecutor.shutdown();</div><div class="line"><span class="number">36</span>:             taskExecutor.shutdown();</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 1 è‡³ 21 è¡Œ ï¼šæ–¹æ³•å‚æ•°ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li><s><code>workloadSize</code> å‚æ•°</s>ï¼Œç›¸æ¯” <code>#createBatchingTaskDispatcher(...)</code> å°‘è¿™ä¸ªå‚æ•°ã€‚<strong>åœ¨ç¬¬ 24 è¡Œï¼Œä½ ä¼šå‘ç°è¯¥å‚æ•°ä¼ é€’ç»™ AcceptorExecutor ä½¿ç”¨ 1 å™¢</strong>ã€‚</li><li><code>taskProcessor</code> å‚æ•°ï¼Œ<strong>è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨å®ç°</strong>ã€‚</li></ul></li><li>ç¬¬ 21 è‡³ 25 è¡Œ ï¼šåˆ›å»ºä»»åŠ¡<strong>æ¥æ”¶</strong>æ‰§è¡Œå™¨ã€‚å’Œ <code>#createBatchingTaskDispatcher(...)</code> åªå·® <code>workloadSize = 1</code> å‚æ•°ã€‚åœ¨ <a href="#">ã€Œ5. åˆ›å»ºä»»åŠ¡æ¥æ”¶å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šåˆ›å»º<strong>å•</strong>ä»»åŠ¡æ‰§è¡Œå™¨ã€‚<strong>å’Œ <code>#createBatchingTaskDispatcher(...)</code> å·®åˆ«å¾ˆå¤§</strong>ã€‚<a href="#">ã€Œ6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 30 è‡³ 42 è¡Œ ï¼šåˆ›å»º<strong>å•</strong>ä»»åŠ¡åˆ†å‘å™¨ã€‚å’Œ <code>#createBatchingTaskDispatcher(...)</code> ä¸€æ ·ã€‚</li></ul><h1>5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</h1><p><code>com.netflix.eureka.util.batcher.AcceptorExecutor</code> ï¼Œä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€‚åˆ›å»ºæ„é€ æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">AcceptorExecutor</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AcceptorExecutor.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:      * å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment"> 7:      * &#123;<span class="doctag">@link</span> #processingOrder&#125;</span></div><div class="line"><span class="comment"> 8:      */</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBufferSize;</div><div class="line"><span class="number">10</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">11:      * å•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">12:      */</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBatchingSize;</div><div class="line"><span class="number">14</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">15:      * æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">16:      */</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> maxBatchingDelay;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">20:      * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">21:      */</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="number">23</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">24:      * æ¥æ”¶ä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">25:      */</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; acceptorQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">28:      * é‡æ–°æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">29:      */</span></div><div class="line"><span class="number">30</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingDeque&lt;TaskHolder&lt;ID, T&gt;&gt; reprocessQueue = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;();</div><div class="line"><span class="number">31</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">32:      * æ¥æ”¶ä»»åŠ¡çº¿ç¨‹</span></div><div class="line"><span class="comment">33:      */</span></div><div class="line"><span class="number">34</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Thread acceptorThread;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">37:      * å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„</span></div><div class="line"><span class="comment">38:      */</span></div><div class="line"><span class="number">39</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ID, TaskHolder&lt;ID, T&gt;&gt; pendingTasks = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="number">40</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">41:      * å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">42:      */</span></div><div class="line"><span class="number">43</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;ID&gt; processingOrder = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">46:      * å•ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">47:      */</span></div><div class="line"><span class="number">48</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Semaphore singleItemWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="number">49</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">50:      * å•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">51:      */</span></div><div class="line"><span class="number">52</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; singleItemWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">55:      * æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">56:      */</span></div><div class="line"><span class="number">57</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Semaphore batchWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="number">58</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">59:      * æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">60:      */</span></div><div class="line"><span class="number">61</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; batchWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">62</span>: </div><div class="line"><span class="number">63</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">64:      * ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></div><div class="line"><span class="comment">65:      */</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">private</span> <span class="keyword">final</span> TrafficShaper trafficShaper;</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:     AcceptorExecutor(String id,</div><div class="line"><span class="number">69</span>:                      <span class="keyword">int</span> maxBufferSize,</div><div class="line"><span class="number">70</span>:                      <span class="keyword">int</span> maxBatchingSize,</div><div class="line"><span class="number">71</span>:                      <span class="keyword">long</span> maxBatchingDelay,</div><div class="line"><span class="number">72</span>:                      <span class="keyword">long</span> congestionRetryDelayMs,</div><div class="line"><span class="number">73</span>:                      <span class="keyword">long</span> networkFailureRetryMs) &#123;</div><div class="line"><span class="number">74</span>:         <span class="keyword">this</span>.maxBufferSize = maxBufferSize;</div><div class="line"><span class="number">75</span>:         <span class="keyword">this</span>.maxBatchingSize = maxBatchingSize;</div><div class="line"><span class="number">76</span>:         <span class="keyword">this</span>.maxBatchingDelay = maxBatchingDelay;</div><div class="line"><span class="number">77</span>: </div><div class="line"><span class="number">78</span>:         <span class="comment">// åˆ›å»º ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></div><div class="line"><span class="number">79</span>:         <span class="keyword">this</span>.trafficShaper = <span class="keyword">new</span> TrafficShaper(congestionRetryDelayMs, networkFailureRetryMs);</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:         <span class="comment">// åˆ›å»º æ¥æ”¶ä»»åŠ¡çº¿ç¨‹</span></div><div class="line"><span class="number">82</span>:         ThreadGroup threadGroup = <span class="keyword">new</span> ThreadGroup(<span class="string">"eurekaTaskExecutors"</span>);</div><div class="line"><span class="number">83</span>:         <span class="keyword">this</span>.acceptorThread = <span class="keyword">new</span> Thread(threadGroup, <span class="keyword">new</span> AcceptorRunner(), <span class="string">"TaskAcceptor-"</span> + id);</div><div class="line"><span class="number">84</span>:         <span class="keyword">this</span>.acceptorThread.setDaemon(<span class="keyword">true</span>);</div><div class="line"><span class="number">85</span>:         <span class="keyword">this</span>.acceptorThread.start();</div><div class="line"><span class="number">86</span>: </div><div class="line"><span class="number">87</span>:         <span class="comment">// TODO ï¼ˆçœç•¥ä»£ç ï¼‰èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line"><span class="number">88</span>:     &#125;</div><div class="line"><span class="number">89</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è‡³ 61 è¡Œ ï¼šå±æ€§ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li>çœ¼å°–å¦‚ä½ ï¼Œä¼šå‘ç° AcceptorExecutor å³å­˜åœ¨å•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>singleItemWorkQueue</code> )ï¼Œåˆå­˜åœ¨æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>batchWorkQueue</code> ) ï¼Œåœ¨ <a href="#">ã€Œ9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘ã€</a> ä¼šè§£ç­”è¿™ä¸ªç–‘æƒ‘ã€‚</li></ul></li><li>ç¬¬ 78 è‡³ 79 è¡Œ ï¼šåˆ›å»ºç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€‚åœ¨ <a href="#">ã€Œ7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 81 è‡³ 85 è¡Œ ï¼š<strong>åˆ›å»ºæ¥æ”¶ä»»åŠ¡çº¿ç¨‹</strong>ã€‚</li></ul><h1>6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskExecutors</code> ï¼Œä»»åŠ¡æ‰§è¡Œå™¨ã€‚<strong>å…¶å†…éƒ¨æä¾›åˆ›å»ºå•ä»»åŠ¡å’Œæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨çš„ä¸¤ç§æ–¹æ³•</strong>ã€‚TaskExecutors æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskExecutors</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TaskExecutors.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å·¥ä½œçº¿ç¨‹æ± </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Thread&gt; workerThreads;</div><div class="line"></div><div class="line">    TaskExecutors(WorkerRunnableFactory&lt;ID, T&gt; workerRunnableFactory, <span class="keyword">int</span> workerCount, AtomicBoolean isShutdown) &#123;</div><div class="line">        <span class="keyword">this</span>.isShutdown = isShutdown;</div><div class="line">        <span class="keyword">this</span>.workerThreads = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»º å·¥ä½œçº¿ç¨‹æ± </span></div><div class="line">        ThreadGroup threadGroup = <span class="keyword">new</span> ThreadGroup(<span class="string">"eurekaTaskExecutors"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; workerCount; i++) &#123;</div><div class="line">            WorkerRunnable&lt;ID, T&gt; runnable = workerRunnableFactory.create(i);</div><div class="line">            Thread workerThread = <span class="keyword">new</span> Thread(threadGroup, runnable, runnable.getWorkerName());</div><div class="line">            workerThreads.add(workerThread);</div><div class="line">            workerThread.setDaemon(<span class="keyword">true</span>);</div><div class="line">            workerThread.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºå·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">WorkerRunnableFactory</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="function">WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>workerThreads</code> å±æ€§ï¼Œå·¥ä½œçº¿ç¨‹<strong>æ± </strong>ã€‚<strong>å·¥ä½œä»»åŠ¡é˜Ÿåˆ—ä¼šè¢«å·¥ä½œçº¿ç¨‹æ± å¹¶å‘æ‹‰å–ï¼Œå¹¶å‘æ‰§è¡Œ</strong>ã€‚</li><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnableFactory</code> ï¼Œåˆ›å»ºå·¥ä½œçº¿ç¨‹å·¥å‚<strong>æ¥å£</strong>ã€‚å•ä»»åŠ¡å’Œæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹å®ç°ä¸åŒï¼Œé€šè¿‡è‡ªå®šä¹‰å·¥å‚å®ç°ç±»åˆ›å»ºã€‚</li></ul><h2>6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</h2><p>è°ƒç”¨ <code>TaskExecutors#batchExecutors(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> name ä»»åŠ¡æ‰§è¡Œå™¨å</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> processor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> acceptorExecutor æ¥æ”¶ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskExecutors&lt;ID, T&gt; <span class="title">batchExecutors</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics = <span class="keyword">new</span> TaskExecutorMetrics(name);</div><div class="line">   <span class="comment">// åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutors&lt;&gt;(<span class="keyword">new</span> WorkerRunnableFactory&lt;ID, T&gt;() &#123; <span class="comment">// æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> BatchWorkerRunnable&lt;&gt;(<span class="string">"TaskBatchingWorker-"</span> + name + <span class="string">'-'</span> + idx <span class="comment">/* çº¿ç¨‹å */</span>, isShutdown, metrics, processor, acceptorExecutor);</div><div class="line">       &#125;</div><div class="line">   &#125;, workerCount, isShutdown);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable.BatchWorkerRunnable</code> ï¼Œæ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹ã€‚</li></ul><h2>6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</h2><p>è°ƒç”¨ <code>TaskExecutors#singleItemExecutors(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> name ä»»åŠ¡æ‰§è¡Œå™¨å</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> processor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> acceptorExecutor æ¥æ”¶ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskExecutors&lt;ID, T&gt; <span class="title">singleItemExecutors</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics = <span class="keyword">new</span> TaskExecutorMetrics(name);</div><div class="line">   <span class="comment">// åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutors&lt;&gt;(<span class="keyword">new</span> WorkerRunnableFactory&lt;ID, T&gt;() &#123; <span class="comment">// å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SingleTaskWorkerRunnable&lt;&gt;(<span class="string">"TaskNonBatchingWorker-"</span> + name + <span class="string">'-'</span> + idx <span class="comment">/* çº¿ç¨‹å */</span>, isShutdown, metrics, processor, acceptorExecutor);</div><div class="line">       &#125;</div><div class="line">   &#125;, workerCount, isShutdown);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable.SingleTaskWorkerRunnable</code> ï¼Œå•ä»»åŠ¡å·¥ä½œçº¿ç¨‹ã€‚</li></ul><h2>6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</h2><p><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable</code> ï¼Œä»»åŠ¡å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»ã€‚BatchWorkerRunnable å’Œ SingleTaskWorkerRunnable éƒ½å®ç°è¯¥ç±»ï¼Œå·®å¼‚åœ¨ <code>#run()</code> çš„è‡ªå®šä¹‰å®ç°ã€‚WorkerRunnable å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * çº¿ç¨‹å</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> String workerName;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown;</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; taskDispatcher;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ„é€ æ–¹æ³•å’Œ getting æ–¹æ³•ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</h1><p><code>com.netflix.eureka.util.batcher.TrafficShaper</code> ï¼Œç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€‚å½“ä»»åŠ¡æ‰§è¡Œå‘ç”Ÿè¯·æ±‚é™æµï¼Œæˆ–æ˜¯è¯·æ±‚ç½‘ç»œå¤±è´¥çš„æƒ…å†µï¼Œåˆ™å»¶æ—¶ AcceptorRunner å°†ä»»åŠ¡æäº¤åˆ°å·¥ä½œä»»åŠ¡é˜Ÿåˆ—ï¼Œä»è€Œé¿å…ä»»åŠ¡å¾ˆå¿«å»æ‰§è¡Œï¼Œå†æ¬¡å‘ç”Ÿä¸Šè¿°æƒ…å†µã€‚TrafficShaper å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrafficShaper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Upper bound on delay provided by configuration.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_DELAY = <span class="number">30</span> * <span class="number">1000</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> congestionRetryDelayMs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> networkFailureRetryMs;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åè¯·æ±‚é™æµæ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastCongestionError;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åç½‘ç»œå¤±è´¥æ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastNetworkFailure;</div><div class="line"></div><div class="line">    TrafficShaper(<span class="keyword">long</span> congestionRetryDelayMs, <span class="keyword">long</span> networkFailureRetryMs) &#123;</div><div class="line">        <span class="keyword">this</span>.congestionRetryDelayMs = Math.min(MAX_DELAY, congestionRetryDelayMs);</div><div class="line">        <span class="keyword">this</span>.networkFailureRetryMs = Math.min(MAX_DELAY, networkFailureRetryMs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerFailure</span><span class="params">(ProcessingResult processingResult)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (processingResult == ProcessingResult.Congestion) &#123;</div><div class="line">            lastCongestionError = System.currentTimeMillis();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processingResult == ProcessingResult.TransientError) &#123;</div><div class="line">            lastNetworkFailure = System.currentTimeMillis();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¡ç®—æäº¤å»¶è¿Ÿï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å»¶è¿Ÿ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">long</span> <span class="title">transmissionDelay</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// æ— å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastCongestionError == -<span class="number">1</span> &amp;&amp; lastNetworkFailure == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// è®¡ç®—æœ€åè¯·æ±‚é™æµå¸¦æ¥çš„å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastCongestionError != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">long</span> congestionDelay = now - lastCongestionError;</div><div class="line">            <span class="keyword">if</span> (congestionDelay &gt;= <span class="number">0</span> &amp;&amp; congestionDelay &lt; congestionRetryDelayMs) &#123; <span class="comment">// èŒƒå›´å†…</span></div><div class="line">                <span class="keyword">return</span> congestionRetryDelayMs - congestionDelay; <span class="comment">// è¡¥å……å»¶è¿Ÿ</span></div><div class="line">            &#125;</div><div class="line">            lastCongestionError = -<span class="number">1</span>; <span class="comment">// é‡ç½®æ—¶é—´æˆ³</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// è®¡ç®—æœ€åç½‘ç»œå¤±è´¥å¸¦æ¥çš„å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastNetworkFailure != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">long</span> failureDelay = now - lastNetworkFailure;</div><div class="line">            <span class="keyword">if</span> (failureDelay &gt;= <span class="number">0</span> &amp;&amp; failureDelay &lt; networkFailureRetryMs) &#123; <span class="comment">// èŒƒå›´å†…</span></div><div class="line">                <span class="keyword">return</span> networkFailureRetryMs - failureDelay; <span class="comment">// è¡¥å……å»¶è¿Ÿ</span></div><div class="line">            &#125;</div><div class="line">            lastNetworkFailure = -<span class="number">1</span>; <span class="comment">// é‡ç½®æ—¶é—´æˆ³</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// æ— å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#registerFailure(...)</code> ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œæäº¤ä»»åŠ¡ç»“æœç»™ TrafficShaper ï¼Œè®°å½•å‘ç”Ÿæ—¶é—´ã€‚åœ¨ <a href="#">ã€Œ10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘ã€</a> ä¼šçœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li><li><code>#transmissionDelay(...)</code> ï¼Œè®¡ç®—æäº¤å»¶è¿Ÿï¼Œå•ä½ï¼šæ¯«ç§’ã€‚<a href="#">ã€Œ9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘ã€</a> ä¼šçœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li></ul><h1>8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</h1><p>è°ƒç”¨ <code>AcceptorExecutor#process(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡åˆ°æ¥æ”¶ä»»åŠ¡é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AcceptorExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line">   acceptorQueue.add(<span class="keyword">new</span> TaskHolder&lt;ID, T&gt;(id, task, expiryTime));</div><div class="line">   acceptedTasks++;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.eureka.util.batcher.TaskHolder</code> ï¼Œä»»åŠ¡æŒæœ‰è€…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskHolder</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ID id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T task;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡è¿‡æœŸæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expiryTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æäº¤æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> submitTimestamp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</h1><p>åå°çº¿ç¨‹æ‰§è¡Œ <code>AcceptorRunner#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> scheduleTime = <span class="number">0</span>;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:             <span class="comment">// å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )</span></div><div class="line"> <span class="number">7</span>:             drainInputQueues();</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:             <span class="comment">// å¾…æ‰§è¡Œä»»åŠ¡æ•°é‡</span></div><div class="line"><span class="number">10</span>:             <span class="keyword">int</span> totalItems = processingOrder.size();</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:             <span class="comment">// è®¡ç®—è°ƒåº¦æ—¶é—´</span></div><div class="line"><span class="number">13</span>:             <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (scheduleTime &lt; now) &#123;</div><div class="line"><span class="number">15</span>:                 scheduleTime = now + trafficShaper.transmissionDelay();</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:             <span class="comment">// è°ƒåº¦</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (scheduleTime &lt;= now) &#123;</div><div class="line"><span class="number">20</span>:                 <span class="comment">// è°ƒåº¦æ‰¹é‡ä»»åŠ¡</span></div><div class="line"><span class="number">21</span>:                 assignBatchWork();</div><div class="line"><span class="number">22</span>:                 <span class="comment">// è°ƒåº¦å•ä»»åŠ¡</span></div><div class="line"><span class="number">23</span>:                 assignSingleItemWork();</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:             <span class="comment">// 1ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨æ— ä»»åŠ¡è¯·æ±‚ï¼Œæ­£åœ¨å¿™ç¢Œå¤„ç†ä¹‹å‰çš„ä»»åŠ¡ï¼›æˆ–è€… 2ï¼‰ä»»åŠ¡å»¶è¿Ÿè°ƒåº¦ã€‚ç¡çœ  10 ç§’ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</span></div><div class="line"><span class="number">27</span>:             <span class="comment">// If no worker is requesting data or there is a delay injected by the traffic shaper,</span></div><div class="line"><span class="number">28</span>:             <span class="comment">// sleep for some time to avoid tight loop.</span></div><div class="line"><span class="number">29</span>:             <span class="keyword">if</span> (totalItems == processingOrder.size()) &#123;</div><div class="line"><span class="number">30</span>:                 Thread.sleep(<span class="number">10</span>);</div><div class="line"><span class="number">31</span>:             &#125;</div><div class="line"><span class="number">32</span>:         &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line"><span class="number">33</span>:             <span class="comment">// Ignore</span></div><div class="line"><span class="number">34</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">35</span>:             <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line"><span class="number">36</span>:             logger.warn(<span class="string">"Discovery AcceptorThread error"</span>, e);</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šæ— é™å¾ªç¯æ‰§è¡Œè°ƒåº¦ï¼Œç›´åˆ°å…³é—­ã€‚</p></li><li><p>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šè°ƒç”¨ <code>#drainInputQueues()</code> æ–¹æ³•ï¼Œ<strong>å¾ªç¯</strong>å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )ï¼Œ<strong>ç›´åˆ°</strong>æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainInputQueues</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// å¤„ç†å®Œé‡æ–°æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line"> <span class="number">4</span>:         drainReprocessQueue();</div><div class="line"> <span class="number">5</span>:         <span class="comment">// å¤„ç†å®Œæ¥æ”¶é˜Ÿåˆ—</span></div><div class="line"> <span class="number">6</span>:         drainAcceptorQueue();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾… 10 msï¼Œçœ‹æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æœ‰æ–°ä»»åŠ¡</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (!isShutdown.get()) &#123;</div><div class="line"><span class="number">10</span>:             <span class="comment">// If all queues are empty, block for a while on the acceptor queue</span></div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (reprocessQueue.isEmpty() &amp;&amp; acceptorQueue.isEmpty() &amp;&amp; pendingTasks.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:                 TaskHolder&lt;ID, T&gt; taskHolder = acceptorQueue.poll(<span class="number">10</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (taskHolder != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">14</span>:                     appendTaskHolder(taskHolder);</div><div class="line"><span class="number">15</span>:                 &#125;</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:     &#125; <span class="keyword">while</span> (!reprocessQueue.isEmpty() || !acceptorQueue.isEmpty() || pendingTasks.isEmpty()); <span class="comment">// å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )</span></div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ &amp;&amp; ç¬¬ 18 è¡Œ ï¼š<strong>å¾ªç¯</strong>ï¼Œç›´åˆ°<strong>åŒæ—¶</strong>æ»¡è¶³å¦‚ä¸‹å…¨éƒ¨æ¡ä»¶ï¼š</p><ul><li>é‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>reprocessQueue</code> ) å’Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ä¸ºç©º</li><li>å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„( <code>pendingTasks</code> )<strong>ä¸ä¸ºç©º</strong></li></ul></li><li><p>ç¬¬ 3 è‡³ 4 è¡Œ ï¼šå¤„ç†å®Œé‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>reprocessQueue</code> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainReprocessQueue</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">3</span>:     <span class="keyword">while</span> (!reprocessQueue.isEmpty() &amp;&amp; !isFull()) &#123;</div><div class="line"> <span class="number">4</span>:         TaskHolder&lt;ID, T&gt; taskHolder = reprocessQueue.pollLast(); <span class="comment">// ä¼˜å…ˆæ‹¿è¾ƒæ–°çš„ä»»åŠ¡</span></div><div class="line"> <span class="number">5</span>:         ID id = taskHolder.getId();</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (taskHolder.getExpiryTime() &lt;= now) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"> <span class="number">7</span>:             expiredTasks++;</div><div class="line"> <span class="number">8</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pendingTasks.containsKey(id)) &#123; <span class="comment">// å·²å­˜åœ¨</span></div><div class="line"> <span class="number">9</span>:             overriddenTasks++;</div><div class="line"><span class="number">10</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">11</span>:             pendingTasks.put(id, taskHolder);</div><div class="line"><span class="number">12</span>:             processingOrder.addFirst(id); <span class="comment">// æäº¤åˆ°é˜Ÿå¤´</span></div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;</div><div class="line"><span class="number">15</span>:     <span class="comment">// å¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œæ¸…ç©ºé‡æ–°æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (isFull()) &#123;</div><div class="line"><span class="number">17</span>:         queueOverflows += reprocessQueue.size();</div><div class="line"><span class="number">18</span>:         reprocessQueue.clear();</div><div class="line"><span class="number">19</span>:     &#125;</div><div class="line"><span class="number">20</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šä¼˜å…ˆä»é‡æ–°æ‰§è¡Œä»»åŠ¡çš„é˜Ÿå°¾æ‹¿è¾ƒæ–°çš„ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¿ç•™æ›´æ–°çš„ä»»åŠ¡åœ¨å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„( <code>pendingTasks</code> ) é‡Œã€‚</li><li>ç¬¬ 12 è¡Œ ï¼šæ·»åŠ ä»»åŠ¡ç¼–å·åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> ) çš„å¤´éƒ¨ã€‚æ•ˆæœå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_17/03.png" alt=""></li><li>ç¬¬ 15 è‡³ 18 è¡Œ ï¼šå¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—( <code>pendingTasks</code> )å·²æ»¡ï¼Œæ¸…ç©ºé‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡ã€‚</li></ul></li><li><p>ç¬¬ 5 è‡³ 6 è¡Œ ï¼šå¤„ç†å®Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainAcceptorQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">while</span> (!acceptorQueue.isEmpty()) &#123; <span class="comment">// å¾ªç¯ï¼Œç›´åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">      appendTaskHolder(acceptorQueue.poll());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTaskHolder</span><span class="params">(TaskHolder&lt;ID, T&gt; taskHolder)</span> </span>&#123;</div><div class="line">  <span class="comment">// å¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œç§»é™¤å¾…å¤„ç†é˜Ÿåˆ—ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡</span></div><div class="line">  <span class="keyword">if</span> (isFull()) &#123;</div><div class="line">      pendingTasks.remove(processingOrder.poll());</div><div class="line">      queueOverflows++;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">  TaskHolder&lt;ID, T&gt; previousTask = pendingTasks.put(taskHolder.getId(), taskHolder);</div><div class="line">  <span class="keyword">if</span> (previousTask == <span class="keyword">null</span>) &#123;</div><div class="line">      processingOrder.add(taskHolder.getId());</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      overriddenTasks++;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 8 è‡³ 17 è¡Œ ï¼šå½“æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡ä»æ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> ) æ‹‰å–ä»»åŠ¡ 10 msã€‚è‹¥æ‹‰å–åˆ°ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )ã€‚</p></li></ul></li><li><p>ç¬¬ 12 è‡³ 16 è¡Œ ï¼šè®¡ç®—å¯è°ƒåº¦ä»»åŠ¡çš„æœ€å°æ—¶é—´( <code>scheduleTime</code> )ã€‚</p><ul><li>å½“ <code>scheduleTime</code> å°äºå½“å‰æ—¶é—´ï¼Œä¸é‡æ–°è®¡ç®—ï¼Œå³æ­¤æ—¶éœ€è¦å»¶è¿Ÿç­‰å¾…è°ƒåº¦ã€‚</li><li>å½“ <code>scheduleTime</code> å¤§äºç­‰äºå½“å‰æ—¶é—´ï¼Œé…åˆ <code>TrafficShaper#transmissionDelay(...)</code> é‡æ–°è®¡ç®—ã€‚</li></ul></li><li><p>ç¬¬ 19 è¡Œ ï¼šå½“ <code>scheduleTime</code> å°äºå½“å‰æ—¶é—´ï¼Œæ‰§è¡Œä»»åŠ¡çš„è°ƒåº¦ã€‚</p></li><li><p>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#assignBatchWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦æ‰¹é‡ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">assignBatchWork</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (hasEnoughTasksForNextBatch()) &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// è·å– æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (batchWorkRequests.tryAcquire(<span class="number">1</span>)) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="comment">// è·å–æ‰¹é‡ä»»åŠ¡</span></div><div class="line"> <span class="number">6</span>:             <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">7</span>:             <span class="keyword">int</span> len = Math.min(maxBatchingSize, processingOrder.size());</div><div class="line"> <span class="number">8</span>:             List&lt;TaskHolder&lt;ID, T&gt;&gt; holders = <span class="keyword">new</span> ArrayList&lt;&gt;(len);</div><div class="line"> <span class="number">9</span>:             <span class="keyword">while</span> (holders.size() &lt; len &amp;&amp; !processingOrder.isEmpty()) &#123;</div><div class="line"><span class="number">10</span>:                 ID id = processingOrder.poll();</div><div class="line"><span class="number">11</span>:                 TaskHolder&lt;ID, T&gt; holder = pendingTasks.remove(id);</div><div class="line"><span class="number">12</span>:                 <span class="keyword">if</span> (holder.getExpiryTime() &gt; now) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"><span class="number">13</span>:                     holders.add(holder);</div><div class="line"><span class="number">14</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                     expiredTasks++;</div><div class="line"><span class="number">16</span>:                 &#125;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>:             <span class="comment">//</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (holders.isEmpty()) &#123; <span class="comment">// æœªè°ƒåº¦åˆ°æ‰¹é‡ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="number">20</span>:                 batchWorkRequests.release();</div><div class="line"><span class="number">21</span>:             &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ·»åŠ æ‰¹é‡ä»»åŠ¡åˆ°æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="number">22</span>:                 batchSizeMetric.record(holders.size(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">23</span>:                 batchWorkQueue.add(holders);</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>#hasEnoughTasksForNextBatch()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿä»»åŠ¡è¿›è¡Œä¸‹ä¸€æ¬¡æ‰¹é‡ä»»åŠ¡è°ƒåº¦ï¼š1ï¼‰å¾…æ‰§è¡Œä»»åŠ¡( <code>processingOrder</code> )æ˜ å°„å·²æ»¡ï¼›æˆ–è€… 2ï¼‰åˆ°è¾¾æ‰¹é‡ä»»åŠ¡å¤„ç†æœ€å¤§ç­‰å¾…å»¶è¿Ÿã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasEnoughTasksForNextBatch</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">    <span class="keyword">if</span> (processingOrder.isEmpty()) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„å·²æ»¡</span></div><div class="line">    <span class="keyword">if</span> (pendingTasks.size() &gt;= maxBufferSize) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ°è¾¾æ‰¹é‡ä»»åŠ¡å¤„ç†æœ€å¤§ç­‰å¾…å»¶è¿Ÿ( é€šè¿‡å¾…å¤„ç†é˜Ÿåˆ—çš„å¤´éƒ¨ä»»åŠ¡åˆ¤æ–­ )</span></div><div class="line">    TaskHolder&lt;ID, T&gt; nextHolder = pendingTasks.get(processingOrder.peek());</div><div class="line">    <span class="keyword">long</span> delay = System.currentTimeMillis() - nextHolder.getSubmitTimestamp();</div><div class="line">    <span class="keyword">return</span> delay &gt;= maxBatchingDelay;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 5 è‡³ 17 è¡Œ ï¼šè·å–æ‰¹é‡ä»»åŠ¡( <code>holders</code> )ã€‚ğŸ˜ˆ ä½ ä¼šå‘ç°ï¼Œæœ¬æ–‡è¯´äº†åŠå¤©çš„æ‰¹é‡ä»»åŠ¡ï¼Œå®é™…æ˜¯ <code>List&lt;TaskHolder&lt;ID, T&gt;&gt;</code> å“ˆã€‚</p></li><li><p>ç¬¬ 4 è¡Œ ï¼šè·å–æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡( <code>batchWorkRequests</code> ) ã€‚åœ¨ä»»åŠ¡æ‰§è¡Œå™¨çš„æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå‘å‡º <code>batchWorkRequests</code> ã€‚<strong>æ¯ä¸€ä¸ªä¿¡å·é‡éœ€è¦ä¿è¯è·å–åˆ°ä¸€ä¸ªæ‰¹é‡ä»»åŠ¡</strong>ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 20 è¡Œ ï¼šæœªè°ƒåº¦åˆ°æ‰¹é‡ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡ï¼Œ<strong>ä»£è¡¨è¯·æ±‚å®é™…æœªå®Œæˆï¼Œæ¯ä¸€ä¸ªä¿¡å·é‡éœ€è¦ä¿è¯è·å–åˆ°ä¸€ä¸ªæ‰¹é‡ä»»åŠ¡</strong>ã€‚</p></li><li><p>ç¬¬ 21 è‡³ 24 è¡Œ ï¼šæ·»åŠ æ‰¹é‡ä»»åŠ¡åˆ°æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—ã€‚</p></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#assignSingleItemWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦å•ä»»åŠ¡ã€‚</p></li></ul></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#assignSingleItemWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦å•ä»»åŠ¡ï¼Œå’Œ <code>#assignBatchWork()</code> æ–¹æ³•<strong>ç±»ä¼¼</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">assignSingleItemWork</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!processingOrder.isEmpty()) &#123; <span class="comment">// å¾…æ‰§è¡Œä»»é˜Ÿåˆ—ä¸ä¸ºç©º</span></div><div class="line">      <span class="comment">// è·å– å•ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line">      <span class="keyword">if</span> (singleItemWorkRequests.tryAcquire(<span class="number">1</span>)) &#123;</div><div class="line">          <span class="comment">// ã€å¾ªç¯ã€‘è·å–å•ä»»åŠ¡</span></div><div class="line">          <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">          <span class="keyword">while</span> (!processingOrder.isEmpty()) &#123;</div><div class="line">              ID id = processingOrder.poll(); <span class="comment">// ä¸€å®šä¸ä¸ºç©º</span></div><div class="line">              TaskHolder&lt;ID, T&gt; holder = pendingTasks.remove(id);</div><div class="line">              <span class="keyword">if</span> (holder.getExpiryTime() &gt; now) &#123;</div><div class="line">                  singleItemWorkQueue.add(holder);</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">              expiredTasks++;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// è·å–ä¸åˆ°å•ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡</span></div><div class="line">          singleItemWorkRequests.release();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 26 è‡³ 31 è¡Œ ï¼šå½“è°ƒåº¦ä»»åŠ¡å‰çš„å¾…æ‰§è¡Œä»»åŠ¡æ•°( <code>totalItems</code> )ç­‰äºå½“å‰å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )çš„ä»»åŠ¡æ•°ï¼Œæ„å‘³ç€ï¼š1ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨æ— ä»»åŠ¡è¯·æ±‚ï¼Œæ­£åœ¨å¿™ç¢Œå¤„ç†ä¹‹å‰çš„ä»»åŠ¡ï¼›æˆ–è€… 2ï¼‰ä»»åŠ¡å»¶è¿Ÿè°ƒåº¦ã€‚ç¡çœ  10 ç§’ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p></li></ul><h1>10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</h1><h2>10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</h2><p>æ‰¹é‡ä»»åŠ¡å·¥ä½œåå°çº¿ç¨‹( BatchWorkerRunnable )æ‰§è¡Œ <code>#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">4</span>:         <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line">  <span class="number">5</span>:             <span class="comment">// è·å–æ‰¹é‡ä»»åŠ¡</span></div><div class="line">  <span class="number">6</span>:             List&lt;TaskHolder&lt;ID, T&gt;&gt; holders = getWork();</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">  <span class="number">9</span>:             metrics.registerExpiryTimes(holders);</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:             <span class="comment">// è·å¾—å®é™…æ‰¹é‡ä»»åŠ¡</span></div><div class="line"> <span class="number">12</span>:             List&lt;T&gt; tasks = getTasksOf(holders);</div><div class="line"> <span class="number">13</span>:             <span class="comment">// è°ƒç”¨å¤„ç†å™¨æ‰§è¡Œä»»åŠ¡</span></div><div class="line"> <span class="number">14</span>:             ProcessingResult result = processor.process(tasks);</div><div class="line"> <span class="number">15</span>:             <span class="keyword">switch</span> (result) &#123;</div><div class="line"> <span class="number">16</span>:                 <span class="keyword">case</span> Success:</div><div class="line"> <span class="number">17</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">case</span> Congestion:</div><div class="line"> <span class="number">19</span>:                 <span class="keyword">case</span> TransientError:</div><div class="line"> <span class="number">20</span>:                     taskDispatcher.reprocess(holders, result); <span class="comment">// æäº¤é‡æ–°å¤„ç†</span></div><div class="line"> <span class="number">21</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">22</span>:                 <span class="keyword">case</span> PermanentError:</div><div class="line"> <span class="number">23</span>:                     logger.warn(<span class="string">"Discarding &#123;&#125; tasks of &#123;&#125; due to permanent error"</span>, holders.size(), workerName);</div><div class="line"> <span class="number">24</span>:             &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line"> <span class="number">27</span>:             metrics.registerTaskResult(result, tasks.size());</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">30</span>:         <span class="comment">// Ignore</span></div><div class="line"> <span class="number">31</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">32</span>:         <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line"> <span class="number">33</span>:         logger.warn(<span class="string">"Discovery WorkerThread error"</span>, e);</div><div class="line"> <span class="number">34</span>:     &#125;</div><div class="line"> <span class="number">35</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šæ— é™å¾ªç¯æ‰§è¡Œè°ƒåº¦ï¼Œç›´åˆ°å…³é—­ã€‚</p></li><li><p>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>getWork()</code> æ–¹æ³•ï¼Œè·å–<strong>ä¸€ä¸ª</strong>æ‰¹é‡ä»»åŠ¡ç›´åˆ°æˆåŠŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> List&lt;TaskHolder&lt;ID, T&gt;&gt; getWork() <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—æ‰¹é‡ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"> <span class="number">3</span>:     BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; workQueue = taskDispatcher.requestWorkItems();</div><div class="line"> <span class="number">4</span>:     <span class="comment">// ã€å¾ªç¯ã€‘è·å–æ‰¹é‡ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"> <span class="number">5</span>:     List&lt;TaskHolder&lt;ID, T&gt;&gt; result;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">7</span>:         result = workQueue.poll(<span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line"> <span class="number">8</span>:     &#125; <span class="keyword">while</span> (!isShutdown.get() &amp;&amp; result == <span class="keyword">null</span>);</div><div class="line"> <span class="number">9</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>TaskDispatcher#requestWorkItems()</code> æ–¹æ³•ï¼Œå‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—æ‰¹é‡ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskDispatcher.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Semaphore batchWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; batchWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; requestWorkItems() &#123;</div><div class="line">   batchWorkRequests.release();</div><div class="line">   <span class="keyword">return</span> batchWorkQueue;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼Œæ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>batchWorkQueue</code> ) å’Œå•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>singleItemWorkQueue</code> ) æ˜¯<strong>ä¸åŒçš„é˜Ÿåˆ—</strong>ã€‚</li></ul></li><li><p>ç¬¬ 5 è‡³ 8 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å–<strong>ä¸€ä¸ª</strong>æ‰¹é‡ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸã€‚</p></li></ul></li><li><p>ç¬¬ 12 è¡Œ ï¼šè°ƒç”¨ <code>#getTasksOf(...)</code> æ–¹æ³•ï¼Œè·å¾—<strong>å®é™…</strong>æ‰¹é‡ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;T&gt; <span class="title">getTasksOf</span><span class="params">(List&lt;TaskHolder&lt;ID, T&gt;&gt; holders)</span> </span>&#123;</div><div class="line">    List&lt;T&gt; tasks = <span class="keyword">new</span> ArrayList&lt;&gt;(holders.size());</div><div class="line">    <span class="keyword">for</span> (TaskHolder&lt;ID, T&gt; holder : holders) &#123;</div><div class="line">        tasks.add(holder.getTask());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> tasks;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 14 è‡³ 24 è¡Œ ï¼šè°ƒç”¨å¤„ç†å™¨( TaskProcessor ) æ‰§è¡Œä»»åŠ¡ã€‚å½“ä»»åŠ¡æ‰§è¡Œç»“æœä¸º <code>Congestion</code> æˆ– <code>TransientError</code> ï¼Œè°ƒç”¨ <code>AcceptorExecutor#reprocess(...)</code> æäº¤<strong>æ•´ä¸ªæ‰¹é‡ä»»åŠ¡</strong>é‡æ–°å¤„ç†ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AcceptorExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">reprocess</span><span class="params">(List&lt;TaskHolder&lt;ID, T&gt;&gt; holders, ProcessingResult processingResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° é‡æ–°æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   reprocessQueue.addAll(holders);</div><div class="line"></div><div class="line">   <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">   replayedTasks += holders.size();</div><div class="line">   </div><div class="line">   <span class="comment">// æäº¤ä»»åŠ¡ç»“æœç»™ TrafficShaper</span></div><div class="line">   trafficShaper.registerFailure(processingResult);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</h2><p>å•ä»»åŠ¡å·¥ä½œåå°çº¿ç¨‹( SingleTaskWorkerRunnable )æ‰§è¡Œ <code>#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ï¼Œå’Œ <code>BatchWorkerRunnable#run(...)</code> åŸºæœ¬ç±»ä¼¼ï¼Œå°±ä¸å•°å—¦äº†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// SingleTaskWorkerRunnable.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line">          <span class="comment">// å‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—å•ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—</span></div><div class="line">          BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; workQueue = taskDispatcher.requestWorkItem();</div><div class="line">          TaskHolder&lt;ID, T&gt; taskHolder;</div><div class="line">          <span class="comment">// ã€å¾ªç¯ã€‘è·å–å•ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line">          <span class="keyword">while</span> ((taskHolder = workQueue.poll(<span class="number">1</span>, TimeUnit.SECONDS)) == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (isShutdown.get()) &#123;</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">          metrics.registerExpiryTime(taskHolder);</div><div class="line">          <span class="keyword">if</span> (taskHolder != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="comment">// è°ƒç”¨å¤„ç†å™¨æ‰§è¡Œä»»åŠ¡</span></div><div class="line">              ProcessingResult result = processor.process(taskHolder.getTask());</div><div class="line">              <span class="keyword">switch</span> (result) &#123;</div><div class="line">                  <span class="keyword">case</span> Success:</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> Congestion:</div><div class="line">                  <span class="keyword">case</span> TransientError:</div><div class="line">                      taskDispatcher.reprocess(taskHolder, result); <span class="comment">// æäº¤é‡æ–°å¤„ç†</span></div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> PermanentError:</div><div class="line">                      logger.warn(<span class="string">"Discarding a task of &#123;&#125; due to permanent error"</span>, workerName);</div><div class="line">              &#125;</div><div class="line">              <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">              metrics.registerTaskResult(result, <span class="number">1</span>);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      <span class="comment">// Ignore</span></div><div class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">      <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line">      logger.warn(<span class="string">"Discovery WorkerThread error"</span>, e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>ğŸ˜ˆ åˆæ˜¯ä¸€ç¯‡é•¿æ–‡ã€‚å»ºè®®è¾¹çœ‹ä»£ç ï¼Œè¾¹å¯¹ç…§ç€æ•´ä½“æµç¨‹å›¾ï¼Œç†è§£å®é™…ä¸éš¾ã€‚</p><p>å½“ç„¶ï¼Œæ¬¢è¿ä½ æœ‰ä»»ä½•ç–‘é—®ï¼Œåœ¨æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç•™è¨€ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/batch-tasks/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a hre
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/</id>
    <published>2018-07-13T16:00:00.000Z</published>
    <updated>2017-10-20T01:19:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/">2. è¯»å†™é”</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka æ³¨å†Œä¸­å¿ƒçš„é‚£æŠŠè¯»å†™é”</strong>ï¼Œè®©æˆ‘ç˜™ç—’éš¾è€ï¼Œå´ä¸å¾—å…¶è§£ã€‚åœ¨æŸæ¬¡æ„å¤–çš„æŠ è„šçš„ä¸€åˆ»( ç¬”è€…ä¸æŠ½çƒŸï¼Œå¦‚æœæŠ½çƒŸçš„è¯ï¼Œæ­¤å¤„åº”è¯¥å°±ä¸æ˜¯æŠ è„šäº† )ï¼Œçªç„¶é¡¿æ‚Ÿï¼Œçˆ½ï¼Œè¿™å¥½æ¯”... æ¯”å–»æœ‰ç‚¹çŒ¥çï¼Œç¬”è€…å°±çœç•¥ 100 å­—ã€‚</p><p>ä¸çæ¯”æ¯”ï¼Œä¸Šä»£ç ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceRegistry</span> <span class="keyword">implements</span> <span class="title">InstanceRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock read = readWriteLock.readLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock write = readWriteLock.writeLock();</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. è¯»å†™é”</h1><p>æˆ‘ä»¬æŠŠè®¾è®¡åˆ°è¯»å†™é”çš„æ–¹æ³•æ•´ç†å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯»é”</th><th>å†™é”</th><th>ä¸ä½¿ç”¨</th></tr></thead><tbody><tr><td><code>#register(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#cancel(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#evict(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#renew(...)</code></td><td></td><td></td><td>âˆš</td></tr><tr><td><code>#statusUpdate(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#deleteStatusOverride(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#getApplicationDeltasFromMultipleRegions(...)</code></td><td></td><td>âˆš</td><td></td></tr><tr><td><code>#getApplicationsFromMultipleRegions(...)</code></td><td></td><td></td><td>âˆš</td></tr></tbody></table><p>æ˜¯å¦çœ‹åˆ°è¿™è¯»å†™æ„Ÿåˆ°å‡ ä¸è¯¡å¼‚çš„å‘³é“ï¼ŸOKï¼Œæˆ‘ä»¬æŠŠé—®é¢˜æ¢³ç†å¦‚ä¸‹ï¼š</p><ul><li>A. ä¸ºä»€ä¹ˆ <code>#register(...)</code> / <code>#cancel(...)</code> / <code>#evict(...)</code> / <code>#statusUpdate(...)</code> / <code>#deleteStatusOverride(...)</code> ç­‰<strong>å†™æ“ä½œ</strong>ä½¿ç”¨<strong>è¯»é”</strong></li><li>B. ä¸ºä»€ä¹ˆ <code>#renew(...)</code> <strong>å†™æ“ä½œ</strong>ä¸ä½¿ç”¨<strong>é”</strong></li><li>C. ä¸ºä»€ä¹ˆ <code>#getApplicationDeltasFromMultipleRegions(...)</code> <strong>è¯»æ“ä½œ</strong>ä½¿ç”¨<strong>å†™é”</strong></li><li>D. ä¸ºä»€ä¹ˆ <code>getApplicationsFromMultipleRegions(...)</code> <strong>è¯»æ“ä½œ</strong>ä¸ä½¿ç”¨<strong>é”</strong></li></ul><hr><p><strong>å…ˆè§£é‡Š A + C</strong> ï¼š</p><p>æˆ‘ä»¬æ¥å›æƒ³ä¸‹ï¼Œåœ¨ Eureka åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç çš„å…¬å¼ï¼š<code>appsHashCode = ${status}_${count}_</code> ã€‚( ä¸äº†è§£çš„åŒå­¦å¯ä»¥åŠ è½½ä¸‹ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹ã€Œ 2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç  ã€</a> )</p><p><s>åº”ç”¨å®ä¾‹çš„æ•°é‡å’ŒçŠ¶æ€éƒ½ä¼šå½±å“<strong>å“ˆå¸Œç </strong>çš„è®¡ç®—ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šè¿°<strong>å‰å…­ä¸ª</strong>( åŒ…æ‹¬ä¸ä½¿ç”¨é”çš„ <code>#renew(...)</code> æ–¹æ³• )æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå½±å“å“ˆå¸Œç ã€‚</s></p><p>æˆ‘ä»¬æŠŠç›®å…‰ç§»å‘å”¯ä¸€ä½¿ç”¨<strong>å†™é”</strong>çš„ <code>#getApplicationDeltasFromMultipleRegions(...)</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¿è¯ <code>recentlyChangedQueue</code> å’Œ <code>registry</code> å…±äº«å˜é‡çš„<strong>åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸€è‡´</strong>ï¼Œä¸ç„¶è¿”å›çš„å¢é‡åº”ç”¨å®ä¾‹é›†åˆçš„çŠ¶æ€æ˜¯ä¸å‡†ç¡®çš„ã€‚æ­¤æ—¶èƒ½å¤Ÿè¾¾åˆ°è¯¥æ•ˆæœï¼Œå¿…é¡»è®© <code>#getApplicationDeltasFromMultipleRegions(...)</code> å’Œå‰å…­ä¸ªæ–¹æ³•<strong>äº’æ–¥</strong>ã€‚æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>a. å…¨éƒ¨ <code>synchronized</code></li><li>b. <code>#getApplicationDeltasFromMultipleRegions(...)</code> ä½¿ç”¨<strong>è¯»é”</strong>ï¼Œå‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨<strong>å†™é”</strong></li><li>c. <code>#getApplicationDeltasFromMultipleRegions(...)</code> ä½¿ç”¨<strong>å†™é”</strong>ï¼Œå‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨<strong>è¯»é”</strong></li></ul><p>Eureka é€‰æ‹©äº†<strong>æ–¹æ¡ˆc</strong>ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ul><li>a. æ€§èƒ½å¤ªå·®</li><li>b. å‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨<strong>å†™é”</strong>ï¼ŒåŠ¿å¿…å†²çªå¤ªå¤§ï¼Œè™½ç„¶è¯»è‚¯å®šæ¯”å†™å¤šã€‚</li><li>c. <code>#getApplicationDeltasFromMultipleRegions(...)</code> ä½¿ç”¨<strong>å†™é”</strong>ï¼Œé…åˆ ResponseCache ï¼Œå³å‡å°‘äº†<strong>å†™é”</strong>ä½¿ç”¨çš„é¢‘ç‡ï¼Œæ¯æ¬¡ç¼“å­˜è¿‡æœŸæ‰ä½¿ç”¨ï¼Œåˆé¿å…äº†å‰å…­ä¸ªæ–¹æ³•å› ä¸º<strong>æ–¹æ¡ˆb</strong>ä¸­çš„<strong>å†™é”</strong>å¯¼è‡´äº’æ–¥ã€‚( ä¸äº†è§£ ResponseCache çš„åŒå­¦å¯ä»¥åŠ è½½ä¸‹ <a href="hhttp://www.iocoder.cn/Eureka/instance-registry-fetch-all/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ 3.2 å“åº”ç¼“å­˜ ResponseCache ã€</a> )</li></ul><hr><p><strong>å†è§£é‡Š D</strong></p><p><code>#getApplicationsFromMultipleRegions(...)</code> æ–¹æ³•çš„é€»è¾‘ï¼Œåªä¾èµ– <code>registry</code> å…±äº«å˜é‡ï¼Œä¸å­˜åœ¨åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸€è‡´çš„å›°æ‰°ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨é”ã€‚</p><hr><p><strong>æœ€åè§£é‡Š B</strong></p><p><code>#renew(...)</code> æ–¹æ³•çš„é€»è¾‘ï¼Œè™½ç„¶ä¼šå½±å“åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œä½†æ˜¯æ˜¯æå°æ¦‚ç‡ï¼Œè€ƒè™‘åˆ°å®ƒè°ƒç”¨çš„æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯”èµ·å› ä¸ºé”ç»™è¿™ä¸ªæ–¹æ³•å¸¦æ¥çš„æ€§èƒ½é™ä½ï¼Œä¸å¦‚è¿”å›çš„ç»“æœæš‚æ—¶ä¸å¤Ÿå‡†ç¡®ã€‚( æƒ³äº†è§£æå°æ¦‚ç‡å‘ç”ŸåŸå› çš„åŒå­¦å¯ä»¥åŠ è½½ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹ã€Œ 4.3 ç»­ç§Ÿåœºæ™¯ ã€</a> )</p><hr><p>TODO [0029] è¯»å†™é”</p><p>ç¬”è€…è·¯ä¸Šçªç„¶åˆæƒ³äº†é—®é¢˜ï¼Œå¯èƒ½ä¸æ˜¯ä¸Šè¿°åŸå› ï¼Œå¯èƒ½å’Œ ResponseCache æœ‰å…³ç³»ï¼Œå‚è§ <code>#invalidateCache(...)</code> æ–¹æ³•çš„æ¯æ¬¡è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯»å†™é”æ˜¯é’ˆå¯¹ ResponseCache çš„è¯»å†™é”ã€‚</p><h1>666. å½©è›‹</h1><p>å¼€æ£® ï¼</p><p>æœ¬æ¥ä»¥ä¸ºéœ€è¦è·Ÿ Eureka å®˜æ–¹æäº¤ issue æé—®ï¼Œå¹¶ä¸”åšå¥½äº†è·å¾—ä¸åˆ°ç­”æ¡ˆçš„å‡†å¤‡ï¼Œç»“æœæ— æ„ä¸­çš„æŠ è„š( è¯·å…è®¸æˆ‘çƒ­çˆ±æŠ è„šç»™æˆ‘å¸¦æ¥çš„çµæ„Ÿ )è§£ç­”äº†è‡ªå·±çš„ç–‘æƒ‘ã€‚</p><p>å²æœˆæ˜¯æŠŠçº ç»“è€ŒåˆèŒèŒå“’çš„é”ï¼Œä½ ä¸çŸ¥é“ä½ çš„å›°æ‰°ï¼Œå“ªå¤©ä¸ç»æ„çš„è¢«æ‰“å¼€ã€‚</p><p>æ„¿å¤§å–œå¤§æ‚²ï¼Œä¸æ‰ä»…çŸ¥çš„è¿™ä¸€ç”Ÿã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
</feed>
