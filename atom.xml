<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-12-01T14:03:11.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>èŠ‹é“æºç </name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.10) ä¹‹ RequestRateLimiterGatewayFilterFactory è¯·æ±‚é™æµ</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/</id>
    <published>2020-04-09T16:00:00.000Z</published>
    <updated>2017-12-01T14:03:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">3. RequestRateLimiterGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4. KeyResolver</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4.1 PrincipalNameKeyResolver</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4.2 è‡ªå®šä¹‰ KeyResolver</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5. RateLimiter</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5.1 GatewayRedisAutoConfiguration</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5.2 RedisRateLimiter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5.3 Redis Lua è„šæœ¬</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RequestRateLimiterGatewayFilterFactory çš„ä»£ç å®ç°</strong>ã€‚</p><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° Spring Cloud Gateway æä¾›äº†å¤šç§ GatewayFilterFactory çš„å®ç°ï¼Œè€Œ RequestRateLimiterGatewayFilterFactory ä¹Ÿæ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚</p><p>é€šè¿‡ RequestRateLimiterGatewayFilterFactory ï¼Œå¯ä»¥åˆ›å»º RequestRateLimiterGatewayFilter ( å®é™…æ˜¯å†…éƒ¨åŒ¿åç±»ï¼Œä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼Œä¸‹é¢ç»§ç»­è¿™ä¹ˆç§°å‘¼ ) ã€‚</p><p>RequestRateLimiterGatewayFilter ä½¿ç”¨ <strong>Redis + Lua</strong> å®ç°åˆ†å¸ƒå¼é™æµã€‚è€Œé™æµçš„ç²’åº¦ï¼Œä¾‹å¦‚ URL / ç”¨æˆ· / IP ç­‰ï¼Œé€šè¿‡ <code>org.springframework.cloud.gateway.filter.ratelimit.KeyResolver</code> <strong>å®ç°ç±»</strong>å†³å®šï¼Œåœ¨ <a href="#">ã€Œ4. KeyResolverã€</a> è¯¦ç»†è§£æã€‚</p><p>è¿™é‡Œï¼Œç¬”è€…ä¸€æœ¬æ­£ç»çš„æ¨èä¸‹è‡ªå·±åˆ†äº«çš„ <a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a> ï¼Œç®€ç›´ä¸šç•Œè‰¯å¿ƒã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-ç¯å¢ƒæ­å»º"><a href="#2-ç¯å¢ƒæ­å»º" class="headerlink" title="2. ç¯å¢ƒæ­å»º"></a>2. ç¯å¢ƒæ­å»º</h1><p>ç¬¬ä¸€æ­¥ï¼Œä»¥ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ä¸ºåŸºç¡€ï¼Œåœ¨ <code>pom.xml</code> æ–‡ä»¶æ·»åŠ ä¾èµ–åº“ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ <code>application.yml</code> é…ç½®<strong>ä¸€ä¸ª</strong> RouteDefinition ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">default_path_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://127.0.0.1:8081</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RequestRateLimiter=10,</span> <span class="number">20</span><span class="string">,</span> <span class="comment">#&#123;@principalNameKeyResolver&#125;</span></div></pre></td></tr></table></figure><ul><li><code>- RequestRateLimiter=10, 20, #{@principalNameKeyResolver}</code> ï¼Œé…ç½® RequestRateLimiterGatewayFilterFactory ã€‚ <ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŸºäº<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>å®ç°é™æµã€‚ </li><li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>burstCapacity</code> ï¼Œä»¤ç‰Œæ¡¶ä¸Šé™ ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<code>replenishRate</code> ï¼Œä»¤ç‰Œæ¡¶å¡«å……å¹³å‡é€Ÿç‡ï¼Œå•ä½ï¼šç§’ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œ<code>keyResolver</code> ï¼Œé™æµ<strong>é”®</strong>è§£æå™¨ Bean å¯¹è±¡åå­—ï¼Œæ ¹æ® <code>#{@beanName}</code> ï¼Œä½¿ç”¨ SpEL è¡¨è¾¾å¼ï¼Œä» Spring å®¹å™¨ä¸­è·å– Bean å¯¹è±¡ï¼Œè¯¦ç»†å‚è§ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/83496b78944269050373bb92bb2181e1b7c070e8/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RouteDefinitionRouteLocator.java#L182" rel="external nofollow noopener noreferrer" target="_blank"><code>RouteDefinitionRouteLocator#getTuple(ArgumentHints, Map&lt;String, String&gt;, SpelExpressionParser, BeanFactory)</code></a> å¤„çš„ä»£ç ã€‚å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª BUG ï¼šåœ¨ YAML é‡Œï¼Œ<code>#</code> ä»£è¡¨æ³¨é‡Šï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ªå‚æ•°æ— æ³•æ­£ç¡®è¢«è¯»å–ï¼Œéœ€è¦ç­‰å¾…å®˜æ–¹ä¿®å¤ã€‚å¦‚æœæ¯”è¾ƒç€æ€¥ä½¿ç”¨ï¼Œå¯ä»¥è€ƒè™‘å°†æ­¤å¤„çš„ <code>#</code> ä¿®æ”¹æˆ <code>\#</code> ï¼Œå¹¶ä¿®æ”¹éƒ¨åˆ†ç›¸å…³ä»£ç ä»¥è§£å†³è¯¥ BUG ã€‚</li></ul></li></ul><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®Œæˆï¼Œå¯åŠ¨ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ã€‚</p><blockquote><p><strong>å‹æƒ…æç¤º</strong>ï¼ŒRequestRateLimiterGatewayFilter ä½¿ç”¨äº† RedisTemplate ï¼Œç”Ÿäº§ç¯å¢ƒè¯·é…ç½®ã€‚</p></blockquote><h1 id="3-RequestRateLimiterGatewayFilterFactory"><a href="#3-RequestRateLimiterGatewayFilterFactory" class="headerlink" title="3. RequestRateLimiterGatewayFilterFactory"></a>3. RequestRateLimiterGatewayFilterFactory</h1><p><code>org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory</code> ï¼Œè¯·æ±‚é™æµç½‘å…³è¿‡æ»¤å™¨<strong>å·¥å‚</strong>ç±»ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestRateLimiterGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_RESOLVER_KEY = <span class="string">"keyResolver"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter;</div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> KeyResolver defaultKeyResolver;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">RequestRateLimiterGatewayFilterFactory</span><span class="params">(RateLimiter rateLimiter,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">9</span>: KeyResolver defaultKeyResolver)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: <span class="keyword">this</span>.rateLimiter = rateLimiter;</div><div class="line"><span class="number">11</span>: <span class="keyword">this</span>.defaultKeyResolver = defaultKeyResolver;</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> Arrays.asList(</div><div class="line"><span class="number">17</span>:                 RedisRateLimiter.REPLENISH_RATE_KEY,</div><div class="line"><span class="number">18</span>:                 RedisRateLimiter.BURST_CAPACITY_KEY,</div><div class="line"><span class="number">19</span>:                 KEY_RESOLVER_KEY</div><div class="line"><span class="number">20</span>:         );</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">24</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validateArgs</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">25</span>:  <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="number">29</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">30</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">31</span>:         validateMin(<span class="number">2</span>, args);</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:         <span class="comment">// è·å¾— KeyResolver</span></div><div class="line"><span class="number">34</span>: KeyResolver keyResolver;</div><div class="line"><span class="number">35</span>: <span class="keyword">if</span> (args.hasFieldName(KEY_RESOLVER_KEY)) &#123;</div><div class="line"><span class="number">36</span>: keyResolver = args.getValue(KEY_RESOLVER_KEY, KeyResolver.class);</div><div class="line"><span class="number">37</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>: keyResolver = defaultKeyResolver;</div><div class="line"><span class="number">39</span>: &#125;</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="keyword">return</span> (exchange, chain) -&gt; keyResolver.resolve(exchange).flatMap(key -&gt;</div><div class="line"><span class="number">42</span>:             <span class="comment">// <span class="doctag">TODO:</span> if key is empty?</span></div><div class="line"><span class="number">43</span>:             rateLimiter.isAllowed(key, args).flatMap(response -&gt; &#123;</div><div class="line"><span class="number">44</span>:                 <span class="comment">// <span class="doctag">TODO:</span> set some headers for rate, tokens left</span></div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:                 <span class="comment">// å…è®¸è®¿é—®</span></div><div class="line"><span class="number">47</span>:                 <span class="keyword">if</span> (response.isAllowed()) &#123;</div><div class="line"><span class="number">48</span>:                     <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">49</span>:                 &#125;</div><div class="line"><span class="number">50</span>: </div><div class="line"><span class="number">51</span>:                 <span class="comment">// è¢«é™æµï¼Œä¸å…è®¸è®¿é—®</span></div><div class="line"><span class="number">52</span>:                 exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</div><div class="line"><span class="number">53</span>:                 <span class="keyword">return</span> exchange.getResponse().setComplete();</div><div class="line"><span class="number">54</span>:             &#125;));</div><div class="line"><span class="number">55</span>: &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>rateLimiter</code> å±æ€§ï¼Œé™æµå™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ RedisRateLimiter ã€‚</li><li><code>defaultKeyResolver</code> å±æ€§ï¼Œé»˜è®¤é™æµ<strong>é”®</strong>è§£æå™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ PrincipalNameKeyResolver ã€‚</li><li><code>#argNames()</code> æ–¹æ³•ï¼Œå®šä¹‰äº† Tuple å‚æ•°çš„ Key ä¸º <code>replenishRate</code> / <code>burstCapacity</code> / <code>keyResolver</code> ã€‚</li><li><code>#validateArgs()</code> æ–¹æ³•ï¼Œå®šä¹‰åœ¨ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/83496b78944269050373bb92bb2181e1b7c070e8/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RouteDefinitionRouteLocator.java#L182" rel="external nofollow noopener noreferrer" target="_blank"><code>RouteDefinitionRouteLocator#getTuple(ArgumentHints, Map&lt;String, String&gt;, SpelExpressionParser, BeanFactory)</code></a> æ— éœ€æ ¡éªŒ Tuple ç»“æœã€‚å› ä¸º <code>keyResolver</code> éå¿…å¡«é¡¹ï¼Œåœ¨ <code>#apply()</code> æ–¹æ³•ï¼Œåˆ›å»º RequestRateLimiterGatewayFilter æ—¶<strong>æ ¡éªŒ</strong>ã€‚</li><li><code>#apply()</code> æ–¹æ³•ï¼Œåˆ›å»º RequestRateLimiterGatewayFilter å¯¹è±¡ã€‚</li><li>ç¬¬ 31 è¡Œ ï¼šæ ¡éªŒ Tuple å‚æ•°è‡³å°‘æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œå³ <code>replenishRate</code> å’Œ <code>burstCapacity</code> ã€‚è€Œ <code>keyResolver</code> æ˜¯<strong>é€‰å¡«</strong>ï¼Œä¸ºç©ºæ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼ <code>defaultKeyResolver</code> ã€‚</li><li>ç¬¬ 34 è‡³ 39 è¡Œ ï¼šè·å¾— <code>keyResolver</code> ã€‚é€šè¿‡å®ƒï¼Œè·å¾—è¯·æ±‚çš„é™æµ<strong>é”®</strong>ï¼Œä¾‹å¦‚URL / ç”¨æˆ· / IP ç­‰ã€‚</li><li>â€”â€”â€” ç¬¬ 41 è‡³ 54 è¡Œ ï¼š<strong>åˆ›å»º RequestRateLimiterGatewayFilter å¯¹è±¡å¹¶è¿”å›</strong>ã€‚</li><li>ç¬¬ 41 è¡Œ ï¼šè°ƒç”¨ <code>KeyResolver#resolve(ServerWebExchange)</code> æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚çš„é™æµ<strong>é”®</strong>ã€‚<ul><li><strong>æ³¨æ„ä¸‹</strong>ï¼Œè¿™é‡Œæœªå¤„ç†é™æµ<strong>é”®</strong>ä¸ºç©ºçš„æƒ…å†µ( <code>TODO: if key is empty?</code> )ã€‚æ‰€ä»¥ï¼Œå½“é™æµ<strong>é”®</strong>ä¸ºç©ºæ—¶ï¼Œè¿‡æ»¤å™¨é“¾ä¸ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šè¯·æ±‚åç«¯ Http / Websocket æœåŠ¡ï¼Œå¹¶ä¸”æœ€ç»ˆè¿”å›å®¢æˆ·ç«¯ <strong>200</strong> çŠ¶æ€ç ï¼Œå†…å®¹ä¸º<strong>ç©º</strong>ã€‚</li></ul></li><li>ç¬¬ 43 è‡³ 54 è¡Œ ï¼šè°ƒç”¨ <code>RateLimiter#isAllowed(ServerWebExchange, Tuple)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¢«é™æµã€‚<ul><li>ç¬¬ 47 è‡³ 49 è¡Œ ï¼š<strong>æœª</strong>è¢«é™æµï¼Œå…è®¸è®¿é—®ï¼Œæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</li><li>ç¬¬ 52 è‡³ 53 è¡Œ ï¼šè¢«é™æµï¼Œ <strong>ä¸</strong>å…è®¸è®¿é—®ï¼Œè®¾ç½®å“åº” 429 çŠ¶æ€ç ï¼Œå¹¶å›å†™å®¢æˆ·ç«¯<strong>å“åº”</strong>( <code>exchange.getResponse().setComplete()</code> ) ã€‚</li></ul></li></ul><h1 id="4-KeyResolver"><a href="#4-KeyResolver" class="headerlink" title="4. KeyResolver"></a>4. KeyResolver</h1><p><code>org.springframework.cloud.gateway.filter.ratelimit.KeyResolver</code> ï¼Œè¯·æ±‚<strong>é”®</strong>è§£æå™¨<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyResolver</span> </span>&#123;</div><div class="line"><span class="function">Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>KeyResolver#resolve(ServerWebExchange)</code> æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚çš„é™æµ<strong>é”®</strong>ã€‚</li></ul><p>é€šè¿‡å®ç° KeyResolver æ¥å£ï¼Œå®ç°è·å¾—ä¸åŒçš„è¯·æ±‚çš„é™æµ<strong>é”®</strong>ï¼Œä¾‹å¦‚URL / ç”¨æˆ· / IP ç­‰ã€‚</p><p>ç›®å‰ç‰ˆæœ¬ï¼ŒSpring Cloud Gateway æä¾›çš„ KeyResolver å®ç°ç±»åªæœ‰ PrincipalNameKeyResolver ã€‚æ®å®˜æ–¹è¯´æ³•ï¼Œåœ¨æœªæ¥çš„é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¸­ï¼Œå°†ä¼šæœ‰ä¸€äº› KeyResolver å…·ä½“å®ç°ç±»ã€‚</p><h2 id="4-1-PrincipalNameKeyResolver"><a href="#4-1-PrincipalNameKeyResolver" class="headerlink" title="4.1 PrincipalNameKeyResolver"></a>4.1 PrincipalNameKeyResolver</h2><p><code>org.springframework.cloud.gateway.filter.ratelimit.PrincipalNameKeyResolver</code> ï¼Œä½¿ç”¨è¯·æ±‚è®¤è¯çš„ <code>java.security.Principal</code> ä½œä¸ºé™æµ<strong>é”®</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrincipalNameKeyResolver</span> <span class="keyword">implements</span> <span class="title">KeyResolver</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"principalNameKeyResolver"</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> exchange.getPrincipal().map(Principal::getName).switchIfEmpty(Mono.empty());</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-2-è‡ªå®šä¹‰-KeyResolver"><a href="#4-2-è‡ªå®šä¹‰-KeyResolver" class="headerlink" title="4.2 è‡ªå®šä¹‰ KeyResolver"></a>4.2 è‡ªå®šä¹‰ KeyResolver</h2><p>é€šè¿‡å®ç° KeyResolver æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰ KeyResolver ã€‚ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸ªä½¿ç”¨è¯·æ±‚ IP ä½œä¸ºé™æµ<strong>é”®</strong>çš„ KeyResolver ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º RemoteAddrKeyResolver ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteAddrKeyResolver</span> <span class="keyword">implements</span> <span class="title">KeyResolver</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"remoteAddrKeyResolver"</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Mono.just(exchange.getRequest().getRemoteAddress().getAddress().getHostAddress());</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼Œé…ç½® RemoteAddrKeyResolver Bean å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Bean</span>(name = RemoteAddrKeyResolver.BEAN_NAME)</div><div class="line"><span class="meta">@ConditionalOnBean</span>(RateLimiter.class)</div><div class="line"><span class="function"><span class="keyword">public</span> RemoteAddrKeyResolver <span class="title">remoteAddrKeyResolver</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RemoteAddrKeyResolver();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½® RouteDefinition è·¯ç”±é…ç½®ï¼Œé…ç½®å¦‚ä¸‹ ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">default_path_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://127.0.0.1:8081</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RequestRateLimiter=10,</span> <span class="number">20</span><span class="string">,</span> <span class="comment">#&#123;@remoteAddrKeyResolver&#125;</span></div></pre></td></tr></table></figure><p>ç¬¬å››æ­¥ï¼Œ<strong>å¤§åŠŸå‘Šæˆ</strong>ï¼Œå¯åŠ¨ Spring Cloud Gateway å³å¯ã€‚</p><p>å¦å¤–ï¼Œæ¨è <a href="https://mp.weixin.qq.com/s?__biz=MzI4ODQ3NjE2OA==&amp;mid=2247483811&amp;idx=1&amp;sn=16fe7e25a90635e93c60048ebe8b40a2&amp;chksm=ec3c9cc4db4b15d2937fb8b2ef571c941b2bb9fefcf5ed8232e3699b4868392022a62b963699&amp;mpshare=1&amp;scene=1&amp;srcid=1201O46Ma9D5ln5TuxHUgziY#rd" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå‘¨ç«‹ â€”â€” Spring Cloudé™æµè¯¦è§£ï¼ˆé™„æºç ï¼‰ã€‹</a>ï¼Œé‡Œé¢æœ‰ä¸€äº›é™æµç»´åº¦çš„åˆ†æã€‚</p><h1 id="5-RateLimiter"><a href="#5-RateLimiter" class="headerlink" title="5. RateLimiter"></a>5. RateLimiter</h1><p><code>org.springframework.cloud.gateway.filter.ratelimit.RateLimiter</code> ï¼Œé™æµå™¨<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="function">Mono&lt;Response&gt; <span class="title">isAllowed</span><span class="params">(String id, Tuple args)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#isAllowed(String id, Tuple args)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¢«é™æµã€‚</li><li><p>Response ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å…è®¸è®¿é—®( æœªè¢«é™æµ )</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> allowed;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»¤ç‰Œæ¡¶å‰©ä½™æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> tokensRemaining;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(<span class="keyword">boolean</span> allowed, <span class="keyword">long</span> tokensRemaining)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.allowed = allowed;</div><div class="line"><span class="keyword">this</span>.tokensRemaining = tokensRemaining;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h2 id="5-1-GatewayRedisAutoConfiguration"><a href="#5-1-GatewayRedisAutoConfiguration" class="headerlink" title="5.1 GatewayRedisAutoConfiguration"></a>5.1 GatewayRedisAutoConfiguration</h2><p><code>org.springframework.cloud.gateway.config.GatewayRedisAutoConfiguration</code> ï¼ŒRedis ç›¸å…³é…ç½®ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Configuration</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@AutoConfigureAfter</span>(RedisReactiveAutoConfiguration.class)</div><div class="line"> <span class="number">3</span>: <span class="meta">@AutoConfigureBefore</span>(GatewayAutoConfiguration.class)</div><div class="line"> <span class="number">4</span>: <span class="meta">@ConditionalOnBean</span>(ReactiveRedisTemplate.class)</div><div class="line"> <span class="number">5</span>: <span class="meta">@ConditionalOnClass</span>(&#123;RedisTemplate.class, DispatcherHandler.class&#125;)</div><div class="line"> <span class="number">6</span>: <span class="class"><span class="keyword">class</span> <span class="title">GatewayRedisAutoConfiguration</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Bean</span></div><div class="line"> <span class="number">9</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> RedisScript <span class="title">redisRequestRateLimiterScript</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">11</span>: DefaultRedisScript redisScript = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</div><div class="line"><span class="number">12</span>: redisScript.setScriptSource(<span class="keyword">new</span> ResourceScriptSource(<span class="keyword">new</span> ClassPathResource(<span class="string">"META-INF/scripts/request_rate_limiter.lua"</span>)));</div><div class="line"><span class="number">13</span>: redisScript.setResultType(List.class);</div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> redisScript;</div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="meta">@Bean</span></div><div class="line"><span class="number">18</span>: <span class="comment">//<span class="doctag">TODO:</span> replace with ReactiveStringRedisTemplate in future</span></div><div class="line"><span class="number">19</span>: <span class="function"><span class="keyword">public</span> ReactiveRedisTemplate&lt;String, String&gt; <span class="title">stringReactiveRedisTemplate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>: ReactiveRedisConnectionFactory reactiveRedisConnectionFactory,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">21</span>: ResourceLoader resourceLoader)</span> </span>&#123;</div><div class="line"><span class="number">22</span>: RedisSerializer&lt;String&gt; serializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line"><span class="number">23</span>: RedisSerializationContext&lt;String , String&gt; serializationContext = RedisSerializationContext</div><div class="line"><span class="number">24</span>: .&lt;String, String&gt;newSerializationContext()</div><div class="line"><span class="number">25</span>: .key(serializer)</div><div class="line"><span class="number">26</span>: .value(serializer)</div><div class="line"><span class="number">27</span>: .hashKey(serializer)</div><div class="line"><span class="number">28</span>: .hashValue(serializer)</div><div class="line"><span class="number">29</span>: .build();</div><div class="line"><span class="number">30</span>: <span class="keyword">return</span> <span class="keyword">new</span> ReactiveRedisTemplate&lt;&gt;(reactiveRedisConnectionFactory,</div><div class="line"><span class="number">31</span>: serializationContext);</div><div class="line"><span class="number">32</span>: &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="meta">@Bean</span></div><div class="line"><span class="number">35</span>: <span class="function"><span class="keyword">public</span> RedisRateLimiter <span class="title">redisRateLimiter</span><span class="params">(ReactiveRedisTemplate&lt;String, String&gt; redisTemplate,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">36</span>:  @Qualifier(<span class="string">"redisRequestRateLimiterScript"</span>)</span> RedisScript&lt;List&lt;Long&gt;&gt; redisScript) </span>&#123;</div><div class="line"><span class="number">37</span>: <span class="keyword">return</span> <span class="keyword">new</span> RedisRateLimiter(redisTemplate, redisScript);</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 8 è‡³ 15 è¡Œ ï¼šåˆ›å»º <code>org.springframework.data.redis.core.script.RedisScript</code> Bean å¯¹è±¡ï¼ŒåŠ è½½ <code>META-INF/scripts/request_rate_limiter.lua</code> è·¯å¾„ä¸‹çš„ Redis Lua è„šæœ¬ã€‚è¯¥è„šæœ¬ä½¿ç”¨ Redis åŸºäº<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>å®ç°é™æµã€‚åœ¨æœ¬æ–‡ <a href="#">ã€ŒRedis Lua è„šæœ¬ã€</a> è¯¦ç»†è§£æã€‚ </li><li>ç¬¬ 17 è‡³ 32 è¡Œ ï¼šåˆ›å»º <code>org.springframework.data.redis.core.ReactiveRedisTemplate</code> Bean å¯¹è±¡ã€‚</li><li>ç¬¬ 34 è‡³ 38 è¡Œ ï¼šä½¿ç”¨ RedisScript å’Œ ReactiveRedisTemplate Bean å¯¹è±¡ï¼Œåˆ›å»º RedisRateLimiter Bean å¯¹è±¡ã€‚</li></ul><h2 id="5-2-RedisRateLimiter"><a href="#5-2-RedisRateLimiter" class="headerlink" title="5.2 RedisRateLimiter"></a>5.2 RedisRateLimiter</h2><p><code>org.springframework.cloud.gateway.filter.ratelimit.RedisRateLimiter</code> ï¼ŒåŸºäº Redis çš„åˆ†å¸ƒå¼é™æµå™¨<strong>å®ç°ç±»</strong>ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisRateLimiter</span> <span class="keyword">implements</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPLENISH_RATE_KEY = <span class="string">"replenishRate"</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BURST_CAPACITY_KEY = <span class="string">"burstCapacity"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, String&gt; redisTemplate;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> RedisScript&lt;List&lt;Long&gt;&gt; script;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">RedisRateLimiter</span><span class="params">(ReactiveRedisTemplate&lt;String, String&gt; redisTemplate,</span></span></div><div class="line"><span class="function"><span class="params">RedisScript&lt;List&lt;Long&gt;&gt; script)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.redisTemplate = redisTemplate;</div><div class="line"><span class="keyword">this</span>.script = script;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>redisTemplate</code> å±æ€§ï¼ŒRedisTemplate ã€‚</li><li><code>script</code> å±æ€§ï¼ŒLua è„šæœ¬ã€‚</li></ul><hr><p><code>#isAllowed(id, Tuple)</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Response&gt; <span class="title">isAllowed</span><span class="params">(String id, Tuple args)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="comment">// How many requests per second do you want a user to be allowed to do?</span></div><div class="line"> <span class="number">3</span>: <span class="keyword">int</span> replenishRate = args.getInt(REPLENISH_RATE_KEY);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="comment">// How much bursting do you want to allow?</span></div><div class="line"> <span class="number">6</span>: <span class="keyword">int</span> burstCapacity;</div><div class="line"> <span class="number">7</span>: <span class="keyword">if</span> (args.hasFieldName(BURST_CAPACITY_KEY)) &#123;</div><div class="line"> <span class="number">8</span>: burstCapacity = args.getInt(BURST_CAPACITY_KEY);</div><div class="line"> <span class="number">9</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>: burstCapacity = <span class="number">0</span>;</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>: <span class="comment">// Make a unique key per user.</span></div><div class="line"><span class="number">15</span>: String prefix = <span class="string">"request_rate_limiter."</span> + id;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// You need two Redis keys for Token Bucket.</span></div><div class="line"><span class="number">18</span>: List&lt;String&gt; keys = Arrays.asList(prefix + <span class="string">".tokens"</span>, prefix + <span class="string">".timestamp"</span>);</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="comment">// The arguments to the LUA script. time() returns unixtime in seconds.</span></div><div class="line"><span class="number">21</span>: List&lt;String&gt; scriptArgs = Arrays.asList(replenishRate + <span class="string">""</span>, burstCapacity + <span class="string">""</span>,</div><div class="line"><span class="number">22</span>:  Instant.now().getEpochSecond() + <span class="string">""</span>, <span class="string">"1"</span>);</div><div class="line"><span class="number">23</span>: <span class="comment">// allowed, tokens_left = redis.eval(SCRIPT, keys, args)</span></div><div class="line"><span class="number">24</span>: Flux&lt;List&lt;Long&gt;&gt; flux = <span class="keyword">this</span>.redisTemplate.execute(<span class="keyword">this</span>.script, keys, scriptArgs);</div><div class="line"><span class="number">25</span>: <span class="comment">// .log("redisratelimiter", Level.FINER);</span></div><div class="line"><span class="number">26</span>: <span class="keyword">return</span> flux</div><div class="line"><span class="number">27</span>: <span class="comment">// Throwable =&gt; Flux.just(Arrays.asList(1L, -1L)) ã€‚</span></div><div class="line"><span class="number">28</span>: .onErrorResume(throwable -&gt; Flux.just(Arrays.asList(<span class="number">1L</span>, -<span class="number">1L</span>)))</div><div class="line"><span class="number">29</span>: <span class="comment">// Flux&lt;List&lt;Long&gt;&gt; =&gt; Mono&lt;List&lt;Long&gt;&gt;</span></div><div class="line"><span class="number">30</span>: .reduce(<span class="keyword">new</span> ArrayList&lt;Long&gt;(), (longs, l) -&gt; &#123;</div><div class="line"><span class="number">31</span>: longs.addAll(l);</div><div class="line"><span class="number">32</span>: <span class="keyword">return</span> longs;</div><div class="line"><span class="number">33</span>: &#125;)</div><div class="line"><span class="number">34</span>: <span class="comment">// Mono&lt;List&lt;Long&gt;&gt; =&gt; Mono&lt;Response&gt;</span></div><div class="line"><span class="number">35</span>: .map(results -&gt; &#123;</div><div class="line"><span class="number">36</span>: <span class="keyword">boolean</span> allowed = results.get(<span class="number">0</span>) == <span class="number">1L</span>;</div><div class="line"><span class="number">37</span>: Long tokensLeft = results.get(<span class="number">1</span>);</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>: Response response = <span class="keyword">new</span> Response(allowed, tokensLeft);</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line"><span class="number">42</span>: log.debug(<span class="string">"response: "</span> + response);</div><div class="line"><span class="number">43</span>: &#125;</div><div class="line"><span class="number">44</span>: <span class="keyword">return</span> response;</div><div class="line"><span class="number">45</span>: &#125;);</div><div class="line"><span class="number">46</span>: &#125;</div><div class="line"><span class="number">47</span>: <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">48</span>: <span class="comment">/*</span></div><div class="line"><span class="comment">49:  * We don't want a hard dependency on Redis to allow traffic. Make sure to set</span></div><div class="line"><span class="comment">50:  * an alert so you know if this is happening too much. Stripe's observed</span></div><div class="line"><span class="comment">51:  * failure rate is 0.01%.</span></div><div class="line"><span class="comment">52:  */</span></div><div class="line"><span class="number">53</span>: log.error(<span class="string">"Error determining if user allowed from redis"</span>, e);</div><div class="line"><span class="number">54</span>: &#125;</div><div class="line"><span class="number">55</span>: <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> Response(<span class="keyword">true</span>, -<span class="number">1</span>));</div><div class="line"><span class="number">56</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>id</code> æ–¹æ³•å‚æ•°ï¼Œä»¤ç‰Œæ¡¶ç¼–å·ã€‚ä¸€ä¸ªä»¤ç‰Œæ¡¶ç¼–å·å¯¹åº”ä»¤ç‰Œæ¡¶ã€‚<ul><li>åœ¨æœ¬æ–‡åœºæ™¯ä¸­ä¸ºè¯·æ±‚é™æµ<strong>é”®</strong>ã€‚</li></ul></li><li>ç¬¬ 3 è¡Œ ï¼šè·å¾— <code>burstCapacity</code> ä»¤ç‰Œæ¡¶ä¸Šé™ã€‚</li><li>ç¬¬ 5 è‡³ 11 è¡Œ ï¼šè·å¾— <code>replenishRate</code> ï¼Œä»¤ç‰Œæ¡¶å¡«å……å¹³å‡é€Ÿç‡ï¼Œå•ä½ï¼šç§’ã€‚</li><li>ç¬¬ 15 è¡Œ ï¼šè·å¾—ä»¤ç‰Œæ¡¶å‰ç¼€ï¼Œ<code>request_rate_limiter.${id}</code> ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šè·å¾—ä»¤ç‰Œæ¡¶é”®æ•°ç»„ ï¼š<ul><li><code>request_rate_limiter.${id}.tokens</code> ï¼šä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°ã€‚</li><li><code>request_rate_limiter.${id}.timestamp</code> ï¼šä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li></ul></li><li><p>ç¬¬ 21 è‡³ 22 è¡Œ ï¼šè·å¾— Lua è„šæœ¬å‚æ•° ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•° ï¼š<code>replenishRate</code> ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° ï¼š<code>burstCapacity</code> ã€‚</li><li><p>ç¬¬ä¸‰ä¸ªå‚æ•° ï¼šå¾—åˆ°ä» <code>1970-01-01 00:00:00</code> å¼€å§‹çš„ç§’æ•°ã€‚<strong>ä¸ºä»€ä¹ˆåœ¨ Java ä»£ç é‡Œè·å–ï¼Œè€Œä¸ä½¿ç”¨ Lua åœ¨ Reids é‡Œè·å–</strong>ï¼Ÿ</p><blockquote><p>FROM <a href="https://union-click.jd.com/jdc?d=pT3LH8" rel="external nofollow noopener noreferrer" target="_blank">ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹</a><br>å› ä¸º Redis çš„é™åˆ¶ï¼ˆ Luaä¸­æœ‰å†™æ“ä½œä¸èƒ½ä½¿ç”¨å¸¦éšæœºæ€§è´¨çš„è¯»æ“ä½œï¼Œå¦‚TIME ï¼‰ä¸èƒ½åœ¨ Redis Luaä¸­ ä½¿ç”¨ TIME è·å–æ—¶é—´æˆ³ï¼Œå› æ­¤åªå¥½ä»åº”ç”¨è·å–ç„¶åä¼ å…¥ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹ï¼ˆæœºå™¨æ—¶é’Ÿä¸å‡†çš„æƒ…å†µä¸‹ï¼‰ï¼Œé™æµä¼šå­˜åœ¨ä¸€äº›å°é—®é¢˜ã€‚</p><ul><li>æ¶›å“¥è¿™æœ¬ä¹¦éå¸¸ä¸é”™ï¼Œæ¨èè´­ä¹°ã€‚</li></ul></blockquote></li><li><p>ç¬¬å››ä¸ªå‚æ•° ï¼šæ¶ˆè€—ä»¤ç‰Œæ•°é‡ï¼Œé»˜è®¤ 1 ã€‚</p></li></ul></li><li><p>ç¬¬ 24 è¡Œ ï¼šè°ƒç”¨ <code>ReactiveRedisTemplate#execute(RedisScript&lt;T&gt;, List&lt;K&gt;, List&lt;?&gt;)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Redis Lua è„šæœ¬ï¼Œè·å–ä»¤ç‰Œã€‚è¿”å›ç»“æœä¸º <code>[æ˜¯å¦è·å–ä»¤ç‰ŒæˆåŠŸ, å‰©ä½™ä»¤ç‰Œæ•°]</code> ï¼Œå…¶ä¸­ï¼Œ<code>1</code> ä»£è¡¨è·å–ä»¤ç‰Œ<strong>æˆåŠŸ</strong>ï¼Œ<code>0</code> ä»£è¡¨ä»¤ç‰Œè·å–<strong>å¤±è´¥</strong>ã€‚</p></li><li><p>ç¬¬ 25 è¡Œ ï¼šå½“ Redis Lua è„šæœ¬è¿‡ç¨‹ä¸­å‘ç”Ÿ<strong>å¼‚å¸¸</strong>ï¼Œå¿½ç•¥å¼‚å¸¸ï¼Œè¿”å› <code>Flux.just(Arrays.asList(1L, -1L))</code> ï¼Œå³è®¤ä¸º<strong>è·å–ä»¤ç‰ŒæˆåŠŸ</strong>ã€‚ä¸ºä»€ä¹ˆï¼Ÿåœ¨ Redis å‘ç”Ÿæ•…éšœæ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›é™æµå™¨å¯¹ Reids æ˜¯<strong>å¼ºä¾èµ–</strong>ï¼Œå¹¶ä¸” Redis å‘ç”Ÿæ•…éšœçš„æ¦‚ç‡æœ¬èº«å°±å¾ˆä½ã€‚</p><blockquote><p>We donâ€™t want a hard dependency on Redis to allow traffic.<br>Make sure to set an alert so you know if this is happening too much. Stripeâ€™s observed failure rate is 0.01%.</p></blockquote></li><li><p>ç¬¬ 30 è‡³ 33 è¡Œ ï¼šè°ƒç”¨ <code>Flux#reduce(A, BiFunction&lt;A, ? super T, A&gt;)</code> æ–¹æ³•ï¼Œå°† <code>Flux&lt;List&lt;Long&gt;&gt;</code> è½¬æ¢æˆ <code>Mono&lt;List&lt;Long&gt;&gt;</code> ã€‚å› ä¸º <code>ReactiveRedisTemplate#execute(RedisScript&lt;T&gt;, List&lt;K&gt;, List&lt;?&gt;)</code> æ–¹æ³•çš„æ‰§è¡Œç»“æœä¸º Flux ( å¤šæ¬¡ )ï¼Œå®é™…åœ¨å½“å‰åœºæ™¯é‡Œï¼Œè‡ªè¡Œ Redis Lua è„šæœ¬åªä¼šè¿”å›<strong>ä¸€æ¬¡</strong>æ•°ç»„ï¼Œæ‰€ä»¥è½¬æ¢æˆ Mono (ä¸€æ¬¡)ã€‚</p></li><li>ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè°ƒç”¨ <code>Mono#map(Function&lt;? super T, ? extends R&gt;)</code> æ–¹æ³•ï¼Œå°† <code>Mono&lt;List&lt;Long&gt;&gt;</code> =&gt; <code>Mono&lt;Response&gt;</code> ã€‚</li><li>ç¬¬ 47 è‡³ 55 è¡Œ ï¼šå½“ã€ç¬¬ 15 è‡³ 24 è¡Œã€‘ä»£ç éƒ¨åˆ†æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¾‹å¦‚ Redis æŒ‚äº†ï¼Œè¿”å› <code>Flux.just(Arrays.asList(1L, -1L))</code> ï¼Œå³è®¤ä¸º<strong>è·å–ä»¤ç‰ŒæˆåŠŸ</strong>ã€‚</li></ul><h2 id="5-3-Redis-Lua-è„šæœ¬"><a href="#5-3-Redis-Lua-è„šæœ¬" class="headerlink" title="5.3 Redis Lua è„šæœ¬"></a>5.3 Redis Lua è„šæœ¬</h2><p><code>META-INF/scripts/request_rate_limiter.lua</code> ï¼ŒRedis Lua è„šæœ¬ï¼Œå®ç°åŸºäº<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>å®ç°é™æµã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight lua"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">local</span> tokens_key = KEYS[<span class="number">1</span>]</div><div class="line"> <span class="number">2</span>: <span class="keyword">local</span> timestamp_key = KEYS[<span class="number">2</span>]</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</div><div class="line"> <span class="number">5</span>: <span class="keyword">local</span> capacity = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</div><div class="line"> <span class="number">6</span>: <span class="keyword">local</span> now = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</div><div class="line"> <span class="number">7</span>: <span class="keyword">local</span> requested = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="keyword">local</span> fill_time = capacity/rate</div><div class="line"><span class="number">10</span>: <span class="keyword">local</span> ttl = <span class="built_in">math</span>.<span class="built_in">floor</span>(fill_time*<span class="number">2</span>)</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="keyword">local</span> last_tokens = <span class="built_in">tonumber</span>(redis.call(<span class="string">"get"</span>, tokens_key))</div><div class="line"><span class="number">13</span>: <span class="keyword">if</span> last_tokens == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line"><span class="number">14</span>:   last_tokens = capacity</div><div class="line"><span class="number">15</span>: <span class="keyword">end</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="keyword">local</span> last_refreshed = <span class="built_in">tonumber</span>(redis.call(<span class="string">"get"</span>, timestamp_key))</div><div class="line"><span class="number">18</span>: <span class="keyword">if</span> last_refreshed == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line"><span class="number">19</span>:   last_refreshed = <span class="number">0</span></div><div class="line"><span class="number">20</span>: <span class="keyword">end</span></div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="keyword">local</span> delta = <span class="built_in">math</span>.<span class="built_in">max</span>(<span class="number">0</span>, now-last_refreshed)</div><div class="line"><span class="number">23</span>: <span class="keyword">local</span> filled_tokens = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, last_tokens+(delta*rate))</div><div class="line"><span class="number">24</span>: <span class="keyword">local</span> allowed = filled_tokens &gt;= requested</div><div class="line"><span class="number">25</span>: <span class="keyword">local</span> new_tokens = filled_tokens</div><div class="line"><span class="number">26</span>: <span class="keyword">local</span> allowed_num = <span class="number">0</span></div><div class="line"><span class="number">27</span>: <span class="keyword">if</span> allowed <span class="keyword">then</span></div><div class="line"><span class="number">28</span>:   new_tokens = filled_tokens - requested</div><div class="line"><span class="number">29</span>:   allowed_num = <span class="number">1</span></div><div class="line"><span class="number">30</span>: <span class="keyword">end</span></div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>: redis.call(<span class="string">"setex"</span>, tokens_key, ttl, new_tokens)</div><div class="line"><span class="number">33</span>: redis.call(<span class="string">"setex"</span>, timestamp_key, ttl, now)</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> &#123; allowed_num, new_tokens &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 1 è‡³ 2 è¡Œ ï¼šKEYS æ–¹æ³•å‚æ•° ï¼š<ul><li>ç¬¬ä¸€ä¸ªå‚æ•° ï¼š<code>request_rate_limiter.${id}.tokens</code> ï¼Œä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° ï¼š<code>request_rate_limiter.${id}.timestamp</code> ï¼Œä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li></ul></li><li><p>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šARGV æ–¹æ³•å‚æ•° ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•° ï¼š<code>replenishRate</code> ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° ï¼š<code>burstCapacity</code> ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•° ï¼šå¾—åˆ°ä» <code>1970-01-01 00:00:00</code> å¼€å§‹çš„ç§’æ•°ã€‚</li><li>ç¬¬å››ä¸ªå‚æ•° ï¼šæ¶ˆè€—ä»¤ç‰Œæ•°é‡ï¼Œé»˜è®¤ 1 ã€‚</li></ul></li><li><p>ç¬¬ 9 è¡Œ ï¼šè®¡ç®—ä»¤ç‰Œæ¡¶å¡«å……<strong>æ»¡</strong>ä»¤ç‰Œéœ€è¦å¤šä¹…æ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</p></li><li>ç¬¬ 10 è¡Œ ï¼šè®¡ç®— <code>request_rate_limiter.${id}.tokens</code> / <code>request_rate_limiter.${id}.timestamp</code> çš„ <strong>ttl</strong> ã€‚<code>* 2</code> ä¿è¯æ—¶é—´å……è¶³ã€‚</li><li>ç¬¬ 12 è‡³ 20 è¡Œ ï¼šè°ƒç”¨ <code>get</code> å‘½ä»¤ï¼Œè·å¾—ä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°( <code>last_tokens</code> ) ï¼Œä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´(<code>last_refreshed</code>) ã€‚</li><li>ç¬¬ 22 è‡³ 23 è¡Œ ï¼šå¡«å……ä»¤ç‰Œï¼Œè®¡ç®—<strong>æ–°</strong>çš„ä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°( <code>filled_tokens</code> )ã€‚å¡«å……ä¸è¶…è¿‡ä»¤ç‰Œæ¡¶ä»¤ç‰Œ<strong>ä¸Šé™</strong>ã€‚</li><li><p>ç¬¬ 24 è‡³ 30 è¡Œ ï¼šè·å–ä»¤ç‰Œæ˜¯å¦æˆåŠŸã€‚</p><ul><li>è‹¥<strong>æˆåŠŸ</strong>ï¼Œä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°(<code>new_tokens</code>) <strong>å‡</strong>æ¶ˆè€—ä»¤ç‰Œæ•°( <code>requested</code> )ï¼Œå¹¶è®¾ç½®è·å–æˆåŠŸ( <code>allowed_num = 1</code> ) ã€‚</li><li>è‹¥<strong>å¤±è´¥</strong>ï¼Œè®¾ç½®è·å–å¤±è´¥( <code>allowed_num = 0</code> ) ã€‚</li></ul></li><li><p>ç¬¬ 32 è‡³ 33 è¡Œ ï¼šè®¾ç½®ä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°( <code>new_tokens</code> ) ï¼Œä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´(<code>now</code>) ã€‚</p></li><li>ç¬¬ 35 è¡Œ ï¼šè¿”å›æ•°ç»„ç»“æœï¼Œ<code>[æ˜¯å¦è·å–ä»¤ç‰ŒæˆåŠŸ, å‰©ä½™ä»¤ç‰Œæ•°]</code> ã€‚</li></ul><p><strong>Redis Lua è„šæœ¬ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ä¹ˆ</strong>ï¼Ÿ</p><blockquote><p>FROM <a href="https://union-click.jd.com/jdc?d=pT3LH8" rel="external nofollow noopener noreferrer" target="_blank">ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹</a><br>å›  Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œå› æ­¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></blockquote><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å“‡å“ˆå“ˆï¼Œè¿‡æ»¤å™¨å…¨éƒ¨å®Œæˆã€‚æ©ï¼Œå½“ç„¶åé¢éœ€è¦åœ¨è€ƒè™‘ä¸€ä¸‹ï¼Œä¾‹å¦‚è®¤è¯è¿‡æ»¤å™¨ç­‰ç­‰ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_10/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/fil
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.9) ä¹‹ HystrixGatewayFilterFactory ç†”æ–­</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/</id>
    <published>2020-04-04T16:00:00.000Z</published>
    <updated>2017-12-01T14:03:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">3. HystrixGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4. æ³¨æ„äº‹é¡¹</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>HystrixGatewayFilterFactory çš„ä»£ç å®ç°</strong>ã€‚</p><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° Spring Cloud Gateway æä¾›äº†å¤šç§ GatewayFilterFactory çš„å®ç°ï¼Œè€Œ HystrixGatewayFilterFactory ä¹Ÿæ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚</p><p>é€šè¿‡ HystrixGatewayFilterFactory ï¼Œå¯ä»¥åˆ›å»º HystrixGatewayFilter ( å®é™…æ˜¯å†…éƒ¨åŒ¿åç±»ï¼Œä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼Œä¸‹é¢ç»§ç»­è¿™ä¹ˆç§°å‘¼ ) ã€‚</p><p>HystrixGatewayFilter ä½¿ç”¨ <a href="https://github.com/Netflix/Hystrix" rel="external nofollow noopener noreferrer" target="_blank">Hystrix</a> ï¼Œå®ç°åŸºäº <strong>Route</strong> çº§åˆ«çš„ç†”æ–­åŠŸèƒ½ã€‚</p><p>è¿™é‡Œï¼Œç¬”è€…ä¸€æœ¬æ­£ç»çš„æ¨èä¸‹è‡ªå·±åˆ†äº«çš„ <a href="http://www.iocoder.cn/categories/Hystrix/?self">ã€ŠHystrix æºç è§£æç³»åˆ—ã€‹</a> ï¼Œç®€ç›´ä¸šç•Œè‰¯å¿ƒã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-ç¯å¢ƒæ­å»º"><a href="#2-ç¯å¢ƒæ­å»º" class="headerlink" title="2. ç¯å¢ƒæ­å»º"></a>2. ç¯å¢ƒæ­å»º</h1><p>ç¬¬ä¸€æ­¥ï¼Œä»¥ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ä¸ºåŸºç¡€ï¼Œåœ¨ <code>pom.xml</code> æ–‡ä»¶æ·»åŠ ä¾èµ–åº“ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ <code>application.yml</code> é…ç½®<strong>ä¸€ä¸ª</strong> RouteDefinition ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">default_path_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://127.0.0.1:8081</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Hystrix=myCommandName</span></div></pre></td></tr></table></figure><ul><li><code>- Hystrix=myCommandName</code> ï¼Œé…ç½® HystrixGatewayFilterFactory ï¼Œå¹¶ä»¥ <code>myCommandName</code> ä¸º <strong>Hystrix Command åå­—</strong>ã€‚</li></ul><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®Œæˆï¼Œå¯åŠ¨ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ã€‚</p><h1 id="3-HystrixGatewayFilterFactory"><a href="#3-HystrixGatewayFilterFactory" class="headerlink" title="3. HystrixGatewayFilterFactory"></a>3. HystrixGatewayFilterFactory</h1><p><code>org.springframework.cloud.gateway.filter.factory.HystrixGatewayFilterFactory</code> ï¼Œç†”æ–­ç½‘å…³è¿‡æ»¤å™¨<strong>å·¥å‚</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> Arrays.asList(NAME_KEY);</div><div class="line"> <span class="number">6</span>: &#125;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: <span class="comment">//<span class="doctag">TODO:</span> if no name is supplied, generate one from command id (useful for default filter)</span></div><div class="line"><span class="number">11</span>: <span class="keyword">final</span> String commandName = args.getString(NAME_KEY);</div><div class="line"><span class="number">12</span>: <span class="keyword">final</span> HystrixCommandGroupKey groupKey = HystrixCommandGroupKey.Factory.asKey(getClass().getSimpleName());</div><div class="line"><span class="number">13</span>: <span class="keyword">final</span> HystrixCommandKey commandKey = HystrixCommandKey.Factory.asKey(commandName);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="keyword">final</span> HystrixObservableCommand.Setter setter = HystrixObservableCommand.Setter</div><div class="line"><span class="number">16</span>: .withGroupKey(groupKey)</div><div class="line"><span class="number">17</span>: .andCommandKey(commandKey);</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line"><span class="number">20</span>: RouteHystrixCommand command = <span class="keyword">new</span> RouteHystrixCommand(setter, exchange, chain);</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="keyword">return</span> Mono.create(s -&gt; &#123;</div><div class="line"><span class="number">23</span>:     <span class="comment">// ä½¿ç”¨ Hystrix Command Observable è®¢é˜…</span></div><div class="line"><span class="number">24</span>: Subscription sub = command.toObservable().subscribe(s::success, s::error, s::success);</div><div class="line"><span class="number">25</span>: <span class="comment">// Mono å–æ¶ˆæ—¶ï¼Œå–æ¶ˆ Hystrix Command Observable çš„è®¢é˜…ï¼Œç»“æŸ Hystrix Command çš„æ‰§è¡Œ</span></div><div class="line"><span class="number">26</span>: s.onCancel(sub::unsubscribe);</div><div class="line"><span class="number">27</span>: &#125;).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; &#123;</div><div class="line"><span class="number">28</span>: <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> HystrixRuntimeException) &#123;</div><div class="line"><span class="number">29</span>: HystrixRuntimeException e = (HystrixRuntimeException) throwable;</div><div class="line"><span class="number">30</span>: <span class="keyword">if</span> (e.getFailureType() == TIMEOUT) &#123; <span class="comment">//<span class="doctag">TODO:</span> optionally set status</span></div><div class="line"><span class="number">31</span>: setResponseStatus(exchange, HttpStatus.GATEWAY_TIMEOUT);</div><div class="line"><span class="number">32</span>: <span class="keyword">return</span> exchange.getResponse().setComplete();</div><div class="line"><span class="number">33</span>: &#125;</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">36</span>: &#125;).then();</div><div class="line"><span class="number">37</span>: &#125;;</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>#argNames()</code> æ–¹æ³•ï¼Œå®šä¹‰äº† Tuple å‚æ•°çš„ Key ä¸º <code>name</code> ã€‚</li><li><code>#apply()</code> æ–¹æ³•ï¼Œåˆ›å»º HystrixGatewayFilter å¯¹è±¡ã€‚</li><li>ç¬¬ 11 è¡Œ ï¼šä» Tuple å‚æ•°è·å¾— Hystrix Command åå­—ï¼Œä¾‹å¦‚ä¸Šé¢ä¸¾ä¾‹çš„ RouteDefinition æ—¶ï¼Œ<code>commandName = myCommandName</code> ã€‚</li><li>ç¬¬ 12 è¡Œ ï¼šåˆ›å»º Hystrix Command åˆ†ç»„ Key ä¸º <code>HystrixGatewayFilterFactory</code> ã€‚</li><li>ç¬¬ 13 è¡Œ ï¼šåˆ›å»º Hystrix Command Key ä¸º <code>commandName</code> ã€‚</li><li>ç¬¬ 15 è‡³ 17 è¡Œ ï¼šåˆ›å»º HystrixObservableCommand.Setter å¯¹è±¡ã€‚</li><li>â€”â€”â€” ç¬¬ 19 è‡³ 37 è¡Œ ï¼š<strong>åˆ›å»º HystrixGatewayFilter å¯¹è±¡å¹¶è¿”å›</strong>ã€‚</li><li><p>ç¬¬ 20 è¡Œ ï¼šåˆ›å»º RouteHystrixCommand å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteHystrixCommand</span> <span class="keyword">extends</span> <span class="title">HystrixObservableCommand</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ServerWebExchange exchange;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> GatewayFilterChain chain;</div><div class="line"></div><div class="line">RouteHystrixCommand(Setter setter, ServerWebExchange exchange, GatewayFilterChain chain) &#123;</div><div class="line"><span class="keyword">super</span>(setter);</div><div class="line"><span class="keyword">this</span>.exchange = exchange;</div><div class="line"><span class="keyword">this</span>.chain = chain;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Void&gt; <span class="title">construct</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> RxReactiveStreams.toObservable(<span class="keyword">this</span>.chain.filter(<span class="keyword">this</span>.exchange));</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šè°ƒç”¨ <code>Mono#create(Consumer&lt;MonoSink&lt;T&gt;&gt;)</code> æ–¹æ³•ï¼Œåˆ›å»º Mono å¯¹è±¡ã€‚ç‚¹å‡» <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#create-java.util.function.Consumer-" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> æŸ¥çœ‹è¯¥æ–¹æ³•è¯¦ç»†è¯´æ˜ã€‚å› ä¸º Hystrix åŸºäº RxJava ï¼Œè€Œ GatewayFilter åŸºäº Reactor ( Mono æ˜¯å…¶å†…éƒ¨çš„ä¸€ä¸ªç±» )ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œå®ç°è®¢é˜…çš„é€‚é…ã€‚<strong>æœªæ¥ï¼Œä¼šå®ç° <a href="https://github.com/Netflix/Hystrix/issues/1089#issuecomment-180512000" rel="external nofollow noopener noreferrer" target="_blank">HystrixMonoCommand</a> æ›¿æ¢ HystrixObservableCommand ï¼Œä»è€Œç»Ÿä¸€è®¢é˜…ï¼Œå»é™¤é€‚é…ä»£ç </strong>ã€‚</p><ul><li>ç¬¬ 24 è¡Œ ï¼š1ï¼‰è°ƒç”¨ <code>RouteHystrixCommand#toObservable()</code> æ–¹æ³•ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ <code>RouteHystrixCommand#construct()</code> æ–¹æ³•ï¼Œè·å¾—æ‰§è¡Œ <code>this.chain.filter(this.exchange)</code> çš„ Observable ã€‚2ï¼‰è®¢é˜… Observable ï¼šæˆåŠŸæˆ–å®Œæˆæ—¶ï¼Œè°ƒç”¨ <code>Mono#success(Object)</code> æ–¹æ³•ï¼Œç›®å‰åˆ›å»ºçš„ Mono ä¸Šæ²¡æœ‰ç›¸å…³çš„è®¢é˜…ï¼›<strong>å¼‚å¸¸æ—¶</strong>ï¼Œè°ƒç”¨ <code>Mono#error(Object)</code> æ–¹æ³•ï¼Œç›®å‰åˆ›å»ºçš„ Mono ä¸Šè°ƒç”¨ <code>Mongo#onErrorResume(Function&lt;Throwable, Mono&lt;Void&gt;&gt;))</code> æ–¹æ³•ï¼Œè¿›è¡Œè®¢é˜…ã€‚</li><li>ç¬¬ 26 è¡Œ ï¼šMono å–æ¶ˆæ—¶ï¼Œå–æ¶ˆ Hystrix Command Observable çš„è®¢é˜…ï¼Œç»“æŸ Hystrix Command çš„æ‰§è¡Œã€‚</li></ul></li><li>ç¬¬ 27 è‡³ 34 è¡Œ ï¼šå½“ Hystrix Command <strong>æ‰§è¡Œè¶…æ—¶</strong>æ—¶ï¼Œè®¾ç½®å“åº” 504 çŠ¶æ€ç ï¼Œå¹¶å›å†™å®¢æˆ·ç«¯<strong>å“åº”</strong>( <code>exchange.getResponse().setComplete()</code> ) ã€‚</li><li>ç¬¬ 35 è¡Œ ï¼š<strong>å½“ Hystrix Command å‘ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶ï¼Œä¾‹å¦‚æ–­è·¯å™¨æ‰“å¼€ï¼Œè¿”å› <code>Mono.empty()</code> ï¼Œæœ€ç»ˆè¿”å›å®¢æˆ·ç«¯ 200 çŠ¶æ€ç ï¼Œå†…å®¹ä¸ºç©º</strong>ã€‚</li><li>ç¬¬ 36 è¡Œ ï¼šè°ƒç”¨ <code>Mono#then()</code> æ–¹æ³•ï¼Œ<strong>å‚æ•°ä¸ºç©º</strong>ï¼Œè¿”å›ç©º Mono ï¼Œä¸å†å‘åå‘å°„æ•°æ®ã€‚</li></ul><h1 id="4-æ³¨æ„äº‹é¡¹"><a href="#4-æ³¨æ„äº‹é¡¹" class="headerlink" title="4. æ³¨æ„äº‹é¡¹"></a>4. æ³¨æ„äº‹é¡¹</h1><ol><li>ç›®å‰ Hystrix Command æ‰§è¡Œè¶…æ—¶æ—¶ï¼Œè¿”å›å®¢æˆ·ç«¯ 504 çŠ¶æ€ç ï¼Œå¦‚æœä½¿ç”¨ JSON æ ¼å¼ä½œä¸ºæ•°æ®è¿”å›ï¼Œåˆ™éœ€è¦ä¿®æ”¹ä¸‹è¯¥ HystrixGatewayFilter çš„ä»£ç å®ç°ã€‚</li><li><p>Hystrix é…ç½®å‚æ•°ï¼Œç›®å‰åªèƒ½<strong>å…¨å±€</strong>é…ç½®ï¼Œä¾‹å¦‚è¯´ Hystrix æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œé…ç½®å¦‚ä¸‹ ï¼š</p> <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">hystrix:</span></div><div class="line"><span class="attr">  command:</span></div><div class="line"><span class="attr">    default:</span></div><div class="line"><span class="attr">      execution:</span></div><div class="line"><span class="attr">        isolation:</span></div><div class="line"><span class="attr">          thread:</span></div><div class="line"><span class="attr">            timeoutInMilliseconds:</span> <span class="number">10000</span></div></pre></td></tr></table></figure><ul><li>å¦‚æœæƒ³å®ç° Route / URL çº§åˆ«çš„ Hystrix é…ç½®å‚æ•°ï¼Œåˆ™éœ€è¦ä¿®æ”¹ä¸‹è¯¥ HystrixGatewayFilter çš„ä»£ç å®ç°ã€‚</li><li><a href="https://github.com/Netflix/Hystrix/wiki/Configuration#contents" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHystrix â€”â€” Configurationã€‹</a> ï¼ŒHystrix é…ç½®é¡¹ï¼Œéœ€è¦è‡ªå–ã€‚</li></ul></li><li><p>å½“ Hystrix ç†”æ–­æ—¶ï¼Œæœ€ç»ˆè¿”å›å®¢æˆ·ç«¯ 200 çŠ¶æ€ç ï¼Œå†…å®¹ä¸ºç©ºï¼Œæ­¤å¤„å»ºè®®è¯¥ HystrixGatewayFilter çš„ä»£ç å®ç°ã€‚</p></li></ol><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å˜¿å˜¿å˜¿ï¼Œå†™å®Œç†”æ–­ï¼Œå‡†å¤‡é™æµè¿‡æ»¤å™¨èµ°èµ·ã€‚é¸¡å†»ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_05/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/&lt;
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/</id>
    <published>2020-03-31T16:00:00.000Z</published>
    <updated>2017-12-01T14:03:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">2. ç¯å¢ƒé…ç½®</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">3. WebClientHttpRoutingFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">4. WebClientWriteResponseFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">5. å’Œ NettyRoutingFilter å¯¹æ¯”</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>WebClientHttpRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>WebClientHttpRoutingFilter ï¼ŒHttp <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>http://</code> æˆ– <code>https://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œä½¿ç”¨åŸºäº <code>org.springframework.cloud.gateway.filter.WebClient</code> å®ç°çš„ HttpClient è¯·æ±‚åç«¯ Http æœåŠ¡ã€‚</p><p>WebClientWriteResponseFilter ï¼Œä¸ WebClientHttpRoutingFilter <strong>æˆå¯¹ä½¿ç”¨</strong>çš„ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶å°† WebClientWriteResponseFilter è¯·æ±‚åç«¯ Http æœåŠ¡çš„<strong>å“åº”</strong>å†™å›å®¢æˆ·ç«¯ã€‚</p><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_01/01.png" alt=""></p><h1 id="2-ç¯å¢ƒé…ç½®"><a href="#2-ç¯å¢ƒé…ç½®" class="headerlink" title="2. ç¯å¢ƒé…ç½®"></a>2. ç¯å¢ƒé…ç½®</h1><p>ç›®å‰ WebClientHttpRoutingFilter / WebClientWriteResponseFilter å¤„äº<strong>å®éªŒ</strong>é˜¶æ®µï¼Œå»ºè®®ç­‰æ­£å¼å‘å¸ƒåœ¨ä½¿ç”¨ã€‚</p><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ç¯å¢ƒã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåœ¨ NettyConfiguration æ³¨é‡Šæ‰ <code>#routingFilter(...)</code> å’Œ <code>#nettyWriteResponseFilter()</code> ä¸¤ä¸ª Bean æ–¹æ³•ã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ GatewayAutoConfiguration æ‰“å¼€ <code>#webClientHttpRoutingFilter()</code> å’Œ <code>#webClientWriteResponseFilter()</code> ä¸¤ä¸ª Bean æ–¹æ³•ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®Œæˆï¼Œå¯åŠ¨ Spring Cloud Gateway ã€‚</p><h1 id="3-WebClientHttpRoutingFilter"><a href="#3-WebClientHttpRoutingFilter" class="headerlink" title="3. WebClientHttpRoutingFilter"></a>3. WebClientHttpRoutingFilter</h1><p><code>org.springframework.cloud.gateway.filter.WebClientHttpRoutingFilter</code> ï¼ŒHttp <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebClientHttpRoutingFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebClientHttpRoutingFilter</span><span class="params">(WebClient webClient)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.webClient = webClient;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>webClient</code> å±æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>org.springframework.web.reactive.function.client.DefaultWebClient</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¯·æ±‚åç«¯çš„ Http æœåŠ¡</strong>ã€‚</li></ul><hr><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// è·å¾— requestUrl</span></div><div class="line"> <span class="number">4</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"> <span class="number">7</span>: String scheme = requestUrl.getScheme();</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || (!scheme.equals(<span class="string">"http"</span>) &amp;&amp; !scheme.equals(<span class="string">"https"</span>))) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">13</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: ServerHttpRequest request = exchange.getRequest();</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">//<span class="doctag">TODO:</span> support forms</span></div><div class="line"><span class="number">18</span>: <span class="comment">// Request Method</span></div><div class="line"><span class="number">19</span>: HttpMethod method = request.getMethod();</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">// Request</span></div><div class="line"><span class="number">22</span>: RequestBodySpec bodySpec = <span class="keyword">this</span>.webClient.method(method)</div><div class="line"><span class="number">23</span>: .uri(requestUrl)</div><div class="line"><span class="number">24</span>: .headers(httpHeaders -&gt; &#123;</div><div class="line"><span class="number">25</span>: httpHeaders.addAll(request.getHeaders());</div><div class="line"><span class="number">26</span>: httpHeaders.remove(HttpHeaders.HOST);</div><div class="line"><span class="number">27</span>: &#125;);</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: <span class="comment">// Request Body</span></div><div class="line"><span class="number">30</span>: RequestHeadersSpec&lt;?&gt; headersSpec;</div><div class="line"><span class="number">31</span>: <span class="keyword">if</span> (requiresBody(method)) &#123;</div><div class="line"><span class="number">32</span>: headersSpec = bodySpec.body(BodyInserters.fromDataBuffers(request.getBody()));</div><div class="line"><span class="number">33</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">34</span>: headersSpec = bodySpec;</div><div class="line"><span class="number">35</span>: &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>: <span class="keyword">return</span> headersSpec.exchange()</div><div class="line"><span class="number">38</span>: <span class="comment">// .log("webClient route")</span></div><div class="line"><span class="number">39</span>: .flatMap(res -&gt; &#123;</div><div class="line"><span class="number">40</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: <span class="comment">// Response Header</span></div><div class="line"><span class="number">43</span>: response.getHeaders().putAll(res.headers().asHttpHeaders());</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>: <span class="comment">// Response Status</span></div><div class="line"><span class="number">46</span>: response.setStatusCode(res.statusCode());</div><div class="line"><span class="number">47</span>: </div><div class="line"><span class="number">48</span>: <span class="comment">// è®¾ç½® Response åˆ° CLIENT_RESPONSE_ATTR</span></div><div class="line"><span class="number">49</span>: <span class="comment">// Defer committing the response until all route filters have run</span></div><div class="line"><span class="number">50</span>: <span class="comment">// Put client response as ServerWebExchange attribute and write response later NettyWriteResponseFilter</span></div><div class="line"><span class="number">51</span>: exchange.getAttributes().put(CLIENT_RESPONSE_ATTR, res);</div><div class="line"><span class="number">52</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">53</span>: &#125;);</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</li><li><p>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><code>http://</code> æˆ–è€… <code>https://</code> å‰ç¼€( Scheme ) ã€‚</li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 17 è¡Œ ï¼šTODO ã€3025ã€‘ ç›®å‰æš‚ä¸æ”¯æŒ forms å‚æ•°</p></li><li>ç¬¬ 22 è‡³ 35 è¡Œ ï¼š<strong>åˆ›å»º</strong>å‘åç«¯æœåŠ¡çš„è¯·æ±‚ã€‚<ul><li>ç¬¬ 22 è¡Œ ï¼šè®¾ç½® Method å±æ€§ã€‚</li><li>ç¬¬ 24 è‡³ 27 è¡Œ ï¼šè®¾ç½® Header å±æ€§ã€‚</li><li>ç¬¬ 30 è‡³ 35 è¡Œ ï¼šè®¾ç½® Body å±æ€§ã€‚</li></ul></li><li>ç¬¬ 37 è¡Œ ï¼š<strong>å‘èµ·</strong>å‘åç«¯æœåŠ¡çš„è¯·æ±‚ã€‚</li><li>ç¬¬ 40 è‡³ 53 è¡Œ ï¼š<strong>å¤„ç†</strong>è¿”å›è‡ªåç«¯æœåŠ¡çš„ç›¸åº”ã€‚<ul><li>ç¬¬ 43 è¡Œ ï¼šè®¾ç½® <code>response</code> çš„ Header å±æ€§ã€‚</li><li>ç¬¬ 46 è¡Œ ï¼šè®¾ç½® <code>response</code> çš„ Status å±æ€§ã€‚</li><li>ç¬¬ 51 è¡Œ ï¼šè®¾ç½® <code>res</code> åˆ° <code>CLIENT_RESPONSE_ATTR</code> ã€‚åç»­ WebClientWriteResponseFilter å°†å“åº”<strong>å†™å›</strong>ç»™å®¢æˆ·ç«¯ã€‚</li><li>ç¬¬ 52 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</li></ul></li></ul><h1 id="4-WebClientWriteResponseFilter"><a href="#4-WebClientWriteResponseFilter" class="headerlink" title="4. WebClientWriteResponseFilter"></a>4. WebClientWriteResponseFilter</h1><p><code>org.springframework.cloud.gateway.filter.WebClientWriteResponseFilter</code> ï¼ŒHttp å›å†™<strong>å“åº”</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_RESPONSE_FILTER_ORDER = -<span class="number">1</span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> WRITE_RESPONSE_FILTER_ORDER;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¿”å›é¡ºåºä¸º <code>-1</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// NOTICE: nothing in "pre" filter stage as CLIENT_RESPONSE_ATTR is not added</span></div><div class="line"> <span class="number">4</span>: <span class="comment">// until the WebHandler is run</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> chain.filter(exchange).then(Mono.defer(() -&gt; &#123;</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— Response</span></div><div class="line"> <span class="number">7</span>: ClientResponse clientResponse = exchange.getAttribute(CLIENT_RESPONSE_ATTR);</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (clientResponse == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: log.trace(<span class="string">"WebClientWriteResponseFilter start"</span>);</div><div class="line"><span class="number">12</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers())).log(<span class="string">"webClient response"</span>);</div><div class="line"><span class="number">15</span>: &#125;));</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>#then(Mono)</code> æ–¹æ³•ï¼Œå®ç° <strong>After Filter</strong> é€»è¾‘ã€‚</li><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šä» <code>CLIENT_RESPONSE_ATTR</code> ä¸­ï¼Œè·å¾— ClientResponse ã€‚</li><li>ç¬¬ 14 è¡Œ ï¼šå°† ClientResponse å†™å›ç»™å®¢æˆ·ç«¯ã€‚</li></ul><h1 id="5-å’Œ-NettyRoutingFilter-å¯¹æ¯”"><a href="#5-å’Œ-NettyRoutingFilter-å¯¹æ¯”" class="headerlink" title="5. å’Œ NettyRoutingFilter å¯¹æ¯”"></a>5. å’Œ NettyRoutingFilter å¯¹æ¯”</h1><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.7) ä¹‹ NettyRoutingFilterã€‹</a> ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ NettyRoutingFilter / NettyWriteResponseFilter å’Œ WebClientHttpRoutingFilter / WebClientHttpRoutingFilter å®ç°<strong>ä¸€æ ·</strong>çš„åŠŸèƒ½ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å†å®ç°ä¸€æ¬¡å‘¢ï¼Ÿ</p><p>TODO ã€3001ã€‘</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œä¸»è¦çš„è¿‡æ»¤å™¨å·²ç»å†™å®Œï¼Œåé¢ç†”æ–­ã€é™æµè¿‡æ»¤å™¨çš„å®ç°ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_01/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.7) ä¹‹ NettyRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/</id>
    <published>2020-03-27T16:00:00.000Z</published>
    <updated>2017-12-01T14:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">2. NettyRoutingFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">3. NettyWriteResponseFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>NettyRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>NettyRoutingFilter ï¼ŒNetty <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>http://</code> æˆ– <code>https://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œä½¿ç”¨åŸºäº Netty å®ç°çš„ HttpClient è¯·æ±‚åç«¯ Http æœåŠ¡ã€‚</p><p>NettyWriteResponseFilter ï¼Œä¸ NettyRoutingFilter <strong>æˆå¯¹ä½¿ç”¨</strong>çš„ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶å°† NettyRoutingFilter è¯·æ±‚åç«¯ Http æœåŠ¡çš„<strong>å“åº”</strong>å†™å›å®¢æˆ·ç«¯ã€‚</p><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_28/01.png" alt=""></p><p>å¦å¤–ï¼ŒSpring Cloud Gateway å®ç°äº† WebClientHttpRoutingFilter / WebClientWriteResponseFilter ï¼ŒåŠŸèƒ½ä¸Šå’Œ NettyRoutingFilter / NettyWriteResponseFilter <strong>ç›¸åŒ</strong>ï¼Œå·®åˆ«åœ¨äºåŸºäº <code>org.springframework.cloud.gateway.filter.WebClient</code> å®ç°çš„ HttpClient è¯·æ±‚åç«¯ Http æœåŠ¡ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilterã€‹</a> ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è§£æã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-NettyRoutingFilter"><a href="#2-NettyRoutingFilter" class="headerlink" title="2. NettyRoutingFilter"></a>2. NettyRoutingFilter</h1><p><code>org.springframework.cloud.gateway.filter.NettyRoutingFilter</code> ï¼ŒNetty <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public class NettyRoutingFilter implements GlobalFilter, Ordered &#123;</div><div class="line"></div><div class="line">private final HttpClient httpClient;</div><div class="line"></div><div class="line">public NettyRoutingFilter(HttpClient httpClient) &#123;</div><div class="line">this.httpClient = httpClient;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>httpClient</code> å±æ€§ï¼ŒåŸºäº <strong>Netty</strong> å®ç°çš„ HttpClient ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¯·æ±‚åç«¯çš„ Http æœåŠ¡</strong>ã€‚</li></ul><hr><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// è·å¾— requestUrl</span></div><div class="line"> <span class="number">4</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"> <span class="number">7</span>: String scheme = requestUrl.getScheme();</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || (!scheme.equals(<span class="string">"http"</span>) &amp;&amp; !scheme.equals(<span class="string">"https"</span>))) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">13</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: ServerHttpRequest request = exchange.getRequest();</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// Request Method</span></div><div class="line"><span class="number">18</span>: <span class="keyword">final</span> HttpMethod method = HttpMethod.valueOf(request.getMethod().toString());</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="comment">// è·å¾— url</span></div><div class="line"><span class="number">21</span>: <span class="keyword">final</span> String url = requestUrl.toString();</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="comment">// Request Header</span></div><div class="line"><span class="number">24</span>: <span class="keyword">final</span> DefaultHttpHeaders httpHeaders = <span class="keyword">new</span> DefaultHttpHeaders();</div><div class="line"><span class="number">25</span>: request.getHeaders().forEach(httpHeaders::set);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">// è¯·æ±‚</span></div><div class="line"><span class="number">28</span>: <span class="keyword">return</span> <span class="keyword">this</span>.httpClient.request(method, url, req -&gt; &#123;</div><div class="line"><span class="number">29</span>: <span class="keyword">final</span> HttpClientRequest proxyRequest = req.options(NettyPipeline.SendOptions::flushOnEach)</div><div class="line"><span class="number">30</span>: .failOnClientError(<span class="keyword">false</span>) <span class="comment">// // æ˜¯å¦è¯·æ±‚å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></div><div class="line"><span class="number">31</span>: .headers(httpHeaders);</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: <span class="comment">// Request Form</span></div><div class="line"><span class="number">34</span>: <span class="keyword">if</span> (MediaType.APPLICATION_FORM_URLENCODED.includes(request.getHeaders().getContentType())) &#123;</div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> exchange.getFormData()</div><div class="line"><span class="number">36</span>: .flatMap(map -&gt; proxyRequest.sendForm(form -&gt; &#123;</div><div class="line"><span class="number">37</span>: <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; entry: map.entrySet()) &#123;</div><div class="line"><span class="number">38</span>: <span class="keyword">for</span> (String value : entry.getValue()) &#123;</div><div class="line"><span class="number">39</span>: form.attr(entry.getKey(), value);</div><div class="line"><span class="number">40</span>: &#125;</div><div class="line"><span class="number">41</span>: &#125;</div><div class="line"><span class="number">42</span>: &#125;).then())</div><div class="line"><span class="number">43</span>: .then(chain.filter(exchange));</div><div class="line"><span class="number">44</span>: &#125;</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>: <span class="comment">// Request Body</span></div><div class="line"><span class="number">47</span>: <span class="keyword">return</span> proxyRequest.sendHeaders() <span class="comment">//I shouldn't need this</span></div><div class="line"><span class="number">48</span>: .send(request.getBody()</div><div class="line"><span class="number">49</span>: .map(DataBuffer::asByteBuffer) <span class="comment">// Flux&lt;DataBuffer&gt; =&gt; ByteBuffer</span></div><div class="line"><span class="number">50</span>: .map(Unpooled::wrappedBuffer)); <span class="comment">// ByteBuffer =&gt; Flux&lt;DataBuffer&gt;</span></div><div class="line"><span class="number">51</span>: &#125;).doOnNext(res -&gt; &#123;</div><div class="line"><span class="number">52</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">53</span>: <span class="comment">// Response Header</span></div><div class="line"><span class="number">54</span>: <span class="comment">// put headers and status so filters can modify the response</span></div><div class="line"><span class="number">55</span>: HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</div><div class="line"><span class="number">56</span>: res.responseHeaders().forEach(entry -&gt; headers.add(entry.getKey(), entry.getValue()));</div><div class="line"><span class="number">57</span>: response.getHeaders().putAll(headers);</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>: <span class="comment">// Response Status</span></div><div class="line"><span class="number">60</span>: response.setStatusCode(HttpStatus.valueOf(res.status().code()));</div><div class="line"><span class="number">61</span>: </div><div class="line"><span class="number">62</span>: <span class="comment">// è®¾ç½® Response åˆ° CLIENT_RESPONSE_ATTR</span></div><div class="line"><span class="number">63</span>: <span class="comment">// Defer committing the response until all route filters have run</span></div><div class="line"><span class="number">64</span>: <span class="comment">// Put client response as ServerWebExchange attribute and write response later NettyWriteResponseFilter</span></div><div class="line"><span class="number">65</span>: exchange.getAttributes().put(CLIENT_RESPONSE_ATTR, res);</div><div class="line"><span class="number">66</span>: &#125;).then(chain.filter(exchange));</div><div class="line"><span class="number">67</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</li><li><p>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><code>http://</code> æˆ–è€… <code>https://</code> å‰ç¼€( Scheme ) ã€‚</li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 18 è¡Œ ï¼šåˆ›å»º <strong>Netty Request Method</strong> å¯¹è±¡ã€‚<code>request#getMethod()</code> è¿”å›çš„ä¸æ˜¯ <code>io.netty.handler.codec.http.HttpMethod</code> ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè½¬æ¢ã€‚</p></li><li>ç¬¬ 21 è¡Œ ï¼šè·å¾— <code>url</code> ã€‚</li><li>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º  <strong>Netty Request Header</strong> å¯¹è±¡( <code>io.netty.handler.codec.http.DefaultHttpHeaders</code> )ï¼Œå°†è¯·æ±‚çš„ Header è®¾ç½®ç»™å®ƒã€‚</li><li>â€”â€”â€” ç¬¬ 28 è‡³ 50 è¡Œ ï¼šè°ƒç”¨ <code>HttpClient#request(HttpMethod, String, Function)</code> æ–¹æ³•ï¼Œè¯·æ±‚åç«¯ Http æœåŠ¡ã€‚</li><li><p>ç¬¬ 29 è‡³ 31 è¡Œ ï¼šåˆ›å»º <strong>Netty Request</strong> å¯¹è±¡( <code>reactor.ipc.netty.http.client.HttpClientRequest</code> )ã€‚</p><ul><li>ç¬¬ 29 è¡Œ ï¼šTODO ã€3024ã€‘ NettyPipeline.SendOptions::flushOnEach</li><li><p>ç¬¬ 30 è¡Œ ï¼šè®¾ç½®è¯·æ±‚å¤±è´¥( åç«¯æœåŠ¡è¿”å›å“åº”çŠ¶ä½“ç  <code>&gt;= 400</code> )æ—¶ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HttpClientOperations#checkResponseCode(HttpResponse response)</span></div><div class="line"><span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (code &gt;= <span class="number">400</span>) &#123;</div><div class="line"><span class="keyword">if</span> (clientError) &#123;</div><div class="line"><span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">log.debug(<span class="string">"&#123;&#125; Received Request Error, stop reading: &#123;&#125;"</span>,</div><div class="line">channel(),</div><div class="line">response.toString());</div><div class="line">&#125;</div><div class="line">Exception ex = <span class="keyword">new</span> HttpClientException(uri(), response);</div><div class="line">parentContext().fireContextError(ex);</div><div class="line">receive().subscribe();</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€šè¿‡è®¾ç½® <code>clientError = false</code> ï¼Œç¬¬ 51 è¡Œå¯ä»¥è°ƒç”¨ <code>Mono#doNext(Consumer)</code> æ–¹æ³•ï¼Œ<strong>ç»Ÿä¸€è®¢é˜…å¤„ç†</strong>è¿”å›çš„ <code>reactor.ipc.netty.http.client.HttpClientResponse</code> å¯¹è±¡ã€‚</li></ul></li><li><p>ç¬¬ 31 è¡Œ ï¼šè®¾ç½® <strong>Netty Request</strong> å¯¹è±¡çš„ Header ã€‚</p></li></ul></li><li><p>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šã€TODO 3025ã€‘ç›®å‰æ˜¯ä¸€ä¸ª BUG ï¼Œåœ¨ 2.0.x ç‰ˆæœ¬ä¿®å¤ã€‚è§ <a href="FormIntegrationTests">FormIntegrationTests#formUrlencodedWorks()</a> å•å…ƒæµ‹è¯•çš„æ³¨é‡Šè¯´æ˜ã€‚</p></li><li><p>ç¬¬ 47 è‡³ 50 è¡Œ ï¼šè¯·æ±‚åç«¯çš„ Http æœåŠ¡ã€‚</p><ul><li>ç¬¬ 47 è¡Œ ï¼šå‘é€è¯·æ±‚ Header ã€‚</li><li>ç¬¬ 48 è‡³ 50 è¡Œ ï¼šå‘é€è¯·æ±‚ Body ã€‚å…¶ä¸­ä¸­é—´çš„ <code>#map(...)</code> çš„è¿‡ç¨‹ä¸º <code>Flux&lt;DataBuffer&gt; =&gt; ByteBuffer =&gt; Flux&lt;DataBuffer&gt;</code> ã€‚</li></ul></li><li><p>â€”â€”â€” ç¬¬ 51 è‡³ 65 è¡Œ ï¼šè¯·æ±‚åç«¯ Http æœåŠ¡<strong>å®Œæˆ</strong>ï¼Œå°† <strong>Netty Response</strong> èµ‹å€¼ç»™å“åº” <code>response</code> ã€‚</p></li><li>ç¬¬ 53 è‡³ 57 è¡Œ ï¼šåˆ›å»º <code>org.springframework.http.HttpHeaders</code> å¯¹è±¡ï¼Œå°† <strong>Netty Response Header</strong> è®¾ç½®ç»™å®ƒï¼Œè€Œåè®¾ç½®å›ç»™å“åº” <code>response</code> ã€‚</li><li>ç¬¬ 60 è¡Œ ï¼šè®¾ç½®å“åº” <code>response</code> çš„çŠ¶æ€ç ã€‚</li><li>ç¬¬ 65 è¡Œ ï¼šè®¾ç½® <strong>Netty Response</strong> åˆ° <code>CLIENT_RESPONSE_ATTR</code> ã€‚åç»­ NettyWriteResponseFilter å°† <strong>Netty Response</strong> å†™å›ç»™å®¢æˆ·ç«¯ã€‚</li><li>â€”â€”â€” ç¬¬ 66 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</li></ul><h1 id="3-NettyWriteResponseFilter"><a href="#3-NettyWriteResponseFilter" class="headerlink" title="3. NettyWriteResponseFilter"></a>3. NettyWriteResponseFilter</h1><p><code>org.springframework.cloud.gateway.filter.NettyWriteResponseFilter</code> ï¼ŒNetty å›å†™<strong>å“åº”</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_RESPONSE_FILTER_ORDER = -<span class="number">1</span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> WRITE_RESPONSE_FILTER_ORDER;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¿”å›é¡ºåºä¸º <code>-1</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// NOTICE: nothing in "pre" filter stage as CLIENT_RESPONSE_ATTR is not added</span></div><div class="line"> <span class="number">4</span>: <span class="comment">// until the WebHandler is run</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> chain.filter(exchange).then(Mono.defer(() -&gt; &#123;</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— Response</span></div><div class="line"> <span class="number">7</span>: HttpClientResponse clientResponse = exchange.getAttribute(CLIENT_RESPONSE_ATTR);</div><div class="line"> <span class="number">8</span>: <span class="comment">// HttpClientResponse clientResponse = getAttribute(exchange, CLIENT_RESPONSE_ATTR, HttpClientResponse.class);</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">if</span> (clientResponse == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: log.trace(<span class="string">"NettyWriteResponseFilter start"</span>);</div><div class="line"><span class="number">13</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="comment">// å°† Netty Response å†™å›ç»™å®¢æˆ·ç«¯ã€‚</span></div><div class="line"><span class="number">16</span>: NettyDataBufferFactory factory = (NettyDataBufferFactory) response.bufferFactory();</div><div class="line"><span class="number">17</span>: <span class="comment">//<span class="doctag">TODO:</span> what if it's not netty</span></div><div class="line"><span class="number">18</span>: <span class="keyword">final</span> Flux&lt;NettyDataBuffer&gt; body = clientResponse.receive()</div><div class="line"><span class="number">19</span>: .retain() <span class="comment">// ByteBufFlux =&gt; ByteBufFlux</span></div><div class="line"><span class="number">20</span>: .map(factory::wrap); <span class="comment">// ByteBufFlux  =&gt; Flux&lt;NettyDataBuffer&gt;</span></div><div class="line"><span class="number">21</span>: <span class="keyword">return</span> response.writeWith(body);</div><div class="line"><span class="number">22</span>: &#125;));</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>#then(Mono)</code> æ–¹æ³•ï¼Œå®ç° <strong>After Filter</strong> é€»è¾‘ã€‚</li><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šä» <code>CLIENT_RESPONSE_ATTR</code> ä¸­ï¼Œè·å¾— <strong>Netty Response</strong> ã€‚</li><li>ç¬¬ 15 è‡³ 21 è¡Œ ï¼šå°† <strong>Netty Response</strong> å†™å›ç»™å®¢æˆ·ç«¯ã€‚å› ä¸º <code>org.springframework.http.server.reactive#writeWith(Publisher&lt;? extends DataBuffer&gt;)</code> éœ€è¦çš„å‚æ•°ç±»å‹æ˜¯ <code>Publisher&lt;? extends DataBuffer&gt;</code> ï¼Œæ‰€ä»¥ã€ç¬¬ 18 è‡³ 20 è¡Œã€‘çš„è½¬æ¢è¿‡ç¨‹æ˜¯ <code>ByteBufFlux =&gt; Flux&lt;NettyDataBuffer&gt;</code> ã€‚<ul><li>ç¬¬ 19 è¡Œ ï¼šTODO ã€3024ã€‘ByteBufFlux#retain() </li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä¸‹ä¸€ç¯‡ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilterã€‹</a> èµ°èµ·ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_28/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-net
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.6) ä¹‹ WebSocketRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/</id>
    <published>2020-03-24T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">3. WebsocketRoutingFilter</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">3.1 ProxyWebSocketHandler</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>WebsocketRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>WebsocketRoutingFilter ï¼ŒWebsocket <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>ws://</code> / <code>wss://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œ<strong>ä»£ç†åç«¯ Websocket æœåŠ¡</strong>ï¼Œæä¾›ç»™å®¢æˆ·ç«¯è¿æ¥ã€‚å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_25/01.png" alt=""></p><ul><li>ç›®å‰<strong>ä¸€ä¸ª</strong> RouteDefinition åªèƒ½æŒ‡å®š<strong>ä¸€ä¸ª</strong>åç«¯ WebSocket æœåŠ¡ã€‚å®˜æ–¹æ­£åœ¨è®¡åˆ’åœ¨ LoadBalancerClientFilter ä¸Šå®ç° Websocket çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ä¹Ÿå°±è¯´ï¼Œæœªæ¥<strong>ä¸€ä¸ª</strong> RouteDefinition èƒ½å¤ŸæŒ‡å®š<strong>å¤šä¸ª</strong>åç«¯ WebSocket æœåŠ¡ã€‚</li></ul><p>Websocket çš„ RouteDefinition é…ç½®å¦‚ä¸‹ ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">websocket_test</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">ws://localhost:9000</span></div><div class="line"><span class="attr">        order:</span> <span class="number">8000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/echo</span></div></pre></td></tr></table></figure><ul><li><code>uri</code> ä½¿ç”¨ <code>ws://</code> æˆ–è€… <code>wss://</code> ä¸ºå‰ç¼€ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-ç¯å¢ƒæ­å»º"><a href="#2-ç¯å¢ƒæ­å»º" class="headerlink" title="2. ç¯å¢ƒæ­å»º"></a>2. ç¯å¢ƒæ­å»º</h1><p>åœ¨è§£ææºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»¥ <a href="https://github.com/websockets/wscat" rel="external nofollow noopener noreferrer" target="_blank">wscat</a>  æ­å»ºä¸€ä¸ª WebSocket æœåŠ¡ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œå®‰è£… wscat ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install -g wscat</div></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼Œå¯åŠ¨ wscat ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wscat --listen 9000</div></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥ï¼Œè¿æ¥ wscat ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wscat --listen 9000</div></pre></td></tr></table></figure><p>ç¬¬å››æ­¥ï¼Œé…ç½® RouteDefinition ï¼Œå¹¶å¯åŠ¨ Spring Cloud Gateway ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cloud:</div><div class="line">    gateway:</div><div class="line">      routes:</div><div class="line">      - id: websocket_test</div><div class="line">        uri: ws://localhost:9000</div><div class="line">        order: 8000</div><div class="line">        predicates:</div><div class="line">        - Path=/echo</div></pre></td></tr></table></figure><p>ç¬¬äº”æ­¥ï¼Œé€šè¿‡ Gateway è¿æ¥ wscat ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wscat --connect ws://localhost:8080/echo</div></pre></td></tr></table></figure><p>å¤§åŠŸå‘Šæˆã€‚</p><p>æ³¨æ„ï¼Œwscat åŒä¸€æ—¶é—´ä»…å…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚</p><h1 id="3-WebsocketRoutingFilter"><a href="#3-WebsocketRoutingFilter" class="headerlink" title="3. WebsocketRoutingFilter"></a>3. WebsocketRoutingFilter</h1><p><code>org.springframework.cloud.gateway.filter.WebsocketRoutingFilter</code> ï¼ŒWebsocket <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketRoutingFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEC_WEBSOCKET_PROTOCOL = <span class="string">"Sec-WebSocket-Protocol"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebSocketClient webSocketClient;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebSocketService webSocketService;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebsocketRoutingFilter</span><span class="params">(WebSocketClient webSocketClient)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>(webSocketClient, <span class="keyword">new</span> HandshakeWebSocketService());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebsocketRoutingFilter</span><span class="params">(WebSocketClient webSocketClient,</span></span></div><div class="line"><span class="function"><span class="params">WebSocketService webSocketService)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.webSocketClient = webSocketClient;</div><div class="line"><span class="keyword">this</span>.webSocketService = webSocketService;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>webSocketClient</code> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/init/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³åˆå§‹åŒ–ã€‹ã€Œ5.2 åˆå§‹åŒ– NettyConfigurationã€</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>org.springframework.web.reactive.socket.client.ReactorNettyWebSocketClient</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¿æ¥åç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡</strong>ã€‚</li><li><code>webSocketService</code> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/init/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³åˆå§‹åŒ–ã€‹ã€Œ5.3 åˆå§‹åŒ– GlobalFilterã€</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>org.springframework.web.reactive.socket.server.support.HandshakeWebSocketService</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚( Handshake Request ) ã€‚</li></ul><hr><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// è·å¾— requestUrl</span></div><div class="line"> <span class="number">4</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"> <span class="number">7</span>: String scheme = requestUrl.getScheme();</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || (!scheme.equals(<span class="string">"ws"</span>) &amp;&amp; !scheme.equals(<span class="string">"wss"</span>))) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">13</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="comment">// å¤„ç†è¿æ¥è¯·æ±‚</span></div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> <span class="keyword">this</span>.webSocketService.handleRequest(exchange,</div><div class="line"><span class="number">17</span>: <span class="keyword">new</span> ProxyWebSocketHandler(requestUrl, <span class="keyword">this</span>.webSocketClient, exchange.getRequest().getHeaders()));</div><div class="line"><span class="number">18</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</li><li><p>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><code>ws://</code> æˆ–è€… <code>wss://</code> å‰ç¼€( Scheme ) ã€‚</li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 15 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>WebSocketService#hanldeRequest(ServerWebExchange, WebSocketHandler)</code> æ–¹æ³•ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚( Handshake Request ) ã€‚è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸åœ¨æœ¬æ–‡èŒƒå›´å†…ï¼Œä½†æ˜¯è‰¯å¿ƒå¦‚ç¬”è€…ï¼Œå¤§æ¦‚è®²ä¸‹æ¶‰åŠåˆ°çš„ç±» ï¼š</p><ul><li>ä¸»è¦é€»è¾‘åœ¨ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/socket/server/upgrade/ReactorNettyRequestUpgradeStrategy.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.web.reactive.socket.server.upgrade.ReactorNettyRequestUpgradeStrategy</code></a> ç±»é‡Œã€‚</li><li>ã€ç¬¬ä¸€æ­¥ã€‘ ReactorNettyRequestUpgradeStrategy è°ƒç”¨ <a href="https://github.com/reactor/reactor-netty/blob/master/src/main/java/reactor/ipc/netty/http/server/HttpServerWSOperations.java" rel="external nofollow noopener noreferrer" target="_blank"><code>reactor.ipc.netty.http.server.HttpServerWSOperations</code></a> ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚ã€‚å¤„ç†æˆåŠŸï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯è¿æ¥æˆåŠŸã€‚</li><li>ã€ç¬¬äºŒæ­¥ã€‘ReactorNettyRequestUpgradeStrategy è°ƒç”¨ <a href="https://github.com/spring-projects/spring-framework/blob/8f69b5ff23d6835eee89a26c0e1e3e63a64a21a0/spring-webflux/src/main/java/org/springframework/web/reactive/socket/WebSocketHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.web.reactive.socket.server.upgrade.ReactorNettyRequestUpgradeStrategy</code></a> <strong>æ¥å£</strong>çš„ <code>#handle(WebSocketSession)</code> æ–¹æ³•ï¼Œå¤„ç†å®¢æˆ·ç«¯ WebSocket Session ã€‚ProxyWebSocketHandler æ˜¯ WebSocketHandler çš„<strong>å®ç°ç±»</strong>ï¼Œåœ¨ <a href="#">ã€Œ3.1 ProxyWebSocketHandlerã€</a> æ¥è¯¦ç»†è§£æ <code>#handle(WebSocketSession)</code> å®ç°äº†ä»€ä¹ˆé€»è¾‘ã€‚</li></ul></li></ul><h2 id="3-1-ProxyWebSocketHandler"><a href="#3-1-ProxyWebSocketHandler" class="headerlink" title="3.1 ProxyWebSocketHandler"></a>3.1 ProxyWebSocketHandler</h2><p><code>org.springframework.cloud.gateway.filter.WebsocketRoutingFilter.ProxyWebSocketHandler</code> ï¼Œ<strong>ä»£ç†</strong>åç«¯ WebSocket æœåŠ¡å¤„ç†å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyWebSocketHandler</span> <span class="keyword">implements</span> <span class="title">WebSocketHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">final</span> WebSocketClient client;</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> URI url;</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> HttpHeaders headers;</div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; subProtocols;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">ProxyWebSocketHandler</span><span class="params">(URI url, WebSocketClient client, HttpHeaders headers)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">this</span>.client = client;</div><div class="line"><span class="number">10</span>: <span class="keyword">this</span>.url = url;</div><div class="line"><span class="number">11</span>: <span class="keyword">this</span>.headers = <span class="keyword">new</span> HttpHeaders();<span class="comment">//headers;</span></div><div class="line"><span class="number">12</span>: <span class="comment">//<span class="doctag">TODO:</span> better strategy to filter these headers?</span></div><div class="line"><span class="number">13</span>: headers.entrySet().forEach(header -&gt; &#123;</div><div class="line"><span class="number">14</span>: <span class="keyword">if</span> (!header.getKey().toLowerCase().startsWith(<span class="string">"sec-websocket"</span>)</div><div class="line"><span class="number">15</span>: &amp;&amp; !header.getKey().equalsIgnoreCase(<span class="string">"upgrade"</span>)</div><div class="line"><span class="number">16</span>: &amp;&amp; !header.getKey().equalsIgnoreCase(<span class="string">"connection"</span>)) &#123;</div><div class="line"><span class="number">17</span>: <span class="keyword">this</span>.headers.addAll(header.getKey(), header.getValue());</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: &#125;);</div><div class="line"><span class="number">20</span>: List&lt;String&gt; protocols = headers.get(SEC_WEBSOCKET_PROTOCOL);</div><div class="line"><span class="number">21</span>: <span class="keyword">if</span> (protocols != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>: <span class="keyword">this</span>.subProtocols = protocols;</div><div class="line"><span class="number">23</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">24</span>: <span class="keyword">this</span>.subProtocols = Collections.emptyList();</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>client</code> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/init/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³åˆå§‹åŒ–ã€‹ã€Œ5.2 åˆå§‹åŒ– NettyConfigurationã€</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>org.springframework.web.reactive.socket.client.ReactorNettyWebSocketClient</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¿æ¥åç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡</strong>ã€‚</li><li><code>url</code> å±æ€§ï¼Œåç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡çš„åœ°å€ã€‚</li><li><code>header</code> å±æ€§ï¼Œè¯·æ±‚å¤´ï¼Œåœ¨ <a href="http://blog.csdn.net/baiye_xing/article/details/73938360" rel="external nofollow noopener noreferrer" target="_blank">ã€Š ã€è®¡ç½‘ã€‘HTTPä¸WebSocketçš„åŒºåˆ«ã€‹</a> æœ‰è¯¦ç»†è§£æï¼ŒåŒ…æ‹¬ä¸ºä»€ä¹ˆã€ç¬¬ 14 è‡³ 18 è¡Œã€‘çš„ä»£ç è¿™æ ·å¤„ç†ã€‚</li><li><code>subProtocols</code> å±æ€§ï¼Œæœ€ç»ˆé€šä¿¡ä½¿ç”¨çš„åè®®ã€‚</li></ul><hr><p><code>#handle(WebSocketSession)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(WebSocketSession session)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// pass headers along so custom headers can be sent through</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">return</span> client.execute(url, <span class="keyword">this</span>.headers, <span class="keyword">new</span> WebSocketHandler() &#123;</div><div class="line"> <span class="number">5</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(WebSocketSession proxySession)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: <span class="comment">// Use retain() for Reactor Netty</span></div><div class="line"> <span class="number">8</span>: <span class="comment">// è½¬å‘æ¶ˆæ¯ å®¢æˆ·ç«¯ =ã€‹åç«¯æœåŠ¡</span></div><div class="line"> <span class="number">9</span>: Mono&lt;Void&gt; proxySessionSend = proxySession</div><div class="line"><span class="number">10</span>: .send(session.receive().doOnNext(WebSocketMessage::retain));</div><div class="line"><span class="number">11</span>: <span class="comment">// è½¬å‘æ¶ˆæ¯ åç«¯æœåŠ¡=ã€‹å®¢æˆ·ç«¯</span></div><div class="line"><span class="number">12</span>: <span class="comment">// .log("proxySessionSend", Level.FINE);</span></div><div class="line"><span class="number">13</span>: Mono&lt;Void&gt; serverSessionSend = session</div><div class="line"><span class="number">14</span>: .send(proxySession.receive().doOnNext(WebSocketMessage::retain));</div><div class="line"><span class="number">15</span>: <span class="comment">// .log("sessionSend", Level.FINE);</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// </span></div><div class="line"><span class="number">18</span>: <span class="keyword">return</span> Mono.when(proxySessionSend, serverSessionSend).then();</div><div class="line"><span class="number">19</span>: &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">22:  * Copy subProtocols so they are available downstream.</span></div><div class="line"><span class="comment">23:  * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">24:  */</span></div><div class="line"><span class="number">25</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">26</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getSubProtocols</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">27</span>: <span class="keyword">return</span> ProxyWebSocketHandler.<span class="keyword">this</span>.subProtocols;</div><div class="line"><span class="number">28</span>: &#125;</div><div class="line"><span class="number">29</span>: &#125;);</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>WebSocketClient#execute(URI, HttpHeaders, WebSocketHandler)</code> æ–¹æ³•ï¼Œ<strong>è¿æ¥åç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡</strong>ã€‚è¿æ¥æˆåŠŸåï¼Œå›è°ƒ WebSocketHandler å®ç°çš„å†…éƒ¨ç±»çš„ <code>#handle(WebSocketSession)</code> æ–¹æ³•ã€‚</li><li>WebSocketHandler å®ç°çš„å†…éƒ¨ç±» <ul><li>ç¬¬ 9 è‡³ 10 è¡Œ ï¼šè½¬å‘æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯ <code>=&gt;</code> åç«¯æœåŠ¡ã€‚</li><li>ç¬¬ 13 è‡³ 14 è¡Œ ï¼šè½¬å‘æ¶ˆæ¯ï¼Œåç«¯æœåŠ¡ <code>=&gt;</code> å®¢æˆ·ç«¯ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šè°ƒç”¨ <code>Mono#when()</code> æ–¹æ³•ï¼Œåˆå¹¶ <code>proxySessionSend</code> / <code>serverSessionSend</code> ä¸¤ä¸ª Mono ã€‚è°ƒç”¨ <code>Mono#then()</code> æ–¹æ³•ï¼Œ<strong>å‚æ•°ä¸ºç©º</strong>ï¼Œåˆå¹¶çš„ Mono ä¸å‘å°„æ•°æ®å‡ºæ¥ã€‚RxJava å’Œ Reactor ç±»ä¼¼ï¼Œå¯ä»¥å‚è€ƒ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/And.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” And/Then/Whenã€‹</a> å­¦ä¹ ä¸‹ <code>when / and / then</code> æ“ä½œç¬¦ã€‚</li><li>ä¸‹å›¾å¯ä»¥å¸®åŠ©ç†è§£ä¸‹è¿™ä¸ªç±»çš„ç”¨é€” ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_25/01.png" alt=""></li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ é™äºå¯¹ Reactor å’Œ Netty äº†è§£ä¸å¤Ÿæ·±å…¥ï¼Œå†™çš„ä¸å¤Ÿé€å½»ã€‚å›å¤´æ·±å…¥ç†è§£ä¸‹å®ƒä»¬ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_25/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.5) ä¹‹ ForwardRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/</id>
    <published>2020-03-19T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">2. RouteToRequestUrlFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>ForwardRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>RouteToRequestUrlFilter ï¼Œè½¬å‘<strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>forward://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œ<strong>å°†è¯·æ±‚è½¬å‘åˆ°å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œé…ç½® RouteDefinition è·¯ç”±å®šä¹‰å¦‚ä¸‹ ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">juejin-gateway</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">forward_sample</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">forward:///globalfilters</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/globalfilters</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">PrefixPath=/application/gateway</span></div></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬å‡å®šç½‘å…³ç«¯å£ä¸º <code>8080</code> ã€‚</li><li>å½“è¯·æ±‚ <code>http://127.0.0.1:8080/globalfilters</code> æ¥å£ï¼ŒSpring Cloud Gateway å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ ï¼š<ul><li>åŒ¹é…åˆ°è·¯ç”± Route (<code>id = forward_sample</code>) ã€‚</li><li><strong>é…ç½®</strong>çš„ PrefixPathGatewayFilterFactory å°†è¯·æ±‚<strong>æ”¹å†™</strong>æˆ <code>http://127.0.0.1:8080/application/gateway/globalfilters</code> ã€‚</li><li>ForwardRoutingFilter åˆ¤æ–­æœ‰ <code>forward://</code> å‰ç¼€( Scheme )ï¼Œè¿‡æ»¤å¤„ç†ï¼Œå°†è¯·æ±‚<strong>è½¬å‘</strong>ç»™ DispatcherHandler ã€‚</li><li>DispatcherHandler åŒ¹é…å¹¶è½¬å‘åˆ°<strong>å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</strong> <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/83496b78944269050373bb92bb2181e1b7c070e8/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/actuate/GatewayWebfluxEndpoint.java#L96" rel="external nofollow noopener noreferrer" target="_blank"><code>application/gateway/globalfilters</code></a> ã€‚</li></ul></li><li>ä¸ºä»€ä¹ˆéœ€è¦é…ç½® PrefixPathGatewayFilterFactory ï¼Ÿéœ€è¦é€šè¿‡ PrefixPathGatewayFilterFactory å°†è¯·æ±‚é‡å†™è·¯å¾„ï¼Œä»¥åŒ¹é…æœ¬åœ° API ï¼Œå¦åˆ™ DispatcherHandler è½¬å‘ä¼šå¤±è´¥ã€‚</li></ul><p>å¦å¤–ï¼ŒRouteToRequestUrlFilter æ˜¯ Spring Cloud Gateway å®ç°çš„ä¸€ç§<strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ï¼Œç›®å‰è¿˜æä¾› WebsocketRoutingFilter / NettyRoutingFilter / WebClientHttpRoutingFilter ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-RouteToRequestUrlFilter"><a href="#2-RouteToRequestUrlFilter" class="headerlink" title="2. RouteToRequestUrlFilter"></a>2. RouteToRequestUrlFilter</h1><p><code>org.springframework.cloud.gateway.filter.ForwardRoutingFilter</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardRoutingFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(ForwardRoutingFilter.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> DispatcherHandler dispatcherHandler;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="title">ForwardRoutingFilter</span><span class="params">(DispatcherHandler dispatcherHandler)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">this</span>.dispatcherHandler = dispatcherHandler;</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line"><span class="number">14</span>: &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"><span class="number">18</span>:     <span class="comment">// è·å¾— requestUrl</span></div><div class="line"><span class="number">19</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"><span class="number">22</span>: String scheme = requestUrl.getScheme();</div><div class="line"><span class="number">23</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || !scheme.equals(<span class="string">"forward"</span>)) &#123;</div><div class="line"><span class="number">24</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">28</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">//<span class="doctag">TODO:</span> translate url?</span></div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>: <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line"><span class="number">33</span>: log.trace(<span class="string">"Forwarding to URI: "</span>+requestUrl);</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">// DispatcherHandler åŒ¹é…å¹¶è½¬å‘åˆ°å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</span></div><div class="line"><span class="number">37</span>: <span class="keyword">return</span> <span class="keyword">this</span>.dispatcherHandler.handle(exchange);</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure><ul><li>å®ç° <strong>GlobalFilter</strong> æ¥å£ã€‚</li><li><code>#getOrder()</code> æ–¹æ³•ï¼Œè¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li><li>ç¬¬ 19 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</li><li><p>ç¬¬ 22 è‡³ 25 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><code>forward://</code> å‰ç¼€( Scheme ) ã€‚</li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 28 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 37 è¡Œ ï¼šå°†è¯·æ±‚<strong>è½¬å‘</strong>ç»™ DispatcherHandler ã€‚DispatcherHandler åŒ¹é…å¹¶è½¬å‘åˆ°<strong>å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</strong>ã€‚</p></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä¸€å¼€å§‹æƒ³é”™äº† ForwardRoutingFilter äº†çš„ç”¨é€”ï¼Œè°ƒè¯•è®¸ä¹…ï¼Œåé¢çœ‹äº†å®˜æ–¹æä¾›çš„ç¤ºä¾‹ <code>org.springframework.cloud.gateway.test.ForwardTests</code> ï¼Œè±ç„¶å¼€æœ—ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_20/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-f
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.4) ä¹‹ LoadBalancerClientFilter è´Ÿè½½å‡è¡¡</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/</id>
    <published>2020-03-14T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">3. LoadBalancerClientFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">4. é«˜èƒ½</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>LoadBalancerClientFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>LoadBalancerClientFilter æ ¹æ® <code>lb://</code> å‰ç¼€è¿‡æ»¤å¤„ç†ï¼Œä½¿ç”¨ <code>serviceId</code> é€‰æ‹©<strong>ä¸€ä¸ª</strong>æœåŠ¡å®ä¾‹ï¼Œä»è€Œå®ç°<strong>è´Ÿè½½å‡è¡¡</strong>ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-ç¯å¢ƒæ­å»º"><a href="#2-ç¯å¢ƒæ­å»º" class="headerlink" title="2. ç¯å¢ƒæ­å»º"></a>2. ç¯å¢ƒæ­å»º</h1><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.4ï¼‰ä¹‹ DiscoveryClientRouteDefinitionLocator æ³¨å†Œä¸­å¿ƒã€‹ã€Œ2. ç¯å¢ƒæ­å»ºã€</a> æœ‰è¯¦ç»†æ•™ç¨‹ã€‚</p><h1 id="3-LoadBalancerClientFilter"><a href="#3-LoadBalancerClientFilter" class="headerlink" title="3. LoadBalancerClientFilter"></a>3. LoadBalancerClientFilter</h1><p><code>org.springframework.cloud.gateway.filter.LoadBalancerClientFilter</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerClientFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(LoadBalancerClientFilter.class);</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_BALANCER_CLIENT_FILTER_ORDER = <span class="number">10100</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancerClient loadBalancer;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">LoadBalancerClientFilter</span><span class="params">(LoadBalancerClient loadBalancer)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">this</span>.loadBalancer = loadBalancer;</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> LOAD_BALANCER_CLIENT_FILTER_ORDER;</div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">18</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: <span class="comment">// è·å¾— URL</span></div><div class="line"><span class="number">20</span>: URI url = exchange.getAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"><span class="number">21</span>: <span class="keyword">if</span> (url == <span class="keyword">null</span> || !url.getScheme().equals(<span class="string">"lb"</span>)) &#123;</div><div class="line"><span class="number">22</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: <span class="comment">// æ·»åŠ  åŸå§‹è¯·æ±‚URI åˆ° GATEWAY_ORIGINAL_REQUEST_URL_ATTR</span></div><div class="line"><span class="number">25</span>: <span class="comment">//preserve the original url</span></div><div class="line"><span class="number">26</span>: addOriginalRequestUrl(exchange, url);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: log.trace(<span class="string">"LoadBalancerClientFilter url before: "</span> + url);</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">// è·å– æœåŠ¡å®ä¾‹</span></div><div class="line"><span class="number">31</span>: <span class="keyword">final</span> ServiceInstance instance = loadBalancer.choose(url.getHost());</div><div class="line"><span class="number">32</span>: <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">33</span>: <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundException(<span class="string">"Unable to find instance for "</span> + url.getHost());</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">/*URI uri = exchange.getRequest().getURI();</span></div><div class="line"><span class="comment">37: URI requestUrl = loadBalancer.reconstructURI(instance, uri);*/</span></div><div class="line"><span class="number">38</span>: <span class="comment">//</span></div><div class="line"><span class="number">39</span>: URI requestUrl = UriComponentsBuilder.fromUri(url)</div><div class="line"><span class="number">40</span>: .scheme(instance.isSecure()? <span class="string">"https"</span> : <span class="string">"http"</span>) <span class="comment">//<span class="doctag">TODO:</span> support websockets</span></div><div class="line"><span class="number">41</span>: .host(instance.getHost())</div><div class="line"><span class="number">42</span>: .port(instance.getPort())</div><div class="line"><span class="number">43</span>: .build(<span class="keyword">true</span>)</div><div class="line"><span class="number">44</span>: .toUri();</div><div class="line"><span class="number">45</span>: log.trace(<span class="string">"LoadBalancerClientFilter url chosen: "</span> + requestUrl);</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>: <span class="comment">// æ·»åŠ  è¯·æ±‚URI åˆ° GATEWAY_REQUEST_URL_ATTR</span></div><div class="line"><span class="number">48</span>: exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, requestUrl);</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>: <span class="comment">// æäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤</span></div><div class="line"><span class="number">51</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">52</span>: &#125;</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šè·å¾— URL ã€‚<strong>åªå¤„ç† <code>lb://</code> ä¸ºå‰ç¼€( Scheme )çš„åœ°å€</strong>ã€‚</li><li><p>ç¬¬ ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>ServerWebExchangeUtils#addOriginalRequestUrl(...)</code> æ·»åŠ åŸå§‹è¯·æ±‚ URI åˆ° <code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addOriginalRequestUrl</span><span class="params">(ServerWebExchange exchange, URI url)</span> </span>&#123;</div><div class="line">exchange.getAttributes().computeIfAbsent(GATEWAY_ORIGINAL_REQUEST_URL_ATTR, s -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;()); <span class="comment">// æ•°ç»„ï¼Œè€ƒè™‘å¤šæ¬¡é‡å†™</span></div><div class="line">    LinkedHashSet&lt;URI&gt; uris = exchange.getRequiredAttribute(GATEWAY_ORIGINAL_REQUEST_URL_ATTR);</div><div class="line">    uris.add(url);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä¸ºä»€ä¹ˆä½¿ç”¨ LinkedHashSet ï¼Ÿå› ä¸ºå¯ä»¥ä½¿ç”¨ RewritePathGatewayFilterFactory / PrefixPathGatewayFilterFactory å¤šæ¬¡é‡å†™ã€‚</li></ul></li><li><p>ç¬¬ 30 è‡³ 34 è¡Œ ï¼šè°ƒç”¨ <code>LoadBalancerClient#choose(String)</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¸€ä¸ª</strong>æœåŠ¡å®ä¾‹( ServiceInstance ) ï¼Œä»è€Œå®ç°<strong>è´Ÿè½½å‡è¡¡</strong>ã€‚</p><ul><li>ç†Ÿæ‚‰ Spring Cloud çš„åŒå­¦éƒ½çŸ¥é“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ LoadBalancerClient å®ç°ç±»ä¸º <code>org.springframework.cloud.netflix.ribbon.RibbonLoadBalancerClient</code> ã€‚</li><li>ä¸¾ä¸ª <code>instance</code> çš„<strong>å€¼</strong>ä¾‹å­ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_15/01.png" alt=""></li></ul></li><li>ç¬¬ 39 è‡³ 45 è¡Œ ï¼šåˆ›å»º <code>requestUrl</code> ã€‚ä¸¾ä¸ªä¾‹å­ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_15/02.png" alt=""></li><li>ç¬¬ 48 è¡Œ ï¼šè®¾ç½® <code>requestUrl</code> åˆ° <code>GATEWAY_REQUEST_URL_ATTR</code> ã€‚åé¢ Routing ç›¸å…³çš„ GatewayFilter ä¼šé€šè¿‡è¯¥å±æ€§ï¼Œå‘èµ·è¯·æ±‚ã€‚</li><li>ç¬¬ 51 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚<strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œä¸éœ€è¦åˆ›å»º<strong>æ–°</strong>çš„ ServerWebExchange </li></ul><h1 id="4-é«˜èƒ½"><a href="#4-é«˜èƒ½" class="headerlink" title="4. é«˜èƒ½"></a>4. é«˜èƒ½</h1><p>æˆ‘ä»¬å›è¿‡å¤´çœ‹ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.4ï¼‰ä¹‹ DiscoveryClientRouteDefinitionLocator æ³¨å†Œä¸­å¿ƒã€‹ã€Œ4. é«˜èƒ½ã€</a></p><p>ç›¸åŒæœåŠ¡( <code>serviceId</code> ç›¸åŒ) ï¼ŒæœåŠ¡å®ä¾‹çš„æ³¨å†Œæˆ–ä¸‹çº¿ï¼ŒRibbon å·²ç»å¤„ç†ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ²¡æœ‰å½©è›‹ï¼Œç»§ç»­å¾€ä¸‹å†™ï¼å½“ç„¶ï¼Œã€Šå¤©æ‰éº»å°†å°‘å¥³ã€‹çš„ç¦åˆ©è¿˜æ˜¯æœ‰çš„ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_15/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/fil
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.3) ä¹‹ RouteToRequestUrlFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/</id>
    <published>2020-03-09T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/">2. RouteToRequestUrlFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RouteToRequestUrlFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>RouteToRequestUrlFilter æ ¹æ®<strong>åŒ¹é…</strong>çš„ Route ï¼Œè®¡ç®—è¯·æ±‚çš„åœ°å€ã€‚<strong>æ³¨æ„ï¼Œè¿™é‡Œçš„åœ°å€æŒ‡çš„æ˜¯ URL ï¼Œè€Œä¸æ˜¯ URI</strong> ã€‚</p><p>ğŸ˜ˆ RouteToRequestUrlFilter çš„ä»£ç ååˆ†å°‘ï¼Œæ‰€ä»¥è¿™ä¼šæ˜¯ä¸€ç¯‡ç®€å•çš„æ–‡ç« ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-RouteToRequestUrlFilter"><a href="#2-RouteToRequestUrlFilter" class="headerlink" title="2. RouteToRequestUrlFilter"></a>2. RouteToRequestUrlFilter</h1><p><code>org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteToRequestUrlFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(RouteToRequestUrlFilter.class);</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ROUTE_TO_URL_FILTER_ORDER = <span class="number">10000</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">return</span> ROUTE_TO_URL_FILTER_ORDER;</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"><span class="number">13</span>:     <span class="comment">// è·å¾— Route</span></div><div class="line"><span class="number">14</span>: Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);</div><div class="line"><span class="number">15</span>: <span class="keyword">if</span> (route == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">17</span>: &#125;</div><div class="line"><span class="number">18</span>: log.trace(<span class="string">"RouteToRequestUrlFilter start"</span>);</div><div class="line"><span class="number">19</span>: <span class="comment">// æ‹¼æ¥ requestUrl</span></div><div class="line"><span class="number">20</span>: URI requestUrl = UriComponentsBuilder.fromHttpRequest(exchange.getRequest())</div><div class="line"><span class="number">21</span>: .uri(route.getUri())</div><div class="line"><span class="number">22</span>: .build(<span class="keyword">true</span>) <span class="comment">// encoded=true</span></div><div class="line"><span class="number">23</span>: .toUri();</div><div class="line"><span class="number">24</span>: <span class="comment">// è®¾ç½® requestUrl åˆ° GATEWAY_REQUEST_URL_ATTR &#123;@link RewritePathGatewayFilterFactory&#125;</span></div><div class="line"><span class="number">25</span>: exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, requestUrl);</div><div class="line"><span class="number">26</span>: <span class="comment">// æäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤</span></div><div class="line"><span class="number">27</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">28</span>: &#125;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure><ul><li>å®ç° <strong>GlobalFilter</strong> æ¥å£ã€‚</li><li><code>#getOrder()</code> æ–¹æ³•ï¼Œè¿”å›é¡ºåºä¸º 10000 ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li><li>ç¬¬ 13 è‡³ 18 è¡Œ ï¼šè·å¾—è¯·æ±‚åŒ¹é…çš„ Route ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.2) ä¹‹ RoutePredicateHandlerMapping è·¯ç”±åŒ¹é…ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 20 è‡³ 23 è¡Œ ï¼šæ‹¼æ¥ <code>requestUrl</code> ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œå¦‚æœ <code>Route.uri</code> å±æ€§é…ç½®å¸¦æœ‰ Path ï¼Œåˆ™ä¼šè¦†ç›–è¯·æ±‚çš„ Path ã€‚æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ ï¼š</li></ul><table><thead><tr><th><code>Route.uri</code></th><th><code>Request.uri</code></th><th><code>requestUrl</code></th></tr></thead><tbody><tr><td><a href="http://bin.org:80" rel="external nofollow noopener noreferrer" target="_blank">http://bin.org:80</a></td><td><a href="http://127.0.0.1:8080/test/segment" rel="external nofollow noopener noreferrer" target="_blank">http://127.0.0.1:8080/test/segment</a></td><td><a href="http://httpbin.org:80/123" rel="external nofollow noopener noreferrer" target="_blank">http://httpbin.org:80/123</a></td></tr><tr><td><a href="http://bin.org:80/123" rel="external nofollow noopener noreferrer" target="_blank">http://bin.org:80/123</a></td><td><a href="http://127.0.0.1:8080/test/segment" rel="external nofollow noopener noreferrer" target="_blank">http://127.0.0.1:8080/test/segment</a></td><td><a href="http://httpbin.org:80/test/segment" rel="external nofollow noopener noreferrer" target="_blank">http://httpbin.org:80/test/segment</a></td></tr></tbody></table><ul><li><p>ä¸ºä»€ä¹ˆä¼šå¯¼è‡´è¦†ç›–çš„æƒ…å†µå‘¢ ï¼Ÿç­”æ¡ˆåœ¨ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/util/UriComponentsBuilder.java#L413" rel="external nofollow noopener noreferrer" target="_blank"><code>UriComponentsBuilder#uri(URI)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><pre><code class="Java"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> UriComponentsBuilder <span class="title">uri</span><span class="params">(URI uri)</span> </span>{ <span class="number">2</span>:     Assert.notNull(uri, <span class="string">"URI must not be null"</span>); <span class="number">3</span>:     <span class="keyword">this</span>.scheme = uri.getScheme(); <span class="number">4</span>:     <span class="keyword">if</span> (uri.isOpaque()) { <span class="number">5</span>:         <span class="keyword">this</span>.ssp = uri.getRawSchemeSpecificPart(); <span class="number">6</span>:         resetHierarchicalComponents(); <span class="number">7</span>:     } <span class="number">8</span>:     <span class="keyword">else</span> { <span class="number">9</span>:         <span class="keyword">if</span> (uri.getRawUserInfo() != <span class="keyword">null</span>) {<span class="number">10</span>:             <span class="keyword">this</span>.userInfo = uri.getRawUserInfo();<span class="number">11</span>:         }<span class="number">12</span>:         <span class="keyword">if</span> (uri.getHost() != <span class="keyword">null</span>) {<span class="number">13</span>:             <span class="keyword">this</span>.host = uri.getHost();<span class="number">14</span>:         }<span class="number">15</span>:         <span class="keyword">if</span> (uri.getPort() != -<span class="number">1</span>) {<span class="number">16</span>:             <span class="keyword">this</span>.port = String.valueOf(uri.getPort());<span class="number">17</span>:         }<span class="number">18</span>:         <span class="keyword">if</span> (StringUtils.hasLength(uri.getRawPath())) {<span class="number">19</span>:             <span class="keyword">this</span>.pathBuilder = <span class="keyword">new</span> CompositePathComponentBuilder();<span class="number">20</span>:             <span class="keyword">this</span>.pathBuilder.addPath(uri.getRawPath());<span class="number">21</span>:         }<span class="number">22</span>:         <span class="keyword">if</span> (StringUtils.hasLength(uri.getRawQuery())) {<span class="number">23</span>:             <span class="keyword">this</span>.queryParams.clear();<span class="number">24</span>:             query(uri.getRawQuery());<span class="number">25</span>:         }<span class="number">26</span>:         resetSchemeSpecificPart();<span class="number">27</span>:     }<span class="number">28</span>:     <span class="keyword">if</span> (uri.getRawFragment() != <span class="keyword">null</span>) {<span class="number">29</span>:         <span class="keyword">this</span>.fragment = uri.getRawFragment();<span class="number">30</span>:     }<span class="number">31</span>:     <span class="keyword">return</span> <span class="keyword">this</span>;<span class="number">32</span>: }</code></pre><ul><li>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šå½“ <code>uri</code> å‚æ•°æœ‰ Path æ—¶ï¼Œ<strong>æ–°å»º</strong>ä¸€ä¸ª CompositePathComponentBuilder ï¼Œå› æ­¤åŸæœ‰çš„ <code>this.pathBuilder</code> è¢«<strong>è¦†ç›–</strong>äº†ã€‚</li></ul></li><li><p>ç¬¬ 25 è¡Œ ï¼šè®¾ç½® <code>requestUrl</code> åˆ° <code>GATEWAY_REQUEST_URL_ATTR</code> ã€‚åé¢ Routing ç›¸å…³çš„ GatewayFilter ä¼šé€šè¿‡è¯¥å±æ€§ï¼Œå‘èµ·è¯·æ±‚ã€‚</p></li><li>ç¬¬ 27 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚<strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œä¸éœ€è¦åˆ›å»º<strong>æ–°</strong>çš„ ServerWebExchange ã€‚ </li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ ç¡¬ç”Ÿç”ŸæŠŠè¿™ä¸ªæ–‡ç« ä¸°å¯Œäº†ä¸‹ã€‚äººç”Ÿå¦‚æˆï¼Œå…¨é å¥—è·¯ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_10/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/</id>
    <published>2020-03-04T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2. Header</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.1 AddRequestHeaderGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.2 RemoveRequestHeaderGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.3 AddResponseHeaderGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.4 RemoveResponseHeaderGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.5 SetResponseHeaderGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.6 RemoveNonProxyHeadersGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">2.7 SecureHeadersGatewayFilterFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">3. Parameter</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">3.1 AddRequestParameterGatewayFilterFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">4. Path</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">4.1 RewritePathGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">4.2 PrefixPathGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">4.3 SetPathGatewayFilterFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">5. Status</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">5.1 SetStatusGatewayFilterFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">6. Redirect</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">6.1 RedirectToGatewayFilterFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">7. Hystrix</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">8. RateLimiter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>GatewayFilterFactory çš„å®ç°ç±»</strong>ã€‚</p><p>GatewayFilterFactory å®ç°ç±»è¾ƒå¤šï¼Œæ ¹æ®ç”¨é€”æ•´ç†å¦‚ä¸‹è„‘å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_05/01.png" alt=""></p><p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹é€å—è§£ææºç å®ç°ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-Header"><a href="#2-Header" class="headerlink" title="2. Header"></a>2. Header</h1><p>æœ¬å°èŠ‚åˆ†äº« Header ç›¸å…³çš„ GatewayFilterFactory å®ç°ç±»ã€‚</p><h2 id="2-1-AddRequestHeaderGatewayFilterFactory"><a href="#2-1-AddRequestHeaderGatewayFilterFactory" class="headerlink" title="2.1 AddRequestHeaderGatewayFilterFactory"></a>2.1 AddRequestHeaderGatewayFilterFactory</h2><ul><li>ç”¨é€” ï¼šæ·»åŠ æŒ‡å®šè¯·æ±‚ Header ä¸ºæŒ‡å®šå€¼ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">add_request_header_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">AddRequestHeader=X-Request-Foo,</span> <span class="string">Bar</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddRequestHeaderGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> Arrays.asList(NAME_KEY, VALUE_KEY);</div><div class="line"> <span class="number">6</span>: &#125;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: String name = args.getString(NAME_KEY);</div><div class="line"><span class="number">11</span>: String value = args.getString(VALUE_KEY);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123; <span class="comment">// GatewayFilter</span></div><div class="line"><span class="number">14</span>: <span class="comment">// åˆ›å»ºæ–°çš„ ServerHttpRequest</span></div><div class="line"><span class="number">15</span>: ServerHttpRequest request = exchange.getRequest().mutate()</div><div class="line"><span class="number">16</span>: .header(name, value)</div><div class="line"><span class="number">17</span>: .build();</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>: <span class="comment">// åˆ›å»ºæ–°çš„ ServerWebExchange ï¼Œæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤</span></div><div class="line"><span class="number">20</span>: <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</div><div class="line"><span class="number">21</span>: &#125;;</div><div class="line"><span class="number">22</span>: &#125;</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tuple å‚æ•° ï¼š<code>name</code> / <code>value</code> ã€‚</li><li>ç¬¬ 14 è‡³ 17 è¡Œ ï¼šåˆ›å»º<strong>æ–°</strong>çš„ ServerHttpRequest ã€‚</li><li>ç¬¬ 19 è‡³ 20 è¡Œ ï¼šåˆ›å»º<strong>æ–°</strong>çš„ ServerWebExchange ï¼Œæäº¤<strong>è¿‡æ»¤å™¨é“¾</strong>ç»§ç»­è¿‡æ»¤ã€‚</li></ul></li></ul><h2 id="2-2-RemoveRequestHeaderGatewayFilterFactory"><a href="#2-2-RemoveRequestHeaderGatewayFilterFactory" class="headerlink" title="2.2 RemoveRequestHeaderGatewayFilterFactory"></a>2.2 RemoveRequestHeaderGatewayFilterFactory</h2><p>ç±»ä¼¼ AddRequestHeaderGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#removerequestheader-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” RemoveRequestHeader GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="2-3-AddResponseHeaderGatewayFilterFactory"><a href="#2-3-AddResponseHeaderGatewayFilterFactory" class="headerlink" title="2.3 AddResponseHeaderGatewayFilterFactory"></a>2.3 AddResponseHeaderGatewayFilterFactory</h2><p>ç±»ä¼¼ AddRequestHeaderGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#addresponseheader-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” AddResponseHeader GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="2-4-RemoveResponseHeaderGatewayFilterFactory"><a href="#2-4-RemoveResponseHeaderGatewayFilterFactory" class="headerlink" title="2.4 RemoveResponseHeaderGatewayFilterFactory"></a>2.4 RemoveResponseHeaderGatewayFilterFactory</h2><p>ç±»ä¼¼ AddRequestHeaderGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#removeresponseheader-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” RemoveResponseHeader GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="2-5-SetResponseHeaderGatewayFilterFactory"><a href="#2-5-SetResponseHeaderGatewayFilterFactory" class="headerlink" title="2.5 SetResponseHeaderGatewayFilterFactory"></a>2.5 SetResponseHeaderGatewayFilterFactory</h2><p>ç±»ä¼¼ AddRequestHeaderGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#removeresponseheader-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” SetStatus GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="2-6-RemoveNonProxyHeadersGatewayFilterFactory"><a href="#2-6-RemoveNonProxyHeadersGatewayFilterFactory" class="headerlink" title="2.6 RemoveNonProxyHeadersGatewayFilterFactory"></a>2.6 RemoveNonProxyHeadersGatewayFilterFactory</h2><ul><li>ç”¨é€” ï¼šç§»é™¤è¯·æ±‚ <strong>Proxy</strong> ç›¸å…³çš„ Header ã€‚é»˜è®¤å€¼ä¸º <code>[ &quot;Connection&quot;, &quot;Keep-Alive&quot;, &quot;Proxy-Authenticate&quot;, &quot;Proxy-Authorization&quot;, &quot;TE&quot;, &quot;Trailer&quot;, &quot;Transfer-Encoding&quot;, &quot;Upgrade&quot; ]</code> ( å‚è€ƒè‡ª ï¼š<a href="https://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14#section-7.1.3" rel="external nofollow noopener noreferrer" target="_blank">https://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14#section-7.1.3</a> ) ï¼Œå¯ä»¥é€šè¿‡ <code>spring.cloud.gateway.filter.remove-non-proxy-headers</code> é…ç½®ã€‚</li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@ConfigurationProperties</span>(<span class="string">"spring.cloud.gateway.filter.remove-non-proxy-headers"</span>)</div><div class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoveNonProxyHeadersGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 5:      * é»˜è®¤</span></div><div class="line"><span class="comment"> 6:      */</span></div><div class="line"> <span class="number">7</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_HEADERS_TO_REMOVE = <span class="keyword">new</span> String[] &#123;<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>,</div><div class="line"> <span class="number">8</span>: <span class="string">"Proxy-Authenticate"</span>, <span class="string">"Proxy-Authorization"</span>, <span class="string">"TE"</span>, <span class="string">"Trailer"</span>, <span class="string">"Transfer-Encoding"</span>, <span class="string">"Upgrade"</span>&#125;;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="keyword">private</span> List&lt;String&gt; headers = Arrays.asList(DEFAULT_HEADERS_TO_REMOVE);</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> headers;</div><div class="line"><span class="number">14</span>: &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeaders</span><span class="params">(List&lt;String&gt; headers)</span> </span>&#123;</div><div class="line"><span class="number">17</span>: <span class="keyword">this</span>.headers = headers;</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">22</span>: <span class="comment">//<span class="doctag">TODO:</span> support filter args</span></div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line"><span class="number">25</span>: <span class="comment">// åˆ›å»ºæ–°çš„ ServerHttpRequest</span></div><div class="line"><span class="number">26</span>: ServerHttpRequest request = exchange.getRequest().mutate()</div><div class="line"><span class="number">27</span>: .headers(httpHeaders -&gt; &#123;</div><div class="line"><span class="number">28</span>: <span class="keyword">for</span> (String header : <span class="keyword">this</span>.headers) &#123;</div><div class="line"><span class="number">29</span>: httpHeaders.remove(header); <span class="comment">// ç§»é™¤</span></div><div class="line"><span class="number">30</span>: &#125;</div><div class="line"><span class="number">31</span>: &#125;)</div><div class="line"><span class="number">32</span>: .build();</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="comment">// åˆ›å»ºæ–°çš„ ServerWebExchange ï¼Œæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤</span></div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</div><div class="line"><span class="number">36</span>: &#125;;</div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>:</div></pre></td></tr></table></figure></li></ul><h2 id="2-7-SecureHeadersGatewayFilterFactory"><a href="#2-7-SecureHeadersGatewayFilterFactory" class="headerlink" title="2.7 SecureHeadersGatewayFilterFactory"></a>2.7 SecureHeadersGatewayFilterFactory</h2><ul><li>ç”¨é€” ï¼šæ·»åŠ å“åº” Secure ç›¸å…³çš„ Header ã€‚é»˜è®¤å€¼åœ¨ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/SecureHeadersProperties.java#L27" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.gateway.filter.factory.SecureHeadersProperties</code></a> ï¼Œå¯ä»¥é€šè¿‡ <code>spring.cloud.gateway.filter.secure-headers</code> é…ç½®ã€‚</li><li>æ¨èæ–‡ç«  ï¼š<ul><li><a href="https://blog.appcanary.com/2017/http-security-headers.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠEverything you need to know about HTTP security headersã€‹</a></li><li><a href="http://blog.jobbole.com/60143/" rel="external nofollow noopener noreferrer" target="_blank">ã€Š4ä¸ªå¸¸ç”¨çš„HTTPå®‰å…¨å¤´éƒ¨ã€‹</a> </li></ul></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecureHeadersGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String X_XSS_PROTECTION_HEADER = <span class="string">"X-Xss-Protection"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STRICT_TRANSPORT_SECURITY_HEADER = <span class="string">"Strict-Transport-Security"</span>;</div><div class="line"> <span class="number">5</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String X_FRAME_OPTIONS_HEADER = <span class="string">"X-Frame-Options"</span>;</div><div class="line"> <span class="number">6</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String X_CONTENT_TYPE_OPTIONS_HEADER = <span class="string">"X-Content-Type-Options"</span>;</div><div class="line"> <span class="number">7</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REFERRER_POLICY_HEADER = <span class="string">"Referrer-Policy"</span>;</div><div class="line"> <span class="number">8</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_SECURITY_POLICY_HEADER = <span class="string">"Content-Security-Policy"</span>;</div><div class="line"> <span class="number">9</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String X_DOWNLOAD_OPTIONS_HEADER = <span class="string">"X-Download-Options"</span>;</div><div class="line"><span class="number">10</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String X_PERMITTED_CROSS_DOMAIN_POLICIES_HEADER = <span class="string">"X-Permitted-Cross-Domain-Policies"</span>;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="keyword">private</span> <span class="keyword">final</span> SecureHeadersProperties properties;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="function"><span class="keyword">public</span> <span class="title">SecureHeadersGatewayFilterFactory</span><span class="params">(SecureHeadersProperties properties)</span> </span>&#123;</div><div class="line"><span class="number">15</span>: <span class="keyword">this</span>.properties = properties;</div><div class="line"><span class="number">16</span>: &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">19</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">20</span>: <span class="comment">//<span class="doctag">TODO:</span> allow args to override properties</span></div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line"><span class="number">23</span>: HttpHeaders headers = exchange.getResponse().getHeaders();</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="comment">//<span class="doctag">TODO:</span> allow header to be disabled</span></div><div class="line"><span class="number">26</span>: headers.add(X_XSS_PROTECTION_HEADER, properties.getXssProtectionHeader());</div><div class="line"><span class="number">27</span>: headers.add(STRICT_TRANSPORT_SECURITY_HEADER, properties.getStrictTransportSecurity());</div><div class="line"><span class="number">28</span>: headers.add(X_FRAME_OPTIONS_HEADER, properties.getFrameOptions());</div><div class="line"><span class="number">29</span>: headers.add(X_CONTENT_TYPE_OPTIONS_HEADER, properties.getContentTypeOptions());</div><div class="line"><span class="number">30</span>: headers.add(REFERRER_POLICY_HEADER, properties.getReferrerPolicy());</div><div class="line"><span class="number">31</span>: headers.add(CONTENT_SECURITY_POLICY_HEADER, properties.getContentSecurityPolicy());</div><div class="line"><span class="number">32</span>: headers.add(X_DOWNLOAD_OPTIONS_HEADER, properties.getDownloadOptions());</div><div class="line"><span class="number">33</span>: headers.add(X_PERMITTED_CROSS_DOMAIN_POLICIES_HEADER, properties.getPermittedCrossDomainPolicies());</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">36</span>: &#125;;</div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 26 è‡³ 33 è¡Œ ï¼šæ·»åŠ å“åº” Secure ç›¸å…³çš„ Header ã€‚ </li></ul></li></ul><h1 id="3-Parameter"><a href="#3-Parameter" class="headerlink" title="3. Parameter"></a>3. Parameter</h1><p>æœ¬å°èŠ‚åˆ†äº« Parameter ç›¸å…³çš„ GatewayFilterFactory å®ç°ç±»ã€‚</p><h2 id="3-1-AddRequestParameterGatewayFilterFactory"><a href="#3-1-AddRequestParameterGatewayFilterFactory" class="headerlink" title="3.1 AddRequestParameterGatewayFilterFactory"></a>3.1 AddRequestParameterGatewayFilterFactory</h2><p>ç±»ä¼¼ AddRequestHeaderGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#addrequestheader-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” AddRequestParameter GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h1 id="4-Path"><a href="#4-Path" class="headerlink" title="4. Path"></a>4. Path</h1><p>æœ¬å°èŠ‚åˆ†äº« Path ç›¸å…³çš„ GatewayFilterFactory å®ç°ç±»ã€‚</p><h2 id="4-1-RewritePathGatewayFilterFactory"><a href="#4-1-RewritePathGatewayFilterFactory" class="headerlink" title="4.1 RewritePathGatewayFilterFactory"></a>4.1 RewritePathGatewayFilterFactory</h2><ul><li>ç”¨é€” ï¼šæ ¹æ®é…ç½®çš„æ­£åˆ™è¡¨è¾¾å¼ <code>regexp</code> ï¼Œä½¿ç”¨é…ç½®çš„ <code>replacement</code> é‡å†™è¯·æ±‚ Path ã€‚ä»åŠŸèƒ½ç›®çš„ä¸Šç±»ä¼¼ <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠModule ngx_http_rewrite_moduleã€‹</a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">rewritepath_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RewritePath=/foo/(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></div></pre></td></tr></table></figure><ul><li>æ³¨æ„ï¼Œ<code>$\</code> ç”¨äºæ›¿ä»£ <code>$</code> ï¼Œé¿å…å’Œ YAML è¯­æ³•å†²çªã€‚</li></ul></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RewritePathGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEXP_KEY = <span class="string">"regexp"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPLACEMENT_KEY = <span class="string">"replacement"</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">return</span> Arrays.asList(REGEXP_KEY, REPLACEMENT_KEY);</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">final</span> String regex = args.getString(REGEXP_KEY);</div><div class="line"><span class="number">14</span>: <span class="comment">// `$\` ç”¨äºæ›¿ä»£ `$` ï¼Œé¿å…å’Œ YAML è¯­æ³•å†²çªã€‚</span></div><div class="line"><span class="number">15</span>: String replacement = args.getString(REPLACEMENT_KEY).replace(<span class="string">"$\\"</span>, <span class="string">"$"</span>);</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line"><span class="number">18</span>: ServerHttpRequest req = exchange.getRequest();</div><div class="line"><span class="number">19</span>: <span class="comment">// æ·»åŠ  åŸå§‹è¯·æ±‚URI åˆ° GATEWAY_ORIGINAL_REQUEST_URL_ATTR</span></div><div class="line"><span class="number">20</span>: addOriginalRequestUrl(exchange, req.getURI());</div><div class="line"><span class="number">21</span>: <span class="comment">// é‡å†™ Path</span></div><div class="line"><span class="number">22</span>: String path = req.getURI().getPath();</div><div class="line"><span class="number">23</span>: String newPath = path.replaceAll(regex, replacement);</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="comment">// åˆ›å»ºæ–°çš„ ServerHttpRequest</span></div><div class="line"><span class="number">26</span>: ServerHttpRequest request = req.mutate()</div><div class="line"><span class="number">27</span>: .path(newPath) <span class="comment">// è®¾ç½® Path</span></div><div class="line"><span class="number">28</span>: .build();</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">// æ·»åŠ  è¯·æ±‚URI åˆ° GATEWAY_REQUEST_URL_ATTR</span></div><div class="line"><span class="number">31</span>: exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, request.getURI());</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: <span class="comment">// åˆ›å»ºæ–°çš„ ServerWebExchange ï¼Œæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤</span></div><div class="line"><span class="number">34</span>: <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</div><div class="line"><span class="number">35</span>: &#125;;</div><div class="line"><span class="number">36</span>: &#125;</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tuple å‚æ•° ï¼š<code>regexp</code> / <code>replacement</code> ã€‚</li><li>ç¬¬ 15 è¡Œ ï¼š<code>$\</code> ç”¨äºæ›¿ä»£ <code>$</code> ï¼Œé¿å…å’Œ YAML è¯­æ³•å†²çªã€‚</li><li><p>ç¬¬ 20 è¡Œ ï¼šè°ƒç”¨ <code>ServerWebExchangeUtils#addOriginalRequestUrl(...)</code> æ·»åŠ åŸå§‹è¯·æ±‚ URI åˆ° <code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addOriginalRequestUrl</span><span class="params">(ServerWebExchange exchange, URI url)</span> </span>&#123;</div><div class="line">exchange.getAttributes().computeIfAbsent(GATEWAY_ORIGINAL_REQUEST_URL_ATTR, s -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;()); <span class="comment">// æ•°ç»„ï¼Œè€ƒè™‘å¤šæ¬¡é‡å†™</span></div><div class="line">    LinkedHashSet&lt;URI&gt; uris = exchange.getRequiredAttribute(GATEWAY_ORIGINAL_REQUEST_URL_ATTR);</div><div class="line">    uris.add(url);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä¸ºä»€ä¹ˆä½¿ç”¨ LinkedHashSet ï¼Ÿå› ä¸ºå¯ä»¥ä½¿ç”¨ RewritePathGatewayFilterFactory / PrefixPathGatewayFilterFactory å¤šæ¬¡é‡å†™ã€‚</li></ul></li><li><p>ç¬¬ 21 è‡³ 23 è¡Œ ï¼š<strong>é‡å†™</strong>è¯·æ±‚ Path ã€‚</p></li><li>ç¬¬ 26 è‡³ 28 è¡Œ ï¼šåˆ›å»º<strong>æ–°</strong>çš„ ServerHttpRequest ã€‚</li><li>ç¬¬ 31 è¡Œ ï¼šæ·»åŠ è¯·æ±‚ URI åˆ° <code>GATEWAY_REQUEST_URL_ATTR</code> ã€‚</li><li>ç¬¬ 34 è¡Œ ï¼šåˆ›å»º<strong>æ–°</strong>çš„ ServerWebExchange ï¼Œæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</li></ul></li></ul><h2 id="4-2-PrefixPathGatewayFilterFactory"><a href="#4-2-PrefixPathGatewayFilterFactory" class="headerlink" title="4.2 PrefixPathGatewayFilterFactory"></a>4.2 PrefixPathGatewayFilterFactory</h2><p>ç±»ä¼¼ RewritePathGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#setpath-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” PrefixPath GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="4-3-SetPathGatewayFilterFactory"><a href="#4-3-SetPathGatewayFilterFactory" class="headerlink" title="4.3 SetPathGatewayFilterFactory"></a>4.3 SetPathGatewayFilterFactory</h2><p>ç±»ä¼¼ RewritePathGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#prefixpath-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” SetPath GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h1 id="5-Status"><a href="#5-Status" class="headerlink" title="5. Status"></a>5. Status</h1><p>æœ¬å°èŠ‚åˆ†äº« Status ç›¸å…³çš„ GatewayFilterFactory å®ç°ç±»ã€‚</p><h2 id="5-1-SetStatusGatewayFilterFactory"><a href="#5-1-SetStatusGatewayFilterFactory" class="headerlink" title="5.1 SetStatusGatewayFilterFactory"></a>5.1 SetStatusGatewayFilterFactory</h2><p>ç±»ä¼¼ RedirectToGatewayFilterFactory ï¼Œä¸é‡å¤åˆ†äº«ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#setstatus-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gateway â€”â€” SetStatus GatewayFilter Factoryã€‹</a> æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h1 id="6-Redirect"><a href="#6-Redirect" class="headerlink" title="6. Redirect"></a>6. Redirect</h1><p>æœ¬å°èŠ‚åˆ†äº« Redirect ç›¸å…³çš„ GatewayFilterFactory å®ç°ç±»ã€‚</p><h2 id="6-1-RedirectToGatewayFilterFactory"><a href="#6-1-RedirectToGatewayFilterFactory" class="headerlink" title="6.1 RedirectToGatewayFilterFactory"></a>6.1 RedirectToGatewayFilterFactory</h2><ul><li>ç”¨é€” ï¼šå°†å“åº”é‡å®šå‘åˆ°æŒ‡å®š URL ï¼Œå¹¶è®¾ç½®å“åº”çŠ¶æ€ç ä¸ºæŒ‡å®š Status ã€‚<strong>æ³¨æ„</strong>ï¼ŒStatus å¿…é¡»ä¸º 3XX é‡å®šå‘çŠ¶æ€ç ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">prefixpath_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RedirectTo=302,</span> <span class="attr">http://www.iocoder.cn</span></div></pre></td></tr></table></figure></li></ul><ul><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedirectToGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STATUS_KEY = <span class="string">"status"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_KEY = <span class="string">"url"</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">return</span> Arrays.asList(STATUS_KEY, URL_KEY);</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">13</span>: String statusString = args.getRawString(STATUS_KEY);</div><div class="line"><span class="number">14</span>: String urlString = args.getString(URL_KEY);</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="comment">// è§£æ status ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ˜¯ 3XX é‡å®šå‘çŠ¶æ€</span></div><div class="line"><span class="number">17</span>: <span class="keyword">final</span> HttpStatus httpStatus = parse(statusString);</div><div class="line"><span class="number">18</span>: Assert.isTrue(httpStatus.is3xxRedirection(), <span class="string">"status must be a 3xx code, but was "</span> + statusString);</div><div class="line"><span class="number">19</span>: <span class="comment">// åˆ›å»º URL</span></div><div class="line"><span class="number">20</span>: <span class="keyword">final</span> URL url;</div><div class="line"><span class="number">21</span>: <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>: url = URI.create(urlString).toURL();</div><div class="line"><span class="number">23</span>: &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line"><span class="number">24</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid url "</span> + urlString, e);</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="keyword">return</span> (exchange, chain) -&gt;</div><div class="line"><span class="number">28</span>: chain.filter(exchange).then(Mono.defer(() -&gt; &#123; <span class="comment">// After Filter</span></div><div class="line"><span class="number">29</span>: <span class="keyword">if</span> (!exchange.getResponse().isCommitted()) &#123;</div><div class="line"><span class="number">30</span>:     <span class="comment">// è®¾ç½®å“åº” Status</span></div><div class="line"><span class="number">31</span>: setResponseStatus(exchange, httpStatus);</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: <span class="comment">// è®¾ç½®å“åº” Header</span></div><div class="line"><span class="number">34</span>: <span class="keyword">final</span> ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">35</span>: response.getHeaders().set(HttpHeaders.LOCATION, url.toString());</div><div class="line"><span class="number">36</span>: <span class="keyword">return</span> response.setComplete();</div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">39</span>: &#125;));</div><div class="line"><span class="number">40</span>: &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 16 è‡³ 18 è¡Œ ï¼šè§£æé…ç½®çš„ <code>statusString</code> ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ˜¯ 3XX é‡å®šå‘çŠ¶æ€ç ã€‚</li><li>ç¬¬ 19 è‡³ 25 è¡Œ ï¼šè§£æé…ç½®çš„ <code>urlString</code> ï¼Œåˆ›å»º URL ã€‚</li><li>ç¬¬ 28 è¡Œ ï¼šè°ƒç”¨ <code>#then(Mono)</code> æ–¹æ³•ï¼Œå®ç° <strong>After Filter</strong> é€»è¾‘ã€‚è¿™é‡Œå’Œ AddRequestHeaderGatewayFilterFactory å®ç°çš„ <strong>Before Filter</strong> ã€æ–¹å¼ã€‘<strong>ä¸åŒ</strong>ã€‚</li><li>ç¬¬ 29 è‡³ 37 è¡Œ ï¼š<strong>è‹¥å“åº”æœªæäº¤</strong>ï¼Œè®¾ç½®å“åº”çš„çŠ¶æ€ç ã€å“åº”çš„ Header ( <code>Location</code> ) ã€‚</li><li>ç¬¬ 38 è¡Œ ï¼š<strong>è®¾ç½®å“åº”å·²æäº¤</strong>ã€‚</li></ul></li></ul><h1 id="7-Hystrix"><a href="#7-Hystrix" class="headerlink" title="7. Hystrix"></a>7. Hystrix</h1><p>ç†”æ–­ç›¸å…³ GatewayFilterï¼Œæˆ‘ä»¬åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.9) ä¹‹ HystrixGatewayFilterFactory ç†”æ–­ã€‹</a> è¯¦ç»†è§£æã€‚</p><h1 id="8-RateLimiter"><a href="#8-RateLimiter" class="headerlink" title="8. RateLimiter"></a>8. RateLimiter</h1><p>é™æµç›¸å…³ GatewayFilterï¼Œæˆ‘ä»¬åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.10) ä¹‹ RequestRateLimiterGatewayFilterFactory è¯·æ±‚é™æµã€‹</a> è¯¦ç»†è§£æã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ©ï¼Œç¨æ˜¾å•°å—¦çš„ä¸€ç¯‡æ–‡ç« ï¼Œåé¢ä¼šæ¯”è¾ƒç²¾å½©ï¼Œä½ æ‡‚çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_05/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/&lt;
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆ</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/</id>
    <published>2020-02-29T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">2. GatewyFilter</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">2.1 GatewayFilterFactory å†…éƒ¨ç±»</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">2.2 OrderedGatewayFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">2.3 GatewayFilterAdapter</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">3. GlobalFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">4. GatewayFilterChain</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦å¯¹ <strong>è¿‡æ»¤å™¨ GatewayFilter åšæ•´ä½“çš„è®¤è¯†</strong>ã€‚</p><p>è¿‡æ»¤å™¨æ•´ä½“ç±»å›¾å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_01/01.png" alt=""></p><p>æ˜¯ä¸æ˜¯æœ‰ç‚¹ç–‘æƒ‘ GlobalFilter ä¸ GatewayFilter çš„å…³ç³» ï¼Ÿä¸”è§æœ¬æ–‡åˆ†æ™“ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-GatewyFilter"><a href="#2-GatewyFilter" class="headerlink" title="2. GatewyFilter"></a>2. GatewyFilter</h1><p><code>org.springframework.cloud.gateway.filter.GatewayFilter</code> ï¼Œç½‘å…³è¿‡æ»¤å™¨<strong>æ¥å£</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GatewayFilter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Process the Web request and (optionally) delegate to the next</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»æ¥å£æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå’Œ <a href="https://tomcat.apache.org/tomcat-5.5-doc/servletapi/javax/servlet/Filter.html" rel="external nofollow noopener noreferrer" target="_blank"><code>javax.servlet.Filter</code></a> ç±»ä¼¼ã€‚</li></ul><p>GatewayFilter æœ‰ä¸‰ç§ç±»å‹çš„å­ç±»å®ç°ï¼Œæˆ‘ä»¬ä¸‹é¢æ¯èŠ‚ä»‹ç»ä¸€ç§ã€‚</p><h2 id="2-1-GatewayFilterFactory-å†…éƒ¨ç±»"><a href="#2-1-GatewayFilterFactory-å†…éƒ¨ç±»" class="headerlink" title="2.1 GatewayFilterFactory å†…éƒ¨ç±»"></a>2.1 GatewayFilterFactory å†…éƒ¨ç±»</h2><p>åœ¨æ¯ä¸ª GatewayFilterFactory å®ç°ç±»çš„ <code>#apply(Tuple)</code> æ–¹æ³•é‡Œï¼Œéƒ½å£°æ˜äº†ä¸€ä¸ªå®ç° GatewayFilter çš„<strong>å†…éƒ¨ç±»</strong>ï¼Œä»¥ AddRequestHeaderGatewayFilterFactory çš„ä»£ç ä¸¾ä¾‹å­ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddRequestHeaderGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> Arrays.asList(NAME_KEY, VALUE_KEY);</div><div class="line"> <span class="number">6</span>: &#125;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: String name = args.getString(NAME_KEY);</div><div class="line"><span class="number">11</span>: String value = args.getString(VALUE_KEY);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123; <span class="comment">// GatewayFilter  </span></div><div class="line"><span class="number">14</span>: ServerHttpRequest request = exchange.getRequest().mutate()</div><div class="line"><span class="number">15</span>: .header(name, value)</div><div class="line"><span class="number">16</span>: .build();</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</div><div class="line"><span class="number">19</span>: &#125;;</div><div class="line"><span class="number">20</span>: &#125;</div><div class="line"><span class="number">21</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 13 è‡³ 19 è¡Œ ï¼šå®šä¹‰äº†ä¸€ä¸ª GatewayFilter <strong>å†…éƒ¨å®ç°ç±»</strong>ã€‚</li></ul><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹</a> ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è§£ææ¯ä¸ª GatewayFilterFactory å®šä¹‰çš„GatewayFilter <strong>å†…éƒ¨å®ç°ç±»</strong>ã€‚</p><h2 id="2-2-OrderedGatewayFilter"><a href="#2-2-OrderedGatewayFilter" class="headerlink" title="2.2 OrderedGatewayFilter"></a>2.2 OrderedGatewayFilter</h2><p><code>org.springframework.cloud.gateway.filter.OrderedGatewayFilter</code> ï¼Œ<strong>æœ‰åºçš„</strong>ç½‘å…³è¿‡æ»¤å™¨<strong>å®ç°ç±»</strong>ã€‚åœ¨ FilterChain é‡Œï¼Œè¿‡æ»¤å™¨æ•°ç»„é¦–å…ˆä¼šæŒ‰ç…§ <code>order</code> å‡åºæ’åºï¼ŒæŒ‰ç…§<strong>é¡ºåº</strong>è¿‡æ»¤è¯·æ±‚ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderedGatewayFilter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> GatewayFilter delegate;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> order;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">OrderedGatewayFilter</span><span class="params">(GatewayFilter delegate, <span class="keyword">int</span> order)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.delegate = delegate;</div><div class="line"><span class="keyword">this</span>.order = order;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.delegate.filter(exchange, chain);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.order;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>delegate</code> å±æ€§ï¼Œå§”æ‰˜çš„ GatewayFilter ã€‚</li><li><code>order</code> å±æ€§ï¼Œé¡ºåºã€‚</li><li><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>delegate</code> è¿‡æ»¤è¯·æ±‚ã€‚</li></ul><h2 id="2-3-GatewayFilterAdapter"><a href="#2-3-GatewayFilterAdapter" class="headerlink" title="2.3 GatewayFilterAdapter"></a>2.3 GatewayFilterAdapter</h2><p><code>org.springframework.cloud.gateway.handler.FilteringWebHandler.GatewayFilterAdapter</code> ï¼Œç½‘å…³è¿‡æ»¤å™¨é€‚é…å™¨ã€‚åœ¨ GatewayFilterChain ä½¿ç”¨ GatewayFilter è¿‡æ»¤è¯·æ±‚ï¼Œæ‰€ä»¥é€šè¿‡ GatewayFilterAdapter å°† GlobalFilter é€‚é…æˆ GatewayFilter ã€‚GatewayFilterAdapter ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterAdapter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GlobalFilter delegate;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GatewayFilterAdapter</span><span class="params">(GlobalFilter delegate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delegate = delegate;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.filter(exchange, chain);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>delegate</code> å±æ€§ï¼Œå§”æ‰˜çš„ GlobalFilter ã€‚</li><li><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>delegate</code> è¿‡æ»¤è¯·æ±‚ã€‚</li></ul><hr><p>åœ¨ FilteringWebHandler åˆå§‹åŒ–æ—¶ï¼Œå°† GlobalFilter å§”æ‰˜æˆ GatewayFilterAdapter ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteringWebHandler</span> <span class="keyword">implements</span> <span class="title">WebHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * å…¨å±€è¿‡æ»¤å™¨</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; globalFilters;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">FilteringWebHandler</span><span class="params">(List&lt;GlobalFilter&gt; globalFilters)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">this</span>.globalFilters = loadFilters(globalFilters);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;GatewayFilter&gt; <span class="title">loadFilters</span><span class="params">(List&lt;GlobalFilter&gt; filters)</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> filters.stream()</div><div class="line"><span class="number">14</span>: .map(filter -&gt; &#123;</div><div class="line"><span class="number">15</span>: GatewayFilterAdapter gatewayFilter = <span class="keyword">new</span> GatewayFilterAdapter(filter);</div><div class="line"><span class="number">16</span>: <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> Ordered) &#123;</div><div class="line"><span class="number">17</span>: <span class="keyword">int</span> order = ((Ordered) filter).getOrder();</div><div class="line"><span class="number">18</span>: <span class="keyword">return</span> <span class="keyword">new</span> OrderedGatewayFilter(gatewayFilter, order);</div><div class="line"><span class="number">19</span>: &#125;</div><div class="line"><span class="number">20</span>: <span class="keyword">return</span> gatewayFilter;</div><div class="line"><span class="number">21</span>: &#125;).collect(Collectors.toList());</div><div class="line"><span class="number">22</span>: &#125;</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 16 è‡³ 19 è¡Œ ï¼šå½“ GlobalFilter å­ç±»å®ç°äº† <code>org.springframework.core.Ordered</code> æ¥å£ï¼Œåœ¨å§”æ‰˜ä¸€å±‚ OrderedGatewayFilter ã€‚è¿™æ · <code>AnnotationAwareOrderComparator#sort(List)</code> æ–¹æ³•å¥½æ’åºã€‚</li><li>ç¬¬ 20 è¡Œ ï¼šå½“ GlobalFilter å­ç±»<strong>æ²¡æœ‰</strong>å®ç°äº† <code>org.springframework.core.Ordered</code> æ¥å£ï¼Œåœ¨ <code>AnnotationAwareOrderComparator#sort(List)</code> æ’åºæ—¶ï¼Œé¡ºåºå€¼ä¸º <code>Integer.MAX_VALUE</code> ã€‚</li><li>ç›®å‰ GlobalFilter éƒ½å®ç°äº† <code>org.springframework.core.Ordered</code> æ¥å£ã€‚</li></ul><h1 id="3-GlobalFilter"><a href="#3-GlobalFilter" class="headerlink" title="3. GlobalFilter"></a>3. GlobalFilter</h1><p><code>org.springframework.cloud.gateway.filter.GlobalFilter</code> ï¼Œå…¨å±€è¿‡æ»¤å™¨<strong>æ¥å£</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GlobalFilter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Process the Web request and (optionally) delegate to the next</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>GlobalFilter å’Œ GatewayFilter çš„ <code>#filter(ServerWebExchange, GatewayFilterChain)</code> <strong>æ–¹æ³•ç­¾åä¸€è‡´</strong>ã€‚å®˜æ–¹è¯´ï¼Œæœªæ¥çš„ç‰ˆæœ¬å°†ä½œå‡ºä¸€äº›è°ƒæ•´ã€‚</p><blockquote><p>FROM <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#path-route-predicate-factory#user-content-global-filters" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gatewayã€‹</a><br>This interface and usage are subject to change in future milestones</p></blockquote></li><li><p>GlobalFilter ä¼šä½œç”¨åˆ°<strong>æ‰€æœ‰çš„</strong> Route ä¸Šã€‚</p></li></ul><p>GlobalFilter å®ç°ç±»å¦‚ä¸‹ç±»å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_01/02.png" alt=""></p><ul><li><p>RoutingFilter</p><ul><li>NettyRoutingFilter</li><li>WebClientHttpRoutingFilter</li><li>WebsocketRoutingFilter</li><li>ForwardRoutingFilter</li></ul></li><li><p>æˆå¯¹çš„ Filter</p><ul><li>NettyRoutingFilter / NettyRoutingFilter</li><li>WebClientHttpRoutingFilter / WebClientWriteResponseFilter</li></ul></li></ul><p>æ¢³ç† GlobalFilter çš„é¡ºåºå¦‚ä¸‹ ï¼š</p><table><thead><tr><th>GlobalFilter</th><th>é¡ºåº</th><th>æ–‡ç« </th></tr></thead><tbody><tr><td>NettyWriteResponseFilter</td><td>-1</td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.7) ä¹‹ NettyRoutingFilterã€‹</a></td></tr><tr><td>WebClientWriteResponseFilter</td><td>-1</td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilterã€‹</a></td></tr><tr><td>RouteToRequestUrlFilter</td><td>10000</td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-route-to-request/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.3) ä¹‹ RouteToRequestUrlFilterã€‹</a></td></tr><tr><td>LoadBalancerClientFilter</td><td>10100</td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.4) ä¹‹ LoadBalancerClientFilter è´Ÿè½½å‡è¡¡ã€‹</a></td></tr><tr><td>ForwardRoutingFilter</td><td><code>Integer.MAX_VALUE</code></td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.5) ä¹‹ ForwardRoutingFilterã€‹</a></td></tr><tr><td>NettyRoutingFilter</td><td><code>Integer.MAX_VALUE</code></td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.7) ä¹‹ NettyRoutingFilterã€‹</a></td></tr><tr><td>WebClientHttpRoutingFilter</td><td><code>Integer.MAX_VALUE</code></td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilterã€‹</a></td></tr><tr><td>WebsocketRoutingFilter</td><td><code>Integer.MAX_VALUE</code></td><td><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.6) ä¹‹ WebSocketRoutingFilterã€‹</a></td></tr></tbody></table><p>TODO ã€3030ã€‘ </p><h1 id="4-GatewayFilterChain"><a href="#4-GatewayFilterChain" class="headerlink" title="4. GatewayFilterChain"></a>4. GatewayFilterChain</h1><p><code>org.springframework.cloud.gateway.filter.GatewayFilterChain</code> ï¼Œç½‘å…³è¿‡æ»¤å™¨é“¾<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GatewayFilterChain</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Delegate to the next &#123;<span class="doctag">@code</span> WebFilter&#125; in the chain.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request handling is complete</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»æ¥å£æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå’Œ <a href="https://tomcat.apache.org/tomcat-8.0-doc/servletapi/javax/servlet/FilterChain.html" rel="external nofollow noopener noreferrer" target="_blank"><code>javax.servlet.FilterChain</code></a> ç±»ä¼¼ã€‚</li></ul><hr><p><code>org.springframework.cloud.gateway.handler.FilteringWebHandler.GatewayFilterAdapter</code> ï¼Œç½‘å…³è¿‡æ»¤å™¨<strong>é“¾é»˜è®¤å®ç°ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultGatewayFilterChain</span> <span class="keyword">implements</span> <span class="title">GatewayFilterChain</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; filters;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultGatewayFilterChain</span><span class="params">(List&lt;GatewayFilter&gt; filters)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.filters = filters;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.index &lt; filters.size()) &#123;</div><div class="line">GatewayFilter filter = filters.get(<span class="keyword">this</span>.index++);</div><div class="line"><span class="keyword">return</span> filter.filter(exchange, <span class="keyword">this</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">return</span> Mono.empty(); <span class="comment">// complete</span></div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å•¦å•¦å•¦ï¼Œç»ˆäºåˆ°è¿‡æ»¤å™¨äº†ã€‚å¼€æ£®ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_01/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/&lt;/a&gt; 
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.3) ä¹‹ FilteringWebHandler åˆ›å»ºè¿‡æ»¤å™¨é“¾</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/</id>
    <published>2020-02-24T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/">http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/">2. FilteringWebHandler</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>FilteringWebHandler</strong>ã€‚</p><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.2) ä¹‹ RoutePredicateHandlerMapping è·¯ç”±åŒ¹é… ã€‹ã€Œ2.1 SimpleHandlerAdapterã€</a> é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ° <code>SimpleHandlerAdapter#handle(ServerWebExchange, Object)</code> è°ƒç”¨ <code>FilteringWebHandler#handle(ServerWebExchange)</code> æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚</p><p>FilteringWebHandler é€šè¿‡åˆ›å»ºè¯·æ±‚å¯¹åº”çš„ Route å¯¹åº”çš„ GatewayFilterChain è¿›è¡Œå¤„ç†ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_20/01.jpeg" alt=""></p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-FilteringWebHandler"><a href="#2-FilteringWebHandler" class="headerlink" title="2. FilteringWebHandler"></a>2. FilteringWebHandler</h1><p><code>org.springframework.cloud.gateway.handler.FilteringWebHandler</code> ï¼Œ<code>#handle(ServerWebExchange)</code> ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteringWebHandler</span> <span class="keyword">implements</span> <span class="title">WebHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:  * å…¨å±€è¿‡æ»¤å™¨</span></div><div class="line"><span class="comment"> 5: */</span></div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; globalFilters;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:     <span class="comment">// è·å¾— Route</span></div><div class="line"><span class="number">11</span>: Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);</div><div class="line"><span class="number">12</span>: <span class="comment">// è·å¾— GatewayFilter</span></div><div class="line"><span class="number">13</span>: List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters();</div><div class="line"><span class="number">14</span>: List&lt;GatewayFilter&gt; combined = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.globalFilters);</div><div class="line"><span class="number">15</span>: combined.addAll(gatewayFilters);</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// æ’åº</span></div><div class="line"><span class="number">18</span>: <span class="comment">//<span class="doctag">TODO:</span> needed or cached?</span></div><div class="line"><span class="number">19</span>: AnnotationAwareOrderComparator.sort(combined);</div><div class="line"><span class="number">20</span>: logger.debug(<span class="string">"Sorted gatewayFilterFactories: "</span>+ combined);</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="comment">// åˆ›å»º DefaultGatewayFilterChain</span></div><div class="line"><span class="number">23</span>: <span class="keyword">return</span> <span class="keyword">new</span> DefaultGatewayFilterChain(combined).filter(exchange);</div><div class="line"><span class="number">24</span>: &#125;</div><div class="line"><span class="number">25</span>: &#125;</div></pre></td></tr></table></figure><ul><li>æœ¬æ–¹æ³•æ¶‰åŠåˆ°çš„è¿‡æ»¤å™¨ GlobalFilter / GatewayFilter / GatewayFilterAdapter / OrderedGatewayFilter ç±»ï¼Œæˆ‘ä»¬åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹</a> è¯¦ç»†è§£æã€‚</li><li>æœ¬æ–¹æ³•æ¶‰åŠåˆ°çš„è¿‡æ»¤å™¨é“¾ GatewayFilterChain / DefaultGatewayFilterChain ç±»ï¼Œæˆ‘ä»¬åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 11 è¡Œ ï¼šä» <code>GATEWAY_ROUTE_ATTR</code> è·å¾— è¯·æ±‚å¯¹åº”çš„ Route ã€‚</li><li>ç¬¬ 13 è‡³ 15 è¡Œ ï¼šè·å¾— GatewayFilter æ•°ç»„ï¼ŒåŒ…å« <code>route.filters</code> å’Œ <code>globalFilters</code> ã€‚</li><li>ç¬¬ 19 è¡Œ ï¼šæ’åºè·å¾—çš„ GatewayFilter æ•°ç»„ã€‚</li><li>ç¬¬ 23 è¡Œ ï¼šä½¿ç”¨è·å¾—çš„ GatewayFilter æ•°ç»„åˆ›å»º DefaultGatewayFilterChain ï¼Œ<strong>è¿‡æ»¤å¤„ç†è¯·æ±‚</strong>ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å“ˆå“ˆå“ˆï¼Œæˆ‘æ°´æ›´æˆ‘å¿«ä¹ã€‚ä¸»è¦è¿˜æ˜¯è€ƒè™‘æ–‡ç« å°½é‡è§£è€¦ï¼Œæ‰€ä»¥è¿™ç¯‡å†…å®¹åæ°´( å¾ˆæ°´ )ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_25/01.jpeg" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/h
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.2) ä¹‹ RoutePredicateHandlerMapping è·¯ç”±åŒ¹é…</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/</id>
    <published>2020-02-19T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/">http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/">2. DispatcherHandler</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/">2.1 SimpleHandlerAdapter</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/">3. RoutePredicateHandlerMapping</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RoutePredicateHandlerMapping è·¯ç”±åŒ¹é…</strong>ã€‚</p><p>æˆ‘ä»¬å…ˆä¸€èµ·æ¥çœ‹çœ‹ï¼Œä¸€ä¸ªè¯·æ±‚æ˜¯æ€ä¹ˆè¢« Spring Cloud Gateway å¤„ç†çš„ï¼Œå¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_20/01.jpeg" alt=""></p><ol><li><code>org.springframework.web.reactive.DispatcherHandler</code> ï¼šæ¥æ”¶åˆ°è¯·æ±‚ï¼ŒåŒ¹é… HandlerMapping ï¼Œæ­¤å¤„ä¼šåŒ¹é…åˆ° RoutePredicateHandlerMapping ã€‚</li><li><code>org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</code> ï¼šæ¥æ”¶åˆ°è¯·æ±‚ï¼ŒåŒ¹é… Route ã€‚</li><li><code>org.springframework.cloud.gateway.handler.FilteringWebHandler</code> ï¼šè·å¾— Route çš„ GatewayFilter æ•°ç»„ï¼Œåˆ›å»º GatewayFilterChain å¤„ç†è¯·æ±‚ã€‚</li></ol><p>ç¬¬ä¸€ã€äºŒæ­¥ï¼Œåœ¨æœ¬æ–‡åˆ†äº«ã€‚ç¬¬ä¸‰æ­¥ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-filtering-web-handler/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.3) ä¹‹ FilteringWebHandler åˆ›å»ºè¿‡æ»¤å™¨é“¾ ã€‹</a> åˆ†äº«ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-DispatcherHandler"><a href="#2-DispatcherHandler" class="headerlink" title="2. DispatcherHandler"></a>2. DispatcherHandler</h1><p><code>org.springframework.web.reactive.DispatcherHandler</code> ï¼Œè¯·æ±‚åˆ†å‘å¤„ç†å™¨ï¼ŒSpring WebFlux çš„è®¿é—®å…¥å£ã€‚å¯èƒ½å¤§å¤šæ•°äººå¯¹è¿™ä¸ªç±»éƒ½æ¯”è¾ƒé™Œç”Ÿï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»–åœ¨ Spring MVC çš„å…„å¼Ÿ <a href="http://jinnianshilongnian.iteye.com/blog/1602617" rel="external nofollow noopener noreferrer" target="_blank">DispatcherServlet</a> æ˜¯ä¸æ˜¯å°±æœ‰ç‚¹ç†Ÿæ‚‰çš„æ„Ÿè§‰ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹ <code>DispatcherHandler#handle(ServerWebExchange)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherHandler</span> <span class="keyword">implements</span> <span class="title">WebHandler</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="meta">@Nullable</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> List&lt;HandlerMapping&gt; handlerMappings;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Nullable</span></div><div class="line"> <span class="number">7</span>: <span class="keyword">private</span> List&lt;HandlerAdapter&gt; handlerAdapters;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line"><span class="number">11</span>: <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">12</span>: ServerHttpRequest request = exchange.getRequest();</div><div class="line"><span class="number">13</span>: logger.debug(<span class="string">"Processing "</span> + request.getMethodValue() + <span class="string">" request for ["</span> + request.getURI() + <span class="string">"]"</span>);</div><div class="line"><span class="number">14</span>: &#125;</div><div class="line"><span class="number">15</span>: <span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> Mono.error(HANDLER_NOT_FOUND_EXCEPTION);</div><div class="line"><span class="number">17</span>: &#125;</div><div class="line"><span class="number">18</span>: <span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.handlerMappings)</div><div class="line"><span class="number">19</span>: .concatMap(mapping -&gt; mapping.getHandler(exchange))</div><div class="line"><span class="number">20</span>: .next()</div><div class="line"><span class="number">21</span>: .switchIfEmpty(Mono.error(HANDLER_NOT_FOUND_EXCEPTION))</div><div class="line"><span class="number">22</span>: .flatMap(handler -&gt; invokeHandler(exchange, handler))</div><div class="line"><span class="number">23</span>: .flatMap(result -&gt; handleResult(exchange, result));</div><div class="line"><span class="number">24</span>: &#125;</div><div class="line"><span class="number">25</span>: &#125;</div></pre></td></tr></table></figure><ul><li><p>ç¬¬ 18 è‡³ 20 è¡Œ ï¼š<strong>é¡ºåº</strong>ä½¿ç”¨ <code>handlerMappings</code> è·å¾—å¯¹åº”çš„ WebHandler ã€‚</p><ul><li>ä½¿ç”¨ <code>#concatMap(Function)</code> æ“ä½œç¬¦çš„åŸå› æ˜¯è€ƒè™‘ <code>handlerMappings</code> çš„é¡ºåºæ€§ï¼Œè¯¦è§ <a href="http://blog.csdn.net/johnny901114/article/details/51533282" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠRxJavaï¼ˆå››ï¼‰ concatMapæ“ä½œç¬¦ç”¨æ³•è¯¦è§£ã€‹</a> ã€‚</li><li>ä½¿ç”¨å®˜æ–¹ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ï¼Œæ­¤å¤„æ‰“æ–­ç‚¹ï¼Œ<code>handlerMappings</code> å˜é‡å€¼å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_20/02.png" alt=""></li><li>åœ¨ã€<strong>ç¬¬ 19 è¡Œ</strong>ã€‘ï¼Œè°ƒç”¨ <code>HandlerMapping#getHandler(ServerWebExchange)</code> è·å¾— Handler ã€‚åœ¨æ•´ç†ï¼ŒRoutePredicateHandlerMapping åŒ¹é…è¯·æ±‚å¯¹åº”çš„ Route ï¼Œå¹¶è¿”å› FilteringWebHandler ã€‚æ­¤æ—¶ï¼Œ<strong>FilteringWebHandler è¿˜å¹¶æœªè·å¾— Route çš„ GatewayFilter ï¼Œåˆ›å»º GatewayFilterChain å¤„ç†è¯·æ±‚</strong>ã€‚å’Œæœ¬æ–‡çš„ç¬¬ä¸€å¼ å›¾æœ‰ç‚¹å‡ºå…¥ï¼Œè¯¥å›¾ä¸»è¦æè¿°æ•´ä¸ªè¯·æ±‚ç»å†çš„æµç¨‹ã€‚</li><li>ç¬¬ 21 è¡Œ ï¼šå¦‚æœåŒ¹é…ä¸åˆ° WebHandler ï¼Œè¿”å› <code>HANDLER_NOT_FOUND_EXCEPTION</code> ã€‚</li><li><p>ç¬¬ 22 è¡Œ ï¼šè°ƒç”¨ <code>#handle()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Handler ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Mono&lt;HandlerResult&gt; <span class="title">invokeHandler</span><span class="params">(ServerWebExchange exchange, Object handler)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="keyword">if</span> (<span class="keyword">this</span>.handlerAdapters != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">3</span>: <span class="keyword">for</span> (HandlerAdapter handlerAdapter : <span class="keyword">this</span>.handlerAdapters) &#123;</div><div class="line"> <span class="number">4</span>: <span class="keyword">if</span> (handlerAdapter.supports(handler)) &#123;</div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> handlerAdapter.handle(exchange, handler);</div><div class="line"> <span class="number">6</span>: &#125;</div><div class="line"> <span class="number">7</span>: &#125;</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"No HandlerAdapter: "</span> + handler));</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨å®˜æ–¹ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ï¼Œæ­¤å¤„æ‰“æ–­ç‚¹ï¼Œ<code>handlerMappings</code> å˜é‡å€¼å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_20/03.png" alt=""></li><li>ç¬¬ 2 è‡³ 8 è¡Œ ï¼š<strong>é¡ºåº</strong>åŒ¹é… HandlerAdapter ï¼Œé€šè¿‡è°ƒç”¨ <code>HandlerAdapter#handle(ServerWebExchange, Object)</code> æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œ Handler ã€‚åœ¨æ­¤å¤„ï¼Œæˆ‘ä»¬ä¼šåŒ¹é…åˆ° SimpleHandlerAdapter ã€‚</li><li>ç¬¬ 9 è¡Œ ï¼šåŒ¹é…ä¸åˆ° HandlerAdapter ï¼Œè¿”å› IllegalStateException ã€‚</li></ul></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#handleResult()</code> æ–¹æ³•ï¼Œå¤„ç†ç»“æœã€‚SimpleHandlerAdapter è¿”å›çš„æ˜¯ <code>Mono.empty()</code> ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘è¯¥æ–¹æ³•ã€‚<code>#handleResult()</code> ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">handleResult</span><span class="params">(ServerWebExchange exchange, HandlerResult result)</span> </span>&#123;</div><div class="line"><span class="number">2</span>: <span class="keyword">return</span> getResultHandler(result).handleResult(exchange, result)</div><div class="line"><span class="number">3</span>: .onErrorResume(ex -&gt; result.applyExceptionHandler(ex).flatMap(exceptionResult -&gt;</div><div class="line"><span class="number">4</span>: getResultHandler(exceptionResult).handleResult(exchange, exceptionResult)));</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></li></ul></li></ul><h2 id="2-1-SimpleHandlerAdapter"><a href="#2-1-SimpleHandlerAdapter" class="headerlink" title="2.1 SimpleHandlerAdapter"></a>2.1 SimpleHandlerAdapter</h2><p><code>org.springframework.web.reactive.result.SimpleHandlerAdapter</code> ï¼ŒåŸºæ‰§è¡Œ WebHandler çš„å¤„ç†å™¨é€‚é…å™¨ã€‚</p><p><code>#supports(Object)</code> <strong>æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean supports(Object handler) &#123;</div><div class="line">return WebHandler.class.isAssignableFrom(handler.getClass());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ”¯æŒ WebHandler ã€‚</li></ul><hr><p><code>#handle(ServerWebExchange, Object)</code> <strong>æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;HandlerResult&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange, Object handler)</span> </span>&#123;</div><div class="line"><span class="number">3</span>: WebHandler webHandler = (WebHandler) handler;</div><div class="line"><span class="number">4</span>: Mono&lt;Void&gt; mono = webHandler.handle(exchange);</div><div class="line"><span class="number">5</span>: <span class="keyword">return</span> mono.then(Mono.empty());</div><div class="line"><span class="number">6</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 3 è‡³ 4 è¡Œ ï¼šè°ƒç”¨ <code>WebHandler#handle(ServerWebExchange)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå¤„ç†å™¨ã€‚ä¾‹å¦‚ï¼Œ<strong>WebHandler ä¸º FilteringWebHandler æ—¶ï¼Œè·å¾— Route çš„ GatewayFilter æ•°ç»„ï¼Œåˆ›å»º GatewayFilterChain å¤„ç†è¯·æ±‚</strong>ã€‚</li><li>ç¬¬ 5 è¡Œ ï¼šåœ¨ WebHandler <strong>æ‰§è¡Œå®Œå</strong> ( <code>#then(Mongo)</code> )ï¼Œç„¶åè¿”å› <code>Mono.empty()</code> ã€‚</li></ul><h1 id="3-RoutePredicateHandlerMapping"><a href="#3-RoutePredicateHandlerMapping" class="headerlink" title="3. RoutePredicateHandlerMapping"></a>3. RoutePredicateHandlerMapping</h1><p><code>org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</code> ï¼ŒåŒ¹é… Route ï¼Œå¹¶è¿”å›å¤„ç† Route çš„ FilteringWebHandler ã€‚</p><p>RoutePredicateHandlerMapping <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutePredicateHandlerMapping</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMapping</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> FilteringWebHandler webHandler;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> RouteLocator routeLocator;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">RoutePredicateHandlerMapping</span><span class="params">(FilteringWebHandler webHandler, RouteLocator routeLocator)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.webHandler = webHandler;</div><div class="line"><span class="keyword">this</span>.routeLocator = routeLocator;</div><div class="line"></div><div class="line">setOrder(<span class="number">1</span>); <span class="comment">// RequestMappingHandlerMapping ä¹‹å</span></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#setOrder(1)</code> çš„åŸå› ï¼ŒSpring Cloud Gateway çš„ GatewayWebfluxEndpoint æä¾› HTTP API ï¼Œä¸éœ€è¦ç»è¿‡ç½‘å…³ï¼Œå®ƒé€šè¿‡ RequestMappingHandlerMapping è¿›è¡Œè¯·æ±‚åŒ¹é…å¤„ç†ã€‚RequestMappingHandlerMapping çš„ <code>order = 0</code> ï¼Œéœ€è¦æ’åœ¨ RoutePredicateHandlerMapping å‰é¢ã€‚æ‰€æœ‰ï¼ŒRoutePredicateHandlerMapping è®¾ç½® <code>order = 1</code> ã€‚</li></ul><hr><p><code>#getHandlerInternal()</code> æ–¹æ³•ï¼Œåœ¨ <code>DispatcherHandler#handle(ServerWebExchange)</code> æ–¹æ³•çš„ã€<strong>ç¬¬ 19 è¡Œ</strong>ã€‘è¢«è°ƒç”¨ï¼ŒåŒ¹é… Route ï¼Œå¹¶è¿”å›å¤„ç† Route çš„ FilteringWebHandler ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> Mono&lt;?&gt; getHandlerInternal(ServerWebExchange exchange) &#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// è®¾ç½® GATEWAY_HANDLER_MAPPER_ATTR ä¸º RoutePredicateHandlerMapping</span></div><div class="line"> <span class="number">4</span>: exchange.getAttributes().put(GATEWAY_HANDLER_MAPPER_ATTR, getClass().getSimpleName());</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="keyword">return</span> lookupRoute(exchange) <span class="comment">// åŒ¹é… Route</span></div><div class="line"> <span class="number">7</span>: <span class="comment">// .log("route-predicate-handler-mapping", Level.FINER) //name this</span></div><div class="line"> <span class="number">8</span>: .flatMap((Function&lt;Route, Mono&lt;?&gt;&gt;) r -&gt; &#123; <span class="comment">// è¿”å› FilteringWebHandler</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">10</span>: logger.debug(<span class="string">"Mapping ["</span> + getExchangeDesc(exchange) + <span class="string">"] to "</span> + r);</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: <span class="comment">// è®¾ç½® GATEWAY_ROUTE_ATTR ä¸º åŒ¹é…çš„ Route</span></div><div class="line"><span class="number">14</span>: exchange.getAttributes().put(GATEWAY_ROUTE_ATTR, r);</div><div class="line"><span class="number">15</span>: <span class="comment">// è¿”å›</span></div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> Mono.just(webHandler);</div><div class="line"><span class="number">17</span>: &#125;).switchIfEmpty(Mono.empty().then(Mono.fromRunnable(() -&gt; &#123; <span class="comment">// åŒ¹é…ä¸åˆ° Route</span></div><div class="line"><span class="number">18</span>: <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line"><span class="number">19</span>: logger.trace(<span class="string">"No RouteDefinition found for ["</span> + getExchangeDesc(exchange) + <span class="string">"]"</span>);</div><div class="line"><span class="number">20</span>: &#125;</div><div class="line"><span class="number">21</span>: &#125;)));</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è¡Œ ï¼šè®¾ç½® <code>GATEWAY_HANDLER_MAPPER_ATTR</code> ä¸º RoutePredicateHandlerMapping ã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>#lookupRoute(ServerWebExchange)</code> æ–¹æ³•ï¼ŒåŒ¹é… Route ã€‚</li><li>ç¬¬ 8 è‡³ 16 è¡Œ ï¼šè¿”å› Route çš„å¤„ç†å™¨ FilteringWebHandler ã€‚<ul><li>ç¬¬ 14 è¡Œ ï¼šè®¾ç½® <code>GATEWAY_ROUTE_ATTR</code> ä¸º<strong>åŒ¹é…</strong>çš„ Route ã€‚</li><li>ç¬¬ 16 è¡Œ ï¼šè¿”å› FilteringWebHandlerã€‚</li></ul></li><li>ç¬¬ 17 è‡³ 21 è¡Œ ï¼š<strong>åŒ¹é…ä¸åˆ°</strong> Route ï¼Œè¿”å› <code>Mono.empty()</code> ï¼Œå³ä¸è¿”å›å¤„ç†å™¨ã€‚<strong>è¿™æ ·ä¼šä¸ä¼šæœ‰é—®é¢˜</strong>ï¼Ÿä¸ä¼šï¼Œåœ¨ <code>DispatcherHandler#handle(ServerWebExchange)</code> æ–¹æ³•çš„ã€<strong>ç¬¬ 21 è¡Œ</strong>ã€‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“æ²¡æœ‰åˆé€‚çš„ Handler ï¼Œè¿”å› <code>Mono.error(HANDLER_NOT_FOUND_EXCEPTION)</code> ã€‚</li></ul><hr><p><code>#lookupRoute(ServerWebExchange)</code> æ–¹æ³•ï¼Œ<strong>é¡ºåº</strong>åŒ¹é… Route ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> Mono&lt;Route&gt; <span class="title">lookupRoute</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="keyword">return</span> <span class="keyword">this</span>.routeLocator.getRoutes()</div><div class="line"> <span class="number">3</span>: .filter(route -&gt; route.getPredicate().test(exchange))</div><div class="line"> <span class="number">4</span>: .next()</div><div class="line"> <span class="number">5</span>: <span class="comment">//<span class="doctag">TODO:</span> error handling</span></div><div class="line"> <span class="number">6</span>: .map(route -&gt; &#123;</div><div class="line"> <span class="number">7</span>: <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">8</span>: logger.debug(<span class="string">"RouteDefinition matched: "</span> + route.getId());</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: validateRoute(route, exchange);</div><div class="line"><span class="number">11</span>: <span class="keyword">return</span> route;</div><div class="line"><span class="number">12</span>: &#125;);</div><div class="line"><span class="number">13</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 2 è‡³ 4 è¡Œ ï¼šè°ƒç”¨ <code>RouteLocator#getRoutes()</code> æ–¹æ³•ï¼Œè·å¾—å…¨éƒ¨ Route ï¼Œå¹¶è°ƒç”¨ <code>Predicate#test(ServerWebExchange)</code> æ–¹æ³•ï¼Œ<strong>é¡ºåº</strong>åŒ¹é…<strong>ä¸€ä¸ª</strong> Routeã€‚</li><li>ç¬¬ 5 è¡Œ ï¼šæœªæ¥ä¼šå¢åŠ åŒ¹é…è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸çš„å¤„ç†ã€‚ç›®å‰ï¼Œä»»ä½•ä¸€ä¸ª <code>Predicate#test(ServerWebExchange)</code> çš„æ–¹æ³•è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œéƒ½ä¼šå¯¼è‡´åŒ¹é…ä¸åˆ° Route ã€‚<strong>ä¸€å®šè¦æ³¨æ„</strong>ã€‚</li><li>ç¬¬ 6 è‡³ 11 è¡Œ ï¼šè°ƒç”¨ <code>#validateRoute(Route, ServerWebExchange)</code> æ–¹æ³•ï¼Œæ ¡éªŒ Route çš„æœ‰æ•ˆæ€§ã€‚ç›®å‰è¯¥æ–¹æ³•æ˜¯ä¸ª<strong>ç©ºæ–¹æ³•</strong>ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿ RoutePredicateHandlerMapping è¿›è¡Œè¦†ç›–é‡å†™ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ä¸€ä¸å°å¿ƒç®€å•å†™äº†ä¸‹ WebFlux çš„ DispatcherHandler çš„æºç è§£æï¼Œå˜¿å˜¿å˜¿ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_20/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-handler-mapping/&quot;&gt;http://www.iocoder.cn/Spring-Cloud
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.1) ä¹‹ RoutePredicateFactory  è·¯ç”±è°“è¯­å·¥å‚</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/</id>
    <published>2020-02-14T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">2. RoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">3. AfterRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">4. BeforeRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">5. BetweenRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">6. CookieRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">7. HeaderRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">8. HostRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">9. MethodRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">10. PathRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">11. QueryRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">12. RemoteAddrRoutePredicateFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RoutePredicateFactory è·¯ç”±è°“è¯­å·¥å‚</strong>ã€‚</p><p>RoutePredicateFactory æ¶‰åŠåˆ°çš„ç±»åœ¨ <code>org.springframework.cloud.gateway.handler.predicate</code> åŒ…ä¸‹ï¼Œå¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_15/01.png" alt=""></p><p>Spring Cloud Gateway åˆ›å»º Route å¯¹è±¡æ—¶ï¼Œä½¿ç”¨ RoutePredicateFactory åˆ›å»º Predicate å¯¹è±¡ã€‚Predicate å¯¹è±¡å¯ä»¥èµ‹å€¼ç»™ <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Route.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>Route.predicate</code></a> å±æ€§ï¼Œç”¨äºåŒ¹é…<strong>è¯·æ±‚</strong>å¯¹åº”çš„ Route ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-RoutePredicateFactory"><a href="#2-RoutePredicateFactory" class="headerlink" title="2. RoutePredicateFactory"></a>2. RoutePredicateFactory</h1><p><code>org.springframework.cloud.gateway.handler.predicate.RoutePredicateFactory</code> ï¼Œ è·¯ç”±è°“è¯­å·¥å‚<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">ArgumentHints</span> </span>&#123;</div><div class="line"></div><div class="line">    String PATTERN_KEY = <span class="string">"pattern"</span>;</div><div class="line"></div><div class="line"><span class="function">Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">default</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> NameUtils.normalizePredicateName(getClass());</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#name()</code> <strong>é»˜è®¤</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>NameUtils#normalizePredicateName(Class)</code> æ–¹æ³•ï¼Œè·å¾— RoutePredicateFactory çš„åå­—ã€‚è¯¥æ–¹æ³•æˆªå–ç±»å<strong>å‰åŠæ®µ</strong>ï¼Œä¾‹å¦‚ QueryRoutePredicateFactory çš„ç»“æœä¸º <code>Query</code> ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/support/NameUtils.java#L33" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚</li><li><code>#apply()</code> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ›å»º Predicate ã€‚</li><li>ç»§æ‰¿ <code>org.springframework.cloud.gateway.support.ArgumentHints</code> <strong>æ¥å£</strong> ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.2ï¼‰ä¹‹ RouteDefinitionRouteLocator è·¯ç”±é…ç½®ã€‹ã€Œ2.4 è·å¾— Tupleã€</a> æœ‰ä½¿ç”¨åˆ°å®ƒçš„ä»£ç ã€‚</li></ul><hr><p>RoutePredicateFactory <strong>å®ç°ç±»</strong>å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_15/02.png" alt=""></p><p>ä¸‹é¢æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ª RoutePredicateFactory å®ç°ç±»ç†è§£ã€‚ä»£ç æ¯”è¾ƒå¤šï¼Œå®é™…ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p><p>å¦å¤–ï¼Œ<code>org.springframework.cloud.gateway.handler.predicate.RoutePredicates</code> ï¼ŒRoutePredicates <strong>å·¥å‚</strong>ï¼Œå…¶è°ƒç”¨ RoutePredicateFactory æ¥å£çš„<strong>å®ç°ç±»</strong>ï¼Œåˆ›å»ºå„ç§ Predicate ã€‚</p><h1 id="3-AfterRoutePredicateFactory"><a href="#3-AfterRoutePredicateFactory" class="headerlink" title="3. AfterRoutePredicateFactory"></a>3. AfterRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚<strong>æ—¶é—´</strong>æ»¡è¶³åœ¨é…ç½®æ—¶é—´<strong>ä¹‹å</strong>ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">after_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span></div></pre></td></tr></table></figure></li><li><p>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L40" rel="external nofollow noopener noreferrer" target="_blank">#after(ZonedDateTime)</a> ã€‚</p></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATETIME_KEY = <span class="string">"datetime"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: <span class="keyword">return</span> Collections.singletonList(DATETIME_KEY);</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">12</span>: Object value = args.getValue(DATETIME_KEY);</div><div class="line"><span class="number">13</span>: <span class="keyword">final</span> ZonedDateTime dateTime = BetweenRoutePredicateFactory.getZonedDateTime(value);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">16</span>: <span class="keyword">final</span> ZonedDateTime now = ZonedDateTime.now();</div><div class="line"><span class="number">17</span>: <span class="keyword">return</span> now.isAfter(dateTime);</div><div class="line"><span class="number">18</span>: &#125;;</div><div class="line"><span class="number">19</span>: &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>datetime</code> ã€‚</li><li>ç¬¬ 13 è¡Œ ï¼šè°ƒç”¨ <code>BetweenRoutePredicateFactory#getZonedDateTime(value)</code> æ–¹æ³•ï¼Œè§£æé…ç½®çš„æ—¶é—´å€¼ï¼Œåœ¨ <a href="#">ã€Œ5. BetweenRoutePredicateFactoryã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h1 id="4-BeforeRoutePredicateFactory"><a href="#4-BeforeRoutePredicateFactory" class="headerlink" title="4. BeforeRoutePredicateFactory"></a>4. BeforeRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚<strong>æ—¶é—´</strong>æ»¡è¶³åœ¨é…ç½®æ—¶é—´<strong>ä¹‹å‰</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L44" rel="external nofollow noopener noreferrer" target="_blank">#before(ZonedDateTime)</a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">before_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeforeRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATETIME_KEY = <span class="string">"datetime"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: <span class="keyword">return</span> Collections.singletonList(DATETIME_KEY);</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">12</span>: Object value = args.getValue(DATETIME_KEY);</div><div class="line"><span class="number">13</span>: <span class="keyword">final</span> ZonedDateTime dateTime = BetweenRoutePredicateFactory.getZonedDateTime(value);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">16</span>: <span class="keyword">final</span> ZonedDateTime now = ZonedDateTime.now();</div><div class="line"><span class="number">17</span>: <span class="keyword">return</span> now.isBefore(dateTime);</div><div class="line"><span class="number">18</span>: &#125;;</div><div class="line"><span class="number">19</span>: &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>datetime</code> ã€‚</li><li>ç¬¬ 13 è¡Œ ï¼šè°ƒç”¨ <code>BetweenRoutePredicateFactory#getZonedDateTime(value)</code> æ–¹æ³•ï¼Œè§£æé…ç½®çš„æ—¶é—´å€¼ï¼Œåœ¨ <a href="#">ã€Œ5. BetweenRoutePredicateFactoryã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h1 id="5-BetweenRoutePredicateFactory"><a href="#5-BetweenRoutePredicateFactory" class="headerlink" title="5. BetweenRoutePredicateFactory"></a>5. BetweenRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚<strong>æ—¶é—´</strong>æ»¡è¶³åœ¨é…ç½®æ—¶é—´<strong>ä¹‹é—´</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>#between(ZonedDateTime, ZonedDateTime)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">between_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Betweeen=2017-01-20T17:42:47.789-07:00[America/Denver],</span> <span class="number">2017</span><span class="bullet">-01</span><span class="bullet">-21</span><span class="attr">T17:42:47.789-07:00[America/Denver]</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BetweenRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATETIME1_KEY = <span class="string">"datetime1"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATETIME2_KEY = <span class="string">"datetime2"</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="comment">//<span class="doctag">TODO:</span> is ZonedDateTime the right thing to use?</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">final</span> ZonedDateTime dateTime1 = getZonedDateTime(args.getValue(DATETIME1_KEY));</div><div class="line"><span class="number">10</span>: <span class="keyword">final</span> ZonedDateTime dateTime2 = getZonedDateTime(args.getValue(DATETIME2_KEY));</div><div class="line"><span class="number">11</span>: Assert.isTrue(dateTime1.isBefore(dateTime2), args.getValue(DATETIME1_KEY) +</div><div class="line"><span class="number">12</span>: <span class="string">" must be before "</span> + args.getValue(DATETIME2_KEY));</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">15</span>: <span class="keyword">final</span> ZonedDateTime now = ZonedDateTime.now();</div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> now.isAfter(dateTime1) &amp;&amp; now.isBefore(dateTime2);</div><div class="line"><span class="number">17</span>: &#125;;</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZonedDateTime <span class="title">getZonedDateTime</span><span class="params">(Object value)</span> </span>&#123;</div><div class="line"><span class="number">21</span>: ZonedDateTime dateTime;</div><div class="line"><span class="number">22</span>: <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ZonedDateTime) &#123;</div><div class="line"><span class="number">23</span>: dateTime = ZonedDateTime.class.cast(value);</div><div class="line"><span class="number">24</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">25</span>: dateTime = parseZonedDateTime(value.toString());</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: <span class="keyword">return</span> dateTime;</div><div class="line"><span class="number">28</span>: &#125;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZonedDateTime <span class="title">parseZonedDateTime</span><span class="params">(String dateString)</span> </span>&#123;</div><div class="line"><span class="number">31</span>: ZonedDateTime dateTime;</div><div class="line"><span class="number">32</span>: <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">33</span>: <span class="comment">// æ•°å­—</span></div><div class="line"><span class="number">34</span>: <span class="keyword">long</span> epoch = Long.parseLong(dateString);</div><div class="line"><span class="number">35</span>: dateTime = Instant.ofEpochMilli(epoch).atOffset(ZoneOffset.ofTotalSeconds(<span class="number">0</span>))</div><div class="line"><span class="number">36</span>: .toZonedDateTime();</div><div class="line"><span class="number">37</span>: &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line"><span class="number">38</span>: <span class="comment">// å­—ç¬¦ä¸²</span></div><div class="line"><span class="number">39</span>: <span class="comment">// try ZonedDateTime instead</span></div><div class="line"><span class="number">40</span>: dateTime = ZonedDateTime.parse(dateString);</div><div class="line"><span class="number">41</span>: &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>: <span class="keyword">return</span> dateTime;</div><div class="line"><span class="number">44</span>: &#125;</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>datetime1</code> / <code>datetime2</code> ã€‚</li><li>ç¬¬ 20 è‡³ 44 è¡Œ ï¼šè§£æé…ç½®çš„æ—¶é—´å€¼ ã€‚<ul><li>ç¬¬ 22 è‡³ 23 è¡Œ ï¼šå½“å€¼ç±»å‹ä¸º <strong>ZonedDateTime</strong> ã€‚ä¸»è¦ä½¿ç”¨ Java / Kotlin é…ç½® Route æ—¶ï¼Œä¾‹å¦‚ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>RoutePredicates#between(ZonedDateTime, ZonedDateTime)</code></a> ã€‚ </li><li>ç¬¬ 33 è‡³ 36 è¡Œ ï¼šå½“å€¼ç±»å‹ä¸º <strong>Long</strong> ã€‚ä¾‹å¦‚é…ç½®æ–‡ä»¶ <code>1511795602765</code>ã€‚</li><li>å½“ 38 è‡³ 41 è¡Œ ï¼šå½“å€¼ç±»å‹ä¸º <strong>String</strong> ã€‚ä¾‹å¦‚é…ç½®æ–‡ä»¶é‡Œ <code>2017-01-20T17:42:47.789-07:00[America/Denver]</code> ã€‚</li></ul></li></ul></li></ul><h1 id="6-CookieRoutePredicateFactory"><a href="#6-CookieRoutePredicateFactory" class="headerlink" title="6. CookieRoutePredicateFactory"></a>6. CookieRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚<strong>æŒ‡å®š Cookie</strong> æ­£åˆ™åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>#cookie(Stringï¼Œ String)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">cookie_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Cookie=chocolate,</span> <span class="string">ch.p</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CookieRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_KEY = <span class="string">"name"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEXP_KEY = <span class="string">"regexp"</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">return</span> Arrays.asList(NAME_KEY, REGEXP_KEY);</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">13</span>: String name = args.getString(NAME_KEY);</div><div class="line"><span class="number">14</span>: String regexp = args.getString(REGEXP_KEY);</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">17</span>: List&lt;HttpCookie&gt; cookies = exchange.getRequest().getCookies().get(name);</div><div class="line"><span class="number">18</span>: <span class="keyword">for</span> (HttpCookie cookie : cookies) &#123;</div><div class="line"><span class="number">19</span>: <span class="comment">// æ­£åˆ™åŒ¹é…</span></div><div class="line"><span class="number">20</span>: <span class="keyword">if</span> (cookie.getValue().matches(regexp)) &#123;</div><div class="line"><span class="number">21</span>: <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">22</span>: &#125;</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">25</span>: &#125;;</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>name</code> / <code>regexp</code> ã€‚</li><li>ç¬¬ 20 è¡Œ ï¼šæŒ‡å®š Cookie æ­£åˆ™åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li></ul></li></ul><h1 id="7-HeaderRoutePredicateFactory"><a href="#7-HeaderRoutePredicateFactory" class="headerlink" title="7. HeaderRoutePredicateFactory"></a>7. HeaderRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚<strong>æŒ‡å®š Cookie</strong> æ­£åˆ™åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>#header(Stringï¼Œ String)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">header_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_KEY = <span class="string">"header"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEXP_KEY = <span class="string">"regexp"</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">return</span> Arrays.asList(HEADER_KEY, REGEXP_KEY);</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">13</span>: String header = args.getString(HEADER_KEY);</div><div class="line"><span class="number">14</span>: String regexp = args.getString(REGEXP_KEY);</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">17</span>: List&lt;String&gt; values = exchange.getRequest().getHeaders().get(header);</div><div class="line"><span class="number">18</span>: <span class="keyword">for</span> (String value : values) &#123;</div><div class="line"><span class="number">19</span>: <span class="comment">// æ­£åˆ™åŒ¹é…</span></div><div class="line"><span class="number">20</span>: <span class="keyword">if</span> (value.matches(regexp)) &#123;</div><div class="line"><span class="number">21</span>: <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">22</span>: &#125;</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">25</span>: &#125;;</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>header</code> / <code>regexp</code> ã€‚</li><li>ç¬¬ 20 è¡Œ ï¼šæŒ‡å®š Header æ­£åˆ™åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li></ul></li></ul><h1 id="8-HostRoutePredicateFactory"><a href="#8-HostRoutePredicateFactory" class="headerlink" title="8. HostRoutePredicateFactory"></a>8. HostRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚ <strong>Host</strong> åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L63" rel="external nofollow noopener noreferrer" target="_blank"><code>#host(String)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">host_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Host=**.somehost.org</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> PathMatcher pathMatcher = <span class="keyword">new</span> AntPathMatcher(<span class="string">"."</span>);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPathMatcher</span><span class="params">(PathMatcher pathMatcher)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>: <span class="keyword">this</span>.pathMatcher = pathMatcher;</div><div class="line"> <span class="number">7</span>: &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">11</span>: <span class="keyword">return</span> Collections.singletonList(PATTERN_KEY);</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">16</span>: String pattern = args.getString(PATTERN_KEY);</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">19</span>: String host = exchange.getRequest().getHeaders().getFirst(<span class="string">"Host"</span>);</div><div class="line"><span class="number">20</span>: <span class="comment">// åŒ¹é…</span></div><div class="line"><span class="number">21</span>: <span class="keyword">return</span> <span class="keyword">this</span>.pathMatcher.match(pattern, host);</div><div class="line"><span class="number">22</span>: &#125;;</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>pattern</code> ã€‚</li><li><code>pathMatcher</code> å±æ€§ï¼Œè·¯å¾„åŒ¹é…å™¨ï¼Œé»˜è®¤ä½¿ç”¨ <code>org.springframework.util.AntPathMatcher</code> ã€‚é€šè¿‡ <code>#setPathMatcher(PathMatcher)</code> æ–¹æ³•ï¼Œå¯ä»¥é‡æ–°è®¾ç½®ã€‚</li><li>ç¬¬ 21 è¡Œ ï¼šè¯·æ±‚<strong>è·¯å¾„</strong> åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li></ul></li></ul><h1 id="9-MethodRoutePredicateFactory"><a href="#9-MethodRoutePredicateFactory" class="headerlink" title="9. MethodRoutePredicateFactory"></a>9. MethodRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚ <strong>Method</strong> åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L67" rel="external nofollow noopener noreferrer" target="_blank"><code>#method(String)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">method_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Method=GET</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_KEY = <span class="string">"method"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: <span class="keyword">return</span> Arrays.asList(METHOD_KEY);</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">12</span>: String method = args.getString(METHOD_KEY);</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">14</span>: HttpMethod requestMethod = exchange.getRequest().getMethod();</div><div class="line"><span class="number">15</span>: <span class="comment">// æ­£åˆ™åŒ¹é…</span></div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> requestMethod.matches(method);</div><div class="line"><span class="number">17</span>: &#125;;</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>method</code> ã€‚</li><li>ç¬¬ 16 è¡Œ ï¼šè¯·æ±‚ <strong>Method</strong> åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li></ul></li></ul><h1 id="10-PathRoutePredicateFactory"><a href="#10-PathRoutePredicateFactory" class="headerlink" title="10. PathRoutePredicateFactory"></a>10. PathRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚ <strong>Path</strong> åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>#path(String, String)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">host_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/&#123;segment&#125;</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> PathPatternParser pathPatternParser = <span class="keyword">new</span> PathPatternParser();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPathPatternParser</span><span class="params">(PathPatternParser pathPatternParser)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>: <span class="keyword">this</span>.pathPatternParser = pathPatternParser;</div><div class="line"> <span class="number">7</span>: &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">11</span>: <span class="keyword">return</span> Collections.singletonList(PATTERN_KEY);</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     <span class="comment">// è§£æ Path ï¼Œåˆ›å»ºå¯¹åº”çš„ PathPattern</span></div><div class="line"><span class="number">17</span>: String unparsedPattern = args.getString(PATTERN_KEY);</div><div class="line"><span class="number">18</span>: PathPattern pattern;</div><div class="line"><span class="number">19</span>: <span class="keyword">synchronized</span> (<span class="keyword">this</span>.pathPatternParser) &#123;</div><div class="line"><span class="number">20</span>: pattern = <span class="keyword">this</span>.pathPatternParser.parse(unparsedPattern);</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">24</span>: PathContainer path = parsePath(exchange.getRequest().getURI().getPath());</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>: <span class="comment">// åŒ¹é…</span></div><div class="line"><span class="number">27</span>: <span class="keyword">boolean</span> match = pattern.matches(path);</div><div class="line"><span class="number">28</span>: traceMatch(<span class="string">"Pattern"</span>, pattern.getPatternString(), path, match);</div><div class="line"><span class="number">29</span>: <span class="keyword">if</span> (match) &#123;</div><div class="line"><span class="number">30</span>: <span class="comment">// è§£æ è·¯å¾„å‚æ•°ï¼Œä¾‹å¦‚ path=/foo/123 &lt;=&gt; /foo/&#123;segment&#125;</span></div><div class="line"><span class="number">31</span>: PathMatchInfo uriTemplateVariables = pattern.matchAndExtract(path);</div><div class="line"><span class="number">32</span>: exchange.getAttributes().put(URI_TEMPLATE_VARIABLES_ATTRIBUTE, uriTemplateVariables);</div><div class="line"><span class="number">33</span>: <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">36</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>: &#125;;</div><div class="line"><span class="number">39</span>: &#125;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>pattern</code> ã€‚</li><li><code>pathPatternParser</code> å±æ€§ï¼Œè·¯å¾„æ¨¡å¼è§£æå™¨ã€‚</li><li>ç¬¬ 17 è‡³ 21 è¡Œ ï¼šè§£æ<strong>é…ç½®</strong>çš„ Path ï¼Œåˆ›å»ºå¯¹åº”çš„ PathPattern ã€‚è€ƒè™‘åˆ°è§£æè¿‡ç¨‹ä¸­çš„<strong>çº¿ç¨‹å®‰å…¨</strong>ï¼Œæ­¤å¤„ä½¿ç”¨ <code>synchronized</code> ä¿®é¥°ç¬¦ï¼Œè¯¦è§ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/util/pattern/PathPatternParser.java#L99" rel="external nofollow noopener noreferrer" target="_blank"><code>PathPatternParser#parse(String)</code></a> æ–¹æ³•çš„æ³¨é‡Šã€‚</li><li>ç¬¬ 24 è‡³ 27 è¡Œ ï¼šè§£æ<strong>è¯·æ±‚</strong>çš„ Path ï¼ŒåŒ¹é…<strong>é…ç½®</strong>çš„ Path ã€‚</li><li><p>ç¬¬ 30 è‡³ 32 è¡Œ ï¼šè§£æ<strong>è·¯å¾„å‚æ•°</strong>ï¼Œè®¾ç½®åˆ° <code>ServerWebExchange.attributes</code> å±æ€§ä¸­ï¼Œæä¾›ç»™åç»­çš„ GatewayFilter ä½¿ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“é…ç½®çš„ Path ä¸º <code>/foo/{segment}</code> ï¼Œè¯·æ±‚çš„ Path ä¸º <code>/foo/123</code> ï¼Œåœ¨æ­¤å¤„æ‰“æ–­ç‚¹ï¼Œç»“æœå¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_15/03.png" alt=""></p><blockquote><p>FROM <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#path-route-predicate-factory" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Gatewayã€‹</a><br>This predicate extracts the URI template variables (like <code>segment</code> defined in the example above) as a map of names and values and places it in the <code>ServerWebExchange.getAttributes()</code> with a key defined in <code>PathRoutePredicate.URL_PREDICATE_VARS_ATTR</code>. Those values are then available for use by <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/docs/src/main/asciidoc/spring-cloud-gateway.adoc#setpath-gatewayfilter-factory" rel="external nofollow noopener noreferrer" target="_blank">GatewayFilter Factories</a></p></blockquote></li></ul></li></ul><h1 id="11-QueryRoutePredicateFactory"><a href="#11-QueryRoutePredicateFactory" class="headerlink" title="11. QueryRoutePredicateFactory"></a>11. QueryRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚ <strong>QueryParam</strong> åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L75" rel="external nofollow noopener noreferrer" target="_blank"><code>#query(String, String)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">query_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Query=baz</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Query=foo,</span> <span class="string">ba.</span></div></pre></td></tr></table></figure></li><li><p>ä»£ç  ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PARAM_KEY = <span class="string">"param"</span>;</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEXP_KEY = <span class="string">"regexp"</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">return</span> Arrays.asList(PARAM_KEY, REGEXP_KEY);</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validateArgs</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">14</span>: &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">18</span>: validateMin(<span class="number">1</span>, args);</div><div class="line"><span class="number">19</span>: String param = args.getString(PARAM_KEY);</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">22</span>:     <span class="comment">// åŒ…å« å‚æ•°</span></div><div class="line"><span class="number">23</span>: <span class="keyword">if</span> (!args.hasFieldName(REGEXP_KEY)) &#123;</div><div class="line"><span class="number">24</span>: <span class="comment">// check existence of header</span></div><div class="line"><span class="number">25</span>: <span class="keyword">return</span> exchange.getRequest().getQueryParams().containsKey(param);</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: <span class="comment">// æ­£åˆ™åŒ¹é… å‚æ•°</span></div><div class="line"><span class="number">29</span>: String regexp = args.getString(REGEXP_KEY);</div><div class="line"><span class="number">30</span>: List&lt;String&gt; values = exchange.getRequest().getQueryParams().get(param);</div><div class="line"><span class="number">31</span>: <span class="keyword">for</span> (String value : values) &#123;</div><div class="line"><span class="number">32</span>: <span class="keyword">if</span> (value.matches(regexp)) &#123;</div><div class="line"><span class="number">33</span>: <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: &#125;</div><div class="line"><span class="number">36</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">37</span>: &#125;;</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼š<code>param</code> ( å¿…å¡« ) / <code>regexp</code> ( é€‰å¡« ) ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šè°ƒç”¨ <code>#validateMin(...)</code> æ–¹æ³•ï¼Œæ ¡éªŒå‚æ•°æ•°é‡è‡³å°‘ä¸º <code>1</code> ï¼Œå³ <code>param</code> éç©º ã€‚</li><li>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šå½“ <code>regexp</code> ä¸ºç©ºæ—¶ï¼Œæ ¡éªŒ <code>param</code> å¯¹åº”çš„ <code>QueryParam</code> å­˜åœ¨ã€‚</li><li>ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå½“ <code>regexp</code> éç©ºæ—¶ï¼Œè¯·æ±‚ <code>param</code> å¯¹åº”çš„ <strong>QueryParam</strong> æ­£åˆ™åŒ¹é…<strong>æŒ‡å®šå€¼</strong>ã€‚<ul><li>å½“ <code>QueryParams</code> ä¸ºç©ºæ—¶ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆ <strong>BUG</strong> ã€‚</li></ul></li></ul></li></ul><h1 id="12-RemoteAddrRoutePredicateFactory"><a href="#12-RemoteAddrRoutePredicateFactory" class="headerlink" title="12. RemoteAddrRoutePredicateFactory"></a>12. RemoteAddrRoutePredicateFactory</h1><ul><li>Route åŒ¹é… ï¼šè¯·æ±‚<strong>æ¥æº IP</strong> åœ¨<strong>æŒ‡å®šèŒƒå›´å†…</strong>ã€‚</li><li>RoutePredicates æ–¹æ³• ï¼š<a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#remoteAddr(String...)</code></a> ã€‚</li><li><p>é…ç½® ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">remoteaddr_route</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RemoteAddr=192.168.1.1/24</span></div></pre></td></tr></table></figure></li></ul><ul><li><p>ä»£ç  ï¼š    </p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteAddrRoutePredicateFactory</span> <span class="keyword">implements</span> <span class="title">RoutePredicateFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(RemoteAddrRoutePredicateFactory.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: validate(<span class="number">1</span>, args);</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="comment">//</span></div><div class="line"><span class="number">10</span>: List&lt;SubnetUtils&gt; sources = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">11</span>: <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>: <span class="keyword">for</span> (Object arg : args.getValues()) &#123;</div><div class="line"><span class="number">13</span>: addSource(sources, (String) arg);</div><div class="line"><span class="number">14</span>: &#125;</div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line"><span class="number">18</span>: InetSocketAddress remoteAddress = exchange.getRequest().getRemoteAddress();</div><div class="line"><span class="number">19</span>: <span class="keyword">if</span> (remoteAddress != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>: <span class="comment">// æ¥æº IP</span></div><div class="line"><span class="number">21</span>: String hostAddress = remoteAddress.getAddress().getHostAddress();</div><div class="line"><span class="number">22</span>: String host = exchange.getRequest().getURI().getHost();</div><div class="line"><span class="number">23</span>: <span class="keyword">if</span> (!hostAddress.equals(host)) &#123;</div><div class="line"><span class="number">24</span>: log.warn(<span class="string">"Remote addresses didn't match "</span> + hostAddress + <span class="string">" != "</span> + host);</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">//</span></div><div class="line"><span class="number">28</span>: <span class="keyword">for</span> (SubnetUtils source : sources) &#123;</div><div class="line"><span class="number">29</span>: <span class="keyword">if</span> (source.getInfo().isInRange(hostAddress)) &#123;</div><div class="line"><span class="number">30</span>: <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">31</span>: &#125;</div><div class="line"><span class="number">32</span>: &#125;</div><div class="line"><span class="number">33</span>: &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">36</span>: &#125;;</div><div class="line"><span class="number">37</span>: &#125;</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addSource</span><span class="params">(List&lt;SubnetUtils&gt; sources, String source)</span> </span>&#123;</div><div class="line"><span class="number">40</span>: <span class="keyword">boolean</span> inclusiveHostCount = <span class="keyword">false</span>;</div><div class="line"><span class="number">41</span>: <span class="keyword">if</span> (!source.contains(<span class="string">"/"</span>)) &#123; <span class="comment">// no netmask, add default</span></div><div class="line"><span class="number">42</span>: source = source + <span class="string">"/32"</span>;</div><div class="line"><span class="number">43</span>: &#125;</div><div class="line"><span class="number">44</span>: <span class="keyword">if</span> (source.endsWith(<span class="string">"/32"</span>)) &#123;</div><div class="line"><span class="number">45</span>: <span class="comment">//http://stackoverflow.com/questions/2942299/converting-cidr-address-to-subnet-mask-and-network-address#answer-6858429</span></div><div class="line"><span class="number">46</span>: inclusiveHostCount = <span class="keyword">true</span>;</div><div class="line"><span class="number">47</span>: &#125;</div><div class="line"><span class="number">48</span>: <span class="comment">//<span class="doctag">TODO:</span> howto support ipv6 as well?</span></div><div class="line"><span class="number">49</span>: SubnetUtils subnetUtils = <span class="keyword">new</span> SubnetUtils(source);</div><div class="line"><span class="number">50</span>: subnetUtils.setInclusiveHostCount(inclusiveHostCount);</div><div class="line"><span class="number">51</span>: sources.add(subnetUtils);</div><div class="line"><span class="number">52</span>: &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure><ul><li>Tulpe å‚æ•° ï¼šå­—ç¬¦ä¸²<strong>æ•°ç»„</strong>ã€‚</li><li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>#validateMin(...)</code> æ–¹æ³•ï¼Œæ ¡éªŒå‚æ•°æ•°é‡è‡³å°‘ä¸º <code>1</code> ï¼Œå­—ç¬¦ä¸²æ•°ç»„<strong>éç©º</strong>ã€‚</li><li>ç¬¬ 10 è‡³ 15 è¡Œ ï¼šä½¿ç”¨ <strong>SubnetUtils</strong> å·¥å…·ç±»ï¼Œè§£æé…ç½®çš„å€¼ã€‚</li><li>ç¬¬ 21 è‡³ 25 è¡Œ ï¼šè·å¾—è¯·æ±‚æ¥æº IP ã€‚</li><li>ç¬¬ 28 è‡³ 32 è¡Œ ï¼šè¯·æ±‚<strong>æ¥æº IP</strong> åœ¨<strong>æŒ‡å®šèŒƒå›´å†…</strong>ã€‚</li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ ä»£ç å¥½å¤šï¼Œè´´çš„æ‰‹éƒ½æŠ½äº†ã€‚å˜¿å˜¿ï¼ŒRemoteAddrRoutePredicateFactory å†™çš„æœ‰ç‚¹å·æ‡’ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_15/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.4ï¼‰ä¹‹ Kotlin è‡ªå®šä¹‰ RouteLocator</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/</id>
    <published>2020-02-09T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/">2. RouteLocatorDsl</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>å¦‚ä½•ä½¿ç”¨ Kotlin å®ç°è‡ªå®šä¹‰ RouteLocator</strong>ã€‚</p><p>ğŸ˜ˆ ç”±äºç¬”è€…æš‚æ—¶ä¸äº†è§£ Kotlin ï¼Œä¹Ÿæ¯”è¾ƒ<strong>æ‡’</strong>ï¼Œæš‚æ—¶ä¸å‡†å¤‡äº†è§£ Kotlin ï¼Œæ‰€ä»¥æœ¬æ–‡å¾ˆå¤§å¯èƒ½æ€§æ˜¯ <code>&quot;ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“&quot;</code> ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-RouteLocatorDsl"><a href="#2-RouteLocatorDsl" class="headerlink" title="2. RouteLocatorDsl"></a>2. RouteLocatorDsl</h1><p><code>org.springframework.cloud.gateway.route.RouteLocatorDsl</code> ï¼Œä½¿ç”¨ Kotlin å®ç°è‡ªå®šä¹‰ RouteLocator ã€‚æˆ‘ä»¬å…ˆæ‰“å¼€ <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/kotlin/org/springframework/cloud/gateway/route/GatewayDsl.kt" rel="external nofollow noopener noreferrer" target="_blank">GatewayDsl.kt</a> ï¼Œå¤§ä½“æµè§ˆä¸€ä¸‹ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€æ®µ<strong>ç¤ºä¾‹</strong>ç¨‹åºï¼Œæˆ‘ä»¬ä¼šæŠŠ <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/kotlin/org/springframework/cloud/gateway/route/GatewayDsl.kt" rel="external nofollow noopener noreferrer" target="_blank">GatewayDsl.kt</a> çš„ä»£ç å®ç°åµŒå…¥å…¶ä¸­ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight kotlin"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.factory.GatewayFilters.addResponseHeader</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.handler.predicate.RoutePredicates.host</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.handler.predicate.RoutePredicates.path</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.gateway</div><div class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean</div><div class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration</div><div class="line"></div><div class="line">  <span class="number">1</span>: <span class="meta">@Configuration</span></div><div class="line">  <span class="number">2</span>: <span class="class"><span class="keyword">class</span> <span class="title">AdditionalRoutes</span> </span>&#123;</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>: <span class="meta">@Bean</span></div><div class="line">  <span class="number">5</span>: <span class="function"><span class="keyword">fun</span> <span class="title">additionalRouteLocator</span><span class="params">()</span></span>: RouteLocator = gateway &#123;</div><div class="line">  <span class="number">6</span>: route(id = <span class="string">"test-kotlin"</span>) &#123;</div><div class="line">  <span class="number">7</span>: uri(<span class="string">"http://httpbin.org:80"</span>) <span class="comment">// Route.Builder#uri(uri)</span></div><div class="line">  <span class="number">8</span>: predicate(host(<span class="string">"kotlin.abc.org"</span>) and path(<span class="string">"/image/png"</span>)) <span class="comment">// Route.Builder#predicate(predicate)</span></div><div class="line">  <span class="number">9</span>: add(addResponseHeader(<span class="string">"X-TestHeader"</span>, <span class="string">"foobar"</span>)) <span class="comment">// Route.Builder#add(webFilter)</span></div><div class="line"> <span class="number">10</span>: &#125;</div><div class="line"> <span class="number">11</span>: &#125;</div><div class="line"> <span class="number">12</span>: </div><div class="line"> <span class="number">13</span>: &#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#gateway(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>è‡ªå®šä¹‰</strong>çš„ RouteLocator ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight kotlin"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GatewayDsl.kt</span></div><div class="line"><span class="function"><span class="keyword">fun</span> <span class="title">gateway</span><span class="params">(routeLocator: <span class="type">RouteLocatorDsl</span>.()</span></span> -&gt; <span class="built_in">Unit</span>) = RouteLocatorDsl().apply(routeLocator).build()</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 6 è‡³ 10 è¡Œ ï¼šè°ƒç”¨ <code>RouteLocatorDsl#route(...)</code> æ–¹æ³•ï¼Œé…ç½®<strong>ä¸€ä¸ª</strong> Route ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight kotlin"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GatewayDsl.kt</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">val</span> routes = mutableListOf&lt;Route&gt;()</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * DSL to add a route to the [RouteLocator]</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> [Route.Builder]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">fun</span> <span class="title">route</span><span class="params">(id: <span class="type">String</span>? = <span class="literal">null</span>, order: <span class="type">Int</span> = <span class="number">0</span>, uri: <span class="type">String</span>? = <span class="literal">null</span>, init: <span class="type">Route</span>.<span class="type">Builder</span>.()</span></span> -&gt; <span class="built_in">Unit</span>) &#123;</div><div class="line">    <span class="keyword">val</span> builder = Route.builder()</div><div class="line">    <span class="keyword">if</span> (uri != <span class="literal">null</span>) &#123;</div><div class="line">        builder.uri(uri)</div><div class="line">    &#125;</div><div class="line">    routes += builder.id(id).order(order).apply(init).build()</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>Route.Builder#uri(uri)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>uri</code> ã€‚</p></li><li><p>ç¬¬ 8 è¡Œ ï¼šè°ƒç”¨ <code>Route.Builder#predicate(predicate)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>predicates</code> ã€‚</p><ul><li>ä½¿ç”¨ RoutePredicates åˆ›å»º<strong>æ¯ä¸ª</strong> Route çš„ Predicate ã€‚</li><li><p><code>and</code> / <code>or</code> æ“ä½œç¬¦ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight kotlin"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GatewayDsl.kt</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * A helper to return a composed [Predicate] that tests against this [Predicate] AND the [other] predicate</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Predicate<span class="type">&lt;T&gt;</span>.<span class="title">and</span><span class="params">(other: <span class="type">Predicate</span>&lt;<span class="type">T</span>&gt;)</span></span> = <span class="keyword">this</span>.and(other)</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * A helper to return a composed [Predicate] that tests against this [Predicate] OR the [other] predicate</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Predicate<span class="type">&lt;T&gt;</span>.<span class="title">or</span><span class="params">(other: <span class="type">Predicate</span>&lt;<span class="type">T</span>&gt;)</span></span> = <span class="keyword">this</span>.or(other)</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 9 è¡Œ ï¼šè°ƒç”¨ <code>Route.Builder#add(webFilter)</code> æ–¹æ³•ï¼Œæ·»åŠ  <code>filters</code> ã€‚</p><ul><li>ä½¿ç”¨ GatewayFilters åˆ›å»º<strong>æ¯ä¸ª</strong> Route çš„ GatewayFilter ã€‚</li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ â€œ<strong>ä¸€æœ¬æ­£ç»</strong>â€œ çš„å†™å®Œäº†ï¼Œåæ­£æˆ‘æ˜¯ä¸ç®¡äº†ã€‚å“ˆå“ˆå“ˆå“ˆã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_10/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-kotlin/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gatew
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.3ï¼‰ä¹‹ Java è‡ªå®šä¹‰ RouteLocator</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/</id>
    <published>2020-02-04T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/">2. Routes</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/">3. RoutePredicates</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/">4. GatewayFilters</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>å¦‚ä½•ä½¿ç”¨ Java å®ç°è‡ªå®šä¹‰ RouteLocator</strong>ã€‚</p><p><em>ps ï¼šä¸ºä»€ä¹ˆè¿™é‡Œå¼ºè°ƒ Java å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ Kotlin å®ç°è‡ªå®šä¹‰ RouteLocator ï¼Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†äº«</em>ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µ<strong>ç¤ºä¾‹</strong>ç¨‹åºï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.cloud.gateway.filter.factory.GatewayFilters.addResponseHeader;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.cloud.gateway.handler.predicate.RoutePredicates.host;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.cloud.gateway.handler.predicate.RoutePredicates.path;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.tuple.TupleBuilder.tuple;</div><div class="line"></div><div class="line">  <span class="number">1</span>: <span class="meta">@Bean</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(ThrottleGatewayFilterFactory throttle)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>: <span class="comment">//@formatter:off</span></div><div class="line">  <span class="number">4</span>: <span class="keyword">return</span> Routes.locator()</div><div class="line">  <span class="number">5</span>:            <span class="comment">// Route</span></div><div class="line">  <span class="number">6</span>: .route(<span class="string">"test"</span>)</div><div class="line">  <span class="number">7</span>: .predicate(host(<span class="string">"**.abc.org"</span>).and(path(<span class="string">"/image/png"</span>)))</div><div class="line">  <span class="number">8</span>: .addResponseHeader(<span class="string">"X-TestHeader"</span>, <span class="string">"foobar"</span>)</div><div class="line">  <span class="number">9</span>: .uri(<span class="string">"http://httpbin.org:80"</span>)</div><div class="line"> <span class="number">10</span>:            <span class="comment">// Route</span></div><div class="line"> <span class="number">11</span>: .route(<span class="string">"test2"</span>)</div><div class="line"> <span class="number">12</span>: .predicate(path(<span class="string">"/image/webp"</span>))</div><div class="line"> <span class="number">13</span>: .add(addResponseHeader(<span class="string">"X-AnotherHeader"</span>, <span class="string">"baz"</span>))</div><div class="line"> <span class="number">14</span>: .uri(<span class="string">"http://httpbin.org:80"</span>)</div><div class="line"> <span class="number">15</span>:            <span class="comment">// Route</span></div><div class="line"> <span class="number">16</span>: .route(<span class="string">"test3"</span>)</div><div class="line"> <span class="number">17</span>: .order(-<span class="number">1</span>)</div><div class="line"> <span class="number">18</span>: .predicate(host(<span class="string">"**.throttle.org"</span>).and(path(<span class="string">"/get"</span>)))</div><div class="line"> <span class="number">19</span>: .add(throttle.apply(tuple().of(<span class="string">"capacity"</span>, <span class="number">1</span>,</div><div class="line"> <span class="number">20</span>: <span class="string">"refillTokens"</span>, <span class="number">1</span>,</div><div class="line"> <span class="number">21</span>: <span class="string">"refillPeriod"</span>, <span class="number">10</span>,</div><div class="line"> <span class="number">22</span>: <span class="string">"refillUnit"</span>, <span class="string">"SECONDS"</span>)))</div><div class="line"> <span class="number">23</span>: .uri(<span class="string">"http://httpbin.org:80"</span>)</div><div class="line"> <span class="number">24</span>: .build();</div><div class="line"> <span class="number">25</span>: <span class="comment">////@formatter:on</span></div><div class="line"> <span class="number">26</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ Routes åˆ›å»ºäº†<strong>ä¸‰ä¸ª</strong> Route ã€‚</li><li>ä½¿ç”¨ RoutePredicates åˆ›å»º<strong>æ¯ä¸ª</strong> Route çš„ Predicate ã€‚</li><li>ä½¿ç”¨ GatewayFilters åˆ›å»º<strong>æ¯ä¸ª</strong> Route çš„ GatewayFilter ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-Routes"><a href="#2-Routes" class="headerlink" title="2. Routes"></a>2. Routes</h1><p><code>rg.springframework.cloud.gateway.route.Routes</code> ï¼ŒJava è‡ªå®šä¹‰ RouteLocator <strong>Builder</strong> ã€‚</p><p>Routes å†…ç½®å¤šä¸ª Builder ç±»ï¼Œç”¨äºåˆ›å»º Route ç›¸å…³çš„å„ä¸ªå…ƒç´  ï¼š</p><table><thead><tr><th>Routes å†…ç½® Builder ç±»</th><th>ç»„ä»¶</th></tr></thead><tbody><tr><td>LocatorBuilder</td><td>RouteLocator</td></tr><tr><td>RouteSpec</td><td>Route</td></tr><tr><td>PredicateSpec</td><td>Predicate</td></tr><tr><td>GatewayFilterSpec</td><td>GatewayFilter</td></tr></tbody></table><p>ä½¿ç”¨æ—¶ï¼Œé¦–å…ˆè°ƒç”¨ <code>Routes#locator()</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª LocatorBuilder ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LocatorBuilder <span class="title">locator</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocatorBuilder();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>LocatorBuilder ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LocatorBuilder</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> List&lt;Route&gt; routes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> PredicateSpec <span class="title">route</span><span class="params">(String id)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>: <span class="keyword">return</span> <span class="keyword">new</span> RouteSpec(<span class="keyword">this</span>).id(id);</div><div class="line"> <span class="number">7</span>: &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Route route)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: <span class="keyword">this</span>.routes.add(route);</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: <span class="function">LocatorBuilder <span class="title">uri</span><span class="params">(Route.Builder builder, String uri)</span> </span>&#123;</div><div class="line"><span class="number">14</span>: Route route = builder.uri(uri).build();</div><div class="line"><span class="number">15</span>: routes.add(route);</div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line"><span class="number">17</span>: &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>: <span class="function">LocatorBuilder <span class="title">uri</span><span class="params">(Route.Builder builder, URI uri)</span> </span>&#123;</div><div class="line"><span class="number">20</span>: Route route = builder.uri(uri).build();</div><div class="line"><span class="number">21</span>: routes.add(route);</div><div class="line"><span class="number">22</span>: <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">26</span>: <span class="keyword">return</span> () -&gt; Flux.fromIterable(<span class="keyword">this</span>.routes);</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>routes</code> å±æ€§ï¼ŒLocatorBuilder å·²åˆ›å»ºå¥½çš„ Route æ•°ç»„ã€‚</li><li><code>#add()</code> æ–¹æ³•ï¼Œæ·»åŠ å·²åˆ›å»ºå¥½çš„ Route ã€‚</li><li><code>#uri()</code> æ–¹æ³•ï¼Œä½¿ç”¨ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Route.java#L67" rel="external nofollow noopener noreferrer" target="_blank">Route.Builder</a> æ–¹æ³•ï¼Œåˆ›å»º Route å¹¶æ·»åŠ ã€‚ </li><li><p><code>#route()</code> æ–¹æ³•ï¼Œ<strong>ä¸åŒäºä¸Šé¢ä¸¤ä¸ªæ–¹æ³•</strong>ï¼Œé¦–å…ˆåˆ›å»º RouteSpec å¯¹è±¡ï¼Œåè°ƒç”¨ <code>RouteSpec#id(...)</code> æ–¹æ³•ï¼Œåˆ›å»º PredicateSpec å¯¹è±¡ã€‚<strong>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„å‘¢</strong>ï¼ŸRoutes é‡Œ<strong>åˆ›å»º</strong> Route æ˜¯<strong>æœ‰åº</strong>çš„<strong>é“¾å¼</strong>è¿‡ç¨‹ï¼Œå¦‚ä¸‹å¦‚ ï¼š</p><p>  <img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_05/01.png" alt=""></p><ul><li>ç»¿çº¿ ï¼šåˆ›å»º<strong>ä¸€ä¸ª</strong> <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Route.java#L67" rel="external nofollow noopener noreferrer" target="_blank">Route.Builder</a> ã€‚</li><li>çº¢çº¿ ï¼šè°ƒç”¨ <code>LocatorBuilder#uri(uri)</code> æ–¹æ³•ï¼Œåˆ›å»º Route å¹¶æ·»åŠ ã€‚åé¢ï¼Œå¯ä»¥ç»§ç»­ã€<strong>ç»¿çº¿</strong>ã€‘ï¼Œåˆ›å»ºä¸‹ä¸€ä¸ª <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Route.java#L67" rel="external nofollow noopener noreferrer" target="_blank">Route.Builder</a> ã€‚</li></ul></li><li><code>#build()</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>è‡ªå®šä¹‰</strong> RouteLocator ç±»ã€‚</li></ul><hr><p>RouteSpec / PredicateSpec / GatewayFilterSpec å®ç°ä¸Šå°±æ˜¯å¸¸è§çš„ Builder ç±»ï¼Œç‚¹å‡»é“¾æ¥ç›´æ¥æŸ¥çœ‹ä»£ç  ï¼š</p><ul><li><a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Routes.java#L72" rel="external nofollow noopener noreferrer" target="_blank">RouteSpec</a></li><li><a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Routes.java#L91" rel="external nofollow noopener noreferrer" target="_blank">PredicateSpec</a></li><li><a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Routes.java#L132" rel="external nofollow noopener noreferrer" target="_blank">GatewayFilterSpec</a></li></ul><h1 id="3-RoutePredicates"><a href="#3-RoutePredicates" class="headerlink" title="3. RoutePredicates"></a>3. RoutePredicates</h1><p><code>org.springframework.cloud.gateway.handler.predicate.RoutePredicates</code> ï¼ŒRoutePredicates <strong>å·¥å‚</strong>ï¼Œå…¶è°ƒç”¨ RoutePredicateFactory æ¥å£çš„<strong>å®ç°ç±»</strong>ï¼Œåˆ›å»ºå„ç§ Predicate ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/predicate/RoutePredicates.java#L38" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p><h1 id="4-GatewayFilters"><a href="#4-GatewayFilters" class="headerlink" title="4. GatewayFilters"></a>4. GatewayFilters</h1><p><code>org.springframework.cloud.gateway.filter.factory.GatewayFilters</code> ï¼ŒGatewayFilter <strong>å·¥å‚</strong>ï¼Œå…¶è°ƒç”¨ GatewayFilterFactory æ¥å£çš„<strong>å®ç°ç±»</strong>ï¼Œåˆ›å»ºå„ç§ GatewayFilter ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡» <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/9ffb0f18678460fda9b25c572c12f9054a62ca52/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/GatewayFilters.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>åŸå…ˆè¿˜åœ¨çº ç»“ Routes æ€ä¹ˆè§£é‡Šåˆé€‚ï¼Œç”»äº†ä¸ªå›¾ï¼Œæ»¡æ„ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_05/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-custom-java/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.2ï¼‰ä¹‹ RouteDefinitionRouteLocator è·¯ç”±é…ç½®</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/</id>
    <published>2020-01-31T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">2. RouteDefinitionRouteLocator</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">2.1 æ„é€ æ–¹æ³•</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">2.2 è·å¾— Route</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">2.3 è½¬æ¢ Route</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">2.4 è·å¾— Tuple</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RouteDefinitionRouteLocator çš„æºç å®ç°</strong>ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_01/01.jpeg" alt=""></p><ul><li><strong>è“è‰²</strong>éƒ¨åˆ† ï¼šRouteDefinitionRouteLocator ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-RouteDefinitionRouteLocator"><a href="#2-RouteDefinitionRouteLocator" class="headerlink" title="2. RouteDefinitionRouteLocator"></a>2. RouteDefinitionRouteLocator</h1><p><code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code> ï¼ŒåŸºäº <strong>RouteDefinitionLocator</strong> çš„ RouteLocator <strong>å®ç°ç±»</strong>ã€‚</p><p>RouteDefinitionRouteLocator ä» RouteDefinitionLocator è·å– RouteDefinition ï¼Œè½¬æ¢æˆ Route ã€‚å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_01/02.png" alt=""></p><h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><p>RouteDefinitionRouteLocator æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteDefinitionRouteLocator</span> <span class="keyword">implements</span> <span class="title">RouteLocator</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> RouteDefinitionLocator routeDefinitionLocator;</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:  * RoutePredicateFactory æ˜ å°„</span></div><div class="line"><span class="comment"> 7:  * key ï¼š&#123;<span class="doctag">@link</span> RoutePredicateFactory#name()&#125;</span></div><div class="line"><span class="comment"> 8:  */</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RoutePredicateFactory&gt; predicates = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">11:  * GatewayFilterFactory æ˜ å°„</span></div><div class="line"><span class="comment">12:  * key ï¼š&#123;<span class="doctag">@link</span> GatewayFilterFactory#name()&#125;</span></div><div class="line"><span class="comment">13:  */</span></div><div class="line"><span class="number">14</span>: <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, GatewayFilterFactory&gt; gatewayFilterFactories = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="number">15</span>: <span class="keyword">private</span> <span class="keyword">final</span> GatewayProperties gatewayProperties;</div><div class="line"><span class="number">16</span>: <span class="keyword">private</span> <span class="keyword">final</span> SpelExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</div><div class="line"><span class="number">17</span>: <span class="keyword">private</span> BeanFactory beanFactory;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>: <span class="function"><span class="keyword">public</span> <span class="title">RouteDefinitionRouteLocator</span><span class="params">(RouteDefinitionLocator routeDefinitionLocator,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>:    List&lt;RoutePredicateFactory&gt; predicates,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">21</span>:    List&lt;GatewayFilterFactory&gt; gatewayFilterFactories,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">22</span>:    GatewayProperties gatewayProperties)</span> </span>&#123;</div><div class="line"><span class="number">23</span>: <span class="comment">// è®¾ç½® RouteDefinitionLocator</span></div><div class="line"><span class="number">24</span>: <span class="keyword">this</span>.routeDefinitionLocator = routeDefinitionLocator;</div><div class="line"><span class="number">25</span>: <span class="comment">// åˆå§‹åŒ– RoutePredicateFactory</span></div><div class="line"><span class="number">26</span>: initFactories(predicates);</div><div class="line"><span class="number">27</span>: <span class="comment">// åˆå§‹åŒ– RoutePredicateFactory</span></div><div class="line"><span class="number">28</span>: gatewayFilterFactories.forEach(factory -&gt; <span class="keyword">this</span>.gatewayFilterFactories.put(factory.name(), factory));</div><div class="line"><span class="number">29</span>: <span class="comment">// è®¾ç½® GatewayProperties</span></div><div class="line"><span class="number">30</span>: <span class="keyword">this</span>.gatewayProperties = gatewayProperties;</div><div class="line"><span class="number">31</span>: &#125;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">34</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line"><span class="number">35</span>: <span class="keyword">this</span>.beanFactory = beanFactory;</div><div class="line"><span class="number">36</span>: &#125;</div><div class="line"><span class="number">37</span>:&#125;</div></pre></td></tr></table></figure><ul><li><code>routeDefinitionLocator</code> å±æ€§ï¼Œæä¾› RouteDefinition çš„ RouteDefinitionLocator ã€‚</li><li><code>predicates</code> å±æ€§ï¼ŒRoutePredicateFactory Bean å¯¹è±¡<strong>æ˜ å°„</strong>ã€‚<ul><li><code>key</code> ä¸º <code>{@link RoutePredicateFactory#name()}</code> ã€‚</li><li>é€šè¿‡å®ƒï¼Œå°† <code>RouteDefinition.predicates</code> è½¬æ¢æˆ <code>Route.predicates</code> ã€‚</li><li>ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>#initFactories()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–æ˜ å°„ã€‚é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/6bb8d6f93c289fd3a84c802ada60dd2bb57e1fb7/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RouteDefinitionRouteLocator.java#L90" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ä»£ç ã€‚</li></ul></li><li><code>gatewayFilterFactories</code> å±æ€§ï¼ŒRoutePredicateFactory Bean å¯¹è±¡<strong>æ˜ å°„</strong>ã€‚<ul><li><code>key</code> ä¸º <code>{@link GatewayFilterFactory#name()}</code> ã€‚</li><li>é€šè¿‡å®ƒï¼Œå°† <code>RouteDefinition.filters</code> è½¬æ¢æˆ <code>Route.filters</code> ã€‚</li><li>ç¬¬ 28 è¡Œ ï¼šåˆå§‹åŒ–æ˜ å°„ã€‚</li></ul></li><li><code>gatewayProperties</code> å±æ€§ï¼Œä½¿ç”¨ <code>GatewayProperties.defaultFilters</code> <strong>é»˜è®¤è¿‡æ»¤å™¨å®šä¹‰æ•°ç»„</strong>ï¼Œæ·»åŠ åˆ°æ¯ä¸ª Route ã€‚ä¸‹æ–‡ä¼šçœ‹åˆ°ç›¸å…³ä»£ç çš„å®ç°ã€‚</li><li><code>parser</code> å±æ€§ï¼ŒSpring EL è¡¨è¾¾å¼è§£æå™¨ã€‚åœ¨ <a href="#">ã€Œ2.4 è·å¾— Tupleã€</a> ä¼šçœ‹åˆ°å®ƒçš„ä½¿ç”¨ã€‚</li><li><code>beanFactory</code> å±æ€§ï¼ŒBean å·¥å‚ã€‚</li></ul><h2 id="2-2-è·å¾—-Route"><a href="#2-2-è·å¾—-Route" class="headerlink" title="2.2 è·å¾— Route"></a>2.2 è·å¾— Route</h2><p><code>#getRoutes()</code> æ–¹æ³•ï¼Œè·å¾— Route æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Flux&lt;Route&gt; <span class="title">getRoutes</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionLocator.getRouteDefinitions()</div><div class="line"> <span class="number">4</span>: .map(<span class="keyword">this</span>::convertToRoute) <span class="comment">// RouteDefinition =&gt; Route</span></div><div class="line"> <span class="number">5</span>: <span class="comment">//<span class="doctag">TODO:</span> error handling</span></div><div class="line"> <span class="number">6</span>: .map(route -&gt; &#123; <span class="comment">// æ‰“å°æ—¥å¿—</span></div><div class="line"> <span class="number">7</span>: <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">8</span>: logger.debug(<span class="string">"RouteDefinition matched: "</span> + route.getId());</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: <span class="keyword">return</span> route;</div><div class="line"><span class="number">11</span>: &#125;);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 3 è¡Œ ï¼š è°ƒç”¨ <code>RouteDefinitionLocator#getRouteDefinitions()</code> æ–¹æ³•ï¼Œè·å¾— RouteDefinitions æ•°ç»„ã€‚</li><li>ç¬¬ 4 è¡Œ ï¼šè°ƒç”¨ <code>#convertToRoute()</code> æ–¹æ³•ï¼Œå°†æ¯ä¸ª RouteDefinition <strong>è½¬æ¢</strong>æˆ  Route ã€‚è¯¥æ–¹æ³•åœ¨ <a href="#">ã€Œ2.3 è½¬æ¢ Routeã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šæ‰“å°<strong>è¾“å‡º</strong>æ¯ä¸ª Route ã€‚</li></ul><h2 id="2-3-è½¬æ¢-Route"><a href="#2-3-è½¬æ¢-Route" class="headerlink" title="2.3 è½¬æ¢ Route"></a>2.3 è½¬æ¢ Route</h2><p><code>#convertToRoute()</code> æ–¹æ³•ï¼Œå°†æ¯ä¸ª RouteDefinition <strong>è½¬æ¢</strong>æˆ  Route ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Route <span class="title">convertToRoute</span><span class="params">(RouteDefinition routeDefinition)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åˆå¹¶ Predicate</span></div><div class="line"> <span class="number">3</span>: Predicate&lt;ServerWebExchange&gt; predicate = combinePredicates(routeDefinition);</div><div class="line"> <span class="number">4</span>: <span class="comment">// è·å¾— GatewayFilter</span></div><div class="line"> <span class="number">5</span>: List&lt;GatewayFilter&gt; gatewayFilters = getFilters(routeDefinition);</div><div class="line"> <span class="number">6</span>: <span class="comment">// æ„å»º Route</span></div><div class="line"> <span class="number">7</span>: <span class="keyword">return</span> Route.builder(routeDefinition)</div><div class="line"> <span class="number">8</span>: .predicate(predicate)</div><div class="line"> <span class="number">9</span>: .gatewayFilters(gatewayFilters)</div><div class="line"><span class="number">10</span>: .build();</div><div class="line"><span class="number">11</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>#combinePredicates()</code> æ–¹æ³•ï¼Œå°† <code>RouteDefinition.predicates</code> <strong>æ•°ç»„</strong>åˆå¹¶æˆ<strong>ä¸€ä¸ª</strong> <code>java.util.function.Predicate</code> ï¼Œè¿™æ · RoutePredicateHandlerMapping ä¸ºè¯·æ±‚<strong>åŒ¹é…</strong> Route ï¼Œåªè¦è°ƒç”¨<strong>ä¸€æ¬¡</strong> <code>Predicate#test(ServerWebExchange)</code> æ–¹æ³•å³å¯ã€‚</li><li>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>#getFilters()</code> æ–¹æ³•ï¼Œè·å¾— GatewayFilter <strong>æ•°ç»„</strong>ã€‚</li><li>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šæ„å»º Route ã€‚</li></ul><hr><p><code>#combinePredicates()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Predicate&lt;ServerWebExchange&gt; <span class="title">combinePredicates</span><span class="params">(RouteDefinition routeDefinition)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å¯»æ‰¾ Predicate</span></div><div class="line"> <span class="number">3</span>: List&lt;PredicateDefinition&gt; predicates = routeDefinition.getPredicates();</div><div class="line"> <span class="number">4</span>: Predicate&lt;ServerWebExchange&gt; predicate = lookup(routeDefinition, predicates.get(<span class="number">0</span>));</div><div class="line"> <span class="number">5</span>: <span class="comment">// æ‹¼æ¥ Predicate</span></div><div class="line"> <span class="number">6</span>: <span class="keyword">for</span> (PredicateDefinition andPredicate : predicates.subList(<span class="number">1</span>, predicates.size())) &#123;</div><div class="line"> <span class="number">7</span>: Predicate&lt;ServerWebExchange&gt; found = lookup(routeDefinition, andPredicate);</div><div class="line"> <span class="number">8</span>: predicate = predicate.and(found);</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: <span class="comment">// è¿”å› Predicate</span></div><div class="line"><span class="number">11</span>: <span class="keyword">return</span> predicate;</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="function"><span class="keyword">private</span> Predicate&lt;ServerWebExchange&gt; <span class="title">lookup</span><span class="params">(RouteDefinition routeDefinition, PredicateDefinition predicate)</span> </span>&#123;</div><div class="line"><span class="number">15</span>:     <span class="comment">// è·å¾— RoutePredicateFactory</span></div><div class="line"><span class="number">16</span>: RoutePredicateFactory found = <span class="keyword">this</span>.predicates.get(predicate.getName());</div><div class="line"><span class="number">17</span>: <span class="keyword">if</span> (found == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to find RoutePredicateFactory with name "</span> + predicate.getName());</div><div class="line"><span class="number">19</span>: &#125;</div><div class="line"><span class="number">20</span>: <span class="comment">// è·å¾— Tuple</span></div><div class="line"><span class="number">21</span>: Map&lt;String, String&gt; args = predicate.getArgs();</div><div class="line"><span class="number">22</span>: <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">23</span>: logger.debug(<span class="string">"RouteDefinition "</span> + routeDefinition.getId() + <span class="string">" applying "</span></div><div class="line"><span class="number">24</span>: + args + <span class="string">" to "</span> + predicate.getName());</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: Tuple tuple = getTuple(found, args, <span class="keyword">this</span>.parser, <span class="keyword">this</span>.beanFactory);</div><div class="line"><span class="number">27</span>: <span class="comment">// è·å¾— Predicate</span></div><div class="line"><span class="number">28</span>: <span class="keyword">return</span> found.apply(tuple);</div><div class="line"><span class="number">29</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 2 è‡³ 9 è¡Œ ï¼šé€šè¿‡è°ƒç”¨ <code>#lookup()</code> æ–¹æ³•ï¼ŒæŸ¥æ‰¾ PredicateDefinition å¯¹åº”çš„ Predicate ã€‚ä¸ºä»€ä¹ˆæ‹†æˆ<strong>ä¸¤éƒ¨åˆ†</strong>ï¼Ÿç¬¬ä¸€éƒ¨åˆ†æ‰¾åˆ° <code>java.util.function.Predicate</code> ï¼Œç¬¬äºŒéƒ¨åˆ†é€šè¿‡ <code>Predicate#and(Predicate)</code> æ–¹æ³•ä¸æ–­æ‹¼æ¥ã€‚</li><li>ç¬¬ 11 è¡Œ ï¼šè¿”å› Predicate ã€‚</li><li>â€”â€”â€”â€”â€”â€”â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”â€”â€”â€”â€”â€”â€“</li><li>ç¬¬ 14 è‡³ 29 è¡Œ ï¼š<code>#lookup()</code> æ–¹æ³•ã€‚<ul><li>ç¬¬ 16 è‡³ 19 è¡Œ ï¼šè·å¾— RoutePredicateFactory Bean å¯¹è±¡ã€‚</li><li>ç¬¬ 21 è‡³ 26 è¡Œ ï¼šè°ƒç”¨ <code>#getTuple()</code> æ–¹æ³•ï¼Œè·å¾— Tuple ã€‚è¯¥æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œåœ¨ <a href="#">ã€Œ2.4 è·å¾— Tupleã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è¡Œ ï¼šè°ƒç”¨ <code>RoutePredicateFactory#apply(Tuple)</code> æ–¹æ³•ï¼Œåˆ›å»º Predicate ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.1) ä¹‹ RoutePredicateFactory  è·¯ç”±è°“è¯­å·¥å‚ ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><hr><p><code>#getFilters()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> List&lt;GatewayFilter&gt; <span class="title">getFilters</span><span class="params">(RouteDefinition routeDefinition)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: List&lt;GatewayFilter&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> <span class="number">3</span>: <span class="comment">// æ·»åŠ  é»˜è®¤è¿‡æ»¤å™¨</span></div><div class="line"> <span class="number">4</span>: <span class="comment">//<span class="doctag">TODO:</span> support option to apply defaults after route specific filters?</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">if</span> (!<span class="keyword">this</span>.gatewayProperties.getDefaultFilters().isEmpty()) &#123;</div><div class="line"> <span class="number">6</span>: filters.addAll(loadGatewayFilters(<span class="string">"defaultFilters"</span>,</div><div class="line"> <span class="number">7</span>: <span class="keyword">this</span>.gatewayProperties.getDefaultFilters()));</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: <span class="comment">// æ·»åŠ  é…ç½®çš„è¿‡æ»¤å™¨</span></div><div class="line"><span class="number">10</span>: <span class="keyword">if</span> (!routeDefinition.getFilters().isEmpty()) &#123;</div><div class="line"><span class="number">11</span>: filters.addAll(loadGatewayFilters(routeDefinition.getId(), routeDefinition.getFilters()));</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: <span class="comment">// æ’åº</span></div><div class="line"><span class="number">14</span>: AnnotationAwareOrderComparator.sort(filters);</div><div class="line"><span class="number">15</span>: <span class="keyword">return</span> filters;</div><div class="line"><span class="number">16</span>: &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: <span class="function"><span class="keyword">private</span> List&lt;GatewayFilter&gt; <span class="title">loadGatewayFilters</span><span class="params">(String id, List&lt;FilterDefinition&gt; filterDefinitions)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: List&lt;GatewayFilter&gt; filters = filterDefinitions.stream()</div><div class="line"><span class="number">20</span>: .map(definition -&gt; &#123; <span class="comment">// FilterDefinition =&gt; GatewayFilter</span></div><div class="line"><span class="number">21</span>:     <span class="comment">// è·å¾— GatewayFilterFactory</span></div><div class="line"><span class="number">22</span>: GatewayFilterFactory filter = <span class="keyword">this</span>.gatewayFilterFactories.get(definition.getName());</div><div class="line"><span class="number">23</span>: <span class="keyword">if</span> (filter == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to find GatewayFilterFactory with name "</span> + definition.getName());</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: <span class="comment">// è·å¾— Tuple</span></div><div class="line"><span class="number">27</span>: Map&lt;String, String&gt; args = definition.getArgs();</div><div class="line"><span class="number">28</span>: <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">29</span>: logger.debug(<span class="string">"RouteDefinition "</span> + id + <span class="string">" applying filter "</span> + args + <span class="string">" to "</span> + definition.getName());</div><div class="line"><span class="number">30</span>: &#125;</div><div class="line"><span class="number">31</span>: Tuple tuple = getTuple(filter, args, <span class="keyword">this</span>.parser, <span class="keyword">this</span>.beanFactory);</div><div class="line"><span class="number">32</span>: <span class="comment">// è·å¾— GatewayFilter</span></div><div class="line"><span class="number">33</span>: <span class="keyword">return</span> filter.apply(tuple);</div><div class="line"><span class="number">34</span>: &#125;)</div><div class="line"><span class="number">35</span>: .collect(Collectors.toList()); <span class="comment">// è½¬æˆ List</span></div><div class="line"><span class="number">36</span>:    <span class="comment">// GatewayFilter =&gt; OrderedGatewayFilter</span></div><div class="line"><span class="number">37</span>: ArrayList&lt;GatewayFilter&gt; ordered = <span class="keyword">new</span> ArrayList&lt;&gt;(filters.size());</div><div class="line"><span class="number">38</span>: <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filters.size(); i++) &#123;</div><div class="line"><span class="number">39</span>: ordered.add(<span class="keyword">new</span> OrderedGatewayFilter(filters.get(i), i+<span class="number">1</span>));</div><div class="line"><span class="number">40</span>: &#125;</div><div class="line"><span class="number">41</span>: <span class="comment">// è¿”å› GatewayFilter æ•°ç»„</span></div><div class="line"><span class="number">42</span>: <span class="keyword">return</span> ordered;</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è‡³ 8 è¡Œ ï¼šè°ƒç”¨ <code>#loadGatewayFilters()</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>GatewayProperties.defaultFilters</code> <strong>é»˜è®¤</strong>çš„è¿‡æ»¤å™¨é…ç½®ï¼Œå°† FilterDefinition è½¬æ¢æˆ GatewayFilter ã€‚</li><li>ç¬¬ 10 è‡³ 12 è¡Œ ï¼šè°ƒç”¨ <code>#loadGatewayFilters()</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>RouteDefinition.filters</code> <strong>é…ç½®</strong>çš„è¿‡æ»¤å™¨é…ç½®ï¼Œå°† FilterDefinition è½¬æ¢æˆ GatewayFilter ã€‚</li><li>â€”â€”â€”â€”â€”â€”â€”â€”â€”- åˆ†å‰²çº¿ â€”â€”â€”â€”â€”â€”â€”â€”â€“</li><li>ç¬¬ 18 è‡³ 43 è¡Œ ï¼š<code>#loadGatewayFilters()</code> æ–¹æ³•ã€‚<ul><li>ç¬¬ 20 è‡³ 34 è¡Œ ï¼šå°† FilterDefinition è½¬æ¢æˆ GatewayFilter ã€‚<ul><li>ç¬¬ 21 è‡³ 25 è¡Œ ï¼šè·å¾— GatewayFilterFactory Bean å¯¹è±¡ã€‚</li><li>ç¬¬ 27 è‡³ 31 è¡Œ ï¼šè°ƒç”¨ <code>#getTuple()</code> æ–¹æ³•ï¼Œè·å¾— Tuple ã€‚è¯¥æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œåœ¨ <a href="#">ã€Œ2.4 è·å¾— Tupleã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 33 è¡Œ ï¼šåˆ›å»º GatewayFilter ã€‚</li></ul></li><li>ç¬¬ 35 è¡Œ ï¼šè·å¾— GatewayFilter æ•°ç»„ã€‚</li></ul></li><li>ç¬¬ 37 è‡³ 40 è¡Œ ï¼šå°† GatewayFilter æ•°ç»„<strong>è½¬æ¢æˆ</strong> OrderedGatewayFilter æ•°ç»„ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 42 è¡Œ ï¼šè¿”å› GatewayFilter <strong>æ•°ç»„</strong>ã€‚</li></ul><h2 id="2-4-è·å¾—-Tuple"><a href="#2-4-è·å¾—-Tuple" class="headerlink" title="2.4 è·å¾— Tuple"></a>2.4 è·å¾— Tuple</h2><p>åœ¨çœ‹ <code>#getTuple()</code> æ–¹æ³•çš„ä»£ç å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ Tuple ã€‚</p><p>Tuple ï¼Œ<strong>å®šä¹‰</strong>å¦‚ä¸‹ ï¼š</p><blockquote><p>FROM <a href="https://unmi.cc/simple-java-tuple-datatype/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç®€å•å®ç° Java çš„ Tuple å…ƒç»„æ•°æ®ç±»å‹ã€‹</a><br>å…ƒç»„ç±»å‹ï¼Œå³ Tuple å¸¸åœ¨è„šæœ¬è¯­è¨€ä¸­å‡ºç°ï¼Œä¾‹å¦‚ Scala çš„ (â€œUnmiâ€, â€œfantasia@sina.comâ€, â€œblahblaâ€)<br>å…ƒç»„å¯è®¤ä¸ºæ˜¯è±¡æ•°ç»„ä¸€æ ·çš„å®¹å™¨ï¼Œå®ƒçš„ç›®çš„æ˜¯è®©ä½ æ–¹ä¾¿æ„é€ å’Œå¼•ç”¨ï¼Œä¾‹å¦‚ Pair å¯è®¤ä¸ºæ˜¯ä¸€ä¸ªåªèƒ½å­˜ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œåƒæ˜¯ä¸ª Map<br>çœŸæ­£çš„å…ƒç»„åº”è¯¥æ˜¯å¯ä»¥ä»»æ„å¤šä¸ªå…ƒç´ çš„å®¹å™¨ï¼Œç»•æ¥ç»•å»ï¼Œå®ƒè¿˜æ˜¯æ•°ç»„ï¼Œæˆ–åˆ—è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å®ç°ä¸Šè¿˜æ˜¯è¦å€ŸåŠ©äºæ•°ç»„æˆ–æ˜¯åˆ—è¡¨ã€‚</p></blockquote><p>æˆªæ­¢ç›®å‰ï¼ŒJava å¹¶æœªå†…ç½® Tuple çš„å®ç°ã€‚Spring æä¾›äº† <code>spring-tuple</code> <strong>ç±»åº“</strong>ï¼Œæä¾›äº† Tuple çš„æ”¯æŒã€‚ä½¿ç”¨<strong>ç¤ºä¾‹</strong>å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 1 å¯¹</span></div><div class="line">Tuple tuple = tuple().of(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line"><span class="comment">// 2 å¯¹</span></div><div class="line">Tuple tuple2 = tuple().of(<span class="string">"up"</span>, <span class="number">1</span>, <span class="string">"down"</span>, <span class="number">2</span>);</div><div class="line"><span class="comment">// 3 å¯¹</span></div><div class="line">Tuple tuple3 = tuple().of(<span class="string">"up"</span>, <span class="number">1</span>, <span class="string">"down"</span>, <span class="number">2</span>, <span class="string">"charm"</span>, <span class="number">3</span> );</div><div class="line"><span class="comment">// 4 å¯¹</span></div><div class="line">Tuple tuple4 = tuple().of(<span class="string">"up"</span>, <span class="number">1</span>, <span class="string">"down"</span>, <span class="number">2</span>, <span class="string">"charm"</span>, <span class="number">3</span>, <span class="string">"strange"</span>, <span class="number">4</span>);</div><div class="line"><span class="comment">// 6 å¯¹ ( é€‚ç”¨äºè¶…è¿‡ 4 å¯¹ )</span></div><div class="line">Tuple tuple6 = tuple().put(<span class="string">"up"</span>, <span class="number">1</span>)</div><div class="line">                      .put(<span class="string">"down"</span>, <span class="number">2</span>)</div><div class="line">              .put(<span class="string">"charm"</span>, <span class="number">3</span>)</div><div class="line">              .put(<span class="string">"strange"</span>, <span class="number">4</span>)</div><div class="line">              .put(<span class="string">"bottom"</span>, <span class="number">5</span>)</div><div class="line">              .put(<span class="string">"top"</span>, <span class="number">6</span>)</div><div class="line">              .build();</div></pre></td></tr></table></figure><ul><li>æ›´å¤š <code>spring-tuple</code> çš„æ–‡æ¡£ï¼Œè¯·è§ <a href="https://docs.spring.io/spring-xd/docs/0.1.x-SNAPSHOT/reference/html/_tuples.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Docs â€”â€” Tuplesã€‹</a> ã€‚</li></ul><hr><p>é‚£ä¹ˆ<strong>ä¸ºä»€ä¹ˆ</strong> <code>RoutePredicateFactory#apply(Tuple)</code> / <code>GatewayFilterFactory#apply(Tuple)</code> éœ€è¦ä½¿ç”¨ Tuple å‘¢ ï¼ŸRoutePredicateFactory / GatewayFilterFactory <strong>å­ç±»å®ç°ç±»</strong>éœ€è¦æˆå¯¹çš„å‚æ•°ä¸åŒï¼Œä¾‹å¦‚ ï¼š</p><ul><li><a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/SetStatusGatewayFilterFactory.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.gateway.filter.factory.SetStatusGatewayFilterFactory</code></a> ï¼Œä½¿ç”¨ <code>status</code> <strong>ä¸€å¯¹</strong>å‚æ•°ã€‚</li><li><a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/SetResponseHeaderGatewayFilterFactory.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.gateway.filter.factory.SetResponseHeaderGatewayFilterFactory</code></a> ï¼Œä½¿ç”¨ <code>name</code> / <code>value</code> <strong>ä¸¤å¯¹</strong>å‚æ•°ã€‚</li></ul><hr><p>OK ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹çœ‹ <code>#getTuple()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/* for testing */</span> <span class="function"><span class="keyword">static</span> Tuple <span class="title">getTuple</span><span class="params">(ArgumentHints hasArguments, Map&lt;String, String&gt; args, SpelExpressionParser parser, BeanFactory beanFactory)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: TupleBuilder builder = TupleBuilder.tuple();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="comment">// å‚æ•°ä¸ºç©º</span></div><div class="line"> <span class="number">5</span>: List&lt;String&gt; argNames = hasArguments.argNames();</div><div class="line"> <span class="number">6</span>: <span class="keyword">if</span> (!argNames.isEmpty()) &#123;</div><div class="line"> <span class="number">7</span>: <span class="comment">// ensure size is the same for key replacement later</span></div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (hasArguments.validateArgs() &amp;&amp; args.size() != argNames.size()) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Wrong number of arguments. Expected "</span> + argNames</div><div class="line"><span class="number">10</span>: + <span class="string">" "</span> + argNames + <span class="string">". Found "</span> + args.size() + <span class="string">" "</span> + args + <span class="string">"'"</span>);</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="comment">// åˆ›å»º Tuple</span></div><div class="line"><span class="number">15</span>: <span class="keyword">int</span> entryIdx = <span class="number">0</span>;</div><div class="line"><span class="number">16</span>: <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : args.entrySet()) &#123;</div><div class="line"><span class="number">17</span>:     <span class="comment">// è·å¾—å‚æ•° KEY</span></div><div class="line"><span class="number">18</span>: String key = entry.getKey();</div><div class="line"><span class="number">19</span>: <span class="comment">// RoutePredicateFactory has name hints and this has a fake key name</span></div><div class="line"><span class="number">20</span>: <span class="comment">// replace with the matching key hint</span></div><div class="line"><span class="number">21</span>: <span class="keyword">if</span> (key.startsWith(NameUtils.GENERATED_NAME_PREFIX) &amp;&amp; !argNames.isEmpty()</div><div class="line"><span class="number">22</span>: &amp;&amp; entryIdx &lt; args.size()) &#123;</div><div class="line"><span class="number">23</span>: key = argNames.get(entryIdx);</div><div class="line"><span class="number">24</span>: &#125;</div><div class="line"><span class="number">25</span>: <span class="comment">// è·å¾—å‚æ•° VALUE</span></div><div class="line"><span class="number">26</span>: Object value;</div><div class="line"><span class="number">27</span>: String rawValue = entry.getValue();</div><div class="line"><span class="number">28</span>: <span class="keyword">if</span> (rawValue != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>: rawValue = rawValue.trim();</div><div class="line"><span class="number">30</span>: &#125;</div><div class="line"><span class="number">31</span>: <span class="keyword">if</span> (rawValue != <span class="keyword">null</span> &amp;&amp; rawValue.startsWith(<span class="string">"#&#123;"</span>) &amp;&amp; entry.getValue().endsWith(<span class="string">"&#125;"</span>)) &#123;</div><div class="line"><span class="number">32</span>: <span class="comment">// assume it's spel</span></div><div class="line"><span class="number">33</span>: StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</div><div class="line"><span class="number">34</span>: context.setBeanResolver(<span class="keyword">new</span> BeanFactoryResolver(beanFactory));</div><div class="line"><span class="number">35</span>: Expression expression = parser.parseExpression(entry.getValue(), <span class="keyword">new</span> TemplateParserContext());</div><div class="line"><span class="number">36</span>: value = expression.getValue(context);</div><div class="line"><span class="number">37</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>: value = entry.getValue();</div><div class="line"><span class="number">39</span>: &#125;</div><div class="line"><span class="number">40</span>: <span class="comment">// æ·»åŠ  KEY / VALUE</span></div><div class="line"><span class="number">41</span>: builder.put(key, value);</div><div class="line"><span class="number">42</span>: entryIdx++;</div><div class="line"><span class="number">43</span>: &#125;</div><div class="line"><span class="number">44</span>: Tuple tuple = builder.build();</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>: <span class="comment">// æ ¡éªŒå‚æ•°</span></div><div class="line"><span class="number">47</span>: <span class="keyword">if</span> (hasArguments.validateArgs()) &#123;</div><div class="line"><span class="number">48</span>: <span class="keyword">for</span> (String name : argNames) &#123;</div><div class="line"><span class="number">49</span>: <span class="keyword">if</span> (!tuple.hasFieldName(name)) &#123;</div><div class="line"><span class="number">50</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Missing argument '"</span> + name + <span class="string">"'. Given "</span> + tuple);</div><div class="line"><span class="number">51</span>: &#125;</div><div class="line"><span class="number">52</span>: &#125;</div><div class="line"><span class="number">53</span>: &#125;</div><div class="line"><span class="number">54</span>: <span class="keyword">return</span> tuple;</div><div class="line"><span class="number">55</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>hasArguments</code> <strong>å‚æ•°</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/support/ArgumentHints.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.gateway.support.ArgumentHints</code></a> æŸ¥çœ‹ä»£ç å®ç°ã€‚RoutePredicateFactory / GatewayFilterFactory å®ç° ArgumentHints <strong>æ¥å£</strong>ã€‚</li><li>ç¬¬ 5 è‡³ 12 è¡Œ ï¼š<strong>æ ¡éªŒ</strong>å‚æ•°æ˜¯å¦æ­£ç¡®( éœ€è¦å‚æ•°<strong>éç©º</strong> )ã€‚</li><li><p>ç¬¬ 15 è‡³ 44 è¡Œ ï¼šåˆ›å»º Tuple ã€‚</p><ul><li>ç¬¬ 18 è‡³ 24 è¡Œ ï¼šè·å¾—<strong>ä¸€å¯¹</strong>å‚æ•° KEY ã€‚</li><li>ç¬¬ 26 è‡³ 39 è¡Œ ï¼šè·å¾—<strong>ä¸€å¯¹</strong>å‚æ•° VALUE ã€‚</li><li><p>ç¬¬ 41 è¡Œ ï¼šæ·»åŠ <strong>ä¸€å¯¹</strong>å‚æ•° KEY / VALUE ã€‚æˆ‘ä»¬åœ¨æ­¤å¤„æ‰“æ–­ç‚¹ï¼Œçœ‹çœ‹æ­¤æ—¶å„å˜é‡çš„å€¼ï¼Œè·¯ç”±é…ç½®å¦‚ä¸‹ ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">websocket_test</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">ws://localhost:9000</span></div><div class="line"><span class="attr">        order:</span> <span class="number">9000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/echo</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Query=foo,</span> <span class="string">ba.</span></div></pre></td></tr></table></figure><ul><li>PATH <ul><li><code>/echo</code> <img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_01/03.png" alt=""></li></ul></li><li>Query <ul><li><code>foo</code> <img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_01/04.png" alt=""></li><li><code>ba.</code> <img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_01/05.png" alt=""></li></ul></li></ul></li><li><p>ç¬¬ 44 è¡Œ ï¼šåˆ›å»º Tuple ã€‚</p></li></ul></li><li>ç¬¬ 47 è‡³ 53 è¡Œ ï¼š<strong>æ ¡éªŒ</strong>å‚æ•°æ˜¯å¦æ­£ç¡®( éœ€è¦å‚æ•°<strong>éƒ½å­˜åœ¨</strong> )ã€‚</li><li>ç¬¬ 54 è¡Œ ï¼šè¿”å› Tuple ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ©æ©ï¼Œå¹²äº†ä¸€äº›çš„æ–‡ç« ã€‚è¿™ä¸ªå‘¨æœ«è¿˜æ˜¯æœ¨æœ‰å®Œæˆè®¡åˆ’å†™çš„æ–‡ç« ã€‚ç»§ç»­åŠ æ²¹ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_02_01/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.1ï¼‰ä¹‹ RouteLocator ä¸€è§ˆ</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/</id>
    <published>2020-01-27T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">2. Route</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">3. RouteLocator</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">4. CompositeRouteLocator</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">5. CachingRouteLocator</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦å¯¹ <strong>è·¯ç”±å®šä½å™¨ RouteLocator åšæ•´ä½“çš„è®¤è¯†</strong>ã€‚</p><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.1ï¼‰ä¹‹ RouteDefinitionLocator ä¸€è§ˆã€‹</a> ä¸­ï¼Œæˆ‘ä»¬å¯¹ RouteLocator å¯¹äº†ç®€å•çš„ä»‹ç» ï¼š</p><ul><li><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_10/01.png" alt=""></li><li>RouteLocator å¯ä»¥ç›´æ¥<strong>è‡ªå®šä¹‰</strong>è·¯ç”±( <code>org.springframework.cloud.gateway.route.Route</code> ) ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ RouteDefinitionRouteLocator è·å– RouteDefinition ï¼Œå¹¶è½¬æ¢æˆ Route ã€‚ </li><li>RoutePredicateHandlerMapping ä½¿ç”¨ RouteLocator è·å¾— Route ä¿¡æ¯ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-Route"><a href="#2-Route" class="headerlink" title="2. Route"></a>2. Route</h1><p><code>org.springframework.cloud.gateway.route.Route</code> ï¼Œè·¯ç”±ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·¯ç”±ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·¯ç”±å‘çš„ URI</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URI uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¡ºåº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> order;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è°“è¯­æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Predicate&lt;ServerWebExchange&gt; predicate;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿‡æ»¤å™¨æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; gatewayFilters;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>id</code> å±æ€§ï¼ŒID ç¼–å·ï¼Œ<strong>å”¯ä¸€</strong>ã€‚</li><li><code>predicates</code> å±æ€§ï¼Œè°“è¯­æ•°ç»„ã€‚<strong>è¯·æ±‚</strong>é€šè¿‡ <code>predicates</code> åˆ¤æ–­æ˜¯å¦<strong>åŒ¹é…</strong>ã€‚</li><li><code>filters</code> å±æ€§ï¼Œè¿‡æ»¤å™¨æ•°ç»„ã€‚</li><li><code>uri</code> å±æ€§ï¼Œè·¯ç”±å‘çš„ URI ã€‚</li><li><code>order</code> å±æ€§ï¼Œé¡ºåºã€‚å½“è¯·æ±‚åŒ¹é…åˆ°å¤šä¸ªè·¯ç”±æ—¶ï¼Œä½¿ç”¨é¡ºåº<strong>å°</strong>çš„ã€‚</li><li><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_10/03.png" alt=""></li></ul><hr><p>Route å†…ç½® Builder ç±»ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/Route.java#L67" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><hr><p>Route æä¾› <code>routeDefinition</code> RouteDefinition åˆ›å»ºå¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">builder</span><span class="params">(RouteDefinition routeDefinition)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> Builder()</div><div class="line">.id(routeDefinition.getId())</div><div class="line">.uri(routeDefinition.getUri())</div><div class="line">.order(routeDefinition.getOrder());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>predicate</code> / <code>gatewayFilters</code> å±æ€§ï¼Œéœ€è¦è°ƒç”¨ Builder ç›¸å…³æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</li></ul><h1 id="3-RouteLocator"><a href="#3-RouteLocator" class="headerlink" title="3. RouteLocator"></a>3. RouteLocator</h1><p><code>org.springframework.cloud.gateway.route.RouteLocator</code> ï¼Œè·¯ç”±å®šä½å™¨<strong>æ¥å£</strong>ï¼Œå®šä¹‰è·å¾—è·¯ç”±æ•°ç»„çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteLocator</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="function">Flux&lt;Route&gt; <span class="title">getRoutes</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å¯¹ Reactor Flux æš‚æ—¶ä¸ç†Ÿæ‚‰çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯»å®Œæœ¬æ–‡ Google è¿›è¡Œå­¦ä¹ ã€‚éšç€ Spring 5 å¯¹å“åº”å¼ç¼–ç¨‹çš„æ¨å¹¿ï¼Œå‰å®³å¦‚ä½ ä¸€å®šè¦å»æŒæ¡ã€‚</li></ul><p>åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº† RouteLocator çš„å¤šä¸ªå®ç°ç±»ï¼Œç±»å›¾å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_28/01.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ CompositeRouteLocator / CachingRouteLocator çš„æºç å®ç°ã€‚å…¶ä»–çš„å®ç°ç±»ä¼šåœ¨åé¢æ–‡ç« è¯¦ç»†è§£æã€‚</li><li>è‡ªå®šä¹‰çš„ RouteLocator ï¼Œé€šè¿‡<strong>å†…éƒ¨ç±»</strong>å®ç°ï¼Œç±»å›¾æš‚æ—¶ä¸å¥½ä½“ç°ã€‚</li></ul><h1 id="4-CompositeRouteLocator"><a href="#4-CompositeRouteLocator" class="headerlink" title="4. CompositeRouteLocator"></a>4. CompositeRouteLocator</h1><p><code>org.springframework.cloud.gateway.route.CompositeRouteLocator</code> ï¼Œç»„åˆ<strong>å¤šç§</strong> RouteLocator çš„å®ç°ç±»ï¼Œä¸º RoutePredicateHandlerMapping æä¾›<strong>ç»Ÿä¸€</strong>å…¥å£è®¿é—®è·¯ç”±ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeRouteLocator</span> <span class="keyword">implements</span> <span class="title">RouteLocator</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Flux&lt;RouteLocator&gt; delegates;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CompositeRouteLocator</span><span class="params">(Flux&lt;RouteLocator&gt; delegates)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.delegates = delegates;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Flux&lt;Route&gt; <span class="title">getRoutes</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.delegates.flatMap(RouteLocator::getRoutes);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#getRoutes()</code> æ–¹æ³•ï¼Œæä¾›<strong>ç»Ÿä¸€</strong>æ–¹æ³•ï¼Œå°†ç»„åˆçš„ <code>delegates</code> çš„è·¯ç”±<strong>å…¨éƒ¨</strong>è¿”å›ã€‚</li></ul><h1 id="5-CachingRouteLocator"><a href="#5-CachingRouteLocator" class="headerlink" title="5. CachingRouteLocator"></a>5. CachingRouteLocator</h1><p><code>org.springframework.cloud.gateway.route.CachingRouteLocator</code> ï¼Œ<strong>ç¼“å­˜</strong>è·¯ç”±çš„ RouteLocator å®ç°ç±»ã€‚RoutePredicateHandlerMapping è°ƒç”¨ CachingRouteLocator çš„ <code>RouteLocator#getRoutes()</code> æ–¹æ³•ï¼Œè·å–è·¯ç”±ã€‚</p><p>CachingRouteLocator ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingRouteLocator</span> <span class="keyword">implements</span> <span class="title">RouteLocator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RouteLocator delegate;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·¯ç”±ç¼“å­˜</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;List&lt;Route&gt;&gt; cachedRoutes = <span class="keyword">new</span> AtomicReference&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachingRouteLocator</span><span class="params">(RouteLocator delegate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        <span class="keyword">this</span>.cachedRoutes.compareAndSet(<span class="keyword">null</span>, collectRoutes());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Route&gt; <span class="title">getRoutes</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.cachedRoutes.get());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Sets the new routes</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> old routes</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Route&gt; <span class="title">refresh</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.cachedRoutes.getAndUpdate(</div><div class="line">routes -&gt; CachingRouteLocator.<span class="keyword">this</span>.collectRoutes()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> List&lt;Route&gt; <span class="title">collectRoutes</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;Route&gt; routes = <span class="keyword">this</span>.delegate.getRoutes().collectList().block();</div><div class="line">        <span class="comment">// æ’åº</span></div><div class="line">        AnnotationAwareOrderComparator.sort(routes);</div><div class="line">        <span class="keyword">return</span> routes;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@EventListener</span>(RefreshRoutesEvent.class)</div><div class="line">    <span class="comment">/* for testing */</span> <span class="function"><span class="keyword">void</span> <span class="title">handleRefresh</span><span class="params">()</span> </span>&#123;</div><div class="line">        refresh();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>cachedRoutes</code> å±æ€§ï¼Œè·¯ç”±<strong>ç¼“å­˜</strong>ã€‚</li><li>CachingRouteLocator <strong>æ„é€ </strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>#collectRoutes()</code> æ–¹æ³•è·å¾—è·¯ç”±ï¼Œå¹¶ç¼“å­˜åˆ° <code>cachedRoutes</code> å±æ€§ã€‚</li><li><code>#collectRoutes()</code> æ–¹æ³•ï¼Œä» <code>delegate</code> è·å–è·¯ç”±æ•°ç»„ã€‚</li><li><code>#getRoutes()</code> æ–¹æ³•ï¼Œè¿”å›è·¯ç”±<strong>ç¼“å­˜</strong>ã€‚</li><li><code>#refresh()</code> æ–¹æ³•ï¼Œåˆ·æ–°<strong>ç¼“å­˜</strong> <code>cachedRoutes</code> å±æ€§ã€‚</li><li><code>#handleRefresh()</code> æ–¹æ³•ï¼Œç›‘å¬ <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RefreshRoutesEvent.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.context.ApplicationEvent.RefreshRoutesEvent</code></a> äº‹ä»¶ï¼Œåˆ·æ–°<strong>ç¼“å­˜</strong>ã€‚</li></ul><hr><p>GatewayWebfluxEndpoint æœ‰<strong>ä¸€ä¸ª</strong> HTTP API è°ƒç”¨äº† ApplicationEventPublisher ï¼Œå‘å¸ƒ RefreshRoutesEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;management.context-path:/application&#125;/gateway"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayWebfluxEndpoint</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * åº”ç”¨äº‹ä»¶å‘å¸ƒå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</div><div class="line"></div><div class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/refresh"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">refresh</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</div><div class="line">        <span class="keyword">return</span> Mono.empty();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>POST &quot;/refresh</code> ï¼Œå‘å¸ƒ RefreshRoutesEvent äº‹ä»¶ã€‚CachingRouteLocator ç›‘å¬åˆ°è¯¥äº‹ä»¶ï¼Œåˆ·æ–°ç¼“å­˜ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>åˆæ˜¯æ¯”è¾ƒå¹²çˆ½( æ°´æ›´ )çš„ä¸€ç¯‡æ–‡ç« ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_28/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gateway/route-locat
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.4ï¼‰ä¹‹ DiscoveryClientRouteDefinitionLocator æ³¨å†Œä¸­å¿ƒ</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/</id>
    <published>2020-01-24T16:00:00.000Z</published>
    <updated>2017-12-01T14:02:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/">3. DiscoveryClientRouteDefinitionLocator</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/">4. é«˜èƒ½</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦å¯¹ <strong>DiscoveryClientRouteDefinitionLocator çš„æºç å®ç°</strong>ã€‚</p><p>DiscoveryClientRouteDefinitionLocator é€šè¿‡è°ƒç”¨ <code>org.springframework.cloud.client.discovery.DiscoveryClient</code> è·å–æ³¨å†Œåœ¨æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åˆ—è¡¨ï¼Œç”Ÿæˆå¯¹åº”çš„ RouteDefinition æ•°ç»„ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-ç¯å¢ƒæ­å»º"><a href="#2-ç¯å¢ƒæ­å»º" class="headerlink" title="2. ç¯å¢ƒæ­å»º"></a>2. ç¯å¢ƒæ­å»º</h1><p>åœ¨è§£ææºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»¥ Eureka ä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè®²è§£ä¸‹å¦‚ä½•é…ç½® DiscoveryClientRouteDefinitionLocator ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œä»¥ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ä¸ºåŸºç¡€ï¼Œåœ¨ <code>pom.xml</code> æ–‡ä»¶æ·»åŠ ä¾èµ–åº“ã€‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.M1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><ul><li>æ³¨æ„ï¼Œéœ€è¦æ’é™¤ <code>spring-boot-starter-web</code> çš„ä¾èµ–ï¼Œé¿å…å’Œ Spring Cloud Gateway ä¾èµ–çš„ <code>spring-boot-starter-webflux</code> å†²çªã€‚</li></ul><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ <code>application.yml</code> æ·»åŠ  Eureka ç›¸å…³é…ç½® ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">juejin-gateway</span></div><div class="line"></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  instance:</span></div><div class="line"><span class="attr">    leaseRenewalIntervalInSeconds:</span> <span class="number">10</span></div><div class="line"><span class="attr">    leaseExpirationDurationInSeconds:</span> <span class="number">30</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    serviceUrl:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka.didispace.com/eureka/</span></div></pre></td></tr></table></figure><ul><li>å¦‚æœä½ <strong>â€œæ‡’â€</strong>çš„å¯åŠ¨ Eureka ï¼Œæ¨èä½¿ç”¨ <a href="http://eureka.didispace.com/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç¨‹åºçŒ¿DD - å…¬ç›Š - EUREKA SERVERã€‹</a> ã€‚æ„Ÿè°¢ <strong>1024</strong> ã€‚</li></ul><p>ç¬¬ä¸‰æ­¥ï¼Œåœ¨ <code>org.springframework.cloud.gateway.sample.GatewaySampleApplication</code> <strong>ç±»</strong>é‡Œï¼Œæ·»åŠ  RouteDefinitionLocator Bean é…ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">// &#123;@link DiscoveryClientRouteDefinitionLocator&#125;</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewaySampleApplication</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RouteDefinitionLocator <span class="title">discoveryClientRouteDefinitionLocator</span><span class="params">(DiscoveryClient discoveryClient)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DiscoveryClientRouteDefinitionLocator(discoveryClient);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç¬¬å››æ­¥ï¼Œå¯åŠ¨ä¸€ä¸ªæ³¨å†Œåœ¨ Eureka çš„åº”ç”¨æœåŠ¡ã€‚æœºæ™ºå¦‚ä½ ï¼Œè¿™é‡Œæˆ‘å°±ä¸å•°å—¦è½ã€‚</p><p>ç¬¬äº”æ­¥ï¼Œåœ¨ DiscoveryClientRouteDefinitionLocator çš„ <code>#getRouteDefinitions()</code> æ–¹æ³•æ‰“<strong>æ–­ç‚¹</strong>ï¼Œè°ƒè¯•å¯åŠ¨ <code>spring-cloud-gateway-sample</code> ã€‚å°åŠŸå‘Šæˆã€‚æ’’èŠ±~</p><h1 id="3-DiscoveryClientRouteDefinitionLocator"><a href="#3-DiscoveryClientRouteDefinitionLocator" class="headerlink" title="3. DiscoveryClientRouteDefinitionLocator"></a>3. DiscoveryClientRouteDefinitionLocator</h1><p><code>org.springframework.cloud.gateway.discovery.DiscoveryClientRouteDefinitionLocator</code> ï¼Œé€šè¿‡è°ƒç”¨ DiscoveryClient è·å–æ³¨å†Œåœ¨æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åˆ—è¡¨ï¼Œç”Ÿæˆå¯¹åº”çš„ RouteDefinition æ•°ç»„ã€‚</p><p>ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClientRouteDefinitionLocator</span> <span class="keyword">implements</span> <span class="title">RouteDefinitionLocator</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> String routeIdPrefix;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> <span class="title">DiscoveryClientRouteDefinitionLocator</span><span class="params">(DiscoveryClient discoveryClient)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: <span class="keyword">this</span>.discoveryClient = discoveryClient;</div><div class="line"> <span class="number">8</span>: <span class="keyword">this</span>.routeIdPrefix = <span class="keyword">this</span>.discoveryClient.getClass().getSimpleName() + <span class="string">"_"</span>;</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> Flux.fromIterable(discoveryClient.getServices())</div><div class="line"><span class="number">14</span>: .map(serviceId -&gt; &#123;</div><div class="line"><span class="number">15</span>: RouteDefinition routeDefinition = <span class="keyword">new</span> RouteDefinition();</div><div class="line"><span class="number">16</span>: <span class="comment">// è®¾ç½® ID</span></div><div class="line"><span class="number">17</span>: routeDefinition.setId(<span class="keyword">this</span>.routeIdPrefix + serviceId);</div><div class="line"><span class="number">18</span>: <span class="comment">// è®¾ç½® URI</span></div><div class="line"><span class="number">19</span>: routeDefinition.setUri(URI.create(<span class="string">"lb://"</span> + serviceId));</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">// add a predicate that matches the url at /serviceId</span></div><div class="line"><span class="number">22</span>: <span class="comment">/*PredicateDefinition barePredicate = new PredicateDefinition();</span></div><div class="line"><span class="comment">23: barePredicate.setName(normalizePredicateName(PathRoutePredicateFactory.class));</span></div><div class="line"><span class="comment">24: barePredicate.addArg(PATTERN_KEY, "/" + serviceId);</span></div><div class="line"><span class="comment">25: routeDefinition.getPredicates().add(barePredicate);*/</span></div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">// æ·»åŠ  Path åŒ¹é…æ–­è¨€</span></div><div class="line"><span class="number">28</span>: <span class="comment">// add a predicate that matches the url at /serviceId/**</span></div><div class="line"><span class="number">29</span>: PredicateDefinition subPredicate = <span class="keyword">new</span> PredicateDefinition();</div><div class="line"><span class="number">30</span>: subPredicate.setName(normalizePredicateName(PathRoutePredicateFactory.class));</div><div class="line"><span class="number">31</span>: subPredicate.addArg(PATTERN_KEY, <span class="string">"/"</span> + serviceId + <span class="string">"/**"</span>);</div><div class="line"><span class="number">32</span>: routeDefinition.getPredicates().add(subPredicate);</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="comment">//<span class="doctag">TODO:</span> support for other default predicates</span></div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">// æ·»åŠ  Path é‡å†™è¿‡æ»¤å™¨</span></div><div class="line"><span class="number">37</span>: <span class="comment">// add a filter that removes /serviceId by default</span></div><div class="line"><span class="number">38</span>: FilterDefinition filter = <span class="keyword">new</span> FilterDefinition();</div><div class="line"><span class="number">39</span>: filter.setName(normalizeFilterName(RewritePathGatewayFilterFactory.class));</div><div class="line"><span class="number">40</span>: String regex = <span class="string">"/"</span> + serviceId + <span class="string">"/(?&lt;remaining&gt;.*)"</span>;</div><div class="line"><span class="number">41</span>: String replacement = <span class="string">"/$&#123;remaining&#125;"</span>;</div><div class="line"><span class="number">42</span>: filter.addArg(REGEXP_KEY, regex);</div><div class="line"><span class="number">43</span>: filter.addArg(REPLACEMENT_KEY, replacement);</div><div class="line"><span class="number">44</span>: routeDefinition.getFilters().add(filter);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>: <span class="comment">//<span class="doctag">TODO:</span> support for default filters</span></div><div class="line"><span class="number">47</span>: </div><div class="line"><span class="number">48</span>: <span class="keyword">return</span> routeDefinition;</div><div class="line"><span class="number">49</span>: &#125;);</div><div class="line"><span class="number">50</span>: &#125;</div><div class="line"><span class="number">51</span>: &#125;</div></pre></td></tr></table></figure><ul><li><code>discoveryClient</code> å±æ€§ï¼Œæ³¨å†Œå‘ç°å®¢æˆ·ç«¯ï¼Œç”¨äºå‘æ³¨å†Œä¸­å¿ƒå‘èµ·è¯·æ±‚ã€‚</li><li><code>routeIdPrefix</code> å±æ€§ï¼Œè·¯ç”±é…ç½®ç¼–å·å‰ç¼€ï¼Œä»¥ DiscoveryClient ç±»å + <code>_</code> ã€‚</li><li>ç¬¬ 13 è¡Œ ï¼šè°ƒç”¨ <code>discoveryClient</code> è·å–æ³¨å†Œåœ¨æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åˆ—è¡¨ã€‚</li><li>ç¬¬ 14 è¡Œ ï¼šéå†æœåŠ¡åˆ—è¡¨ï¼Œç”Ÿæˆå¯¹åº”çš„ RouteDefinition æ•°ç»„ã€‚</li><li>ç¬¬ 16 è¡Œ ï¼šè®¾ç½® <code>RouteDefinition.id</code> ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šè®¾ç½® <code>RouteDefinition.uri</code> ï¼Œæ ¼å¼ä¸º <code>lb://${serviceId}</code> ã€‚åœ¨ LoadBalancerClientFilter ä¼šæ ¹æ® <code>lb://</code> å‰ç¼€è¿‡æ»¤å¤„ç†ï¼Œè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©æœ€ç»ˆè°ƒç”¨çš„æœåŠ¡åœ°å€ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.4) ä¹‹ LoadBalancerClientFilter è´Ÿè½½å‡è¡¡ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 27 è‡³ 32 è¡Œ ï¼šä½¿ç”¨ PathRoutePredicateFactory åˆ›å»º Path åŒ¹é…æ–­è¨€ã€‚<ul><li>ä¾‹å¦‚æœåŠ¡çš„ <code>serviceId = spring.application.name = juejin-sample</code> ï¼Œé€šè¿‡<strong>ç½‘å…³</strong> <code>http://${gateway}/${serviceId}/some_api</code> è®¿é—®<strong>æœåŠ¡</strong> <code>http://some_api</code> ã€‚</li><li>PathRoutePredicateFactory åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/handler-route-predicate-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” å¤„ç†å™¨ (3.1) ä¹‹ RoutePredicateFactory  è·¯ç”±è°“è¯­å·¥å‚ã€‹ã€Œ10. PathRoutePredicateFactoryã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 36 è‡³ 44 è¡Œ ï¼šä½¿ç”¨ RewritePathGatewayFilterFactory åˆ›å»ºé‡å†™ç½‘å…³è¿‡æ»¤å™¨ï¼Œç”¨äºç§»é™¤è¯·æ±‚è·¯å¾„é‡Œçš„ <code>/${serviceId}</code> ã€‚å¦‚æœä¸ç§»é™¤ï¼Œæœ€ç»ˆè¯·æ±‚ä¸åˆ°æœåŠ¡ã€‚RewritePathGatewayFilterFactory åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹ã€Œ4.1 RewritePathGatewayFilterFactoryã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 48 è¡Œ ï¼šè¿”å›è·¯ç”±å®šä¹‰ RouteDefinition ã€‚ä¸¾ä¸ª RouteDefinition ä¾‹å­ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_25/01.png" alt=""></li></ul><h1 id="4-é«˜èƒ½"><a href="#4-é«˜èƒ½" class="headerlink" title="4. é«˜èƒ½"></a>4. é«˜èƒ½</h1><p>æœ¬å°èŠ‚å»ºè®®é˜…è¯»å®Œ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.1ï¼‰ä¹‹ RouteLocator ä¸€è§ˆã€‹</a> å†ç†è§£ã€‚</p><p>RoutePredicateHandlerMapping ä½¿ç”¨ CachingRouteLocator æ¥è·å– Route ä¿¡æ¯ã€‚åœ¨ Spring Cloud Gateway å¯åŠ¨åï¼Œå¦‚æœæœ‰æ–°åŠ å…¥çš„æœåŠ¡ï¼Œåˆ™éœ€è¦åˆ·æ–° CachingRouteLocator <strong>ç¼“å­˜</strong>ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦<strong>æ³¨æ„</strong>ä¸‹ ï¼šæ–°åŠ å…¥çš„æœåŠ¡ï¼ŒæŒ‡çš„æ˜¯æ–°çš„ <code>serviceId</code> ï¼Œè€Œä¸æ˜¯åŸæœ‰æœåŠ¡æ–°å¢çš„å®ä¾‹ã€‚</p><p>ä¸ªäººå»ºè®®ï¼Œå†™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œé—´éš”è°ƒç”¨ DiscoveryClient è·å–æœåŠ¡åˆ—è¡¨ï¼Œè‹¥å‘ç°<strong>å˜åŒ–</strong>ï¼Œåˆ·æ–° CachingRouteLocator <strong>ç¼“å­˜</strong>ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ æ»¡è¶³ã€‚ä¸»è¦å› ä¸º <a href="#">ã€Œ4. é«˜èƒ½ã€</a> è¿™å°èŠ‚ï¼ŒåŸæ¥è¿˜æ˜¯éå¸¸æ‹…å¿ƒæœåŠ¡åˆ—è¡¨çš„ç¼“å­˜ä¸åˆ·æ–°é—®é¢˜ï¼Œå¦‚æœä¸è§£å†³ï¼Œç½‘å…³åŸºæœ¬å±äºä¸å¯ç”¨çš„çŠ¶æ€ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_25/02.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/&quot;&gt;http://www.iocoder.cn/Spring-Clou
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.3ï¼‰ä¹‹ RouteDefinitionRepository å­˜å‚¨å™¨</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/</id>
    <published>2020-01-19T16:00:00.000Z</published>
    <updated>2017-12-01T14:01:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">2. RouteDefinitionWriter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">3. RouteDefinitionRepository</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">4. InMemoryRouteDefinitionRepository</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">5. GatewayWebfluxEndpoint</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">6. è‡ªå®šä¹‰ RouteDefinitionRepository</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦å¯¹ <strong>RouteDefinitionRepository çš„æºç å®ç°</strong>ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_20/01.jpeg" alt=""></p><ul><li><strong>è“è‰²</strong>éƒ¨åˆ† ï¼šRouteDefinitionRepository ã€‚</li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å›¾å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_20/02.png" alt=""></p><ul><li>ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸ªç±»è¿›è¡Œè§£æã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-RouteDefinitionWriter"><a href="#2-RouteDefinitionWriter" class="headerlink" title="2. RouteDefinitionWriter"></a>2. RouteDefinitionWriter</h1><p><code>org.springframework.cloud.gateway.route.RouteDefinitionWriter</code> ï¼Œè·¯ç”±é…ç½®å†™å…¥<strong>æ¥å£</strong>ã€‚è¯¥æ¥å£å®šä¹‰äº†<strong>ä¿å­˜</strong>ä¸<strong>åˆ é™¤</strong>ä¸¤ä¸ªæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteDefinitionWriter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¿å­˜è·¯ç”±é…ç½®</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> route è·¯ç”±é…ç½®</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> Mono&lt;Void&gt;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">save</span><span class="params">(Mono&lt;RouteDefinition&gt; route)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ é™¤è·¯ç”±é…ç½®</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> routeId è·¯ç”±ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> Mono&lt;Void&gt;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">delete</span><span class="params">(Mono&lt;String&gt; routeId)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¯¥æ¥å£æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</li></ul><h1 id="3-RouteDefinitionRepository"><a href="#3-RouteDefinitionRepository" class="headerlink" title="3. RouteDefinitionRepository"></a>3. RouteDefinitionRepository</h1><p><code>org.springframework.cloud.gateway.route.RouteDefinitionRepository</code> ï¼Œå­˜å‚¨å™¨ RouteDefinitionLocator <strong>æ¥å£</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteDefinitionRepository</span> <span class="keyword">extends</span> <span class="title">RouteDefinitionLocator</span>, <span class="title">RouteDefinitionWriter</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç»§æ‰¿ RouteDefinitionLocator <strong>æ¥å£</strong>ã€‚</li><li>ç»§æ‰¿ RouteDefinitionWriter <strong>æ¥å£</strong>ã€‚</li></ul><p>é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œå®ç°ä»<strong>å­˜å‚¨å™¨</strong>( ä¾‹å¦‚ï¼Œå†…å­˜ / Redis / MySQL ç­‰ )è¯»å–ã€ä¿å­˜ã€åˆ é™¤è·¯ç”±é…ç½®ã€‚</p><p>ç›®å‰ Spring Cloud Gateway å®ç°äº†<strong>åŸºäºå†…å­˜ä¸ºå­˜å‚¨å™¨</strong>çš„ InMemoryRouteDefinitionRepository ã€‚</p><h1 id="4-InMemoryRouteDefinitionRepository"><a href="#4-InMemoryRouteDefinitionRepository" class="headerlink" title="4. InMemoryRouteDefinitionRepository"></a>4. InMemoryRouteDefinitionRepository</h1><p><code>org.springframework.cloud.gateway.route.InMemoryRouteDefinitionRepository</code> ï¼Œ<strong>åŸºäºå†…å­˜ä¸ºå­˜å‚¨å™¨</strong>çš„ RouteDefinitionLocator ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRouteDefinitionRepository</span> <span class="keyword">implements</span> <span class="title">RouteDefinitionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·¯ç”±é…ç½®æ˜ å°„</span></div><div class="line"><span class="comment">     * key ï¼šè·¯ç”±ç¼–å· &#123;<span class="doctag">@link</span> RouteDefinition#id&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RouteDefinition&gt; routes = synchronizedMap(<span class="keyword">new</span> LinkedHashMap&lt;String, RouteDefinition&gt;());</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">save</span><span class="params">(Mono&lt;RouteDefinition&gt; route)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> route.flatMap( r -&gt; &#123;</div><div class="line">            routes.put(r.getId(), r);</div><div class="line">            <span class="keyword">return</span> Mono.empty();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">delete</span><span class="params">(Mono&lt;String&gt; routeId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> routeId.flatMap(id -&gt; &#123;</div><div class="line">            <span class="keyword">if</span> (routes.containsKey(id)) &#123;</div><div class="line">                routes.remove(id);</div><div class="line">                <span class="keyword">return</span> Mono.empty();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> NotFoundException(<span class="string">"RouteDefinition not found: "</span>+routeId));</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Flux.fromIterable(routes.values());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç…ç…å°±å¥½ã€‚</li><li><code>InMemoryRouteDefinitionRepository#getRouteDefinitions()</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å·²ç»åœ¨ CompositeRouteDefinitionLocator çœ‹åˆ°ã€‚</li><li><code>InMemoryRouteDefinitionRepository#save()</code> / <code>InMemoryRouteDefinitionRepository#delete()</code> æ–¹æ³•ï¼Œä¸‹é¢åœ¨ GatewayWebfluxEndpoint å¯ä»¥çœ‹åˆ°ã€‚</li></ul><h1 id="5-GatewayWebfluxEndpoint"><a href="#5-GatewayWebfluxEndpoint" class="headerlink" title="5. GatewayWebfluxEndpoint"></a>5. GatewayWebfluxEndpoint</h1><p><code>org.springframework.cloud.gateway.actuate.GatewayWebfluxEndpoint</code> ï¼Œæä¾›<strong>ç®¡ç†</strong>ç½‘å…³çš„ HTTP API ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;management.context-path:/application&#125;/gateway"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayWebfluxEndpoint</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å­˜å‚¨å™¨ RouteDefinitionLocator å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»æ³¨è§£ <code>@RestController</code> æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼ŒGatewayWebfluxEndpoint æ˜¯ä¸€ä¸ª <strong>Controller</strong> ã€‚</li></ul><p>GatewayWebfluxEndpoint æœ‰<strong>ä¸¤ä¸ª</strong> HTTP API è°ƒç”¨äº† RouteDefinitionWriter çš„<strong>ä¸¤ä¸ª</strong>æ–¹æ³•ã€‚</p><ul><li><p><code>POST &quot;/routes/{id}&quot;</code> ï¼Œä¿å­˜è·¯ç”±é…ç½®ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@PostMapping</span>(<span class="string">"/routes/&#123;id&#125;"</span>)</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Void&gt;&gt; save(<span class="meta">@PathVariable</span> String id, <span class="meta">@RequestBody</span> Mono&lt;RouteDefinition&gt; route) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.save(route.map(r -&gt;  &#123; <span class="comment">// è®¾ç½® ID</span></div><div class="line">r.setId(id);</div><div class="line">log.debug(<span class="string">"Saving route: "</span> + route);</div><div class="line"><span class="keyword">return</span> r;</div><div class="line">&#125;)).then(Mono.defer(() -&gt; <span class="comment">// status ï¼š201 ï¼Œåˆ›å»ºæˆåŠŸã€‚å‚è§ HTTP è§„èŒƒ ï¼šhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Status/201</span></div><div class="line">Mono.just(ResponseEntity.created(URI.create(<span class="string">"/routes/"</span>+id)).build())</div><div class="line">));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>ä¾‹å¦‚ï¼ŒHTTP è¯·æ±‚å¦‚ä¸‹ ï¼š</p><blockquote><p>http POST :8080/application/gateway/routes/apiaddreqhead uri=<a href="http://httpbin.org:80" rel="external nofollow noopener noreferrer" target="_blank">http://httpbin.org:80</a> predicates:=â€™[â€œHost=**.apiaddrequestheader.orgâ€, â€œPath=/headersâ€]â€™ filters:=â€™[â€œAddRequestHeader=X-Request-ApiFoo, ApiBarâ€]â€™    </p></blockquote></li></ul></li><li><p><code>DELETE &quot;/routes/{id}&quot;</code> ï¼Œåˆ é™¤è·¯ç”±é…ç½®ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DeleteMapping</span>(<span class="string">"/routes/&#123;id&#125;"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(<span class="meta">@PathVariable</span> String id) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</div><div class="line">.then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build()))) <span class="comment">// åˆ é™¤æˆåŠŸ</span></div><div class="line">.onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build())); <span class="comment">// åˆ é™¤å¤±è´¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h1 id="6-è‡ªå®šä¹‰-RouteDefinitionRepository"><a href="#6-è‡ªå®šä¹‰-RouteDefinitionRepository" class="headerlink" title="6. è‡ªå®šä¹‰ RouteDefinitionRepository"></a>6. è‡ªå®šä¹‰ RouteDefinitionRepository</h1><p>ä½¿ç”¨ InMemoryRouteDefinitionRepository æ¥ç»´æŠ¤ RouteDefinition ä¿¡æ¯ï¼Œåœ¨ç½‘å…³å®ä¾‹é‡å¯æˆ–è€…å´©æºƒåï¼ŒRouteDefinition å°±ä¼šä¸¢å¤±ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å®ç° RouteDefinitionRepository <strong>æ¥å£</strong>ï¼Œä»¥å®ç°ä¾‹å¦‚ MySQLRouteDefinitionRepository ã€‚</p><p>é€šè¿‡ç±»ä¼¼ MySQL ç­‰<strong>æŒä¹…åŒ–</strong>ã€<strong>å¯å…±äº«</strong>çš„å­˜å‚¨å™¨ï¼Œä¹Ÿå¯ä»¥å¸¦æ¥ Spring Cloud Gateway å®ä¾‹<strong>é›†ç¾¤</strong>è·å¾—ä¸€è‡´çš„ã€ç›¸åŒçš„ RouteDefinition ä¿¡æ¯ã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬çœ‹åˆ° RouteDefinitionRepository åˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// GatewayAutoConfiguration.java</span></div><div class="line"><span class="meta">@Bean</span> <span class="comment">// 4.2</span></div><div class="line"><span class="meta">@ConditionalOnMissingBean</span>(RouteDefinitionRepository.class)</div><div class="line"><span class="function"><span class="keyword">public</span> InMemoryRouteDefinitionRepository <span class="title">inMemoryRouteDefinitionRepository</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> InMemoryRouteDefinitionRepository();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ³¨è§£ <code>@ConditionalOnMissingBean(RouteDefinitionRepository.class)</code> ï¼Œå½“<strong>ä¸å­˜åœ¨</strong> RouteDefinitionRepository çš„ Bean å¯¹è±¡æ—¶ï¼Œåˆå§‹åŒ– InMemoryRouteDefinitionRepository ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆå§‹åŒ–è‡ªå®šä¹‰çš„ RouteDefinitionRepository ä»¥<strong>â€œæ³¨å…¥â€</strong> ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯”è¾ƒå¹²çˆ½( æ°´æ›´ )çš„ä¸€ç¯‡æ–‡ç« ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_20/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gat
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.2ï¼‰ä¹‹ PropertiesRouteDefinitionLocator é…ç½®æ–‡ä»¶</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/</id>
    <published>2020-01-14T16:00:00.000Z</published>
    <updated>2017-12-01T14:01:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/">http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.x M4</strong>  </p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/">2. PropertiesRouteDefinitionLocator</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/">3. GatewayProperties</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦å¯¹ <strong>PropertiesRouteDefinitionLocator çš„æºç å®ç°</strong>ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_15/01.jpeg" alt=""></p><ul><li><strong>è“è‰²</strong>éƒ¨åˆ† ï¼šPropertiesRouteDefinitionLocator ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1 id="2-PropertiesRouteDefinitionLocator"><a href="#2-PropertiesRouteDefinitionLocator" class="headerlink" title="2. PropertiesRouteDefinitionLocator"></a>2. PropertiesRouteDefinitionLocator</h1><p><code>org.springframework.cloud.gateway.config.PropertiesRouteDefinitionLocator</code> ï¼Œä»<strong>é…ç½®æ–‡ä»¶</strong>( ä¾‹å¦‚ï¼ŒYML / Properties ç­‰ ) è¯»å–è·¯ç”±é…ç½®ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesRouteDefinitionLocator</span> <span class="keyword">implements</span> <span class="title">RouteDefinitionLocator</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> GatewayProperties properties;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">PropertiesRouteDefinitionLocator</span><span class="params">(GatewayProperties properties)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.properties = properties;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.properties.getRoutes());</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#getRouteDefinitions()</code> æ–¹æ³•ï¼Œä» <strong>GatewayProperties</strong> è·å–è·¯ç”±é…ç½®æ•°ç»„ã€‚</li></ul><h1 id="3-GatewayProperties"><a href="#3-GatewayProperties" class="headerlink" title="3. GatewayProperties"></a>3. GatewayProperties</h1><p><code>org.springframework.cloud.gateway.config.GatewayProperties</code> ï¼Œä»é…ç½®æ–‡ä»¶<strong>è¯»å–</strong> ï¼š</p><ul><li>è·¯ç”±é…ç½®</li><li><strong>é»˜è®¤</strong>è¿‡æ»¤å™¨é…ç½®ã€‚å½“ RouteDefinition =&gt; Route æ—¶ï¼Œä¼šå°†è¿‡æ»¤å™¨é…ç½®æ·»åŠ åˆ°<strong>æ¯ä¸ª</strong> Route ã€‚</li></ul><p>GatewayProperties ä»£ç å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"spring.cloud.gateway"</span>)</div><div class="line"><span class="meta">@Validated</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayProperties</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * List of Routes</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@NotNull</span></div><div class="line"><span class="meta">@Valid</span></div><div class="line"><span class="keyword">private</span> List&lt;RouteDefinition&gt; routes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * List of filter definitions that are applied to every route.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> List&lt;FilterDefinition&gt; defaultFilters = loadDefaults();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ArrayList&lt;FilterDefinition&gt; <span class="title">loadDefaults</span><span class="params">()</span> </span>&#123;</div><div class="line">ArrayList&lt;FilterDefinition&gt; defaults = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">FilterDefinition definition = <span class="keyword">new</span> FilterDefinition();</div><div class="line">definition.setName(normalizeFilterName(RemoveNonProxyHeadersGatewayFilterFactory.class));</div><div class="line">defaults.add(definition);</div><div class="line"><span class="keyword">return</span> defaults;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>routes</code> å±æ€§ï¼Œè·¯ç”±é…ç½®ã€‚é€šè¿‡ <code>spring.cloud.gateway.routes</code> é…ç½®ã€‚ä»¥ YAML é…ç½®æ–‡ä»¶ä¸¾ä¾‹å­ ï¼š </p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="bullet">      -</span> <span class="string">host_example_to_httpbin=$&#123;test.uri&#125;,</span> <span class="string">Host=**.example.org</span></div><div class="line"></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">host_foo_path_headers_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="string">$&#123;test.uri&#125;</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Host=**.foo.org</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/headers</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Method=GET</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Query=foo,</span> <span class="string">ba.</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Query=baz</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Cookie=chocolate,</span> <span class="string">ch.p</span></div><div class="line"><span class="bullet">        -</span> <span class="string">After=1900-01-20T17:42:47.789-07:00[America/Denver]</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">AddResponseHeader=X-Response-Foo,</span> <span class="string">Bar</span></div><div class="line"></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">add_request_header_test</span></div><div class="line"><span class="attr">        uri:</span> <span class="string">$&#123;test.uri&#125;</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Host=**.addrequestheader.org</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/headers</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">AddRequestHeader=X-Request-Foo,</span> <span class="string">Bar</span></div></pre></td></tr></table></figure><ul><li>æ›´å¤šä¾‹å­ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/test/resources/application.yml#L15" rel="external nofollow noopener noreferrer" target="_blank">application.yml</a> æŸ¥çœ‹ã€‚</li></ul></li><li><p><code>defaultFilters</code> å±æ€§ï¼Œ<strong>é»˜è®¤</strong>è¿‡æ»¤å™¨é…ç½®ã€‚é€šè¿‡ <code>spring.cloud.gateway.default-filters</code> é…ç½®ã€‚ä»¥ YAML é…ç½®æ–‡ä»¶ä¸¾ä¾‹å­ ï¼š</p>  <figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      default-filters:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">AddResponseHeader=X-Response-Default-Foo,</span> <span class="string">Default-Bar</span></div><div class="line"><span class="bullet">      -</span> <span class="string">PrefixPath=/httpbin</span></div></pre></td></tr></table></figure><ul><li>æ›´å¤šä¾‹å­ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/spring-cloud-gateway/blob/382a4cd98fbb8ac53a83a5559bacb0f885838074/spring-cloud-gateway-core/src/test/resources/application.yml#L10" rel="external nofollow noopener noreferrer" target="_blank">application.yml</a> æŸ¥çœ‹ã€‚</li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>TODO ã€3017ã€‘ ä¸ Spring Cloud Config ç»“åˆ</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_01_15/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-properties/&quot;&gt;http://www.iocoder.cn/Spring-Cloud-Gat
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
</feed>
