<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-10-26T12:43:08.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hystrix æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/Hystrix/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/Hystrix/build-debugging-environment/</id>
    <published>2018-09-30T16:00:00.000Z</published>
    <updated>2017-10-26T12:43:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">1. ä¾èµ–å·¥å…·</a></li><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">2. æºç æ‹‰å–</a></li><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">3. è¿è¡Œç¤ºä¾‹</a></li><li><a href="http://www.iocoder.cn/Hystrix/build-debugging-environment/">4. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. ä¾èµ–å·¥å…·</h1><ul><li>Gradle</li><li>JDK</li><li>IntelliJ IDEA</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/Netflix/Hystrix.git" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/Hystrix.git</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚åœ¨é¡¹ç›®è·¯å¾„ä¸‹ï¼Œåœ¨<strong>å‘½ä»¤è¡Œ</strong>æ‰§è¡Œ <code>./gradlew</code> å‘½ä»¤ï¼Œ<code>Gradle</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚å…¶é—´å¯èƒ½ä¼šå‡ºç°å› ä¸ºç½‘ç»œåŸå› ( æˆ‘ç›¸ä¿¡ä½ æ‡‚çš„ )ï¼Œå¯èƒ½ä¼šå‡ºç°å¤±è´¥çš„æƒ…å†µï¼Œæ·¡å®šï¼Œé‡æ–°æ‰§è¡Œä¸Šè¿°å‘½ä»¤ç›´åˆ°æˆåŠŸã€‚æ­¤åˆ»ï¼Œä½ å°±æ˜¯ä¸€ä¸ª <code>while(true)</code> çš„å°å¼ºã€‚</p><p>æœ¬æ–‡åŸºäº <code>master</code> åˆ†æ”¯ã€‚</p><h1>3. è¿è¡Œç¤ºä¾‹</h1><p>åœ¨ <code>hystrix-examples</code> å­é¡¹ç›®ä¸‹ï¼Œæä¾›äº†<strong>å¤§é‡</strong>çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Hystrix/2018_10_01/01.png" alt=""></p><ul><li><code>basic</code> åŒ… ï¼šé’ˆå¯¹ Hystrix æ¯ä¸ªç‰¹æ€§æä¾›å°çš„å•å…ƒæµ‹è¯•ç¤ºä¾‹ã€‚ä½ å¯ä»¥ä» CommandHelloWorld å¼€å§‹å°è¯•ã€‚</li><li><code>demo</code> åŒ… ï¼šç»“åˆå®é™…åœºæ™¯çš„å®æˆ˜å°ä¾‹å­ã€‚è¿è¡Œå…¥å£ä¸º HystrixCommandDemo æˆ–è€… HystrixCommandAsyncDemo ã€‚æ©ï¼Œèªæ…§å¦‚ä½ ï¼Œä»åå­—èƒ½çœ‹å‡ºå®ƒä»¬çš„åŒºåˆ«ç‚¹ã€‚</li></ul><p>å¯èƒ½æœ‰éƒ¨åˆ†åŒå­¦å¯¹ Hystrix çš„ç‰¹æ€§äº†è§£çš„ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œç¬”è€…æ¨èå¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li><a href="http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€ç¿»è¯‘ã€‘Hystrix æ–‡æ¡£ - å®ç°åŸç†ã€‹</a></li><li><a href="http://tech.lede.com/2017/06/15/rd/server/hystrix/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šhystrix åœ¨ spring mvc çš„ä½¿ç”¨ã€‹</a></li></ul><p>å¦å¤–ï¼Œç¬”è€…ä¹Ÿæ•´ç†äº†ä¸‹ Hystrix çš„ç‰¹æ€§å¦‚ä¸‹( å¯èƒ½ä¸æ˜¯å¾ˆä¸¥è°¨ï¼Œä¸»è¦è¾…åŠ©ç†è§£ ) ï¼š</p><ul><li>æ–­è·¯å™¨æœºåˆ¶<ul><li>è®¡ç®—çº¿è·¯å¥åº·åº¦</li></ul></li><li>Fallback ( å¤±è´¥å›é€€ )</li><li>èµ„æºéš”ç¦»<ul><li>æ–¹å¼<ul><li>çº¿ç¨‹æ± </li><li>ä¿¡å·é‡</li></ul></li><li>ä¾èµ–éš”ç¦»</li></ul></li><li>æ‰§è¡Œæ¨¡å‹<ul><li>åŒæ­¥æ‰§è¡Œ</li><li>å¼‚æ­¥æ‰§è¡Œ</li><li>Reactiveæ¨¡å¼æ‰§è¡Œ<ul><li>observe</li><li>toObservable</li></ul></li></ul></li><li>è¿ç»´å¹³å°<ul><li>åŸºç¡€ Dashboard</li><li>æ•´åˆ Turbine</li></ul></li><li>ç¼“å­˜</li><li>è¯·æ±‚åˆå¹¶( HystrixCollapser )</li></ul><h1>4. å½©è›‹</h1><p>ä¸ºäº†æ˜¾å¾—æœ¬æ–‡çš„è¯šæ„( çœŸçš„ä¸æ˜¯æ°´æ›´ )ï¼Œå‹æƒ…æç¤ºå¦‚ä¸‹ï¼š</p><p>Hystrix åŸºäº RxJava å®ç°ï¼Œæ‰€ä»¥ç¬”è€…æ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç«  ï¼š</p><ul><li><a href="http://gank.io/post/560e15be2dca930e00da1083" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£ã€‹</a></li><li><a href="http://www.jianshu.com/p/856297523728" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¤§è¯ RxJavaã€‹ç³»åˆ—</a></li></ul><p>å¯èƒ½ä¸€å¼€å§‹ç†è§£ä¼šæ¯”è¾ƒå›°éš¾ï¼Œä¿æŒè€å¿ƒï¼Œä½ å³å°†æ‰“å¼€ä¸€ä¸ªæ–°çš„ä¸–ç•Œã€‚å¯¹äº†ï¼Œ<strong>å˜æ¢</strong>( <code>#lift(Operator)</code> ) ä¼šæ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œæˆ‘ç›¸ä¿¡ä½ å¯ä»¥ç†è§£ã€‚</p><hr><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p><p>å¯¹äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»åˆ—æ–‡ï¼Œæ‰€ä»¥ï¼Œåƒä¸‡ä¸è¦é”™è¿‡ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Hystr
      
    
    </summary>
    
      <category term="Hystrix" scheme="http://www.iocoder.cn/categories/Hystrix/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” StringCache</title>
    <link href="http://www.iocoder.cn/Eureka/string-cache/"/>
    <id>http://www.iocoder.cn/Eureka/string-cache/</id>
    <published>2018-08-20T16:00:00.000Z</published>
    <updated>2017-10-19T15:47:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/string-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/string-cache/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/string-cache/">2. StringCache</a></li><li><a href="http://www.iocoder.cn/Eureka/string-cache/">3. ä½¿ç”¨åœºæ™¯</a></li><li><a href="http://www.iocoder.cn/Eureka/string-cache/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka è‡ªå·±å®ç°çš„ StringCache</strong>ã€‚</p><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹ç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿå¯¹ <code>String#intern(...)</code> çš„åˆ†äº«ï¼š</p><blockquote><p>FROM <a href="https://tech.meituan.com/in_depth_understanding_string_intern.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥è§£æString#internã€‹ã€Œ å¼•è¨€ ã€</a><br>åœ¨ JAVA è¯­è¨€ä¸­æœ‰8ä¸­åŸºæœ¬ç±»å‹å’Œä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ <code>String</code>ã€‚è¿™äº›ç±»å‹ä¸ºäº†ä½¿ä»–ä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€Ÿåº¦æ›´å¿«ï¼Œæ›´èŠ‚çœå†…å­˜ï¼Œéƒ½æä¾›äº†ä¸€ç§å¸¸é‡æ± çš„æ¦‚å¿µã€‚å¸¸é‡æ± å°±ç±»ä¼¼ä¸€ä¸ª JAVA ç³»ç»Ÿçº§åˆ«æä¾›çš„ç¼“å­˜ã€‚<br>8 ç§åŸºæœ¬ç±»å‹çš„å¸¸é‡æ± éƒ½æ˜¯ç³»ç»Ÿåè°ƒçš„ï¼Œ<code>String</code> ç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p><ul><li>ç›´æ¥ä½¿ç”¨åŒå¼•å·å£°æ˜å‡ºæ¥çš„ <code>String</code> å¯¹è±¡ä¼šç›´æ¥å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­</li><li>å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„ <code>String</code> å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Stringæä¾›çš„ <code>intern</code> æ–¹æ³•ã€‚<code>intern</code> æ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥è¯¢å½“å‰å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­</li></ul></blockquote><ul><li>å­—ç¬¦ä¸²å¸¸é‡æ± èƒ½å¸¦æ¥é€Ÿåº¦æ›´å¿«ï¼Œæ›´èŠ‚çœå†…å­˜çš„å¥½å¤„</li><li><strong>éåŒå¼•å·å£°æ˜</strong>çš„ String å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ <code>String#intern()</code> æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²å­˜å‚¨åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ã€‚</li></ul><p>çœ‹èµ·æ¥ä¸€åˆ‡éƒ½éå¸¸éå¸¸éå¸¸ç¾å¥½ï¼Œé‚£ä¸ºä»€ä¹ˆ Eureka è‡ªå·±å®ç°äº† StringCache ï¼Ÿ</p><p>ç»§ç»­å‚è§ç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿå¯¹ <code>String#intern(...)</code> çš„åˆ†äº«ï¼š</p><blockquote><p>FROM <a href="https://tech.meituan.com/in_depth_understanding_string_intern.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥è§£æString#internã€‹ã€Œ native ä»£ç  ã€</a><br>JAVA ä½¿ç”¨ JNI è°ƒç”¨ c++ å®ç°çš„ StringTable çš„ <code>intern</code> æ–¹æ³•, StringTableçš„ <code>intern</code> æ–¹æ³•è·Ÿ Java ä¸­çš„ HashMap çš„å®ç°æ˜¯å·®ä¸å¤šçš„, åªæ˜¯ä¸èƒ½è‡ªåŠ¨æ‰©å®¹ã€‚<strong>é»˜è®¤å¤§å°æ˜¯1009</strong>ã€‚</p></blockquote><blockquote><p>è¦æ³¨æ„çš„æ˜¯ï¼ŒString çš„ String Pool æ˜¯ä¸€ä¸ª<strong>å›ºå®šå¤§å°</strong>çš„ Hashtableï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯ 1009ï¼Œå¦‚æœæ”¾è¿› String Pool çš„ String éå¸¸å¤šï¼Œå°±ä¼šé€ æˆ<strong>Hashå†²çªä¸¥é‡</strong>ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨ä¼šå¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†åç›´æ¥ä¼šé€ æˆçš„å½±å“å°±æ˜¯å½“è°ƒç”¨String.internæ—¶æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ï¼ˆå› ä¸ºè¦ä¸€ä¸ªä¸€ä¸ªæ‰¾ï¼‰ã€‚</p></blockquote><blockquote><p>åœ¨ JDK6 ä¸­ StringTable æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯ 1009 çš„é•¿åº¦ï¼Œæ‰€ä»¥å¦‚æœå¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿«ã€‚åœ¨jdk7ä¸­ï¼ŒStringTableçš„é•¿åº¦å¯ä»¥é€šè¿‡ä¸€ä¸ªå‚æ•°æŒ‡å®šï¼š</p></blockquote><blockquote><ul><li>-XX:StringTableSize=99991</li></ul></blockquote><ul><li>JDK è‡ªå¸¦çš„ String Pool å›ºå®šå¤§å°( å³ä½¿å¯é… )ï¼Œä¸æ”¯æŒè‡ªåŠ¨æ‰©å®¹ï¼Œå¤§é‡ä½¿ç”¨ <code>String#intern(...)</code> åï¼Œä¼šå¯¼è‡´æ€§èƒ½å¤§å¹…åº¦ä¸‹é™ã€‚</li><li>Eureka çš„åº”ç”¨å®ä¾‹( InstanceInfo ) çš„ <code>appName</code>ã€<code>appGroupName</code>ã€<code>vipAddress</code>ã€<code>secureVipAddress</code>ã€<code>metadata</code> å’Œåº”ç”¨( Application )çš„ <code>name</code> ç­‰å±æ€§éœ€è¦ä½¿ç”¨åˆ° String Pool ï¼Œä¸ºäº†åœ¨å¤§é‡çš„ç½‘ç»œé€šä¿¡åºåˆ—åŒ–ååºåˆ—çš„è¿‡ç¨‹ä¸­ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œæ›´èŠ‚çœå†…å®¹ã€‚</li></ul><p>å¦å¤–ï¼ŒFastJSON åœ¨ 1.124 ç‰ˆæœ¬<strong>ä¹‹å‰</strong>ä¹Ÿä½¿ç”¨ <code>String#intern(...)</code> æ–¹æ³•ï¼Œä¼˜åŒ– JSON Key çš„é€Ÿåº¦å’Œç©ºé—´ï¼Œä½†æ˜¯åœ¨å¤§é‡åŠ¨æ€ JSON Key çš„åœºæ™¯ä¸‹ï¼Œåè€Œä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚æ‰€ä»¥ FastJSON 1.124 ä¿®å¤äº†è¯¥é—®é¢˜ã€‚å‚è§å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="https://tech.meituan.com/in_depth_understanding_string_intern.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥è§£æString#internã€‹ã€Œ fastjson ä¸å½“ä½¿ç”¨ ã€</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_08_21/01.png" alt=""></p></blockquote><ul><li>But ï¼ŒFastJSON 1.124 ç‰ˆæœ¬<strong>ä¹‹å‰</strong>æ°å¥½é€‚åˆ Eureka ï¼Œå› ä¸º <code>appName</code>ã€<code>appGroupName</code> <strong>ç›¸å¯¹ä¸é‚£ä¹ˆåŠ¨æ€</strong>ã€‚è€ƒè™‘åˆ°å¯èƒ½è¿˜æ˜¯æœ‰å¤§é‡çš„å­—ç¬¦ä¸²å­˜åœ¨ï¼Œå› è€Œå®ç°è‡ªå®šä¹‰çš„ StringCache ç±»ï¼Œä»¥è§£å†³ StringPool çš„ HashTable ä¸æ”¯æŒåŠ¨æ€æ‰©å®¹çš„æƒ…å†µã€‚</li></ul><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ Eureka æ˜¯å¦‚ä½•å®ç°è‡ªå®šä¹‰çš„ StringCache ç±»ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. StringCache</h1><p><code>com.netflix.discovery.util.StringCache</code> ï¼Œå­—ç¬¦ä¸²ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringCache</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LENGTH_LIMIT = <span class="number">38</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StringCache INSTANCE = <span class="keyword">new</span> StringCache();</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"> <span class="number">8</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, WeakReference&lt;String&gt;&gt; cache = <span class="keyword">new</span> WeakHashMap&lt;String, WeakReference&lt;String&gt;&gt;();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> lengthLimit;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> <span class="title">StringCache</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">this</span>(LENGTH_LIMIT);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> <span class="title">StringCache</span><span class="params">(<span class="keyword">int</span> lengthLimit)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">this</span>.lengthLimit = lengthLimit;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">cachedValueOf</span><span class="params">(<span class="keyword">final</span> String str)</span> </span>&#123;</div><div class="line"><span class="number">20</span>:         <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; (lengthLimit &lt; <span class="number">0</span> || str.length() &lt;= lengthLimit)) &#123;</div><div class="line"><span class="number">21</span>:             <span class="comment">// Return value from cache if available</span></div><div class="line"><span class="number">22</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">23</span>:                 lock.readLock().lock();</div><div class="line"><span class="number">24</span>:                 WeakReference&lt;String&gt; ref = cache.get(str);</div><div class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">26</span>:                     <span class="keyword">return</span> ref.get();</div><div class="line"><span class="number">27</span>:                 &#125;</div><div class="line"><span class="number">28</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">29</span>:                 lock.readLock().unlock();</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// Update cache with new content</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">34</span>:                 lock.writeLock().lock();</div><div class="line"><span class="number">35</span>:                 WeakReference&lt;String&gt; ref = cache.get(str);</div><div class="line"><span class="number">36</span>:                 <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">37</span>:                     <span class="keyword">return</span> ref.get();</div><div class="line"><span class="number">38</span>:                 &#125;</div><div class="line"><span class="number">39</span>:                 cache.put(str, <span class="keyword">new</span> WeakReference&lt;&gt;(str));</div><div class="line"><span class="number">40</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">41</span>:                 lock.writeLock().unlock();</div><div class="line"><span class="number">42</span>:             &#125;</div><div class="line"><span class="number">43</span>:             <span class="keyword">return</span> str;</div><div class="line"><span class="number">44</span>:         &#125;</div><div class="line"><span class="number">45</span>:         <span class="keyword">return</span> str;</div><div class="line"><span class="number">46</span>:     &#125;</div><div class="line"><span class="number">47</span>: </div><div class="line"><span class="number">48</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">49</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">50</span>:             lock.readLock().lock();</div><div class="line"><span class="number">51</span>:             <span class="keyword">return</span> cache.size();</div><div class="line"><span class="number">52</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">53</span>:             lock.readLock().unlock();</div><div class="line"><span class="number">54</span>:         &#125;</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">intern</span><span class="params">(String original)</span> </span>&#123;</div><div class="line"><span class="number">58</span>:         <span class="keyword">return</span> INSTANCE.cachedValueOf(original);</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>INSTANCE</code> å±æ€§ï¼Œå­—ç¬¦ä¸²ç¼“å­˜<strong>å•ä¾‹</strong>ã€‚</li><li><code>lock</code> å±æ€§ï¼Œ<strong>è¯»å†™é”</strong>ï¼Œä¿è¯è¯»å†™äº’æ–¥ã€‚</li><li><code>cache</code> å±æ€§ï¼Œç¼“å­˜å“ˆå¸Œè¡¨ã€‚<ul><li>ä½¿ç”¨ WeakHashMapï¼Œå½“ StringCache è¢«å›æ”¶æ—¶ï¼Œå…¶å¯¹åº”çš„å€¼ä¸€èµ·è¢«ç§»é™¤ã€‚</li><li><a href="http://blog.csdn.net/yangzl2008/article/details/6980709" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠWeakHashMapå’ŒHashMapçš„åŒºåˆ«ã€‹</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3311092.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava é›†åˆç³»åˆ—13ä¹‹ WeakHashMapè¯¦ç»†ä»‹ç»(æºç è§£æ)å’Œä½¿ç”¨ç¤ºä¾‹ã€‹</a></li></ul></li><li><code>lengthLimit</code> å±æ€§ï¼Œç¼“å­˜å­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ã€‚é»˜è®¤å€¼ï¼š38 ã€‚</li><li><code>#cachedValueOf(...)</code> æ–¹æ³•ï¼Œè·å¾—å­—ç¬¦ä¸²ç¼“å­˜ã€‚è‹¥ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œç¼“å­˜ã€‚å’Œ <code>String#intern()</code> çš„é€»è¾‘ç›¸åŒï¼ŒåŒºåˆ«åœ¨äº <code>cache</code> æ”¯æŒè‡ªåŠ¨æ‰©å®¹ã€‚<ul><li>ç¬¬ 22 è‡³ 30 è¡Œ ï¼šè¯»é”ï¼Œè¯»å–ç¼“å­˜ã€‚</li><li>ç¬¬ 32 è‡³ 42 è¡Œ ï¼šç¼“å­˜ä¸å­˜åœ¨ï¼Œå†™é”ï¼Œå†™å…¥ç¼“å­˜ã€‚</li></ul></li><li><code>#size()</code> æ–¹æ³•ï¼Œç¼“å­˜å¤§å°ã€‚</li><li><code>#intern()</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œä½¿ç”¨ <code>INSTANCE</code> è·å–ç¼“å­˜å­—ç¬¦ä¸²ã€‚</li></ul><h1>3. ä½¿ç”¨åœºæ™¯</h1><p>åœ¨ InstanceInfo ä¸‹çš„ä½¿ç”¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java#L233" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><p>åœ¨ Application ä¸‹çš„ä½¿ç”¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-client/src/main/java/com/netflix/discovery/shared/Application.java#L95" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h1>666. å½©è›‹</h1><p>åˆ Get æ–°å§¿åŠ¿äº†ï¼Œå¥½å¼€æ£®ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆï¼Œå¯å¥½ï¼Ÿï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/string-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka/string-cache/&quot;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiter</title>
    <link href="http://www.iocoder.cn/Eureka/rate-limiter/"/>
    <id>http://www.iocoder.cn/Eureka/rate-limiter/</id>
    <published>2018-08-13T16:00:00.000Z</published>
    <updated>2017-10-19T05:48:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/rate-limiter/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">2. RateLimiter</a><ul><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">2.1 refillToken</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">2.2 consumeToken</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">3. RateLimitingFilter</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">4. InstanceInfoReplicator</a></li><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RateLimiter çš„ä»£ç å®ç°å’Œ RateLimiter åœ¨ Eureka ä¸­çš„åº”ç”¨</strong>ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. RateLimiter</h1><p><code>com.netflix.discovery.util.RateLimiter</code> ï¼ŒåŸºäº**Token Bucket Algorithm ( ä»¤ç‰Œæ¡¶ç®—æ³• )**çš„é€Ÿç‡é™åˆ¶å™¨ã€‚</p><blockquote><p>FROM <a href="http://www.cnblogs.com/LBSer/p/4083131.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ¥å£é™æµå®è·µã€‹</a><br>ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†æ˜¯ç³»ç»Ÿä¼šä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡ã€‚<br><img src="http://www.iocoder.cn/images/Eureka/2018_08_14/01.png" alt=""></p></blockquote><p>RateLimiter ç›®å‰æ”¯æŒ<strong>åˆ†é’Ÿçº§</strong>å’Œ<strong>ç§’çº§</strong>ä¸¤ç§é€Ÿç‡é™åˆ¶ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é€Ÿç‡å•ä½è½¬æ¢æˆæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> rateToMsConversion;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RateLimiter</span><span class="params">(TimeUnit averageRateUnit)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (averageRateUnit) &#123;</div><div class="line">            <span class="keyword">case</span> SECONDS: <span class="comment">// ç§’çº§</span></div><div class="line">                rateToMsConversion = <span class="number">1000</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MINUTES: <span class="comment">// åˆ†é’Ÿçº§</span></div><div class="line">                rateToMsConversion = <span class="number">60</span> * <span class="number">1000</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"TimeUnit of "</span> + averageRateUnit + <span class="string">" is not supported"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>averageRateUnit</code> å‚æ•°ï¼Œé€Ÿç‡<strong>å•ä½</strong>ã€‚æ„é€ æ–¹æ³•é‡Œå°† <code>averageRateUnit</code> è½¬æ¢æˆ <code>rateToMsConversion</code> ã€‚</li></ul><p>è°ƒç”¨ <code>#acquire(...)</code> æ–¹æ³•ï¼Œè·å–ä»¤ç‰Œï¼Œå¹¶è¿”å›<strong>æ˜¯å¦è·å–æˆåŠŸ</strong></p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// RateLimiter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–ä»¤ç‰Œ( Token )</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> burstSize ä»¤ç‰Œæ¡¶ä¸Šé™</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> averageRate ä»¤ç‰Œå†è£…å¹³å‡é€Ÿç‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ˜¯å¦è·å–æˆåŠŸ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> burstSize, <span class="keyword">long</span> averageRate)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> acquire(burstSize, averageRate, System.currentTimeMillis());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> burstSize, <span class="keyword">long</span> averageRate, <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (burstSize &lt;= <span class="number">0</span> || averageRate &lt;= <span class="number">0</span>) &#123; <span class="comment">// Instead of throwing exception, we just let all the traffic go</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// å¡«å…… ä»¤ç‰Œ</span></div><div class="line">   refillToken(burstSize, averageRate, currentTimeMillis);</div><div class="line">   <span class="comment">// æ¶ˆè´¹ ä»¤ç‰Œ</span></div><div class="line">   <span class="keyword">return</span> consumeToken(burstSize);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>burstSize</code> å‚æ•° ï¼šä»¤ç‰Œæ¡¶ä¸Šé™ã€‚</p></li><li><p><code>averageRate</code> å‚æ•° ï¼šä»¤ç‰Œå¡«å……<strong>å¹³å‡</strong>é€Ÿç‡ã€‚</p></li><li><p>æˆ‘ä»¬ä¸¾ä¸ª ğŸŒ° æ¥ç†è§£è¿™ä¸¤ä¸ªå‚æ•° + æ„é€ æ–¹æ³•é‡Œçš„ä¸€ä¸ªå‚æ•°ï¼š</p><ul><li><code>averageRateUnit = SECONDS</code></li><li><code>averageRate = 2000</code></li><li><code>burstSize = 10</code></li><li>æ¯<strong>ç§’</strong>å¯è·å– <code>2000</code> ä¸ªä»¤ç‰Œã€‚ä¾‹å¦‚ï¼Œæ¯ç§’å…è®¸è¯·æ±‚ <code>2000</code> æ¬¡ã€‚</li><li>æ¯<strong>æ¯«ç§’</strong>å¯å¡«å…… <code>2000 / 1000 = 2</code> ä¸ª<strong>æ¶ˆè€—</strong>çš„ä»¤ç‰Œã€‚</li><li>æ¯<strong>æ¯«ç§’</strong>å¯è·å– <code>10</code> ä¸ªä»¤ç‰Œã€‚ä¾‹å¦‚ï¼Œæ¯æ¯«ç§’å…è®¸è¯·æ±‚ä¸Šé™ä¸º <code>10</code> æ¬¡ï¼Œå¹¶ä¸”è¯·æ±‚<strong>æ¶ˆè€—</strong>æ‰çš„ä»¤ç‰Œï¼Œéœ€è¦é€æ­¥å¡«å……ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œè™½ç„¶æ¯æ¯«ç§’å…è®¸è¯·æ±‚ä¸Šé™ä¸º <code>10</code> æ¬¡ï¼Œè¿™æ˜¯åœ¨æ²¡æœ‰ä»»ä½•ä»¤ç‰Œè¢«<strong>æ¶ˆè€—</strong>çš„æƒ…å†µä¸‹ï¼Œå®é™…æ¯ç§’å…è®¸è¯·æ±‚ä¾ç„¶æ˜¯ <code>2000</code> æ¬¡ã€‚</li><li><strong>è¿™å°±æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„é™æµçš„ç‰¹ç‚¹ï¼šè®©æµé‡å¹³ç¨³ï¼Œè€Œä¸æ˜¯ç¬é—´æµé‡ã€‚1000 QPS ç›¸å¯¹å¹³å‡çš„åˆ†æ‘Šåœ¨è¿™ä¸€ç§’å†…ï¼Œè€Œä¸æ˜¯ç¬¬ 1 ms 999 è¯·æ±‚ï¼Œåé¢ 999 ms 0 è¯·æ±‚</strong>ã€‚</li></ul></li><li><p>ä»ä»£ç ä¸Šçœ‹ï¼Œ<code>#acquire(...)</code> åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆ†åˆ«è§£æï¼Œæ•´ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_14/02.png" alt=""></p></li></ul><h2>2.1 refillToken</h2><p>è°ƒç”¨ <code>#refillToken(...)</code> æ–¹æ³•ï¼Œå¡«å……<strong>å·²æ¶ˆè€—</strong>çš„ä»¤ç‰Œã€‚å¯èƒ½å¾ˆå¤šåŒå­¦å¼€å§‹å’Œæˆ‘æƒ³çš„ä¸€æ ·ï¼Œä¸€ä¸ªåå°æ¯æ¯«ç§’æ‰§è¡Œå¡«å……ã€‚<strong>ä¸ºä»€ä¹ˆä¸é€‚åˆè¿™æ ·å‘¢ï¼Ÿ<strong>ä¸€æ–¹é¢ï¼Œå®é™…é¡¹ç›®é‡Œæ¯ä¸ªæ¥å£éƒ½ä¼šæœ‰ç›¸åº”çš„ RateLimiter ï¼Œå¯¼è‡´</strong>å¤ªå¤š</strong>æ‰§è¡Œé¢‘ç‡<strong>æé«˜</strong>çš„åå°ä»»åŠ¡ï¼›å¦ä¸€æ–¹é¢ï¼Œè·å–ä»¤ç‰Œæ—¶æ‰è®¡ç®—ï¼Œå¤šæ¬¡ä»¤ç‰Œå¡«å……å¯ä»¥åˆå¹¶æˆä¸€æ¬¡ï¼Œå‡å°‘å†—ä½™å’Œæ— æ•ˆçš„è®¡ç®—ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * é€Ÿç‡å•ä½è½¬æ¢æˆæ¯«ç§’</span></div><div class="line"><span class="comment"> 3:  */</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> rateToMsConversion;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 7:  * æ¶ˆè€—ä»¤ç‰Œæ•°</span></div><div class="line"><span class="comment"> 8:  */</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger consumedTokens = <span class="keyword">new</span> AtomicInteger();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">11:  * æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´</span></div><div class="line"><span class="comment">12:  */</span></div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastRefillTime = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refillToken</span><span class="params">(<span class="keyword">int</span> burstSize, <span class="keyword">long</span> averageRate, <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     <span class="comment">// è·å¾— æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">long</span> refillTime = lastRefillTime.get();</div><div class="line"><span class="number">18</span>:     <span class="comment">// è·å¾— è¿‡å»å¤šå°‘æ¯«ç§’</span></div><div class="line"><span class="number">19</span>:     <span class="keyword">long</span> timeDelta = currentTimeMillis - refillTime;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>:     <span class="comment">// è®¡ç®— å¯å¡«å……æœ€å¤§ä»¤ç‰Œæ•°é‡</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">long</span> newTokens = timeDelta * averageRate / rateToMsConversion;</div><div class="line"><span class="number">23</span>:     <span class="keyword">if</span> (newTokens &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">24</span>:         <span class="comment">// è®¡ç®— æ–°çš„å¡«å……ä»¤ç‰Œçš„æ—¶é—´</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">long</span> newRefillTime = refillTime == <span class="number">0</span></div><div class="line"><span class="number">26</span>:                 ? currentTimeMillis</div><div class="line"><span class="number">27</span>:                 : refillTime + newTokens * rateToMsConversion / averageRate;</div><div class="line"><span class="number">28</span>:         <span class="comment">// CAS ä¿è¯æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥å¡«å……</span></div><div class="line"><span class="number">29</span>:         <span class="keyword">if</span> (lastRefillTime.compareAndSet(refillTime, newRefillTime)) &#123;</div><div class="line"><span class="number">30</span>:             <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="comment">// æ­»å¾ªç¯ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"><span class="number">31</span>:                 <span class="comment">// è®¡ç®— å¡«å……ä»¤ç‰Œåçš„å·²æ¶ˆè€—ä»¤ç‰Œæ•°é‡</span></div><div class="line"><span class="number">32</span>:                 <span class="keyword">int</span> currentLevel = consumedTokens.get();</div><div class="line"><span class="number">33</span>:                 <span class="keyword">int</span> adjustedLevel = Math.min(currentLevel, burstSize); <span class="comment">// In case burstSize decreased</span></div><div class="line"><span class="number">34</span>:                 <span class="keyword">int</span> newLevel = (<span class="keyword">int</span>) Math.max(<span class="number">0</span>, adjustedLevel - newTokens);</div><div class="line"><span class="number">35</span>:                 <span class="comment">// CAS é¿å…å’Œæ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œçš„çº¿ç¨‹å†²çª</span></div><div class="line"><span class="number">36</span>:                 <span class="keyword">if</span> (consumedTokens.compareAndSet(currentLevel, newLevel)) &#123;</div><div class="line"><span class="number">37</span>:                     <span class="keyword">return</span>;</div><div class="line"><span class="number">38</span>:                 &#125;</div><div class="line"><span class="number">39</span>:             &#125;</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 17 è¡Œ ï¼šè·å–æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´( <code>refillTime</code> ) ã€‚æ¯æ¬¡å¡«å……ä»¤ç‰Œï¼Œä¼šè®¾ç½® <code>currentTimeMillis</code> åˆ° <code>refillTime</code> ã€‚</li><li>ç¬¬ 19 è¡Œ ï¼šè·å¾—è·ç¦»æœ€åå¡«å……ä»¤ç‰Œçš„æ—¶é—´å·®( <code>timeDelta</code> )ï¼Œç”¨äºè®¡ç®—éœ€è¦å¡«å……çš„ä»¤ç‰Œæ•°ã€‚</li><li>ç¬¬ 22 è¡Œ ï¼šè®¡ç®—<strong>å¯å¡«å……çš„</strong>æœ€å¤§ä»¤ç‰Œæ•°é‡( <code>newTokens</code> )ã€‚<code>newTokens</code> å¯èƒ½è¶…è¿‡ <code>burstSize</code> ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šæœ‰é€»è¾‘è°ƒæ•´ <code>newTokens</code> ã€‚</li><li>ç¬¬ 25 è‡³ 27 è¡Œ ï¼šè®¡ç®—<strong>æ–°çš„</strong>å¡«å……ä»¤ç‰Œçš„æ—¶é—´ã€‚<strong>ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ <code>currentTimeMillis</code> å‘¢</strong>ï¼Ÿä¾‹å¦‚ï¼Œ<code>averageRate = 500 &amp;&amp; averageRateUnit = SECONDS</code> æ—¶ï¼Œ æ¯ 2 æ¯«ç§’æ‰å¡«å……ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœè®¾ç½® <code>currentTimeMillis</code> ï¼Œ<strong>ä¼šå¯¼è‡´ä¸è¶³ä»¥å¡«å……ä¸€ä¸ªä»¤ç‰Œçš„æ—¶é•¿è¢«åäº†</strong>ã€‚</li><li>ç¬¬ 29 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿è¯æœ‰ä¸”<strong>ä»…æœ‰ä¸€ä¸ª</strong>çº¿ç¨‹è¿›å…¥å¡«å……é€»è¾‘ã€‚</li><li>ç¬¬ 30 è¡Œ ï¼š<strong>æ­»å¾ªç¯ç›´åˆ°æˆåŠŸ</strong>ã€‚</li><li>ç¬¬ 32 è‡³ 34 è¡Œ ï¼šè®¡ç®—<strong>æ–°çš„</strong>å¡«å……ä»¤ç‰Œåçš„<strong>å·²æ¶ˆè€—</strong>çš„ä»¤ç‰Œæ•°é‡ã€‚<ul><li>ç¬¬ 33 è¡Œ ï¼š<code>burstSize</code> å¯èƒ½è°ƒå°ï¼Œä¾‹å¦‚ï¼Œç³»ç»Ÿæ¥å…¥åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œå¯ä»¥è¿œç¨‹è°ƒæ•´è¯¥æ•°å€¼ã€‚å¦‚æœæ­¤æ—¶ <code>burstSize</code> æ›´å°ï¼Œä»¥å®ƒä½œä¸º<strong>å·²æ¶ˆè€—</strong>çš„ä»¤ç‰Œæ•°é‡ã€‚</li></ul></li><li>ç¬¬ 36 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> ä¿è¯é¿å…è¦†ç›–è®¾ç½®æ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œçš„çº¿ç¨‹ã€‚</li></ul><h2>2.2 consumeToken</h2><p>ç”¨ <code>#refillToken(...)</code> æ–¹æ³•ï¼Œå¡«å……**æ¶ˆè€—( è·å– )**çš„ä»¤ç‰Œã€‚</p><p>ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">consumeToken</span><span class="params">(<span class="keyword">int</span> burstSize)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="comment">// æ­»å¾ªç¯ï¼Œç›´åˆ°æ²¡æœ‰ä»¤ç‰Œï¼Œæˆ–è€…è·å–ä»¤ç‰ŒæˆåŠŸ</span></div><div class="line"> <span class="number">3</span>:         <span class="comment">// æ²¡æœ‰ä»¤ç‰Œ</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">int</span> currentLevel = consumedTokens.get();</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (currentLevel &gt;= burstSize) &#123;</div><div class="line"> <span class="number">6</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>:         <span class="comment">// CAS é¿å…å’Œæ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œæˆ–è€…å¡«å……ä»¤ç‰Œçš„çº¿ç¨‹å†²çª</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (consumedTokens.compareAndSet(currentLevel, currentLevel + <span class="number">1</span>)) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è¡Œ ï¼š<strong>æ­»å¾ªç¯ç›´åˆ°æ²¡æœ‰ä»¤ç‰Œæˆ–è€…ç«äº‰è·å–ä»¤ç‰ŒæˆåŠŸ</strong>ã€‚</li><li>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šæ²¡æœ‰ä»¤ç‰Œã€‚</li><li>ç¬¬ 9 è‡³ 11 è¡Œ ï¼šé€šè¿‡ <strong>CAS</strong> é¿å…å’Œæ­£åœ¨æ¶ˆè´¹ä»¤ç‰Œæˆ–è€…å¡«å……ä»¤ç‰Œçš„çº¿ç¨‹å†²çªã€‚</li></ul><h1>3. RateLimitingFilter</h1><p><code>com.netflix.eureka.RateLimitingFilter</code> ï¼ŒEureka-Server é™æµè¿‡æ»¤å™¨ã€‚ä½¿ç”¨ RateLimiting ï¼Œä¿è¯ Eureka-Server ç¨³å®šæ€§ã€‚</p><p><code>#doFilter(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾— Target</span></div><div class="line"> <span class="number">4</span>:     Target target = getTarget(request);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// Other Target ï¼Œä¸åšé™æµ</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (target == Target.Other) &#123;</div><div class="line"> <span class="number">8</span>:         chain.doFilter(request, response);</div><div class="line"> <span class="number">9</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     HttpServletRequest httpRequest = (HttpServletRequest) request;</div><div class="line"><span class="number">13</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¢«é™æµ</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">if</span> (isRateLimited(httpRequest, target)) &#123;</div><div class="line"><span class="number">15</span>:         <span class="comment">// TODO[0012]ï¼šç›‘æ§ç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line"><span class="number">16</span>:         incrementStats(target);</div><div class="line"><span class="number">17</span>:         <span class="comment">// å¦‚æœå¼€å¯é™æµï¼Œè¿”å› 503 çŠ¶æ€ç </span></div><div class="line"><span class="number">18</span>:         <span class="keyword">if</span> (serverConfig.isRateLimiterEnabled()) &#123;</div><div class="line"><span class="number">19</span>:             ((HttpServletResponse) response).setStatus(HttpServletResponse.SC_SERVICE_UNAVAILABLE);</div><div class="line"><span class="number">20</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>:     chain.doFilter(request, response);</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šè°ƒç”¨ <code>#getTarget()</code> æ–¹æ³•ï¼Œè·å– Targetã€‚RateLimitingFilter åªå¯¹ç¬¦åˆæ­£åœ¨è¡¨è¾¾å¼ <code>^.*/apps(/[^/]*)?$</code> çš„æ¥å£åšé™æµï¼Œå…¶ä¸­ä¸åŒ…å« Eureka-Server é›†ç¾¤æ‰¹é‡åŒæ­¥æ¥å£ã€‚</p><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/RateLimitingFilter.java#L98" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ Target æšä¸¾ç±»ä»£ç ã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/RateLimitingFilter.java#L150" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#getTarget(...)</code> æ–¹æ³•ä»£ç ã€‚</li></ul></li><li><p>ç¬¬ 14 è¡Œ ï¼šè°ƒç”¨ <code>#isRateLimited(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¢«é™æµã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRateLimited</span><span class="params">(HttpServletRequest request, Target target)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦ç‰¹æƒåº”ç”¨</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (isPrivileged(request)) &#123;</div><div class="line"> <span class="number">4</span>:         logger.debug(<span class="string">"Privileged &#123;&#125; request"</span>, target);</div><div class="line"> <span class="number">5</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦è¢«è¶…è½½( é™æµ )</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (isOverloaded(target)) &#123;</div><div class="line"> <span class="number">9</span>:         logger.debug(<span class="string">"Overloaded &#123;&#125; request; discarding it"</span>, target);</div><div class="line"><span class="number">10</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>:     logger.debug(<span class="string">"&#123;&#125; request admitted"</span>, target);</div><div class="line"><span class="number">13</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 6 è¡Œ ï¼šè°ƒç”¨ <code>#isPrivileged()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒåº”ç”¨ï¼Œå¯¹ç‰¹æƒåº”ç”¨ä¸å¼€å¯é™æµé€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPrivileged</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">    <span class="comment">// æ˜¯å¦å¯¹æ ‡å‡†å®¢æˆ·ç«¯å¼€å¯é™æµ</span></div><div class="line">    <span class="keyword">if</span> (serverConfig.isRateLimiterThrottleStandardClients()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ä»¥è¯·æ±‚å¤´( "DiscoveryIdentity-Name" ) åˆ¤æ–­æ˜¯å¦åœ¨æ ‡å‡†å®¢æˆ·ç«¯åé›†åˆå†…</span></div><div class="line">    Set&lt;String&gt; privilegedClients = serverConfig.getRateLimiterPrivilegedClients();</div><div class="line">    String clientName = request.getHeader(AbstractEurekaIdentity.AUTH_NAME_HEADER_KEY);</div><div class="line">    <span class="keyword">return</span> privilegedClients.contains(clientName) || DEFAULT_PRIVILEGED_CLIENTS.contains(clientName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šè°ƒç”¨ <code>#isOverloaded(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è½½( é™æµ )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Includes both full and delta fetches.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RateLimiter registryFetchRateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.SECONDS);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Only full registry fetches.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RateLimiter registryFullFetchRateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.SECONDS);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isOverloaded</span><span class="params">(Target target)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> maxInWindow = serverConfig.getRateLimiterBurstSize(); <span class="comment">// 10</span></div><div class="line">    <span class="keyword">int</span> fetchWindowSize = serverConfig.getRateLimiterRegistryFetchAverageRate(); <span class="comment">// 500</span></div><div class="line">    <span class="keyword">boolean</span> overloaded = !registryFetchRateLimiter.acquire(maxInWindow, fetchWindowSize);</div><div class="line">    <span class="keyword">if</span> (target == Target.FullFetch) &#123;</div><div class="line">        <span class="keyword">int</span> fullFetchWindowSize = serverConfig.getRateLimiterFullFetchAverageRate(); <span class="comment">// 100</span></div><div class="line">            overloaded |= !registryFullFetchRateLimiter.acquire(maxInWindow, fullFetchWindowSize);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> overloaded;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šè‹¥ <code>eureka.rateLimiter.enabled = true</code>( é»˜è®¤å€¼ ï¼š<code>false</code> ï¼Œå¯é… )ï¼Œè¿”å› 503 çŠ¶æ€ç ã€‚</p></li></ul><h1>4. InstanceInfoReplicator</h1><p><code>com.netflix.discovery.InstanceInfoReplicator</code> ï¼ŒEureka-Client åº”ç”¨å®ä¾‹å¤åˆ¶å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><p>åº”ç”¨å®ä¾‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨ <code>#onDemandUpdate()</code> æ–¹æ³•ï¼Œå‘ Eureka-Server å‘èµ·æ³¨å†Œï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚InstanceInfoReplicator ä½¿ç”¨ RateLimiter ï¼Œé¿å…çŠ¶æ€<strong>é¢‘ç¹</strong>å‘ç”Ÿå˜åŒ–ï¼Œå‘ Eureka-Server <strong>é¢‘ç¹</strong>åŒæ­¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * RateLimiter</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»¤ç‰Œæ¡¶ä¸Šé™ï¼Œé»˜è®¤ï¼š2</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> burstSize;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»¤ç‰Œå†è£…å¹³å‡é€Ÿç‡ï¼Œé»˜è®¤ï¼š60 * 2 / 30 = 4</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> allowedRatePerMinute;</div><div class="line">    </div><div class="line">    InstanceInfoReplicator(DiscoveryClient discoveryClient, InstanceInfo instanceInfo, <span class="keyword">int</span> replicationIntervalSeconds, <span class="keyword">int</span> burstSize) &#123;</div><div class="line">        <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">        </div><div class="line">        <span class="keyword">this</span>.rateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.MINUTES);</div><div class="line">        <span class="keyword">this</span>.replicationIntervalSeconds = replicationIntervalSeconds;</div><div class="line">        <span class="keyword">this</span>.burstSize = burstSize;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.allowedRatePerMinute = <span class="number">60</span> * <span class="keyword">this</span>.burstSize / <span class="keyword">this</span>.replicationIntervalSeconds;</div><div class="line">        logger.info(<span class="string">"InstanceInfoReplicator onDemand update allowed rate per min is &#123;&#125;"</span>, allowedRatePerMinute);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDemandUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (rateLimiter.acquire(burstSize, allowedRatePerMinute)) &#123; <span class="comment">// é™æµ</span></div><div class="line">            scheduler.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    logger.debug(<span class="string">"Executing on-demand update of local InstanceInfo"</span>);</div><div class="line">                    <span class="comment">// å–æ¶ˆä»»åŠ¡</span></div><div class="line">                    Future latestPeriodic = scheduledPeriodicRef.get();</div><div class="line">                    <span class="keyword">if</span> (latestPeriodic != <span class="keyword">null</span> &amp;&amp; !latestPeriodic.isDone()) &#123;</div><div class="line">                        logger.debug(<span class="string">"Canceling the latest scheduled update, it will be rescheduled at the end of on demand update"</span>);</div><div class="line">                        latestPeriodic.cancel(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// å†æ¬¡è°ƒç”¨</span></div><div class="line">                    InstanceInfoReplicator.<span class="keyword">this</span>.run();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.warn(<span class="string">"Ignoring onDemand update due to rate limiter"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <code>#onDemandUpdate()</code> æ–¹æ³•ï¼Œè°ƒç”¨ <code>RateLimiter#acquire(...)</code> æ–¹æ³•ï¼Œè·å–ä»¤ç‰Œã€‚<ul><li>è‹¥è·å–æˆåŠŸï¼Œå‘ Eureka-Server å‘èµ·æ³¨å†Œï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li><li>è‹¥è·å–å¤±è´¥ï¼Œ<strong>ä¸</strong>å‘ Eureka-Server å‘èµ·æ³¨å†Œï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚<strong>è¿™æ ·ä¼šä¸ä¼šæœ‰é—®é¢˜</strong>ï¼Ÿç­”æ¡ˆæ˜¯<strong>ä¸ä¼š</strong>ã€‚<ul><li>InstanceInfoReplicator ä¼š<strong>å›ºå®šå‘¨æœŸ</strong>æ£€æŸ¥æœ¬åœ°åº”ç”¨å®ä¾‹æ˜¯å¦æœ‰æ²¡å‘ Eureka-Server ï¼Œè‹¥æœªåŒæ­¥ï¼Œåˆ™å‘èµ·åŒæ­¥ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>Eureka-Client å‘ Eureka-Server å¿ƒè·³æ—¶ï¼ŒEureka-Server ä¼šå¯¹æ¯”åº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> ï¼Œè‹¥ Eureka-Client çš„æ›´å¤§ï¼Œåˆ™ Eureka-Server è¿”å› 404 çŠ¶æ€ç ã€‚Eureka-Client æ¥æ”¶åˆ° 404 çŠ¶æ€ç åï¼Œå‘èµ·æ³¨å†ŒåŒæ­¥ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹ã€Œ2.2 HeartbeatThreadã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul></li></ul><h1>666. å½©è›‹</h1><p>åé¢æ‰¾æ—¶é—´ç ”ç©¶ä¸‹ Google Guava RateLimiter çš„æºç å®ç°ï¼Œä»åŠŸèƒ½ä¸Šæ›´åŠ å¼ºå¤§ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥ç…ç…å‘€ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/rate-limiter/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a hr
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥</title>
    <link href="http://www.iocoder.cn/Eureka/server-cluster/"/>
    <id>http://www.iocoder.cn/Eureka/server-cluster/</id>
    <published>2018-08-06T16:00:00.000Z</published>
    <updated>2017-10-19T05:48:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/server-cluster/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</a><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.3 é›†ç¾¤èŠ‚ç‚¹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4. åŒæ­¥æ³¨å†Œä¿¡æ¯</a><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.1 åŒæ­¥æ“ä½œç±»å‹</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</a></li></ul></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server é›†ç¾¤åŒæ­¥æ³¨å†Œä¿¡æ¯</strong>ã€‚</p><p>Eureka-Server é›†ç¾¤å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/01.png" alt=""></p><ul><li>Eureka-Server é›†ç¾¤ä¸åŒºåˆ†<strong>ä¸»ä»èŠ‚ç‚¹</strong>æˆ–è€… <strong>Primary &amp; Secondary èŠ‚ç‚¹</strong>ï¼Œæ‰€æœ‰èŠ‚ç‚¹<strong>ç›¸åŒè§’è‰²( ä¹Ÿå°±æ˜¯æ²¡æœ‰è§’è‰² )ï¼Œå®Œå…¨å¯¹ç­‰</strong>ã€‚</li><li>Eureka-Client å¯ä»¥å‘<strong>ä»»æ„</strong> Eureka-Client å‘èµ·ä»»æ„<strong>è¯»å†™</strong>æ“ä½œï¼ŒEureka-Server å°†æ“ä½œå¤åˆ¶åˆ°å¦å¤–çš„ Eureka-Server ä»¥è¾¾åˆ°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚æ³¨æ„ï¼ŒEureka-Server æ˜¯é€‰æ‹©äº† AP çš„ç»„ä»¶ã€‚</li></ul><p>Eureka-Server å¯ä»¥ä½¿ç”¨ç›´æ¥é…ç½®æ‰€æœ‰èŠ‚ç‚¹çš„æœåŠ¡åœ°å€ï¼Œæˆ–è€…åŸºäº DNS é…ç½®ã€‚æ¨èé˜…è¯»ï¼š<a href="http://blog.didispace.com/springcloud6/?from=http://www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudæ„å»ºå¾®æœåŠ¡æ¶æ„ï¼ˆå…­ï¼‰é«˜å¯ç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‹</a> ã€‚</p><p>æœ¬æ–‡ä¸»è¦ç±»åœ¨ <code>com.netflix.eureka.cluster</code> åŒ…ä¸‹ã€‚</p><p>OKï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„é¨æ¸¸åœ¨ä»£ç çš„æµ·æ´‹ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><p>ps ï¼š<strong>æ³¨æ„</strong>ï¼Œæœ¬æ–‡æåˆ°çš„<strong>åŒæ­¥</strong>ï¼Œå‡†ç¡®æ¥è¯´æ˜¯<strong>å¤åˆ¶( Replication )</strong>ã€‚</p><h1>2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</h1><p><code>com.netflix.eureka.cluster.PeerEurekaNodes</code> ï¼ŒEureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeerEurekaNodes</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(PeerEurekaNodes.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹æ³¨å†Œè¡¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaServerConfig serverConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Client é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaClientConfig clientConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server ç¼–è§£ç </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ServerCodecs serverCodecs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯ç®¡ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é›†ç¾¤èŠ‚ç‚¹æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;PeerEurekaNode&gt; peerEurekaNodes = Collections.emptyList();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server æœåŠ¡åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Set&lt;String&gt; peerEurekaNodeUrls = Collections.emptySet();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ScheduledExecutorService taskExecutor;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PeerEurekaNodes</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">            PeerAwareInstanceRegistry registry,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaServerConfig serverConfig,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">            ServerCodecs serverCodecs,</span></span></div><div class="line"><span class="function"><span class="params">            ApplicationInfoManager applicationInfoManager)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.registry = registry;</div><div class="line">        <span class="keyword">this</span>.serverConfig = serverConfig;</div><div class="line">        <span class="keyword">this</span>.clientConfig = clientConfig;</div><div class="line">        <span class="keyword">this</span>.serverCodecs = serverCodecs;</div><div class="line">        <span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>peerEurekaNodes</code>, <code>peerEurekaNodeUrls</code>, <code>taskExecutor</code> å±æ€§ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­<strong>æœªè®¾ç½®å’Œåˆå§‹åŒ–</strong>ï¼Œè€Œæ˜¯åœ¨ <code>PeerEurekaNodes#start()</code> æ–¹æ³•ï¼Œè®¾ç½®å’Œåˆå§‹åŒ–ï¼Œä¸‹æ–‡æˆ‘ä»¬ä¼šè§£æè¿™ä¸ªæ–¹æ³•ã€‚</li><li>Eureka-Server åœ¨åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>EurekaBootStrap#getPeerEurekaNodes(...)</code> æ–¹æ³•ï¼Œåˆ›å»º PeerEurekaNodes ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/EurekaBootStrap.java#L245" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ã€‚</li></ul><h2>2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</h2><p>è°ƒç”¨ <code>PeerEurekaNodes#start()</code> æ–¹æ³•ï¼Œé›†ç¾¤èŠ‚ç‚¹å¯åŠ¨ï¼Œä¸»è¦å®Œæˆä¸¤ä¸ªé€»è¾‘ï¼š</p><ul><li>åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</li><li>åˆå§‹åŒ–å›ºå®šå‘¨æœŸ( é»˜è®¤ï¼š10 åˆ†é’Ÿï¼Œå¯é…ç½® )æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯çš„ä»»åŠ¡</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»º å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"> <span class="number">3</span>:     taskExecutor = Executors.newSingleThreadScheduledExecutor(</div><div class="line"> <span class="number">4</span>:             <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line"> <span class="number">5</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:                 <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:                     Thread thread = <span class="keyword">new</span> Thread(r, <span class="string">"Eureka-PeerNodesUpdater"</span>);</div><div class="line"> <span class="number">8</span>:                     thread.setDaemon(<span class="keyword">true</span>);</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> thread;</div><div class="line"><span class="number">10</span>:                 &#125;</div><div class="line"><span class="number">11</span>:             &#125;</div><div class="line"><span class="number">12</span>:     );</div><div class="line"><span class="number">13</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>:         <span class="comment">// åˆå§‹åŒ– é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line"><span class="number">15</span>:         updatePeerEurekaNodes(resolvePeerUrls());</div><div class="line"><span class="number">16</span>:         <span class="comment">// åˆå§‹åŒ– åˆå§‹åŒ–å›ºå®šå‘¨æœŸæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯çš„ä»»åŠ¡</span></div><div class="line"><span class="number">17</span>:         Runnable peersUpdateTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">18</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">19</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">20</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:                     updatePeerEurekaNodes(resolvePeerUrls());</div><div class="line"><span class="number">22</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:                     logger.error(<span class="string">"Cannot update the replica Nodes"</span>, e);</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:         &#125;;</div><div class="line"><span class="number">28</span>:         taskExecutor.scheduleWithFixedDelay(</div><div class="line"><span class="number">29</span>:                 peersUpdateTask,</div><div class="line"><span class="number">30</span>:                 serverConfig.getPeerEurekaNodesUpdateIntervalMs(),</div><div class="line"><span class="number">31</span>:                 serverConfig.getPeerEurekaNodesUpdateIntervalMs(),</div><div class="line"><span class="number">32</span>:                 TimeUnit.MILLISECONDS</div><div class="line"><span class="number">33</span>:         );</div><div class="line"><span class="number">34</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">35</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>:     <span class="comment">// æ‰“å° é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">for</span> (PeerEurekaNode node : peerEurekaNodes) &#123;</div><div class="line"><span class="number">39</span>:         logger.info(<span class="string">"Replica node URL:  "</span> + node.getServiceUrl());</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 15 è¡Œ &amp;&amp; ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#updatePeerEurekaNodes()</code> æ–¹æ³•ï¼Œæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ã€‚</li></ul><h2>2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>#resolvePeerUrls()</code> æ–¹æ³•ï¼Œè·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">resolvePeerUrls</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„</span></div><div class="line"> <span class="number">3</span>:     InstanceInfo myInfo = applicationInfoManager.getInfo();</div><div class="line"> <span class="number">4</span>:     String zone = InstanceInfo.getZone(clientConfig.getAvailabilityZones(clientConfig.getRegion()), myInfo);</div><div class="line"> <span class="number">5</span>:     List&lt;String&gt; replicaUrls = EndpointUtils.getDiscoveryServiceUrls(clientConfig, zone, <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(myInfo));</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// ç§»é™¤è‡ªå·±ï¼ˆé¿å…å‘è‡ªå·±åŒæ­¥ï¼‰</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">while</span> (idx &lt; replicaUrls.size()) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (isThisMyUrl(replicaUrls.get(idx))) &#123;</div><div class="line"><span class="number">11</span>:             replicaUrls.remove(idx);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:             idx++;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>:     <span class="keyword">return</span> replicaUrls;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šè·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„ã€‚<code>EndpointUtils#getDiscoveryServiceUrls(...)</code> æ–¹æ³•ï¼Œé€»è¾‘ä¸ <a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/?self">ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹ã€Œ3.4 ConfigClusterResolverã€</a> åŸºæœ¬ç±»ä¼¼ã€‚EndpointUtils æ­£åœ¨é€æ­¥ï¼ŒçŒœæµ‹æœªæ¥è¿™é‡Œä¼šæ›¿æ¢ã€‚</li><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šç§»é™¤è‡ªèº«èŠ‚ç‚¹ï¼Œé¿å…å‘è‡ªå·±åŒæ­¥ã€‚</li></ul><hr><p>è°ƒç”¨ <code>#updatePeerEurekaNodes()</code> æ–¹æ³•ï¼Œæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸»è¦å®Œæˆä¸¤éƒ¨åˆ†é€»è¾‘ï¼š</p><ul><li>æ·»åŠ æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹</li><li>å…³é—­åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updatePeerEurekaNodes</span><span class="params">(List&lt;String&gt; newPeerUrls)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (newPeerUrls.isEmpty()) &#123;</div><div class="line"> <span class="number">3</span>:         logger.warn(<span class="string">"The replica size seems to be empty. Check the route 53 DNS Registry"</span>);</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// è®¡ç®— æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></div><div class="line"> <span class="number">8</span>:     Set&lt;String&gt; toShutdown = <span class="keyword">new</span> HashSet&lt;&gt;(peerEurekaNodeUrls);</div><div class="line"> <span class="number">9</span>:     toShutdown.removeAll(newPeerUrls);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// è®¡ç®— åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></div><div class="line"><span class="number">12</span>:     Set&lt;String&gt; toAdd = <span class="keyword">new</span> HashSet&lt;&gt;(newPeerUrls);</div><div class="line"><span class="number">13</span>:     toAdd.removeAll(peerEurekaNodeUrls);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (toShutdown.isEmpty() &amp;&amp; toAdd.isEmpty()) &#123; <span class="comment">// No change</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// å…³é—­åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// Remove peers no long available</span></div><div class="line"><span class="number">21</span>:     List&lt;PeerEurekaNode&gt; newNodeList = <span class="keyword">new</span> ArrayList&lt;&gt;(peerEurekaNodes);</div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (!toShutdown.isEmpty()) &#123;</div><div class="line"><span class="number">23</span>:         logger.info(<span class="string">"Removing no longer available peer nodes &#123;&#125;"</span>, toShutdown);</div><div class="line"><span class="number">24</span>:         <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="number">25</span>:         <span class="keyword">while</span> (i &lt; newNodeList.size()) &#123;</div><div class="line"><span class="number">26</span>:             PeerEurekaNode eurekaNode = newNodeList.get(i);</div><div class="line"><span class="number">27</span>:             <span class="keyword">if</span> (toShutdown.contains(eurekaNode.getServiceUrl())) &#123;</div><div class="line"><span class="number">28</span>:                 newNodeList.remove(i);</div><div class="line"><span class="number">29</span>:                 eurekaNode.shutDown(); <span class="comment">// å…³é—­</span></div><div class="line"><span class="number">30</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                 i++;</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="comment">// æ·»åŠ æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹</span></div><div class="line"><span class="number">37</span>:     <span class="comment">// Add new peers</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (!toAdd.isEmpty()) &#123;</div><div class="line"><span class="number">39</span>:         logger.info(<span class="string">"Adding new peer nodes &#123;&#125;"</span>, toAdd);</div><div class="line"><span class="number">40</span>:         <span class="keyword">for</span> (String peerUrl : toAdd) &#123;</div><div class="line"><span class="number">41</span>:             newNodeList.add(createPeerEurekaNode(peerUrl));</div><div class="line"><span class="number">42</span>:         &#125;</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// èµ‹å€¼</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">this</span>.peerEurekaNodes = newNodeList;</div><div class="line"><span class="number">47</span>:     <span class="keyword">this</span>.peerEurekaNodeUrls = <span class="keyword">new</span> HashSet&lt;&gt;(newPeerUrls);</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 7 è‡³ 9 è¡Œ ï¼š<strong>è®¡ç®—</strong>æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€ã€‚</p></li><li><p>ç¬¬ 11 è‡³ 13 è¡Œ ï¼š<strong>è®¡ç®—</strong>åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 34 è¡Œ ï¼š<strong>å…³é—­</strong>åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹ã€‚</p></li><li><p>ç¬¬ 36 è‡³ 43 è¡Œ ï¼š<strong>æ·»åŠ </strong>æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹ã€‚è°ƒç”¨ <code>#createPeerEurekaNode(peerUrl)</code> æ–¹æ³•ï¼Œåˆ›å»ºé›†ç¾¤èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">protected</span> PeerEurekaNode <span class="title">createPeerEurekaNode</span><span class="params">(String peerEurekaNodeUrl)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     HttpReplicationClient replicationClient = JerseyReplicationClient.createReplicationClient(serverConfig, serverCodecs, peerEurekaNodeUrl);</div><div class="line"><span class="number">3</span>:     String targetHost = hostFromUrl(peerEurekaNodeUrl);</div><div class="line"><span class="number">4</span>:     <span class="keyword">if</span> (targetHost == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">5</span>:         targetHost = <span class="string">"host"</span>;</div><div class="line"><span class="number">6</span>:     &#125;</div><div class="line"><span class="number">7</span>:     <span class="keyword">return</span> <span class="keyword">new</span> PeerEurekaNode(registry, targetHost, peerEurekaNodeUrl, replicationClient, serverConfig);</div><div class="line"><span class="number">8</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è¡Œ ï¼šåˆ›å»º Eureka-Server é›†ç¾¤é€šä¿¡å®¢æˆ·ç«¯ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/transport/?self">ã€ŠEureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡ã€‹ã€Œ4.2 JerseyReplicationClientã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 7 è¡Œ ï¼šåˆ›å»º PeerEurekaNode ï¼Œåœ¨ <a href="#">ã€Œ2.3 PeerEurekaNodeã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>2.3 é›†ç¾¤èŠ‚ç‚¹</h2><p><code>com.netflix.eureka.cluster.PeerEurekaNode</code> ï¼Œå•ä¸ªé›†ç¾¤èŠ‚ç‚¹ã€‚</p><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/fcc9027a197783a23e7cb72ad0f617b7dc63d221/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L111" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹<strong>æ„é€ æ–¹æ³•</strong></p><ul><li>ç¬¬ 129 è¡Œ ï¼šåˆ›å»º ReplicationTaskProcessor ã€‚åœ¨ <a href="#">ã€Œ4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨ã€</a> è¯¦ç»†è§£æ</li><li>ç¬¬ 131 è‡³ 140 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡ä»»åŠ¡</strong>åˆ†å‘å™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 142 è‡³ 151 è¡Œ ï¼šåˆ›å»º<strong>å•ä»»åŠ¡</strong>åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( <code>Autoscaling Group</code> ) åŒæ­¥çŠ¶æ€ã€‚æš‚æ—¶è·³è¿‡ã€‚</li></ul><h1>3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</h1><p>Eureka-Server å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#syncUp()</code> æ–¹æ³•ï¼Œä»é›†ç¾¤çš„ä¸€ä¸ª Eureka-Server èŠ‚ç‚¹è·å–<strong>åˆå§‹</strong>æ³¨å†Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">syncUp</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// Copy entire entry from neighboring DS node</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ((i &lt; serverConfig.getRegistrySyncRetries()) &amp;&amp; (count == <span class="number">0</span>)); i++) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æœªè¯»å–åˆ°æ³¨å†Œä¿¡æ¯ï¼Œsleep ç­‰å¾…</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">10</span>:                 Thread.sleep(serverConfig.getRegistrySyncRetryWaitMs());</div><div class="line"><span class="number">11</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Interrupted during registry transfer.."</span>);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:         <span class="comment">// è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="number">18</span>:         Applications apps = eurekaClient.getApplications();</div><div class="line"><span class="number">19</span>:         <span class="keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (isRegisterable(instance)) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ³¨å†Œ</span></div><div class="line"><span class="number">23</span>:                         register(instance, instance.getLeaseInfo().getDurationInSecs(), <span class="keyword">true</span>); <span class="comment">// æ³¨å†Œ</span></div><div class="line"><span class="number">24</span>:                         count++;</div><div class="line"><span class="number">25</span>:                     &#125;</div><div class="line"><span class="number">26</span>:                 &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">27</span>:                     logger.error(<span class="string">"During DS init copy"</span>, t);</div><div class="line"><span class="number">28</span>:                 &#125;</div><div class="line"><span class="number">29</span>:             &#125;</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>:     <span class="keyword">return</span> count;</div><div class="line"><span class="number">33</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šæœªè·å–åˆ°æ³¨å†Œä¿¡æ¯ï¼Œ<code>sleep</code> ç­‰å¾…å†æ¬¡é‡è¯•ã€‚</li><li>ç¬¬ 17 è‡³ 30 è¡Œ ï¼šè·å–æ³¨å†Œä¿¡æ¯ï¼Œè‹¥è·å–åˆ°ï¼Œæ³¨å†Œåˆ°è‡ªèº«èŠ‚ç‚¹ã€‚<ul><li>ç¬¬ 22 è¡Œ ï¼šåˆ¤æ–­åº”ç”¨å®ä¾‹æ˜¯å¦èƒ½å¤Ÿæ³¨å†Œåˆ°è‡ªèº«èŠ‚ç‚¹ã€‚ä¸»è¦ç”¨äºäºšé©¬é€Š AWS ç¯å¢ƒä¸‹çš„åˆ¤æ–­ï¼Œè‹¥ééƒ¨ç½²åœ¨äºšé©¬é€Šé‡Œï¼Œéƒ½è¿”å› <code>true</code> ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/registry/PeerAwareInstanceRegistryImpl.java#L593" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#register()</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹åˆ°è‡ªèº«èŠ‚ç‚¹ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><hr><p>è‹¥è°ƒç”¨ <code>#syncUp()</code> æ–¹æ³•ï¼Œæœªè·å–åˆ°åº”ç”¨å®ä¾‹ï¼Œåˆ™ Eureka-Server ä¼šæœ‰ä¸€æ®µæ—¶é—´( é»˜è®¤ï¼š5 åˆ†é’Ÿï¼Œå¯é… )ä¸å…è®¸è¢« Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œé¿å…å½±å“ Eureka-Client ã€‚</p><ul><li><p>æ ‡è®° Eureka-Server å¯åŠ¨æ—¶ï¼Œæœªè·å–åˆ°åº”ç”¨å®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> peerInstancesTransferEmptyOnStartup = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.peerInstancesTransferEmptyOnStartup = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>åˆ¤æ–­ Eureka-Server æ˜¯å¦å…è®¸è¢« Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldAllowAccess</span><span class="params">(<span class="keyword">boolean</span> remoteRegionRequired)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.peerInstancesTransferEmptyOnStartup) &#123;</div><div class="line">       <span class="comment">// è®¾ç½®å¯åŠ¨æ—¶é—´</span></div><div class="line">       <span class="keyword">this</span>.startupTime = System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (!(System.currentTimeMillis() &gt; <span class="keyword">this</span>.startupTime + serverConfig.getWaitTimeInMsWhenSyncEmpty())) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>4. åŒæ­¥æ³¨å†Œä¿¡æ¯</h1><p>Eureka-Server é›†ç¾¤åŒæ­¥æ³¨å†Œä¿¡æ¯å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/02.png" alt=""></p><ul><li>Eureka-Server æ¥æ”¶åˆ° Eureka-Client çš„ Registerã€Heartbeatã€Cancelã€StatusUpdateã€DeleteStatusOverride æ“ä½œï¼Œå›ºå®šé—´éš”( é»˜è®¤å€¼ ï¼š500 æ¯«ç§’ï¼Œå¯é… )å‘ Eureka-Server é›†ç¾¤å†…å…¶ä»–èŠ‚ç‚¹åŒæ­¥( <strong>å‡†å®æ—¶ï¼Œéå®æ—¶</strong> )ã€‚</li></ul><h2>4.1 åŒæ­¥æ“ä½œç±»å‹</h2><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl.Action</code> ï¼ŒåŒæ­¥æ“ä½œç±»å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Action &#123;</div><div class="line">   Heartbeat, Register, Cancel, StatusUpdate, DeleteStatusOverride;</div><div class="line"></div><div class="line">   <span class="comment">// ... çœç•¥ç›‘æ§ç›¸å…³å±æ€§</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Register ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>Heartbeat ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>Cancel ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸‰ï¼‰ä¹‹ä¸‹çº¿ã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>StatusUpdate ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>DeleteStatusOverride ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æ</li></ul><h2>4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</h2><p>Eureka-Server åœ¨å®Œæˆ Eureka-Client å‘èµ·çš„ä¸Šè¿°æ“ä½œåœ¨<strong>è‡ªèº«èŠ‚ç‚¹çš„æ‰§è¡Œå</strong>ï¼Œå‘é›†ç¾¤å†…å…¶ä»– Eureka-Server å‘èµ·åŒæ­¥æ“ä½œã€‚ä»¥ Register æ“ä½œä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´</span></div><div class="line">   <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</div><div class="line">   <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</div><div class="line">       leaseDuration = info.getLeaseInfo().getDurationInSecs();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">   <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</div><div class="line">   <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">   replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æœ€åä¸€è¡Œï¼Œè°ƒç”¨ <code>#replicateToPeers(...)</code> æ–¹æ³•ï¼Œä¼ é€’<strong>å¯¹åº”çš„åŒæ­¥æ“ä½œç±»å‹</strong>ï¼Œå‘èµ·åŒæ­¥æ“ä½œã€‚</li></ul><hr><p><code>#replicateToPeers(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">2</span>:                               InstanceInfo info <span class="comment">/* optional */</span>,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                               InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     Stopwatch tracer = action.getTimer().start();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (isReplication) &#123;</div><div class="line"> <span class="number">7</span>:             numberOfReplicationsLastMin.increment();</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:         <span class="comment">// Eureka-Server å‘èµ·çš„è¯·æ±‚ æˆ–è€… é›†ç¾¤ä¸ºç©º</span></div><div class="line"><span class="number">11</span>:         <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</div><div class="line"><span class="number">17</span>:             <span class="comment">// If the url represents this host, do not replicate to yourself.</span></div><div class="line"><span class="number">18</span>:             <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:             replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">24</span>:         tracer.stop();</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 10 è‡³ 14 è¡Œ ï¼šEureka-Server åœ¨å¤„ç†ä¸Šè¿°æ“ä½œ( Action )ï¼Œæ— è®ºæ¥è‡ª Eureka-Client å‘èµ·è¯·æ±‚ï¼Œè¿˜æ˜¯ Eureka-Server å‘èµ·åŒæ­¥ï¼Œè°ƒç”¨çš„å†…éƒ¨æ–¹æ³•ç›¸åŒï¼Œé€šè¿‡ <code>isReplication=true</code> å‚æ•°ï¼Œé¿å…æ­»å¾ªç¯åŒæ­¥ã€‚</li><li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼š<strong>å¾ªç¯</strong>é›†ç¾¤å†…<strong>æ¯ä¸ª</strong>èŠ‚ç‚¹ï¼Œè°ƒç”¨ <code>#replicateInstanceActionsToPeers(...)</code> æ–¹æ³•ï¼Œå‘èµ·åŒæ­¥æ“ä½œã€‚</li></ul><hr><p><code>#replicateInstanceActionsToPeers(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateInstanceActionsToPeers</span><span class="params">(Action action, String appName,</span></span></div><div class="line"><span class="function"><span class="params">                                            String id, InstanceInfo info, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                                            PeerEurekaNode node)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       InstanceInfo infoFromRegistry;</div><div class="line">       CurrentRequestVersion.set(Version.V2);</div><div class="line">       <span class="keyword">switch</span> (action) &#123;</div><div class="line">           <span class="keyword">case</span> Cancel:</div><div class="line">               node.cancel(appName, id);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Heartbeat:</div><div class="line">               InstanceStatus overriddenStatus = overriddenInstanceStatusMap.get(id);</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.heartbeat(appName, id, infoFromRegistry, overriddenStatus, <span class="keyword">false</span>);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Register:</div><div class="line">               node.register(info);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> StatusUpdate:</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.statusUpdate(appName, id, newStatus, infoFromRegistry);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> DeleteStatusOverride:</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.deleteStatusOverride(appName, id, infoFromRegistry);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot replicate information to &#123;&#125; for action &#123;&#125;"</span>, node.getServiceUrl(), action.name(), t);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><strong>Cancel</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#cancel(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L157" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>Heartbeat</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#heartbeat(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L194" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>Register</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#register(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L134" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>StatusUpdate</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#statusUpdate(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L243" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p><strong>DeleteStatusOverride</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#deleteStatusOverride(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L294" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</p></li><li><p>ä¸Šé¢çš„æ¯ä¸ªæ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬<strong>éƒ½</strong>ä¼šçœ‹åˆ°ç±»ä¼¼è¿™ä¹ˆä¸€æ®µä»£ç  ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">batchingDispatcher.process(</div><div class="line">    taskId(<span class="string">"$&#123;action&#125;"</span>, appName, id), <span class="comment">// id</span></div><div class="line">    <span class="keyword">new</span> InstanceReplicationTask(targetHost, Action.Cancel, appName, id) &#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> replicationClient.doString(...);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">// do Something...</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;, <span class="comment">// ReplicationTask å­ç±»</span></div><div class="line">    expiryTime</div><div class="line">)</div></pre></td></tr></table></figure></p><ul><li><p><code>#task(...)</code> æ–¹æ³•ï¼Œç”ŸæˆåŒæ­¥æ“ä½œä»»åŠ¡<strong>ç¼–å·</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">taskId</span><span class="params">(String requestType, String appName, String id)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> requestType + <span class="string">'#'</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>ç›¸åŒåº”ç”¨å®ä¾‹çš„ç›¸åŒåŒæ­¥æ“ä½œä½¿ç”¨ç›¸åŒä»»åŠ¡ç¼–å·</strong>ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ2. æ•´ä½“æµç¨‹ã€</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°&quot; æ¥æ”¶çº¿ç¨‹( Runner )åˆå¹¶ä»»åŠ¡ï¼Œå°†ç›¸åŒä»»åŠ¡ç¼–å·çš„ä»»åŠ¡åˆå¹¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚ &quot;ï¼Œå› æ­¤ï¼Œç›¸åŒåº”ç”¨å®ä¾‹çš„ç›¸åŒåŒæ­¥æ“ä½œå°±èƒ½è¢«åˆå¹¶ï¼Œå‡å°‘æ“ä½œé‡ã€‚ä¾‹å¦‚ï¼ŒEureka-Server åŒæ­¥æŸä¸ªåº”ç”¨å®ä¾‹çš„ Heartbeat æ“ä½œï¼Œæ¥æ”¶åŒæ­¥çš„ Eureak-Server æŒ‚äº†ï¼Œä¸€æ–¹é¢è¿™ä¸ªåº”ç”¨çš„è¿™æ¬¡æ“ä½œä¼š<strong>é‡è¯•</strong>ï¼Œå¦ä¸€æ–¹é¢ï¼Œè¿™ä¸ªåº”ç”¨å®ä¾‹ä¼šå‘èµ·<strong>æ–°çš„</strong> Heartbeat æ“ä½œï¼Œé€šè¿‡ä»»åŠ¡ç¼–å·åˆå¹¶ï¼Œæ¥æ”¶åŒæ­¥çš„ Eureka-Server æ¢å¤åï¼Œå‡å°‘æ”¶åˆ°<strong>é‡å¤ç§¯å‹</strong>çš„ä»»åŠ¡ã€‚</li></ul></li><li><p>InstanceReplicationTask ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡ï¼Œåœ¨ <a href="#">ã€Œ4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡ã€</a> è¯¦ç»†è§£æã€‚</p></li><li><p><code>expiryTime</code> ï¼Œä»»åŠ¡è¿‡æœŸæ—¶é—´ã€‚</p></li></ul></li></ul><h3>4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡</h3><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/03.png" alt=""></p><ul><li><code>com.netflix.eureka.cluster.ReplicationTask</code> ï¼ŒåŒæ­¥ä»»åŠ¡<strong>æŠ½è±¡ç±»</strong><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTask.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ ReplicationTask ä»£ç ã€‚</li><li>å®šä¹‰äº† <code>#getTaskName()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ã€‚</li><li>å®šä¹‰äº† <code>#execute()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€‚</li><li>å®ç°äº† <code>#handleSuccess()</code> æ–¹æ³•ï¼Œå¤„ç†æˆåŠŸæ‰§è¡ŒåŒæ­¥ç»“æœã€‚</li><li>å®ç°äº† <code>#handleFailure(...)</code> æ–¹æ³•ï¼Œå¤„ç†å¤±è´¥æ‰§è¡ŒåŒæ­¥ç»“æœã€‚</li></ul></li><li><code>com.netflix.eureka.cluster.InstanceReplicationTask</code> ï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä»»åŠ¡<strong>æŠ½è±¡ç±»</strong><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/InstanceReplicationTask.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ InstanceReplicationTask ä»£ç ã€‚</li><li>å®ç°äº†çˆ¶ç±» <code>#getTaskName()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ã€‚</li></ul></li><li><code>com.netflix.eureka.cluster.AsgReplicationTask</code> ï¼Œäºšé©¬é€Š AWS ä½¿ç”¨ï¼Œæš‚æ—¶è·³è¿‡ã€‚</li></ul><p>ä»ä¸Šé¢ <code>PeerEurekaNode#åŒæ­¥æ“ä½œ(...)</code> æ–¹æ³•ï¼Œ<strong>å…¨éƒ¨</strong>å®ç°äº† InstanceReplicationTask ç±»çš„ <code>#execute()</code> æ–¹æ³•ï¼Œ<strong>éƒ¨åˆ†</strong>é‡å†™äº† <code>#handleFailure(...)</code> æ–¹æ³•ã€‚</p><h3>4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨</h3><p><code>com.netflix.eureka.cluster.InstanceReplicationTask</code> ï¼Œå®ç° TaskProcessor <strong>æ¥å£</strong>ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨ã€‚</p><ul><li>TaskProcessor ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ InstanceReplicationTask ä»£ç ã€‚</li></ul><p><code>ReplicationTaskProcessor#process(task)</code> ï¼Œ<strong>å¤„ç†å•ä»»åŠ¡</strong>ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( <code>Autoscaling Group</code> ) åŒæ­¥çŠ¶æ€ï¼Œæš‚æ—¶è·³è¿‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L38" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚</p><p><code>ReplicationTaskProcessor#process(tasks)</code> ï¼Œ<strong>å¤„ç†æ‰¹é‡ä»»åŠ¡</strong>ï¼Œç”¨äº Eureka-Server é›†ç¾¤æ³¨å†Œä¿¡æ¯çš„åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œé€šè¿‡è°ƒç”¨è¢«åŒæ­¥çš„ Eureka-Server çš„ <code>peerreplication/batch/</code> æ¥å£ï¼Œä¸€æ¬¡æ€§å°†æ‰¹é‡( å¤šä¸ª )çš„åŒæ­¥æ“ä½œä»»åŠ¡å‘èµ·è¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ProcessingResult <span class="title">process</span><span class="params">(List&lt;ReplicationTask&gt; tasks)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡</span></div><div class="line"> <span class="number">4</span>:     ReplicationList list = createReplicationListOf(tasks);</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å‘èµ· æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚</span></div><div class="line"> <span class="number">7</span>:         EurekaHttpResponse&lt;ReplicationListResponse&gt; response = replicationClient.submitBatchUpdates(list);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç† æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!isSuccess(statusCode)) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (statusCode == <span class="number">503</span>) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Server busy (503) HTTP status code received from the peer &#123;&#125;; rescheduling tasks after delay"</span>, peerId);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">return</span> ProcessingResult.Congestion;</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="comment">// Unexpected error returned from the server. This should ideally never happen.</span></div><div class="line"><span class="number">16</span>:                 logger.error(<span class="string">"Batch update failure with HTTP status code &#123;&#125;; discarding &#123;&#125; replication tasks"</span>, statusCode, tasks.size());</div><div class="line"><span class="number">17</span>:                 <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             handleBatchResponse(tasks, response.getEntity().getResponseList());</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:         <span class="keyword">if</span> (isNetworkConnectException(e)) &#123;</div><div class="line"><span class="number">24</span>:             logNetworkErrorSample(<span class="keyword">null</span>, e);</div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> ProcessingResult.TransientError;</div><div class="line"><span class="number">26</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:             logger.error(<span class="string">"Not re-trying this exception because it does not seem to be a network exception"</span>, e);</div><div class="line"><span class="number">28</span>:             <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> ProcessingResult.Success;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šåˆ›å»ºæ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡( ReplicationList ) ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œå’±å°±ä¸å•°å—¦è´´ä»£ç äº†ã€‚<ul><li>ReplicationList ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationList.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li>ReplicationInstance ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationInstance.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li><code>#createReplicationListOf(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L142" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li><code>#createReplicationInstanceOf(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L173" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li></ul></li><li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>JerseyReplicationClient#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œè¯·æ±‚ <code>peerreplication/batch/</code> æ¥å£ï¼Œä¸€æ¬¡æ€§å°†æ‰¹é‡( å¤šä¸ª )çš„åŒæ­¥æ“ä½œä»»åŠ¡å‘èµ·è¯·æ±‚ã€‚<ul><li><code>JerseyReplicationClient#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/transport/JerseyReplicationClient.java#L109" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li>ReplicationListResponse ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationListResponse.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li>ReplicationInstanceResponse ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationInstanceResponse.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li></ul></li><li>ç¬¬ 9 è‡³ 31 è¡Œ ï¼šå¤„ç†æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”ï¼Œåœ¨ <a href="#">ã€Œ4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</h2><p><code>com.netflix.eureka.resources.PeerReplicationResource</code> ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡ Resource ( Controller )ã€‚</p><p><code>peerreplication/batch/</code> æ¥å£ï¼Œæ˜ å°„ <code>PeerReplicationResource#batchReplication(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Path</span>(<span class="string">"batch"</span>)</div><div class="line"> <span class="number">2</span>: <span class="meta">@POST</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">batchReplication</span><span class="params">(ReplicationList replicationList)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:         ReplicationListResponse batchResponse = <span class="keyword">new</span> ReplicationListResponse();</div><div class="line"> <span class="number">6</span>:         <span class="comment">// é€ä¸ªåŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœ( ReplicationInstanceResponse ) åˆå¹¶åˆ° ReplicationListResponse ã€‚</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">for</span> (ReplicationInstance instanceInfo : replicationList.getReplicationList()) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:                 batchResponse.addResponse(dispatch(instanceInfo));</div><div class="line"><span class="number">10</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">11</span>:                 batchResponse.addResponse(<span class="keyword">new</span> ReplicationInstanceResponse(Status.INTERNAL_SERVER_ERROR.getStatusCode(), <span class="keyword">null</span>));</div><div class="line"><span class="number">12</span>:                 logger.error(instanceInfo.getAction() + <span class="string">" request processing failed for batch item "</span></div><div class="line"><span class="number">13</span>:                         + instanceInfo.getAppName() + <span class="string">'/'</span> + instanceInfo.getId(), e);</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> Response.ok(batchResponse).build();</div><div class="line"><span class="number">17</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">18</span>:         logger.error(<span class="string">"Cannot execute batch Request"</span>, e);</div><div class="line"><span class="number">19</span>:         <span class="keyword">return</span> Response.status(Status.INTERNAL_SERVER_ERROR).build();</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="function"><span class="keyword">private</span> ReplicationInstanceResponse <span class="title">dispatch</span><span class="params">(ReplicationInstance instanceInfo)</span> </span>&#123;</div><div class="line"><span class="number">24</span>:     ApplicationResource applicationResource = createApplicationResource(instanceInfo);</div><div class="line"><span class="number">25</span>:     InstanceResource resource = createInstanceResource(instanceInfo, applicationResource);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:     String lastDirtyTimestamp = toString(instanceInfo.getLastDirtyTimestamp());</div><div class="line"><span class="number">28</span>:     String overriddenStatus = toString(instanceInfo.getOverriddenStatus());</div><div class="line"><span class="number">29</span>:     String instanceStatus = toString(instanceInfo.getStatus());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     Builder singleResponseBuilder = <span class="keyword">new</span> Builder();</div><div class="line"><span class="number">32</span>:     <span class="keyword">switch</span> (instanceInfo.getAction()) &#123;</div><div class="line"><span class="number">33</span>:         <span class="keyword">case</span> Register:</div><div class="line"><span class="number">34</span>:             singleResponseBuilder = handleRegister(instanceInfo, applicationResource);</div><div class="line"><span class="number">35</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> Heartbeat:</div><div class="line"><span class="number">37</span>:             singleResponseBuilder = handleHeartbeat(serverConfig, resource, lastDirtyTimestamp, overriddenStatus, instanceStatus);</div><div class="line"><span class="number">38</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">39</span>:         <span class="keyword">case</span> Cancel:</div><div class="line"><span class="number">40</span>:             singleResponseBuilder = handleCancel(resource);</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> StatusUpdate:</div><div class="line"><span class="number">43</span>:             singleResponseBuilder = handleStatusUpdate(instanceInfo, resource);</div><div class="line"><span class="number">44</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">45</span>:         <span class="keyword">case</span> DeleteStatusOverride:</div><div class="line"><span class="number">46</span>:             singleResponseBuilder = handleDeleteStatusOverride(instanceInfo, resource);</div><div class="line"><span class="number">47</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">48</span>:     &#125;</div><div class="line"><span class="number">49</span>:     <span class="keyword">return</span> singleResponseBuilder.build();</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šé€ä¸ªå¤„ç†<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œå¹¶å°†å¤„ç†ç»“æœ( ReplicationInstanceResponse ) æ·»åŠ åˆ° ReplicationListResponse ã€‚</li><li>ç¬¬ 23 è‡³ 50 è¡Œ ï¼šå¤„ç†<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œè¿”å›å¤„ç†ç»“æœ( ReplicationInstanceResponse )ã€‚<ul><li>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º ApplicationResource , InstanceResource ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…è¯¥æ–¹æ³•æ˜¯æŠŠ<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡æäº¤åˆ°å…¶ä»– Resource ( Controller ) å¤„ç†ï¼ŒEureka-Server æ”¶åˆ° Eureka-Client è¯·æ±‚å“åº”çš„ Resource ( Controller ) æ˜¯<strong>ç›¸åŒçš„é€»è¾‘</strong>ã€‚</li><li>Register ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L137" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleRegister(...)</code> æ–¹æ³•ã€‚</li><li>Heartbeat ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L147" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleHeartbeat(...)</code> æ–¹æ³•ã€‚</li><li>Cancel ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L142" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleCancel(...)</code> æ–¹æ³•ã€‚</li><li>StatusUpdate ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L165" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleStatusUpdate(...)</code> æ–¹æ³•ã€‚</li><li>DeleteStatusOverride ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L170" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleDeleteStatusOverride(...)</code> æ–¹æ³•ã€‚</li></ul></li></ul><h2>4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</h2><p>ğŸ˜ˆ æƒ³æƒ³å°±æœ‰å°æ¿€åŠ¨ï¼Œç»ˆäºå†™åˆ°è¿™é‡Œäº†ã€‚</p><p>æ¥ <code>ReplicationTaskProcessor#process(tasks)</code> æ–¹æ³•ï¼Œå¤„ç†æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ProcessingResult <span class="title">process</span><span class="params">(List&lt;ReplicationTask&gt; tasks)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡</span></div><div class="line"> <span class="number">4</span>:     ReplicationList list = createReplicationListOf(tasks);</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å‘èµ· æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚</span></div><div class="line"> <span class="number">7</span>:         EurekaHttpResponse&lt;ReplicationListResponse&gt; response = replicationClient.submitBatchUpdates(list);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç† æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!isSuccess(statusCode)) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (statusCode == <span class="number">503</span>) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Server busy (503) HTTP status code received from the peer &#123;&#125;; rescheduling tasks after delay"</span>, peerId);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">return</span> ProcessingResult.Congestion;</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="comment">// Unexpected error returned from the server. This should ideally never happen.</span></div><div class="line"><span class="number">16</span>:                 logger.error(<span class="string">"Batch update failure with HTTP status code &#123;&#125;; discarding &#123;&#125; replication tasks"</span>, statusCode, tasks.size());</div><div class="line"><span class="number">17</span>:                 <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             handleBatchResponse(tasks, response.getEntity().getResponseList());</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:         <span class="keyword">if</span> (isNetworkConnectException(e)) &#123;</div><div class="line"><span class="number">24</span>:             logNetworkErrorSample(<span class="keyword">null</span>, e);</div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> ProcessingResult.TransientError;</div><div class="line"><span class="number">26</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:             logger.error(<span class="string">"Not re-trying this exception because it does not seem to be a network exception"</span>, e);</div><div class="line"><span class="number">28</span>:             <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> ProcessingResult.Success;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 10 è¡Œ ï¼Œè°ƒç”¨ <code>#isSuccess(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå“åº”çŠ¶æ€ç æ˜¯å¦åœ¨  [200, 300) èŒƒå›´å†…ã€‚</p></li><li><p>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šçŠ¶æ€ç  503 ï¼Œç›®å‰ Eureka-Server è¿”å› 503 çš„åŸå› æ˜¯è¢«é™æµã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a> è¯¦ç»†è§£æã€‚<strong>è¯¥æƒ…å†µä¸ºç¬æ—¶é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šé<strong>é¢„æœŸ</strong>çŠ¶æ€ç ï¼Œç›®å‰ Eureka-Server åœ¨ä»£ç ä¸Šçœ‹ä¸‹æ¥ï¼Œä¸ä¼šè¿”å›è¿™æ ·çš„çŠ¶æ€ç ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 20 è¡Œ ï¼šè¯·æ±‚æˆåŠŸï¼Œè°ƒç”¨ <code>#handleBatchResponse(...)</code> æ–¹æ³•ï¼Œé€ä¸ªå¤„ç†<strong>æ¯ä¸ª</strong> ReplicationTask å’Œ ReplicationInstanceResponse ã€‚<strong>è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œè¯·æ±‚æˆåŠŸæŒ‡çš„æ˜¯æ•´ä¸ªè¯·æ±‚æˆåŠŸï¼Œå®é™…æ¯ä¸ª ReplicationInstanceResponse å¯èƒ½è¿”å›çš„çŠ¶æ€ç ä¸åœ¨ [200, 300) èŒƒå›´å†…</strong>ã€‚è¯¥æ–¹æ³•ä¸‹æ–‡è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 23 è‡³ 25 è¡Œ ï¼šè¯·æ±‚å‘ç”Ÿç½‘ç»œå¼‚å¸¸ï¼Œä¾‹å¦‚ç½‘ç»œè¶…æ—¶ï¼Œæ‰“å°ç½‘ç»œå¼‚å¸¸æ—¥å¿—ã€‚ç›®å‰æ—¥å¿—çš„æ‰“å°ä¸ºéƒ¨åˆ†é‡‡æ ·ï¼Œæ¡ä»¶ä¸ºç½‘ç»œå‘ç”Ÿå¼‚å¸¸æ¯é—´éš” 10 ç§’æ‰“å°ä¸€æ¡ï¼Œé¿å…ç½‘ç»œå‘ç”Ÿå¼‚å¸¸æ‰“å°è¶…çº§å¤§é‡çš„æ—¥å¿—ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><ul><li><code>#isNetworkConnectException(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L163" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li><code>#logNetworkErrorSample(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L103" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li></ul></li><li><p>ç¬¬ 26 è‡³ 29 è¡Œ ï¼šé<strong>é¢„æœŸ</strong>å¼‚å¸¸ï¼Œç›®å‰ Eureka-Server åœ¨ä»£ç ä¸Šçœ‹ä¸‹æ¥ï¼Œä¸ä¼šæŠ›å‡ºè¿™æ ·çš„å¼‚å¸¸ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><hr><p><code>#handleBatchResponse(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBatchResponse</span><span class="params">(List&lt;ReplicationTask&gt; tasks, List&lt;ReplicationInstanceResponse&gt; responseList)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (tasks.size() != responseList.size()) &#123;</div><div class="line">       <span class="comment">// This should ideally never happen unless there is a bug in the software.</span></div><div class="line">       logger.error(<span class="string">"Batch response size different from submitted task list (&#123;&#125; != &#123;&#125;); skipping response analysis"</span>, responseList.size(), tasks.size());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.size(); i++) &#123;</div><div class="line">       handleBatchResponse(tasks.get(i), responseList.get(i));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBatchResponse</span><span class="params">(ReplicationTask task, ReplicationInstanceResponse response)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‰§è¡ŒæˆåŠŸ</span></div><div class="line">   <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line">   <span class="keyword">if</span> (isSuccess(statusCode)) &#123;</div><div class="line">       task.handleSuccess();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// æ‰§è¡Œå¤±è´¥</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       task.handleFailure(response.getStatusCode(), response.getResponseEntity());</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Replication task "</span> + task.getTaskName() + <span class="string">" error handler failure"</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>ReplicationTask#handleSuccess()</code> æ–¹æ³•ï¼Œæ— ä»»åŠ¡åŒæ­¥æ“ä½œä»»åŠ¡é‡å†™ï¼Œæ˜¯ä¸ª<strong>ç©ºæ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// ReplicationTask.java</div><div class="line">public void handleSuccess() &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>ReplicationTask#handleFailure()</code> æ–¹æ³•ï¼Œæœ‰<strong>ä¸¤ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡é‡å†™ï¼š</p><ul><li><p>Cancel ï¼šå½“ Eureka-Server ä¸å­˜åœ¨ä¸‹çº¿çš„åº”ç”¨å®ä¾‹æ—¶ï¼Œè¿”å› 404 çŠ¶æ€ç ï¼Œæ­¤æ—¶æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerEurekaNode#cancel(...)</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="keyword">super</span>.handleFailure(statusCode, responseEntity);</div><div class="line">    <span class="keyword">if</span> (statusCode == <span class="number">404</span>) &#123;</div><div class="line">        logger.warn(<span class="string">"&#123;&#125;: missing entry."</span>, getTaskName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>Heartbeat ï¼šæƒ…å†µè¾ƒä¸ºå¤æ‚ï¼Œæˆ‘ä»¬æ¢ä¸€è¡Œç»§ç»­è¯´ï¼Œé¿å…æ’ç‰ˆæœ‰é—®é¢˜ï¼Œå½±å“é˜…è¯»ã€‚</p></li></ul></li></ul><p>å™”å™”å™”æ°ï¼Œæœ¬æ–‡çš„é‡è¦å¤´æˆæ¥å•¦ï¼Last But Very Importment ï¼ï¼ï¼</p><p>Eureka-Server æ˜¯å…è®¸<strong>åŒä¸€æ—¶åˆ»</strong>å…è®¸åœ¨ä»»æ„èŠ‚ç‚¹è¢« Eureka-Client å‘èµ·<strong>å†™å…¥</strong>ç›¸å…³çš„æ“ä½œï¼Œç½‘ç»œæ˜¯ä¸å¯é çš„èµ„æºï¼ŒEureka-Client å¯èƒ½å‘ä¸€ä¸ª Eureka-Server æ³¨å†ŒæˆåŠŸï¼Œä½†æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼Œå¯¼è‡´ Eureka-Client è¯¯ä»¥ä¸ºå¤±è´¥ï¼Œæ­¤æ—¶æ°å¥½ Eureka-Client å˜æ›´äº†åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œé‡è¯•å‘å¦ä¸€ä¸ª Eureka-Server æ³¨å†Œï¼Œé‚£ä¹ˆä¸¤ä¸ª Eureka-Server å¯¹è¯¥åº”ç”¨å®ä¾‹çš„çŠ¶æ€äº§ç”Ÿå†²çªã€‚</p><p>å†ä¾‹å¦‚...... æˆ‘ä»¬ä¸è¦ç»§ç»­ä¸¾ä¾‹å­ï¼Œç½‘ç»œæ³¢åŠ¨çœŸçš„å¾ˆå¤æ‚ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ Eureka æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>åº”ç”¨å®ä¾‹( InstanceInfo ) çš„ <code>lastDirtyTimestamp</code> å±æ€§ï¼Œä½¿ç”¨<strong>æ—¶é—´æˆ³</strong>ï¼Œè¡¨ç¤ºåº”ç”¨å®ä¾‹çš„<strong>ç‰ˆæœ¬å·</strong>ï¼Œå½“è¯·æ±‚æ–¹( ä¸ä»…ä»…æ˜¯ Eureka-Client ï¼Œä¹Ÿå¯èƒ½æ˜¯åŒæ­¥æ³¨å†Œæ“ä½œçš„ Eureka-Server ) å‘ Eureka-Server å‘èµ·æ³¨å†Œæ—¶ï¼Œè‹¥ Eureka-Server å·²å­˜åœ¨æ‹¥æœ‰æ›´å¤§ <code>lastDirtyTimestamp</code> è¯¥å®ä¾‹( <strong>ç›¸åŒåº”ç”¨å¹¶ä¸”ç›¸åŒåº”ç”¨å®ä¾‹ç¼–å·è¢«è®¤ä¸ºæ˜¯ç›¸åŒå®ä¾‹</strong> )ï¼Œåˆ™è¯·æ±‚æ–¹æ³¨å†Œçš„åº”ç”¨å®ä¾‹( InstanceInfo ) æ— æ³•è¦†ç›–æ³¨å†Œæ­¤ Eureka-Server çš„è¯¥å®ä¾‹( è§ <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³• )ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢ä¸¾çš„ä¾‹å­ï¼Œç¬¬ä¸€ä¸ª Eureka-Server å‘ ç¬¬äºŒä¸ª Eureka-Server åŒæ­¥æ³¨å†Œåº”ç”¨å®ä¾‹æ—¶ï¼Œä¸ä¼šæ³¨å†Œè¦†ç›–ï¼Œåå€’æ˜¯ç¬¬äºŒä¸ª Eureka-Server åŒæ­¥æ³¨å†Œåº”ç”¨åˆ°ç¬¬ä¸€ä¸ª Eureka-Server ï¼Œæ³¨å†Œè¦†ç›–æˆåŠŸï¼Œå› ä¸º <code>lastDirtyTimestamp</code> ( åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´æ—¶ï¼Œå¯ä»¥è®¾ç½® <code>lastDirtyTimestamp</code> ä¸ºå½“å‰æ—¶é—´ï¼Œè§ <code>ApplicationInfoManager#setInstanceStatus(status)</code> æ–¹æ³• )ã€‚</p><p>ä½†æ˜¯å…‰é <strong>æ³¨å†Œ</strong>è¯·æ±‚åˆ¤æ–­ <code>lastDirtyTimestamp</code> æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹æ—¶ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡å¤šæ¬¡æ‰§è¡Œå¤±è´¥åˆ°è¾¾è¿‡æœŸæ—¶é—´åï¼Œæ­¤æ—¶åœ¨ Eureka-Server é›†ç¾¤åŒæ­¥èµ·åˆ°æœ€ç»ˆä¸€è‡´æ€§<strong>æœ€æœ€æœ€</strong>å…³é”®æ€§å‡ºç°äº†ï¼šHeartbeat ã€‚å› ä¸º Heartbeat ä¼šå‘¨æœŸæ€§çš„æ‰§è¡Œï¼Œé€šè¿‡å®ƒä¸€æ–¹é¢å¯ä»¥åˆ¤æ–­ Eureka-Server æ˜¯å¦å­˜åœ¨å¿ƒè·³å¯¹åº”çš„åº”ç”¨å®ä¾‹ï¼Œå¦å¤–ä¸€æ–¹é¢å¯ä»¥æ¯”è¾ƒåº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> ã€‚å½“æ»¡è¶³ä¸‹é¢ä»»æ„æ¡ä»¶ï¼ŒEureka-Server è¿”å› 404 çŠ¶æ€ç ï¼š</p><ul><li>1ï¼‰Eureka-Server åº”ç”¨å®ä¾‹ä¸å­˜åœ¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/registry/AbstractInstanceRegistry.java#L438" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li><li>2ï¼‰Eureka-Server åº”ç”¨å®ä¾‹çŠ¶æ€ä¸º <code>UNKNOWN</code>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/registry/AbstractInstanceRegistry.java#L450" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚ä¸ºä»€ä¹ˆä¼šæ˜¯ <code>UNKNOWN</code> ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹ã€Œ 4.3 ç»­ç§Ÿåœºæ™¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>**3ï¼‰**è¯·æ±‚çš„ <code>lastDirtyTimestamp</code> æ›´å¤§ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L306" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li></ul><p>è¯·æ±‚æ–¹æ¥æ”¶åˆ° 404 çŠ¶æ€ç è¿”å›åï¼Œ<strong>è®¤ä¸º Eureka-Server åº”ç”¨å®ä¾‹å®é™…æ˜¯ä¸å­˜åœ¨çš„</strong>ï¼Œé‡æ–°å‘èµ·åº”ç”¨å®ä¾‹çš„æ³¨å†Œã€‚ä»¥æœ¬æ–‡çš„ Heartbeat ä¸ºä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerEurekaNode#heartbeat(...)</span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">super</span>.handleFailure(statusCode, responseEntity);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (statusCode == <span class="number">404</span>) &#123;</div><div class="line">  <span class="number">5</span>:         logger.warn(<span class="string">"&#123;&#125;: missing entry."</span>, getTaskName());</div><div class="line">  <span class="number">6</span>:         <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">7</span>:             logger.warn(<span class="string">"&#123;&#125;: cannot find instance id &#123;&#125; and hence replicating the instance with status &#123;&#125;"</span>,</div><div class="line">  <span class="number">8</span>:                     getTaskName(), info.getId(), info.getStatus());</div><div class="line">  <span class="number">9</span>:             register(info);</div><div class="line"> <span class="number">10</span>:         &#125;</div><div class="line"> <span class="number">11</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.shouldSyncWhenTimestampDiffers()) &#123;</div><div class="line"> <span class="number">12</span>:         InstanceInfo peerInstanceInfo = (InstanceInfo) responseEntity;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (peerInstanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">14</span>:             syncInstancesIfTimestampDiffers(appName, id, info, peerInstanceInfo);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:     &#125;</div><div class="line"> <span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 10 è¡Œ ï¼šæ¥æ”¶åˆ° 404 çŠ¶æ€ç ï¼Œè°ƒç”¨ <code>#register(...)</code> æ–¹æ³•ï¼Œå‘è¯¥è¢«å¿ƒè·³åŒæ­¥æ“ä½œå¤±è´¥çš„ Eureka-Server å‘èµ·æ³¨å†Œ<strong>æœ¬åœ°çš„åº”ç”¨å®ä¾‹</strong>çš„è¯·æ±‚ã€‚</p><ul><li>ä¸Šè¿° <strong>3ï¼‰</strong> ï¼Œä¼šä½¿ç”¨è¯·æ±‚å‚æ•° <code>overriddenStatus</code> å­˜å‚¨åˆ° Eureka-Server çš„åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€é›†åˆ( <code>AbstractInstanceRegistry.overriddenInstanceStatusMap</code> )ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L123" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 16 è¡Œ ï¼šæ°å¥½æ˜¯ <strong>3ï¼‰</strong> åè¿‡æ¥çš„æƒ…å†µï¼Œæœ¬åœ°çš„åº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> å°äº Eureka-Server è¯¥åº”ç”¨å®ä¾‹çš„ï¼Œæ­¤æ—¶ Eureka-Server è¿”å› 409 çŠ¶æ€ç ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L314" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚è°ƒç”¨ <code>#syncInstancesIfTimestampDiffers()</code> æ–¹æ³•ï¼Œè¦†ç›–æ³¨å†Œæœ¬åœ°åº”ç”¨å®ä¾‹ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L387" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</p></li></ul><p>OKï¼Œæ’’èŠ±ï¼è®°ä½ï¼šEureka é€šè¿‡ Heartbeat å®ç° Eureka-Server é›†ç¾¤åŒæ­¥çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h1>666. å½©è›‹</h1><p>å†™çš„æ¯”è¾ƒå—¨çš®ï¼Œæ‰€ä»¥å°±é€èƒ–å‹ä¸€åªèƒ–å‹</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p><p>ä»¥ä¸‹æ˜¯è‰ç¨¿ï¼Œå¯ä»¥å‡‘åˆçœ‹</p><p>eureka server é›†ç¾¤å‡å®šæ˜¯ s1 s2</p><p>1ï¼‰client å‘ s1 æ³¨å†Œï¼Œæœ‰ä¸€ä¸ª lastDirtyTime ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆåŠŸï¼Œ s1 ä¼šå‘ s2 åŒæ­¥<br>2ï¼‰client å‘ s1 æ³¨å†Œï¼ˆæˆåŠŸï¼Œä½†æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼‰ï¼Œç„¶å client å‘ç”ŸçŠ¶æ€çš„å˜åŒ–ï¼ŒlastDirtyTime å˜åŒ–ï¼Œå‘ s2 æ³¨å†Œã€‚<br>è¿™ä¸ªæ—¶å€™ï¼Œs1 s2 æ˜¯å†²çªçš„ï¼Œä½†æ˜¯ä»–ä»¬ä¼šäº’ç›¸åŒæ­¥ï¼Œå®é™… s2 =&gt; s1 çš„æ³¨å†Œä¼šçœŸæ­£æˆåŠŸï¼Œs1 =&gt; s2 çš„æ³¨å†Œä¸ä¼šè¿”å›å¤±è´¥ï¼Œä½†æ˜¯å®é™… s2 å¤„ç†çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯è‡ªèº«çš„ã€‚</p><p>å¿ƒè·³åªæ˜¯æœ€ç»ˆå»æ ¡éªŒã€‚</p><p>ç†è®ºæ¥è¯´ï¼Œå¿ƒè·³ä¸åº”è¯¥å¸¦ lastDirtyTime å‚æ•°ã€‚å¸¦çš„åŸå› å°±æ˜¯ä¸ºäº†åšå›ºå®šå‘¨æœŸçš„æ¯”è¾ƒã€‚</p><p>æœ€ä¼˜è§£æ˜¯ æ³¨å†Œ å°±å¤„ç†æ‰æ•°æ®ä¸ä¸€è‡´<br>æ¬¡ä¼˜è§£æ˜¯ å¿ƒè·³ å¤„ç†æ‰æ•°æ®ä¸ä¸€è‡´</p><p>å¦‚æœåœ¨ç±»æ¯”ï¼Œ</p><p>æ³¨å†Œï¼Œç›¸å½“äº insertOrUpdate<br>å¿ƒè·³ï¼Œé™„åŠ äº†æ ¡éªŒæ˜¯å¦è¦å‘èµ·ã€æ³¨å†Œã€‘</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/server-cluster/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a 
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡</title>
    <link href="http://www.iocoder.cn/Eureka/transport/"/>
    <id>http://www.iocoder.cn/Eureka/transport/</id>
    <published>2018-07-30T16:00:00.000Z</published>
    <updated>2017-10-18T15:23:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/transport/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">2. EurekaHttpClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">2.1 EurekaJerseyClientImpl</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">2.2 EurekaJerseyClientBuilder</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">3. EurekaHttpClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">3.1 EurekaHttpResponse</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">3.2 TransportClientFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">4. AbstractJerseyEurekaHttpClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">4.1 JerseyApplicationClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">4.2 JerseyReplicationClient</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5. EurekaHttpClientDecorator</a><ul><li><a href="http://www.iocoder.cn/Eureka/transport/">5.1 MetricsCollectingEurekaHttpClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5.2 RedirectingEurekaHttpClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5.3 RetryableEurekaHttpClient</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">5.4 SessionedEurekaHttpClient</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/transport/">6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯</a></li><li><a href="http://www.iocoder.cn/Eureka/transport/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka çš„ç½‘ç»œé€šä¿¡éƒ¨åˆ†</strong>ã€‚åœ¨ä¸è€ƒè™‘ Eureka 2.x çš„å…¼å®¹çš„æƒ…å†µä¸‹ï¼ŒEureka 1.x ä¸»è¦ä¸¤éƒ¨åˆ†çš„ç½‘ç»œé€šä¿¡ï¼š</p><ul><li>Eureka-Client è¯·æ±‚ Eureka-Server çš„ç½‘ç»œé€šä¿¡</li><li>Eureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ <strong>å…¶å®ƒçš„Eureka-Server</strong> çš„ç½‘ç»œé€šä¿¡</li></ul><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.discovery.shared.transport</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/01.png" alt=""></p><ul><li>ç²‰è‰²éƒ¨åˆ† â€”â€” EurekaJerseyClient ï¼Œå¯¹åŸºäº Jersey Server çš„ Eureka-Server çš„ Jersey å®¢æˆ·ç«¯å°è£…ã€‚</li><li>ç»¿è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient ï¼ŒEureka-Server HTTP è®¿é—®å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚å¦‚æœæŠŠ DiscoveryClient ç±»æ¯”æˆ Service ï¼Œé‚£ä¹ˆ EurekaHttpClient å¯ä»¥ç±»æ¯”åŸ Dao ã€‚</li><li>ç»¼è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient å®ç°ç±»ï¼Œ<strong>çœŸæ­£</strong>å®ç°äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚</li><li>çº¢è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient å§”æ‰˜ç±»ï¼Œæä¾›äº†<strong>ä¼šè¯ã€é‡è¯•ã€é‡å®šå‘ã€ç›‘æ§æŒ‡æ ‡æ”¶é›†</strong>ç­‰ç‰¹æ€§ã€‚</li><li>é»„è‰²éƒ¨åˆ† â€”â€” EurekaHttpClientFactoryï¼Œç”¨äºåˆ›å»º EurekaHttpClient ã€‚</li></ul><p>ç±»å›¾çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œæ•´ä½“è°ƒç”¨å…³ç³»å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/02.png" alt=""></p><p>OK ï¼Œæˆ‘ä»¬é€å±‚è§£æï¼Œå—¨èµ·æ¥ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaHttpClient</h1><p><code>com.netflix.discovery.shared.transport.jersey.EurekaJerseyClient</code> ï¼ŒEurekaHttpClient <strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaJerseyClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">ApacheHttpClient4 <span class="title">getClient</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroyResources</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.sun.jersey.client.apache4.ApacheHttpClient4</code> ï¼ŒåŸºäº Apache HttpClient4 å®ç°çš„ Jersey Client ã€‚</li></ul><h2>2.1 EurekaJerseyClientImpl</h2><p><code>com.netflix.discovery.shared.transport.jersey.EurekaJerseyClientImpl</code> ï¼ŒEurekaHttpClient <strong>å®ç°ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaJerseyClientImpl</span> <span class="keyword">implements</span> <span class="title">EurekaJerseyClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åŸºäº Apache HttpClient4 å®ç°çš„ Jersey Client</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClient4 apacheHttpClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Apache HttpClient ç©ºé—²è¿æ¥æ¸…ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClientConnectionCleaner apacheHttpClientConnectionCleaner;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey Client é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ClientConfig jerseyClientConfig;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EurekaJerseyClientImpl</span><span class="params">(<span class="keyword">int</span> connectionTimeout, <span class="keyword">int</span> readTimeout, <span class="keyword">final</span> <span class="keyword">int</span> connectionIdleTimeout,</span></span></div><div class="line"><span class="function"><span class="params">                                  ClientConfig clientConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            jerseyClientConfig = clientConfig;</div><div class="line">            <span class="comment">// åˆ›å»º  ApacheHttpClient</span></div><div class="line">            apacheHttpClient = ApacheHttpClient4.create(jerseyClientConfig);</div><div class="line"></div><div class="line">            <span class="comment">// è®¾ç½® è¿æ¥å‚æ•°</span></div><div class="line">            HttpParams params = apacheHttpClient.getClientHandler().getHttpClient().getParams();</div><div class="line">            HttpConnectionParams.setConnectionTimeout(params, connectionTimeout);</div><div class="line">            HttpConnectionParams.setSoTimeout(params, readTimeout);</div><div class="line"></div><div class="line">            <span class="comment">// åˆ›å»º ApacheHttpClientConnectionCleaner</span></div><div class="line">            <span class="keyword">this</span>.apacheHttpClientConnectionCleaner = <span class="keyword">new</span> ApacheHttpClientConnectionCleaner(apacheHttpClient, connectionIdleTimeout);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create Jersey client"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ApacheHttpClient4 <span class="title">getClient</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> apacheHttpClient;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyResources</span><span class="params">()</span> </span>&#123;</div><div class="line">        apacheHttpClientConnectionCleaner.shutdown();</div><div class="line">        apacheHttpClient.destroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.discovery.shared.transport.jersey.ApacheHttpClientConnectionCleaner</code> ï¼ŒApache HttpClient ç©ºé—²è¿æ¥æ¸…ç†å™¨ï¼Œè´Ÿè´£<strong>å‘¨æœŸæ€§</strong>å…³é—­å¤„äº <code>half-close</code> çŠ¶æ€çš„ç©ºé—²è¿æ¥ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/ApacheHttpClientConnectionCleaner.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ ApacheHttpClientConnectionCleanerã€‚æ¨èé˜…è¯»ï¼š<a href="http://seanhe.iteye.com/blog/234759" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHttpClientå®¹æ˜“å¿½è§†çš„ç»†èŠ‚â€”â€”è¿æ¥å…³é—­ã€‹</a> ã€‚</li></ul><h2>2.2 EurekaJerseyClientBuilder</h2><p>EurekaJerseyClientBuilder ï¼ŒEurekaJerseyClientImpl <strong>å†…éƒ¨ç±»</strong>ï¼Œç”¨äºåˆ›å»º EurekaJerseyClientImpl ã€‚</p><p>è°ƒç”¨ <code>#build()</code> æ–¹æ³•ï¼Œåˆ›å»º EurekaJerseyClientImpl ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaJerseyClientBuilder.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaJerseyClient <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">    MyDefaultApacheHttpClient4Config config = <span class="keyword">new</span> MyDefaultApacheHttpClient4Config();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EurekaJerseyClientImpl(connectionTimeout, readTimeout, connectionIdleTimeout, config);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create Jersey client "</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>MyDefaultApacheHttpClient4Config ï¼Œç»§æ‰¿è‡ª <code>com.sun.jersey.client.apache4.config.DefaultApacheHttpClient4Config</code> ï¼Œå®ç°<strong>è‡ªå®šä¹‰é…ç½®</strong>ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/EurekaJerseyClientImpl.java#L199" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ MyDefaultApacheHttpClient4Configã€‚ä¾‹å¦‚ ï¼š<ul><li>è‡ªå®šä¹‰çš„<strong>è¯·æ±‚ã€å“åº”çš„ç¼–è§£ç å™¨</strong> <code>com.netflix.discovery.provider.DiscoveryJerseyProvider</code> ã€‚</li><li>ç¦ç”¨<strong>é‡å®šå‘</strong>ï¼Œä½¿ç”¨ RedirectingEurekaHttpClient å®ç°è¯¥ç‰¹æ€§ã€‚</li><li>è‡ªå®šä¹‰ UserAgent ã€‚</li><li>è‡ªå®šä¹‰ Http Proxy ã€‚</li><li>SSL åŠŸèƒ½çš„å¢å¼ºã€‚ApacheHttpClient4 ä½¿ç”¨çš„æ˜¯ Apache HttpClient 4.1.1 ç‰ˆæœ¬ï¼Œ<code>com.netflix.discovery.shared.transport.jersey.SSLSocketFactoryAdapter</code> å°† Apache HttpClient 4.3.4 å¯¹ SSL åŠŸèƒ½çš„å¢å¼ºé€‚é…åˆ°è€ç‰ˆæœ¬ API ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/SSLSocketFactoryAdapter.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ SSLSocketFactoryAdapterã€‚</li></ul></li></ul><h1>3. EurekaHttpClient</h1><p><code>com.netflix.discovery.shared.transport.EurekaHttpClient</code> ï¼ŒEureka-Server HTTP è®¿é—®å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³• ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/EurekaHttpClient.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ EurekaHttpClientã€‚</p><h2>3.1 EurekaHttpResponse</h2><p><code>com.netflix.discovery.shared.transport.EurekaHttpResponse</code> ï¼Œè¯·æ±‚å“åº”å¯¹è±¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHttpResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿”å›çŠ¶æ€ç </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> statusCode;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿”å›å¯¹è±¡( Entity )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T entity;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿”å› header</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; headers;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡å®šå‘åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URI location;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ setting / getting å’Œ Builder</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 TransportClientFactory</h2><p><code>com.netflix.discovery.shared.transport.TransportClientFactory</code> ï¼Œåˆ›å»º EurekaHttpClient çš„å·¥å‚<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»º EurekaHttpClient</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> serviceUrl Eureka-Server åœ°å€</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> EurekaHttpClient</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…³é—­å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><strong>å¤§å¤šæ•° EurekaHttpClient å®ç°ç±»éƒ½æœ‰å…¶å¯¹åº”çš„å·¥å‚å®ç°ç±»</strong>ã€‚</p><h1>4. AbstractJerseyEurekaHttpClient</h1><p><code>com.netflix.discovery.shared.transport.jersey.AbstractJerseyEurekaHttpClient</code> ï¼Œå®ç° EurekaHttpClient çš„<strong>æŠ½è±¡ç±»</strong>ï¼Œ<strong>çœŸæ­£</strong>å®ç°äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractJerseyEurekaHttpClient</span> <span class="keyword">implements</span> <span class="title">EurekaHttpClient</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AbstractJerseyEurekaHttpClient.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:  * Jersey Client</span></div><div class="line"><span class="comment"> 7:  */</span></div><div class="line"> <span class="number">8</span>: <span class="keyword">protected</span> <span class="keyword">final</span> Client jerseyClient;</div><div class="line"> <span class="number">9</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">10:  * è¯·æ±‚çš„ Eureka-Server åœ°å€</span></div><div class="line"><span class="comment">11:  */</span></div><div class="line"><span class="number">12</span>: <span class="keyword">protected</span> <span class="keyword">final</span> String serviceUrl;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="function"><span class="keyword">protected</span> <span class="title">AbstractJerseyEurekaHttpClient</span><span class="params">(Client jerseyClient, String serviceUrl)</span> </span>&#123;</div><div class="line"><span class="number">15</span>:     <span class="keyword">this</span>.jerseyClient = jerseyClient;</div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.serviceUrl = serviceUrl;</div><div class="line"><span class="number">17</span>:     logger.debug(<span class="string">"Created client for url: &#123;&#125;"</span>, serviceUrl);</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(InstanceInfo info)</span> </span>&#123;</div><div class="line"><span class="number">22</span>:     <span class="comment">// è®¾ç½® è¯·æ±‚åœ°å€</span></div><div class="line"><span class="number">23</span>:     String urlPath = <span class="string">"apps/"</span> + info.getAppName();</div><div class="line"><span class="number">24</span>:     ClientResponse response = <span class="keyword">null</span>;</div><div class="line"><span class="number">25</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">26</span>:         Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</div><div class="line"><span class="number">27</span>:         <span class="comment">// è®¾ç½® è¯·æ±‚å¤´</span></div><div class="line"><span class="number">28</span>:         addExtraHeaders(resourceBuilder);</div><div class="line"><span class="number">29</span>:         <span class="comment">// è¯·æ±‚ Eureka-Server</span></div><div class="line"><span class="number">30</span>:         response = resourceBuilder</div><div class="line"><span class="number">31</span>:                 .header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>) <span class="comment">// GZIP</span></div><div class="line"><span class="number">32</span>:                 .type(MediaType.APPLICATION_JSON_TYPE) <span class="comment">// è¯·æ±‚å‚æ•°æ ¼å¼ JSON</span></div><div class="line"><span class="number">33</span>:                 .accept(MediaType.APPLICATION_JSON) <span class="comment">// å“åº”ç»“æœæ ¼å¼ JSON</span></div><div class="line"><span class="number">34</span>:                 .post(ClientResponse.class, info); <span class="comment">// è¯·æ±‚å‚æ•°</span></div><div class="line"><span class="number">35</span>:         <span class="comment">// åˆ›å»º EurekaHttpResponse</span></div><div class="line"><span class="number">36</span>:         <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</div><div class="line"><span class="number">37</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">38</span>:         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">39</span>:             logger.debug(<span class="string">"Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, info.getId(),</div><div class="line"><span class="number">40</span>:                     response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:         <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">43</span>:             response.close();</div><div class="line"><span class="number">44</span>:         &#125;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>jerseyClient</code> å±æ€§ï¼ŒJersey Client ï¼Œä½¿ç”¨ä¸Šæ–‡çš„ <code>EurekaHttpClient#getClient(...)</code> æ–¹æ³•ï¼Œè·å– ApacheHttpClient4 ã€‚</li><li><code>serviceUrl</code> å±æ€§ï¼Œè¯·æ±‚çš„ Eureka-Server åœ°å€ã€‚</li><li><code>#register()</code> æ–¹æ³•ï¼Œå®ç°å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚<strong>å…¶ä»–æ–¹æ³•ä»£ç ç±»ä¼¼</strong>ã€‚<ul><li><p>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šè®¾ç½®è¯·æ±‚åœ°å€ã€‚</p></li><li><p>ç¬¬ 28 è¡Œ ï¼šè°ƒç”¨ <code>#addExtraHeaders(...)</code> æ–¹æ³•ï¼Œè®¾ç½®è¯·æ±‚å¤´( header  )ã€‚è¯¥æ–¹æ³•æ˜¯<strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œæä¾›å­ç±»å®ç°è‡ªå®šä¹‰çš„è¯·æ±‚å¤´ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addExtraHeaders</span><span class="params">(Builder webResource)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 29 è‡³ 34 è¡Œ ï¼šè¯·æ±‚ Eureka-Server ã€‚</p></li><li><p>ç¬¬ 35 è‡³ 36 è¡Œ ï¼šè§£æå“åº”ç»“æœï¼Œåˆ›å»º EurekaHttpResponse ã€‚</p></li></ul></li></ul><h2>4.1 JerseyApplicationClient</h2><p><code>com.netflix.discovery.shared.transport.jersey.JerseyApplicationClient</code> ï¼Œå®ç° Eureka-Client è¯·æ±‚ Eureka-Server çš„ç½‘ç»œé€šä¿¡ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/JerseyApplicationClient.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ JerseyApplicationClientã€‚</p><h3>4.1.1 JerseyEurekaHttpClientFactory</h3><p><code>com.netflix.discovery.shared.transport.jersey.JerseyEurekaHttpClientFactory</code> ï¼Œåˆ›å»º JerseyApplicationClient çš„<strong>å·¥å‚ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JerseyEurekaHttpClientFactory</span> <span class="keyword">implements</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaJerseyClient jerseyClient;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClient4 apacheClient;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClientConnectionCleaner cleaner;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; additionalHeaders;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JerseyEurekaHttpClientFactory</span><span class="params">(ApacheHttpClient4 apacheClient, <span class="keyword">long</span> connectionIdleTimeout, Map&lt;String, String&gt; additionalHeaders)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, apacheClient, connectionIdleTimeout, additionalHeaders);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JerseyEurekaHttpClientFactory</span><span class="params">(EurekaJerseyClient jerseyClient,</span></span></div><div class="line"><span class="function"><span class="params">                                          ApacheHttpClient4 apacheClient,</span></span></div><div class="line"><span class="function"><span class="params">                                          <span class="keyword">long</span> connectionIdleTimeout,</span></span></div><div class="line"><span class="function"><span class="params">                                          Map&lt;String, String&gt; additionalHeaders)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jerseyClient = jerseyClient;</div><div class="line">        <span class="keyword">this</span>.apacheClient = jerseyClient != <span class="keyword">null</span> ? jerseyClient.getClient() : apacheClient;</div><div class="line">        <span class="keyword">this</span>.additionalHeaders = additionalHeaders;</div><div class="line">        <span class="keyword">this</span>.cleaner = <span class="keyword">new</span> ApacheHttpClientConnectionCleaner(<span class="keyword">this</span>.apacheClient, connectionIdleTimeout);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint endpoint)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JerseyApplicationClient(apacheClient, endpoint.getServiceUrl(), additionalHeaders);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        cleaner.shutdown();</div><div class="line">        <span class="keyword">if</span> (jerseyClient != <span class="keyword">null</span>) &#123;</div><div class="line">            jerseyClient.destroyResources();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            apacheClient.destroy();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>4.1.2 JerseyEurekaHttpClientFactoryBuilder</h3><p>JerseyEurekaHttpClientFactoryBuilder ï¼ŒJerseyEurekaHttpClientFactory <strong>å†…éƒ¨ç±»</strong>ï¼Œç”¨äºåˆ›å»º JerseyEurekaHttpClientFactory ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/ff48fa728c7085ad8116517ede88398b0fd693c7/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/JerseyEurekaHttpClientFactory.java#L152" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ JerseyEurekaHttpClientFactoryã€‚</p><p>è°ƒç”¨ <code>JerseyEurekaHttpClientFactory#create(...)</code> æ–¹æ³•ï¼Œåˆ›å»º JerseyEurekaHttpClientFactory ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JerseyEurekaHttpClientFactory <span class="title">create</span><span class="params">(EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                  Collection&lt;ClientFilter&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                  InstanceInfo myInstanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                                  AbstractEurekaIdentity clientIdentity)</span> </span>&#123;</div><div class="line">   JerseyEurekaHttpClientFactoryBuilder clientBuilder = newBuilder()</div><div class="line">           .withAdditionalFilters(additionalFilters) <span class="comment">// å®¢æˆ·ç«¯é™„åŠ è¿‡æ»¤å™¨</span></div><div class="line">           .withMyInstanceInfo(myInstanceInfo) <span class="comment">// åº”ç”¨å®ä¾‹</span></div><div class="line">           .withUserAgent(<span class="string">"Java-EurekaClient"</span>) <span class="comment">// UA</span></div><div class="line">           .withClientConfig(clientConfig)</div><div class="line">           .withClientIdentity(clientIdentity);</div><div class="line"></div><div class="line">   <span class="comment">// è®¾ç½® Client Name</span></div><div class="line">   <span class="keyword">if</span> (<span class="string">"true"</span>.equals(System.getProperty(<span class="string">"com.netflix.eureka.shouldSSLConnectionsUseSystemSocketFactory"</span>))) &#123;</div><div class="line">       clientBuilder.withClientName(<span class="string">"DiscoveryClient-HTTPClient-System"</span>).withSystemSSLConfiguration();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clientConfig.getProxyHost() != <span class="keyword">null</span> &amp;&amp; clientConfig.getProxyPort() != <span class="keyword">null</span>) &#123;</div><div class="line">       clientBuilder.withClientName(<span class="string">"Proxy-DiscoveryClient-HTTPClient"</span>)</div><div class="line">               .withProxy(</div><div class="line">                       clientConfig.getProxyHost(), Integer.parseInt(clientConfig.getProxyPort()),</div><div class="line">                       clientConfig.getProxyUserName(), clientConfig.getProxyPassword()</div><div class="line">               ); <span class="comment">// http proxy</span></div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       clientBuilder.withClientName(<span class="string">"DiscoveryClient-HTTPClient"</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> clientBuilder.build();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JerseyEurekaHttpClientFactoryBuilder <span class="title">newBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JerseyEurekaHttpClientFactoryBuilder().withExperimental(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.2 JerseyReplicationClient</h2><p><code>com.netflix.eureka.transport.JerseyReplicationClient</code> ï¼ŒEureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ <strong>å…¶å®ƒçš„Eureka-Server</strong> çš„ç½‘ç»œé€šä¿¡ã€‚</p><ul><li><p>å®ç° <code>AbstractJerseyEurekaHttpClient#addExtraHeaders()</code> æ–¹æ³•ï¼Œæ·»åŠ è‡ªå®šä¹‰å¤´ <code>x-netflix-discovery-replication=true</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addExtraHeaders</span><span class="params">(Builder webResource)</span> </span>&#123;</div><div class="line">   webResource.header(PeerEurekaNode.HEADER_REPLICATION, <span class="string">"true"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>é‡å†™äº† <code>#sendHeartBeat(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>å®ç° <code>com.netflix.eureka.cluster.HttpReplicationClient</code> æ¥å£ï¼Œå®ç°äº† <code>#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><h3>4.2.1 æ²¡æœ‰å·¥å‚</h3><p>JerseyReplicationClient <strong>æ²¡æœ‰ä¸“å±çš„å·¥å‚</strong>ã€‚</p><p>è°ƒç”¨ <code>JerseyReplicationClient#createReplicationClient(...)</code> <strong>é™æ€æ–¹æ³•</strong>ï¼Œåˆ›å»º JerseyReplicationClient ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/transport/JerseyReplicationClient.java#L135" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„æ–¹æ³•ä»£ç ã€‚</p><h1>5. EurekaHttpClientDecorator</h1><p><code>com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator</code>ï¼ŒEurekaHttpClient å§”æ‰˜è€…<strong>æŠ½è±¡ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHttpClientDecorator</span> <span class="keyword">implements</span> <span class="title">EurekaHttpClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œè¯·æ±‚</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> requestExecutor è¯·æ±‚æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt; è¯·æ±‚æ³›å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å“åº”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span></span>;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> execute(<span class="keyword">new</span> RequestExecutor&lt;Void&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> delegate.register(info);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> RequestType <span class="title">getRequestType</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> RequestType.Register;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>#execute(...)</code> <strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œå®ç°è‡ªå·±çš„ç‰¹æ€§ã€‚</p></li><li><p><code>#register()</code> æ–¹æ³•ï¼Œå®ç°å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚<strong>å…¶ä»–æ–¹æ³•ä»£ç ç±»ä¼¼</strong>ã€‚</p><ul><li>è°ƒç”¨ <code>#execute(...)</code> æ–¹æ³•ï¼Œå¹¶å°†åŸæœ‰çš„æ³¨å†Œå®ç°é€šè¿‡ RequestExecutor ä¼ é€’è¿›å»ã€‚</li><li>å­ç±»åœ¨å®ç°çš„ <code>#execute(...)</code> æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ <code>RequestExecutor#execute(...)</code> æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡ŒåŸæœ‰é€»è¾‘ã€‚</li><li>å‚è€ƒè®¾è®¡æ¨¡å¼ï¼š<a href="http://blog.csdn.net/hguisu/article/details/7564039" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè®¾è®¡æ¨¡å¼ ( åä¹ ) æ¨¡æ¿æ–¹æ³•æ¨¡å¼Template methodï¼ˆç±»è¡Œä¸ºå‹ï¼‰ã€‹</a> ã€‚</li></ul></li><li><p>RequestType ï¼Œè¯·æ±‚ç±»å‹<strong>æšä¸¾ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClientDecorator.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> RequestType &#123;</div><div class="line">   Register,</div><div class="line">   Cancel,</div><div class="line">   SendHeartBeat,</div><div class="line">   StatusUpdate,</div><div class="line">   DeleteStatusOverride,</div><div class="line">   GetApplications,</div><div class="line">   GetDelta,</div><div class="line">   GetVip,</div><div class="line">   GetSecureVip,</div><div class="line">   GetApplication,</div><div class="line">   GetInstance,</div><div class="line">   GetApplicationInstance</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>RequestExecutor ï¼Œè¯·æ±‚æ‰§è¡Œå™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClientDecorator.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestExecutor</span>&lt;<span class="title">R</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ‰§è¡Œè¯·æ±‚</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> delegate å§”æ‰˜çš„ EurekaHttpClient</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> å“åº”</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span></span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> è¯·æ±‚ç±»å‹</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function">RequestType <span class="title">getRequestType</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p>EurekaHttpClientDecorator çš„<strong>æ¯ä¸ªå®ç°ç±»å®ç°ä¸€ä¸ªç‰¹æ€§</strong>ï¼Œä»£ç éå¸¸éå¸¸éå¸¸æ¸…æ™°ã€‚</p><blockquote><p>FROM <a href="https://zh.wikipedia.org/wiki/%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå§”æ‰˜æ¨¡å¼ã€‹</a><br>å§”æ‰˜æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€é¡¹åŸºæœ¬æŠ€å·§ã€‚åœ¨å§”æ‰˜æ¨¡å¼ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¯¹è±¡å‚ä¸å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—è¯·æ±‚çš„å¯¹è±¡å°†è¯·æ±‚å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡æ¥å¤„ç†ã€‚å§”æ‰˜æ¨¡å¼æ˜¯ä¸€é¡¹åŸºæœ¬æŠ€å·§ï¼Œè®¸å¤šå…¶ä»–çš„æ¨¡å¼ï¼Œå¦‚çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯åœ¨æ›´ç‰¹æ®Šçš„åœºåˆé‡‡ç”¨äº†å§”æ‰˜æ¨¡å¼ã€‚å§”æ‰˜æ¨¡å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨èšåˆæ¥æ›¿ä»£ç»§æ‰¿ï¼Œå®ƒè¿˜ä½¿æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿmixinã€‚</p></blockquote><p>æˆ‘ä»¬åœ¨ä¸Šå›¾çš„åŸºç¡€ä¸Šï¼Œ<strong>å¢åŠ å§”æ‰˜çš„å…³ç³»</strong>ï¼Œå¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/03.jpeg">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/03.jpeg" alt=""></p><ul><li>è¯·æ³¨æ„ï¼Œæ¯ä¸ªå§”æ‰˜ç€å®ç°ç±»ï¼Œä¸Šé¢å¯èƒ½æœ‰ç±»å‹ä¸º EurekaHttpClientFactory çš„å±æ€§ï¼Œç”¨äºåˆ›å»ºå…¶å§”æ‰˜çš„ EurekaHttpClient ã€‚<strong>ä¸ºä»€ä¹ˆä¼šæœ‰ Factory</strong> ï¼Ÿä¾‹å¦‚ï¼ŒRetryableEurekaHttpClient é‡è¯•è¯·æ±‚å¤šä¸ª Eureka-Server åœ°å€æ—¶ï¼Œæ¯ä¸ª Eureka-Server åœ°å€ä¼šåˆ›å»ºä¸€ä¸ª EurekaHttpClient ã€‚æ‰€ä»¥ï¼Œä¸‹æ–‡æ¶‰åŠåˆ° EurekaHttpClientFactory å’Œ<strong>å§”æ‰˜çš„</strong> EurekaHttpClient çš„åœ°æ–¹ï¼Œä½ éƒ½éœ€è¦ä»”ç»†ç†è§£ã€‚</li></ul><h2>5.1 MetricsCollectingEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.MetricsCollectingEurekaHttpClient</code> ï¼Œç›‘æ§æŒ‡æ ‡æ”¶é›† EurekaHttpClient ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p><p><code>#execute()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾— è¯·æ±‚ç±»å‹ çš„ è¯·æ±‚æŒ‡æ ‡</span></div><div class="line"> <span class="number">4</span>:     EurekaHttpClientRequestMetrics requestMetrics = metricsByRequestType.get(requestExecutor.getRequestType());</div><div class="line"> <span class="number">5</span>:     Stopwatch stopwatch = requestMetrics.latencyTimer.start();</div><div class="line"> <span class="number">6</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></div><div class="line"> <span class="number">8</span>:         EurekaHttpResponse&lt;R&gt; httpResponse = requestExecutor.execute(delegate);</div><div class="line"> <span class="number">9</span>:         <span class="comment">// å¢åŠ  è¯·æ±‚æŒ‡æ ‡</span></div><div class="line"><span class="number">10</span>:         requestMetrics.countersByStatus.get(mappedStatus(httpResponse)).increment();</div><div class="line"><span class="number">11</span>:         <span class="keyword">return</span> httpResponse;</div><div class="line"><span class="number">12</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">13</span>:         requestMetrics.connectionErrors.increment();</div><div class="line"><span class="number">14</span>:         exceptionsMetric.count(e);</div><div class="line"><span class="number">15</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">17</span>:         stopwatch.stop();</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ <code>RequestExecutor#execute(...)</code> æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚<ul><li><code>delegate</code> å±æ€§ï¼Œå¯¹åº” JerseyApplicationClient ã€‚</li></ul></li></ul><h2>5.2 RedirectingEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.RedirectingEurekaHttpClient</code> ï¼Œ<strong>å¯»æ‰¾é 302 é‡å®šå‘</strong>çš„ Eureka-Server çš„ EurekaHttpClient ã€‚</p><p><code>#execute()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     EurekaHttpClient currentEurekaClient = delegateRef.get();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (currentEurekaClient == <span class="keyword">null</span>) &#123; <span class="comment">// æœªæ‰¾åˆ°é 302 çš„ Eureka-Server</span></div><div class="line"> <span class="number">5</span>:         AtomicReference&lt;EurekaHttpClient&gt; currentEurekaClientRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(factory.newClient(serviceEndpoint));</div><div class="line"> <span class="number">6</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:             EurekaHttpResponse&lt;R&gt; response = executeOnNewServer(requestExecutor, currentEurekaClientRef);</div><div class="line"> <span class="number">8</span>:             <span class="comment">// å…³é—­åŸæœ‰çš„å§”æ‰˜ EurekaHttpClient ï¼Œå¹¶è®¾ç½®å½“å‰æˆåŠŸé 302 è¯·æ±‚çš„ EurekaHttpClient</span></div><div class="line"> <span class="number">9</span>:             TransportUtils.shutdown(delegateRef.getAndSet(currentEurekaClientRef.get()));</div><div class="line"><span class="number">10</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">11</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">12</span>:             logger.error(<span class="string">"Request execution error"</span>, e);</div><div class="line"><span class="number">13</span>:             TransportUtils.shutdown(currentEurekaClientRef.get());</div><div class="line"><span class="number">14</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// å·²ç»æ‰¾åˆ°é 302 çš„ Eureka-Server</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">return</span> requestExecutor.execute(currentEurekaClient);</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">20</span>:             logger.error(<span class="string">"Request execution error"</span>, e);</div><div class="line"><span class="number">21</span>:             delegateRef.compareAndSet(currentEurekaClient, <span class="keyword">null</span>);</div><div class="line"><span class="number">22</span>:             currentEurekaClient.shutdown();</div><div class="line"><span class="number">23</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼šå’Œæˆ‘ä»¬ç†è§£çš„å¸¸è§„çš„ 302 çŠ¶æ€è¿”å›å¤„ç†ä¸åŒï¼ï¼ï¼</li><li>æ•´ä¸ªåˆ†æˆä¸¤éƒ¨åˆ†ï¼šã€ç¬¬ 4 è‡³ 15 è¡Œã€‘ã€ã€ç¬¬ 16 è‡³ 24 è¡Œã€‘ã€‚<ul><li>å‰è€…ï¼Œæ„å‘³ç€æœªæ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œæ­¤æ—¶é€šè¿‡åœ¨åŸå§‹ä¼ é€’è¿›æ¥çš„ <code>serviceUrls</code> æ‰§è¡Œè¯·æ±‚ï¼Œå¯»æ‰¾é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Serverã€‚<ul><li>å½“è¿”å›é 302 çŠ¶æ€ç æ—¶ï¼Œæ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ã€‚</li><li>å½“è¿”å› 302 çŠ¶æ€ç æ—¶ï¼Œå‘æ–°çš„é‡å®šå‘çš„ Eureka-Server æ‰§è¡Œè¯·æ±‚ç›´åˆ°æˆåŠŸæ‰¾åˆ°æˆ–è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚</li></ul></li><li>åè€…ï¼Œæ„å‘³ç€å½“å‰å·²ç»æ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚ã€‚<strong>æ³¨æ„</strong> ï¼šæ­¤æ—¶ Eureka-Server å†è¿”å› 302 çŠ¶æ€ç ï¼Œä¸å†å¤„ç†ã€‚</li><li>ç›®å‰ Eureka 1.x çš„ Eureka-Server ä¸å­˜åœ¨è¿”å› 302 çŠ¶æ€ç ï¼ŒçŒœæµ‹å’Œ Eureka 2.X TODO[0028]ï¼šå†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤ æœ‰å…³ã€‚</li></ul></li><li>ã€å‰è€…ã€‘ç¬¬ 5 è¡Œ ï¼šä½¿ç”¨åˆå§‹çš„ <code>serviceEndpoint</code> ( ç›¸å½“äº <code>serviceUrls</code> ) åˆ›å»º<strong>å§”æ‰˜</strong> EurekaHttpClient ã€‚</li><li>ã€å‰è€…ã€‘ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>#executeOnNewServer(...)</code> æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œè¯·æ±‚çš„æ–¹å¼ï¼Œå¯»æ‰¾é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Serverã€‚å®ç°ä»£ç ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/ed9a4241e60e3b558f939754f71188d3063771e2/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RedirectingEurekaHttpClient.java#L111" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ä»£ç å®ç°ã€‚</li><li>ã€å‰è€…ã€‘ã€å‰è€…ã€‘ç¬¬ 9 è¡Œ ï¼šå…³é—­åŸæœ‰çš„ <code>delegateRef</code> ( å› ä¸ºæ­¤å¤„å¯èƒ½å­˜åœ¨å¹¶å‘ï¼Œå¤šä¸ªçº¿ç¨‹éƒ½æ‰¾åˆ°é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Server )ï¼Œå¹¶è®¾ç½®å½“å‰æˆåŠŸé 302 è¯·æ±‚çš„ EurekaHttpClient åˆ° <code>delegateRef</code>ã€‚</li><li>ã€å‰è€…ã€‘ç¬¬ 13 è¡Œ ï¼šå…³é—­ <code>currentEurekaClientRef</code> ï¼Œå½“è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æˆ–è€…è¶…è¿‡æœ€å¤§é‡å®šå‘æ¬¡æ•°ã€‚</li><li>ã€åè€…ã€‘ç¬¬ 18 è¡Œ ï¼šæ„å‘³ç€å½“å‰å·²ç»æ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚ã€‚</li><li>ã€åè€…ã€‘ç¬¬ 21 è‡³ 22 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚å‘ç”Ÿå¼‚å¸¸ï¼Œå…³é—­ <code>currentEurekaClient</code> ï¼Œåé¢è¦é‡æ–°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ã€‚</li></ul><h3>5.2.1 å·¥å‚</h3><p>RedirectingEurekaHttpClient æä¾› <code>#createFactory(...)</code> <strong>é™æ€æ–¹æ³•</strong>è·å¾—åˆ›å»ºå…¶çš„å·¥å‚ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/ed9a4241e60e3b558f939754f71188d3063771e2/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RedirectingEurekaHttpClient.java#L96" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h2>5.3 RetryableEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.RetryableEurekaHttpClient</code> ï¼Œæ”¯æŒå‘å¤šä¸ª Eureka-Server è¯·æ±‚é‡è¯•çš„ EurekaHttpClient ã€‚</p><p><code>#execute()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     List&lt;EurekaEndpoint&gt; candidateHosts = <span class="keyword">null</span>;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">int</span> endpointIdx = <span class="number">0</span>;</div><div class="line"> <span class="number">5</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> retry = <span class="number">0</span>; retry &lt; numberOfRetries; retry++) &#123;</div><div class="line"> <span class="number">6</span>:         EurekaHttpClient currentHttpClient = delegate.get();</div><div class="line"> <span class="number">7</span>:         EurekaEndpoint currentEndpoint = <span class="keyword">null</span>;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:         <span class="comment">// å½“å‰å§”æ‰˜çš„ EurekaHttpClient ä¸å­˜åœ¨</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (currentHttpClient == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">11</span>:             <span class="comment">// è·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„</span></div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (candidateHosts == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">13</span>:                 candidateHosts = getHostCandidates();</div><div class="line"><span class="number">14</span>:                 <span class="keyword">if</span> (candidateHosts.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:                     <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"There is no known eureka server; cluster server list is empty"</span>);</div><div class="line"><span class="number">16</span>:                 &#125;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:             <span class="comment">// è¶…è¿‡å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„ä¸Šé™</span></div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (endpointIdx &gt;= candidateHosts.size()) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"Cannot execute request on any known server"</span>);</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:             <span class="comment">// åˆ›å»ºå€™é€‰çš„ EurekaHttpClient</span></div><div class="line"><span class="number">25</span>:             currentEndpoint = candidateHosts.get(endpointIdx++);</div><div class="line"><span class="number">26</span>:             currentHttpClient = clientFactory.newClient(currentEndpoint);</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">30</span>:             <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></div><div class="line"><span class="number">31</span>:             EurekaHttpResponse&lt;R&gt; response = requestExecutor.execute(currentHttpClient);</div><div class="line"><span class="number">32</span>:             <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¯æ¥å—çš„ç›¸åº”ï¼Œè‹¥æ˜¯ï¼Œè¿”å›ã€‚</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">if</span> (serverStatusEvaluator.accept(response.getStatusCode(), requestExecutor.getRequestType())) &#123;</div><div class="line"><span class="number">34</span>:                 delegate.set(currentHttpClient);</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (retry &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:                     logger.info(<span class="string">"Request execution succeeded on retry #&#123;&#125;"</span>, retry);</div><div class="line"><span class="number">37</span>:                 &#125;</div><div class="line"><span class="number">38</span>:                 <span class="keyword">return</span> response;</div><div class="line"><span class="number">39</span>:             &#125;</div><div class="line"><span class="number">40</span>:             logger.warn(<span class="string">"Request execution failure with status code &#123;&#125;; retrying on another server if available"</span>, response.getStatusCode());</div><div class="line"><span class="number">41</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">42</span>:             logger.warn(<span class="string">"Request execution failed with message: &#123;&#125;"</span>, e.getMessage());  <span class="comment">// just log message as the underlying client should log the stacktrace</span></div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         <span class="comment">// è¯·æ±‚å¤±è´¥ï¼Œè‹¥æ˜¯ currentHttpClient ï¼Œæ¸…é™¤ delegate</span></div><div class="line"><span class="number">46</span>:         <span class="comment">// Connection error or 5xx from the server that must be retried on another server</span></div><div class="line"><span class="number">47</span>:         delegate.compareAndSet(currentHttpClient, <span class="keyword">null</span>);</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:         <span class="comment">// è¯·æ±‚å¤±è´¥ï¼Œå°† currentEndpoint æ·»åŠ åˆ°éš”ç¦»é›†åˆ</span></div><div class="line"><span class="number">50</span>:         <span class="keyword">if</span> (currentEndpoint != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">51</span>:             quarantineSet.add(currentEndpoint);</div><div class="line"><span class="number">52</span>:         &#125;</div><div class="line"><span class="number">53</span>:     &#125;</div><div class="line"><span class="number">54</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"Retry limit reached; giving up on completing the request"</span>);</div><div class="line"><span class="number">55</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 10 è¡Œ ï¼šå½“å‰ <code>currentHttpClient</code> ä¸å­˜åœ¨ï¼Œæ„å‘³ç€åŸæœ‰ <code>delegate</code> ä¸å­˜åœ¨å‘ Eureka-Server æˆåŠŸè¯·æ±‚çš„ EurekaHttpClient ã€‚</p><ul><li>æ­¤æ—¶éœ€è¦ä»é…ç½®ä¸­çš„ Eureka-Server æ•°ç»„é‡è¯•è¯·æ±‚ï¼Œè·å¾—å¯ä»¥è¯·æ±‚çš„ Eureka-Server ã€‚</li><li>å¦‚æœå·²ç»å­˜åœ¨è¯·æ±‚æˆåŠŸçš„ <code>delegate</code> ï¼Œç›´æ¥ä½¿ç”¨å®ƒè¿›è¡Œæ‰§è¡Œè¯·æ±‚ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 17 è¡Œ ï¼šè°ƒç”¨ <code>#getHostCandidates()</code> æ–¹æ³•ï¼Œè·å¾—å€™é€‰çš„ Eureka-Server <code>serviceUrls</code> æ•°ç»„ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> List&lt;EurekaEndpoint&gt; <span class="title">getHostCandidates</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„</span></div><div class="line"> <span class="number">3</span>:     List&lt;EurekaEndpoint&gt; candidateHosts = clusterResolver.getClusterEndpoints();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">// ä¿ç•™äº¤é›†ï¼ˆç§»é™¤ quarantineSet ä¸åœ¨ candidateHosts çš„å…ƒç´ ï¼‰</span></div><div class="line"> <span class="number">6</span>:     quarantineSet.retainAll(candidateHosts);</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// åœ¨ä¿è¯æœ€å°å¯ç”¨çš„å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„ï¼Œç§»é™¤åœ¨éš”ç¦»é›†åˆå†…çš„å…ƒç´ </span></div><div class="line"> <span class="number">9</span>:     <span class="comment">// If enough hosts are bad, we have no choice but start over again</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">int</span> threshold = (<span class="keyword">int</span>) (candidateHosts.size() * transportConfig.getRetryableClientQuarantineRefreshPercentage()); <span class="comment">// 0.66</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (quarantineSet.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// no-op</span></div><div class="line"><span class="number">13</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (quarantineSet.size() &gt;= threshold) &#123;</div><div class="line"><span class="number">14</span>:         logger.debug(<span class="string">"Clearing quarantined list of size &#123;&#125;"</span>, quarantineSet.size());</div><div class="line"><span class="number">15</span>:         quarantineSet.clear();</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">17</span>:         List&lt;EurekaEndpoint&gt; remainingHosts = <span class="keyword">new</span> ArrayList&lt;&gt;(candidateHosts.size());</div><div class="line"><span class="number">18</span>:         <span class="keyword">for</span> (EurekaEndpoint endpoint : candidateHosts) &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (!quarantineSet.contains(endpoint)) &#123;</div><div class="line"><span class="number">20</span>:                 remainingHosts.add(endpoint);</div><div class="line"><span class="number">21</span>:             &#125;</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:         candidateHosts = remainingHosts;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> candidateHosts;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>ClusterResolver#getClusterEndpoints()</code> æ–¹æ³•ï¼Œè·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„( <code>candidateHosts</code> )ã€‚<strong>æ³¨æ„</strong>ï¼šè¯¥æ–¹æ³•è¿”å›çš„ Eureka-Server åœ°å€æ•°ç»„ï¼Œä½¿ç”¨ä»¥æœ¬æœº IP ä¸º<strong>éšæœºç§å­</strong>ï¼Œè¾¾åˆ°ä¸åŒ IP çš„åº”ç”¨å®ä¾‹è·å¾—çš„æ•°ç»„é¡ºåºä¸åŒï¼Œè€Œç›¸åŒ IP çš„åº”ç”¨å®ä¾‹è·å¾—çš„æ•°ç»„é¡ºåºä¸€è‡´ï¼Œ<strong>æ•ˆæœç±»ä¼¼åŸºäº IP HASH çš„è´Ÿè½½å‡è¡¡ç®—æ³•</strong>ã€‚å®ç°è¯¥åŠŸèƒ½çš„ä»£ç ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/?self">ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹æœç´¢å…³é”®å­—ã€ResolverUtils#randomize(...)ã€‘</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>Set#retainAll()</code> æ–¹æ³•ï¼Œç§»é™¤éš”ç¦»çš„æ•…éšœ Eureka-Server åœ°å€æ•°ç»„( <code>quarantineSet</code> ) ä¸­ä¸åœ¨ <code>candidateHosts</code> çš„å…ƒç´ ã€‚</li><li>ç¬¬ 8 è‡³ 24 è¡Œ ï¼šåœ¨ä¿è¯æœ€å°å¯ç”¨çš„ <code>candidateHosts</code>ï¼Œç§»é™¤åœ¨ <code>quarantineSet</code> çš„å…ƒç´ ã€‚<ul><li>ç¬¬ 10 è¡Œ ï¼šæœ€å°å¯ç”¨çš„é˜€å€¼ï¼Œé…ç½® <code>eureka.retryableClientQuarantineRefreshPercentage</code> æ¥è®¾ç½®ç™¾åˆ†æ¯”ï¼Œé»˜è®¤å€¼ï¼š<code>0.66</code> ã€‚</li><li>æœ€ 13 è‡³ 15 è¡Œ ï¼š<code>quarantineSet</code> æ•°é‡è¶…è¿‡é˜€å€¼ï¼Œæ¸…ç©º <code>quarantineSet</code> ï¼Œå…¨éƒ¨ <code>candidateHosts</code> é‡è¯•ã€‚</li><li>ç¬¬ 17 è‡³ 24 è¡Œ ï¼š<code>quarantineSet</code> æ•°é‡æœªè¶…è¿‡é˜€å€¼ï¼Œç§»é™¤ <code>candidateHosts</code> ä¸­åœ¨ <code>quarantineSet</code> çš„å…ƒç´ ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 19 è‡³ 22 è¡Œ ï¼šè¶…è¿‡ <code>candidateHosts</code> ä¸Šé™ï¼Œå…¨éƒ¨ Eureka-Server è¯·æ±‚å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p></li><li><p>ç¬¬ 24 è‡³ 26 è¡Œ ï¼šåˆ›å»ºå§”æ‰˜çš„ EurekaHttpClient ï¼Œç”¨äºä¸‹é¢è¯·æ±‚æ‰§è¡Œã€‚</p></li><li><p>ç¬¬ 31 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚ã€‚</p></li><li><p>ç¬¬ 33 è¡Œ ï¼šè°ƒç”¨ <code>ServerStatusEvaluator#accept()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å“åº”çŠ¶æ€ç å’Œè¯·æ±‚ç±»å‹æ˜¯å¦èƒ½å¤Ÿæ¥å—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerStatusEvaluators.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ServerStatusEvaluator LEGACY_EVALUATOR = <span class="keyword">new</span> ServerStatusEvaluator() &#123;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> statusCode, RequestType requestType)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (statusCode &gt;= <span class="number">200</span> &amp;&amp; statusCode &lt; <span class="number">300</span> || statusCode == <span class="number">302</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.Register &amp;&amp; statusCode == <span class="number">404</span>) &#123; <span class="comment">// æ³¨å†Œï¼Œ404 å¯æ¥å—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.SendHeartBeat &amp;&amp; statusCode == <span class="number">404</span>) &#123; <span class="comment">// å¿ƒè·³ï¼Œ404 å¯æ¥å—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.Cancel) &#123;  <span class="comment">// cancel is best effort ä¸‹çº¿ï¼Œæ¥å—å…¨éƒ¨</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestType == RequestType.GetDelta &amp;&amp; (statusCode == <span class="number">403</span> || statusCode == <span class="number">404</span>)) &#123; <span class="comment">// å¢é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œ403 404 å¯æ¥å—</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 34 è¡Œ ï¼šè¯·æ±‚æˆåŠŸï¼Œè®¾ç½® <code>delegate</code> ã€‚ä¸‹æ¬¡è¯·æ±‚ï¼Œä¼˜å…ˆä½¿ç”¨ <code>delegate</code> ï¼Œå¤±è´¥æ‰è¿›è¡Œå€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„é‡è¯•ã€‚</p></li><li><p>ç¬¬ 47 è¡Œ ï¼šè¯·æ±‚å¤±è´¥ï¼Œ<code>delegate</code> è‹¥ç­‰äº <code>currentHttpClient</code> ï¼Œè¿›è¡Œæ¸…é™¤ã€‚</p></li><li><p>ç¬¬ 50 è‡³ 52 è¡Œ ï¼šè¯·æ±‚å¤±è´¥ï¼Œå°†è¯·æ±‚çš„ Eureka-Server åœ°å€æ·»åŠ åˆ° <code>quarantineSet</code> ã€‚</p></li><li><p>æ€»ç»“æ¥è¯´ï¼š</p><ul><li>ã€ç¬¬ä¸€æ­¥ã€‘è‹¥å½“å‰æœ‰è¯·æ±‚æˆåŠŸçš„ EurekaHttpClient ï¼Œç»§ç»­ä½¿ç”¨ã€‚è‹¥è¯·æ±‚å¤±è´¥ï¼Œæ‰§è¡Œã€ç¬¬äºŒæ­¥ã€‘ã€‚</li><li>ã€ç¬¬äºŒæ­¥ã€‘è‹¥å½“å‰æ— è¯·æ±‚æˆåŠŸçš„ EurekaHttpClient ï¼Œè·å–å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„<strong>é¡ºåº</strong>åˆ›å»ºæ–°çš„ EurekaHttpClientï¼Œç›´åˆ°æˆåŠŸï¼Œæˆ–è€…è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚å½“è¯·æ±‚æˆåŠŸï¼Œä¿å­˜è¯¥ EurekaHttpClient ï¼Œä¸‹æ¬¡ç»§ç»­ä½¿ç”¨ï¼Œç›´åˆ°è¯·æ±‚å¤±è´¥ã€‚</li></ul></li></ul><h3>5.3.1 å·¥å‚</h3><p>RetryableEurekaHttpClient æä¾› <code>#createFactory(...)</code> <strong>é™æ€æ–¹æ³•</strong>è·å¾—åˆ›å»ºå…¶çš„å·¥å‚ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RetryableEurekaHttpClient.java#L135" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ã€‚</p><h2>5.4 SessionedEurekaHttpClient</h2><p><code>com.netflix.discovery.shared.transport.decorator.SessionedEurekaHttpClient</code> ï¼Œæ”¯æŒä¼šè¯çš„ EurekaHttpClient ã€‚æ‰§è¡Œå®šæœŸçš„é‡å»ºä¼šè¯ï¼Œé˜²æ­¢ä¸€ä¸ª Eureka-Client æ°¸è¿œåªè¿æ¥ä¸€ä¸ªç‰¹å®šçš„ Eureka-Server ã€‚åè¿‡æ¥ï¼Œè¿™ä¹Ÿä¿è¯äº† Eureka-Server é›†ç¾¤å˜æ›´æ—¶ï¼ŒEureka-Client å¯¹ Eureka-Server è¿æ¥çš„è´Ÿè½½å‡è¡¡ã€‚</p><p><code>#execute(...)</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">long</span> delay = now - lastReconnectTimeStamp;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// è¶…è¿‡ å½“å‰ä¼šè¯æ—¶é—´ï¼Œå…³é—­å½“å‰å§”æ‰˜çš„ EurekaHttpClient ã€‚</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (delay &gt;= currentSessionDurationMs) &#123;</div><div class="line"> <span class="number">8</span>:         logger.debug(<span class="string">"Ending a session and starting anew"</span>);</div><div class="line"> <span class="number">9</span>:         lastReconnectTimeStamp = now;</div><div class="line"><span class="number">10</span>:         currentSessionDurationMs = randomizeSessionDuration(sessionDurationMs);</div><div class="line"><span class="number">11</span>:         TransportUtils.shutdown(eurekaHttpClientRef.getAndSet(<span class="keyword">null</span>));</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="comment">// è·å¾—å§”æ‰˜çš„ EurekaHttpClient ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°çš„å§”æ‰˜çš„ EurekaHttpClient ã€‚</span></div><div class="line"><span class="number">15</span>:     EurekaHttpClient eurekaHttpClient = eurekaHttpClientRef.get();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (eurekaHttpClient == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">17</span>:         eurekaHttpClient = TransportUtils.getOrSetAnotherClient(eurekaHttpClientRef, clientFactory.newClient());</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>:     <span class="keyword">return</span> requestExecutor.execute(eurekaHttpClient);</div><div class="line"><span class="number">20</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 7 è‡³ 12 è¡Œ ï¼šè¶…è¿‡å½“å‰ä¼šè¯æ—¶é—´ï¼Œå…³é—­å½“å‰å§”æ‰˜çš„ EurekaHttpClient ã€‚</p><ul><li><p>ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ <code>#randomizeSessionDuration(...)</code> æ–¹æ³•ï¼Œè®¡ç®—è®¡ç®—ä¸‹ä¸€æ¬¡ä¼šè¯è¶…æ—¶æ—¶é•¿ï¼Œå…¬å¼ä¸º <code>sessionDurationMs * (0.5, 1.5)</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">randomizeSessionDuration</span><span class="params">(<span class="keyword">long</span> sessionDurationMs)</span> </span>&#123;</div><div class="line">   <span class="keyword">long</span> delta = (<span class="keyword">long</span>) (sessionDurationMs * (random.nextDouble() - <span class="number">0.5</span>));</div><div class="line">   <span class="keyword">return</span> sessionDurationMs + delta;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å¢åŠ ä¼šè¯è¿‡æœŸçš„éšæœºæ€§ï¼Œå®ç°æ‰€æœ‰ Eureka-Client çš„ä¼šè¯è¿‡æœŸé‡è¿çš„å‘ç”Ÿæ—¶é—´æ›´åŠ ç¦»æ•£ï¼Œé¿å…é›†ä¸­æ—¶é—´è¿‡æœŸã€‚ç›®å‰çŒœæµ‹è¿™ä¹ˆåšçš„ç›®çš„å’Œ TODO[0028]ï¼šå†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤ æœ‰å…³ï¼Œå³è¿”å› 302 ã€‚å…³è” <a href="https://github.com/Netflix/eureka/pull/687" rel="external nofollow noopener noreferrer" target="_blank">1.x new transport enhancements</a> ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 15 è‡³ 18 è¡Œ ï¼šè·å¾—å§”æ‰˜çš„ EurekaHttpClient ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„å§”æ‰˜çš„ EurekaHttpClient ã€‚<code>TransportUtils#getOrSetAnotherClient(...)</code> æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClient <span class="title">getOrSetAnotherClient</span><span class="params">(AtomicReference&lt;EurekaHttpClient&gt; eurekaHttpClientRef, EurekaHttpClient another)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     EurekaHttpClient existing = eurekaHttpClientRef.get();</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ä¸ºç©ºæ‰è®¾ç½®</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (eurekaHttpClientRef.compareAndSet(<span class="keyword">null</span>, another)) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">return</span> another;</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// è®¾ç½®å¤±è´¥ï¼Œæ„å‘³ç€å¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç»è®¾ç½®</span></div><div class="line"> <span class="number">8</span>:     another.shutdown();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">return</span> existing;</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¯¥æ–¹æ³•å®ç°ï¼Œè·å¾— <code>eurekaHttpClientRef</code> é‡Œçš„ EurekaHttpClient ã€‚è‹¥è·å–ä¸åˆ°ï¼Œå°† <code>another</code> è®¾ç½®åˆ° <code>eurekaHttpClientRef</code> ã€‚å½“æœ‰å¤šä¸ªçº¿ç¨‹è®¾ç½®æ—¶ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆåŠŸï¼Œå¦å¤–çš„è®¾ç½®å¤±è´¥çš„çº¿ç¨‹ä»¬ï¼Œæ„å‘³ç€å½“å‰ <code>eurekaHttpClientRef</code> æœ‰ EurekaHttpClient ï¼Œè¿”å› <code>eurekaHttpClientRef</code> ã€‚</p></li><li><p>ç›®å‰è¯¥æ–¹æ³•å­˜åœ¨ BUG ï¼Œå¤±è´¥çš„çº¿ç¨‹ç›´æ¥è¿”å› <code>existing</code> çš„æ˜¯ <code>null</code> ï¼Œéœ€è¦ä¿®æ”¹æˆ <code>return eurekaHttpClientRef.get()</code> ã€‚æ¨¡æ‹Ÿé‡ç°è¯¥ BUG ä»£ç å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/04.png" alt=""></p></li></ul></li><li><p>ç¬¬ 19 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚ã€‚</p></li></ul><h3>5.4.1 æ²¡æœ‰å·¥å‚</h3><p>åœ¨ SessionedEurekaHttpClient ç±»é‡Œï¼Œæ²¡æœ‰å®ç°åˆ›å»ºå…¶çš„å·¥å‚ã€‚åœ¨ <a href="#">ã€Œ6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯ã€æœç´¢ <code>canonicalClientFactory</code></a> ï¼Œå¯ä»¥çœ‹åˆ° <code>EurekaHttpClients#canonicalClientFactory(...)</code> æ–¹æ³•ï¼Œå†…éƒ¨æœ‰ SessionedEurekaHttpClient çš„åˆ›å»ºå·¥å‚ã€‚</p><h1>6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯</h1><p>å¯¹äº Eureka-Server æ¥è¯´ï¼Œè°ƒç”¨ <code>JerseyReplicationClient#createReplicationClient(...)</code> <strong>é™æ€æ–¹æ³•</strong>å³å¯åˆ›å»ºç”¨äº Eureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ <strong>å…¶å®ƒçš„Eureka-Server</strong> çš„ç½‘ç»œé€šä¿¡å®¢æˆ·ç«¯ã€‚</p><p>å¯¹äº Eureka-Client æ¥è¯´ï¼Œåˆ†æˆç”¨äº<strong>æ³¨å†Œåº”ç”¨å®ä¾‹( <code>registrationClient</code> )<strong>å’Œ</strong>æŸ¥è¯¢æ³¨å†Œä¿¡æ¯( <code>newQueryClient</code> )<strong>çš„</strong>ä¸¤ä¸ªä¸åŒ</strong>ç½‘ç»œé€šä¿¡å®¢æˆ·ç«¯ã€‚åœ¨ DiscoveryClient åˆå§‹åŒ–æ—¶è¿›è¡Œåˆ›å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.class</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleServerEndpointTask</span><span class="params">(EurekaTransport eurekaTransport,</span></span></div><div class="line"><span class="function"><span class="params">  <span class="number">2</span>:                                         AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:         </div><div class="line">  <span class="number">4</span>:     Collection&lt;?&gt; additionalFilters = args == <span class="keyword">null</span></div><div class="line">  <span class="number">5</span>:             ? Collections.emptyList()</div><div class="line">  <span class="number">6</span>:             : args.additionalFilters;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     EurekaJerseyClient providedJerseyClient = args == <span class="keyword">null</span></div><div class="line">  <span class="number">9</span>:             ? <span class="keyword">null</span></div><div class="line"> <span class="number">10</span>:             : args.eurekaJerseyClient;</div><div class="line"> <span class="number">11</span>:     </div><div class="line"> <span class="number">12</span>:     TransportClientFactories argsTransportClientFactories = <span class="keyword">null</span>;</div><div class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.getTransportClientFactories() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">14</span>:         argsTransportClientFactories = args.getTransportClientFactories();</div><div class="line"> <span class="number">15</span>:     &#125;</div><div class="line"> <span class="number">16</span>:     </div><div class="line"> <span class="number">17</span>:     <span class="comment">// Ignore the raw types warnings since the client filter interface changed between jersey 1/2</span></div><div class="line"> <span class="number">18</span>:     <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line"> <span class="number">19</span>:     TransportClientFactories transportClientFactories = argsTransportClientFactories == <span class="keyword">null</span></div><div class="line"> <span class="number">20</span>:             ? <span class="keyword">new</span> Jersey1TransportClientFactories()</div><div class="line"> <span class="number">21</span>:             : argsTransportClientFactories;</div><div class="line"> <span class="number">22</span>: </div><div class="line"> <span class="number">23</span>:     <span class="comment">// If the transport factory was not supplied with args, assume they are using jersey 1 for passivity</span></div><div class="line"> <span class="number">24</span>:     <span class="comment">// noinspection unchecked</span></div><div class="line"> <span class="number">25</span>:     eurekaTransport.transportClientFactory = providedJerseyClient == <span class="keyword">null</span></div><div class="line"> <span class="number">26</span>:             ? transportClientFactories.newTransportClientFactory(clientConfig, additionalFilters, applicationInfoManager.getInfo())</div><div class="line"> <span class="number">27</span>:             : transportClientFactories.newTransportClientFactory(additionalFilters, providedJerseyClient);</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:     <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰åˆå§‹åŒ– åº”ç”¨è§£æå™¨çš„åº”ç”¨å®ä¾‹æ•°æ®æº TODO[0028]å†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤</span></div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:     <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰åˆ›å»º EndPoint è§£æå™¨</span></div><div class="line"> <span class="number">32</span>:     eurekaTransport.bootstrapResolver = EurekaHttpClients.newBootstrapResolver(...)</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:     <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line"> <span class="number">35</span>:         EurekaHttpClientFactory newRegistrationClientFactory = <span class="keyword">null</span>;</div><div class="line"> <span class="number">36</span>:         EurekaHttpClient newRegistrationClient = <span class="keyword">null</span>;</div><div class="line"> <span class="number">37</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">38</span>:             newRegistrationClientFactory = EurekaHttpClients.registrationClientFactory(</div><div class="line"> <span class="number">39</span>:                     eurekaTransport.bootstrapResolver,</div><div class="line"> <span class="number">40</span>:                     eurekaTransport.transportClientFactory,</div><div class="line"> <span class="number">41</span>:                     transportConfig</div><div class="line"> <span class="number">42</span>:             );</div><div class="line"> <span class="number">43</span>:             newRegistrationClient = newRegistrationClientFactory.newClient();</div><div class="line"> <span class="number">44</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">45</span>:             logger.warn(<span class="string">"Transport initialization failure"</span>, e);</div><div class="line"> <span class="number">46</span>:         &#125;</div><div class="line"> <span class="number">47</span>:         eurekaTransport.registrationClientFactory = newRegistrationClientFactory;</div><div class="line"> <span class="number">48</span>:         eurekaTransport.registrationClient = newRegistrationClient;</div><div class="line"> <span class="number">49</span>:     &#125;</div><div class="line"> <span class="number">50</span>: </div><div class="line"> <span class="number">51</span>:     <span class="comment">// new method (resolve from primary servers for read)</span></div><div class="line"> <span class="number">52</span>:     <span class="comment">// Configure new transport layer (candidate for injecting in the future)</span></div><div class="line"> <span class="number">53</span>:     <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line"> <span class="number">54</span>:         EurekaHttpClientFactory newQueryClientFactory = <span class="keyword">null</span>;</div><div class="line"> <span class="number">55</span>:         EurekaHttpClient newQueryClient = <span class="keyword">null</span>;</div><div class="line"> <span class="number">56</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">57</span>:             newQueryClientFactory = EurekaHttpClients.queryClientFactory(</div><div class="line"> <span class="number">58</span>:                     eurekaTransport.bootstrapResolver,</div><div class="line"> <span class="number">59</span>:                     eurekaTransport.transportClientFactory,</div><div class="line"> <span class="number">60</span>:                     clientConfig,</div><div class="line"> <span class="number">61</span>:                     transportConfig,</div><div class="line"> <span class="number">62</span>:                     applicationInfoManager.getInfo(),</div><div class="line"> <span class="number">63</span>:                     applicationsSource</div><div class="line"> <span class="number">64</span>:             );</div><div class="line"> <span class="number">65</span>:             newQueryClient = newQueryClientFactory.newClient();</div><div class="line"> <span class="number">66</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">67</span>:             logger.warn(<span class="string">"Transport initialization failure"</span>, e);</div><div class="line"> <span class="number">68</span>:         &#125;</div><div class="line"> <span class="number">69</span>:         eurekaTransport.queryClientFactory = newQueryClientFactory;</div><div class="line"> <span class="number">70</span>:         eurekaTransport.queryClient = newQueryClient;</div><div class="line"> <span class="number">71</span>:     &#125;</div><div class="line"> <span class="number">72</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 18 è‡³ 27 è¡Œ ï¼šè°ƒç”¨ <code>Jersey1TransportClientFactories#newTransportClientFactory(...)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>registrationClient</code> å’Œ <code>queryClient</code> å…¬ç”¨çš„å§”æ‰˜çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Jersey1TransportClientFactories.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                              <span class="keyword">final</span> Collection&lt;ClientFilter&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                              <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span> </span>&#123;</div><div class="line">   <span class="comment">// JerseyEurekaHttpClientFactory</span></div><div class="line">   <span class="keyword">final</span> TransportClientFactory jerseyFactory = JerseyEurekaHttpClientFactory.create(</div><div class="line">           clientConfig,</div><div class="line">           additionalFilters,</div><div class="line">           myInstanceInfo,</div><div class="line">           <span class="keyword">new</span> EurekaClientIdentity(myInstanceInfo.getIPAddr())</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// TransportClientFactory</span></div><div class="line">   <span class="keyword">final</span> TransportClientFactory metricsFactory = MetricsCollectingEurekaHttpClient.createFactory(jerseyFactory); <span class="comment">// å§”æ‰˜ TransportClientFactory</span></div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TransportClientFactory() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> metricsFactory.newClient(serviceUrl);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">           metricsFactory.shutdown();</div><div class="line">           jerseyFactory.shutdown();</div><div class="line">       &#125;</div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ TransportClientFactory é‡Œ<strong>å§”æ‰˜</strong> JerseyEurekaHttpClientFactory ã€‚</li></ul></li><li><p>ç¬¬ 34 è‡³ 49 è¡Œ ï¼šè°ƒç”¨ <code>EurekaHttpClients#registrationClientFactory(...)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>registrationClient</code> çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClients.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClientFactory <span class="title">registrationClientFactory</span><span class="params">(ClusterResolver bootstrapResolver,</span></span></div><div class="line"><span class="function"><span class="params">                                                                TransportClientFactory transportClientFactory,</span></span></div><div class="line"><span class="function"><span class="params">                                                                EurekaTransportConfig transportConfig)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> canonicalClientFactory(EurekaClientNames.REGISTRATION, transportConfig, bootstrapResolver, transportClientFactory);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> EurekaHttpClientFactory <span class="title">canonicalClientFactory</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> EurekaTransportConfig transportConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> ClusterResolver&lt;EurekaEndpoint&gt; clusterResolver,</span></span></div><div class="line"><span class="function"><span class="params">                                                     <span class="keyword">final</span> TransportClientFactory transportClientFactory)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> EurekaHttpClientFactory() &#123; <span class="comment">// SessionedEurekaHttpClientFactory</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SessionedEurekaHttpClient(</div><div class="line">                   name,</div><div class="line">                   RetryableEurekaHttpClient.createFactory( <span class="comment">// RetryableEurekaHttpClient</span></div><div class="line">                           name,</div><div class="line">                           transportConfig,</div><div class="line">                           clusterResolver,</div><div class="line">                           RedirectingEurekaHttpClient.createFactory(transportClientFactory), <span class="comment">// RedirectingEurekaHttpClient</span></div><div class="line">                           ServerStatusEvaluators.legacyEvaluator()),</div><div class="line">                   transportConfig.getSessionedClientReconnectIntervalSeconds() * <span class="number">1000</span></div><div class="line">           );</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">           wrapClosable(clusterResolver).shutdown();</div><div class="line">       &#125;</div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 51 è‡³ 71 è¡Œ ï¼šè°ƒç”¨ <code>EurekaHttpClients#queryClientFactory(...)</code> æ–¹æ³•ï¼Œåˆ›å»º <code>queryClient</code> çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaHttpClients.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClientFactory <span class="title">queryClientFactory</span><span class="params">(ClusterResolver bootstrapResolver,</span></span></div><div class="line"><span class="function"><span class="params">                                                        TransportClientFactory transportClientFactory,</span></span></div><div class="line"><span class="function"><span class="params">                                                        EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                        EurekaTransportConfig transportConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                        InstanceInfo myInstanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                                        ApplicationsResolver.ApplicationsSource applicationsSource)</span> </span>&#123;</div><div class="line"></div><div class="line">   ClosableResolver queryResolver = transportConfig.useBootstrapResolverForQuery()</div><div class="line">           ? wrapClosable(bootstrapResolver)</div><div class="line">           : queryClientResolver(bootstrapResolver, transportClientFactory,</div><div class="line">           clientConfig, transportConfig, myInstanceInfo, applicationsSource);</div><div class="line">   <span class="keyword">return</span> canonicalClientFactory(EurekaClientNames.QUERY, transportConfig, queryResolver, transportClientFactory); <span class="comment">// è¯¥æ–¹æ³•ä¸Šé¢æœ‰</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>è¿™æ¬¡çœŸçš„æ˜¯å½©è›‹ï¼Œæˆ‘ä»¬å°†æ•´ä½“è°ƒç”¨å…³ç³»è°ƒæ•´å¦‚ä¸‹å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_31/05.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_31/05.png" alt=""></p><p>èƒ–å‹ï¼Œä½ å­¦ä¼šäº†ä¹ˆï¼Ÿ</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/transport/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨</title>
    <link href="http://www.iocoder.cn/Eureka/end-point-and-resolver/"/>
    <id>http://www.iocoder.cn/Eureka/end-point-and-resolver/</id>
    <published>2018-07-23T16:00:00.000Z</published>
    <updated>2017-10-16T11:13:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/end-point-and-resolver/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2. EndPoint</a><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2.1 EurekaEndpoint</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2.2 DefaultEndpoint</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">2.3 AwsEndpoint</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3. è§£æå™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.1 ClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.2 ClosableResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.3 DnsTxtRecordClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.4 ConfigClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.5 ZoneAffinityClusterResolver</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.6 AsyncResolver</a><ul><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.6.1 å®šæ—¶ä»»åŠ¡</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">3.6.2 è§£æ EndPoint é›†ç¾¤</a></li></ul></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">4. åˆå§‹åŒ–è§£æå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>EndPoint ä¸ è§£æå™¨</strong>ã€‚</p><ul><li>EndPoint ï¼ŒæœåŠ¡ç«¯ç‚¹ã€‚ä¾‹å¦‚ï¼ŒEureka-Server çš„è®¿é—®åœ°å€ã€‚</li><li>EndPoint è§£æå™¨ï¼Œå°†é…ç½®çš„ Eureka-Server çš„è®¿é—®åœ°å€è§£ææˆ EndPoint ã€‚</li></ul><p>ç›®å‰æœ‰å¤šç§ Eureka-Server è®¿é—®åœ°å€çš„é…ç½®æ–¹å¼ï¼Œ<strong>æœ¬æ–‡åªåˆ†äº« Eureka 1.x çš„é…ç½®</strong>ï¼Œä¸åŒ…å« Eureka 1.x å¯¹ Eureka 2.x çš„å…¼å®¹é…ç½®ï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼Œç›´æ¥é…ç½®å®é™…è®¿é—®åœ°å€ã€‚ä¾‹å¦‚ï¼Œ<code>eureka.serviceUrl.defaultZone=http://127.0.0.1:8080/v2</code> ã€‚</li><li>ç¬¬äºŒç§ï¼ŒåŸºäº DNS è§£æå‡ºè®¿é—®åœ°å€ã€‚ä¾‹å¦‚ï¼Œ<code>eureka.shouldUseDns=true</code> å¹¶ä¸”  <code>eureka.eurekaServer.domainName=eureka.iocoder.cn</code> ã€‚</li></ul><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.discovery.shared.resolver</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_24/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_24/01.png" alt=""></p><ul><li>çº¢è‰²éƒ¨åˆ† â€”â€” EndPoint</li><li>é»„è‰²éƒ¨åˆ† â€”â€” EndPoint è§£æå™¨</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EndPoint</h1><h2>2.1 EurekaEndpoint</h2><p><code>com.netflix.discovery.shared.resolver.EurekaEndpoint</code> ï¼ŒEureka æœåŠ¡ç«¯ç‚¹<strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEndpoint</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å®Œæ•´çš„æœåŠ¡ URL</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getServiceUrl</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@deprecated</span> use &#123;<span class="doctag">@link</span> #getNetworkAddress()&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    <span class="function">String <span class="title">getHostName</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ç½‘ç»œåœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getNetworkAddress</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦å®‰å…¨( https )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSecure</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ç›¸å¯¹è·¯å¾„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getRelativeUri</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>2.2 DefaultEndpoint</h2><p><code>com.netflix.discovery.shared.resolver.DefaultEndpoint</code> ï¼Œé»˜è®¤ Eureka æœåŠ¡ç«¯ç‚¹<strong>å®ç°ç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEndpoint</span> <span class="keyword">implements</span> <span class="title">EurekaEndpoint</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç½‘ç»œåœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String networkAddress;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å®‰å…¨( https )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSecure;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›¸å¯¹åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String relativeUri;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®Œæ•´çš„æœåŠ¡ URL</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String serviceUrl;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEndpoint</span><span class="params">(String serviceUrl)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.serviceUrl = serviceUrl;</div><div class="line"></div><div class="line">        <span class="comment">// å°† serviceUrl åˆ†è§£æˆ å‡ ä¸ªå±æ€§</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            URL url = <span class="keyword">new</span> URL(serviceUrl);</div><div class="line">            <span class="keyword">this</span>.networkAddress = url.getHost();</div><div class="line">            <span class="keyword">this</span>.port = url.getPort();</div><div class="line">            <span class="keyword">this</span>.isSecure = <span class="string">"https"</span>.equals(url.getProtocol());</div><div class="line">            <span class="keyword">this</span>.relativeUri = url.getPath();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Malformed serviceUrl: "</span> + serviceUrl);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEndpoint</span><span class="params">(String networkAddress, <span class="keyword">int</span> port, <span class="keyword">boolean</span> isSecure, String relativeUri)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.networkAddress = networkAddress;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.isSecure = isSecure;</div><div class="line">        <span class="keyword">this</span>.relativeUri = relativeUri;</div><div class="line"></div><div class="line">        <span class="comment">// å‡ ä¸ªå±æ€§ æ‹¼æ¥æˆ serviceUrl</span></div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder().append(isSecure ? <span class="string">"https"</span> : <span class="string">"http"</span>).append(<span class="string">"://"</span>).append(networkAddress);</div><div class="line"><span class="keyword">if</span> (port &gt;= <span class="number">0</span>) &#123;</div><div class="line">sb.append(<span class="string">':'</span>).append(port);</div><div class="line">&#125;</div><div class="line">        <span class="keyword">if</span> (relativeUri != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!relativeUri.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                sb.append(<span class="string">'/'</span>);</div><div class="line">            &#125;</div><div class="line">            sb.append(relativeUri);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.serviceUrl = sb.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é‡å†™äº† <code>#equals(...)</code> å’Œ <code>#hashCode(...)</code> æ–¹æ³•ï¼Œæ ‡å‡†å®ç°æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚</li><li>é‡å†™äº† <code>#compareTo(...)</code> æ–¹æ³•ï¼ŒåŸºäº <code>serviceUrl</code> å±æ€§åšæ¯”è¾ƒã€‚</li></ul><h2>2.3 AwsEndpoint</h2><p><code>com.netflix.discovery.shared.resolver.aws.AwsEndpoint</code> ï¼ŒåŸºäº <code>region</code>ã€<code>zone</code> çš„ Eureka æœåŠ¡ç«¯ç‚¹<strong>å®ç°ç±»</strong> ( è¯·ä¸è¦åœ¨æ„ AWS å¼€å¤´ )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AwsEndpoint</span> <span class="keyword">extends</span> <span class="title">DefaultEndpoint</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åŒºåŸŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String region;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯ç”¨åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String zone;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é‡å†™äº† <code>#equals(...)</code> å’Œ <code>#hashCode(...)</code> æ–¹æ³•ï¼Œæ ‡å‡†å®ç°æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚</li></ul><h1>3. è§£æå™¨</h1><p>EndPoint è§£æå™¨ä½¿ç”¨<strong>å§”æ‰˜è®¾è®¡æ¨¡å¼</strong>å®ç°ã€‚æ‰€ä»¥ï¼Œä¸Šæ–‡å›¾ç‰‡ä¸­æˆ‘ä»¬çœ‹åˆ°å¥½å¤šä¸ªè§£æå™¨ï¼Œ<strong>å®é™…ä»£ç éå¸¸éå¸¸éå¸¸æ¸…æ™°</strong>ã€‚</p><blockquote><p>FROM <a href="https://zh.wikipedia.org/wiki/%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå§”æ‰˜æ¨¡å¼ã€‹</a><br>å§”æ‰˜æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€é¡¹åŸºæœ¬æŠ€å·§ã€‚åœ¨å§”æ‰˜æ¨¡å¼ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¯¹è±¡å‚ä¸å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—è¯·æ±‚çš„å¯¹è±¡å°†è¯·æ±‚å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡æ¥å¤„ç†ã€‚å§”æ‰˜æ¨¡å¼æ˜¯ä¸€é¡¹åŸºæœ¬æŠ€å·§ï¼Œè®¸å¤šå…¶ä»–çš„æ¨¡å¼ï¼Œå¦‚çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯åœ¨æ›´ç‰¹æ®Šçš„åœºåˆé‡‡ç”¨äº†å§”æ‰˜æ¨¡å¼ã€‚å§”æ‰˜æ¨¡å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨èšåˆæ¥æ›¿ä»£ç»§æ‰¿ï¼Œå®ƒè¿˜ä½¿æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿmixinã€‚</p></blockquote><p>æˆ‘ä»¬åœ¨ä¸Šå›¾çš„åŸºç¡€ä¸Šï¼Œ<strong>å¢åŠ å§”æ‰˜çš„å…³ç³»</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_24/02.png" alt=""></p><h2>3.1 ClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.ClusterResolver</code> ï¼Œé›†ç¾¤è§£æå™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClusterResolver</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">EurekaEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> åœ°åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getRegion</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> EndPoint é›†ç¾¤( æ•°ç»„ )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;T&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 ClosableResolver</h2><p><code>com.netflix.discovery.shared.resolver.ClosableResolver</code> ï¼Œ<strong>å¯å…³é—­</strong>çš„è§£æå™¨<strong>æ¥å£</strong>ï¼Œç»§æ‰¿è‡ª ClusterResolver <strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClosableResolver</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">EurekaEndpoint</span>&gt; <span class="keyword">extends</span> <span class="title">ClusterResolver</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.3 DnsTxtRecordClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.aws.DnsTxtRecordClusterResolver</code> ï¼ŒåŸºäº DNS <strong>TXT</strong> è®°å½•ç±»å‹çš„é›†ç¾¤è§£æå™¨ã€‚<strong>ç±»å±æ€§</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DnsTxtRecordClusterResolver</span> <span class="keyword">implements</span> <span class="title">ClusterResolver</span>&lt;<span class="title">AwsEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åœ°åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String region;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é›†ç¾¤æ ¹åœ°å€ï¼Œä¾‹å¦‚ txt.default.eureka.iocoder.cn</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String rootClusterDNS;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦è§£æå¯ç”¨åŒº( zone )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> extractZoneFromDNS;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å®‰å…¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSecure;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›¸å¯¹åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String relativeUri;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>DnsTxtRecordClusterResolver é€šè¿‡é›†ç¾¤æ ¹åœ°å€( <code>rootClusterDNS</code> ) è§£æå‡º EndPoint é›†ç¾¤ã€‚éœ€è¦åœ¨ DNS é…ç½®<strong>ä¸¤å±‚</strong>è§£æè®°å½•ï¼š</p><ul><li>ç¬¬ä¸€å±‚ ï¼š<ul><li>ä¸»æœºè®°å½• ï¼šæ ¼å¼ä¸º <code>TXT.${REGION}.${è‡ªå®šä¹‰äºŒçº§åŸŸå}</code> ã€‚</li><li>è®°å½•ç±»å‹ ï¼š<strong>TXT è®°å½•ç±»å‹</strong>ã€‚</li><li>è®°å½•å€¼ ï¼šç¬¬äºŒå±‚çš„<strong>ä¸»æœºè®°å½•</strong>ã€‚å¦‚æœ‰å¤šä¸ªç¬¬äºŒå±‚çº§ï¼Œä½¿ç”¨<strong>ç©ºæ ¼</strong>åˆ†éš”ã€‚</li></ul></li><li>ç¬¬äºŒå±‚ï¼š<ul><li>ä¸»æœºè®°å½• ï¼šæ ¼å¼ä¸º <code>TXT.${ZONE}.${è‡ªå®šä¹‰äºŒçº§åŸŸå}</code> æˆ–è€… <code>${ZONE}.${è‡ªå®šä¹‰äºŒçº§åŸŸå}</code>ã€‚</li><li>è®°å½•ç±»å‹ ï¼š<strong>TXT è®°å½•ç±»å‹</strong>ã€‚</li><li>è®°å½•å€¼ ï¼šEndPoint çš„ç½‘ç»œåœ°å€ã€‚å¦‚æœ‰å¤šä¸ª EndPointï¼Œä½¿ç”¨<strong>ç©ºæ ¼</strong>åˆ†éš”ã€‚</li></ul></li><li>ä¸¾ä¸ªä¾‹å­ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_24/03.png" alt=""></li></ul></li><li><p><code>rootClusterDNS</code> ï¼Œé›†ç¾¤æ ¹åœ°å€ã€‚ä¾‹å¦‚ï¼š<code>txt.default.eureka.iocoder.cn</code>ï¼Œå…¶Â· <code>txt.default.eureka</code> ä¸º DNS è§£æè®°å½•çš„ç¬¬ä¸€å±‚çš„<strong>ä¸»æœºè®°å½•</strong>ã€‚</p></li><li><p><code>region</code> ï¼šåœ°åŒºã€‚éœ€è¦å’Œ <code>rootClusterDNS</code> çš„ <code>${REGION}</code> ä¸€è‡´ã€‚</p></li><li><p><code>extractZoneFromDNS</code> ï¼šæ˜¯å¦è§£æ DNS è§£æè®°å½•çš„ç¬¬äºŒå±‚çº§çš„<strong>ä¸»æœºè®°å½•</strong>çš„ <code>${ZONE}</code> å¯ç”¨åŒºã€‚</p></li></ul><hr><p><code>#getClusterEndpoints(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     List&lt;AwsEndpoint&gt; eurekaEndpoints = resolve(region, rootClusterDNS, extractZoneFromDNS, port, isSecure, relativeUri);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">5</span>:         logger.debug(<span class="string">"Resolved &#123;&#125; to &#123;&#125;"</span>, rootClusterDNS, eurekaEndpoints);</div><div class="line"> <span class="number">6</span>:     &#125;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">return</span> eurekaEndpoints;</div><div class="line"> <span class="number">8</span>: &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AwsEndpoint&gt; <span class="title">resolve</span><span class="params">(String region, String rootClusterDNS, <span class="keyword">boolean</span> extractZone, <span class="keyword">int</span> port, <span class="keyword">boolean</span> isSecure, String relativeUri)</span> </span>&#123;</div><div class="line"><span class="number">11</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// è§£æ ç¬¬ä¸€å±‚ DNS è®°å½•</span></div><div class="line"><span class="number">13</span>:         Set&lt;String&gt; zoneDomainNames = resolve(rootClusterDNS);</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (zoneDomainNames.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> ClusterResolverException(<span class="string">"Cannot resolve Eureka cluster addresses; there are no data in TXT record for DN "</span> + rootClusterDNS);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>:         <span class="comment">// è®°å½• ç¬¬äºŒå±‚ DNS è®°å½•</span></div><div class="line"><span class="number">18</span>:         List&lt;AwsEndpoint&gt; endpoints = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">for</span> (String zoneDomain : zoneDomainNames) &#123;</div><div class="line"><span class="number">20</span>:             String zone = extractZone ? ResolverUtils.extractZoneFromHostName(zoneDomain) : <span class="keyword">null</span>; <span class="comment">// </span></div><div class="line"><span class="number">21</span>:             Set&lt;String&gt; zoneAddresses = resolve(zoneDomain);</div><div class="line"><span class="number">22</span>:             <span class="keyword">for</span> (String address : zoneAddresses) &#123;</div><div class="line"><span class="number">23</span>:                 endpoints.add(<span class="keyword">new</span> AwsEndpoint(address, port, isSecure, relativeUri, region, zone));</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> endpoints;</div><div class="line"><span class="number">27</span>:     &#125; <span class="keyword">catch</span> (NamingException e) &#123;</div><div class="line"><span class="number">28</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> ClusterResolverException(<span class="string">"Cannot resolve Eureka cluster addresses for root: "</span> + rootClusterDNS, e);</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 12 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>#resolve(rootClusterDNS)</code> è§£æ<strong>ç¬¬ä¸€å±‚</strong> DNS è®°å½•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">resolve</span><span class="params">(String rootClusterDNS)</span> <span class="keyword">throws</span> NamingException </span>&#123;</div><div class="line"> <span class="number">2</span>:     Set&lt;String&gt; result;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         result = DnsResolver.getCNamesFromTxtRecord(rootClusterDNS);</div><div class="line"> <span class="number">5</span>:         <span class="comment">// TODO èŠ‹è‰¿ï¼šè¿™å—æ˜¯bugï¼Œä¸éœ€è¦è¿™ä¸€æ®µ</span></div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (!rootClusterDNS.startsWith(<span class="string">"txt."</span>)) &#123;</div><div class="line"> <span class="number">7</span>:             result = DnsResolver.getCNamesFromTxtRecord(<span class="string">"txt."</span> + rootClusterDNS);</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">catch</span> (NamingException e) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!rootClusterDNS.startsWith(<span class="string">"txt."</span>)) &#123;</div><div class="line"><span class="number">11</span>:             result = DnsResolver.getCNamesFromTxtRecord(<span class="string">"txt."</span> + rootClusterDNS);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼š è°ƒç”¨ <code>DnsResolver#getCNamesFromTxtRecord(...)</code> æ–¹æ³•ï¼Œè§£æ TXT ä¸»æœºè®°å½•ã€‚ç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/endpoint/DnsResolver.java#L126" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ DnsResolver çš„ä»£ç ï¼Œæ¯”è¾ƒè§£æï¼Œç¬”è€…å°±ä¸å•°å—¦äº†ã€‚</li><li>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šå½“ä¼ é€’å‚æ•° <code>rootClusterDNS</code> ä¸ä»¥ <code>txt.</code> å¼€å¤´æ—¶ï¼Œå³ä½¿ç¬¬ 4 è¡Œè§£ææˆåŠŸï¼Œä¹Ÿä¼šæŠ¥é”™ï¼Œæ­¤æ—¶æ˜¯ä¸ª Eureka çš„ BUG ã€‚å› æ­¤ï¼Œé…ç½® DNS è§£æè®°å½•æ—¶ï¼Œä¸»æœºè®°å½•æš‚æ—¶å¿…é¡»ä»¥ <code>txt.</code> å¼€å¤´ã€‚</li></ul></li><li><p>ç¬¬ 17 è‡³ 25 è¡Œ ï¼šå¾ªç¯ç¬¬ä¸€å±‚ DNS è®°å½•çš„è§£æç»“æœï¼Œè¿›ä¸€æ­¥è§£æç¬¬äºŒå±‚ DNS è®°å½•ã€‚</p><ul><li>ç¬¬ 20 è¡Œ ï¼šè§£æå¯ç”¨åŒº( <code>zone</code> )ã€‚</li><li>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#resolve(rootClusterDNS)</code> è§£æ<strong>ç¬¬äºŒå±‚</strong> DNS è®°å½•ã€‚</li></ul></li></ul><h2>3.4 ConfigClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.aws.ConfigClusterResolver</code> ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„é›†ç¾¤è§£æå™¨ã€‚<strong>ç±»å±æ€§</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClusterResolver</span> <span class="keyword">implements</span> <span class="title">ClusterResolver</span>&lt;<span class="title">AwsEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaClientConfig clientConfig;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo myInstanceInfo;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfigClusterResolver</span><span class="params">(EurekaClientConfig clientConfig, InstanceInfo myInstanceInfo)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.clientConfig = clientConfig;</div><div class="line">        <span class="keyword">this</span>.myInstanceInfo = myInstanceInfo;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><hr><p><code>#getClusterEndpoints(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// ä½¿ç”¨ DNS è·å– EndPoint</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line"> <span class="number">6</span>:             logger.info(<span class="string">"Resolving eureka endpoints via DNS: &#123;&#125;"</span>, getDNSName());</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">return</span> getClusterEndpointsFromDns();</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:     <span class="comment">// ç›´æ¥é…ç½®å®é™…è®¿é—®åœ°å€</span></div><div class="line"><span class="number">11</span>:         logger.info(<span class="string">"Resolving eureka endpoints via configuration"</span>);</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> getClusterEndpointsFromConfig();</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 8 è¡Œ ï¼šåŸºäº DNS è·å– EndPoint é›†ç¾¤ï¼Œè°ƒç”¨ <code>#getClusterEndpointsFromDns()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpointsFromDns</span><span class="params">()</span> </span>&#123;</div><div class="line">   String discoveryDnsName = getDNSName(); <span class="comment">// è·å– é›†ç¾¤æ ¹åœ°å€</span></div><div class="line">   <span class="keyword">int</span> port = Integer.parseInt(clientConfig.getEurekaServerPort()); <span class="comment">// ç«¯å£</span></div><div class="line"></div><div class="line">   <span class="comment">// cheap enough so just re-use</span></div><div class="line">   DnsTxtRecordClusterResolver dnsResolver = <span class="keyword">new</span> DnsTxtRecordClusterResolver(</div><div class="line">           getRegion(),</div><div class="line">           discoveryDnsName,</div><div class="line">           <span class="keyword">true</span>, <span class="comment">// è§£æ zone</span></div><div class="line">           port,</div><div class="line">           <span class="keyword">false</span>,</div><div class="line">           clientConfig.getEurekaServerURLContext()</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// è°ƒç”¨ DnsTxtRecordClusterResolver è§£æ EndPoint</span></div><div class="line">   List&lt;AwsEndpoint&gt; endpoints = dnsResolver.getClusterEndpoints();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (endpoints.isEmpty()) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot resolve to any endpoints for the given dnsName: &#123;&#125;"</span>, discoveryDnsName);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> endpoints;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDNSName</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"txt."</span> + getRegion() + <span class="string">'.'</span> + clientConfig.getEurekaServerDNSName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å¿…é¡»é…ç½® <code>eureka.shouldUseDns=true</code> ï¼Œå¼€å¯åŸºäº DNS è·å– EndPoint é›†ç¾¤ã€‚</li><li>å¿…é¡»é…ç½® <code>eureka.eurekaServer.domainName=${xxxxx}</code> ï¼Œé…ç½®é›†ç¾¤æ ¹åœ°å€ã€‚</li><li>é€‰å¡«é… <code>eureka.eurekaServer.port</code> ï¼Œ<code>eureka.eurekaServer.context</code> ã€‚</li><li>ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ DnsTxtRecordClusterResolver è§£æå‡º EndPoint é›†ç¾¤ã€‚</li></ul></li><li><p>ç¬¬ 9 è‡³ 13 è¡Œ ï¼šç›´æ¥<strong>é…ç½®æ–‡ä»¶</strong>å¡«å†™å®é™… EndPoint é›†ç¾¤ï¼Œè°ƒç”¨ <code>#getClusterEndpointsFromConfig()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p></li></ul><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpointsFromConfig</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— å¯ç”¨åŒº</span></div><div class="line"> <span class="number">3</span>:     String[] availZones = clientConfig.getAvailabilityZones(clientConfig.getRegion());</div><div class="line"> <span class="number">4</span>:     <span class="comment">// è·å– åº”ç”¨å®ä¾‹è‡ªå·± çš„ å¯ç”¨åŒº</span></div><div class="line"> <span class="number">5</span>:     String myZone = InstanceInfo.getZone(availZones, myInstanceInfo);</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— å¯ç”¨åŒºä¸ serviceUrls çš„æ˜ å°„</span></div><div class="line"> <span class="number">7</span>:     Map&lt;String, List&lt;String&gt;&gt; serviceUrls = EndpointUtils.getServiceUrlsMapFromConfig(clientConfig, myZone, clientConfig.shouldPreferSameZoneEureka());</div><div class="line"> <span class="number">8</span>:     <span class="comment">// æ‹¼è£… EndPoint é›†ç¾¤ç»“æœ</span></div><div class="line"> <span class="number">9</span>:     List&lt;AwsEndpoint&gt; endpoints = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">10</span>:     <span class="keyword">for</span> (String zone : serviceUrls.keySet()) &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">for</span> (String url : serviceUrls.get(zone)) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                 endpoints.add(<span class="keyword">new</span> AwsEndpoint(url, getRegion(), zone));</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</div><div class="line"><span class="number">15</span>:                 logger.warn(<span class="string">"Invalid eureka server URI: &#123;&#125;; removing from the server pool"</span>, url);</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="comment">// æ‰“å°æ—¥å¿—ï¼ŒEndPoint é›†ç¾¤</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">22</span>:         logger.debug(<span class="string">"Config resolved to &#123;&#125;"</span>, endpoints);</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>:     <span class="comment">// æ‰“å°æ—¥å¿—ï¼Œè§£æç»“æœä¸ºç©º</span></div><div class="line"><span class="number">25</span>:     <span class="keyword">if</span> (endpoints.isEmpty()) &#123;</div><div class="line"><span class="number">26</span>:         logger.error(<span class="string">"Cannot resolve to any endpoints from provided configuration: &#123;&#125;"</span>, serviceUrls);</div><div class="line"><span class="number">27</span>:     &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:     <span class="keyword">return</span> endpoints;</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šè·å¾—å¯ç”¨åŒºæ•°ç»„ã€‚é€šè¿‡ <code>eureka.${REGION}.availabilityZones</code> é…ç½®ã€‚</p></li><li><p>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>InstanceInfo#getZone(...)</code> æ–¹æ³•ï¼Œè·å¾—<strong>åº”ç”¨å®ä¾‹è‡ªå·±æ‰€åœ¨çš„å¯ç”¨åŒº</strong>( <code>zone</code> )ã€‚éäºšé©¬é€Š AWS ç¯å¢ƒä¸‹ï¼Œå¯ç”¨åŒºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯<strong>åº”ç”¨å®ä¾‹è‡ªå·±æ‰€åœ¨çš„å¯ç”¨åŒº</strong>ã€‚</p></li><li><p>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>EndpointUtils#getServiceUrlsMapFromConfig(...)</code> æ–¹æ³•ï¼Œè·å¾—å¯ç”¨åŒºä¸ <code>serviceUrls</code> çš„æ˜ å°„ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EndpointUtils.java</span></div><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; getServiceUrlsMapFromConfig(EurekaClientConfig clientConfig, String instanceZone, <span class="keyword">boolean</span> preferSameZone) &#123;</div><div class="line">  <span class="number">2</span>:     Map&lt;String, List&lt;String&gt;&gt; orderedUrls = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(); <span class="comment">// keyï¼šzoneï¼›valueï¼šserviceUrls</span></div><div class="line">  <span class="number">3</span>:     <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çš„ åœ°åŒº( region )</span></div><div class="line">  <span class="number">4</span>:     String region = getRegion(clientConfig);</div><div class="line">  <span class="number">5</span>:     <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çš„ å¯ç”¨åŒº</span></div><div class="line">  <span class="number">6</span>:     String[] availZones = clientConfig.getAvailabilityZones(clientConfig.getRegion());</div><div class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (availZones == <span class="keyword">null</span> || availZones.length == <span class="number">0</span>) &#123;</div><div class="line">  <span class="number">8</span>:         availZones = <span class="keyword">new</span> String[<span class="number">1</span>];</div><div class="line">  <span class="number">9</span>:         availZones[<span class="number">0</span>] = DEFAULT_ZONE;</div><div class="line"> <span class="number">10</span>:     &#125;</div><div class="line"> <span class="number">11</span>:     logger.debug(<span class="string">"The availability zone for the given region &#123;&#125; are &#123;&#125;"</span>, region, Arrays.toString(availZones));</div><div class="line"> <span class="number">12</span>:     <span class="comment">// è·å¾— å¼€å§‹ä½ç½®</span></div><div class="line"> <span class="number">13</span>:     <span class="keyword">int</span> myZoneOffset = getZoneOffset(instanceZone, preferSameZone, availZones);</div><div class="line"> <span class="number">14</span>:     <span class="comment">// å°† å¼€å§‹ä½ç½® çš„ serviceUrls æ·»åŠ åˆ°ç»“æœ</span></div><div class="line"> <span class="number">15</span>:     String zone = availZones[myZoneOffset];</div><div class="line"> <span class="number">16</span>:     List&lt;String&gt; serviceUrls = clientConfig.getEurekaServerServiceUrls(zone);</div><div class="line"> <span class="number">17</span>:     <span class="keyword">if</span> (serviceUrls != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">18</span>:         orderedUrls.put(zone, serviceUrls);</div><div class="line"> <span class="number">19</span>:     &#125;</div><div class="line"> <span class="number">20</span>:     <span class="comment">// ä»å¼€å§‹ä½ç½®é¡ºåºéå†å‰©ä½™çš„ serviceUrls æ·»åŠ åˆ°ç»“æœ</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">int</span> currentOffset = myZoneOffset == (availZones.length - <span class="number">1</span>) ? <span class="number">0</span> : (myZoneOffset + <span class="number">1</span>);</div><div class="line"> <span class="number">22</span>:     <span class="keyword">while</span> (currentOffset != myZoneOffset) &#123;</div><div class="line"> <span class="number">23</span>:         zone = availZones[currentOffset];</div><div class="line"> <span class="number">24</span>:         serviceUrls = clientConfig.getEurekaServerServiceUrls(zone);</div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (serviceUrls != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">26</span>:             orderedUrls.put(zone, serviceUrls);</div><div class="line"> <span class="number">27</span>:         &#125;</div><div class="line"> <span class="number">28</span>:         <span class="keyword">if</span> (currentOffset == (availZones.length - <span class="number">1</span>)) &#123;</div><div class="line"> <span class="number">29</span>:             currentOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">30</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">31</span>:             currentOffset++;</div><div class="line"> <span class="number">32</span>:         &#125;</div><div class="line"> <span class="number">33</span>:     &#125;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="comment">// ä¸ºç©ºï¼ŒæŠ¥é”™</span></div><div class="line"> <span class="number">36</span>:     <span class="keyword">if</span> (orderedUrls.size() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">37</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"DiscoveryClient: invalid serviceUrl specified!"</span>);</div><div class="line"> <span class="number">38</span>:     &#125;</div><div class="line"> <span class="number">39</span>:     <span class="keyword">return</span> orderedUrls;</div><div class="line"> <span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 13 è¡Œ ï¼šè·å¾—<strong>å¼€å§‹ä½ç½®</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getZoneOffset</span><span class="params">(String myZone, <span class="keyword">boolean</span> preferSameZone, String[] availZones)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; availZones.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (myZone != <span class="keyword">null</span> &amp;&amp; (availZones[i].equalsIgnoreCase(myZone.trim()) == preferSameZone)) &#123;</div><div class="line">           <span class="keyword">return</span> i;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   logger.warn(<span class="string">"DISCOVERY: Could not pick a zone based on preferred zone settings. My zone - &#123;&#125;,"</span> +</div><div class="line">           <span class="string">" preferSameZone- &#123;&#125;. Defaulting to "</span> + availZones[<span class="number">0</span>], myZone, preferSameZone);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“æ–¹æ³•å‚æ•° <code>preferSameZone=true</code> ï¼Œå³ <code>eureka.preferSameZone=true</code>( é»˜è®¤å€¼ ï¼š<code>true</code> ) æ—¶ï¼Œ<strong>å¼€å§‹ä½ç½®</strong>ä¸ºå¯ç”¨åŒºæ•°ç»„( <code>availZones</code> )çš„<strong>ç¬¬ä¸€ä¸ª</strong>å’Œåº”ç”¨å®ä¾‹æ‰€åœ¨çš„å¯ç”¨åŒº( <code>myZone</code> )ã€<strong>ç›¸ç­‰</strong>ã€‘å…ƒç´ çš„ä½ç½®ã€‚</li><li>å½“æ–¹æ³•å‚æ•° <code>preferSameZone=false</code> ï¼Œå³ <code>eureka.preferSameZone=false</code>( é»˜è®¤å€¼ ï¼š<code>true</code> ) æ—¶ï¼Œ<strong>å¼€å§‹ä½ç½®</strong>ä¸ºå¯ç”¨åŒºæ•°ç»„( <code>availZones</code> )çš„<strong>ç¬¬ä¸€ä¸ª</strong>å’Œåº”ç”¨å®ä¾‹æ‰€åœ¨çš„å¯ç”¨åŒº( <code>myZone</code> )ã€<strong>ä¸ç›¸ç­‰</strong>ã€‘å…ƒç´ çš„ä½ç½®ã€‚</li></ul></li><li><p>ç¬¬ 20 è‡³ 33 è¡Œ ï¼šä»å¼€å§‹ä½ç½®<strong>é¡ºåº</strong>å°†å‰©ä½™çš„å¯ç”¨åŒºçš„ <code>serviceUrls</code> æ·»åŠ åˆ°ç»“æœã€‚<strong>é¡ºåº</strong>ç†è§£å¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_24/04.png" alt=""></p></li></ul></li><li><p>ç¬¬ 9 è‡³ 18 è¡Œ ï¼šæ‹¼è£… EndPoint é›†ç¾¤ç»“æœã€‚</p></li></ul><h2>3.5 ZoneAffinityClusterResolver</h2><p><code>com.netflix.discovery.shared.resolver.aws.ZoneAffinityClusterResolver</code> ï¼Œä½¿ç”¨å¯ç”¨åŒºäº²å’Œçš„é›†ç¾¤è§£æå™¨ã€‚<strong>ç±»å±æ€§</strong>ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZoneAffinityClusterResolver</span> <span class="keyword">implements</span> <span class="title">ClusterResolver</span>&lt;<span class="title">AwsEndpoint</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ZoneAffinityClusterResolver.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å§”æ‰˜çš„è§£æå™¨</span></div><div class="line"><span class="comment">     * ç›®å‰ä»£ç é‡Œä¸º &#123;<span class="doctag">@link</span> ConfigClusterResolver&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClusterResolver&lt;AwsEndpoint&gt; delegate;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹çš„å¯ç”¨åŒº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String myZone;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å¯ç”¨åŒºäº²å’Œ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> zoneAffinity;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZoneAffinityClusterResolver</span><span class="params">(ClusterResolver&lt;AwsEndpoint&gt; delegate, String myZone, <span class="keyword">boolean</span> zoneAffinity)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delegate = delegate;</div><div class="line">        <span class="keyword">this</span>.myZone = myZone;</div><div class="line">        <span class="keyword">this</span>.zoneAffinity = zoneAffinity;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å±æ€§ <code>delegate</code> ï¼Œå§”æ‰˜çš„è§£æå™¨ã€‚ç›®å‰ä»£ç é‡Œä½¿ç”¨çš„æ˜¯ ConfigClusterResolver ã€‚</li><li>å±æ€§ <code>zoneAffinity</code> ï¼Œæ˜¯å¦å¯ç”¨åŒºäº²å’Œã€‚<ul><li><code>true</code> ï¼šEndPoint å¯ç”¨åŒºä¸º<strong>æœ¬åœ°</strong>çš„ä¼˜å…ˆè¢«æ”¾åœ¨å‰é¢ã€‚</li><li><code>false</code> ï¼šEndPoint å¯ç”¨åŒº<strong>éæœ¬åœ°</strong>çš„ä¼˜å…ˆè¢«æ”¾åœ¨å‰é¢ã€‚</li></ul></li></ul><p><code>#getClusterEndpoints(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;AwsEndpoint&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// æ‹†åˆ†æˆ æœ¬åœ°çš„å¯ç”¨åŒºå’Œéæœ¬åœ°çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤</span></div><div class="line"> <span class="number">4</span>:     List&lt;AwsEndpoint&gt;[] parts = ResolverUtils.splitByZone(delegate.getClusterEndpoints(), myZone);</div><div class="line"> <span class="number">5</span>:     List&lt;AwsEndpoint&gt; myZoneEndpoints = parts[<span class="number">0</span>];</div><div class="line"> <span class="number">6</span>:     List&lt;AwsEndpoint&gt; remainingEndpoints = parts[<span class="number">1</span>];</div><div class="line"> <span class="number">7</span>:     <span class="comment">// éšæœºæ‰“ä¹± EndPoint é›†ç¾¤å¹¶è¿›è¡Œåˆå¹¶</span></div><div class="line"> <span class="number">8</span>:     List&lt;AwsEndpoint&gt; randomizedList = randomizeAndMerge(myZoneEndpoints, remainingEndpoints);</div><div class="line"> <span class="number">9</span>:     <span class="comment">// éå¯ç”¨åŒºäº²å’Œï¼Œå°†éæœ¬åœ°çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤æ”¾åœ¨å‰é¢</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">if</span> (!zoneAffinity) &#123;</div><div class="line"><span class="number">11</span>:         Collections.reverse(randomizedList);</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">15</span>:         logger.debug(<span class="string">"Local zone=&#123;&#125;; resolved to: &#123;&#125;"</span>, myZone, randomizedList);</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="keyword">return</span> randomizedList;</div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>ClusterResolver#getClusterEndpoints()</code> æ–¹æ³•ï¼Œè·å¾— EndPoint é›†ç¾¤ã€‚å†è°ƒç”¨ <code>ResolverUtils#splitByZone(...)</code> æ–¹æ³•ï¼Œæ‹†åˆ†æˆ<strong>æœ¬åœ°</strong>å’Œ<strong>éæœ¬åœ°</strong>çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/resolver/ResolverUtils.java#L55" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ã€‚</p></li><li><p>ç¬¬ 8 è¡Œ ï¼šè°ƒç”¨ <code>#randomizeAndMerge(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ†åˆ«</strong>éšæœºæ‰“ä¹±<strong>æ¯ä¸ª</strong> EndPoint é›†ç¾¤ï¼Œå¹¶è¿›è¡Œ<strong>åˆå¹¶</strong>æ•°ç»„ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZoneAffinityClusterResolver.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AwsEndpoint&gt; <span class="title">randomizeAndMerge</span><span class="params">(List&lt;AwsEndpoint&gt; myZoneEndpoints, List&lt;AwsEndpoint&gt; remainingEndpoints)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (myZoneEndpoints.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> ResolverUtils.randomize(remainingEndpoints); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (remainingEndpoints.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> ResolverUtils.randomize(myZoneEndpoints); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   &#125;</div><div class="line">   List&lt;AwsEndpoint&gt; mergedList = ResolverUtils.randomize(myZoneEndpoints); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   mergedList.addAll(ResolverUtils.randomize(remainingEndpoints)); <span class="comment">// æ‰“ä¹±</span></div><div class="line">   <span class="keyword">return</span> mergedList;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ResolverUtils.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends EurekaEndpoint&gt; <span class="function">List&lt;T&gt; <span class="title">randomize</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ•°ç»„å¤§å°ä¸º 0 æˆ–è€… 1 ï¼Œä¸è¿›è¡Œæ‰“ä¹±</span></div><div class="line">   List&lt;T&gt; randomList = <span class="keyword">new</span> ArrayList&lt;&gt;(list);</div><div class="line">   <span class="keyword">if</span> (randomList.size() &lt; <span class="number">2</span>) &#123;</div><div class="line">       <span class="keyword">return</span> randomList;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»¥æœ¬åœ°IPä¸ºéšæœºç§å­ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š</span></div><div class="line">   <span class="comment">// å¤šä¸ªä¸»æœºï¼Œå®ç°å¯¹åŒä¸€ä¸ª EndPoint é›†ç¾¤è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</span></div><div class="line">   <span class="comment">// å•ä¸ªä¸»æœºï¼ŒåŒä¸€ä¸ª EndPoint é›†ç¾¤æŒ‰ç…§å›ºå®šé¡ºåºè®¿é—®ã€‚Eureka-Server ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„æ³¨å†Œä¸­å¿ƒï¼ŒEureka-Client å¯¹åŒä¸€ä¸ª Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œä¿è¯ä¸¤è€…ä¹‹é—´å¢é‡åŒæ­¥çš„ä¸€è‡´æ€§ã€‚</span></div><div class="line">   Random random = <span class="keyword">new</span> Random(LOCAL_IPV4_ADDRESS.hashCode());</div><div class="line">   <span class="keyword">int</span> last = randomList.size() - <span class="number">1</span>;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; last; i++) &#123;</div><div class="line">       <span class="keyword">int</span> pos = random.nextInt(randomList.size() - i);</div><div class="line">       <span class="keyword">if</span> (pos != i) &#123;</div><div class="line">           Collections.swap(randomList, i, pos);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> randomList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„ï¼Œ<code>ResolverUtils#randomize(...)</code> ä½¿ç”¨ä»¥æœ¬æœºIPä¸ºéšæœºç§å­</strong>ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š<ul><li>å¤šä¸ªä¸»æœºï¼Œå®ç°å¯¹åŒä¸€ä¸ª EndPoint é›†ç¾¤è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</li><li>å•ä¸ªä¸»æœºï¼ŒåŒä¸€ä¸ª EndPoint é›†ç¾¤æŒ‰ç…§å›ºå®šé¡ºåºè®¿é—®ã€‚Eureka-Server ä¸æ˜¯å¼ºä¸€è‡´æ€§çš„æ³¨å†Œä¸­å¿ƒï¼ŒEureka-Client å¯¹åŒä¸€ä¸ª Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œä¿è¯ä¸¤è€…ä¹‹é—´å¢é‡åŒæ­¥çš„ä¸€è‡´æ€§ã€‚</li></ul></li></ul></li><li><p>ç¬¬ 10 è‡³ 12 è¡Œ ï¼šéå¯ç”¨åŒºäº²å’Œï¼Œå°†éæœ¬åœ°çš„å¯ç”¨åŒºçš„ EndPoint é›†ç¾¤æ”¾åœ¨å‰é¢ã€‚</p></li></ul><h2>3.6 AsyncResolver</h2><p><code>com.netflix.discovery.shared.resolver.AsyncResolver</code> ï¼Œ<strong>å¼‚æ­¥æ‰§è¡Œ</strong>è§£æçš„é›†ç¾¤è§£æå™¨ã€‚AsyncResolver å±æ€§è¾ƒå¤šï¼Œè€Œä¸”å¤æ‚çš„å¤šï¼Œæˆ‘ä»¬æ‹†åˆ†åˆ°å…·ä½“æ–¹æ³•é‡Œåˆ†äº«ã€‚</p><h3>3.6.1 å®šæ—¶ä»»åŠ¡</h3><p>AsyncResolver å†…ç½®å®šæ—¶ä»»åŠ¡ï¼Œ<strong>å®šæ—¶</strong>åˆ·æ–° EndPoint é›†ç¾¤è§£æç»“æœã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦åˆ·æ–°</strong>ï¼Ÿä¾‹å¦‚ï¼ŒEureka-Server çš„ <code>serviceUrls</code> åŸºäº DNS é…ç½®ã€‚</p><p><strong>å®šæ—¶ä»»åŠ¡ä»£ç å¦‚ä¸‹</strong>ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ˜¯å¦å·²ç»è°ƒåº¦å®šæ—¶ä»»åŠ¡ &#123;<span class="doctag">@link</span> #updateTask&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean scheduled = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å§”æ‰˜çš„è§£æå™¨</span></div><div class="line"><span class="comment">* ç›®å‰ä»£ç ä¸º &#123;<span class="doctag">@link</span> com.netflix.discovery.shared.resolver.aws.ZoneAffinityClusterResolver&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClusterResolver&lt;T&gt; delegate;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å®šæ—¶æœåŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executorService;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* çº¿ç¨‹æ± æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor threadPoolExecutor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åå°ä»»åŠ¡</span></div><div class="line"><span class="comment">* å®šæ—¶è§£æ EndPoint é›†ç¾¤</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TimedSupervisorTask backgroundTask;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è§£æ EndPoint é›†ç¾¤ç»“æœ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;List&lt;T&gt;&gt; resultsRef;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å®šæ—¶è§£æ EndPoint é›†ç¾¤çš„é¢‘ç‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> refreshIntervalMs;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* é¢„çƒ­è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> warmUpTimeoutMs;</div><div class="line"></div><div class="line"><span class="comment">// Metric timestamp, tracking last time when data were effectively changed.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastLoadTimestamp = -<span class="number">1</span>;</div><div class="line"></div><div class="line">AsyncResolver(String name,</div><div class="line">             ClusterResolver&lt;T&gt; delegate,</div><div class="line">             List&lt;T&gt; initialValue,</div><div class="line">             <span class="keyword">int</span> executorThreadPoolSize,</div><div class="line">             <span class="keyword">int</span> refreshIntervalMs,</div><div class="line">             <span class="keyword">int</span> warmUpTimeoutMs) &#123;</div><div class="line">   <span class="keyword">this</span>.name = name;</div><div class="line">   <span class="keyword">this</span>.delegate = delegate;</div><div class="line">   <span class="keyword">this</span>.refreshIntervalMs = refreshIntervalMs;</div><div class="line">   <span class="keyword">this</span>.warmUpTimeoutMs = warmUpTimeoutMs;</div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– å®šæ—¶æœåŠ¡</span></div><div class="line">   <span class="keyword">this</span>.executorService = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="comment">// çº¿ç¨‹å¤§å°=1</span></div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                   .setNameFormat(<span class="string">"AsyncResolver-"</span> + name + <span class="string">"-%d"</span>)</div><div class="line">                   .setDaemon(<span class="keyword">true</span>)</div><div class="line">                   .build());</div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– çº¿ç¨‹æ± æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">this</span>.threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">           <span class="number">1</span>, <span class="comment">// çº¿ç¨‹å¤§å°=1</span></div><div class="line">           executorThreadPoolSize, <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">           <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),  <span class="comment">// use direct handoff</span></div><div class="line">           <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                   .setNameFormat(<span class="string">"AsyncResolver-"</span> + name + <span class="string">"-executor-%d"</span>)</div><div class="line">                   .setDaemon(<span class="keyword">true</span>)</div><div class="line">                   .build()</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– åå°ä»»åŠ¡</span></div><div class="line">   <span class="keyword">this</span>.backgroundTask = <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">           <span class="keyword">this</span>.getClass().getSimpleName(),</div><div class="line">           executorService,</div><div class="line">           threadPoolExecutor,</div><div class="line">           refreshIntervalMs,</div><div class="line">           TimeUnit.MILLISECONDS,</div><div class="line">           <span class="number">5</span>,</div><div class="line">           updateTask</div><div class="line">   );</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.resultsRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(initialValue);</div><div class="line">   Monitors.registerObject(name, <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>backgroundTask</code> ï¼Œåå°ä»»åŠ¡ï¼Œå®šæ—¶è§£æ EndPoint é›†ç¾¤ã€‚<ul><li><p>TimedSupervisorTask ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹ã€Œ2.3 TimedSupervisorTaskã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>updateTask</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable updateTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            List&lt;T&gt; newList = delegate.getClusterEndpoints(); <span class="comment">// è°ƒç”¨ å§”æ‰˜çš„è§£æå™¨ è§£æ EndPoint é›†ç¾¤</span></div><div class="line">            <span class="keyword">if</span> (newList != <span class="keyword">null</span>) &#123;</div><div class="line">                resultsRef.getAndSet(newList);</div><div class="line">                lastLoadTimestamp = System.currentTimeMillis();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                logger.warn(<span class="string">"Delegate returned null list of cluster endpoints"</span>);</div><div class="line">            &#125;</div><div class="line">            logger.debug(<span class="string">"Resolved to &#123;&#125;"</span>, newList);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.warn(<span class="string">"Failed to retrieve cluster endpoints from the delegate"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><ul><li><code>delegate</code> ï¼Œå§”æ‰˜çš„è§£æå™¨ï¼Œç›®å‰ä»£ç ä¸º ZoneAffinityClusterResolverã€‚</li></ul></li><li><p>åå°ä»»åŠ¡çš„<strong>å‘èµ·</strong>åœ¨ <code>#getClusterEndpoints()</code> æ–¹æ³•ï¼Œåœ¨ <a href="#">ã€Œ3.6.2 è§£æ EndPoint é›†ç¾¤ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h3>3.6.2 è§£æ EndPoint é›†ç¾¤</h3><p>è°ƒç”¨ <code>#getClusterEndpoints()</code> æ–¹æ³•ï¼Œè§£æ EndPoint é›†ç¾¤ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getClusterEndpoints</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> delay = refreshIntervalMs;</div><div class="line"> <span class="number">4</span>:     <span class="comment">// è‹¥æœªé¢„çƒ­è§£æ EndPoint é›†ç¾¤ç»“æœï¼Œè¿›è¡Œé¢„çƒ­</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (warmedUp.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (!doWarmUp()) &#123;</div><div class="line"> <span class="number">7</span>:             delay = <span class="number">0</span>; <span class="comment">// é¢„çƒ­å¤±è´¥ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡çš„ç¬¬ä¸€æ¬¡å»¶è¿Ÿ</span></div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>:     <span class="comment">// è‹¥æœªè°ƒåº¦å®šæ—¶ä»»åŠ¡ï¼Œè¿›è¡Œè°ƒåº¦</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (scheduled.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line"><span class="number">12</span>:         scheduleTask(delay);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>:     <span class="comment">// è¿”å› EndPoint é›†ç¾¤</span></div><div class="line"><span class="number">15</span>:     <span class="keyword">return</span> resultsRef.get();</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è‡³ 9 è¡Œ ï¼š<strong>è‹¥æœªé¢„çƒ­è§£æ EndPoint é›†ç¾¤ç»“æœ</strong>ï¼Œè°ƒç”¨ <code>#doWarmUp()</code> æ–¹æ³•ï¼Œè¿›è¡Œé¢„çƒ­ã€‚è‹¥é¢„çƒ­å¤±è´¥ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡çš„ç¬¬ä¸€æ¬¡å»¶è¿Ÿã€‚<code>#doWarmUp()</code> æ–¹æ³•å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">doWarmUp</span><span class="params">()</span> </span>&#123;</div><div class="line">   Future future = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       future = threadPoolExecutor.submit(updateTask);</div><div class="line">       future.get(warmUpTimeoutMs, TimeUnit.MILLISECONDS);  <span class="comment">// block until done or timeout</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.warn(<span class="string">"Best effort warm up failed"</span>, e);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (future != <span class="keyword">null</span>) &#123;</div><div class="line">           future.cancel(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>updateTask</code> ï¼Œè§£æ EndPoint é›†ç¾¤ã€‚</li></ul></li><li><p>ç¬¬ 10 è‡³ 13 è¡Œ ï¼š <strong>è‹¥æœªè°ƒåº¦å®šæ—¶ä»»åŠ¡ï¼Œè¿›è¡Œè°ƒåº¦</strong>ï¼Œè°ƒç”¨ <code>#scheduleTask()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTask</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</div><div class="line">   executorService.schedule(backgroundTask, delay, TimeUnit.MILLISECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 15 è¡Œ ï¼šè¿”å› EndPoint é›†ç¾¤ã€‚<strong>å½“ç¬¬ä¸€æ¬¡é¢„çƒ­å¤±è´¥ï¼Œä¼šè¿”å›ç©ºï¼Œç›´åˆ°å®šæ—¶ä»»åŠ¡è·å¾—åˆ°ç»“æœ</strong>ã€‚</p></li></ul><h1>4. åˆå§‹åŒ–è§£æå™¨</h1><p>Eureka-Client åœ¨åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>DiscoveryClient#scheduleServerEndpointTask()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– AsyncResolver è§£æå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleServerEndpointTask</span><span class="params">(EurekaTransport eurekaTransport,</span></span></div><div class="line"><span class="function"><span class="params">                                            AbstractDiscoveryClientOptionalArgs args)</span> </span>&#123;</div><div class="line">                                            </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">   <span class="comment">// åˆ›å»º EndPoint è§£æå™¨</span></div><div class="line">   eurekaTransport.bootstrapResolver = EurekaHttpClients.newBootstrapResolver(</div><div class="line">           clientConfig,</div><div class="line">           transportConfig,</div><div class="line">           eurekaTransport.transportClientFactory,</div><div class="line">           applicationInfoManager.getInfo(),</div><div class="line">           applicationsSource</div><div class="line">   );</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>EurekaHttpClients#newBootstrapResolver(...)</code> æ–¹æ³•ï¼Œåˆ›å»º EndPoint è§£æå™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String COMPOSITE_BOOTSTRAP_STRATEGY = <span class="string">"composite"</span>;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClosableResolver&lt;AwsEndpoint&gt; <span class="title">newBootstrapResolver</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">4</span>:         <span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">5</span>:         <span class="keyword">final</span> EurekaTransportConfig transportConfig,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">6</span>:         <span class="keyword">final</span> TransportClientFactory transportClientFactory,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">7</span>:         <span class="keyword">final</span> InstanceInfo myInstanceInfo,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">8</span>:         <span class="keyword">final</span> ApplicationsResolver.ApplicationsSource applicationsSource)</span></span></div><div class="line"><span class="function"> 9: </span>&#123;</div><div class="line"><span class="number">10</span>:     <span class="keyword">if</span> (COMPOSITE_BOOTSTRAP_STRATEGY.equals(transportConfig.getBootstrapResolverStrategy())) &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">return</span> compositeBootstrapResolver(</div><div class="line"><span class="number">13</span>:                     clientConfig,</div><div class="line"><span class="number">14</span>:                     transportConfig,</div><div class="line"><span class="number">15</span>:                     transportClientFactory,</div><div class="line"><span class="number">16</span>:                     myInstanceInfo,</div><div class="line"><span class="number">17</span>:                     applicationsSource</div><div class="line"><span class="number">18</span>:             );</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             logger.warn(<span class="string">"Cannot create a composite bootstrap resolver if registry fetch is disabled."</span> +</div><div class="line"><span class="number">21</span>:                     <span class="string">" Falling back to using a default bootstrap resolver."</span>);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:     <span class="comment">// if all else fails, return the default</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> defaultBootstrapResolver(clientConfig, myInstanceInfo);</div><div class="line"><span class="number">27</span>: &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">30:  * <span class="doctag">@return</span> a bootstrap resolver that resolves eureka server endpoints based on either DNS or static config,</span></div><div class="line"><span class="comment">31:  *         depending on configuration for one or the other. This resolver will warm up at the start.</span></div><div class="line"><span class="comment">32:  */</span></div><div class="line"><span class="number">33</span>: <span class="function"><span class="keyword">static</span> ClosableResolver&lt;AwsEndpoint&gt; <span class="title">defaultBootstrapResolver</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">34</span>:                                                               <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span> </span>&#123;</div><div class="line"><span class="number">35</span>:     <span class="comment">// è·å¾— å¯ç”¨åŒºé›†åˆ</span></div><div class="line"><span class="number">36</span>:     String[] availZones = clientConfig.getAvailabilityZones(clientConfig.getRegion());</div><div class="line"><span class="number">37</span>:     <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çš„ å¯ç”¨åŒº</span></div><div class="line"><span class="number">38</span>:     String myZone = InstanceInfo.getZone(availZones, myInstanceInfo);</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="comment">// åˆ›å»º ZoneAffinityClusterResolver</span></div><div class="line"><span class="number">41</span>:     ClusterResolver&lt;AwsEndpoint&gt; delegateResolver = <span class="keyword">new</span> ZoneAffinityClusterResolver(</div><div class="line"><span class="number">42</span>:             <span class="keyword">new</span> ConfigClusterResolver(clientConfig, myInstanceInfo),</div><div class="line"><span class="number">43</span>:             myZone,</div><div class="line"><span class="number">44</span>:             <span class="keyword">true</span></div><div class="line"><span class="number">45</span>:     );</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="comment">// ç¬¬ä¸€æ¬¡ EndPoint è§£æ</span></div><div class="line"><span class="number">48</span>:     List&lt;AwsEndpoint&gt; initialValue = delegateResolver.getClusterEndpoints();</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:     <span class="comment">// è§£æä¸åˆ° Eureka-Server EndPoint ï¼Œå¿«é€Ÿå¤±è´¥</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">if</span> (initialValue.isEmpty()) &#123;</div><div class="line"><span class="number">52</span>:         String msg = <span class="string">"Initial resolution of Eureka server endpoints failed. Check ConfigClusterResolver logs for more info"</span>;</div><div class="line"><span class="number">53</span>:         logger.error(msg);</div><div class="line"><span class="number">54</span>:         failFastOnInitCheck(clientConfig, msg);</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="comment">// åˆ›å»º AsyncResolver</span></div><div class="line"><span class="number">58</span>:     <span class="keyword">return</span> <span class="keyword">new</span> AsyncResolver&lt;&gt;(</div><div class="line"><span class="number">59</span>:             EurekaClientNames.BOOTSTRAP,</div><div class="line"><span class="number">60</span>:             delegateResolver,</div><div class="line"><span class="number">61</span>:             initialValue,</div><div class="line"><span class="number">62</span>:             <span class="number">1</span>,</div><div class="line"><span class="number">63</span>:             clientConfig.getEurekaServiceUrlPollIntervalSeconds() * <span class="number">1000</span></div><div class="line"><span class="number">64</span>:     );</div><div class="line"><span class="number">65</span>: &#125;</div></pre></td></tr></table></figure></p></li></ul><pre><code>* ç¬¬ 10 è‡³ 23 è¡Œ ï¼šç»„åˆè§£æå™¨ï¼Œç”¨äº Eureka 1.x å¯¹ Eureka 2.x çš„å…¼å®¹é…ç½®ï¼Œæš‚æ—¶ä¸éœ€è¦äº†è§£ã€‚TODO[0028]å†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤* ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ `#defaultBootstrapResolver()` æ–¹æ³•ï¼Œåˆ›å»ºé»˜è®¤çš„è§£æå™¨ AsyncResolver ã€‚* ç¬¬ 40 è‡³ 45 è¡Œ ï¼šåˆ›å»º ZoneAffinityClusterResolver ã€‚åœ¨ ZoneAffinityClusterResolver æ„é€ æ–¹æ³•çš„å‚æ•°ï¼Œæˆ‘ä»¬çœ‹åˆ°åˆ›å»º ConfigClusterResolver ä½œä¸º `delegate` å‚æ•°ã€‚* ç¬¬ 48 è¡Œ ï¼šè°ƒç”¨ `ZoneAffinityClusterResolver#getClusterEndpoints()` æ–¹æ³•ï¼Œ**ç¬¬ä¸€æ¬¡ Eureka-Server EndPoint é›†ç¾¤è§£æ**ã€‚* ç¬¬ 51 è‡³ 55 è¡Œ ï¼šè§£æä¸åˆ° Eureka-Server EndPoint é›†ç¾¤æ—¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®( `eureka.experimental.clientTransportFailFastOnInit=true` )ï¼Œä½¿ Eureka-Client åˆå§‹åŒ–å¤±è´¥ã€‚`#failFastOnInitCheck(...)` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š    <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// potential future feature, guarding with experimental flag for now</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">failFastOnInitCheck</span><span class="params">(EurekaClientConfig clientConfig, String msg)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="string">"true"</span>.equals(clientConfig.getExperimental(<span class="string">"clientTransportFailFastOnInit"</span>))) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>    * x</code></pre><ul><li><p>ç¬¬ 58 è‡³ 64 è¡Œ ï¼šåˆ›å»º AsyncResolver ã€‚ä»ä»£ç ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>AsyncResolver.resultsRef</code> å±æ€§ä¸€å¼€å§‹å·²ç»ç”¨ <code>initialValue</code> ä¼ é€’ç»™ AsyncResolver æ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncResolver</span><span class="params">(String name,</span></span></div><div class="line"><span class="function"><span class="params">                      ClusterResolver&lt;T&gt; delegate,</span></span></div><div class="line"><span class="function"><span class="params">                      List&lt;T&gt; initialValues,</span></span></div><div class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> executorThreadPoolSize,</span></span></div><div class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> refreshIntervalMs)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(</div><div class="line">             name,</div><div class="line">             delegate,</div><div class="line">             initialValues,</div><div class="line">             executorThreadPoolSize,</div><div class="line">             refreshIntervalMs,</div><div class="line">             <span class="number">0</span></div><div class="line">     );</div><div class="line">    </div><div class="line">     <span class="comment">// è®¾ç½®å·²ç»é¢„çƒ­</span></div><div class="line">     warmedUp.set(<span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul><h1>666. å½©è›‹</h1><p>T T  ä¸€å¼€å§‹çœ‹è§£æå™¨ï¼Œæ²¡ååº”è¿‡æ¥æ˜¯å§”æ‰˜è®¾è®¡æ¨¡å¼ï¼Œä¸€è„¸æ‡µé€¼+ä¸€è„¸æ‡µé€¼+ä¸€è„¸æ‡µé€¼ã€‚åé¢ç†é¡ºäº†ï¼Œå‘ç°è¶…çº§å¥ˆæ–¯( Nice ) å•Š ï¼ï¼ï¼ï¼</p><p>èƒ–å‹ï¼Œä½ å­¦ä¼šäº†ä¹ˆï¼Ÿ</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/end-point-and-resolver/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†</title>
    <link href="http://www.iocoder.cn/Eureka/batch-tasks/"/>
    <id>http://www.iocoder.cn/Eureka/batch-tasks/</id>
    <published>2018-07-16T16:00:00.000Z</published>
    <updated>2017-10-17T14:06:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/batch-tasks/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">2. æ•´ä½“æµç¨‹</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">3. ä»»åŠ¡å¤„ç†å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>ä»»åŠ¡æ‰¹å¤„ç†</strong>ã€‚Eureka-Server é›†ç¾¤é€šè¿‡ä»»åŠ¡æ‰¹å¤„ç†åŒæ­¥åº”ç”¨å®ä¾‹æ³¨å†Œå®ä¾‹ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿæ˜¯ä¸º Eureka-Server é›†ç¾¤åŒæ­¥çš„åˆ†äº«åšé“ºå«ã€‚</p><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.eureka.util.batcher</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_17/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_17/02.png" alt=""></p><ul><li>ç´«è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡åˆ†å‘å™¨</li><li>è“è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æ¥æ”¶å™¨</li><li>çº¢è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æ‰§è¡Œå™¨</li><li>ç»¿è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡å¤„ç†å™¨</li><li>é»„è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æŒæœ‰è€…( ä»»åŠ¡ )</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. æ•´ä½“æµç¨‹</h1><p>ä»»åŠ¡æ‰§è¡Œçš„æ•´ä½“æµç¨‹å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_17/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_17/01.png" alt=""></p><ul><li><p>ç»†ç®­å¤´ â€”â€” ä»»åŠ¡æ‰§è¡Œç»å†çš„æ“ä½œ</p></li><li><p>ç²—ç®­å¤´ â€”â€” ä»»åŠ¡é˜Ÿåˆ—æµè½¬çš„æ–¹å‘</p></li><li><p><strong>ä¸åŒäº</strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»»åŠ¡æäº¤äº†<strong>ç«‹å³</strong>åŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œï¼Œä»»åŠ¡çš„æ‰§è¡Œæ‹†åˆ†äº†<strong>ä¸‰å±‚é˜Ÿåˆ—</strong>ï¼š</p><ul><li><p>ç¬¬ä¸€å±‚ï¼Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ï¼Œé‡æ–°å¤„ç†é˜Ÿåˆ—( <code>reprocessQueue</code> )ã€‚</p><ul><li>è“çº¿ï¼šåˆ†å‘å™¨åœ¨æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œè¯·æ±‚åï¼Œæäº¤åˆ°æ¥æ”¶é˜Ÿåˆ—ï¼Œ<strong>ä»»åŠ¡å®é™…æœªæ‰§è¡Œ</strong>ã€‚</li><li>é»„çº¿ï¼šæ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹å¤„ç†ä»»åŠ¡å¤±è´¥ï¼Œå°†ç¬¦åˆæ¡ä»¶( è§ <a href="#">ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> )çš„å¤±è´¥ä»»åŠ¡æäº¤åˆ°é‡æ–°æ‰§è¡Œé˜Ÿåˆ—ã€‚</li></ul></li><li><p>ç¬¬äºŒå±‚ï¼Œå¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )</p><ul><li>ç²‰çº¿ï¼šæ¥æ”¶çº¿ç¨‹( Runner )å°†é‡æ–°æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ¥æ”¶é˜Ÿåˆ—æäº¤åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚</li></ul></li><li><p>ç¬¬ä¸‰å±‚ï¼Œå·¥ä½œé˜Ÿåˆ—( <code>workQueue</code> )</p><ul><li>ç²‰çº¿ï¼šæ¥æ”¶çº¿ç¨‹( Runner )å°†å¾…æ‰§è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡æ ¹æ®å‚æ•°( <code>maxBatchingSize</code> )å°†ä»»åŠ¡åˆå¹¶æˆ<strong>æ‰¹é‡ä»»åŠ¡</strong>ï¼Œè°ƒåº¦( æäº¤ )åˆ°å·¥ä½œé˜Ÿåˆ—ã€‚</li><li>é»„çº¿ï¼šæ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹<strong>æ± </strong>ï¼Œä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¯ä»¥æ‹‰å–ä¸€ä¸ª<strong>æ‰¹é‡ä»»åŠ¡</strong>è¿›è¡Œæ‰§è¡Œã€‚</li></ul></li></ul></li><li><p><strong>ä¸‰å±‚é˜Ÿåˆ—çš„å¥½å¤„</strong>ï¼š</p><ul><li>æ¥æ”¶é˜Ÿåˆ—ï¼Œé¿å…å¤„ç†ä»»åŠ¡çš„é˜»å¡ç­‰å¾…ã€‚</li><li>æ¥æ”¶çº¿ç¨‹( Runner )åˆå¹¶ä»»åŠ¡ï¼Œå°†ç›¸åŒä»»åŠ¡ç¼–å·( <strong>æ˜¯çš„ï¼Œä»»åŠ¡æ˜¯å¸¦æœ‰ç¼–å·çš„</strong> )çš„ä»»åŠ¡åˆå¹¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>Eureka-Server ä¸ºé›†ç¾¤åŒæ­¥æä¾›æ‰¹é‡æ“ä½œ<strong>å¤šä¸ª</strong>åº”ç”¨å®ä¾‹çš„<strong>æ¥å£</strong>ï¼Œä¸€ä¸ª<strong>æ‰¹é‡ä»»åŠ¡</strong>å¯ä»¥ä¸€æ¬¡è°ƒåº¦æ¥å£å®Œæˆï¼Œé¿å…å¤šæ¬¡è°ƒç”¨çš„å¼€é”€ã€‚å½“ç„¶ï¼Œè¿™æ ·åšçš„å‰ææ˜¯åˆå¹¶ä»»åŠ¡ï¼Œè¿™ä¹Ÿå¯¼è‡´ Eureka-Server é›†ç¾¤ä¹‹é—´å¯¹åº”ç”¨å®ä¾‹çš„æ³¨å†Œå’Œä¸‹çº¿å¸¦æ¥æ›´å¤§çš„å»¶è¿Ÿã€‚<strong>æ¯•ç«Ÿï¼ŒEureka æ˜¯åœ¨ CAP ä¹‹é—´ï¼Œé€‰æ‹©äº† AP</strong>ã€‚</li></ul></li></ul><h1>3. ä»»åŠ¡å¤„ç†å™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskProcessor</code> ï¼Œä»»åŠ¡å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskProcessor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * A processed task/task list ends up in one of the following states:</span></div><div class="line"><span class="comment">     * &lt;ul&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> Success&#125; processing finished successfully&lt;/li&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> TransientError&#125; processing failed, but shall be retried later&lt;/li&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> PermanentError&#125; processing failed, and is non recoverable&lt;/li&gt;</span></div><div class="line"><span class="comment">     * &lt;/ul&gt;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">enum</span> ProcessingResult &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æˆåŠŸ</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Success,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æ‹¥æŒ¤é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Congestion,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * ç¬æ—¶é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        TransientError,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æ°¸ä¹…é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        PermanentError</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤„ç†å•ä»»åŠ¡</span></div><div class="line"><span class="comment">     * In non-batched mode a single task is processed at a time.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ProcessingResult <span class="title">process</span><span class="params">(T task)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤„ç†æ‰¹é‡ä»»åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * For batched mode a collection of tasks is run at a time. The result is provided for the aggregated result,</span></div><div class="line"><span class="comment">     * and all tasks are handled in the same way according to what is returned (for example are rescheduled, if the</span></div><div class="line"><span class="comment">     * error is transient).</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ProcessingResult <span class="title">process</span><span class="params">(List&lt;T&gt; tasks)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ProcessingResult ï¼Œå¤„ç†ä»»åŠ¡ç»“æœã€‚<ul><li><code>Success</code> ï¼ŒæˆåŠŸã€‚</li><li><code>Congestion</code> ï¼Œæ‹¥æŒ¤é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«é‡è¯•</strong>ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚è¢«é™æµã€‚</li><li><code>TransientError</code> ï¼Œç¬æ—¶é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«é‡è¯•</strong>ã€‚ä¾‹å¦‚ï¼Œç½‘ç»œè¯·æ±‚è¶…æ—¶ã€‚</li><li><code>PermanentError</code> ï¼Œæ°¸ä¹…é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«ä¸¢å¼ƒ</strong>ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œæ—¶å‘ç”Ÿç¨‹åºå¼‚å¸¸ã€‚</li></ul></li><li><code>#process(task)</code> æ–¹æ³•ï¼Œå¤„ç†å•ä»»åŠ¡ã€‚</li><li><code>#process(tasks)</code> æ–¹æ³•ï¼Œå¤„ç†æ‰¹é‡ä»»åŠ¡ã€‚</li></ul><h1>4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskDispatcher</code> ï¼Œä»»åŠ¡åˆ†å‘å™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskDispatcher</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#process(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç¼–å·ï¼Œä»»åŠ¡ï¼Œä»»åŠ¡è¿‡æœŸæ—¶é—´ç»™ä»»åŠ¡åˆ†å‘å™¨å¤„ç†ã€‚</li></ul><p><code>com.netflix.eureka.util.batcher.TaskDispatchers</code> ï¼Œä»»åŠ¡åˆ†å‘å™¨<strong>å·¥å‚ç±»</strong>ï¼Œç”¨äºåˆ›å»ºä»»åŠ¡åˆ†å‘å™¨ã€‚å…¶å†…éƒ¨æä¾›ä¸¤ç§ä»»åŠ¡åˆ†å‘å™¨çš„å®ç°ï¼š</p><ul><li><strong>æ‰¹é‡ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server é›†ç¾¤æ³¨å†Œä¿¡æ¯çš„åŒæ­¥ä»»åŠ¡ã€‚</li><li><strong>å•ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( Autoscaling Group ) åŒæ­¥çŠ¶æ€ã€‚è™½ç„¶æœ¬ç³»åˆ—æš‚æ—¶å¯¹ AWS ç›¸å…³çš„ä¸åšè§£æï¼Œä»å·¥å…·ç±»çš„è§’åº¦æ¥è¯´ï¼Œæœ¬æ–‡ä¼šå¯¹è¯¥åˆ†å‘å™¨è¿›è¡Œåˆ†äº«ã€‚</li></ul><p><code>com.netflix.eureka.cluster.ReplicationTaskProcessor</code> ï¼Œå®ç° TaskDispatcher ï¼ŒEureka-Server é›†ç¾¤ä»»åŠ¡å¤„ç†å™¨ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/6e1b694898aa2f4c155936420c2ce5850f142742/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>è‡ªå·±ç ”ç©¶ï¼Œæˆ‘ä»¬å°†åœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2>4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</h2><p>è°ƒç”¨ <code>TaskDispatchers#createBatchingTaskDispatcher(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ‰¹é‡ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskDispatchers.java</span></div><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">  2:  * åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment">  3:  *</span></div><div class="line"><span class="comment">  4:  * <span class="doctag">@param</span> id ä»»åŠ¡æ‰§è¡Œå™¨ç¼–å·</span></div><div class="line"><span class="comment">  5:  * <span class="doctag">@param</span> maxBufferSize å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">  6:  * <span class="doctag">@param</span> workloadSize å•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">  7:  * <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">  8:  * <span class="doctag">@param</span> maxBatchingDelay æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">  9:  * <span class="doctag">@param</span> congestionRetryDelayMs è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 10:  * <span class="doctag">@param</span> networkFailureRetryMs ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 11:  * <span class="doctag">@param</span> taskProcessor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment"> 12:  * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment"> 13:  * <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment"> 14:  * <span class="doctag">@return</span> æ‰¹é‡ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment"> 15:  */</span></div><div class="line"> <span class="number">16</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskDispatcher&lt;ID, T&gt; <span class="title">createBatchingTaskDispatcher</span><span class="params">(String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">17</span>:                                                                          <span class="keyword">int</span> maxBufferSize,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">18</span>:                                                                          <span class="keyword">int</span> workloadSize,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">19</span>:                                                                          <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">20</span>:                                                                          <span class="keyword">long</span> maxBatchingDelay,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">21</span>:                                                                          <span class="keyword">long</span> congestionRetryDelayMs,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">22</span>:                                                                          <span class="keyword">long</span> networkFailureRetryMs,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">23</span>:                                                                          TaskProcessor&lt;T&gt; taskProcessor)</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:     <span class="comment">// åˆ›å»º ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"> <span class="number">25</span>:     <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor = <span class="keyword">new</span> AcceptorExecutor&lt;&gt;(</div><div class="line"> <span class="number">26</span>:             id, maxBufferSize, workloadSize, maxBatchingDelay, congestionRetryDelayMs, networkFailureRetryMs</div><div class="line"> <span class="number">27</span>:     );</div><div class="line"> <span class="number">28</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"> <span class="number">29</span>:     <span class="keyword">final</span> TaskExecutors&lt;ID, T&gt; taskExecutor = TaskExecutors.batchExecutors(id, workerCount, taskProcessor, acceptorExecutor);</div><div class="line"> <span class="number">30</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡ä»»åŠ¡åˆ†å‘å™¨</span></div><div class="line"> <span class="number">31</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TaskDispatcher&lt;ID, T&gt;() &#123;</div><div class="line"> <span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line"> <span class="number">34</span>:             acceptorExecutor.process(id, task, expiryTime);</div><div class="line"> <span class="number">35</span>:         &#125;</div><div class="line"> <span class="number">36</span>: </div><div class="line"> <span class="number">37</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">38</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">39</span>:             acceptorExecutor.shutdown();</div><div class="line"> <span class="number">40</span>:             taskExecutor.shutdown();</div><div class="line"> <span class="number">41</span>:         &#125;</div><div class="line"> <span class="number">42</span>:     &#125;;</div><div class="line"> <span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 1 è‡³ 23 è¡Œ ï¼šæ–¹æ³•å‚æ•°ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li><code>workloadSize</code> å‚æ•°ï¼Œå•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡ã€‚</li><li><code>taskProcessor</code> å‚æ•°ï¼Œ<strong>è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨å®ç°</strong>ã€‚</li></ul></li><li>ç¬¬ 24 è‡³ 27 è¡Œ ï¼šåˆ›å»ºä»»åŠ¡<strong>æ¥æ”¶</strong>æ‰§è¡Œå™¨ã€‚åœ¨ <a href="#">ã€Œ5. åˆ›å»ºä»»åŠ¡æ¥æ”¶å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡</strong>ä»»åŠ¡æ‰§è¡Œå™¨ã€‚åœ¨ <a href="#">ã€Œ6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 30 è‡³ 42 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡</strong>ä»»åŠ¡åˆ†å‘å™¨ã€‚<ul><li>ç¬¬ 32 è‡³ 35 è¡Œ ï¼š<code>#process()</code> æ–¹æ³•çš„å®ç°ï¼Œè°ƒç”¨ <code>AcceptorExecutor#process(...)</code> æ–¹æ³•ï¼Œæäº¤ [ ä»»åŠ¡ç¼–å· , ä»»åŠ¡ , ä»»åŠ¡è¿‡æœŸæ—¶é—´ ] ç»™ä»»åŠ¡åˆ†å‘å™¨å¤„ç†ã€‚</li></ul></li></ul><h2>4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</h2><p>è°ƒç”¨ <code>TaskDispatchers#createNonBatchingTaskDispatcher(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> id ä»»åŠ¡æ‰§è¡Œå™¨ç¼–å·</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> maxBufferSize å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> maxBatchingDelay æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> congestionRetryDelayMs è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 9:  * <span class="doctag">@param</span> networkFailureRetryMs ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">10:  * <span class="doctag">@param</span> taskProcessor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">11:  * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">12:  * <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">13:  * <span class="doctag">@return</span> å•ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment">14:  */</span></div><div class="line"><span class="number">15</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskDispatcher&lt;ID, T&gt; <span class="title">createNonBatchingTaskDispatcher</span><span class="params">(String id,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">16</span>:                                                                             <span class="keyword">int</span> maxBufferSize,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">17</span>:                                                                             <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">18</span>:                                                                             <span class="keyword">long</span> maxBatchingDelay,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">19</span>:                                                                             <span class="keyword">long</span> congestionRetryDelayMs,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>:                                                                             <span class="keyword">long</span> networkFailureRetryMs,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">21</span>:                                                                             TaskProcessor&lt;T&gt; taskProcessor)</span> </span>&#123;</div><div class="line"><span class="number">22</span>:     <span class="comment">// åˆ›å»º ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor = <span class="keyword">new</span> AcceptorExecutor&lt;&gt;(</div><div class="line"><span class="number">24</span>:             id, maxBufferSize, <span class="comment">/* workloadSize = 1 */</span><span class="number">1</span>, maxBatchingDelay, congestionRetryDelayMs, networkFailureRetryMs</div><div class="line"><span class="number">25</span>:     );</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> TaskExecutors&lt;ID, T&gt; taskExecutor = TaskExecutors.singleItemExecutors(id, workerCount, taskProcessor, acceptorExecutor);</div><div class="line"><span class="number">27</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TaskDispatcher&lt;ID, T&gt;() &#123;</div><div class="line"><span class="number">28</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">29</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line"><span class="number">30</span>:             acceptorExecutor.process(id, task, expiryTime);</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">34</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">35</span>:             acceptorExecutor.shutdown();</div><div class="line"><span class="number">36</span>:             taskExecutor.shutdown();</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 1 è‡³ 21 è¡Œ ï¼šæ–¹æ³•å‚æ•°ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li><s><code>workloadSize</code> å‚æ•°</s>ï¼Œç›¸æ¯” <code>#createBatchingTaskDispatcher(...)</code> å°‘è¿™ä¸ªå‚æ•°ã€‚<strong>åœ¨ç¬¬ 24 è¡Œï¼Œä½ ä¼šå‘ç°è¯¥å‚æ•°ä¼ é€’ç»™ AcceptorExecutor ä½¿ç”¨ 1 å™¢</strong>ã€‚</li><li><code>taskProcessor</code> å‚æ•°ï¼Œ<strong>è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨å®ç°</strong>ã€‚</li></ul></li><li>ç¬¬ 21 è‡³ 25 è¡Œ ï¼šåˆ›å»ºä»»åŠ¡<strong>æ¥æ”¶</strong>æ‰§è¡Œå™¨ã€‚å’Œ <code>#createBatchingTaskDispatcher(...)</code> åªå·® <code>workloadSize = 1</code> å‚æ•°ã€‚åœ¨ <a href="#">ã€Œ5. åˆ›å»ºä»»åŠ¡æ¥æ”¶å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šåˆ›å»º<strong>å•</strong>ä»»åŠ¡æ‰§è¡Œå™¨ã€‚<strong>å’Œ <code>#createBatchingTaskDispatcher(...)</code> å·®åˆ«å¾ˆå¤§</strong>ã€‚<a href="#">ã€Œ6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 30 è‡³ 42 è¡Œ ï¼šåˆ›å»º<strong>å•</strong>ä»»åŠ¡åˆ†å‘å™¨ã€‚å’Œ <code>#createBatchingTaskDispatcher(...)</code> ä¸€æ ·ã€‚</li></ul><h1>5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</h1><p><code>com.netflix.eureka.util.batcher.AcceptorExecutor</code> ï¼Œä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€‚åˆ›å»ºæ„é€ æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">AcceptorExecutor</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AcceptorExecutor.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:      * å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment"> 7:      * &#123;<span class="doctag">@link</span> #processingOrder&#125;</span></div><div class="line"><span class="comment"> 8:      */</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBufferSize;</div><div class="line"><span class="number">10</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">11:      * å•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">12:      */</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBatchingSize;</div><div class="line"><span class="number">14</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">15:      * æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">16:      */</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> maxBatchingDelay;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">20:      * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">21:      */</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="number">23</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">24:      * æ¥æ”¶ä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">25:      */</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; acceptorQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">28:      * é‡æ–°æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">29:      */</span></div><div class="line"><span class="number">30</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingDeque&lt;TaskHolder&lt;ID, T&gt;&gt; reprocessQueue = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;();</div><div class="line"><span class="number">31</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">32:      * æ¥æ”¶ä»»åŠ¡çº¿ç¨‹</span></div><div class="line"><span class="comment">33:      */</span></div><div class="line"><span class="number">34</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Thread acceptorThread;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">37:      * å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„</span></div><div class="line"><span class="comment">38:      */</span></div><div class="line"><span class="number">39</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ID, TaskHolder&lt;ID, T&gt;&gt; pendingTasks = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="number">40</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">41:      * å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">42:      */</span></div><div class="line"><span class="number">43</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;ID&gt; processingOrder = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">46:      * å•ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">47:      */</span></div><div class="line"><span class="number">48</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Semaphore singleItemWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="number">49</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">50:      * å•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">51:      */</span></div><div class="line"><span class="number">52</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; singleItemWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">55:      * æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">56:      */</span></div><div class="line"><span class="number">57</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Semaphore batchWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="number">58</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">59:      * æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">60:      */</span></div><div class="line"><span class="number">61</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; batchWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">62</span>: </div><div class="line"><span class="number">63</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">64:      * ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></div><div class="line"><span class="comment">65:      */</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">private</span> <span class="keyword">final</span> TrafficShaper trafficShaper;</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:     AcceptorExecutor(String id,</div><div class="line"><span class="number">69</span>:                      <span class="keyword">int</span> maxBufferSize,</div><div class="line"><span class="number">70</span>:                      <span class="keyword">int</span> maxBatchingSize,</div><div class="line"><span class="number">71</span>:                      <span class="keyword">long</span> maxBatchingDelay,</div><div class="line"><span class="number">72</span>:                      <span class="keyword">long</span> congestionRetryDelayMs,</div><div class="line"><span class="number">73</span>:                      <span class="keyword">long</span> networkFailureRetryMs) &#123;</div><div class="line"><span class="number">74</span>:         <span class="keyword">this</span>.maxBufferSize = maxBufferSize;</div><div class="line"><span class="number">75</span>:         <span class="keyword">this</span>.maxBatchingSize = maxBatchingSize;</div><div class="line"><span class="number">76</span>:         <span class="keyword">this</span>.maxBatchingDelay = maxBatchingDelay;</div><div class="line"><span class="number">77</span>: </div><div class="line"><span class="number">78</span>:         <span class="comment">// åˆ›å»º ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></div><div class="line"><span class="number">79</span>:         <span class="keyword">this</span>.trafficShaper = <span class="keyword">new</span> TrafficShaper(congestionRetryDelayMs, networkFailureRetryMs);</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:         <span class="comment">// åˆ›å»º æ¥æ”¶ä»»åŠ¡çº¿ç¨‹</span></div><div class="line"><span class="number">82</span>:         ThreadGroup threadGroup = <span class="keyword">new</span> ThreadGroup(<span class="string">"eurekaTaskExecutors"</span>);</div><div class="line"><span class="number">83</span>:         <span class="keyword">this</span>.acceptorThread = <span class="keyword">new</span> Thread(threadGroup, <span class="keyword">new</span> AcceptorRunner(), <span class="string">"TaskAcceptor-"</span> + id);</div><div class="line"><span class="number">84</span>:         <span class="keyword">this</span>.acceptorThread.setDaemon(<span class="keyword">true</span>);</div><div class="line"><span class="number">85</span>:         <span class="keyword">this</span>.acceptorThread.start();</div><div class="line"><span class="number">86</span>: </div><div class="line"><span class="number">87</span>:         <span class="comment">// TODO ï¼ˆçœç•¥ä»£ç ï¼‰èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line"><span class="number">88</span>:     &#125;</div><div class="line"><span class="number">89</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è‡³ 61 è¡Œ ï¼šå±æ€§ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li>çœ¼å°–å¦‚ä½ ï¼Œä¼šå‘ç° AcceptorExecutor å³å­˜åœ¨å•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>singleItemWorkQueue</code> )ï¼Œåˆå­˜åœ¨æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>batchWorkQueue</code> ) ï¼Œåœ¨ <a href="#">ã€Œ9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘ã€</a> ä¼šè§£ç­”è¿™ä¸ªç–‘æƒ‘ã€‚</li></ul></li><li>ç¬¬ 78 è‡³ 79 è¡Œ ï¼šåˆ›å»ºç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€‚åœ¨ <a href="#">ã€Œ7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 81 è‡³ 85 è¡Œ ï¼š<strong>åˆ›å»ºæ¥æ”¶ä»»åŠ¡çº¿ç¨‹</strong>ã€‚</li></ul><h1>6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskExecutors</code> ï¼Œä»»åŠ¡æ‰§è¡Œå™¨ã€‚<strong>å…¶å†…éƒ¨æä¾›åˆ›å»ºå•ä»»åŠ¡å’Œæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨çš„ä¸¤ç§æ–¹æ³•</strong>ã€‚TaskExecutors æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskExecutors</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TaskExecutors.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å·¥ä½œçº¿ç¨‹æ± </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Thread&gt; workerThreads;</div><div class="line"></div><div class="line">    TaskExecutors(WorkerRunnableFactory&lt;ID, T&gt; workerRunnableFactory, <span class="keyword">int</span> workerCount, AtomicBoolean isShutdown) &#123;</div><div class="line">        <span class="keyword">this</span>.isShutdown = isShutdown;</div><div class="line">        <span class="keyword">this</span>.workerThreads = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»º å·¥ä½œçº¿ç¨‹æ± </span></div><div class="line">        ThreadGroup threadGroup = <span class="keyword">new</span> ThreadGroup(<span class="string">"eurekaTaskExecutors"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; workerCount; i++) &#123;</div><div class="line">            WorkerRunnable&lt;ID, T&gt; runnable = workerRunnableFactory.create(i);</div><div class="line">            Thread workerThread = <span class="keyword">new</span> Thread(threadGroup, runnable, runnable.getWorkerName());</div><div class="line">            workerThreads.add(workerThread);</div><div class="line">            workerThread.setDaemon(<span class="keyword">true</span>);</div><div class="line">            workerThread.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºå·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">WorkerRunnableFactory</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="function">WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>workerThreads</code> å±æ€§ï¼Œå·¥ä½œçº¿ç¨‹<strong>æ± </strong>ã€‚<strong>å·¥ä½œä»»åŠ¡é˜Ÿåˆ—ä¼šè¢«å·¥ä½œçº¿ç¨‹æ± å¹¶å‘æ‹‰å–ï¼Œå¹¶å‘æ‰§è¡Œ</strong>ã€‚</li><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnableFactory</code> ï¼Œåˆ›å»ºå·¥ä½œçº¿ç¨‹å·¥å‚<strong>æ¥å£</strong>ã€‚å•ä»»åŠ¡å’Œæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹å®ç°ä¸åŒï¼Œé€šè¿‡è‡ªå®šä¹‰å·¥å‚å®ç°ç±»åˆ›å»ºã€‚</li></ul><h2>6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</h2><p>è°ƒç”¨ <code>TaskExecutors#batchExecutors(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> name ä»»åŠ¡æ‰§è¡Œå™¨å</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> processor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> acceptorExecutor æ¥æ”¶ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskExecutors&lt;ID, T&gt; <span class="title">batchExecutors</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics = <span class="keyword">new</span> TaskExecutorMetrics(name);</div><div class="line">   <span class="comment">// åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutors&lt;&gt;(<span class="keyword">new</span> WorkerRunnableFactory&lt;ID, T&gt;() &#123; <span class="comment">// æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> BatchWorkerRunnable&lt;&gt;(<span class="string">"TaskBatchingWorker-"</span> + name + <span class="string">'-'</span> + idx <span class="comment">/* çº¿ç¨‹å */</span>, isShutdown, metrics, processor, acceptorExecutor);</div><div class="line">       &#125;</div><div class="line">   &#125;, workerCount, isShutdown);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable.BatchWorkerRunnable</code> ï¼Œæ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹ã€‚</li></ul><h2>6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</h2><p>è°ƒç”¨ <code>TaskExecutors#singleItemExecutors(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> name ä»»åŠ¡æ‰§è¡Œå™¨å</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> processor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> acceptorExecutor æ¥æ”¶ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskExecutors&lt;ID, T&gt; <span class="title">singleItemExecutors</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics = <span class="keyword">new</span> TaskExecutorMetrics(name);</div><div class="line">   <span class="comment">// åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutors&lt;&gt;(<span class="keyword">new</span> WorkerRunnableFactory&lt;ID, T&gt;() &#123; <span class="comment">// å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SingleTaskWorkerRunnable&lt;&gt;(<span class="string">"TaskNonBatchingWorker-"</span> + name + <span class="string">'-'</span> + idx <span class="comment">/* çº¿ç¨‹å */</span>, isShutdown, metrics, processor, acceptorExecutor);</div><div class="line">       &#125;</div><div class="line">   &#125;, workerCount, isShutdown);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable.SingleTaskWorkerRunnable</code> ï¼Œå•ä»»åŠ¡å·¥ä½œçº¿ç¨‹ã€‚</li></ul><h2>6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</h2><p><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable</code> ï¼Œä»»åŠ¡å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»ã€‚BatchWorkerRunnable å’Œ SingleTaskWorkerRunnable éƒ½å®ç°è¯¥ç±»ï¼Œå·®å¼‚åœ¨ <code>#run()</code> çš„è‡ªå®šä¹‰å®ç°ã€‚WorkerRunnable å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * çº¿ç¨‹å</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> String workerName;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown;</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; taskDispatcher;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ„é€ æ–¹æ³•å’Œ getting æ–¹æ³•ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</h1><p><code>com.netflix.eureka.util.batcher.TrafficShaper</code> ï¼Œç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€‚å½“ä»»åŠ¡æ‰§è¡Œå‘ç”Ÿè¯·æ±‚é™æµï¼Œæˆ–æ˜¯è¯·æ±‚ç½‘ç»œå¤±è´¥çš„æƒ…å†µï¼Œåˆ™å»¶æ—¶ AcceptorRunner å°†ä»»åŠ¡æäº¤åˆ°å·¥ä½œä»»åŠ¡é˜Ÿåˆ—ï¼Œä»è€Œé¿å…ä»»åŠ¡å¾ˆå¿«å»æ‰§è¡Œï¼Œå†æ¬¡å‘ç”Ÿä¸Šè¿°æƒ…å†µã€‚TrafficShaper å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrafficShaper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Upper bound on delay provided by configuration.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_DELAY = <span class="number">30</span> * <span class="number">1000</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> congestionRetryDelayMs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> networkFailureRetryMs;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åè¯·æ±‚é™æµæ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastCongestionError;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åç½‘ç»œå¤±è´¥æ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastNetworkFailure;</div><div class="line"></div><div class="line">    TrafficShaper(<span class="keyword">long</span> congestionRetryDelayMs, <span class="keyword">long</span> networkFailureRetryMs) &#123;</div><div class="line">        <span class="keyword">this</span>.congestionRetryDelayMs = Math.min(MAX_DELAY, congestionRetryDelayMs);</div><div class="line">        <span class="keyword">this</span>.networkFailureRetryMs = Math.min(MAX_DELAY, networkFailureRetryMs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerFailure</span><span class="params">(ProcessingResult processingResult)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (processingResult == ProcessingResult.Congestion) &#123;</div><div class="line">            lastCongestionError = System.currentTimeMillis();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processingResult == ProcessingResult.TransientError) &#123;</div><div class="line">            lastNetworkFailure = System.currentTimeMillis();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¡ç®—æäº¤å»¶è¿Ÿï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å»¶è¿Ÿ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">long</span> <span class="title">transmissionDelay</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// æ— å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastCongestionError == -<span class="number">1</span> &amp;&amp; lastNetworkFailure == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// è®¡ç®—æœ€åè¯·æ±‚é™æµå¸¦æ¥çš„å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastCongestionError != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">long</span> congestionDelay = now - lastCongestionError;</div><div class="line">            <span class="keyword">if</span> (congestionDelay &gt;= <span class="number">0</span> &amp;&amp; congestionDelay &lt; congestionRetryDelayMs) &#123; <span class="comment">// èŒƒå›´å†…</span></div><div class="line">                <span class="keyword">return</span> congestionRetryDelayMs - congestionDelay; <span class="comment">// è¡¥å……å»¶è¿Ÿ</span></div><div class="line">            &#125;</div><div class="line">            lastCongestionError = -<span class="number">1</span>; <span class="comment">// é‡ç½®æ—¶é—´æˆ³</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// è®¡ç®—æœ€åç½‘ç»œå¤±è´¥å¸¦æ¥çš„å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastNetworkFailure != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">long</span> failureDelay = now - lastNetworkFailure;</div><div class="line">            <span class="keyword">if</span> (failureDelay &gt;= <span class="number">0</span> &amp;&amp; failureDelay &lt; networkFailureRetryMs) &#123; <span class="comment">// èŒƒå›´å†…</span></div><div class="line">                <span class="keyword">return</span> networkFailureRetryMs - failureDelay; <span class="comment">// è¡¥å……å»¶è¿Ÿ</span></div><div class="line">            &#125;</div><div class="line">            lastNetworkFailure = -<span class="number">1</span>; <span class="comment">// é‡ç½®æ—¶é—´æˆ³</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// æ— å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#registerFailure(...)</code> ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œæäº¤ä»»åŠ¡ç»“æœç»™ TrafficShaper ï¼Œè®°å½•å‘ç”Ÿæ—¶é—´ã€‚åœ¨ <a href="#">ã€Œ10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘ã€</a> ä¼šçœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li><li><code>#transmissionDelay(...)</code> ï¼Œè®¡ç®—æäº¤å»¶è¿Ÿï¼Œå•ä½ï¼šæ¯«ç§’ã€‚<a href="#">ã€Œ9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘ã€</a> ä¼šçœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li></ul><h1>8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</h1><p>è°ƒç”¨ <code>AcceptorExecutor#process(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡åˆ°æ¥æ”¶ä»»åŠ¡é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AcceptorExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line">   acceptorQueue.add(<span class="keyword">new</span> TaskHolder&lt;ID, T&gt;(id, task, expiryTime));</div><div class="line">   acceptedTasks++;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.eureka.util.batcher.TaskHolder</code> ï¼Œä»»åŠ¡æŒæœ‰è€…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskHolder</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ID id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T task;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡è¿‡æœŸæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expiryTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æäº¤æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> submitTimestamp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</h1><p>åå°çº¿ç¨‹æ‰§è¡Œ <code>AcceptorRunner#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> scheduleTime = <span class="number">0</span>;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:             <span class="comment">// å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )</span></div><div class="line"> <span class="number">7</span>:             drainInputQueues();</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:             <span class="comment">// å¾…æ‰§è¡Œä»»åŠ¡æ•°é‡</span></div><div class="line"><span class="number">10</span>:             <span class="keyword">int</span> totalItems = processingOrder.size();</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:             <span class="comment">// è®¡ç®—è°ƒåº¦æ—¶é—´</span></div><div class="line"><span class="number">13</span>:             <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (scheduleTime &lt; now) &#123;</div><div class="line"><span class="number">15</span>:                 scheduleTime = now + trafficShaper.transmissionDelay();</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:             <span class="comment">// è°ƒåº¦</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (scheduleTime &lt;= now) &#123;</div><div class="line"><span class="number">20</span>:                 <span class="comment">// è°ƒåº¦æ‰¹é‡ä»»åŠ¡</span></div><div class="line"><span class="number">21</span>:                 assignBatchWork();</div><div class="line"><span class="number">22</span>:                 <span class="comment">// è°ƒåº¦å•ä»»åŠ¡</span></div><div class="line"><span class="number">23</span>:                 assignSingleItemWork();</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:             <span class="comment">// 1ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨æ— ä»»åŠ¡è¯·æ±‚ï¼Œæ­£åœ¨å¿™ç¢Œå¤„ç†ä¹‹å‰çš„ä»»åŠ¡ï¼›æˆ–è€… 2ï¼‰ä»»åŠ¡å»¶è¿Ÿè°ƒåº¦ã€‚ç¡çœ  10 ç§’ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</span></div><div class="line"><span class="number">27</span>:             <span class="comment">// If no worker is requesting data or there is a delay injected by the traffic shaper,</span></div><div class="line"><span class="number">28</span>:             <span class="comment">// sleep for some time to avoid tight loop.</span></div><div class="line"><span class="number">29</span>:             <span class="keyword">if</span> (totalItems == processingOrder.size()) &#123;</div><div class="line"><span class="number">30</span>:                 Thread.sleep(<span class="number">10</span>);</div><div class="line"><span class="number">31</span>:             &#125;</div><div class="line"><span class="number">32</span>:         &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line"><span class="number">33</span>:             <span class="comment">// Ignore</span></div><div class="line"><span class="number">34</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">35</span>:             <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line"><span class="number">36</span>:             logger.warn(<span class="string">"Discovery AcceptorThread error"</span>, e);</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šæ— é™å¾ªç¯æ‰§è¡Œè°ƒåº¦ï¼Œç›´åˆ°å…³é—­ã€‚</p></li><li><p>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šè°ƒç”¨ <code>#drainInputQueues()</code> æ–¹æ³•ï¼Œ<strong>å¾ªç¯</strong>å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )ï¼Œ<strong>ç›´åˆ°</strong>æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainInputQueues</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// å¤„ç†å®Œé‡æ–°æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line"> <span class="number">4</span>:         drainReprocessQueue();</div><div class="line"> <span class="number">5</span>:         <span class="comment">// å¤„ç†å®Œæ¥æ”¶é˜Ÿåˆ—</span></div><div class="line"> <span class="number">6</span>:         drainAcceptorQueue();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾… 10 msï¼Œçœ‹æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æœ‰æ–°ä»»åŠ¡</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (!isShutdown.get()) &#123;</div><div class="line"><span class="number">10</span>:             <span class="comment">// If all queues are empty, block for a while on the acceptor queue</span></div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (reprocessQueue.isEmpty() &amp;&amp; acceptorQueue.isEmpty() &amp;&amp; pendingTasks.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:                 TaskHolder&lt;ID, T&gt; taskHolder = acceptorQueue.poll(<span class="number">10</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (taskHolder != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">14</span>:                     appendTaskHolder(taskHolder);</div><div class="line"><span class="number">15</span>:                 &#125;</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:     &#125; <span class="keyword">while</span> (!reprocessQueue.isEmpty() || !acceptorQueue.isEmpty() || pendingTasks.isEmpty()); <span class="comment">// å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )</span></div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ &amp;&amp; ç¬¬ 18 è¡Œ ï¼š<strong>å¾ªç¯</strong>ï¼Œç›´åˆ°<strong>åŒæ—¶</strong>æ»¡è¶³å¦‚ä¸‹å…¨éƒ¨æ¡ä»¶ï¼š</p><ul><li>é‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>reprocessQueue</code> ) å’Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ä¸ºç©º</li><li>å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„( <code>pendingTasks</code> )<strong>ä¸ä¸ºç©º</strong></li></ul></li><li><p>ç¬¬ 3 è‡³ 4 è¡Œ ï¼šå¤„ç†å®Œé‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>reprocessQueue</code> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainReprocessQueue</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">3</span>:     <span class="keyword">while</span> (!reprocessQueue.isEmpty() &amp;&amp; !isFull()) &#123;</div><div class="line"> <span class="number">4</span>:         TaskHolder&lt;ID, T&gt; taskHolder = reprocessQueue.pollLast(); <span class="comment">// ä¼˜å…ˆæ‹¿è¾ƒæ–°çš„ä»»åŠ¡</span></div><div class="line"> <span class="number">5</span>:         ID id = taskHolder.getId();</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (taskHolder.getExpiryTime() &lt;= now) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"> <span class="number">7</span>:             expiredTasks++;</div><div class="line"> <span class="number">8</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pendingTasks.containsKey(id)) &#123; <span class="comment">// å·²å­˜åœ¨</span></div><div class="line"> <span class="number">9</span>:             overriddenTasks++;</div><div class="line"><span class="number">10</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">11</span>:             pendingTasks.put(id, taskHolder);</div><div class="line"><span class="number">12</span>:             processingOrder.addFirst(id); <span class="comment">// æäº¤åˆ°é˜Ÿå¤´</span></div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;</div><div class="line"><span class="number">15</span>:     <span class="comment">// å¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œæ¸…ç©ºé‡æ–°æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (isFull()) &#123;</div><div class="line"><span class="number">17</span>:         queueOverflows += reprocessQueue.size();</div><div class="line"><span class="number">18</span>:         reprocessQueue.clear();</div><div class="line"><span class="number">19</span>:     &#125;</div><div class="line"><span class="number">20</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šä¼˜å…ˆä»é‡æ–°æ‰§è¡Œä»»åŠ¡çš„é˜Ÿå°¾æ‹¿è¾ƒæ–°çš„ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¿ç•™æ›´æ–°çš„ä»»åŠ¡åœ¨å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„( <code>pendingTasks</code> ) é‡Œã€‚</li><li>ç¬¬ 12 è¡Œ ï¼šæ·»åŠ ä»»åŠ¡ç¼–å·åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> ) çš„å¤´éƒ¨ã€‚æ•ˆæœå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_17/03.png" alt=""></li><li>ç¬¬ 15 è‡³ 18 è¡Œ ï¼šå¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—( <code>pendingTasks</code> )å·²æ»¡ï¼Œæ¸…ç©ºé‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡ã€‚</li></ul></li><li><p>ç¬¬ 5 è‡³ 6 è¡Œ ï¼šå¤„ç†å®Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainAcceptorQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">while</span> (!acceptorQueue.isEmpty()) &#123; <span class="comment">// å¾ªç¯ï¼Œç›´åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">      appendTaskHolder(acceptorQueue.poll());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTaskHolder</span><span class="params">(TaskHolder&lt;ID, T&gt; taskHolder)</span> </span>&#123;</div><div class="line">  <span class="comment">// å¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œç§»é™¤å¾…å¤„ç†é˜Ÿåˆ—ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡</span></div><div class="line">  <span class="keyword">if</span> (isFull()) &#123;</div><div class="line">      pendingTasks.remove(processingOrder.poll());</div><div class="line">      queueOverflows++;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">  TaskHolder&lt;ID, T&gt; previousTask = pendingTasks.put(taskHolder.getId(), taskHolder);</div><div class="line">  <span class="keyword">if</span> (previousTask == <span class="keyword">null</span>) &#123;</div><div class="line">      processingOrder.add(taskHolder.getId());</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      overriddenTasks++;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 8 è‡³ 17 è¡Œ ï¼šå½“æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡ä»æ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> ) æ‹‰å–ä»»åŠ¡ 10 msã€‚è‹¥æ‹‰å–åˆ°ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )ã€‚</p></li></ul></li><li><p>ç¬¬ 12 è‡³ 16 è¡Œ ï¼šè®¡ç®—å¯è°ƒåº¦ä»»åŠ¡çš„æœ€å°æ—¶é—´( <code>scheduleTime</code> )ã€‚</p><ul><li>å½“ <code>scheduleTime</code> å°äºå½“å‰æ—¶é—´ï¼Œä¸é‡æ–°è®¡ç®—ï¼Œå³æ­¤æ—¶éœ€è¦å»¶è¿Ÿç­‰å¾…è°ƒåº¦ã€‚</li><li>å½“ <code>scheduleTime</code> å¤§äºç­‰äºå½“å‰æ—¶é—´ï¼Œé…åˆ <code>TrafficShaper#transmissionDelay(...)</code> é‡æ–°è®¡ç®—ã€‚</li></ul></li><li><p>ç¬¬ 19 è¡Œ ï¼šå½“ <code>scheduleTime</code> å°äºå½“å‰æ—¶é—´ï¼Œæ‰§è¡Œä»»åŠ¡çš„è°ƒåº¦ã€‚</p></li><li><p>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#assignBatchWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦æ‰¹é‡ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">assignBatchWork</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (hasEnoughTasksForNextBatch()) &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// è·å– æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (batchWorkRequests.tryAcquire(<span class="number">1</span>)) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="comment">// è·å–æ‰¹é‡ä»»åŠ¡</span></div><div class="line"> <span class="number">6</span>:             <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">7</span>:             <span class="keyword">int</span> len = Math.min(maxBatchingSize, processingOrder.size());</div><div class="line"> <span class="number">8</span>:             List&lt;TaskHolder&lt;ID, T&gt;&gt; holders = <span class="keyword">new</span> ArrayList&lt;&gt;(len);</div><div class="line"> <span class="number">9</span>:             <span class="keyword">while</span> (holders.size() &lt; len &amp;&amp; !processingOrder.isEmpty()) &#123;</div><div class="line"><span class="number">10</span>:                 ID id = processingOrder.poll();</div><div class="line"><span class="number">11</span>:                 TaskHolder&lt;ID, T&gt; holder = pendingTasks.remove(id);</div><div class="line"><span class="number">12</span>:                 <span class="keyword">if</span> (holder.getExpiryTime() &gt; now) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"><span class="number">13</span>:                     holders.add(holder);</div><div class="line"><span class="number">14</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                     expiredTasks++;</div><div class="line"><span class="number">16</span>:                 &#125;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>:             <span class="comment">//</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (holders.isEmpty()) &#123; <span class="comment">// æœªè°ƒåº¦åˆ°æ‰¹é‡ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="number">20</span>:                 batchWorkRequests.release();</div><div class="line"><span class="number">21</span>:             &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ·»åŠ æ‰¹é‡ä»»åŠ¡åˆ°æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="number">22</span>:                 batchSizeMetric.record(holders.size(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">23</span>:                 batchWorkQueue.add(holders);</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>#hasEnoughTasksForNextBatch()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿä»»åŠ¡è¿›è¡Œä¸‹ä¸€æ¬¡æ‰¹é‡ä»»åŠ¡è°ƒåº¦ï¼š1ï¼‰å¾…æ‰§è¡Œä»»åŠ¡( <code>processingOrder</code> )æ˜ å°„å·²æ»¡ï¼›æˆ–è€… 2ï¼‰åˆ°è¾¾æ‰¹é‡ä»»åŠ¡å¤„ç†æœ€å¤§ç­‰å¾…å»¶è¿Ÿã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasEnoughTasksForNextBatch</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">    <span class="keyword">if</span> (processingOrder.isEmpty()) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„å·²æ»¡</span></div><div class="line">    <span class="keyword">if</span> (pendingTasks.size() &gt;= maxBufferSize) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ°è¾¾æ‰¹é‡ä»»åŠ¡å¤„ç†æœ€å¤§ç­‰å¾…å»¶è¿Ÿ( é€šè¿‡å¾…å¤„ç†é˜Ÿåˆ—çš„å¤´éƒ¨ä»»åŠ¡åˆ¤æ–­ )</span></div><div class="line">    TaskHolder&lt;ID, T&gt; nextHolder = pendingTasks.get(processingOrder.peek());</div><div class="line">    <span class="keyword">long</span> delay = System.currentTimeMillis() - nextHolder.getSubmitTimestamp();</div><div class="line">    <span class="keyword">return</span> delay &gt;= maxBatchingDelay;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 5 è‡³ 17 è¡Œ ï¼šè·å–æ‰¹é‡ä»»åŠ¡( <code>holders</code> )ã€‚ğŸ˜ˆ ä½ ä¼šå‘ç°ï¼Œæœ¬æ–‡è¯´äº†åŠå¤©çš„æ‰¹é‡ä»»åŠ¡ï¼Œå®é™…æ˜¯ <code>List&lt;TaskHolder&lt;ID, T&gt;&gt;</code> å“ˆã€‚</p></li><li><p>ç¬¬ 4 è¡Œ ï¼šè·å–æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡( <code>batchWorkRequests</code> ) ã€‚åœ¨ä»»åŠ¡æ‰§è¡Œå™¨çš„æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå‘å‡º <code>batchWorkRequests</code> ã€‚<strong>æ¯ä¸€ä¸ªä¿¡å·é‡éœ€è¦ä¿è¯è·å–åˆ°ä¸€ä¸ªæ‰¹é‡ä»»åŠ¡</strong>ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 20 è¡Œ ï¼šæœªè°ƒåº¦åˆ°æ‰¹é‡ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡ï¼Œ<strong>ä»£è¡¨è¯·æ±‚å®é™…æœªå®Œæˆï¼Œæ¯ä¸€ä¸ªä¿¡å·é‡éœ€è¦ä¿è¯è·å–åˆ°ä¸€ä¸ªæ‰¹é‡ä»»åŠ¡</strong>ã€‚</p></li><li><p>ç¬¬ 21 è‡³ 24 è¡Œ ï¼šæ·»åŠ æ‰¹é‡ä»»åŠ¡åˆ°æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—ã€‚</p></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#assignSingleItemWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦å•ä»»åŠ¡ã€‚</p></li></ul></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#assignSingleItemWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦å•ä»»åŠ¡ï¼Œå’Œ <code>#assignBatchWork()</code> æ–¹æ³•<strong>ç±»ä¼¼</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">assignSingleItemWork</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!processingOrder.isEmpty()) &#123; <span class="comment">// å¾…æ‰§è¡Œä»»é˜Ÿåˆ—ä¸ä¸ºç©º</span></div><div class="line">      <span class="comment">// è·å– å•ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line">      <span class="keyword">if</span> (singleItemWorkRequests.tryAcquire(<span class="number">1</span>)) &#123;</div><div class="line">          <span class="comment">// ã€å¾ªç¯ã€‘è·å–å•ä»»åŠ¡</span></div><div class="line">          <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">          <span class="keyword">while</span> (!processingOrder.isEmpty()) &#123;</div><div class="line">              ID id = processingOrder.poll(); <span class="comment">// ä¸€å®šä¸ä¸ºç©º</span></div><div class="line">              TaskHolder&lt;ID, T&gt; holder = pendingTasks.remove(id);</div><div class="line">              <span class="keyword">if</span> (holder.getExpiryTime() &gt; now) &#123;</div><div class="line">                  singleItemWorkQueue.add(holder);</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">              expiredTasks++;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// è·å–ä¸åˆ°å•ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡</span></div><div class="line">          singleItemWorkRequests.release();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 26 è‡³ 31 è¡Œ ï¼šå½“è°ƒåº¦ä»»åŠ¡å‰çš„å¾…æ‰§è¡Œä»»åŠ¡æ•°( <code>totalItems</code> )ç­‰äºå½“å‰å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )çš„ä»»åŠ¡æ•°ï¼Œæ„å‘³ç€ï¼š1ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨æ— ä»»åŠ¡è¯·æ±‚ï¼Œæ­£åœ¨å¿™ç¢Œå¤„ç†ä¹‹å‰çš„ä»»åŠ¡ï¼›æˆ–è€… 2ï¼‰ä»»åŠ¡å»¶è¿Ÿè°ƒåº¦ã€‚ç¡çœ  10 ç§’ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p></li></ul><h1>10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</h1><h2>10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</h2><p>æ‰¹é‡ä»»åŠ¡å·¥ä½œåå°çº¿ç¨‹( BatchWorkerRunnable )æ‰§è¡Œ <code>#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">4</span>:         <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line">  <span class="number">5</span>:             <span class="comment">// è·å–æ‰¹é‡ä»»åŠ¡</span></div><div class="line">  <span class="number">6</span>:             List&lt;TaskHolder&lt;ID, T&gt;&gt; holders = getWork();</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">  <span class="number">9</span>:             metrics.registerExpiryTimes(holders);</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:             <span class="comment">// è·å¾—å®é™…æ‰¹é‡ä»»åŠ¡</span></div><div class="line"> <span class="number">12</span>:             List&lt;T&gt; tasks = getTasksOf(holders);</div><div class="line"> <span class="number">13</span>:             <span class="comment">// è°ƒç”¨å¤„ç†å™¨æ‰§è¡Œä»»åŠ¡</span></div><div class="line"> <span class="number">14</span>:             ProcessingResult result = processor.process(tasks);</div><div class="line"> <span class="number">15</span>:             <span class="keyword">switch</span> (result) &#123;</div><div class="line"> <span class="number">16</span>:                 <span class="keyword">case</span> Success:</div><div class="line"> <span class="number">17</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">case</span> Congestion:</div><div class="line"> <span class="number">19</span>:                 <span class="keyword">case</span> TransientError:</div><div class="line"> <span class="number">20</span>:                     taskDispatcher.reprocess(holders, result); <span class="comment">// æäº¤é‡æ–°å¤„ç†</span></div><div class="line"> <span class="number">21</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">22</span>:                 <span class="keyword">case</span> PermanentError:</div><div class="line"> <span class="number">23</span>:                     logger.warn(<span class="string">"Discarding &#123;&#125; tasks of &#123;&#125; due to permanent error"</span>, holders.size(), workerName);</div><div class="line"> <span class="number">24</span>:             &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line"> <span class="number">27</span>:             metrics.registerTaskResult(result, tasks.size());</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">30</span>:         <span class="comment">// Ignore</span></div><div class="line"> <span class="number">31</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">32</span>:         <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line"> <span class="number">33</span>:         logger.warn(<span class="string">"Discovery WorkerThread error"</span>, e);</div><div class="line"> <span class="number">34</span>:     &#125;</div><div class="line"> <span class="number">35</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šæ— é™å¾ªç¯æ‰§è¡Œè°ƒåº¦ï¼Œç›´åˆ°å…³é—­ã€‚</p></li><li><p>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>getWork()</code> æ–¹æ³•ï¼Œè·å–<strong>ä¸€ä¸ª</strong>æ‰¹é‡ä»»åŠ¡ç›´åˆ°æˆåŠŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> List&lt;TaskHolder&lt;ID, T&gt;&gt; getWork() <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—æ‰¹é‡ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"> <span class="number">3</span>:     BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; workQueue = taskDispatcher.requestWorkItems();</div><div class="line"> <span class="number">4</span>:     <span class="comment">// ã€å¾ªç¯ã€‘è·å–æ‰¹é‡ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"> <span class="number">5</span>:     List&lt;TaskHolder&lt;ID, T&gt;&gt; result;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">7</span>:         result = workQueue.poll(<span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line"> <span class="number">8</span>:     &#125; <span class="keyword">while</span> (!isShutdown.get() &amp;&amp; result == <span class="keyword">null</span>);</div><div class="line"> <span class="number">9</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>TaskDispatcher#requestWorkItems()</code> æ–¹æ³•ï¼Œå‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—æ‰¹é‡ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskDispatcher.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Semaphore batchWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; batchWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; requestWorkItems() &#123;</div><div class="line">   batchWorkRequests.release();</div><div class="line">   <span class="keyword">return</span> batchWorkQueue;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼Œæ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>batchWorkQueue</code> ) å’Œå•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>singleItemWorkQueue</code> ) æ˜¯<strong>ä¸åŒçš„é˜Ÿåˆ—</strong>ã€‚</li></ul></li><li><p>ç¬¬ 5 è‡³ 8 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å–<strong>ä¸€ä¸ª</strong>æ‰¹é‡ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸã€‚</p></li></ul></li><li><p>ç¬¬ 12 è¡Œ ï¼šè°ƒç”¨ <code>#getTasksOf(...)</code> æ–¹æ³•ï¼Œè·å¾—<strong>å®é™…</strong>æ‰¹é‡ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;T&gt; <span class="title">getTasksOf</span><span class="params">(List&lt;TaskHolder&lt;ID, T&gt;&gt; holders)</span> </span>&#123;</div><div class="line">    List&lt;T&gt; tasks = <span class="keyword">new</span> ArrayList&lt;&gt;(holders.size());</div><div class="line">    <span class="keyword">for</span> (TaskHolder&lt;ID, T&gt; holder : holders) &#123;</div><div class="line">        tasks.add(holder.getTask());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> tasks;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 14 è‡³ 24 è¡Œ ï¼šè°ƒç”¨å¤„ç†å™¨( TaskProcessor ) æ‰§è¡Œä»»åŠ¡ã€‚å½“ä»»åŠ¡æ‰§è¡Œç»“æœä¸º <code>Congestion</code> æˆ– <code>TransientError</code> ï¼Œè°ƒç”¨ <code>AcceptorExecutor#reprocess(...)</code> æäº¤<strong>æ•´ä¸ªæ‰¹é‡ä»»åŠ¡</strong>é‡æ–°å¤„ç†ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AcceptorExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">reprocess</span><span class="params">(List&lt;TaskHolder&lt;ID, T&gt;&gt; holders, ProcessingResult processingResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° é‡æ–°æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   reprocessQueue.addAll(holders);</div><div class="line"></div><div class="line">   <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">   replayedTasks += holders.size();</div><div class="line">   </div><div class="line">   <span class="comment">// æäº¤ä»»åŠ¡ç»“æœç»™ TrafficShaper</span></div><div class="line">   trafficShaper.registerFailure(processingResult);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</h2><p>å•ä»»åŠ¡å·¥ä½œåå°çº¿ç¨‹( SingleTaskWorkerRunnable )æ‰§è¡Œ <code>#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ï¼Œå’Œ <code>BatchWorkerRunnable#run(...)</code> åŸºæœ¬ç±»ä¼¼ï¼Œå°±ä¸å•°å—¦äº†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// SingleTaskWorkerRunnable.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line">          <span class="comment">// å‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—å•ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—</span></div><div class="line">          BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; workQueue = taskDispatcher.requestWorkItem();</div><div class="line">          TaskHolder&lt;ID, T&gt; taskHolder;</div><div class="line">          <span class="comment">// ã€å¾ªç¯ã€‘è·å–å•ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line">          <span class="keyword">while</span> ((taskHolder = workQueue.poll(<span class="number">1</span>, TimeUnit.SECONDS)) == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (isShutdown.get()) &#123;</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">          metrics.registerExpiryTime(taskHolder);</div><div class="line">          <span class="keyword">if</span> (taskHolder != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="comment">// è°ƒç”¨å¤„ç†å™¨æ‰§è¡Œä»»åŠ¡</span></div><div class="line">              ProcessingResult result = processor.process(taskHolder.getTask());</div><div class="line">              <span class="keyword">switch</span> (result) &#123;</div><div class="line">                  <span class="keyword">case</span> Success:</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> Congestion:</div><div class="line">                  <span class="keyword">case</span> TransientError:</div><div class="line">                      taskDispatcher.reprocess(taskHolder, result); <span class="comment">// æäº¤é‡æ–°å¤„ç†</span></div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> PermanentError:</div><div class="line">                      logger.warn(<span class="string">"Discarding a task of &#123;&#125; due to permanent error"</span>, workerName);</div><div class="line">              &#125;</div><div class="line">              <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">              metrics.registerTaskResult(result, <span class="number">1</span>);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      <span class="comment">// Ignore</span></div><div class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">      <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line">      logger.warn(<span class="string">"Discovery WorkerThread error"</span>, e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>ğŸ˜ˆ åˆæ˜¯ä¸€ç¯‡é•¿æ–‡ã€‚å»ºè®®è¾¹çœ‹ä»£ç ï¼Œè¾¹å¯¹ç…§ç€æ•´ä½“æµç¨‹å›¾ï¼Œç†è§£å®é™…ä¸éš¾ã€‚</p><p>å½“ç„¶ï¼Œæ¬¢è¿ä½ æœ‰ä»»ä½•ç–‘é—®ï¼Œåœ¨æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç•™è¨€ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/batch-tasks/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a hre
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/</id>
    <published>2018-07-13T16:00:00.000Z</published>
    <updated>2017-10-20T01:19:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/">2. è¯»å†™é”</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka æ³¨å†Œä¸­å¿ƒçš„é‚£æŠŠè¯»å†™é”</strong>ï¼Œè®©æˆ‘ç˜™ç—’éš¾è€ï¼Œå´ä¸å¾—å…¶è§£ã€‚åœ¨æŸæ¬¡æ„å¤–çš„æŠ è„šçš„ä¸€åˆ»( ç¬”è€…ä¸æŠ½çƒŸï¼Œå¦‚æœæŠ½çƒŸçš„è¯ï¼Œæ­¤å¤„åº”è¯¥å°±ä¸æ˜¯æŠ è„šäº† )ï¼Œçªç„¶é¡¿æ‚Ÿï¼Œçˆ½ï¼Œè¿™å¥½æ¯”... æ¯”å–»æœ‰ç‚¹çŒ¥çï¼Œç¬”è€…å°±çœç•¥ 100 å­—ã€‚</p><p>ä¸çæ¯”æ¯”ï¼Œä¸Šä»£ç ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceRegistry</span> <span class="keyword">implements</span> <span class="title">InstanceRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock read = readWriteLock.readLock();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock write = readWriteLock.writeLock();</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. è¯»å†™é”</h1><p>æˆ‘ä»¬æŠŠè®¾è®¡åˆ°è¯»å†™é”çš„æ–¹æ³•æ•´ç†å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯»é”</th><th>å†™é”</th><th>ä¸ä½¿ç”¨</th></tr></thead><tbody><tr><td><code>#register(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#cancel(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#evict(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#renew(...)</code></td><td></td><td></td><td>âˆš</td></tr><tr><td><code>#statusUpdate(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#deleteStatusOverride(...)</code></td><td>âˆš</td><td></td><td></td></tr><tr><td><code>#getApplicationDeltasFromMultipleRegions(...)</code></td><td></td><td>âˆš</td><td></td></tr><tr><td><code>#getApplicationsFromMultipleRegions(...)</code></td><td></td><td></td><td>âˆš</td></tr></tbody></table><p>æ˜¯å¦çœ‹åˆ°è¿™è¯»å†™æ„Ÿåˆ°å‡ ä¸è¯¡å¼‚çš„å‘³é“ï¼ŸOKï¼Œæˆ‘ä»¬æŠŠé—®é¢˜æ¢³ç†å¦‚ä¸‹ï¼š</p><ul><li>A. ä¸ºä»€ä¹ˆ <code>#register(...)</code> / <code>#cancel(...)</code> / <code>#evict(...)</code> / <code>#statusUpdate(...)</code> / <code>#deleteStatusOverride(...)</code> ç­‰<strong>å†™æ“ä½œ</strong>ä½¿ç”¨<strong>è¯»é”</strong></li><li>B. ä¸ºä»€ä¹ˆ <code>#renew(...)</code> <strong>å†™æ“ä½œ</strong>ä¸ä½¿ç”¨<strong>é”</strong></li><li>C. ä¸ºä»€ä¹ˆ <code>#getApplicationDeltasFromMultipleRegions(...)</code> <strong>è¯»æ“ä½œ</strong>ä½¿ç”¨<strong>å†™é”</strong></li><li>D. ä¸ºä»€ä¹ˆ <code>getApplicationsFromMultipleRegions(...)</code> <strong>è¯»æ“ä½œ</strong>ä¸ä½¿ç”¨<strong>é”</strong></li></ul><hr><p><strong>å…ˆè§£é‡Š A + C</strong> ï¼š</p><p>æˆ‘ä»¬æ¥å›æƒ³ä¸‹ï¼Œåœ¨ Eureka åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç çš„å…¬å¼ï¼š<code>appsHashCode = ${status}_${count}_</code> ã€‚( ä¸äº†è§£çš„åŒå­¦å¯ä»¥åŠ è½½ä¸‹ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹ã€Œ 2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç  ã€</a> )</p><p><s>åº”ç”¨å®ä¾‹çš„æ•°é‡å’ŒçŠ¶æ€éƒ½ä¼šå½±å“<strong>å“ˆå¸Œç </strong>çš„è®¡ç®—ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šè¿°<strong>å‰å…­ä¸ª</strong>( åŒ…æ‹¬ä¸ä½¿ç”¨é”çš„ <code>#renew(...)</code> æ–¹æ³• )æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå½±å“å“ˆå¸Œç ã€‚</s></p><p>æˆ‘ä»¬æŠŠç›®å…‰ç§»å‘å”¯ä¸€ä½¿ç”¨<strong>å†™é”</strong>çš„ <code>#getApplicationDeltasFromMultipleRegions(...)</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¿è¯ <code>recentlyChangedQueue</code> å’Œ <code>registry</code> å…±äº«å˜é‡çš„<strong>åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸€è‡´</strong>ï¼Œä¸ç„¶è¿”å›çš„å¢é‡åº”ç”¨å®ä¾‹é›†åˆçš„çŠ¶æ€æ˜¯ä¸å‡†ç¡®çš„ã€‚æ­¤æ—¶èƒ½å¤Ÿè¾¾åˆ°è¯¥æ•ˆæœï¼Œå¿…é¡»è®© <code>#getApplicationDeltasFromMultipleRegions(...)</code> å’Œå‰å…­ä¸ªæ–¹æ³•<strong>äº’æ–¥</strong>ã€‚æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>a. å…¨éƒ¨ <code>synchronized</code></li><li>b. <code>#getApplicationDeltasFromMultipleRegions(...)</code> ä½¿ç”¨<strong>è¯»é”</strong>ï¼Œå‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨<strong>å†™é”</strong></li><li>c. <code>#getApplicationDeltasFromMultipleRegions(...)</code> ä½¿ç”¨<strong>å†™é”</strong>ï¼Œå‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨<strong>è¯»é”</strong></li></ul><p>Eureka é€‰æ‹©äº†<strong>æ–¹æ¡ˆc</strong>ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ul><li>a. æ€§èƒ½å¤ªå·®</li><li>b. å‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨<strong>å†™é”</strong>ï¼ŒåŠ¿å¿…å†²çªå¤ªå¤§ï¼Œè™½ç„¶è¯»è‚¯å®šæ¯”å†™å¤šã€‚</li><li>c. <code>#getApplicationDeltasFromMultipleRegions(...)</code> ä½¿ç”¨<strong>å†™é”</strong>ï¼Œé…åˆ ResponseCache ï¼Œå³å‡å°‘äº†<strong>å†™é”</strong>ä½¿ç”¨çš„é¢‘ç‡ï¼Œæ¯æ¬¡ç¼“å­˜è¿‡æœŸæ‰ä½¿ç”¨ï¼Œåˆé¿å…äº†å‰å…­ä¸ªæ–¹æ³•å› ä¸º<strong>æ–¹æ¡ˆb</strong>ä¸­çš„<strong>å†™é”</strong>å¯¼è‡´äº’æ–¥ã€‚( ä¸äº†è§£ ResponseCache çš„åŒå­¦å¯ä»¥åŠ è½½ä¸‹ <a href="hhttp://www.iocoder.cn/Eureka/instance-registry-fetch-all/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ 3.2 å“åº”ç¼“å­˜ ResponseCache ã€</a> )</li></ul><hr><p><strong>å†è§£é‡Š D</strong></p><p><code>#getApplicationsFromMultipleRegions(...)</code> æ–¹æ³•çš„é€»è¾‘ï¼Œåªä¾èµ– <code>registry</code> å…±äº«å˜é‡ï¼Œä¸å­˜åœ¨åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸€è‡´çš„å›°æ‰°ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨é”ã€‚</p><hr><p><strong>æœ€åè§£é‡Š B</strong></p><p><code>#renew(...)</code> æ–¹æ³•çš„é€»è¾‘ï¼Œè™½ç„¶ä¼šå½±å“åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œä½†æ˜¯æ˜¯æå°æ¦‚ç‡ï¼Œè€ƒè™‘åˆ°å®ƒè°ƒç”¨çš„æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯”èµ·å› ä¸ºé”ç»™è¿™ä¸ªæ–¹æ³•å¸¦æ¥çš„æ€§èƒ½é™ä½ï¼Œä¸å¦‚è¿”å›çš„ç»“æœæš‚æ—¶ä¸å¤Ÿå‡†ç¡®ã€‚( æƒ³äº†è§£æå°æ¦‚ç‡å‘ç”ŸåŸå› çš„åŒå­¦å¯ä»¥åŠ è½½ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹ã€Œ 4.3 ç»­ç§Ÿåœºæ™¯ ã€</a> )</p><hr><p>TODO [0029] è¯»å†™é”</p><p>ç¬”è€…è·¯ä¸Šçªç„¶åˆæƒ³äº†é—®é¢˜ï¼Œå¯èƒ½ä¸æ˜¯ä¸Šè¿°åŸå› ï¼Œå¯èƒ½å’Œ ResponseCache æœ‰å…³ç³»ï¼Œå‚è§ <code>#invalidateCache(...)</code> æ–¹æ³•çš„æ¯æ¬¡è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯»å†™é”æ˜¯é’ˆå¯¹ ResponseCache çš„è¯»å†™é”ã€‚</p><h1>666. å½©è›‹</h1><p>å¼€æ£® ï¼</p><p>æœ¬æ¥ä»¥ä¸ºéœ€è¦è·Ÿ Eureka å®˜æ–¹æäº¤ issue æé—®ï¼Œå¹¶ä¸”åšå¥½äº†è·å¾—ä¸åˆ°ç­”æ¡ˆçš„å‡†å¤‡ï¼Œç»“æœæ— æ„ä¸­çš„æŠ è„š( è¯·å…è®¸æˆ‘çƒ­çˆ±æŠ è„šç»™æˆ‘å¸¦æ¥çš„çµæ„Ÿ )è§£ç­”äº†è‡ªå·±çš„ç–‘æƒ‘ã€‚</p><p>å²æœˆæ˜¯æŠŠçº ç»“è€ŒåˆèŒèŒå“’çš„é”ï¼Œä½ ä¸çŸ¥é“ä½ çš„å›°æ‰°ï¼Œå“ªå¤©ä¸ç»æ„çš„è¢«æ‰“å¼€ã€‚</p><p>æ„¿å¤§å–œå¤§æ‚²ï¼Œä¸æ‰ä»…çŸ¥çš„è¿™ä¸€ç”Ÿã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-override-status/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-override-status/</id>
    <published>2018-07-07T16:00:00.000Z</published>
    <updated>2017-10-18T18:03:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-override-status/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">2. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€å˜æ›´æ¥å£</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">2.1 æ›´æ–°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">3. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€åˆ é™¤æ¥å£</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">3.1 åˆ é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">4. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">4.1 åº”ç”¨å®ä¾‹çŠ¶æ€è¦†ç›–è§„åˆ™</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">4.2 æ³¨å†Œåœºæ™¯</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">4.3 ç»­ç§Ÿåœºæ™¯</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">4.4 ä¸‹çº¿åœºæ™¯</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">4.5 è¿‡æœŸåœºæ™¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">5. å®¢æˆ·ç«¯è°ƒç”¨æ¥å£</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€å±æ€§</strong>ã€‚</p><p>è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œä¸æ˜¯åº”ç”¨å®ä¾‹çš„çŠ¶æ€( <code>status</code> )ï¼Œè€Œæ˜¯è¦†ç›–çŠ¶æ€( <code>overridestatus</code> ) ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceInfo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceStatus overriddenstatus = InstanceStatus.UNKNOWN;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å±æ€§å’Œæ–¹æ³•</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è°ƒç”¨ Eureka-Server HTTP Restful æ¥å£ <code>apps/${APP_NAME}/${INSTANCE_ID}/status</code> å¯¹åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€çš„å˜æ›´ï¼Œä»è€Œè¾¾åˆ°<strong>ä¸»åŠ¨</strong>çš„ã€<strong>å¼ºåˆ¶</strong>çš„å˜æ›´åº”ç”¨å®ä¾‹çŠ¶æ€ã€‚æ³¨æ„ï¼Œ<strong>å®é™…ä¸ä¼šçœŸçš„ä¿®æ”¹ Eureka-Client åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œè€Œæ˜¯ä¿®æ”¹åœ¨ Eureka-Server æ³¨å†Œçš„åº”ç”¨å®ä¾‹çš„çŠ¶æ€</strong>ã€‚</p><p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒEureka-Client åœ¨è·å–åˆ°æ³¨å†Œä¿¡æ¯æ—¶ï¼Œå¹¶ä¸”é…ç½® <code>eureka.shouldFilterOnlyUpInstances = true</code>ï¼Œè¿‡æ»¤æ‰é <code>InstanceStatus.UP</code> çš„åº”ç”¨å®ä¾‹ï¼Œä»è€Œé¿å…è°ƒåŠ¨è¯¥å®ä¾‹ï¼Œä»¥è¾¾åˆ°åº”ç”¨å®ä¾‹çš„<strong>æš‚åœæœåŠ¡( <code>InstanceStatus.OUT_OF_SERVICE</code> )ï¼Œè€Œæ— éœ€å…³é—­åº”ç”¨å®ä¾‹</strong>ã€‚</p><p>å› æ­¤ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè°ƒç”¨è¯¥æ¥å£çš„ç›®çš„ï¼Œå°†åº”ç”¨å®ä¾‹çŠ¶æ€åœ¨ ( <code>InstanceStatus.UP</code> ) å’Œ  ( <code>InstanceStatus.OUT_OF_SERVICE</code> ) ä¹‹é—´åˆ‡æ¢ã€‚å¼•ç”¨å®˜æ–¹ä»£ç ä¸Šçš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p><blockquote><p><code>AbstractInstanceRegistry#statusUpdate</code> æ–¹æ³•æ³¨é‡Š<br>Updates the status of an instance.<br>Normally happens to put an instance between {@link InstanceStatus#OUT_OF_SERVICE} and {@link InstanceStatus#UP} to put the instance in and out of traffic.</p></blockquote><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><hr><p>æ¥å£ <code>apps/${APP_NAME}/${INSTANCE_ID}/status</code> å®é™…æ˜¯ä¸¤ä¸ªï¼š</p><ul><li>PUT <code>apps/${APP_NAME}/${INSTANCE_ID}/status</code></li><li>DELETE <code>apps/${APP_NAME}/${INSTANCE_ID}/status</code></li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€èŠ‚åˆ†äº«è¿™ä¸¤æ¥å£çš„ä»£ç å®ç°ã€‚</p><h1>2. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€å˜æ›´æ¥å£</h1><p>åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€å˜æ›´æ¥å£ï¼Œæ˜ å°„ <code>InstanceResource#statusUpdate()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@PUT</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"status"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">statusUpdate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">       @QueryParam(<span class="string">"value"</span>)</span> String newStatus,</span></div><div class="line"><span class="function">       @<span class="title">HeaderParam</span><span class="params">(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></div><div class="line"><span class="function">       @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åº”ç”¨å®ä¾‹ä¸å­˜åœ¨</span></div><div class="line">       <span class="keyword">if</span> (registry.getInstanceByAppAndId(app.getName(), id) == <span class="keyword">null</span>) &#123;</div><div class="line">           logger.warn(<span class="string">"Instance not found: &#123;&#125;/&#123;&#125;"</span>, app.getName(), id);</div><div class="line">           <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// è¦†ç›–çŠ¶æ€æ›´æ–°</span></div><div class="line">       <span class="keyword">boolean</span> isSuccess = registry.statusUpdate(app.getName(), id,</div><div class="line">               InstanceStatus.valueOf(newStatus), lastDirtyTimestamp,</div><div class="line">               <span class="string">"true"</span>.equals(isReplication));</div><div class="line"></div><div class="line">       <span class="comment">// è¿”å›ç»“æœ</span></div><div class="line">       <span class="keyword">if</span> (isSuccess) &#123;</div><div class="line">           logger.info(<span class="string">"Status updated: "</span> + app.getName() + <span class="string">" - "</span> + id</div><div class="line">                   + <span class="string">" - "</span> + newStatus);</div><div class="line">           <span class="keyword">return</span> Response.ok().build();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           logger.warn(<span class="string">"Unable to update status: "</span> + app.getName() + <span class="string">" - "</span></div><div class="line">                   + id + <span class="string">" - "</span> + newStatus);</div><div class="line">           <span class="keyword">return</span> Response.serverError().build();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Error updating instance &#123;&#125; for status &#123;&#125;"</span>, id,</div><div class="line">               newStatus);</div><div class="line">       <span class="keyword">return</span> Response.serverError().build();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#statusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></div><div class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> InstanceStatus newStatus, String lastDirtyTimestamp,</span></span></div><div class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">super</span>.statusUpdate(appName, id, newStatus, lastDirtyTimestamp, isReplication)) &#123;</div><div class="line">       <span class="comment">// Eureka-Server é›†ç¾¤åŒæ­¥</span></div><div class="line">       replicateToPeers(Action.StatusUpdate, appName, id, <span class="keyword">null</span>, newStatus, isReplication);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#statusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€ã€‚</li></ul></li></ul><h2>2.1 æ›´æ–°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#statusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">statusUpdate</span><span class="params">(String appName, String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                             InstanceStatus newStatus, String lastDirtyTimestamp,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">4</span>:                             <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// è·å–è¯»é”</span></div><div class="line"> <span class="number">7</span>:         read.lock();</div><div class="line"> <span class="number">8</span>:         <span class="comment">// æ·»åŠ  è¦†ç›–çŠ¶æ€å˜æ›´æ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"> <span class="number">9</span>:         STATUS_UPDATE.increment(isReplication);</div><div class="line"><span class="number">10</span>:         <span class="comment">// è·å¾— ç§Ÿçº¦</span></div><div class="line"><span class="number">11</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line"><span class="number">12</span>:         Lease&lt;InstanceInfo&gt; lease = <span class="keyword">null</span>;</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">14</span>:             lease = gMap.get(id);</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="comment">// ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (lease == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             <span class="comment">// è®¾ç½® ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´ï¼ˆç»­ç§Ÿï¼‰</span></div><div class="line"><span class="number">21</span>:             lease.renew();</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:             <span class="comment">// åº”ç”¨å®ä¾‹ä¿¡æ¯ä¸å­˜åœ¨( é˜²å¾¡å‹ç¼–ç¨‹ )</span></div><div class="line"><span class="number">24</span>:             InstanceInfo info = lease.getHolder();</div><div class="line"><span class="number">25</span>:             <span class="comment">// Lease is always created with its instance info object.</span></div><div class="line"><span class="number">26</span>:             <span class="comment">// This log statement is provided as a safeguard, in case this invariant is violated.</span></div><div class="line"><span class="number">27</span>:             <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">28</span>:                 logger.error(<span class="string">"Found Lease without a holder for instance id &#123;&#125;"</span>, id);</div><div class="line"><span class="number">29</span>:             &#125;</div><div class="line"><span class="number">30</span>:             <span class="comment">//</span></div><div class="line"><span class="number">31</span>:             <span class="keyword">if</span> ((info != <span class="keyword">null</span>) &amp;&amp; !(info.getStatus().equals(newStatus))) &#123;</div><div class="line"><span class="number">32</span>:                 <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆï¼‰</span></div><div class="line"><span class="number">33</span>:                 <span class="comment">// Mark service as UP if needed</span></div><div class="line"><span class="number">34</span>:                 <span class="keyword">if</span> (InstanceStatus.UP.equals(newStatus)) &#123;</div><div class="line"><span class="number">35</span>:                     lease.serviceUp();</div><div class="line"><span class="number">36</span>:                 &#125;</div><div class="line"><span class="number">37</span>:                 <span class="comment">// æ·»åŠ åˆ° åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„</span></div><div class="line"><span class="number">38</span>:                 <span class="comment">// This is NAC overridden status</span></div><div class="line"><span class="number">39</span>:                 overriddenInstanceStatusMap.put(id, newStatus);</div><div class="line"><span class="number">40</span>:                 <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</span></div><div class="line"><span class="number">41</span>:                 <span class="comment">// Set it for transfer of overridden status to replica on</span></div><div class="line"><span class="number">42</span>:                 <span class="comment">// replica start up</span></div><div class="line"><span class="number">43</span>:                 info.setOverriddenStatus(newStatus);</div><div class="line"><span class="number">44</span>:                 <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸ä¸€è‡´æ—¶é—´</span></div><div class="line"><span class="number">45</span>:                 <span class="keyword">long</span> replicaDirtyTimestamp = <span class="number">0</span>;</div><div class="line"><span class="number">46</span>:                 <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line"><span class="number">47</span>:                 info.setStatusWithoutDirty(newStatus);</div><div class="line"><span class="number">48</span>:                 <span class="keyword">if</span> (lastDirtyTimestamp != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">49</span>:                     replicaDirtyTimestamp = Long.valueOf(lastDirtyTimestamp);</div><div class="line"><span class="number">50</span>:                 &#125;</div><div class="line"><span class="number">51</span>:                 <span class="comment">// If the replication's dirty timestamp is more than the existing one, just update</span></div><div class="line"><span class="number">52</span>:                 <span class="comment">// it to the replica's.</span></div><div class="line"><span class="number">53</span>:                 <span class="keyword">if</span> (replicaDirtyTimestamp &gt; info.getLastDirtyTimestamp()) &#123;</div><div class="line"><span class="number">54</span>:                     info.setLastDirtyTimestamp(replicaDirtyTimestamp);</div><div class="line"><span class="number">55</span>:                 &#125;</div><div class="line"><span class="number">56</span>:                 <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="number">57</span>:                 info.setActionType(ActionType.MODIFIED);</div><div class="line"><span class="number">58</span>:                 recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</div><div class="line"><span class="number">59</span>:                 <span class="comment">// è®¾ç½® æœ€åæ›´æ–°æ—¶é—´</span></div><div class="line"><span class="number">60</span>:                 info.setLastUpdatedTimestamp();</div><div class="line"><span class="number">61</span>:                 <span class="comment">// è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"><span class="number">62</span>:                 invalidateCache(appName, info.getVIPAddress(), info.getSecureVipAddress());</div><div class="line"><span class="number">63</span>:             &#125;</div><div class="line"><span class="number">64</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">65</span>:         &#125;</div><div class="line"><span class="number">66</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">67</span>:         <span class="comment">// é‡Šæ”¾é”</span></div><div class="line"><span class="number">68</span>:         read.unlock();</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šè·å–è¯»é”ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/?self">ã€ŠEurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 8 è‡³ 9 è¡Œ ï¼šæ·»åŠ è¦†ç›–çŠ¶æ€å˜æ›´æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 10 è‡³ 15 è¡Œ ï¼šè·å¾—ç§Ÿçº¦ã€‚</p></li><li><p>ç¬¬ 16 è‡³ 18 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›æ›´æ–°å¤±è´¥ã€‚</p></li><li><p>ç¬¬ 20 è‡³ 21 è¡Œ ï¼šè®¾ç½®ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´( ç»­ç§Ÿ )ã€‚</p></li><li><p>ç¬¬ 23 è‡³ 29 è¡Œ ï¼šæŒæœ‰ç§Ÿçº¦çš„åº”ç”¨å®ä¾‹ä¸å­˜åœ¨ï¼Œç†è®ºæ¥è¯´ä¸ä¼šå‡ºç°ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ã€‚</p></li><li><p>ç¬¬ 31 è¡Œ ï¼š<strong>åº”ç”¨å®ä¾‹å½“å‰çŠ¶æ€å’Œè¦†è¯¥çŠ¶æ€ä¸ä¸€è‡´æ—¶æ‰æ›´æ–°è¦†ç›–çŠ¶æ€</strong>ã€‚</p></li><li><p>ç¬¬ 32 è‡³ 36 è¡Œ ï¼šå½“è¦†ç›–çŠ¶æ€æ˜¯ <code>InstanceStatus.UP</code>ï¼Œè®¾ç½®ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆï¼‰ã€‚</p></li><li><p>ç¬¬ 37 è‡³ 39 è¡Œ ï¼šæ·»åŠ åˆ°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„( <code>overriddenInstanceStatusMap</code> )ã€‚æ­¤å¤„è‹±æ–‡ <code>&quot;NAC&quot;</code> å¯èƒ½æ˜¯ <code>&quot;Network Access Control&quot;</code> çš„ç¼©å†™ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ <a href="https://en.wikipedia.org/wiki/Network_Access_Control" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetwork Access Controlã€‹</a> ã€‚<code>overriddenInstanceStatusMap</code> å±æ€§ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„</span></div><div class="line"><span class="comment">* keyï¼šåº”ç”¨å®ä¾‹ç¼–å·</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ConcurrentMap&lt;String, InstanceStatus&gt; overriddenInstanceStatusMap = CacheBuilder</div><div class="line">      .newBuilder().initialCapacity(<span class="number">500</span>)</div><div class="line">      .expireAfterAccess(<span class="number">1</span>, TimeUnit.HOURS)</div><div class="line">      .&lt;String, InstanceStatus&gt;build().asMap();</div></pre></td></tr></table></figure></p><ul><li>æœ‰æ•ˆæœŸ 1 å°æ—¶ã€‚æ¯æ¬¡è®¿é—®åä¼šåˆ·æ–°æœ‰æ•ˆæœŸï¼Œåœ¨åæ–‡ä½ ä¼šçœ‹åˆ°å¯¹å…¶çš„è®¿é—®ã€‚</li></ul></li><li><p>ç¬¬ 40 è‡³ 43 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€ã€‚ç”¨äº Eureka-Server é›†ç¾¤åŒæ­¥ã€‚</p></li><li><p>ç¬¬ 46 è‡³ 47 è¡Œ ï¼š<strong>è®¾ç½®åº”ç”¨å®ä¾‹çŠ¶æ€</strong>ã€‚è®¾ç½®åï¼ŒEureka-Client æ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œè¢«æ›´æ–°è¦†ç›–çŠ¶æ€çš„åº”ç”¨å®ä¾‹å°±æ˜¯è®¾ç½®çš„çŠ¶æ€ã€‚</p></li><li><p>ç¬¬ 48 è‡³ 55 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„æ•°æ®ä¸ä¸€è‡´æ—¶é—´ã€‚ç”¨äº Eureka-Server é›†ç¾¤åŒæ­¥ã€‚</p></li><li><p>ç¬¬ 56 è‡³ 58 è¡Œ ï¼šæ·»åŠ åº”ç”¨å®ä¾‹åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—ã€‚</p></li><li><p>ç¬¬ 59 è‡³ 60 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„æœ€åæ›´æ–°æ—¶é—´( <code>lastUpdatedTimestamp</code> )ã€‚<code>lastUpdatedTimestamp</code> ä¸»è¦ç”¨äºè®°å½•æœ€åæ›´æ–°æ—¶é—´ï¼Œæ— å®é™…ä¸šåŠ¡ç”¨é€”ã€‚</p></li><li><p>ç¬¬ 61 è‡³ 62 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜è¿‡æœŸã€‚</p></li><li><p>ç¬¬ 64 è¡Œ ï¼šè¿”å›æ›´æ–°æˆåŠŸã€‚</p></li><li><p>ç¬¬ 68 è¡Œ ï¼šé‡Šæ”¾è¯»é”ã€‚</p></li></ul><h1>3. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€åˆ é™¤æ¥å£</h1><p>å½“æˆ‘ä»¬ä¸éœ€è¦åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€æ—¶ï¼Œè°ƒåº¦æ¥å£æ¥å£è¿›è¡Œåˆ é™¤ã€‚å…³è”å®˜æ–¹ <code>issue#89</code> ï¼š<a href="https://github.com/Netflix/eureka/issues/89" rel="external nofollow noopener noreferrer" target="_blank">Provide an API to remove all overridden status</a>ã€‚</p><p>åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€åˆ é™¤æ¥å£ï¼Œæ˜ å°„ <code>InstanceResource#deleteStatusUpdate()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"status"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">deleteStatusUpdate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">       @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></div><div class="line"><span class="function">       @<span class="title">QueryParam</span><span class="params">(<span class="string">"value"</span>)</span> String newStatusValue,</span></div><div class="line"><span class="function">       @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åº”ç”¨å®ä¾‹ä¸å­˜åœ¨</span></div><div class="line">       <span class="keyword">if</span> (registry.getInstanceByAppAndId(app.getName(), id) == <span class="keyword">null</span>) &#123;</div><div class="line">           logger.warn(<span class="string">"Instance not found: &#123;&#125;/&#123;&#125;"</span>, app.getName(), id);</div><div class="line">           <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// è¦†ç›–çŠ¶æ€åˆ é™¤</span></div><div class="line">       InstanceStatus newStatus = newStatusValue == <span class="keyword">null</span> ? InstanceStatus.UNKNOWN : InstanceStatus.valueOf(newStatusValue);</div><div class="line">       <span class="keyword">boolean</span> isSuccess = registry.deleteStatusOverride(app.getName(), id,</div><div class="line">               newStatus, lastDirtyTimestamp, <span class="string">"true"</span>.equals(isReplication));</div><div class="line"></div><div class="line">       <span class="comment">// è¿”å›ç»“æœ</span></div><div class="line">       <span class="keyword">if</span> (isSuccess) &#123;</div><div class="line">           logger.info(<span class="string">"Status override removed: "</span> + app.getName() + <span class="string">" - "</span> + id);</div><div class="line">           <span class="keyword">return</span> Response.ok().build();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           logger.warn(<span class="string">"Unable to remove status override: "</span> + app.getName() + <span class="string">" - "</span> + id);</div><div class="line">           <span class="keyword">return</span> Response.serverError().build();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Error removing instance's &#123;&#125; status override"</span>, id);</div><div class="line">       <span class="keyword">return</span> Response.serverError().build();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¯·æ±‚å‚æ•° <code>newStatusValue</code> ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹çš„çŠ¶æ€ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<code>newStatusValue</code> è¦å’Œåº”ç”¨å®ä¾‹å®é™…çš„çŠ¶æ€ä¸€è‡´ï¼Œå› ä¸ºè¯¥åº”ç”¨å®ä¾‹çš„ Eureka-Client ä¸ä¼šä» Eureka-Server æ‹‰å–åˆ°è¯¥åº”ç”¨çŠ¶æ€ <code>newStatusValue</code> ã€‚å¦å¤–ä¸€ç§æ–¹å¼ï¼Œä¸ä¼ é€’è¯¥å‚æ•°ï¼Œç›¸å½“äº <code>UNKNOWN</code> çŠ¶æ€ï¼Œè¿™æ ·ï¼ŒEureka-Client ä¼šä¸»åŠ¨å‘ Eureka-Server å†æ¬¡å‘èµ·æ³¨å†Œï¼Œå…·ä½“åŸå› åœ¨ [ã€Œ4.3 ç»­ç§Ÿåœºæ™¯ã€] è¯¦ç»†è§£æï¼Œæ›´åŠ æ¨èçš„æ–¹å¼ã€‚</p></li><li><p>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#deleteStatusOverride(...)</code> æ–¹æ³•ï¼Œåˆ é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteStatusOverride</span><span class="params">(String appName, String id,</span></span></div><div class="line"><span class="function"><span class="params">                                   InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                                   String lastDirtyTimestamp,</span></span></div><div class="line"><span class="function"><span class="params">                                   <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">super</span>.deleteStatusOverride(appName, id, newStatus, lastDirtyTimestamp, isReplication)) &#123;</div><div class="line">       <span class="comment">// Eureka-Server é›†ç¾¤åŒæ­¥</span></div><div class="line">       replicateToPeers(Action.DeleteStatusOverride, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#deleteStatusOverride(...)</code> æ–¹æ³•ï¼Œåˆ é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€ã€‚</li></ul></li></ul><h2>3.1 åˆ é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</h2><p>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#deleteStatusOverride(...)</code> æ–¹æ³•ï¼Œåˆ é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteStatusOverride</span><span class="params">(String appName, String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                                     InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">4</span>:                                     String lastDirtyTimestamp,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">5</span>:                                     <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// è·å–è¯»é”</span></div><div class="line"> <span class="number">8</span>:         read.lock();</div><div class="line"> <span class="number">9</span>:         <span class="comment">// æ·»åŠ  è¦†ç›–çŠ¶æ€åˆ é™¤æ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"><span class="number">10</span>:         STATUS_OVERRIDE_DELETE.increment(isReplication);</div><div class="line"><span class="number">11</span>:         <span class="comment">// è·å¾— ç§Ÿçº¦</span></div><div class="line"><span class="number">12</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line"><span class="number">13</span>:         Lease&lt;InstanceInfo&gt; lease = <span class="keyword">null</span>;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">15</span>:             lease = gMap.get(id);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>:         <span class="comment">// ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"><span class="number">18</span>:         <span class="keyword">if</span> (lease == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">20</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">21</span>:             <span class="comment">// è®¾ç½® ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´ï¼ˆç»­ç§Ÿï¼‰</span></div><div class="line"><span class="number">22</span>:             lease.renew();</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:             <span class="comment">// åº”ç”¨å®ä¾‹ä¿¡æ¯ä¸å­˜åœ¨( é˜²å¾¡å‹ç¼–ç¨‹ )</span></div><div class="line"><span class="number">25</span>:             InstanceInfo info = lease.getHolder();</div><div class="line"><span class="number">26</span>:             <span class="comment">// Lease is always created with its instance info object.</span></div><div class="line"><span class="number">27</span>:             <span class="comment">// This log statement is provided as a safeguard, in case this invariant is violated.</span></div><div class="line"><span class="number">28</span>:             <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:                 logger.error(<span class="string">"Found Lease without a holder for instance id &#123;&#125;"</span>, id);</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</span></div><div class="line"><span class="number">33</span>:             InstanceStatus currentOverride = overriddenInstanceStatusMap.remove(id);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (currentOverride != <span class="keyword">null</span> &amp;&amp; info != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">35</span>:                 <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</span></div><div class="line"><span class="number">36</span>:                 info.setOverriddenStatus(InstanceStatus.UNKNOWN);</div><div class="line"><span class="number">37</span>:                 <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line"><span class="number">38</span>:                 info.setStatusWithoutDirty(newStatus);</div><div class="line"><span class="number">39</span>:                 <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸ä¸€è‡´æ—¶é—´</span></div><div class="line"><span class="number">40</span>:                 <span class="keyword">long</span> replicaDirtyTimestamp = <span class="number">0</span>;</div><div class="line"><span class="number">41</span>:                 <span class="keyword">if</span> (lastDirtyTimestamp != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">42</span>:                     replicaDirtyTimestamp = Long.valueOf(lastDirtyTimestamp);</div><div class="line"><span class="number">43</span>:                 &#125;</div><div class="line"><span class="number">44</span>:                 <span class="comment">// If the replication's dirty timestamp is more than the existing one, just update</span></div><div class="line"><span class="number">45</span>:                 <span class="comment">// it to the replica's.</span></div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (replicaDirtyTimestamp &gt; info.getLastDirtyTimestamp()) &#123;</div><div class="line"><span class="number">47</span>:                     info.setLastDirtyTimestamp(replicaDirtyTimestamp);</div><div class="line"><span class="number">48</span>:                 &#125;</div><div class="line"><span class="number">49</span>:                 <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="number">50</span>:                 info.setActionType(ActionType.MODIFIED);</div><div class="line"><span class="number">51</span>:                 recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</div><div class="line"><span class="number">52</span>:                 <span class="comment">// è®¾ç½® æœ€åæ›´æ–°æ—¶é—´</span></div><div class="line"><span class="number">53</span>:                 info.setLastUpdatedTimestamp();</div><div class="line"><span class="number">54</span>:                 <span class="comment">// è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"><span class="number">55</span>:                 invalidateCache(appName, info.getVIPAddress(), info.getSecureVipAddress());</div><div class="line"><span class="number">56</span>:             &#125;</div><div class="line"><span class="number">57</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">58</span>:         &#125;</div><div class="line"><span class="number">59</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">60</span>:         <span class="comment">// é‡Šæ”¾é”</span></div><div class="line"><span class="number">61</span>:         read.unlock();</div><div class="line"><span class="number">62</span>:     &#125;</div><div class="line"><span class="number">63</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 8 è¡Œ ï¼šè·å–è¯»é”ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/?self">ã€ŠEurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 9 è‡³ 10 è¡Œ ï¼šæ·»åŠ è¦†ç›–çŠ¶æ€åˆ é™¤æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li><li>ç¬¬ 11 è‡³ 16 è¡Œ ï¼šè·å¾—ç§Ÿçº¦ã€‚</li><li>ç¬¬ 17 è‡³ 19 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›æ›´æ–°å¤±è´¥ã€‚</li><li>ç¬¬ 21 è‡³ 22 è¡Œ ï¼šè®¾ç½®ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´( ç»­ç§Ÿ )ã€‚</li><li>ç¬¬ 24 è‡³ 30 è¡Œ ï¼šæŒæœ‰ç§Ÿçº¦çš„åº”ç”¨å®ä¾‹ä¸å­˜åœ¨ï¼Œç†è®ºæ¥è¯´ä¸ä¼šå‡ºç°ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li><li>ç¬¬ 32 è‡³ 33 è¡Œ ï¼šç§»é™¤å‡ºåº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„( <code>overriddenInstanceStatusMap</code> )ã€‚</li><li>ç¬¬ 34 è¡Œ ï¼š<strong>åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€å­˜åœ¨æ‰è®¾ç½®çŠ¶æ€</strong>ã€‚</li><li>ç¬¬ 35 è‡³ 36 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€ä¸º InstanceStatus.UNKNOWNã€‚ç”¨äº Eureka-Server é›†ç¾¤åŒæ­¥ã€‚</li><li>ç¬¬ 37 è‡³ 38 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸º <code>newStatus</code>ã€‚è®¾ç½®åï¼ŒEureka-Client æ‹‰å–æ³¨å†Œä¿¡æ¯ï¼Œè¢«æ›´æ–°è¦†ç›–çŠ¶æ€çš„åº”ç”¨å®ä¾‹å°±æ˜¯è®¾ç½®çš„çŠ¶æ€ã€‚</li><li>ç¬¬ 39 è‡³ 48 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„æ•°æ®ä¸ä¸€è‡´æ—¶é—´ã€‚ç”¨äº Eureka-Server é›†ç¾¤åŒæ­¥ã€‚</li><li>ç¬¬ 49 è‡³ 51 è¡Œ ï¼šæ·»åŠ åº”ç”¨å®ä¾‹åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—ã€‚</li><li>ç¬¬ 52 è‡³ 53 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„æœ€åæ›´æ–°æ—¶é—´( <code>lastUpdatedTimestamp</code> )ã€‚<code>lastUpdatedTimestamp</code> ä¸»è¦ç”¨äºè®°å½•æœ€åæ›´æ–°æ—¶é—´ï¼Œæ— å®é™…ä¸šåŠ¡ç”¨é€”ã€‚</li><li>ç¬¬ 54 è‡³ 55 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜è¿‡æœŸã€‚</li><li>ç¬¬ 57 è¡Œ ï¼šè¿”å›æ›´æ–°æˆåŠŸã€‚</li><li>ç¬¬ 61 è¡Œ ï¼šé‡Šæ”¾è¯»é”ã€‚</li></ul><h1>4. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„</h1><p>è™½ç„¶æˆ‘ä»¬åœ¨ä¸Šé¢ä»£ç ï¼Œä½¿ç”¨è¦†ç›–çŠ¶æ€( <code>overridestatus</code> )è®¾ç½®åˆ°åº”ç”¨å®ä¾‹çš„çŠ¶æ€( <code>status</code> )ï¼Œ<strong>å®é™…è°ƒç”¨ <code>AbstractInstanceRegistry#getOverriddenInstanceStatus(...)</code> æ–¹æ³•ï¼Œæ ¹æ®åº”ç”¨å®ä¾‹çŠ¶æ€è¦†ç›–è§„åˆ™( InstanceStatusOverrideRule )è¿›è¡Œè®¡ç®—æœ€ç»ˆåº”ç”¨å®ä¾‹çš„çŠ¶æ€</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="keyword">protected</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">getOverriddenInstanceStatus</span><span class="params">(InstanceInfo r,</span></span></div><div class="line"><span class="function"><span class="params">                                                               Lease&lt;InstanceInfo&gt; existingLease,</span></span></div><div class="line"><span class="function"><span class="params">                                                               <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   InstanceStatusOverrideRule rule = getInstanceInfoOverrideRule();</div><div class="line">   logger.debug(<span class="string">"Processing override status using rule: &#123;&#125;"</span>, rule);</div><div class="line">   <span class="keyword">return</span> rule.apply(r, existingLease, isReplication).status();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> InstanceStatusOverrideRule <span class="title">getInstanceInfoOverrideRule</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#getInstanceInfoOverrideRule()</code> æ–¹æ³•ï¼Œè·å–åº”ç”¨å®ä¾‹çŠ¶æ€è¦†ç›–è§„åˆ™( InstanceStatusOverrideRule )ã€‚åœ¨ PeerAwareInstanceRegistryImpl é‡Œè¯¥æ–¹æ³•å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> InstanceStatusOverrideRule instanceStatusOverrideRule;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">PeerAwareInstanceRegistryImpl</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">            EurekaServerConfig serverConfig,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">            ServerCodecs serverCodecs,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaClient eurekaClient</span></span></div><div class="line"><span class="function"><span class="params">    )</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ–¹æ³•</span></div><div class="line">    </div><div class="line">    <span class="keyword">this</span>.instanceStatusOverrideRule = <span class="keyword">new</span> FirstMatchWinsCompositeRule(</div><div class="line">        <span class="keyword">new</span> DownOrStartingRule(),</div><div class="line">        <span class="keyword">new</span> OverrideExistsRule(overriddenInstanceStatusMap), </div><div class="line">        <span class="keyword">new</span> LeaseExistsRule());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> InstanceStatusOverrideRule <span class="title">getInstanceInfoOverrideRule</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.instanceStatusOverrideRule;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>4.1 åº”ç”¨å®ä¾‹çŠ¶æ€è¦†ç›–è§„åˆ™</h2><p><code>com.netflix.eureka.registry.rule.InstanceStatusOverrideRule</code> ï¼Œåº”ç”¨å®ä¾‹çŠ¶æ€è¦†ç›–è§„åˆ™<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceStatusOverrideRule.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstanceStatusOverrideRule</span> </span>&#123;</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line"><span class="comment">     * Match this rule.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> instanceInfo The instance info whose status we care about. å…³æ³¨çŠ¶æ€çš„åº”ç”¨å®ä¾‹å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> existingLease Does the instance have an existing lease already? If so let's consider that. å·²å­˜åœ¨çš„ç§Ÿçº¦</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> isReplication When overriding consider if we are under a replication mode from other servers. æ˜¯å¦æ˜¯ Eureka-Server å‘èµ·çš„è¯·æ±‚</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> A result with whether we matched and what we propose the status to be overriden to.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">     <span class="function">StatusOverrideResult <span class="title">apply</span><span class="params">(<span class="keyword">final</span> InstanceInfo instanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Lease&lt;InstanceInfo&gt; existingLease,</span></span></div><div class="line"><span class="function"><span class="params">                               <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// StatusOverrideResult.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusOverrideResult</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StatusOverrideResult NO_MATCH = <span class="keyword">new</span> StatusOverrideResult(<span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StatusOverrideResult <span class="title">matchingStatus</span><span class="params">(InstanceInfo.InstanceStatus status)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StatusOverrideResult(<span class="keyword">true</span>, status);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Does the rule match?</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> matches;</div><div class="line"></div><div class="line">    <span class="comment">// The status computed by the rule.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo.InstanceStatus status;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StatusOverrideResult</span><span class="params">(<span class="keyword">boolean</span> matches, InstanceInfo.InstanceStatus status)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.matches = matches;</div><div class="line">        <span class="keyword">this</span>.status = status;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> matches;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">status</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> status;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#apply(...)</code> æ–¹æ³•å‚æ•° <code>instanceInfo</code> ä»£è¡¨çš„æ˜¯<strong>å…³æ³¨çŠ¶æ€</strong>çš„åº”ç”¨å®ä¾‹ï¼Œå’Œæ–¹æ³•å‚æ•° <code>existingLease</code> é‡Œçš„åº”ç”¨å®ä¾‹ä¸ä¸€å®šæ˜¯åŒä¸€ä¸ªï¼Œåœ¨ <a href="#">ã€Œ4.1.6 æ€»ç»“ã€</a> è¯¦ç»†è§£æã€‚</li><li><code>com.netflix.eureka.registry.rule.StatusOverrideResult</code> ï¼ŒçŠ¶æ€è¦†ç›–ç»“æœã€‚å½“åŒ¹é…æˆåŠŸï¼Œè¿”å› <code>matches = true</code> ï¼›å¦åˆ™ï¼Œè¿”å› <code>matches = false</code> ã€‚</li></ul><p><strong>å®ç°ç±»å…³ç³»å¦‚ä¸‹</strong>ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_10/01.png" alt=""></p><ul><li>AsgEnabledRule ï¼Œäºšé©¬é€Š AWS ä¸“ç”¨ï¼Œè·³è¿‡ã€‚</li></ul><h3>4.1.1 FirstMatchWinsCompositeRule</h3><p><code>com.netflix.eureka.registry.rule.FirstMatchWinsCompositeRule</code> ï¼Œ<strong>å¤åˆ</strong>è§„åˆ™ï¼Œä»¥ç¬¬ä¸€ä¸ªåŒ¹é…æˆåŠŸä¸ºå‡†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstMatchWinsCompositeRule</span> <span class="keyword">implements</span> <span class="title">InstanceStatusOverrideRule</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤åˆè§„åˆ™é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceStatusOverrideRule[] rules;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é»˜è®¤è§„åˆ™</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceStatusOverrideRule defaultRule;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String compositeRuleName;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FirstMatchWinsCompositeRule</span><span class="params">(InstanceStatusOverrideRule... rules)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.rules = rules;</div><div class="line">        <span class="keyword">this</span>.defaultRule = <span class="keyword">new</span> AlwaysMatchInstanceStatusRule();</div><div class="line">        <span class="comment">// Let's build up and "cache" the rule name to be used by toString();</span></div><div class="line">        List&lt;String&gt; ruleNames = <span class="keyword">new</span> ArrayList&lt;&gt;(rules.length+<span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.length; ++i) &#123;</div><div class="line">            ruleNames.add(rules[i].toString());</div><div class="line">        &#125;</div><div class="line">        ruleNames.add(defaultRule.toString());</div><div class="line">        compositeRuleName = ruleNames.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> StatusOverrideResult <span class="title">apply</span><span class="params">(InstanceInfo instanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                      Lease&lt;InstanceInfo&gt; existingLease,</span></span></div><div class="line"><span class="function"><span class="params">                                      <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">        <span class="comment">// ä½¿ç”¨å¤åˆè§„åˆ™ï¼Œé¡ºåºåŒ¹é…ï¼Œç›´åˆ°åŒ¹é…æˆåŠŸ</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.rules.length; ++i) &#123;</div><div class="line">            StatusOverrideResult result = <span class="keyword">this</span>.rules[i].apply(instanceInfo, existingLease, isReplication);</div><div class="line">            <span class="keyword">if</span> (result.matches()) &#123;</div><div class="line">                <span class="keyword">return</span> result;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ä½¿ç”¨é»˜è®¤è§„åˆ™</span></div><div class="line">        <span class="keyword">return</span> defaultRule.apply(instanceInfo, existingLease, isReplication);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.compositeRuleName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>rules</code> å±æ€§ï¼Œ<strong>å¤åˆ</strong>è§„åˆ™é›†åˆã€‚åœ¨ PeerAwareInstanceRegistryImpl é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥å±æ€§ä¸º [ DownOrStartingRule , OverrideExistsRule , LeaseExistsRule ] ã€‚</li><li><code>defaultRule</code> å±æ€§ï¼Œé»˜è®¤è§„åˆ™ï¼Œå€¼ä¸º AlwaysMatchInstanceStatusRule ã€‚</li><li><code>#apply()</code> æ–¹æ³•ï¼Œä¼˜å…ˆä½¿ç”¨<strong>å¤åˆ</strong>è§„åˆ™( <code>rules</code> )ï¼Œé¡ºåºåŒ¹é…ï¼Œç›´åˆ°åŒ¹é…æˆåŠŸ ã€‚å½“æœªåŒ¹é…æˆåŠŸï¼Œä½¿ç”¨é»˜è®¤è§„åˆ™( <code>defaultRule</code> ) ã€‚</li></ul><h3>4.1.2 DownOrStartingRule</h3><p><code>com.netflix.eureka.registry.rule.DownOrStartingRule</code> ï¼ŒåŒ¹é… <code>InstanceInfo.InstanceStatus.DOWN</code> æˆ–è€… <code>InstanceInfo.InstanceStatus.STARTING</code> çŠ¶æ€ã€‚å®ç° <code>#apply(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> StatusOverrideResult <span class="title">apply</span><span class="params">(InstanceInfo instanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                 Lease&lt;InstanceInfo&gt; existingLease,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ReplicationInstance is DOWN or STARTING - believe that, but when the instance says UP, question that</span></div><div class="line">   <span class="comment">// The client instance sends STARTING or DOWN (because of heartbeat failures), then we accept what</span></div><div class="line">   <span class="comment">// the client says. The same is the case with replica as well.</span></div><div class="line">   <span class="comment">// The OUT_OF_SERVICE from the client or replica needs to be confirmed as well since the service may be</span></div><div class="line">   <span class="comment">// currently in SERVICE</span></div><div class="line">   <span class="keyword">if</span> ((!InstanceInfo.InstanceStatus.UP.equals(instanceInfo.getStatus()))</div><div class="line">           &amp;&amp; (!InstanceInfo.InstanceStatus.OUT_OF_SERVICE.equals(instanceInfo.getStatus()))) &#123;</div><div class="line">       logger.debug(<span class="string">"Trusting the instance status &#123;&#125; from replica or instance for instance &#123;&#125;"</span>,</div><div class="line">               instanceInfo.getStatus(), instanceInfo.getId());</div><div class="line">       <span class="keyword">return</span> StatusOverrideResult.matchingStatus(instanceInfo.getStatus());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> StatusOverrideResult.NO_MATCH;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼Œä½¿ç”¨çš„æ˜¯ <code>instanceInfo</code> ã€‚</li></ul><h3>4.1.3 OverrideExistsRule</h3><p><code>com.netflix.eureka.registry.rule.OverrideExistsRule</code> ï¼ŒåŒ¹é…åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„( <code>statusOverrides</code> ) ã€‚å®ç° <code>#apply(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverrideExistsRule</span> <span class="keyword">implements</span> <span class="title">InstanceStatusOverrideRule</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> Map&lt;String, InstanceInfo.InstanceStatus&gt; statusOverrides;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> StatusOverrideResult <span class="title">apply</span><span class="params">(InstanceInfo instanceInfo, Lease&lt;InstanceInfo&gt; existingLease, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">        InstanceInfo.InstanceStatus overridden = statusOverrides.get(instanceInfo.getId());</div><div class="line">        <span class="comment">// If there are instance specific overrides, then they win - otherwise the ASG status</span></div><div class="line">        <span class="keyword">if</span> (overridden != <span class="keyword">null</span>) &#123;</div><div class="line">            logger.debug(<span class="string">"The instance specific override for instance &#123;&#125; and the value is &#123;&#125;"</span>,</div><div class="line">                    instanceInfo.getId(), overridden.name());</div><div class="line">            <span class="keyword">return</span> StatusOverrideResult.matchingStatus(overridden);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> StatusOverrideResult.NO_MATCH;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>statusOverrides</code> å±æ€§ï¼Œåº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ã€‚åœ¨ PeerAwareInstanceRegistryImpl é‡Œï¼Œä½¿ç”¨ <code>AbstractInstanceRegistry.overriddenInstanceStatusMap</code> å±æ€§èµ‹å€¼ã€‚</li><li>ä¸Šæ–‡æˆ‘ä»¬æåˆ° <code>AbstractInstanceRegistry.overriddenInstanceStatusMap</code>  æ¯æ¬¡è®¿é—®åˆ·æ–°æœ‰æ•ˆæœŸï¼Œå¦‚æœè°ƒç”¨åˆ° OverrideExistsRule ï¼Œåˆ™ä¼šä¸æ–­åˆ·æ–°ã€‚ä» DownOrStartingRule çœ‹åˆ°ï¼Œ<code>instanceInfo</code> å¤„äº <code>InstanceInfo.InstanceStatus.DOWN</code> æˆ–è€… <code>InstanceInfo.InstanceStatus.STARTING</code> æ‰ä¸ä¼šç»§ç»­è°ƒç”¨ OverrideExistsRule åŒ¹é…ï¼Œ<code>AbstractInstanceRegistry.overriddenInstanceStatusMap</code> æ‰æœ‰å¯èƒ½è¿‡æœŸã€‚</li></ul><h3>4.1.4 LeaseExistsRule</h3><p><code>com.netflix.eureka.registry.rule.LeaseExistsRule</code> ï¼ŒåŒ¹é…å·²å­˜åœ¨ç§Ÿçº¦çš„åº”ç”¨å®ä¾‹çš„ <code>nstanceStatus.OUT_OF_SERVICE</code> æˆ–è€… <code>InstanceInfo.InstanceStatus.UP</code> çŠ¶æ€ã€‚å®ç° <code>#apply(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> StatusOverrideResult <span class="title">apply</span><span class="params">(InstanceInfo instanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                 Lease&lt;InstanceInfo&gt; existingLease,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// This is for backward compatibility until all applications have ASG</span></div><div class="line">   <span class="comment">// names, otherwise while starting up</span></div><div class="line">   <span class="comment">// the client status may override status replicated from other servers</span></div><div class="line">   <span class="keyword">if</span> (!isReplication) &#123; <span class="comment">// é Eureka-Server è¯·æ±‚</span></div><div class="line">       InstanceInfo.InstanceStatus existingStatus = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123;</div><div class="line">           existingStatus = existingLease.getHolder().getStatus();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Allow server to have its way when the status is UP or OUT_OF_SERVICE</span></div><div class="line">       <span class="keyword">if</span> ((existingStatus != <span class="keyword">null</span>)</div><div class="line">               &amp;&amp; (InstanceInfo.InstanceStatus.OUT_OF_SERVICE.equals(existingStatus)</div><div class="line">               || InstanceInfo.InstanceStatus.UP.equals(existingStatus))) &#123;</div><div class="line">           logger.debug(<span class="string">"There is already an existing lease with status &#123;&#125;  for instance &#123;&#125;"</span>,</div><div class="line">                   existingLease.getHolder().getStatus().name(),</div><div class="line">                   existingLease.getHolder().getId());</div><div class="line">           <span class="keyword">return</span> StatusOverrideResult.matchingStatus(existingLease.getHolder().getStatus());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> StatusOverrideResult.NO_MATCH;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼Œä½¿ç”¨çš„æ˜¯ <code>existingLease</code> ï¼Œå¹¶ä¸”é Eureka-Server è¯·æ±‚ã€‚</li></ul><h3>4.1.5 AlwaysMatchInstanceStatusRule</h3><p><code>com.netflix.eureka.registry.rule.AlwaysMatchInstanceStatusRule</code> ï¼Œæ€»æ˜¯åŒ¹é…<strong>å…³æ³¨çŠ¶æ€çš„å®ä¾‹å¯¹è±¡</strong>( <code>instanceInfo</code> )çš„çŠ¶æ€ã€‚å®ç° <code>#apply(...)</code> ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> StatusOverrideResult <span class="title">apply</span><span class="params">(InstanceInfo instanceInfo,</span></span></div><div class="line"><span class="function"><span class="params">                                 Lease&lt;InstanceInfo&gt; existingLease,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   logger.debug(<span class="string">"Returning the default instance status &#123;&#125; for instance &#123;&#125;"</span>, instanceInfo.getStatus(),</div><div class="line">           instanceInfo.getId());</div><div class="line">   <span class="keyword">return</span> StatusOverrideResult.matchingStatus(instanceInfo.getStatus());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>æ³¨æ„</strong>ï¼Œä½¿ç”¨çš„æ˜¯ <code>instanceInfo</code> ã€‚</li></ul><h3>4.1.6 æ€»ç»“</h3><p>æˆ‘ä»¬å°† PeerAwareInstanceRegistryImpl çš„åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€è§„åˆ™æ¢³ç†å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_10/02.png" alt=""></p><ul><li>åº”ç”¨å®ä¾‹çŠ¶æ€æ˜¯<strong>æœ€é‡è¦</strong>çš„å±æ€§ï¼Œæ²¡æœ‰ä¹‹ä¸€ï¼Œå› è€Œåœ¨æœ€ç»ˆå®ä¾‹çŠ¶æ€çš„è®¡ç®—ï¼Œä»¥<strong>å¯ä¿¡èµ–</strong>ä¸ºä¸»ã€‚</li><li>DownOrStartingRule ï¼Œ<code>instanceInfo</code> å¤„äº <code>STARTING</code> æˆ–è€… <code>DOWN</code> çŠ¶æ€ï¼Œåº”ç”¨å®ä¾‹å¯èƒ½ä¸é€‚åˆæä¾›æœåŠ¡( è¢«è¯·æ±‚ )ï¼Œè€ƒè™‘<strong>å¯ä¿¡èµ–</strong>ï¼Œè¿”å› <code>instanceInfo</code> çš„çŠ¶æ€ã€‚</li><li>OverrideExistsRule ï¼Œå½“å­˜åœ¨è¦†ç›–çŠ¶æ€( <code>statusoverrides</code> ) ï¼Œä½¿ç”¨è¯¥çŠ¶æ€ï¼Œæ¯”è¾ƒå¥½ç†è§£ã€‚</li><li>LeaseExistsRule ï¼Œæ¥è‡ª Eureka-Client çš„è¯·æ±‚( é Eureka-Server é›†ç¾¤è¯·æ±‚)ï¼Œå½“ Eureka-Server çš„å®ä¾‹çŠ¶æ€<strong>å­˜åœ¨</strong>ï¼Œå¹¶ä¸”å¤„äº <code>UP</code> æˆ–åˆ™ <code>OUT_OF_SERVICE</code> ï¼Œä¿ç•™å½“å‰çŠ¶æ€ã€‚åŸå› ï¼Œ<strong>ç¦æ­¢ Eureka-Client ä¸»åŠ¨åœ¨è¿™ä¸¤ä¸ªçŠ¶æ€ä¹‹é—´åˆ‡æ¢ã€‚å¦‚æœè¦åˆ‡æ¢ï¼Œä½¿ç”¨åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€å˜æ›´ä¸åˆ é™¤æ¥å£</strong>ã€‚</li><li>AlwaysMatchInstanceStatusRule ï¼Œä½¿ç”¨ <code>instanceInfo</code> çš„çŠ¶æ€è¿”å›ï¼Œä»¥ä¿è¯èƒ½åŒ¹é…åˆ°çŠ¶æ€ã€‚</li><li>åœ¨ä¸‹æ–‡ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ï¼Œ<code>#getOverriddenInstanceStatus()</code> æ–¹æ³•ä¼šåœ¨<strong>æ³¨å†Œ</strong>å’Œ<strong>ç»­ç§Ÿ</strong>ä½¿ç”¨åˆ°ã€‚ç»“åˆä¸Šå›¾ï¼Œæˆ‘ä»¬åœ¨ <a href="#">ã€Œ4.2 æ³¨å†Œåœºæ™¯ã€</a> å’Œ <a href="#">ã€Œ4.3 ç»­ç§Ÿåœºæ™¯ã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li></ul><ul><li>åœ¨ä¸‹æ–‡ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ï¼Œ<code>#getOverriddenInstanceStatus()</code> æ–¹æ³•ä¼šåœ¨<strong>æ³¨å†Œ</strong>å’Œ<strong>ç»­ç§Ÿ</strong>ä½¿ç”¨åˆ°ï¼Œæ–¹æ³•å‚æ•° <code>instanceInfo</code> æƒ…å†µå¦‚ä¸‹ï¼š<ul><li><strong>æ³¨å†Œæ—¶</strong> ï¼šè¯·æ±‚å‚æ•° <code>instanceInfo</code> ï¼Œå’Œ <code>existingLease</code> çš„åº”ç”¨å®ä¾‹å±æ€§ä¸ç›¸ç­‰( å¦‚æœè€ƒè™‘ Eureka-Server çš„ <code>LastDirtyTimestamp</code> æ›´å¤§çš„æƒ…å†µï¼Œåˆ™ç±»ä¼¼ <strong>ç»­ç§Ÿæ—¶çš„æƒ…å†µ</strong> ) ã€‚</li><li><strong>ç»­ç§Ÿæ—¶</strong> ï¼šä½¿ç”¨ Eureka-Server çš„ <code>existingLease</code> çš„åº”ç”¨å®ä¾‹ï¼Œä¸¤è€…ç›¸ç­‰ã€‚</li><li><strong>æ€»çš„æ¥è¯´ï¼Œå¯ä»¥å°† <code>instanceInfo</code> ç†è§£æˆè¯·æ±‚æ–¹çš„çŠ¶æ€</strong>ã€‚</li></ul></li><li>DownOrStartingRule ï¼Œ</li></ul><h2>4.2 æ³¨å†Œåœºæ™¯</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">3</span>:         <span class="comment">// ï¼ˆ(çœç•¥ä»£ç ) ï¼‰è·å–é”</span></div><div class="line">  <span class="number">4</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</div><div class="line">  <span class="number">5</span>:         <span class="comment">// (çœç•¥ä»£ç ) å¢åŠ  æ³¨å†Œæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line">  <span class="number">6</span>:         <span class="comment">// (çœç•¥ä»£ç ) è·å¾— åº”ç”¨å®ä¾‹ä¿¡æ¯ å¯¹åº”çš„ ç§Ÿçº¦</span></div><div class="line">  <span class="number">7</span>:         Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</div><div class="line">  <span class="number">8</span>:         <span class="comment">// Retain the last dirty timestamp without overwriting it, if there is already a lease</span></div><div class="line">  <span class="number">9</span>:         <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123; <span class="comment">// (çœç•¥ä»£ç ) å·²å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ•°æ®ä¸ä¸€è‡´çš„æ—¶é—´å¤§çš„åº”ç”¨æ³¨å†Œä¿¡æ¯ä¸ºæœ‰æ•ˆçš„</span></div><div class="line"> <span class="number">10</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">11</span>:             <span class="comment">// The lease does not exist and hence it is a new registration</span></div><div class="line"> <span class="number">12</span>:             <span class="comment">// (çœç•¥ä»£ç ) ã€è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‘å¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line"> <span class="number">13</span>:         &#125;</div><div class="line"> <span class="number">14</span>:         <span class="comment">// åˆ›å»º ç§Ÿçº¦</span></div><div class="line"> <span class="number">15</span>:         Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</div><div class="line"> <span class="number">16</span>:         <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123; <span class="comment">// è‹¥ç§Ÿçº¦å·²å­˜åœ¨ï¼Œè®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³</span></div><div class="line"> <span class="number">17</span>:             lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</div><div class="line"> <span class="number">18</span>:         &#125;</div><div class="line"> <span class="number">19</span>:         <span class="comment">// æ·»åŠ åˆ° ç§Ÿçº¦æ˜ å°„</span></div><div class="line"> <span class="number">20</span>:         gMap.put(registrant.getId(), lease);</div><div class="line"> <span class="number">21</span>:         <span class="comment">// (çœç•¥ä»£ç ) æ·»åŠ åˆ° æœ€è¿‘æ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"> <span class="number">22</span>:         <span class="comment">// (çœç•¥ä»£ç ) æ·»åŠ åˆ° åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ï¼ˆEureka-Server åˆå§‹åŒ–ä½¿ç”¨ï¼‰</span></div><div class="line"> <span class="number">23</span>:         <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€</span></div><div class="line"> <span class="number">24</span>:         InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">26</span>:             logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</div><div class="line"> <span class="number">27</span>:             registrant.setOverriddenStatus(overriddenStatusFromMap);</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line"> <span class="number">31</span>:         <span class="comment">// Set the status based on the overridden status rules</span></div><div class="line"> <span class="number">32</span>:         InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</div><div class="line"> <span class="number">33</span>:         <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line"> <span class="number">34</span>:         registrant.setStatusWithoutDirty(overriddenInstanceStatus);</div><div class="line"> <span class="number">35</span>: </div><div class="line"> <span class="number">36</span>:         <span class="comment">// (çœç•¥ä»£ç ) è®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆï¼‰</span></div><div class="line"> <span class="number">37</span>:         <span class="comment">// (çœç•¥ä»£ç ) è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ“ä½œç±»å‹ ä¸º æ·»åŠ </span></div><div class="line"> <span class="number">38</span>:         <span class="comment">// (çœç•¥ä»£ç ) æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"> <span class="number">39</span>:         <span class="comment">// (çœç•¥ä»£ç ) è®¾ç½® ç§Ÿçº¦çš„æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"> <span class="number">40</span>:         <span class="comment">// (çœç•¥ä»£ç ) è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"> <span class="number">41</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">42</span>:         <span class="comment">// (çœç•¥ä»£ç ) é‡Šæ”¾é”</span></div><div class="line"> <span class="number">43</span>:     &#125;</div><div class="line"> <span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è¡Œ ï¼šè·å¾—<strong>å·²å­˜åœ¨</strong>çš„ç§Ÿçº¦( <code>existingLease</code> ) ã€‚</li><li>ç¬¬ 15 è¡Œ ï¼šåˆ›å»º<strong>æ–°çš„</strong>ç§Ÿçº¦( <code>lease</code> )ã€‚</li><li>ç¬¬ 24 è‡³ 28 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€( <code>overridestatus</code> )ï¼Œé¿å…æ³¨å†Œåº”ç”¨å®ä¾‹åï¼Œä¸¢å¤±è¦†ç›–çŠ¶æ€ã€‚</li><li>ç¬¬ 30 è‡³ 32 è¡Œ ï¼š<strong>è·å¾—åº”ç”¨å®ä¾‹æœ€ç»ˆçŠ¶æ€</strong>ã€‚æ³¨æ„ä¸‹ï¼Œä¸è€ƒè™‘ç¬¬ 9 è¡Œä»£ç çš„æƒ…å†µï¼Œ<code>registrant</code> å’Œ <code>existingLease</code> çš„åº”ç”¨å®ä¾‹ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</li><li>ç¬¬ 33 åª 34 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„çŠ¶æ€ã€‚</li></ul><h2>4.3 ç»­ç§Ÿåœºæ™¯</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰å¢åŠ  ç»­ç§Ÿæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line">  <span class="number">3</span>:     <span class="comment">// è·å¾— ç§Ÿçº¦</span></div><div class="line">  <span class="number">4</span>:     Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line">  <span class="number">5</span>:     Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</div><div class="line">  <span class="number">6</span>:     <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">7</span>:         leaseToRenew = gMap.get(id);</div><div class="line">  <span class="number">8</span>:     &#125;</div><div class="line">  <span class="number">9</span>:     <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">11</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">12</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">13</span>:         InstanceInfo instanceInfo = leaseToRenew.getHolder();</div><div class="line"> <span class="number">14</span>:         <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">15</span>:             <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line"> <span class="number">16</span>:             InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</div><div class="line"> <span class="number">17</span>:                     instanceInfo, leaseToRenew, isReplication);</div><div class="line"> <span class="number">18</span>:             <span class="comment">// åº”ç”¨å®ä¾‹çŠ¶æ€æœªçŸ¥ï¼Œæ— æ³•ç»­çº¦</span></div><div class="line"> <span class="number">19</span>:             <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</div><div class="line"> <span class="number">20</span>:                 logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></div><div class="line"> <span class="number">21</span>:                         + <span class="string">"; re-register required"</span>, instanceInfo.getId());</div><div class="line"> <span class="number">22</span>:                 RENEW_NOT_FOUND.increment(isReplication);</div><div class="line"> <span class="number">23</span>:                 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">24</span>:             &#125;</div><div class="line"> <span class="number">25</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line"> <span class="number">26</span>:             <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</div><div class="line"> <span class="number">27</span>:                 Object[] args = &#123;</div><div class="line"> <span class="number">28</span>:                         instanceInfo.getStatus().name(),</div><div class="line"> <span class="number">29</span>:                         instanceInfo.getOverriddenStatus().name(),</div><div class="line"> <span class="number">30</span>:                         instanceInfo.getId()</div><div class="line"> <span class="number">31</span>:                 &#125;;</div><div class="line"> <span class="number">32</span>:                 logger.info(</div><div class="line"> <span class="number">33</span>:                         <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></div><div class="line"> <span class="number">34</span>:                                 + <span class="string">"Hence setting the status to overridden status"</span>, args);</div><div class="line"> <span class="number">35</span>:                 instanceInfo.setStatusWithoutDirty(overriddenInstanceStatus);</div><div class="line"> <span class="number">36</span>:             &#125;</div><div class="line"> <span class="number">37</span>:         &#125;</div><div class="line"> <span class="number">38</span>:         <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰æ–°å¢ ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</span></div><div class="line"> <span class="number">39</span>:         <span class="comment">// ï¼ˆçœç•¥ä»£ç ï¼‰è®¾ç½® ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´ï¼ˆç»­ç§Ÿï¼‰</span></div><div class="line"> <span class="number">40</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">41</span>:     &#125;</div><div class="line"> <span class="number">42</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 15 è‡³ 17 è¡Œ ï¼šè·å¾—åº”ç”¨å®ä¾‹çš„<strong>æœ€ç»ˆçŠ¶æ€</strong>ã€‚</li><li>ç¬¬ 18 è‡³ 24 è¡Œ ï¼šåº”ç”¨å®ä¾‹çš„<strong>æœ€ç»ˆçŠ¶æ€</strong>ä¸º <code>UNKNOWN</code>ï¼Œæ— æ³•ç»­çº¦ ã€‚è¿”å› <code>false</code> åï¼Œè¯·æ±‚æ–¹( Eureka-Client æˆ–è€… Eureka-Server é›†ç¾¤å…¶ä»–èŠ‚ç‚¹ )ä¼šå‘èµ·æ³¨å†Œï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> æœ‰è¯¦ç»†è§£æã€‚<strong>ä¸ºä»€ä¹ˆä¼šæ˜¯ <code>UNKNOWN</code> å‘¢</strong>ï¼Ÿåœ¨ <a href="#">ã€Œ3. åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€åˆ é™¤æ¥å£ã€</a> ä¼ é€’åº”ç”¨å®ä¾‹çŠ¶æ€ä¸º <code>UNKNOWN</code> ã€‚</li><li>ç¬¬ 25 è‡³ 36 è¡Œ ï¼šåº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸<strong>æœ€ç»ˆçŠ¶æ€</strong>ä¸ç›¸ç­‰ï¼Œä½¿ç”¨<strong>æœ€ç»ˆçŠ¶æ€</strong>è¦†ç›–åº”ç”¨å®ä¾‹çš„çŠ¶æ€ã€‚<strong>ä¸ºä»€ä¹ˆä¼šä¸ç›¸ç­‰</strong>å‘¢ï¼Ÿ<code>#renew(...)</code> å’Œ <code>#statusUpdate(...)</code> å¯ä»¥æ— é”ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå¦‚æœ<ul><li><code>#renew(...)</code> æ‰§è¡Œå®Œç¬¬ 16 è¡Œä»£ç ï¼Œè·å–åˆ° <code>overriddenInstanceStatus</code> åï¼Œæ°å·§ <code>#statusUpdate(...)</code> æ‰§è¡Œå®Œæ›´æ–°åº”ç”¨å®ä¾‹çŠ¶æ€ <code>newStatus</code>ï¼Œåˆæ°å¥½ä¸¤è€…ä¸ç›¸ç­‰ï¼Œä½¿ç”¨ <code>overriddenInstanceStatus</code> è¦†ç›–æ‰åº”ç”¨å®ä¾‹çš„ <code>newStatus</code> çŠ¶æ€ã€‚</li><li><strong>é‚£å²‚ä¸æ˜¯è¦†ç›–çŠ¶æ€( <code>overriddenstatus</code> )åå€’è¢«è¦†ç›–</strong>ï¼Ÿï¼Ÿï¼Ÿä¸ä¼šï¼Œåœ¨ä¸‹ä¸€æ¬¡å¿ƒè·³ï¼Œåº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¼šè¢«ä¿®æ­£å›æ¥ã€‚å½“ç„¶ï¼Œå¦‚æœåº”ç”¨å®ä¾‹çŠ¶æ€å¦‚æœä¸º <code>UP</code> æˆ–è€… <code>STARTING</code> ä¸ä¼šè¢«ä¿®æ­£ï¼Œä¹Ÿä¸åº”è¯¥è¢«ä¿®æ­£ã€‚</li></ul></li></ul><h2>4.4 ä¸‹çº¿åœºæ™¯</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">internalCancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„</span></div><div class="line">    InstanceStatus instanceStatus = overriddenInstanceStatusMap.remove(id);</div><div class="line">    <span class="keyword">if</span> (instanceStatus != <span class="keyword">null</span>) &#123;</div><div class="line">        logger.debug(<span class="string">"Removed instance id &#123;&#125; from the overridden map which has value &#123;&#125;"</span>, id, instanceStatus.name());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.5 è¿‡æœŸåœºæ™¯</h2><p>åŒ <a href="#">ã€Œ4.4 ä¸‹çº¿åœºæ™¯ã€</a> ç›¸åŒã€‚</p><h1>5. å®¢æˆ·ç«¯è°ƒç”¨æ¥å£</h1><p>å¯¹åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€çš„å˜æ›´å’Œåˆ é™¤æ¥å£è°ƒç”¨ï¼Œç‚¹å‡»å¦‚ä¸‹æ–¹æ³•æŸ¥çœ‹ï¼Œéå¸¸æ˜“æ‡‚ï¼Œæœ¬æ–‡å°±ä¸å•°å—¦äº†ï¼š</p><ul><li><a href="https://github.com/Netflix/eureka/blob/d2dbee8a79b3c6dd9b553eb3f702f7721797bcd6/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/AbstractJerseyEurekaHttpClient.java#L119" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractJerseyEurekaHttpClient#statusUpdate(...)</code></a></li><li><a href="https://github.com/Netflix/eureka/blob/d2dbee8a79b3c6dd9b553eb3f702f7721797bcd6/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/AbstractJerseyEurekaHttpClient.java#L142" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractJerseyEurekaHttpClient#deleteStatusOverride(...)</code></a></li></ul><h1>666. å½©è›‹</h1><p>çŒœæµ‹è¦†ç›–çŠ¶æ€çš„èŠ±è´¹äº†è¾ƒé•¿æ—¶é—´ï¼Œæ¢³ç†åº”ç”¨å®ä¾‹è¦†ç›–è§„åˆ™è€—è´¹å¤§é‡è„‘ç»†èƒã€‚</p><p>ä¸‹ä¸€ç¯‡ï¼Œè®©æˆ‘é¸¡é¸¡åŠ¨åŠ¨çš„ï¼ŒEureka-Server é›†ç¾¤åŒæ­¥èµ°èµ·ï¼</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-override-status/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/stron
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/</id>
    <published>2018-07-02T16:00:00.000Z</published>
    <updated>2017-10-18T18:03:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">2.1 è®¡ç®—å…¬å¼</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">2.2 åˆç†æ€§</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3. Eureka-Client å‘èµ·å¢é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.1 åˆå¹¶åº”ç”¨é›†åˆ</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">4. Eureka-Server æ¥æ”¶å…¨é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.2 æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.3 ç¼“å­˜è¯»å–</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server è·å–å¢é‡æ³¨å†Œä¿¡æ¯çš„è¿‡ç¨‹</strong>ã€‚</p><p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a></p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/01.png" alt=""></p></blockquote><p>Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œåˆ†æˆ<strong>å…¨é‡è·å–</strong>å’Œ<strong>å¢é‡è·å–</strong>ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒEureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡<strong>å…¨é‡</strong>è·å–è¿›è¡Œ<strong>æœ¬åœ°ç¼“å­˜</strong>æ³¨å†Œä¿¡æ¯ï¼Œè€Œåæ¯ <strong>30</strong> ç§’<strong>å¢é‡</strong>è·å–åˆ·æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>( éâ€œ<strong>æ­£å¸¸</strong>â€æƒ…å†µä¸‹ä¼šæ˜¯å…¨é‡è·å– )ã€‚</p><p>æœ¬æ–‡é‡ç‚¹åœ¨äº<strong>å¢é‡è·å–</strong>ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </h1><p><code>Applications.appsHashCode</code> ï¼Œåº”ç”¨é›†åˆ<strong>ä¸€è‡´æ€§å“ˆå¸Œç </strong>ã€‚</p><p><strong>å¢é‡</strong>è·å–æ³¨å†Œçš„åº”ç”¨é›†åˆ( Applications ) æ—¶ï¼ŒEureka-Client ä¼šè·å–åˆ°ï¼š</p><ol><li>Eureka-Server è¿‘æœŸå˜åŒ–( æ³¨å†Œã€ä¸‹çº¿ )çš„åº”ç”¨é›†åˆ</li><li>Eureka-Server åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </li></ol><p>Eureka-Client å°†<strong>å˜åŒ–</strong>çš„åº”ç”¨é›†åˆå’Œ<strong>æœ¬åœ°ç¼“å­˜</strong>çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶åè¿›è¡Œè®¡ç®—æœ¬åœ°çš„åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ã€‚è‹¥ä¸¤ä¸ª<strong>å“ˆå¸Œç </strong>ç›¸ç­‰ï¼Œæ„å‘³ç€å¢é‡è·å–æˆåŠŸï¼›è‹¥ä¸ç›¸ç­‰ï¼Œæ„å‘³ç€å¢é‡è·å–å¤±è´¥ï¼ŒEureka-Client é‡æ–°å’Œ Eureka-Server <strong>å…¨é‡</strong>è·å–åº”ç”¨é›†åˆã€‚</p><p>Eureka æ¯”è¾ƒåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ï¼Œå’Œæ—¥å¸¸æˆ‘ä»¬é€šè¿‡å“ˆå¸Œç æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ç±»ä¼¼ã€‚</p><h2>2.1 è®¡ç®—å…¬å¼</h2><p><code>appsHashCode = ${status}_${count}_</code></p><ul><li><p>ä½¿ç”¨æ¯ä¸ªåº”ç”¨å®ä¾‹çŠ¶æ€( <code>status</code> ) + æ•°é‡( <code>count</code> )æ‹¼æ¥å‡ºä¸€è‡´æ€§å“ˆå¸Œç ã€‚è‹¥æ•°é‡ä¸º 0 ï¼Œè¯¥åº”ç”¨å®ä¾‹çŠ¶æ€ä¸è¿›è¡Œæ‹¼æ¥ã€‚<strong>çŠ¶æ€ä»¥å­—ç¬¦ä¸²å¤§å°æ’åº</strong>ã€‚</p></li><li><p>ä¸¾ä¸ªä¾‹å­ï¼Œ8 ä¸ª UP ï¼Œ0 ä¸ª DOWN ï¼Œåˆ™ <code>appsHashCode = UP_8_</code> ã€‚8 ä¸ª UP ï¼Œ2 ä¸ª DOWN ï¼Œåˆ™ <code>appsHashCode = DOWN_2_UP_8_</code> ã€‚</p></li><li><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getReconcileHashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è®¡æ•°é›†åˆ keyï¼šåº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line">   TreeMap&lt;String, AtomicInteger&gt; instanceCountMap = <span class="keyword">new</span> TreeMap&lt;String, AtomicInteger&gt;();</div><div class="line">   populateInstanceCountMap(instanceCountMap);</div><div class="line">   <span class="comment">// è®¡ç®— hashcode</span></div><div class="line">   <span class="keyword">return</span> getReconcileHashCode(instanceCountMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#populateInstanceCountMap()</code> æ–¹æ³•ï¼Œè®¡ç®—æ¯ä¸ªåº”ç”¨å®ä¾‹çŠ¶æ€çš„æ•°é‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">populateInstanceCountMap</span><span class="params">(Map&lt;String, AtomicInteger&gt; instanceCountMap)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Application app : <span class="keyword">this</span>.getRegisteredApplications()) &#123;</div><div class="line">       <span class="keyword">for</span> (InstanceInfo info : app.getInstancesAsIsFromEureka()) &#123;</div><div class="line">           <span class="comment">// è®¡æ•°</span></div><div class="line">           AtomicInteger instanceCount = instanceCountMap.computeIfAbsent(info.getStatus().name(),</div><div class="line">                   k -&gt; <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>));</div><div class="line">           instanceCount.incrementAndGet();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Application&gt; <span class="title">getRegisteredApplications</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Application&gt;(<span class="keyword">this</span>.applications);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesAsIsFromEureka</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (instances) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;InstanceInfo&gt;(<span class="keyword">this</span>.instances);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è®¡æ•°é‚£å—ä»£ç ï¼Œä½¿ç”¨ Integer å³å¯ï¼Œæ— éœ€ä½¿ç”¨ AtomicInteger ã€‚</li></ul></li></ul></li><li><p>è°ƒç”¨ <code>#getReconcileHashCode()</code> æ–¹æ³•ï¼Œè®¡ç®— <code>hashcode</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getReconcileHashCode</span><span class="params">(Map&lt;String, AtomicInteger&gt; instanceCountMap)</span> </span>&#123;</div><div class="line">   StringBuilder reconcileHashCode = <span class="keyword">new</span> StringBuilder(<span class="number">75</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, AtomicInteger&gt; mapEntry : instanceCountMap.entrySet()) &#123;</div><div class="line">       reconcileHashCode.append(mapEntry.getKey()).append(STATUS_DELIMITER) <span class="comment">// status</span></div><div class="line">               .append(mapEntry.getValue().get()).append(STATUS_DELIMITER); <span class="comment">// count</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> reconcileHashCode.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>2.2 åˆç†æ€§</h2><p><strong>æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„</strong><br><strong>æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„</strong><br><strong>æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„</strong></p><p>ç¬”è€…åˆšçœ‹å®Œåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è®¡ç®—å…¬å¼ï¼Œå¤„äºä¸€è„¸æ‡µé€¼çš„çŠ¶æ€ã€‚è¿™ä¹ˆç²¾ç®€çš„æ–¹å¼çœŸçš„èƒ½å¤Ÿæ ¡éªŒå‡ºæ•°æ®çš„ä¸€è‡´æ€§ä¹ˆï¼Ÿä¸æ™“å¾—æœ‰å¤šå°‘è¯»è€…è·Ÿç¬”è€…æœ‰ä¸€æ ·çš„ç–‘æƒ‘ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è®ºè¯è¯¥ç®—æ³•çš„åˆç†æ€§( ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“ )ã€‚</p><p>ä¸€è‡´æ€§å“ˆå¸Œå€¼é€šè¿‡<strong>çŠ¶æ€ + æ•°é‡</strong>æ¥è®¡ç®—ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯èƒ½çŠ¶æ€æ€»æ•°æ˜¯ä¸€æ ·å¤šï¼Œå®é™…åˆ†å¸ƒåœ¨ä¸åŒçš„åº”ç”¨ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬åˆ—ä¸¾æ¨¡å‹å¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th>UP</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m</td></tr><tr><td>åº”ç”¨B</td><td>n</td></tr></tbody></table><p>å¦‚æœæ­¤æ—¶åº”ç”¨A ä¸‹çº¿äº† c ä¸ªåŸåº”ç”¨å®ä¾‹ï¼Œåº”ç”¨B æ³¨å†Œäº† c ä¸ªä¿¡åº”ç”¨å®ä¾‹ï¼Œé‚£ä¹ˆå¤„äº UP çŠ¶æ€çš„æ•°é‡ä»ç„¶æ˜¯ m + n ä¸ªã€‚</p><ul><li>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒEureka-Client ä» Eureka-Server è·å–åˆ°<strong>å®Œæ•´çš„å¢é‡å˜åŒ–</strong>å¹¶åˆå¹¶ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…æ˜¯ä¸€è‡´çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>åˆç†</strong>ã€‚</li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m - c</td><td>m - c</td></tr><tr><td>åº”ç”¨B</td><td>n + c</td><td>n + c</td></tr></tbody></table><ul><li>å¼‚å¸¸æƒ…å†µä¸‹ã€1ã€‘ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—å…¨éƒ¨è¿‡æœŸã€‚é‚£ Eureka-Client ä» Eureka-Server è·å–åˆ°<strong>ç©ºçš„å¢é‡å˜åŒ–</strong>å¹¶åˆå¹¶ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œ ä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>ä¸åˆç†</strong>ã€‚</li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m - c</td><td>m</td></tr><tr><td>åº”ç”¨B</td><td>n + c</td><td>n</td></tr></tbody></table><ul><li>å¼‚å¸¸æƒ…å†µä¸‹ã€2ã€‘ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—éƒ¨åˆ†è¿‡æœŸï¼Œä¾‹å¦‚åº”ç”¨A å’Œ åº”ç”¨B éƒ½å‰©ä½™ w æ¡å˜æ›´è®°å½•ã€‚é‚£ Eureka-Client ä» Eureka-Server è·å–åˆ°<strong>éƒ¨åˆ†çš„å¢é‡å˜åŒ–</strong>å¹¶åˆå¹¶ï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>ä¸åˆç†</strong>ã€‚</li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m - c</td><td>m - w</td></tr><tr><td>åº”ç”¨B</td><td>n + c</td><td>n + w</td></tr></tbody></table><p>What ï¼Ÿ ä»å¼‚å¸¸æƒ…å†µã€1ã€‘ã€2ã€‘å¯ä»¥çœ‹åˆ°ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ç«Ÿç„¶æ˜¯<strong>ä¸åˆç†</strong>çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰‹åŠ¨æ¥åšä¸€æ¬¡æœ€ç²¾ç®€çš„å®éªŒã€‚å®éªŒå¦‚ä¸‹ï¼š</p><ul><li>æ¨¡æ‹Ÿåœºæ™¯ï¼šå¼‚å¸¸æƒ…å†µã€1ã€‘ï¼Œm = n = c = 1 ã€‚ç®€å•ç²—æš´ã€‚</li><li>ç‰¹åˆ«é…ç½®<ul><li><code>eureka.retentionTimeInMSInDeltaQueue = 1</code> ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—æ¯æ¡è®°å½•å­˜æ´»æ—¶é•¿ 1 msã€‚ç”¨ä»¥å®ç° Eureka-Client è¯·æ±‚ä¸åˆ°å®Œæ•´çš„å¢é‡å˜åŒ–ã€‚</li><li><code>eureka.deltaRetentionTimerIntervalInMs = 1</code> ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—æ¯æ¡è®°å½•è¿‡æœŸå®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ 1 msã€‚ç”¨ä»¥å®ç° Eureka-Client è¯·æ±‚ä¸åˆ°å®Œæ•´çš„å¢é‡å˜åŒ–ã€‚</li><li><code>eureka.shouldUseReadOnlyResponseCache = false</code> ï¼Œç¦ç”¨å“åº”ç¼“å­˜çš„åªè¯»ç¼“å­˜ã€‚ç”¨ä»¥é¿å…ç­‰å¾…ç¼“å­˜åˆ·æ–°ã€‚</li><li><code>eureka.waitTimeInMsWhenSyncEmpty = 1</code> ï¼Œ</li></ul></li><li>å®éªŒè¿‡ç¨‹<ol><li>00:00 å¯åŠ¨ Eureka-Server</li><li>00:30 å¯åŠ¨åº”ç”¨A ï¼Œå‘ Eureka-Server æ³¨å†Œ</li><li>01:00 å¯åŠ¨ Eureka-Client ï¼Œå‘ Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ï¼Œç­‰å¾…è·å–åˆ°åº”ç”¨A</li><li>01:30 å…³é—­åº”ç”¨A ã€‚ç«‹å³å¯åŠ¨åº”ç”¨B ï¼Œå‘ Eureka-Server æ³¨å†Œ</li><li>ç­‰å¾… 5 åˆ†é’Ÿï¼ŒEureka-Client æ— æ³•è·å–åˆ°åº”ç”¨B</li><li>æ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>ä¸åˆç†ã€‚</strong></li></ol></li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>0</td><td>1</td></tr><tr><td>åº”ç”¨B</td><td>1</td><td>0</td></tr></tbody></table><p>ğŸ™‚<strong>ç»“è®º</strong>ğŸ™‚</p><p>å½“ç„¶æ’é™¤æ‰ç‰¹åˆ«æç«¯çš„åœºæ™¯ï¼ŒEureka-Client ä» Eureka-Server å› ä¸ºç½‘ç»œå¼‚å¸¸å¯¼è‡´ä¸€ç›´åŒæ­¥ä¸åˆ°å¢é‡å˜åŒ–ï¼Œåˆæ°å¥½åº”ç”¨å…³é—­å’Œå¼€å¯æ»¡è¶³çŠ¶æ€ç»Ÿè®¡æ•°é‡ã€‚å¦å¤–ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—è®°å½•è¿‡æœŸæ—¶é•¿ä¸º 300 ç§’ï¼Œå¢é‡è·å–é¢‘ç‡ä¸º 30 ç§’ï¼Œè·å–çš„æ¬¡æ•°æœ‰ 10 æ¬¡å·¦å³ã€‚<strong>æ‰€ä»¥ï¼Œåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç åœ¨ç»å¤§å¤šæ•°åœºæ™¯æ˜¯åˆç†çš„</strong>ã€‚<strong>ç¬”è€…çš„YY</strong>ï¼Œè§£å†³è¿™ä¸ªæå°åœºæ™¯æœ‰å¦‚ä¸‹æ–¹å¼ï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼Œä¿®æ”¹è®¡ç®—å…¬å¼ <code>appsHashCode = MD5(${app_name}_${instance_id}_${status}_${count}_)</code> ï¼Œå¢åŠ å¯¹åº”ç”¨åå’Œåº”ç”¨å®ä¾‹ç¼–å·æ•æ„Ÿã€‚</li><li>ç¬¬äºŒç§ï¼Œæ¯ N åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ã€‚</li></ul><p>ps ï¼šç¬”è€…æ€€ç€å¿å¿‘çš„å¿ƒå†™å®Œäº†è¿™ä¸ªå°èŠ‚ï¼Œå¦‚æœæœ‰ä¸åˆç†çš„åœ°æ–¹ï¼Œåˆæˆ–è€…æœ‰ä¸åŒè§‚ç‚¹çš„èƒ–å‹ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨ã€‚è°¢è°¢ã€‚</p><p>TODO[0027][åæ€]ï¼šåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚</p><h1>3. Eureka-Client å‘èµ·å¢é‡è·å–</h1><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> é‡Œï¼Œè°ƒç”¨ <code>DiscoveryClient#getAndUpdateDelta(...)</code> æ–¹æ³•ï¼Œ<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶<strong>åˆ·æ–°</strong>æœ¬åœ°ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndUpdateDelta</span><span class="params">(Applications applications)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="comment">// å¢é‡è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"> <span class="number">5</span>:     Applications delta = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>:     EurekaHttpResponse&lt;Applications&gt; httpResponse = eurekaTransport.queryClient.getDelta(remoteRegionsRef.get());</div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</div><div class="line"> <span class="number">8</span>:         delta = httpResponse.getEntity();</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (delta == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// å¢é‡è·å–ä¸ºç©ºï¼Œå…¨é‡è·å–</span></div><div class="line"><span class="number">13</span>:         logger.warn(<span class="string">"The server does not allow the delta revision to be applied because it is not safe. "</span></div><div class="line"><span class="number">14</span>:                 + <span class="string">"Hence got the full registry."</span>);</div><div class="line"><span class="number">15</span>:         getAndStoreFullRegistry();</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</div><div class="line"><span class="number">17</span>:         logger.debug(<span class="string">"Got delta update with apps hashcode &#123;&#125;"</span>, delta.getAppsHashCode());</div><div class="line"><span class="number">18</span>:         String reconcileHashCode = <span class="string">""</span>;</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (fetchRegistryUpdateLock.tryLock()) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:                 <span class="comment">// å°†å˜åŒ–çš„åº”ç”¨é›†åˆå’Œæœ¬åœ°ç¼“å­˜çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶</span></div><div class="line"><span class="number">22</span>:                 updateDelta(delta);</div><div class="line"><span class="number">23</span>:                 <span class="comment">// è®¡ç®—æœ¬åœ°çš„åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </span></div><div class="line"><span class="number">24</span>:                 reconcileHashCode = getReconcileHashCode(applications);</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">26</span>:                 fetchRegistryUpdateLock.unlock();</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">29</span>:             logger.warn(<span class="string">"Cannot acquire update lock, aborting getAndUpdateDelta"</span>);</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:         <span class="comment">// There is a diff in number of instances for some reason</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (!reconcileHashCode.equals(delta.getAppsHashCode()) <span class="comment">// ä¸€è‡´æ€§å“ˆå¸Œå€¼ä¸ç›¸ç­‰</span></div><div class="line"><span class="number">33</span>:                 || clientConfig.shouldLogDeltaDiff()) &#123; <span class="comment">//</span></div><div class="line"><span class="number">34</span>:             reconcileAndLogDifference(delta, reconcileHashCode);  <span class="comment">// this makes a remoteCall</span></div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>:         logger.warn(<span class="string">"Not updating application delta as another thread is updating it already"</span>);</div><div class="line"><span class="number">38</span>:         logger.debug(<span class="string">"Ignoring delta update with apps hashcode &#123;&#125;, as another thread is updating it already"</span>, delta.getAppsHashCode());</div><div class="line"><span class="number">39</span>:     &#125;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 9 è¡Œ ï¼šè¯·æ±‚<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Applications&gt; <span class="title">getDelta</span><span class="params">(String... regions)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> getApplicationsInternal(<span class="string">"apps/delta"</span>, regions);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#getApplicationsInternal(...)</code> æ–¹æ³•ï¼ŒGET è¯·æ±‚ Eureka-Server çš„ <code>apps/detla</code> æ¥å£ï¼Œå‚æ•°ä¸º <code>regions</code> ï¼Œè¿”å›æ ¼å¼ä¸º JSON ï¼Œå®ç°å¢é‡è·å–æ³¨å†Œä¿¡æ¯ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 15 è¡Œ ï¼š<strong>å¢é‡</strong>è·å–å¤±è´¥ï¼Œè°ƒç”¨ <code>#getAndStoreFullRegistry()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚è¯¥æ–¹æ³•åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4.1 å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 16 è‡³ 35 è¡Œ ï¼šå¤„ç†<strong>å¢é‡</strong>è·å–çš„ç»“æœã€‚</p><ul><li>ç¬¬ 16 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</li><li>ç¬¬ 19 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</li><li>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#updateDelta(...)</code> æ–¹æ³•ï¼Œå°†<strong>å˜åŒ–</strong>çš„åº”ç”¨é›†åˆå’Œ<strong>æœ¬åœ°ç¼“å­˜</strong>çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶ã€‚</li><li>ç¬¬ 31 è‡³ 35 è¡Œ ï¼šä¸€è‡´æ€§å“ˆå¸Œå€¼ä¸ç›¸ç­‰ï¼Œè°ƒç”¨ <code>#reconcileAndLogDifference()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå’Œ <code>#getAndStoreFullRegistry()</code> åŸºæœ¬ç±»ä¼¼ã€‚<ul><li>ç¬¬ 33 è¡Œ ï¼šé…ç½® <code>eureka.printDeltaFullDiff</code> ï¼Œæ˜¯å¦æ‰“å°å¢é‡å’Œå…¨é‡å·®å¼‚ã€‚é»˜è®¤å€¼ ï¼š<code>false</code> ã€‚ä»ç›®å‰ä»£ç å®ç°ä¸Šæ¥çœ‹ï¼Œæš‚æ—¶æ²¡æœ‰ç”Ÿæ•ˆã€‚<strong>æ³¨æ„</strong> ï¼šå¼€å¯è¯¥å‚æ•°ä¼šå¯¼è‡´æ¯æ¬¡<strong>å¢é‡</strong>è·å–ååˆå‘èµ·<strong>å…¨é‡</strong>è·å–ï¼Œä¸è¦å¼€å¯ã€‚</li></ul></li></ul></li></ul><h2>3.1 åˆå¹¶åº”ç”¨é›†åˆ</h2><p>è°ƒç”¨ <code>#updateDelta(...)</code> æ–¹æ³•ï¼Œå°†<strong>å˜åŒ–</strong>çš„åº”ç”¨é›†åˆå’Œ<strong>æœ¬åœ°ç¼“å­˜</strong>çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDelta</span><span class="params">(Applications delta)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">int</span> deltaCount = <span class="number">0</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (Application app : delta.getRegisteredApplications()) &#123; <span class="comment">// å¾ªç¯å¢é‡ï¼ˆå˜åŒ–ï¼‰åº”ç”¨é›†åˆ</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line"> <span class="number">5</span>:             Applications applications = getApplications();</div><div class="line"> <span class="number">6</span>:             <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">7</span>:             String instanceRegion = instanceRegionChecker.getInstanceRegion(instance);</div><div class="line"> <span class="number">8</span>:             <span class="keyword">if</span> (!instanceRegionChecker.isLocalRegion(instanceRegion)) &#123;</div><div class="line"> <span class="number">9</span>:                 Applications remoteApps = remoteRegionVsApps.get(instanceRegion);</div><div class="line"><span class="number">10</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == remoteApps) &#123;</div><div class="line"><span class="number">11</span>:                     remoteApps = <span class="keyword">new</span> Applications();</div><div class="line"><span class="number">12</span>:                     remoteRegionVsApps.put(instanceRegion, remoteApps);</div><div class="line"><span class="number">13</span>:                 &#125;</div><div class="line"><span class="number">14</span>:                 applications = remoteApps;</div><div class="line"><span class="number">15</span>:             &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:             ++deltaCount;</div><div class="line"><span class="number">18</span>:             <span class="keyword">if</span> (ActionType.ADDED.equals(instance.getActionType())) &#123; <span class="comment">// æ·»åŠ </span></div><div class="line"><span class="number">19</span>:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());</div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:                     applications.addApplication(app);</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:                 logger.debug(<span class="string">"Added instance &#123;&#125; to the existing apps in region &#123;&#125;"</span>, instance.getId(), instanceRegion);</div><div class="line"><span class="number">24</span>:                 applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ActionType.MODIFIED.equals(instance.getActionType())) &#123; <span class="comment">// ä¿®æ”¹</span></div><div class="line"><span class="number">26</span>:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());</div><div class="line"><span class="number">27</span>:                 <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">28</span>:                     applications.addApplication(app);</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:                 logger.debug(<span class="string">"Modified instance &#123;&#125; to the existing apps "</span>, instance.getId());</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:                 applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);</div><div class="line"><span class="number">33</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ActionType.DELETED.equals(instance.getActionType())) &#123; <span class="comment">// åˆ é™¤</span></div><div class="line"><span class="number">34</span>:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">36</span>:                     applications.addApplication(app);</div><div class="line"><span class="number">37</span>:                 &#125;</div><div class="line"><span class="number">38</span>:                 logger.debug(<span class="string">"Deleted instance &#123;&#125; to the existing apps "</span>, instance.getId());</div><div class="line"><span class="number">39</span>:                 applications.getRegisteredApplications(instance.getAppName()).removeInstance(instance);</div><div class="line"><span class="number">40</span>:             &#125;</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:     &#125;</div><div class="line"><span class="number">43</span>:     logger.debug(<span class="string">"The total number of instances fetched by the delta processor : &#123;&#125;"</span>, deltaCount);</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     getApplications().setVersion(delta.getVersion());</div><div class="line"><span class="number">46</span>:     <span class="comment">// è¿‡æ»¤ã€æ‰“ä¹±åº”ç”¨é›†åˆ</span></div><div class="line"><span class="number">47</span>:     getApplications().shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="number">50</span>:     <span class="keyword">for</span> (Applications applications : remoteRegionVsApps.values()) &#123;</div><div class="line"><span class="number">51</span>:         applications.setVersion(delta.getVersion());</div><div class="line"><span class="number">52</span>:         applications.shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</div><div class="line"><span class="number">53</span>:     &#125;</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 15 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 18 è‡³ 24 è¡Œ ï¼šæ·»åŠ ( ADDED )åº”ç”¨å®ä¾‹æ—¶ï¼Œè°ƒç”¨ <code>Application#addInstance(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Application.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInstance</span><span class="params">(InstanceInfo i)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° åº”ç”¨å®ä¾‹æ˜ å°„</span></div><div class="line">   instancesMap.put(i.getId(), i);</div><div class="line">   <span class="keyword">synchronized</span> (instances) &#123;</div><div class="line">       <span class="comment">// ç§»é™¤åŸæœ‰å®ä¾‹</span></div><div class="line">       instances.remove(i);</div><div class="line">       <span class="comment">// æ·»åŠ æ–°å®ä¾‹</span></div><div class="line">       instances.add(i);</div><div class="line">       <span class="comment">// è®¾ç½® isDirty ï¼Œç›®å‰åªç”¨äº `#toString()` æ–¹æ³•æ‰“å°ï¼Œæ— ä¸šåŠ¡é€»è¾‘</span></div><div class="line">       isDirty = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123; <span class="comment">// åªä½¿ç”¨ ID è®¡ç®— hashcode</span></div><div class="line">   String id = getId();</div><div class="line">   <span class="keyword">return</span> (id == <span class="keyword">null</span>) ? <span class="number">31</span> : (id.hashCode() + <span class="number">31</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123; <span class="comment">// åªå¯¹æ¯” ID</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span> == obj) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (getClass() != obj.getClass()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   InstanceInfo other = (InstanceInfo) obj;</div><div class="line">   String id = getId();</div><div class="line">   <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">if</span> (other.getId() != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!id.equals(other.getId())) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 25 è‡³ 32 è¡Œ ï¼šä¿®æ”¹( MODIFIED )åº”ç”¨å®ä¾‹æ—¶ï¼Œ<strong>åŒæ ·</strong>è°ƒç”¨ <code>Application#addInstance(...)</code> æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 33 è‡³ 40 è¡Œ ï¼šåˆ é™¤( DELETED )åº”ç”¨å®ä¾‹æ—¶ï¼Œè°ƒç”¨ <code>Application#removeInstance(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeInstance</span><span class="params">(InstanceInfo i)</span> </span>&#123;</div><div class="line">    removeInstance(i, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeInstance</span><span class="params">(InstanceInfo i, <span class="keyword">boolean</span> markAsDirty)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹æ˜ å°„</span></div><div class="line">    instancesMap.remove(i.getId());</div><div class="line">    <span class="keyword">synchronized</span> (instances) &#123;</div><div class="line">        <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹</span></div><div class="line">        instances.remove(i);</div><div class="line">        <span class="keyword">if</span> (markAsDirty) &#123;</div><div class="line">            <span class="comment">// è®¾ç½® isDirty ï¼Œç›®å‰åªç”¨äº `#toString()` æ–¹æ³•æ‰“å°ï¼Œæ— ä¸šåŠ¡é€»è¾‘</span></div><div class="line">            isDirty = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>Applications#shuffleInstances(...)</code> æ–¹æ³•ï¼Œæ ¹æ®é…ç½® <code>eureka.shouldFilterOnlyUpInstances = true</code> ( é»˜è®¤å€¼ ï¼š<code>true</code> ) è¿‡æ»¤åªä¿ç•™çŠ¶æ€ä¸ºå¼€å¯( UP )çš„åº”ç”¨å®ä¾‹ï¼Œå¹¶<strong>éšæœºæ‰“ä¹±</strong>åº”ç”¨å®ä¾‹é¡ºåºã€‚æ‰“ä¹±åï¼Œå®ç°è°ƒç”¨åº”ç”¨æœåŠ¡çš„éšæœºæ€§ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/shared/Applications.java#L286" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹æ–¹æ³•å®ç°ã€‚</p></li><li><p>ç¬¬ 49 è‡³ 53 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li></ul><h1>4. Eureka-Server æ¥æ”¶å…¨é‡è·å–</h1><h2>3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</h2><p><code>com.netflix.eureka.resources.ApplicationsResource</code>ï¼Œå¤„ç†<strong>æ‰€æœ‰</strong>åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>æ¥æ”¶å¢é‡è·å–è¯·æ±‚ï¼Œæ˜ å°„ <code>ApplicationsResource#getContainers()</code> æ–¹æ³•ã€‚</p><ul><li>å’Œ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚ã€</a> ç±»ä¼¼ï¼Œå°±ä¸é‡å¤å•°å—¦å•¦ã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/225a81d9818d355503ad802363448eb29c374b6f/eureka-core/src/main/java/com/netflix/eureka/resources/ApplicationsResource.java#L190" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•çš„<strong>å¸¦ä¸­æ–‡æ³¨é‡Š</strong>ä»£ç ã€‚</li></ul><h2>3.2 æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</h2><p><code>AbstractInstanceRegistry.recentlyChangedQueue</code>ï¼Œæœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RecentlyChangedItem</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">long</span> lastUpdateTime;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ç§Ÿçº¦</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> Lease&lt;InstanceInfo&gt; leaseInfo;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">RecentlyChangedItem</span><span class="params">(Lease&lt;InstanceInfo&gt; lease)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.leaseInfo = lease;</div><div class="line">       lastUpdateTime = System.currentTimeMillis();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastUpdateTime</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.lastUpdateTime;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> Lease&lt;InstanceInfo&gt; <span class="title">getLeaseInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.leaseInfo;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å½“åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€çŠ¶æ€å˜æ›´æ—¶ï¼Œåˆ›å»ºæœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•( RecentlyChangedItem ) åˆ°é˜Ÿåˆ—ã€‚</p></li><li><p>åå°ä»»åŠ¡å®šæ—¶<strong>é¡ºåº</strong>æ‰«æé˜Ÿåˆ—ï¼Œå½“ <code>lastUpdateTime</code> è¶…è¿‡ä¸€å®šæ—¶é•¿åè¿›è¡Œç§»é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="keyword">this</span>.deltaRetentionTimer.schedule(getDeltaRetentionTask(),</div><div class="line">                serverConfig.getDeltaRetentionTimerIntervalInMs(),</div><div class="line">                serverConfig.getDeltaRetentionTimerIntervalInMs());</div><div class="line">                </div><div class="line"><span class="function"><span class="keyword">private</span> TimerTask <span class="title">getDeltaRetentionTask</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">           Iterator&lt;RecentlyChangedItem&gt; it = recentlyChangedQueue.iterator();</div><div class="line">           <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">               <span class="keyword">if</span> (it.next().getLastUpdateTime() &lt; System.currentTimeMillis() - serverConfig.getRetentionTimeInMSInDeltaQueue()) &#123;</div><div class="line">                   it.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é…ç½® <code>eureka.deltaRetentionTimerIntervalInMs</code>ï¼Œ ç§»é™¤é˜Ÿåˆ—é‡Œè¿‡æœŸçš„ç§Ÿçº¦å˜æ›´è®°å½•çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚</li><li>é…ç½® <code>eureka.retentionTimeInMSInDeltaQueue</code>ï¼Œç§Ÿçº¦å˜æ›´è®°å½•è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š 3 * 60 * 1000 æ¯«ç§’ã€‚</li></ul></li></ul><h2>3.3 ç¼“å­˜è¯»å–</h2><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.3 ç¼“å­˜è¯»å–ã€</a> é‡Œï¼Œåœ¨ <code>#generatePayload()</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>AbstractInstanceRegistry#getApplicationDeltas(...)</code> æ–¹æ³•ï¼Œè·å–è¿‘æœŸå˜åŒ–çš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationDeltas</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">// æ·»åŠ  å¢é‡è·å–æ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line">  <span class="number">3</span>:     GET_ALL_CACHE_MISS_DELTA.increment();</div><div class="line">  <span class="number">4</span>:     <span class="comment">// åˆå§‹åŒ– å˜åŒ–çš„åº”ç”¨é›†åˆ</span></div><div class="line">  <span class="number">5</span>:     Applications apps = <span class="keyword">new</span> Applications();</div><div class="line">  <span class="number">6</span>:     apps.setVersion(responseCache.getVersionDelta().get());</div><div class="line">  <span class="number">7</span>:     Map&lt;String, Application&gt; applicationInstancesMap = <span class="keyword">new</span> HashMap&lt;String, Application&gt;();</div><div class="line">  <span class="number">8</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">9</span>:         <span class="comment">// è·å–å†™é”</span></div><div class="line"> <span class="number">10</span>:         write.lock();</div><div class="line"> <span class="number">11</span>:         <span class="comment">// è·å– æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"> <span class="number">12</span>:         Iterator&lt;RecentlyChangedItem&gt; iter = <span class="keyword">this</span>.recentlyChangedQueue.iterator();</div><div class="line"> <span class="number">13</span>:         logger.debug(<span class="string">"The number of elements in the delta queue is :"</span> + <span class="keyword">this</span>.recentlyChangedQueue.size());</div><div class="line"> <span class="number">14</span>:         <span class="comment">// æ‹¼è£… å˜åŒ–çš„åº”ç”¨é›†åˆ</span></div><div class="line"> <span class="number">15</span>:         <span class="keyword">while</span> (iter.hasNext()) &#123;</div><div class="line"> <span class="number">16</span>:             Lease&lt;InstanceInfo&gt; lease = iter.next().getLeaseInfo();</div><div class="line"> <span class="number">17</span>:             InstanceInfo instanceInfo = lease.getHolder();</div><div class="line"> <span class="number">18</span>:             Object[] args = &#123;instanceInfo.getId(), instanceInfo.getStatus().name(), instanceInfo.getActionType().name()&#125;;</div><div class="line"> <span class="number">19</span>:             logger.debug(<span class="string">"The instance id %s is found with status %s and actiontype %s"</span>, args);</div><div class="line"> <span class="number">20</span>:             Application app = applicationInstancesMap.get(instanceInfo.getAppName());</div><div class="line"> <span class="number">21</span>:             <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">22</span>:                 app = <span class="keyword">new</span> Application(instanceInfo.getAppName());</div><div class="line"> <span class="number">23</span>:                 applicationInstancesMap.put(instanceInfo.getAppName(), app);</div><div class="line"> <span class="number">24</span>:                 apps.addApplication(app);</div><div class="line"> <span class="number">25</span>:             &#125;</div><div class="line"> <span class="number">26</span>:             app.addInstance(decorateInstanceInfo(lease));</div><div class="line"> <span class="number">27</span>:         &#125;</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:         <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">30</span>:         <span class="keyword">boolean</span> disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();</div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> (!disableTransparentFallback) &#123;</div><div class="line"> <span class="number">32</span>:             Applications allAppsInLocalRegion = getApplications(<span class="keyword">false</span>);</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">for</span> (RemoteRegionRegistry remoteRegistry : <span class="keyword">this</span>.regionNameVSRemoteRegistry.values()) &#123;</div><div class="line"> <span class="number">35</span>:                 Applications applications = remoteRegistry.getApplicationDeltas();</div><div class="line"> <span class="number">36</span>:                 <span class="keyword">for</span> (Application application : applications.getRegisteredApplications()) &#123;</div><div class="line"> <span class="number">37</span>:                     Application appInLocalRegistry =</div><div class="line"> <span class="number">38</span>:                             allAppsInLocalRegion.getRegisteredApplications(application.getName());</div><div class="line"> <span class="number">39</span>:                     <span class="keyword">if</span> (appInLocalRegistry == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">40</span>:                         apps.addApplication(application);</div><div class="line"> <span class="number">41</span>:                     &#125;</div><div class="line"> <span class="number">42</span>:                 &#125;</div><div class="line"> <span class="number">43</span>:             &#125;</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="comment">// è·å–å…¨é‡åº”ç”¨é›†åˆï¼Œé€šè¿‡å®ƒè®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œå€¼</span></div><div class="line"> <span class="number">47</span>:         Applications allApps = getApplications(!disableTransparentFallback);</div><div class="line"> <span class="number">48</span>:         apps.setAppsHashCode(allApps.getReconcileHashCode());</div><div class="line"> <span class="number">49</span>:         <span class="keyword">return</span> apps;</div><div class="line"> <span class="number">50</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">51</span>:         write.unlock();</div><div class="line"> <span class="number">52</span>:     &#125;</div><div class="line"> <span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ 3 è¡Œ ï¼šæ·»åŠ å¢é‡è·å–æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li><li>ç¬¬ 4 è¡Œ ï¼šåˆå§‹åŒ–å˜åŒ–( å¢é‡ )çš„åº”ç”¨é›†åˆ( <code>apps</code> )ã€‚</li><li>ç¬¬ 9 è¡Œ ï¼šè·å–å†™é”ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/?self">ã€ŠEurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”ã€‹</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šè·å–æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( <code>æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</code> )ã€‚</li><li>ç¬¬ 14 è‡³ 27 è¡Œ ï¼šæ‹¼è£…å˜åŒ–çš„åº”ç”¨é›†åˆ( <code>apps</code> )ã€‚</li><li>ç¬¬ 29 è‡³ 44 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼šè°ƒç”¨ <code>#getApplications(...)</code> æ–¹æ³•ï¼Œè·å–<strong>å…¨é‡</strong>åº”ç”¨é›†åˆ( <code>allApps</code> )ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.3.1 è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€</a> æœ‰è¯¦ç»†è§£æã€‚åé€šè¿‡ <code>allApps</code> è®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œå€¼ã€‚é€šè¿‡è¿™ä¸ªå…¨é‡åº”ç”¨é›†åˆçš„å“ˆå¸Œå€¼ï¼ŒEureka-Client è·å–åˆ°å¢é‡åº”ç”¨é›†åˆå¹¶åˆå¹¶åï¼Œå°±å¯ä»¥æ¯”å¯¹å•¦ã€‚</li><li>ç¬¬ 51 è¡Œ ï¼šé‡Šæ”¾å†™é”ã€‚</li></ul><h1>666. å½©è›‹</h1><p>åœ¨æ±‰å ¡ç‹å†™å®Œè¿™ç¯‡çƒ­æƒ…çš„åšå®¢ã€‚ä¸ºä»€ä¹ˆç”¨â€œçƒ­æƒ…â€è¿™ä¸ªå­—çœ¼å‘¢ï¼Ÿå¤§å¤å¤©çš„ï¼Œç«Ÿç„¶ä¸å¼€ç©ºè°ƒçš„ï¼å¯¹çš„ï¼Œæ²¡æœ‰å¼€ç©ºè°ƒï¼Œç®€ç›´æ˜¯ä¸ªå°ç«ç‚‰ã€‚æ©ï¼Œä¸è¿‡é™å¿ƒå†™å®Œè¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘è¿˜æ˜¯æŒºå—¨çš®çš„ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-fetch-all/</id>
    <published>2018-06-28T16:00:00.000Z</published>
    <updated>2017-10-18T14:48:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-all/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2. Eureka-Client å‘èµ·å…¨é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.1 åˆå§‹åŒ–å…¨é‡è·å–</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.2 å®šæ—¶è·å–</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.3 åˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3. Eureka-Server æ¥æ”¶å…¨é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.2 å“åº”ç¼“å­˜ ResponseCache</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.3 ç¼“å­˜è¯»å–</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.4 ä¸»åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.5 è¢«åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.6 å®šæ—¶åˆ·æ–°åªè¯»ç¼“å­˜</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server è·å–å…¨é‡æ³¨å†Œä¿¡æ¯çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/01.png" alt=""></p></blockquote><p>Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œåˆ†æˆ<strong>å…¨é‡è·å–</strong>å’Œ<strong>å¢é‡è·å–</strong>ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒEureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡<strong>å…¨é‡</strong>è·å–è¿›è¡Œ<strong>æœ¬åœ°ç¼“å­˜</strong>æ³¨å†Œä¿¡æ¯ï¼Œè€Œåæ¯ <strong>30</strong> ç§’<strong>å¢é‡</strong>è·å–åˆ·æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>( éâ€œ<strong>æ­£å¸¸</strong>â€æƒ…å†µä¸‹ä¼šæ˜¯å…¨é‡è·å– )ã€‚</p><p>æœ¬æ–‡é‡ç‚¹åœ¨äº<strong>å…¨é‡è·å–</strong>ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. Eureka-Client å‘èµ·å…¨é‡è·å–</h1><p>æœ¬å°èŠ‚è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/03.png" alt=""></p><h2>2.1 åˆå§‹åŒ–å…¨é‡è·å–</h2><p>Eureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡<strong>å…¨é‡</strong>è·å–è¿›è¡Œ<strong>æœ¬åœ°ç¼“å­˜</strong>æ³¨å†Œä¿¡æ¯ï¼Œé¦–å…ˆä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Applications&gt; localRegionApps = <span class="keyword">new</span> AtomicReference&lt;Applications&gt;();</div><div class="line"></div><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">                    </div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">     </div><div class="line">    <span class="comment">// ã€3.2.5ã€‘åˆå§‹åŒ–åº”ç”¨é›†åˆåœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line">    localRegionApps.set(<span class="keyword">new</span> Applications());</div><div class="line">     </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç      </span></div><div class="line">     </div><div class="line">    <span class="comment">// ã€3.2.12ã€‘ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</span></div><div class="line">    <span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">        fetchRegistryFromBackup();</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç        </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.discovery.shared.Applications</code>ï¼Œæ³¨å†Œçš„åº”ç”¨é›†åˆã€‚è¾ƒä¸ºå®¹æ˜“ç†è§£ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/shared/Applications.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> é“¾æ¥æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ç±»ï¼Œè¿™é‡Œå°±ä¸å•°å—¦äº†ã€‚Applications ä¸ InstanceInfo ç±»å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/02.png" alt=""></p></li><li><p>é…ç½® <code>eureka.shouldFetchRegistry = true</code>ï¼Œå¼€å¯ä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ã€‚é»˜è®¤å€¼ï¼š<code>true</code> ã€‚</p></li><li><p>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server <strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œåœ¨ <a href="#">ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul><h2>2.2 å®šæ—¶è·å–</h2><p>Eureka-Client åœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/?self">åˆå§‹åŒ–</a>è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º<strong>è·å–æ³¨å†Œä¿¡æ¯</strong>çº¿ç¨‹ï¼Œ<strong>å›ºå®šé—´éš”</strong>å‘ Eureka-Server å‘èµ·<strong>è·å–æ³¨å†Œä¿¡æ¯</strong>( fetch )ï¼Œ<strong>åˆ·æ–°</strong>æœ¬åœ°æ³¨å†Œä¿¡æ¯<strong>ç¼“å­˜</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">               Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">               </div><div class="line">    <span class="comment">// ã€3.2.9ã€‘åˆå§‹åŒ–çº¿ç¨‹æ± </span></div><div class="line">    <span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></div><div class="line">    scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">         <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                 .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">                 .setDaemon(<span class="keyword">true</span>)</div><div class="line">                 .build());</div><div class="line">    </div><div class="line">    cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">         <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">         <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">         <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                 .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</div><div class="line">                 .setDaemon(<span class="keyword">true</span>)</div><div class="line">                 .build()</div><div class="line">     );  <span class="comment">// use direct handoff</span></div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="comment">// ã€3.2.14ã€‘åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</span></div><div class="line">    initScheduledTasks();</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">    <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line">       <span class="comment">// registry cache refresh timer</span></div><div class="line">       <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"cacheRefresh"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       cacheRefreshExecutor,</div><div class="line">                       registryFetchIntervalSeconds,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> CacheRefreshThread()</div><div class="line">               ),</div><div class="line">               registryFetchIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">     &#125;</div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ä»£ç ï¼Œå’Œ<strong>ç»­ç§Ÿ</strong>çš„å®šæ—¶ä»»åŠ¡ä»£ç ç±»ä¼¼ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> æœ‰è¯¦ç»†è§£æï¼Œè¿™é‡Œä¸é‡å¤åˆ†äº«ã€‚</p></li><li><p><code>com.netflix.discovery.DiscoveryClient.CacheRefreshThread</code>ï¼Œæ³¨å†Œä¿¡æ¯ç¼“å­˜åˆ·æ–°ä»»åŠ¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        refreshRegistry();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#refreshRegistry(false)</code> æ–¹æ³•ï¼Œåˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜ï¼Œåœ¨ <a href="#">ã€Œ2.3 åˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>2.3 åˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜</h2><p>è°ƒç”¨ <code>#refreshRegistry(false)</code> æ–¹æ³•ï¼Œåˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">refreshRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">3</span>:         <span class="comment">// TODO èŠ‹è‰¿ï¼šTODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">  <span class="number">4</span>:         <span class="keyword">boolean</span> isFetchingRemoteRegionRegistries = isFetchingRemoteRegionRegistries();</div><div class="line">  <span class="number">5</span>: </div><div class="line">  <span class="number">6</span>:         <span class="keyword">boolean</span> remoteRegionsModified = <span class="keyword">false</span>;</div><div class="line">  <span class="number">7</span>:         <span class="comment">// This makes sure that a dynamic change to remote regions to fetch is honored.</span></div><div class="line">  <span class="number">8</span>:         String latestRemoteRegions = clientConfig.fetchRegistryForRemoteRegions();</div><div class="line">  <span class="number">9</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> != latestRemoteRegions) &#123;</div><div class="line"> <span class="number">10</span>:             String currentRemoteRegions = remoteRegionsToFetch.get();</div><div class="line"> <span class="number">11</span>:             <span class="keyword">if</span> (!latestRemoteRegions.equals(currentRemoteRegions)) &#123;</div><div class="line"> <span class="number">12</span>:                 <span class="comment">// Both remoteRegionsToFetch and AzToRegionMapper.regionsToFetch need to be in sync</span></div><div class="line"> <span class="number">13</span>:                 <span class="keyword">synchronized</span> (instanceRegionChecker.getAzToRegionMapper()) &#123;</div><div class="line"> <span class="number">14</span>:                     <span class="keyword">if</span> (remoteRegionsToFetch.compareAndSet(currentRemoteRegions, latestRemoteRegions)) &#123;</div><div class="line"> <span class="number">15</span>:                         String[] remoteRegions = latestRemoteRegions.split(<span class="string">","</span>);</div><div class="line"> <span class="number">16</span>:                         remoteRegionsRef.set(remoteRegions);</div><div class="line"> <span class="number">17</span>:                         instanceRegionChecker.getAzToRegionMapper().setRegionsToFetch(remoteRegions);</div><div class="line"> <span class="number">18</span>:                         remoteRegionsModified = <span class="keyword">true</span>;</div><div class="line"> <span class="number">19</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">20</span>:                         logger.info(<span class="string">"Remote regions to fetch modified concurrently,"</span> +</div><div class="line"> <span class="number">21</span>:                                 <span class="string">" ignoring change from &#123;&#125; to &#123;&#125;"</span>, currentRemoteRegions, latestRemoteRegions);</div><div class="line"> <span class="number">22</span>:                     &#125;</div><div class="line"> <span class="number">23</span>:                 &#125;</div><div class="line"> <span class="number">24</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">25</span>:                 <span class="comment">// Just refresh mapping to reflect any DNS/Property change</span></div><div class="line"> <span class="number">26</span>:                 instanceRegionChecker.getAzToRegionMapper().refreshMapping();</div><div class="line"> <span class="number">27</span>:             &#125;</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         <span class="keyword">boolean</span> success = fetchRegistry(remoteRegionsModified);</div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> (success) &#123;</div><div class="line"> <span class="number">32</span>:             <span class="comment">// è®¾ç½® æ³¨å†Œä¿¡æ¯çš„åº”ç”¨å®ä¾‹æ•°</span></div><div class="line"> <span class="number">33</span>:             registrySize = localRegionApps.get().size();</div><div class="line"> <span class="number">34</span>:             <span class="comment">// è®¾ç½® æœ€åè·å–æ³¨å†Œä¿¡æ¯æ—¶é—´</span></div><div class="line"> <span class="number">35</span>:             lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">36</span>:         &#125;</div><div class="line"> <span class="number">37</span>: </div><div class="line"> <span class="number">38</span>:         <span class="comment">// æ‰“å°æ—¥å¿—</span></div><div class="line"> <span class="number">39</span>:         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">40</span>:             StringBuilder allAppsHashCodes = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">41</span>:             allAppsHashCodes.append(<span class="string">"Local region apps hashcode: "</span>);</div><div class="line"> <span class="number">42</span>:             allAppsHashCodes.append(localRegionApps.get().getAppsHashCode());</div><div class="line"> <span class="number">43</span>:             allAppsHashCodes.append(<span class="string">", is fetching remote regions? "</span>);</div><div class="line"> <span class="number">44</span>:             allAppsHashCodes.append(isFetchingRemoteRegionRegistries);</div><div class="line"> <span class="number">45</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, Applications&gt; entry : remoteRegionVsApps.entrySet()) &#123;</div><div class="line"> <span class="number">46</span>:                 allAppsHashCodes.append(<span class="string">", Remote region: "</span>);</div><div class="line"> <span class="number">47</span>:                 allAppsHashCodes.append(entry.getKey());</div><div class="line"> <span class="number">48</span>:                 allAppsHashCodes.append(<span class="string">" , apps hashcode: "</span>);</div><div class="line"> <span class="number">49</span>:                 allAppsHashCodes.append(entry.getValue().getAppsHashCode());</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:             logger.debug(<span class="string">"Completed cache refresh task for discovery. All Apps hash code is &#123;&#125; "</span>,</div><div class="line"> <span class="number">52</span>:                     allAppsHashCodes.toString());</div><div class="line"> <span class="number">53</span>:         &#125;</div><div class="line"> <span class="number">54</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">55</span>:         logger.error(<span class="string">"Cannot fetch registry from server"</span>, e);</div><div class="line"> <span class="number">56</span>:     &#125;        </div><div class="line"> <span class="number">57</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 28 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 30 è¡Œ ï¼šè°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ï¼Œåœ¨ <a href="#">ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 31 è‡³ 36 è¡Œ ï¼šè·å–æ³¨å†Œä¿¡æ¯æˆåŠŸï¼Œè®¾ç½®æ³¨å†Œä¿¡æ¯çš„åº”ç”¨å®ä¾‹æ•°ï¼Œæœ€åè·å–æ³¨å†Œä¿¡æ¯æ—¶é—´ã€‚å˜é‡ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ³¨å†Œä¿¡æ¯çš„åº”ç”¨å®ä¾‹æ•°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> registrySize = <span class="number">0</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulRegistryFetchTimestamp = -<span class="number">1</span>;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 38 è‡³ 53 è¡Œ ï¼šæ‰“å°è°ƒè¯•æ—¥å¿—ã€‚</p></li><li><p>ç¬¬ 54 è‡³ 56 è¡Œ ï¼šæ‰“å°<strong>å¼‚å¸¸</strong>æ—¥å¿—ã€‚</p></li></ul><h2>2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯</h2><p>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯( æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œå¯èƒ½æ˜¯<strong>å…¨é‡</strong>ï¼Œä¹Ÿå¯èƒ½æ˜¯<strong>å¢é‡</strong> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     Stopwatch tracer = FETCH_REGISTRY_TIMER.start();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:         <span class="comment">// è·å– æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹é›†åˆ</span></div><div class="line"> <span class="number">6</span>:         <span class="comment">// If the delta is disabled or if it is the first time, get all</span></div><div class="line"> <span class="number">7</span>:         <span class="comment">// applications</span></div><div class="line"> <span class="number">8</span>:         Applications applications = getApplications();</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:         <span class="comment">// å…¨é‡è·å–</span></div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (clientConfig.shouldDisableDelta() <span class="comment">// ç¦ç”¨å¢é‡è·å–</span></div><div class="line"><span class="number">12</span>:                 || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</div><div class="line"><span class="number">13</span>:                 || forceFullRegistryFetch</div><div class="line"><span class="number">14</span>:                 || (applications == <span class="keyword">null</span>) <span class="comment">// ç©º</span></div><div class="line"><span class="number">15</span>:                 || (applications.getRegisteredApplications().size() == <span class="number">0</span>) <span class="comment">// ç©º</span></div><div class="line"><span class="number">16</span>:                 || (applications.getVersion() == -<span class="number">1</span>)) <span class="comment">//Client application does not have latest library supporting delta</span></div><div class="line"><span class="number">17</span>:         &#123;</div><div class="line"><span class="number">18</span>:             logger.info(<span class="string">"Disable delta property : &#123;&#125;"</span>, clientConfig.shouldDisableDelta());</div><div class="line"><span class="number">19</span>:             logger.info(<span class="string">"Single vip registry refresh property : &#123;&#125;"</span>, clientConfig.getRegistryRefreshSingleVipAddress());</div><div class="line"><span class="number">20</span>:             logger.info(<span class="string">"Force full registry fetch : &#123;&#125;"</span>, forceFullRegistryFetch);</div><div class="line"><span class="number">21</span>:             logger.info(<span class="string">"Application is null : &#123;&#125;"</span>, (applications == <span class="keyword">null</span>));</div><div class="line"><span class="number">22</span>:             logger.info(<span class="string">"Registered Applications size is zero : &#123;&#125;"</span>,</div><div class="line"><span class="number">23</span>:                     (applications.getRegisteredApplications().size() == <span class="number">0</span>));</div><div class="line"><span class="number">24</span>:             logger.info(<span class="string">"Application version is -1: &#123;&#125;"</span>, (applications.getVersion() == -<span class="number">1</span>));</div><div class="line"><span class="number">25</span>:             <span class="comment">// æ‰§è¡Œ å…¨é‡è·å–</span></div><div class="line"><span class="number">26</span>:             getAndStoreFullRegistry();</div><div class="line"><span class="number">27</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">28</span>:             <span class="comment">// æ‰§è¡Œ å¢é‡è·å–</span></div><div class="line"><span class="number">29</span>:             getAndUpdateDelta(applications);</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:         <span class="comment">// è®¾ç½® åº”ç”¨é›†åˆ hashcode</span></div><div class="line"><span class="number">32</span>:         applications.setAppsHashCode(applications.getReconcileHashCode());</div><div class="line"><span class="number">33</span>:         <span class="comment">// æ‰“å° æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•°é‡</span></div><div class="line"><span class="number">34</span>:         logTotalInstances();</div><div class="line"><span class="number">35</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">36</span>:         logger.error(PREFIX + appPathIdentifier + <span class="string">" - was unable to refresh its cache! status = "</span> + e.getMessage(), e);</div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">38</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">40</span>:             tracer.stop();</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:     &#125;</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>:     <span class="comment">// Notify about cache refresh before updating the instance remote status</span></div><div class="line"><span class="number">45</span>:     onCacheRefreshed();</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="comment">// Update remote status based on refreshed data held in the cache</span></div><div class="line"><span class="number">48</span>:     updateInstanceRemoteStatus();</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:     <span class="comment">// registry was fetched successfully, so return true</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">52</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šè·å–æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> localRegionApps.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 10 è‡³ 26 è¡Œ ï¼š<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ã€‚</p><ul><li>ç¬¬ 11 è¡Œ ï¼šé…ç½® <code>eureka.disableDelta = true</code> ï¼Œç¦ç”¨<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ã€‚é»˜è®¤å€¼ï¼š<code>false</code> ã€‚</li><li>ç¬¬ 12 è¡Œ ï¼šåªè·å¾—ä¸€ä¸ª <code>vipAddress</code> å¯¹åº”çš„åº”ç”¨å®ä¾‹ä»¬çš„æ³¨å†Œä¿¡æ¯ã€‚</li><li>ç¬¬ 13 è¡Œ ï¼šæ–¹æ³•å‚æ•° <code>forceFullRegistryFetch</code> å¼ºåˆ¶<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ã€‚</li><li>ç¬¬ 14 è‡³ 15 è¡Œ ï¼šæœ¬åœ°ç¼“å­˜ä¸ºç©ºã€‚</li><li>ç¬¬ 25 è‡³ 26 è¡Œ ï¼šè°ƒç”¨ <code>#getAndStoreFullRegistry()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚ä¸‹æ–‡è¯¦ç»†è§£æã€‚</li></ul></li><li><p>ç¬¬ 27 è‡³ 30 è¡Œ ï¼š<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶åˆ·æ–°æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 31 è‡³ 32 è¡Œ ï¼šè®¡ç®—åº”ç”¨é›†åˆ <code>hashcode</code> ã€‚è¯¥å˜é‡ç”¨äºæ ¡éªŒ<strong>å¢é‡</strong>è·å–çš„æ³¨å†Œä¿¡æ¯å’Œ Eureka-Server <strong>å…¨é‡</strong>çš„æ³¨å†Œä¿¡æ¯æ˜¯å¦ä¸€è‡´( å®Œæ•´ )ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 33 è‡³ 34 è¡Œ ï¼šæ‰“å°è°ƒè¯•æ—¥å¿—ï¼Œè¾“å‡ºæœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•°é‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logTotalInstances</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">       <span class="keyword">int</span> totInstances = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (Application application : getApplications().getRegisteredApplications()) &#123;</div><div class="line">           totInstances += application.getInstancesAsIsFromEureka().size();</div><div class="line">       &#125;</div><div class="line">       logger.debug(<span class="string">"The total number of all instances in the client now is &#123;&#125;"</span>, totInstances);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 44 è‡³ 45 è¡Œ ï¼šè§¦å‘ CacheRefreshedEvent äº‹ä»¶ï¼Œäº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œã€‚ç›®å‰ Eureka æœªæä¾›é»˜è®¤çš„è¯¥äº‹ä»¶ç›‘å¬å™¨ã€‚</p><ul><li><p><code>#onCacheRefreshed()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Eureka äº‹ä»¶ç›‘å¬å™¨</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;EurekaEventListener&gt; eventListeners = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCacheRefreshed</span><span class="params">()</span> </span>&#123;</div><div class="line">    fireEvent(<span class="keyword">new</span> CacheRefreshedEvent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(<span class="keyword">final</span> EurekaEvent event)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (EurekaEventListener listener : eventListeners) &#123;</div><div class="line">        listener.onEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p><strong>ç¬”è€…çš„YY</strong> ï¼šä½ å¯ä»¥å®ç°è‡ªå®šä¹‰çš„äº‹ä»¶ç›‘å¬å™¨ç›‘å¬ CacheRefreshedEvent äº‹ä»¶ï¼Œä»¥è¾¾åˆ°<strong>æŒä¹…åŒ–</strong>æœ€æ–°çš„æ³¨å†Œä¿¡æ¯åˆ°å­˜å‚¨å™¨( ä¾‹å¦‚ï¼Œæœ¬åœ°æ–‡ä»¶ )ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œé…åˆå®ç° BackupRegistry æ¥å£è¯»å–å­˜å‚¨å™¨ã€‚BackupRegistry æ¥å£è°ƒç”¨å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ã€3.2.12ã€‘ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">    fetchRegistryFromBackup();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li><li><p>ç¬¬47 è‡³ 48 è¡Œ ï¼šæ›´æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>çš„å½“å‰åº”ç”¨å®ä¾‹åœ¨ Eureka-Server çš„çŠ¶æ€ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceInfo.InstanceStatus lastRemoteInstanceStatus = InstanceInfo.InstanceStatus.UNKNOWN; </div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateInstanceRemoteStatus</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="comment">// Determine this instance's status for this app and set to UNKNOWN if not found</span></div><div class="line"> <span class="number">5</span>:     InstanceInfo.InstanceStatus currentRemoteInstanceStatus = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (instanceInfo.getAppName() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>:         Application app = getApplication(instanceInfo.getAppName());</div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:             InstanceInfo remoteInstanceInfo = app.getByInstanceId(instanceInfo.getId());</div><div class="line"><span class="number">10</span>:             <span class="keyword">if</span> (remoteInstanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">11</span>:                 currentRemoteInstanceStatus = remoteInstanceInfo.getStatus();</div><div class="line"><span class="number">12</span>:             &#125;</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (currentRemoteInstanceStatus == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:         currentRemoteInstanceStatus = InstanceInfo.InstanceStatus.UNKNOWN;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// Notify if status changed</span></div><div class="line"><span class="number">20</span>:     <span class="keyword">if</span> (lastRemoteInstanceStatus != currentRemoteInstanceStatus) &#123;</div><div class="line"><span class="number">21</span>:         onRemoteStatusChanged(lastRemoteInstanceStatus, currentRemoteInstanceStatus);</div><div class="line"><span class="number">22</span>:         lastRemoteInstanceStatus = currentRemoteInstanceStatus;</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 14 è¡Œ ï¼šä»æ³¨å†Œä¿¡æ¯ä¸­è·å–å½“å‰åº”ç”¨åœ¨ Eureka-Server çš„çŠ¶æ€ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šå¯¹æ¯”<strong>æœ¬åœ°ç¼“å­˜</strong>å’Œ<strong>æœ€æ–°çš„</strong>çš„å½“å‰åº”ç”¨å®ä¾‹åœ¨ Eureka-Server çš„çŠ¶æ€ï¼Œè‹¥ä¸åŒï¼Œæ›´æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>( <strong>æ³¨æ„ï¼Œåªæ›´æ–°è¯¥ç¼“å­˜å˜é‡ï¼Œä¸æ›´æ–°æœ¬åœ°å½“å‰åº”ç”¨å®ä¾‹çš„çŠ¶æ€( <code>instanceInfo.status</code> )</strong> )ï¼Œè§¦å‘ StatusChangeEvent äº‹ä»¶ï¼Œäº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œã€‚ç›®å‰ Eureka æœªæä¾›é»˜è®¤çš„è¯¥äº‹ä»¶ç›‘å¬å™¨ã€‚<code>#onRemoteStatusChanged(...)</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRemoteStatusChanged</span><span class="params">(InstanceInfo.InstanceStatus oldStatus, InstanceInfo.InstanceStatus newStatus)</span> </span>&#123;</div><div class="line">   fireEvent(<span class="keyword">new</span> StatusChangeEvent(oldStatus, newStatus));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Eureka-Client æœ¬åœ°åº”ç”¨å®ä¾‹ä¸ Eureka-Server çš„è¯¥åº”ç”¨å®ä¾‹çŠ¶æ€ä¸åŒçš„åŸå› ï¼Œå› ä¸ºåº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul></li></ul><h3>2.4.1 å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜</h3><p>è°ƒç”¨ <code>#getAndStoreFullRegistry()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚ä¸‹å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndStoreFullRegistry</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     logger.info(<span class="string">"Getting all instance registry info from the eureka server"</span>);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// å…¨é‡è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"> <span class="number">7</span>:     Applications apps = <span class="keyword">null</span>;</div><div class="line"> <span class="number">8</span>:     EurekaHttpResponse&lt;Applications&gt; httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></div><div class="line"> <span class="number">9</span>:             ? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get())</div><div class="line"><span class="number">10</span>:             : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</div><div class="line"><span class="number">12</span>:         apps = httpResponse.getEntity();</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>:     logger.info(<span class="string">"The response status is &#123;&#125;"</span>, httpResponse.getStatusCode());</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:     <span class="comment">// è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">if</span> (apps == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:         logger.error(<span class="string">"The application is null for some reason. Not storing this information"</span>);</div><div class="line"><span class="number">19</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</div><div class="line"><span class="number">20</span>:         localRegionApps.set(<span class="keyword">this</span>.filterAndShuffle(apps));</div><div class="line"><span class="number">21</span>:         logger.debug(<span class="string">"Got full registry with apps hashcode &#123;&#125;"</span>, apps.getAppsHashCode());</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">23</span>:         logger.warn(<span class="string">"Not updating applications as another thread is updating it already"</span>);</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 14 è¡Œ ï¼š<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Applications&gt; <span class="title">getApplications</span><span class="params">(String... regions)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> getApplicationsInternal(<span class="string">"apps/"</span>, regions);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> EurekaHttpResponse&lt;Applications&gt; <span class="title">getApplicationsInternal</span><span class="params">(String urlPath, String[] regions)</span> </span>&#123;</div><div class="line">   ClientResponse response = <span class="keyword">null</span>;</div><div class="line">   String regionsParamValue = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       WebResource webResource = jerseyClient.resource(serviceUrl).path(urlPath);</div><div class="line">       <span class="keyword">if</span> (regions != <span class="keyword">null</span> &amp;&amp; regions.length &gt; <span class="number">0</span>) &#123;</div><div class="line">           regionsParamValue = StringUtil.join(regions);</div><div class="line">           webResource = webResource.queryParam(<span class="string">"regions"</span>, regionsParamValue);</div><div class="line">       &#125;</div><div class="line">       Builder requestBuilder = webResource.getRequestBuilder();</div><div class="line">       addExtraHeaders(requestBuilder);</div><div class="line">       response = requestBuilder.accept(MediaType.APPLICATION_JSON_TYPE).get(ClientResponse.class); <span class="comment">// JSON</span></div><div class="line"></div><div class="line">       Applications applications = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (response.getStatus() == Status.OK.getStatusCode() &amp;&amp; response.hasEntity()) &#123;</div><div class="line">           applications = response.getEntity(Applications.class);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus(), Applications.class)</div><div class="line">               .headers(headersOf(response))</div><div class="line">               .entity(applications)</div><div class="line">               .build();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Jersey HTTP GET &#123;&#125;/&#123;&#125;?&#123;&#125;; statusCode=&#123;&#125;"</span>,</div><div class="line">                   serviceUrl, urlPath,</div><div class="line">                   regionsParamValue == <span class="keyword">null</span> ? <span class="string">""</span> : <span class="string">"regions="</span> + regionsParamValue,</div><div class="line">                   response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus()</div><div class="line">           );</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">           response.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#getApplications(...)</code> æ–¹æ³•ï¼ŒGET è¯·æ±‚ Eureka-Server çš„ <code>apps/</code> æ¥å£ï¼Œå‚æ•°ä¸º <code>regions</code> ï¼Œè¿”å›æ ¼å¼ä¸º JSON ï¼Œå®ç°<strong>å…¨é‡è·å–æ³¨å†Œä¿¡æ¯</strong>ã€‚</li></ul></li><li><p>ç¬¬ 16 è‡³ 24 è¡Œ ï¼šè®¾ç½®åˆ°æœ¬åœ°æ³¨å†Œä¿¡æ¯<strong>ç¼“å­˜</strong>ã€‚</p><ul><li>ç¬¬ 19 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</li><li>ç¬¬ 20 è¡Œ ï¼šè°ƒç”¨ <code>#filterAndShuffle(...)</code> æ–¹æ³•ï¼Œæ ¹æ®é…ç½® <code>eureka.shouldFilterOnlyUpInstances = true</code> ( é»˜è®¤å€¼ ï¼š<code>true</code> ) è¿‡æ»¤åªä¿ç•™çŠ¶æ€ä¸ºå¼€å¯( UP )çš„åº”ç”¨å®ä¾‹ï¼Œå¹¶<strong>éšæœºæ‰“ä¹±</strong>åº”ç”¨å®ä¾‹é¡ºåºã€‚æ‰“ä¹±åï¼Œå®ç°è°ƒç”¨åº”ç”¨æœåŠ¡çš„éšæœºæ€§ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/DiscoveryClient.java#L1603" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹æ–¹æ³•å®ç°ã€‚</li></ul></li></ul><h1>3. Eureka-Server æ¥æ”¶å…¨é‡è·å–</h1><h2>3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</h2><p><code>com.netflix.eureka.resources.ApplicationsResource</code>ï¼Œå¤„ç†<strong>æ‰€æœ‰</strong>åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>æ¥æ”¶å…¨é‡è·å–è¯·æ±‚ï¼Œæ˜ å°„ <code>ApplicationsResource#getContainers()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@GET</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">getContainers</span><span class="params">(@PathParam(<span class="string">"version"</span>)</span> String version,</span></div><div class="line"><span class="function"> 3:                               @<span class="title">HeaderParam</span><span class="params">(HEADER_ACCEPT)</span> String acceptHeader,</span></div><div class="line"><span class="function"> 4:                               @<span class="title">HeaderParam</span><span class="params">(HEADER_ACCEPT_ENCODING)</span> String acceptEncoding,</span></div><div class="line"><span class="function"> 5:                               @<span class="title">HeaderParam</span><span class="params">(EurekaAccept.HTTP_X_EUREKA_ACCEPT)</span> String eurekaAccept,</span></div><div class="line"><span class="function"> 6:                               @Context UriInfo uriInfo,</span></div><div class="line"><span class="function"> 7:                               @Nullable @<span class="title">QueryParam</span><span class="params">(<span class="string">"regions"</span>)</span> String regionsStr) </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">boolean</span> isRemoteRegionRequested = <span class="keyword">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();</div><div class="line"><span class="number">10</span>:     String[] regions = <span class="keyword">null</span>;</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (!isRemoteRegionRequested) &#123;</div><div class="line"><span class="number">12</span>:         EurekaMonitors.GET_ALL.increment();</div><div class="line"><span class="number">13</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">14</span>:         regions = regionsStr.toLowerCase().split(<span class="string">","</span>);</div><div class="line"><span class="number">15</span>:         Arrays.sort(regions); <span class="comment">// So we don't have different caches for same regions queried in different order.</span></div><div class="line"><span class="number">16</span>:         EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// Check if the server allows the access to the registry. The server can</span></div><div class="line"><span class="number">21</span>:     <span class="comment">// restrict access if it is not</span></div><div class="line"><span class="number">22</span>:     <span class="comment">// ready to serve traffic depending on various reasons.</span></div><div class="line"><span class="number">23</span>:     <span class="keyword">if</span> (!registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</div><div class="line"><span class="number">24</span>:         <span class="keyword">return</span> Response.status(Status.FORBIDDEN).build();</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:     <span class="comment">// API ç‰ˆæœ¬</span></div><div class="line"><span class="number">28</span>:     CurrentRequestVersion.set(Version.toEnum(version));</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:     <span class="comment">// è¿”å›æ•°æ®æ ¼å¼</span></div><div class="line"><span class="number">31</span>:     KeyType keyType = Key.KeyType.JSON;</div><div class="line"><span class="number">32</span>:     String returnMediaType = MediaType.APPLICATION_JSON;</div><div class="line"><span class="number">33</span>:     <span class="keyword">if</span> (acceptHeader == <span class="keyword">null</span> || !acceptHeader.contains(HEADER_JSON_VALUE)) &#123;</div><div class="line"><span class="number">34</span>:         keyType = Key.KeyType.XML;</div><div class="line"><span class="number">35</span>:         returnMediaType = MediaType.APPLICATION_XML;</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="comment">// å“åº”ç¼“å­˜é”®( KEY )</span></div><div class="line"><span class="number">39</span>:     Key cacheKey = <span class="keyword">new</span> Key(Key.EntityType.Application,</div><div class="line"><span class="number">40</span>:             ResponseCacheImpl.ALL_APPS,</div><div class="line"><span class="number">41</span>:             keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions</div><div class="line"><span class="number">42</span>:     );</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>:     <span class="comment">//</span></div><div class="line"><span class="number">45</span>:     Response response;</div><div class="line"><span class="number">46</span>:     <span class="keyword">if</span> (acceptEncoding != <span class="keyword">null</span> &amp;&amp; acceptEncoding.contains(HEADER_GZIP_VALUE)) &#123;</div><div class="line"><span class="number">47</span>:         response = Response.ok(responseCache.getGZIP(cacheKey))</div><div class="line"><span class="number">48</span>:                 .header(HEADER_CONTENT_ENCODING, HEADER_GZIP_VALUE)</div><div class="line"><span class="number">49</span>:                 .header(HEADER_CONTENT_TYPE, returnMediaType)</div><div class="line"><span class="number">50</span>:                 .build();</div><div class="line"><span class="number">51</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">52</span>:         response = Response.ok(responseCache.get(cacheKey))</div><div class="line"><span class="number">53</span>:                 .build();</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">56</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 8 è‡³ 17 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 19 è‡³ 25 è¡Œ ï¼šEureka-Server å¯åŠ¨å®Œæˆï¼Œä½†æ˜¯æœªå¤„äºå°±ç»ª( Ready )çŠ¶æ€ï¼Œä¸æ¥å—è¯·æ±‚å…¨é‡åº”ç”¨æ³¨å†Œä¿¡æ¯çš„è¯·æ±‚ï¼Œä¾‹å¦‚ï¼ŒEureka-Server å¯åŠ¨æ—¶ï¼Œæœªèƒ½ä»å…¶ä»– Eureka-Server é›†ç¾¤çš„èŠ‚ç‚¹è·å–åˆ°åº”ç”¨æ³¨å†Œä¿¡æ¯ã€‚</p></li><li><p>ç¬¬ 27 è‡³ 28 è¡Œ ï¼šè®¾ç½® API ç‰ˆæœ¬å·ã€‚<strong>é»˜è®¤</strong>æœ€æ–° API ç‰ˆæœ¬ä¸º V2ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Version &#123;</div><div class="line">    V1, V2;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Version <span class="title">toEnum</span><span class="params">(String v)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Version version : Version.values()) &#123;</div><div class="line">            <span class="keyword">if</span> (version.name().equalsIgnoreCase(v)) &#123;</div><div class="line">                <span class="keyword">return</span> version;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//Defaults to v2</span></div><div class="line">        <span class="keyword">return</span> V2;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 30 è‡³ 36 è¡Œ ï¼šè®¾ç½®è¿”å›æ•°æ®æ ¼å¼ï¼Œé»˜è®¤ JSON ã€‚</p></li><li><p>ç¬¬ 38 è‡³ 42 è¡Œ ï¼šåˆ›å»ºå“åº”ç¼“å­˜( ResponseCache ) çš„é”®( KEY )ï¼Œåœ¨ <a href="#">ã€Œ3.2.1 ç¼“å­˜é”®ã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 44 è‡³ 55 è¡Œ ï¼šä»å“åº”ç¼“å­˜è¯»å–<strong>å…¨é‡</strong>æ³¨å†Œä¿¡æ¯ï¼Œåœ¨ <a href="#">ã€Œ3.3 ç¼“å­˜è¯»å–ã€</a>è¯¦ç»†è§£æã€‚</p></li></ul><h2>3.2 å“åº”ç¼“å­˜ ResponseCache</h2><p><code>com.netflix.eureka.registry.ResponseCache</code>ï¼Œå“åº”ç¼“å­˜<strong>æ¥å£</strong>ï¼Œæ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResponseCache</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">get</span><span class="params">(Key key)</span></span>;</div><div class="line">    </div><div class="line">    <span class="keyword">byte</span>[] getGZIP(Key key);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">AtomicLong <span class="title">getVersionDelta</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">AtomicLong <span class="title">getVersionDeltaWithRegions</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å…¶ä¸­ï¼Œ<code>#getVersionDelta()</code> å’Œ <code>#getVersionDeltaWithRegions()</code> å·²ç»åºŸå¼ƒã€‚è¿™é‡Œä¿ç•™çš„åŸå› ä¸»è¦æ˜¯è€ƒè™‘å…¼å®¹æ€§ã€‚åˆ¤æ–­ä¾æ®æ¥è‡ªå¦‚ä¸‹ä»£ç ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="meta">@Deprecated</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVersion</span><span class="params">(Long version)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.versionDelta = version;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationDeltas</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ— å…³ä»£ç </span></div><div class="line">    apps.setVersion(responseCache.getVersionDelta().get()); <span class="comment">// å”¯ä¸€è°ƒç”¨åˆ° ResponseCache#getVersionDelta() æ–¹æ³•çš„åœ°æ–¹</span></div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>#get()</code> ï¼šè·å¾—ç¼“å­˜ã€‚</p></li><li><p><code>#getGZIP()</code> ï¼šè·å¾—ç¼“å­˜ï¼Œå¹¶ GZIP ã€‚</p></li><li><p><code>#invalidate()</code> ï¼šè¿‡æœŸç¼“å­˜ã€‚</p></li></ul><h3>3.2.1 ç¼“å­˜é”®</h3><p><code>com.netflix.eureka.registry.Key</code>ï¼Œç¼“å­˜é”®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Key</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> KeyType &#123;</div><div class="line">        JSON, XML</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * An enum to define the entity that is stored in this cache for this key.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> EntityType &#123;</div><div class="line">        Application, VIP, SVIP</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®ä½“å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String entityName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] regions;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚å‚æ•°ç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KeyType requestType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚ API ç‰ˆæœ¬å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Version requestVersion;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * hashKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String hashKey;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®ä½“ç±»å‹</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EntityType&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EntityType entityType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EurekaAccept&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaAccept eurekaAccept;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">(EntityType entityType, String entityName, KeyType type, Version v, EurekaAccept eurekaAccept, @Nullable String[] regions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regions = regions;</div><div class="line">        <span class="keyword">this</span>.entityType = entityType;</div><div class="line">        <span class="keyword">this</span>.entityName = entityName;</div><div class="line">        <span class="keyword">this</span>.requestType = type;</div><div class="line">        <span class="keyword">this</span>.requestVersion = v;</div><div class="line">        <span class="keyword">this</span>.eurekaAccept = eurekaAccept;</div><div class="line">        hashKey = <span class="keyword">this</span>.entityType + <span class="keyword">this</span>.entityName + (<span class="keyword">null</span> != <span class="keyword">this</span>.regions ? Arrays.toString(<span class="keyword">this</span>.regions) : <span class="string">""</span>)</div><div class="line">                + requestType.name() + requestVersion.name() + <span class="keyword">this</span>.eurekaAccept.name();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">(EntityType entityType, String entityName, KeyType type, Version v, EurekaAccept eurekaAccept, @Nullable String[] regions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regions = regions;</div><div class="line">        <span class="keyword">this</span>.entityType = entityType;</div><div class="line">        <span class="keyword">this</span>.entityName = entityName;</div><div class="line">        <span class="keyword">this</span>.requestType = type;</div><div class="line">        <span class="keyword">this</span>.requestVersion = v;</div><div class="line">        <span class="keyword">this</span>.eurekaAccept = eurekaAccept;</div><div class="line">        hashKey = <span class="keyword">this</span>.entityType + <span class="keyword">this</span>.entityName + (<span class="keyword">null</span> != <span class="keyword">this</span>.regions ? Arrays.toString(<span class="keyword">this</span>.regions) : <span class="string">""</span>)</div><div class="line">                + requestType.name() + requestVersion.name() + <span class="keyword">this</span>.eurekaAccept.name();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        String hashKey = getHashKey();</div><div class="line">        <span class="keyword">return</span> hashKey.hashCode();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (other <span class="keyword">instanceof</span> Key) &#123;</div><div class="line">            <span class="keyword">return</span> getHashKey().equals(((Key) other).getHashKey());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.2 å“åº”ç¼“å­˜å®ç°ç±»</h3><p><code>com.netflix.eureka.registry.ResponseCacheImpl</code>ï¼Œå“åº”ç¼“å­˜å®ç°ç±»ã€‚</p><p>åœ¨ ResponseCacheImpl é‡Œï¼Œå°†ç¼“å­˜æ‹†åˆ†æˆä¸¤å±‚ ï¼š</p><ul><li><strong>åªè¯»ç¼“å­˜</strong>( <code>readOnlyCacheMap</code> )</li><li><strong>å›ºå®šè¿‡æœŸ</strong> + <strong>å›ºå®šå¤§å°</strong>çš„<strong>è¯»å†™ç¼“å­˜</strong>( <code>readWriteCacheMap</code> )</li></ul><p>é»˜è®¤é…ç½®ä¸‹ï¼Œ<strong>ç¼“å­˜è¯»å–ç­–ç•¥</strong>å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/04.png" alt=""></p><p><strong>ç¼“å­˜è¿‡æœŸç­–ç•¥</strong>å¦‚ä¸‹ï¼š</p><ul><li>åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€è¿‡æœŸæ—¶ï¼Œ<strong>åªåªåª</strong>è¿‡æœŸ <code>readWriteCacheMap</code> ã€‚</li><li><code>readWriteCacheMap</code> å†™å…¥ä¸€æ®µæ—¶é—´( å¯é…ç½® )åè‡ªåŠ¨è¿‡æœŸã€‚</li><li><strong>å®šæ—¶</strong>ä»»åŠ¡å¯¹æ¯” <code>readWriteCacheMap</code> å’Œ <code>readOnlyCacheMap</code> çš„ç¼“å­˜å€¼ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œä»¥å‰è€…ä¸ºä¸»ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®ç°äº† <code>readOnlyCacheMap</code> çš„å®šæ—¶è¿‡æœŸã€‚</li></ul><p><strong>æ³¨æ„</strong>ï¼šåº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€è¿‡æœŸæ—¶ï¼Œä¸ä¼šå¾ˆå¿«åˆ·æ–°åˆ° <code>readWriteCacheMap</code> ç¼“å­˜é‡Œã€‚é»˜è®¤é…ç½®ä¸‹ï¼Œæœ€å¤§å»¶è¿Ÿåœ¨ 30 ç§’ã€‚</p><p><strong>ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Ÿ</strong></p><p>åœ¨ <a href="https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86" rel="external nofollow noopener noreferrer" target="_blank">CAP</a> çš„é€‰æ‹©ä¸Šï¼ŒEureka é€‰æ‹©äº† AP ï¼Œä¸åŒäº Zookeeper é€‰æ‹©äº† CP ã€‚</p><p>æ¨èé˜…è¯»ï¼š</p><ul><li><a href="http://dockone.io/article/78" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸ºä»€ä¹ˆä¸åº”è¯¥ä½¿ç”¨ZooKeeperåšæœåŠ¡å‘ç°ã€‹</a></li><li><a href="http://blog.spring-cloud.io/blog/sc-eureka.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Netflix Eurekaæºç å¯¼è¯»ä¸åŸç†åˆ†æã€‹ã€Œ4. ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ŒEurekaæ¯”Zookeeperå¥½åœ¨å“ªé‡Œã€</a></li></ul><h2>3.3 ç¼“å­˜è¯»å–</h2><p>è°ƒç”¨ <code>ResponseCacheImpl#get(...)</code> æ–¹æ³•( <code>#getGzip(...)</code> ç±»ä¼¼ )ï¼Œè¯»å–ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Key, Value&gt; readOnlyCacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Key, Value&gt;();</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Key, Value&gt; readWriteCacheMap;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> Key key)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">return</span> get(key, shouldUseReadOnlyResponseCache);</div><div class="line"> <span class="number">7</span>: &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="function">String <span class="title">get</span><span class="params">(<span class="keyword">final</span> Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:     Value payload = getValue(key, useReadOnlyCache);</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (payload == <span class="keyword">null</span> || payload.getPayload().equals(EMPTY_PAYLOAD)) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">13</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">return</span> payload.getPayload();</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>: &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: <span class="function">Value <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</div><div class="line"><span class="number">19</span>:     Value payload = <span class="keyword">null</span>;</div><div class="line"><span class="number">20</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:         <span class="keyword">if</span> (useReadOnlyCache) &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">final</span> Value currentPayload = readOnlyCacheMap.get(key);</div><div class="line"><span class="number">23</span>:             <span class="keyword">if</span> (currentPayload != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>:                 payload = currentPayload;</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">26</span>:                 payload = readWriteCacheMap.get(key);</div><div class="line"><span class="number">27</span>:                 readOnlyCacheMap.put(key, payload);</div><div class="line"><span class="number">28</span>:             &#125;</div><div class="line"><span class="number">29</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">30</span>:             payload = readWriteCacheMap.get(key);</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">33</span>:         logger.error(<span class="string">"Cannot get value for key :"</span> + key, t);</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> payload;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è‡³ 7 è¡Œ ï¼šè°ƒç”¨ <code>#get(key, useReadOnlyCache)</code> æ–¹æ³•ï¼Œè¯»å–ç¼“å­˜ã€‚å…¶ä¸­ <code>shouldUseReadOnlyResponseCache</code> é€šè¿‡é…ç½® <code>eureka.shouldUseReadOnlyResponseCache = true</code> (é»˜è®¤å€¼ ï¼š<code>true</code> ) å¼€å¯åªè¯»ç¼“å­˜ã€‚å¦‚æœä½ å¯¹æ•°æ®çš„ä¸€è‡´æ€§æœ‰ç›¸å¯¹é«˜çš„è¦æ±‚ï¼Œå¯ä»¥å…³é—­è¿™ä¸ªå¼€å…³ï¼Œå½“ç„¶å› ä¸ºå°‘äº† <code>readOnlyCacheMap</code> ï¼Œæ€§èƒ½ä¼šæœ‰ä¸€å®šçš„ä¸‹é™ã€‚</p></li><li><p>ç¬¬ 9 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>getValue(key, useReadOnlyCache)</code> æ–¹æ³•ï¼Œè¯»å–ç¼“å­˜ã€‚ä» <code>readOnlyCacheMap</code> å’Œ <code>readWriteCacheMap</code> å˜é‡å¯ä»¥çœ‹åˆ°ç¼“å­˜å€¼çš„ç±»ä¸º <code>com.netflix.eureka.registry.ResponseCacheImpl.Value</code> ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Value</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * åŸå§‹å€¼</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String payload;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * GZIP å‹ç¼©åçš„å€¼</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] gzipped;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Value</span><span class="params">(String payload)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.payload = payload;</div><div class="line">       <span class="keyword">if</span> (!EMPTY_PAYLOAD.equals(payload)) &#123;</div><div class="line">           <span class="comment">// ... çœç•¥ GZIP å‹ç¼©ä»£ç </span></div><div class="line">           gzipped = bos.toByteArray();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           gzipped = <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getPayload</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> payload;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="keyword">byte</span>[] getGzipped() &#123;</div><div class="line">       <span class="keyword">return</span> gzipped;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 21 è‡³ 31 è¡Œ ï¼šè¯»å–ç¼“å­˜ã€‚</p><ul><li><p>ç¬¬ 21 è‡³ 28 è¡Œ ï¼šå…ˆè¯»å– <code>readOnlyCacheMap</code> ã€‚è¯»å–ä¸åˆ°ï¼Œè¯»å– <code>readWriteCacheMap</code> ï¼Œå¹¶è®¾ç½®åˆ° <code>readOnlyCacheMap</code> ã€‚</p></li><li><p>ç¬¬ 29 è‡³ 31 è¡Œ ï¼šè¯»å– <code>readWriteCacheMap</code> ã€‚</p></li><li><p><code>readWriteCacheMap</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.readWriteCacheMap =</div><div class="line">      CacheBuilder.newBuilder().initialCapacity(<span class="number">1000</span>)</div><div class="line">              .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)</div><div class="line">              .removalListener(<span class="keyword">new</span> RemovalListener&lt;Key, Value&gt;() &#123;</div><div class="line">                  <span class="meta">@Override</span></div><div class="line">                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Key, Value&gt; notification)</span> </span>&#123;</div><div class="line">                      <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">                      Key removedKey = notification.getKey();</div><div class="line">                      <span class="keyword">if</span> (removedKey.hasRegions()) &#123;</div><div class="line">                          Key cloneWithNoRegions = removedKey.cloneWithoutRegions();</div><div class="line">                          regionSpecificKeys.remove(cloneWithNoRegions, removedKey);</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;)</div><div class="line">              .build(<span class="keyword">new</span> CacheLoader&lt;Key, Value&gt;() &#123;</div><div class="line">                  <span class="meta">@Override</span></div><div class="line">                  <span class="function"><span class="keyword">public</span> Value <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                      <span class="comment">// // TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">                      <span class="keyword">if</span> (key.hasRegions()) &#123;</div><div class="line">                          Key cloneWithNoRegions = key.cloneWithoutRegions();</div><div class="line">                          regionSpecificKeys.put(cloneWithNoRegions, key);</div><div class="line">                      &#125;</div><div class="line">                      Value value = generatePayload(key);</div><div class="line">                      <span class="keyword">return</span> value;</div><div class="line">                  &#125;</div><div class="line">              &#125;);</div></pre></td></tr></table></figure></p><ul><li><code>readWriteCacheMap</code> æœ€å¤§ç¼“å­˜æ•°é‡ä¸º 1000 ã€‚</li><li>è°ƒç”¨ <code>#generatePayload(key)</code> æ–¹æ³•ï¼Œç”Ÿæˆç¼“å­˜å€¼ã€‚</li></ul></li></ul></li><li><p><code>#generatePayload(key)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Value <span class="title">generatePayload</span><span class="params">(Key key)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     Stopwatch tracer = <span class="keyword">null</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         String payload;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">switch</span> (key.getEntityType()) &#123;</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> Application:</div><div class="line"> <span class="number">7</span>:                 <span class="keyword">boolean</span> isRemoteRegionRequested = key.hasRegions();</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (ALL_APPS.equals(key.getName())) &#123;</div><div class="line"><span class="number">10</span>:                     <span class="keyword">if</span> (isRemoteRegionRequested) &#123; <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="number">11</span>:                         tracer = serializeAllAppsWithRemoteRegionTimer.start();</div><div class="line"><span class="number">12</span>:                         payload = getPayLoad(key, registry.getApplicationsFromMultipleRegions(key.getRegions()));</div><div class="line"><span class="number">13</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">14</span>:                         tracer = serializeAllAppsTimer.start();</div><div class="line"><span class="number">15</span>:                         payload = getPayLoad(key, registry.getApplications());</div><div class="line"><span class="number">16</span>:                     &#125;</div><div class="line"><span class="number">17</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ALL_APPS_DELTA.equals(key.getName())) &#123;</div><div class="line"><span class="number">18</span>:                     <span class="comment">// ... çœç•¥å¢é‡è·å–ç›¸å…³çš„ä»£ç </span></div><div class="line"><span class="number">19</span>:                  &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:                     tracer = serializeOneApptimer.start();</div><div class="line"><span class="number">21</span>:                     payload = getPayLoad(key, registry.getApplication(key.getName()));</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:             <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">new</span> Value(payload);</div><div class="line"><span class="number">27</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             tracer.stop();</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 10 è‡³ 12 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 13 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>AbstractInstanceRegistry#getApplications()</code> æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€‚åè°ƒç”¨ <code>#getPayLoad()</code> æ–¹æ³•ï¼Œå°†æ³¨å†Œçš„åº”ç”¨é›†åˆè½¬æ¢æˆç¼“å­˜å€¼ã€‚ğŸ™‚ è¿™ä¸¤ä¸ªæ–¹æ³•ä»£ç è¾ƒå¤šï¼Œä¸‹é¢è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 17 è‡³ 18 è¡Œ ï¼šè·å–å¢é‡æ³¨å†Œä¿¡æ¯çš„ç¼“å­˜å€¼ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h3>3.3.1 è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆ</h3><p>è°ƒç”¨ <code>AbstractInstanceRegistry#getApplications()</code> æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] EMPTY_STR_ARRAY = <span class="keyword">new</span> String[<span class="number">0</span>];</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:    <span class="keyword">boolean</span> disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();</div><div class="line"> <span class="number">7</span>:    <span class="keyword">if</span> (disableTransparentFallback) &#123; <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">8</span>:        <span class="keyword">return</span> getApplicationsFromLocalRegionOnly();</div><div class="line"> <span class="number">9</span>:    &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:        <span class="keyword">return</span> getApplicationsFromAllRemoteRegions();  <span class="comment">// Behavior of falling back to remote region can be disabled.</span></div><div class="line"><span class="number">11</span>:    &#125;</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromLocalRegionOnly</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">15</span>:    <span class="keyword">return</span> getApplicationsFromMultipleRegions(EMPTY_STR_ARRAY);</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 8 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 9 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>#getApplicationsFromMultipleRegions(...)</code> æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromMultipleRegions</span><span class="params">(String[] remoteRegions)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">boolean</span> includeRemoteRegion = <span class="keyword">null</span> != remoteRegions &amp;&amp; remoteRegions.length != <span class="number">0</span>;</div><div class="line"> <span class="number">4</span>:     logger.debug(<span class="string">"Fetching applications registry with remote regions: &#123;&#125;, Regions argument &#123;&#125;"</span>,</div><div class="line"> <span class="number">5</span>:             includeRemoteRegion, Arrays.toString(remoteRegions));</div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (includeRemoteRegion) &#123;</div><div class="line"> <span class="number">7</span>:         GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS.increment();</div><div class="line"> <span class="number">8</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">9</span>:         GET_ALL_CACHE_MISS.increment();</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>:     <span class="comment">// è·å¾—è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆ</span></div><div class="line"><span class="number">12</span>:     Applications apps = <span class="keyword">new</span> Applications();</div><div class="line"><span class="number">13</span>:     apps.setVersion(<span class="number">1L</span>);</div><div class="line"><span class="number">14</span>:     <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; entry : registry.entrySet()) &#123;</div><div class="line"><span class="number">15</span>:         Application app = <span class="keyword">null</span>;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (entry.getValue() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; stringLeaseEntry : entry.getValue().entrySet()) &#123;</div><div class="line"><span class="number">19</span>:                 Lease&lt;InstanceInfo&gt; lease = stringLeaseEntry.getValue();</div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:                     app = <span class="keyword">new</span> Application(lease.getHolder().getAppName());</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:                 app.addInstance(decorateInstanceInfo(lease));</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">27</span>:             apps.addApplication(app);</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="number">31</span>:     <span class="keyword">if</span> (includeRemoteRegion) &#123;</div><div class="line"><span class="number">32</span>:         <span class="keyword">for</span> (String remoteRegion : remoteRegions) &#123;</div><div class="line"><span class="number">33</span>:             RemoteRegionRegistry remoteRegistry = regionNameVSRemoteRegistry.get(remoteRegion);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegistry) &#123;</div><div class="line"><span class="number">35</span>:                 Applications remoteApps = remoteRegistry.getApplications();</div><div class="line"><span class="number">36</span>:                 <span class="keyword">for</span> (Application application : remoteApps.getRegisteredApplications()) &#123;</div><div class="line"><span class="number">37</span>:                     <span class="keyword">if</span> (shouldFetchFromRemoteRegistry(application.getName(), remoteRegion)) &#123;</div><div class="line"><span class="number">38</span>:                         logger.info(<span class="string">"Application &#123;&#125;  fetched from the remote region &#123;&#125;"</span>,</div><div class="line"><span class="number">39</span>:                                 application.getName(), remoteRegion);</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>:                         Application appInstanceTillNow = apps.getRegisteredApplications(application.getName());</div><div class="line"><span class="number">42</span>:                         <span class="keyword">if</span> (appInstanceTillNow == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">43</span>:                             appInstanceTillNow = <span class="keyword">new</span> Application(application.getName());</div><div class="line"><span class="number">44</span>:                             apps.addApplication(appInstanceTillNow);</div><div class="line"><span class="number">45</span>:                         &#125;</div><div class="line"><span class="number">46</span>:                         <span class="keyword">for</span> (InstanceInfo instanceInfo : application.getInstances()) &#123;</div><div class="line"><span class="number">47</span>:                             appInstanceTillNow.addInstance(instanceInfo);</div><div class="line"><span class="number">48</span>:                         &#125;</div><div class="line"><span class="number">49</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">50</span>:                         logger.debug(<span class="string">"Application &#123;&#125; not fetched from the remote region &#123;&#125; as there exists a "</span></div><div class="line"><span class="number">51</span>:                                         + <span class="string">"whitelist and this app is not in the whitelist."</span>,</div><div class="line"><span class="number">52</span>:                                 application.getName(), remoteRegion);</div><div class="line"><span class="number">53</span>:                     &#125;</div><div class="line"><span class="number">54</span>:                 &#125;</div><div class="line"><span class="number">55</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">56</span>:                 logger.warn(<span class="string">"No remote registry available for the remote region &#123;&#125;"</span>, remoteRegion);</div><div class="line"><span class="number">57</span>:             &#125;</div><div class="line"><span class="number">58</span>:         &#125;</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>:     <span class="comment">// è®¾ç½® åº”ç”¨é›†åˆ hashcode</span></div><div class="line"><span class="number">61</span>:     apps.setAppsHashCode(apps.getReconcileHashCode());</div><div class="line"><span class="number">62</span>:     <span class="keyword">return</span> apps;</div><div class="line"><span class="number">63</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ ç¬¬ 10 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 11 è‡³ 29 è¡Œ ï¼šè·å¾—è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€‚</li><li>ç¬¬ 30 è‡³ 59 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 61 è¡Œ ï¼šè®¡ç®—åº”ç”¨é›†åˆ <code>hashcode</code> ã€‚è¯¥å˜é‡ç”¨äºæ ¡éªŒ<strong>å¢é‡</strong>è·å–çš„æ³¨å†Œä¿¡æ¯å’Œ Eureka-Server <strong>å…¨é‡</strong>çš„æ³¨å†Œä¿¡æ¯æ˜¯å¦ä¸€è‡´( å®Œæ•´ )ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h3>3.3.2 è½¬æ¢æˆç¼“å­˜å€¼</h3><p>è°ƒç”¨ <code>#getPayLoad()</code> æ–¹æ³•ï¼Œå°†æ³¨å†Œçš„åº”ç”¨é›†åˆè½¬æ¢æˆç¼“å­˜å€¼ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Generate pay load with both JSON and XML formats for all applications.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getPayLoad</span><span class="params">(Key key, Applications apps)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾—ç¼–ç å™¨</span></div><div class="line">   EncoderWrapper encoderWrapper = serverCodecs.getEncoder(key.getType(), key.getEurekaAccept());</div><div class="line">   String result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// ç¼–ç </span></div><div class="line">       result = encoderWrapper.encode(apps);</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.error(<span class="string">"Failed to encode the payload for all apps"</span>, e);</div><div class="line">       <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span>(logger.isDebugEnabled()) &#123;</div><div class="line">       logger.debug(<span class="string">"New application cache entry &#123;&#125; with apps hashcode &#123;&#125;"</span>, key.toStringCompact(), apps.getAppsHashCode());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.4 ä¸»åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</h2><p>åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€è¿‡æœŸæ—¶ï¼Œè°ƒç”¨ <code>ResponseCacheImpl#invalidate()</code> æ–¹æ³•ï¼Œä¸»åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜( <code>readWriteCacheMap</code> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Key.KeyType type : Key.KeyType.values()) &#123;</div><div class="line">       <span class="keyword">for</span> (Version v : Version.values()) &#123;</div><div class="line">           invalidate(</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, appName, type, v, EurekaAccept.full),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, appName, type, v, EurekaAccept.compact),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS, type, v, EurekaAccept.full),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS, type, v, EurekaAccept.compact),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS_DELTA, type, v, EurekaAccept.full),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS_DELTA, type, v, EurekaAccept.compact)</div><div class="line">           );</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != vipAddress) &#123;</div><div class="line">               invalidate(<span class="keyword">new</span> Key(Key.EntityType.VIP, vipAddress, type, v, EurekaAccept.full));</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != secureVipAddress) &#123;</div><div class="line">               invalidate(<span class="keyword">new</span> Key(Key.EntityType.SVIP, secureVipAddress, type, v, EurekaAccept.full));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#invalidate(keys)</code> æ–¹æ³•ï¼Œé€ä¸ªè¿‡æœŸæ¯ä¸ªç¼“å­˜é”®å€¼ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(Key... keys)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Key key : keys) &#123;</div><div class="line">       logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;, &#123;&#125;"</span>, key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept());</div><div class="line">       <span class="comment">// è¿‡æœŸè¯»å†™ç¼“å­˜</span></div><div class="line">       readWriteCacheMap.invalidate(key);</div><div class="line">       <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">       Collection&lt;Key&gt; keysWithRegions = regionSpecificKeys.get(key);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != keysWithRegions &amp;&amp; !keysWithRegions.isEmpty()) &#123;</div><div class="line">           <span class="keyword">for</span> (Key keysWithRegion : keysWithRegions) &#123;</div><div class="line">               logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</div><div class="line">                       key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept());</div><div class="line">               readWriteCacheMap.invalidate(keysWithRegion);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>3.5 è¢«åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</h2><p>è¯»å†™ç¼“å­˜( <code>readWriteCacheMap</code> ) å†™å…¥åï¼Œä¸€æ®µæ—¶é—´è‡ªåŠ¨è¿‡æœŸï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds())</div></pre></td></tr></table></figure></p><ul><li>é…ç½® <code>eureka.responseCacheAutoExpirationInSeconds</code> ï¼Œè®¾ç½®å†™å…¥è¿‡æœŸæ—¶é•¿ã€‚é»˜è®¤å€¼ ï¼š180 ç§’ã€‚</li></ul><h2>3.6 å®šæ—¶åˆ·æ–°åªè¯»ç¼“å­˜</h2><p><strong>å®šæ—¶</strong>ä»»åŠ¡å¯¹æ¯” <code>readWriteCacheMap</code> å’Œ <code>readOnlyCacheMap</code> çš„ç¼“å­˜å€¼ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œä»¥å‰è€…ä¸ºä¸»ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®ç°äº† <code>readOnlyCacheMap</code> çš„å®šæ—¶è¿‡æœŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: ResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) &#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// ... çœç•¥æ— å…³ä»£ç  </span></div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">long</span> responseCacheUpdateIntervalMs = serverConfig.getResponseCacheUpdateIntervalMs();</div><div class="line"> <span class="number">5</span>:     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (shouldUseReadOnlyResponseCache) &#123;</div><div class="line"> <span class="number">8</span>:         timer.schedule(getCacheUpdateTask(),</div><div class="line"> <span class="number">9</span>:                 <span class="keyword">new</span> Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)</div><div class="line"><span class="number">10</span>:                         + responseCacheUpdateIntervalMs),</div><div class="line"><span class="number">11</span>:                 responseCacheUpdateIntervalMs);</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="function"><span class="keyword">private</span> TimerTask <span class="title">getCacheUpdateTask</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">18</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</div><div class="line"><span class="number">19</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">20</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">21</span>:             logger.debug(<span class="string">"Updating the client cache from response cache"</span>);</div><div class="line"><span class="number">22</span>:             <span class="keyword">for</span> (Key key : readOnlyCacheMap.keySet()) &#123; <span class="comment">// å¾ªç¯ readOnlyCacheMap çš„ç¼“å­˜é”®</span></div><div class="line"><span class="number">23</span>:                 <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">24</span>:                     Object[] args = &#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType()&#125;;</div><div class="line"><span class="number">25</span>:                     logger.debug(<span class="string">"Updating the client cache from response cache for key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, args);</div><div class="line"><span class="number">26</span>:                 &#125;</div><div class="line"><span class="number">27</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">28</span>:                     CurrentRequestVersion.set(key.getVersion());</div><div class="line"><span class="number">29</span>:                     Value cacheValue = readWriteCacheMap.get(key);</div><div class="line"><span class="number">30</span>:                     Value currentCacheValue = readOnlyCacheMap.get(key);</div><div class="line"><span class="number">31</span>:                     <span class="keyword">if</span> (cacheValue != currentCacheValue) &#123; <span class="comment">// ä¸ä¸€è‡´æ—¶ï¼Œè¿›è¡Œæ›¿æ¢</span></div><div class="line"><span class="number">32</span>:                         readOnlyCacheMap.put(key, cacheValue);</div><div class="line"><span class="number">33</span>:                     &#125;</div><div class="line"><span class="number">34</span>:                 &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line"><span class="number">35</span>:                     logger.error(<span class="string">"Error while updating the client cache from response cache for key &#123;&#125;"</span>, key.toStringCompact(), th);</div><div class="line"><span class="number">36</span>:                 &#125;</div><div class="line"><span class="number">37</span>:             &#125;</div><div class="line"><span class="number">38</span>:         &#125;</div><div class="line"><span class="number">39</span>:     &#125;;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 12 è¡Œ ï¼šåˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ã€‚é…ç½® <code>eureka.responseCacheUpdateIntervalMs</code>ï¼Œè®¾ç½®ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œé»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚</li><li>ç¬¬ 17 è‡³ 39 è¡Œ ï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚<ul><li>ç¬¬ 22 è¡Œ ï¼šå¾ªç¯ <code>readOnlyCacheMap</code> çš„ç¼“å­˜é”®ã€‚<strong>ä¸ºä»€ä¹ˆä¸å¾ªç¯ <code>readWriteCacheMap</code> å‘¢</strong>ï¼Ÿ <code>readOnlyCacheMap</code> çš„ç¼“å­˜è¿‡æœŸä¾èµ–  <code>readWriteCacheMap</code>ï¼Œå› æ­¤ç¼“å­˜é”®ä¼šæ›´å¤šã€‚</li><li>ç¬¬ 28 è¡Œ è‡³ 33 è¡Œ ï¼šå¯¹æ¯” <code>readWriteCacheMap</code> å’Œ <code>readOnlyCacheMap</code> çš„ç¼“å­˜å€¼ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œä»¥å‰è€…ä¸ºä¸»ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®ç°äº† <code>readOnlyCacheMap</code> çš„å®šæ—¶è¿‡æœŸã€‚</li></ul></li></ul><h1>666. å½©è›‹</h1><p>æ¯”é¢„æœŸï¼Œæ¯”æƒ³æƒ³ï¼Œé•¿è€å¤šè€å¤šçš„ä¸€ç¯‡æ–‡ç« ã€‚ç»†æ€ææã€‚</p><p>ä¼°è®¡ä¸‹ä¸€ç¯‡å¢é‡è·å–ä¼šç®€æ´å¾ˆå¤šã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-all/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸ</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-evict/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-evict/</id>
    <published>2018-06-21T16:00:00.000Z</published>
    <updated>2017-10-12T05:39:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-evict/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">3. EvictionTask</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">4. è¿‡æœŸé€»è¾‘</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server è¿‡æœŸè¶…æ—¶ç»­ç§Ÿçš„ç§Ÿçº¦</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_22/01.png" alt=""></p></blockquote><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</h1><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨å®ä¾‹ä¸‹çº¿æ—¶å€™ä¼šä¸»åŠ¨å‘ Eureka-Server å‘èµ·ä¸‹çº¿è¯·æ±‚ã€‚ä½†å®é™…æƒ…å†µä¸‹ï¼Œåº”ç”¨å®ä¾‹å¯èƒ½å¼‚å¸¸å´©æºƒï¼Œåˆæˆ–è€…æ˜¯ç½‘ç»œå¼‚å¸¸ç­‰åŸå› ï¼Œå¯¼è‡´ä¸‹çº¿è¯·æ±‚æ— æ³•è¢«æˆåŠŸæäº¤ã€‚</p><p>ä»‹äºè¿™ç§æƒ…å†µï¼Œé€šè¿‡ Eureka-Client å¿ƒè·³å»¶é•¿ç§Ÿçº¦ï¼Œé…åˆ Eureka-Server æ¸…ç†è¶…æ—¶çš„ç§Ÿçº¦è§£å†³ä¸Šè¿°å¼‚å¸¸ã€‚</p><h1>3. EvictionTask</h1><p><code>com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask</code>ï¼Œæ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡ã€‚åœ¨ Eureka-Server å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ– EvictionTask å®šæ—¶æ‰§è¡Œï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;EvictionTask&gt; evictionTaskRef = <span class="keyword">new</span> AtomicReference&lt;EvictionTask&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postInit</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– æ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (evictionTaskRef.get() != <span class="keyword">null</span>) &#123;</div><div class="line">       evictionTaskRef.get().cancel();</div><div class="line">   &#125;</div><div class="line">   evictionTaskRef.set(<span class="keyword">new</span> EvictionTask());</div><div class="line">   evictionTimer.schedule(evictionTaskRef.get(),</div><div class="line">           serverConfig.getEvictionIntervalTimerInMs(),</div><div class="line">           serverConfig.getEvictionIntervalTimerInMs());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>é…ç½® <code>eureka.evictionIntervalTimerInMs</code> ï¼Œæ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤ï¼Œ60000 æ¯«ç§’ã€‚</p></li><li><p>EvictionTask å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EvictionTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å– è¡¥å¿æ—¶é—´æ¯«ç§’æ•°</span></div><div class="line">           <span class="keyword">long</span> compensationTimeMs = getCompensationTimeMs();</div><div class="line">           logger.info(<span class="string">"Running the evict task with compensationTime &#123;&#125;ms"</span>, compensationTimeMs);</div><div class="line">           <span class="comment">// æ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘</span></div><div class="line">           evict(compensationTimeMs);</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">           logger.error(<span class="string">"Could not run the evict task"</span>, e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#compensationTimeMs()</code> æ–¹æ³•ï¼Œè·å¾—è¡¥å¿æ—¶é—´æ¯«ç§’æ•°ã€‚è®¡ç®—å…¬å¼ = å½“å‰æ—¶é—´ - æœ€åä»»åŠ¡æ‰§è¡Œæ—¶é—´ - ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ã€‚ä¸ºä»€ä¹ˆéœ€è¦è¡¥å¿æ—¶é—´æ¯«ç§’æ•°ï¼Œåœ¨ <a href="#">ã€Œ4. è¿‡æœŸé€»è¾‘ã€<code>Lease#isisExpired(additionalLeaseMs)</code> æ–¹æ³•</a> æ­æ™“ã€‚<code>#compensationTimeMs()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åä»»åŠ¡æ‰§è¡Œæ—¶é—´</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastExecutionNanosRef = <span class="keyword">new</span> AtomicLong(<span class="number">0L</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">getCompensationTimeMs</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> currNanos = getCurrentTimeNano();</div><div class="line">    <span class="keyword">long</span> lastNanos = lastExecutionNanosRef.getAndSet(currNanos);</div><div class="line">    <span class="keyword">if</span> (lastNanos == <span class="number">0L</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);</div><div class="line">    <span class="keyword">long</span> compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();</div><div class="line">    <span class="keyword">return</span> compensationTime &lt;= <span class="number">0L</span> ? <span class="number">0L</span> : compensationTime;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç”±äº JVM GC ï¼Œåˆæˆ–æ˜¯æ—¶é—´åç§»( clock skew ) ç­‰åŸå› ï¼Œå®šæ—¶å™¨æ‰§è¡Œå®é™…æ¯”é¢„æœŸä¼š<strong>ç•¥æœ‰å»¶è¿Ÿ</strong>ã€‚ç¬”è€…åœ¨æœ¬æœº<strong>ä½è´Ÿè½½</strong>è¿è¡Œï¼Œå¤§æ¦‚ 10 ms å†…ã€‚</p><blockquote><p>compute a compensation time defined as the actual time this task was executed since the prev iteration, vs the configured amount of time for execution. This is useful for cases where changes in time (due to clock skew or gc for example) causes the actual eviction task to execute later than the desired time according to the configured cycle.</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>#evict(compensationTime)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4. è¿‡æœŸé€»è¾‘ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h1>4. è¿‡æœŸé€»è¾‘</h1><p>è°ƒç”¨ <code>#evict(compensationTime)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     logger.debug(<span class="string">"Running the evict task"</span>);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class="line"> <span class="number">5</span>:         logger.debug(<span class="string">"DS: lease expiration is currently disabled."</span>);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="comment">// è·å¾— æ‰€æœ‰è¿‡æœŸçš„ç§Ÿçº¦</span></div><div class="line"><span class="number">10</span>:     <span class="comment">// We collect first all expired items, to evict them in random order. For large eviction sets,</span></div><div class="line"><span class="number">11</span>:     <span class="comment">// if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,</span></div><div class="line"><span class="number">12</span>:     <span class="comment">// the impact should be evenly distributed across all applications.</span></div><div class="line"><span class="number">13</span>:     List&lt;Lease&lt;InstanceInfo&gt;&gt; expiredLeases = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">14</span>:     <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; groupEntry : registry.entrySet()) &#123;</div><div class="line"><span class="number">15</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = groupEntry.getValue();</div><div class="line"><span class="number">16</span>:         <span class="keyword">if</span> (leaseMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">17</span>:             <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseEntry : leaseMap.entrySet()) &#123;</div><div class="line"><span class="number">18</span>:                 Lease&lt;InstanceInfo&gt; lease = leaseEntry.getValue();</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (lease.isExpired(additionalLeaseMs) &amp;&amp; lease.getHolder() != <span class="keyword">null</span>) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"><span class="number">20</span>:                     expiredLeases.add(lease);</div><div class="line"><span class="number">21</span>:                 &#125;</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="comment">// è®¡ç®— æœ€å¤§å…è®¸æ¸…ç†ç§Ÿçº¦æ•°é‡</span></div><div class="line"><span class="number">27</span>:     <span class="comment">// To compensate for GC pauses or drifting local time, we need to use current registry size as a base for</span></div><div class="line"><span class="number">28</span>:     <span class="comment">// triggering self-preservation. Without that we would wipe out full registry.</span></div><div class="line"><span class="number">29</span>:     <span class="keyword">int</span> registrySize = (<span class="keyword">int</span>) getLocalRegistrySize();</div><div class="line"><span class="number">30</span>:     <span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (registrySize * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">31</span>:     <span class="keyword">int</span> evictionLimit = registrySize - registrySizeThreshold;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:     <span class="comment">// è®¡ç®— æ¸…ç†ç§Ÿçº¦æ•°é‡</span></div><div class="line"><span class="number">34</span>:     <span class="keyword">int</span> toEvict = Math.min(expiredLeases.size(), evictionLimit);</div><div class="line"><span class="number">35</span>:     <span class="keyword">if</span> (toEvict &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:         logger.info(<span class="string">"Evicting &#123;&#125; items (expired=&#123;&#125;, evictionLimit=&#123;&#125;)"</span>, toEvict, expiredLeases.size(), evictionLimit);</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:         <span class="comment">// é€ä¸ªè¿‡æœŸ</span></div><div class="line"><span class="number">39</span>:         Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</div><div class="line"><span class="number">40</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toEvict; i++) &#123;</div><div class="line"><span class="number">41</span>:             <span class="comment">// Pick a random item (Knuth shuffle algorithm)</span></div><div class="line"><span class="number">42</span>:             <span class="keyword">int</span> next = i + random.nextInt(expiredLeases.size() - i);</div><div class="line"><span class="number">43</span>:             Collections.swap(expiredLeases, i, next);</div><div class="line"><span class="number">44</span>:             Lease&lt;InstanceInfo&gt; lease = expiredLeases.get(i);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:             String appName = lease.getHolder().getAppName();</div><div class="line"><span class="number">47</span>:             String id = lease.getHolder().getId();</div><div class="line"><span class="number">48</span>:             EXPIRED.increment();</div><div class="line"><span class="number">49</span>:             logger.warn(<span class="string">"DS: Registry: expired lease for &#123;&#125;/&#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">50</span>:             internalCancel(appName, id, <span class="keyword">false</span>);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>:     &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 7 è¡Œ ï¼šåˆ¤æ–­å…è®¸æ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œä¸»è¦å’Œ<strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>æœ‰å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 9 è‡³ 24 è¡Œ ï¼šè·å¾—<strong>æ‰€æœ‰è¿‡æœŸ</strong>çš„ç§Ÿçº¦é›†åˆã€‚</p><ul><li><p>ç¬¬ 19 è¡Œ ï¼šè°ƒç”¨ <code>Lease#isisExpired(additionalLeaseMs)</code> æ–¹æ³•ï¼Œåˆ¤æ–­ç§Ÿçº¦æ˜¯å¦è¿‡æœŸï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lease.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpired</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> (evictionTimestamp &gt; <span class="number">0</span> || System.currentTimeMillis() &gt; (lastUpdateTimestamp + duration + additionalLeaseMs));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">   lastUpdateTimestamp = System.currentTimeMillis() + duration;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ğŸ˜ˆ<strong>æ³¨æ„</strong>ï¼šåœ¨ä¸è€ƒè™‘ <code>additionalLeaseMs</code> å‚æ•°çš„æƒ…å†µä¸‹ï¼Œç§Ÿçº¦è¿‡æœŸæ—¶é—´æ¯”é¢„æœŸå¤šäº†<strong>ä¸€ä¸ª</strong> <code>duration</code>ï¼ŒåŸå› åœ¨äº <code>#renew()</code> æ–¹æ³•é”™è¯¯çš„è®¾ç½® <code>lastUpdateTimestamp = System.currentTimeMillis() + duration</code>ï¼Œæ­£ç¡®çš„è®¾ç½®åº”è¯¥æ˜¯ <code>lastUpdateTimestamp = System.currentTimeMillis()</code> ã€‚</p><blockquote><p>Note that due to renew() doing the 'wrong&quot; thing and setting lastUpdateTimestamp to +duration more than what it should be, the expiry will actually be 2 * duration. <strong>This is a minor bug and should only affect instances that ungracefully shutdown. Due to possible wide ranging impact to existing usage, this will not be fixed</strong>.</p></blockquote></li><li><p>TODO[0023]ï¼šadditionalLeaseMs</p></li></ul></li></ul></li><li><p>ç¬¬ 26 è‡³ 34 è¡Œ ï¼šè®¡ç®—<strong>æœ€å¤§å…è®¸</strong>æ¸…ç†ç§Ÿçº¦çš„æ•°é‡ï¼Œåè®¡ç®—å…è®¸æ¸…ç†ç§Ÿçº¦çš„æ•°é‡ã€‚</p><ul><li><p>ğŸ˜ˆ<strong>æ³¨æ„</strong>ï¼šå³ä½¿ Eureka-Server å…³é—­<strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>ï¼Œå¦‚æœä½¿ç”¨<code>renewalPercentThreshold = 0.85</code> é»˜è®¤é…ç½®ï¼Œç»“æœä¼šæ˜¯<strong>åˆ†æ‰¹é€æ­¥</strong>è¿‡æœŸã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// å‡è®¾ 20 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 10 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬ä¸€è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">20</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">20</span> * <span class="number">0.85</span>) = <span class="number">17</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">20</span> - <span class="number">17</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">10</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬ä¸€è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 17 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 7 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬äºŒè½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">17</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">17</span> * <span class="number">0.85</span>) = <span class="number">14</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">17</span> - <span class="number">14</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">7</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬äºŒè½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 14 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 4 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬ä¸‰è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">14</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">14</span> * <span class="number">0.85</span>) = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">14</span> - <span class="number">11</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">4</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬ä¸‰è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 11 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 1 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬å››è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">11</span> * <span class="number">0.85</span>) = <span class="number">9</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">11</span> - <span class="number">9</span> = <span class="number">2</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">1</span>, <span class="number">2</span>) = <span class="number">1</span>;</div><div class="line"><span class="comment">// ç¬¬å››è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 10 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 0 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚ç»“æŸã€‚</span></div></pre></td></tr></table></figure></p><ul><li>ç»“è®ºï¼šæ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤çš„å·®åˆ«ï¼Œåœ¨äºæ˜¯å¦æ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ã€‚å¦‚æœæƒ³å…³é—­<strong>åˆ†æ‰¹é€æ­¥</strong>è¿‡æœŸï¼Œè®¾ç½® <code>renewalPercentThreshold = 0</code> ã€‚</li></ul></li><li><p>ç”±äº JVM GC ï¼Œæˆ–æ˜¯æœ¬åœ°æ—¶é—´å·®å¼‚åŸå› ï¼Œå¯èƒ½è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶çš„é˜€å€¼ <code>expectedNumberOfRenewsPerMin</code>ã€<code>numberOfRenewsPerMinThreshold</code> ä¸å¤Ÿæ­£ç¡®ï¼Œåœ¨<strong>è¿‡æœŸ</strong>è¿™ä¸ªç›¸å¯¹â€œå±é™©â€çš„æ“ä½œï¼Œ<strong>é‡æ–°è®¡ç®—è‡ªæˆ‘ä¿æŠ¤</strong>çš„é˜€å€¼ã€‚</p></li></ul></li><li><p>ç¬¬ 35 è‡³ 51 è¡Œ ï¼š<strong>éšæœº</strong>æ¸…ç†è¿‡æœŸçš„ç§Ÿçº¦ã€‚ç”±äºç§Ÿçº¦æ˜¯æŒ‰ç…§<strong>åº”ç”¨é¡ºåº</strong>æ·»åŠ åˆ°æ•°ç»„ï¼Œé€šè¿‡éšæœºçš„æ–¹å¼ï¼Œ<strong>å°½é‡é¿å…å•ä¸ªåº”ç”¨è¢«å…¨éƒ¨è¿‡æœŸ</strong>ã€‚</p><ul><li>ç¬¬ 39 è¡Œ ï¼šä¼ å…¥å½“å‰æ—¶é—´ä¸ºç§å­ç”Ÿæˆéšæœºï¼Œé¿å… Java çš„ä¼ªéšæœºæƒ…å†µã€‚åœ¨ <a href="http://www.cnblogs.com/greatfish/p/5845924.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸ºä»€ä¹ˆè¯´Javaä¸­çš„éšæœºæ•°éƒ½æ˜¯ä¼ªéšæœºæ•°ï¼Ÿã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 41 è‡³ 43 è¡Œ ï¼šéšæœºè°ƒæ¢åé¢çš„å…ƒç´ åˆ°å½“å‰ä½ç½®( <code>i</code> )ã€‚</li></ul></li><li><p>ç¬¬ 50 è¡Œ ï¼šè°ƒç”¨ <code>#internalCancel()</code> æ–¹æ³•ï¼Œä¸‹çº¿å·²è¿‡æœŸçš„ç§Ÿçº¦ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹ã€Œ3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>ğŸ˜« åŸæœ¬è§‰å¾—æ¯”è¾ƒå®¹æ˜“çš„ä¸€ç¯‡æ–‡ç« ï¼Œç»“æœæ¶ˆè€—äº†æ¯”æƒ³è±¡ä¸­çš„æ—¶é—´ï¼Œå¯èƒ½æœ‰å››ä¸ªå°æ—¶ã€‚ä¸»è¦å¡åœ¨è¡¥å¿æ—¶é—´ï¼Œç›®å‰ä¹Ÿæ²¡å¼„æ‡‚ã€‚å¦‚æœæœ‰çŸ¥é“çš„èƒ–å‹ï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-evict/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-self-preservation/</id>
    <published>2018-06-14T16:00:00.000Z</published>
    <updated>2017-10-12T05:39:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-self-preservation/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">2. å®šä¹‰</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3. å®ç°</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3.1 è§¦å‘æ¡ä»¶</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3.2 è®¡ç®—å…¬å¼</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3.3 è®¡ç®—æ—¶æœº</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>ï¼Œä¸ºåº”ç”¨å®ä¾‹è¿‡æœŸä¸‹çº¿åšé“ºå«ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li></ul><h1>2. å®šä¹‰</h1><p>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="http://www.itmuch.com/spring-cloud-sum/understanding-eureka-self-preservation/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">å‘¨ç«‹ â€”â€” ã€Šç†è§£Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‹</a><br>å½“Eureka ServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚ä¸€æ—¦è¿›å…¥è¯¥æ¨¡å¼ï¼ŒEureka Serverå°±ä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šæ³¨é”€ä»»ä½•å¾®æœåŠ¡ï¼‰ã€‚å½“ç½‘ç»œæ•…éšœæ¢å¤åï¼Œè¯¥Eureka ServerèŠ‚ç‚¹ä¼šè‡ªåŠ¨é€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p></blockquote><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶</strong> ï¼Ÿä½ ä¹Ÿå¯ä»¥ä»å‘¨ç«‹å…„çš„<strong>è¿™ç¯‡æ–‡ç« å¾—åˆ°ç­”æ¡ˆ</strong>ï¼Œè¿™é‡Œç¬”è€…å°±ä¸ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“äº†ã€‚</p><h1>3. å®ç°</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹åœ¨è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶é‡Œæ‰®æ¼”<strong>é‡è¦</strong>è§’è‰²çš„ä¸¤ä¸ªå˜é‡ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœŸæœ›æœ€å°æ¯åˆ†é’Ÿç»­ç§Ÿæ¬¡æ•°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">int</span> numberOfRenewsPerMinThreshold;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœŸæœ›æœ€å¤§æ¯åˆ†é’Ÿç»­ç§Ÿæ¬¡æ•°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">int</span> expectedNumberOfRenewsPerMin;</div></pre></td></tr></table></figure></p><ul><li><code>expectedNumberOfRenewsPerMin</code> ï¼ŒæœŸæœ›<strong>æœ€å¤§</strong>æ¯åˆ†é’Ÿ<strong>ç»­ç§Ÿ</strong>æ¬¡æ•°ã€‚</li><li><code>numberOfRenewsPerMinThreshold</code> ï¼ŒæœŸæœ›<strong>æœ€å°</strong>æ¯åˆ†é’Ÿ<strong>ç»­ç§Ÿ</strong>æ¬¡æ•°ã€‚</li></ul><h2>3.1 è§¦å‘æ¡ä»¶</h2><p>å½“æ¯åˆ†é’Ÿå¿ƒè·³æ¬¡æ•°( <code>renewsLastMin</code> ) <strong>å°äº</strong> <code>numberOfRenewsPerMinThreshold</code> æ—¶ï¼Œå¹¶ä¸”å¼€å¯è‡ªåŠ¨ä¿æŠ¤æ¨¡å¼å¼€å…³( <code>eureka.enableSelfPreservation = true</code> ) æ—¶ï¼Œ<strong>è§¦å‘è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ï¼Œä¸å†è‡ªåŠ¨è¿‡æœŸç§Ÿçº¦</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class="line">       logger.debug(<span class="string">"DS: lease expiration is currently disabled."</span>);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// ... çœç•¥è¿‡æœŸç§Ÿçº¦é€»è¾‘</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeaseExpirationEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!isSelfPreservationModeEnabled()) &#123;</div><div class="line">       <span class="comment">// The self preservation mode is disabled, hence allowing the instances to expire.</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> numberOfRenewsPerMinThreshold &gt; <span class="number">0</span> &amp;&amp; getNumOfRenewsInLastMin() &gt; numberOfRenewsPerMinThreshold;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 è®¡ç®—å…¬å¼</h2><p>è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><ul><li><code>expectedNumberOfRenewsPerMin</code> = å½“å‰æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•° <code>x</code> 2</li><li><code>numberOfRenewsPerMinThreshold</code> = <code>expectedNumberOfRenewsPerMin</code> <code>*</code> ç»­ç§Ÿç™¾åˆ†æ¯”( <code>eureka.renewalPercentThreshold</code> )</li></ul><p><strong>ä¸ºä»€ä¹ˆä¹˜ä»¥ 2</strong></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ³¨å†Œçš„åº”ç”¨å®ä¾‹æ¯åŠåˆ†é’Ÿç»­ç§Ÿä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€åˆ†é’Ÿå¿ƒè·³<strong>ä¸¤æ¬¡</strong>ï¼Œå› æ­¤ x 2 ã€‚</p><p>è¿™å—ä¼šæœ‰ä¸€äº›ç¡¬ç¼–ç çš„æƒ…å†µï¼Œ<strong>å› æ­¤ä¸å¤ªå»ºè®®ä¿®æ”¹åº”ç”¨å®ä¾‹çš„ç»­ç§Ÿé¢‘ç‡</strong>ã€‚</p><p><strong>ä¸ºä»€ä¹ˆä¹˜ä»¥ç»­ç§Ÿç™¾åˆ†æ¯”</strong></p><p>ä½äºè¿™ä¸ªç™¾åˆ†æ¯”ï¼Œæ„å‘³ç€å¼€å¯è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>eureka.renewalPercentThreshold = 0.85</code> ã€‚</p><p>å¦‚æœä½ çœŸçš„è°ƒæ•´äº†<strong>ç»­ç§Ÿé¢‘ç‡</strong>ï¼Œå¯ä»¥ç­‰æ¯”å»ç»­ç§Ÿç™¾åˆ†æ¯”ï¼Œä»¥ä¿è¯åˆé€‚çš„è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶çš„é˜€å€¼ã€‚å¦å¤–ï¼Œä½ éœ€è¦æ³¨æ„ï¼Œç»­ç§Ÿé¢‘ç‡æ˜¯ Client çº§åˆ«ï¼Œç»­ç§Ÿç™¾åˆ†æ¯”æ˜¯ Server çº§åˆ«ã€‚</p><h2>3.3 è®¡ç®—æ—¶æœº</h2><p>ç›®å‰æœ‰<strong>å››</strong>ä¸ªåœ°æ–¹ä¼šè®¡ç®— <code>numberOfRenewsPerMinThreshold</code> ã€ <code>expectedNumberOfRenewsPerMin</code>ï¼Œæˆ‘ä»¬é€å°èŠ‚æ¥çœ‹ã€‚</p><h3>3.3.1 Eureka-Server åˆå§‹åŒ–</h3><p>Eureka-Server åœ¨å¯åŠ¨æ—¶ï¼Œä» Eureka-Server é›†ç¾¤è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶<strong>é¦–æ¬¡</strong>åˆå§‹åŒ– <code>numberOfRenewsPerMinThreshold</code> ã€ <code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaBootStrap.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initEurekaServerContext</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒä»£ç </span></div><div class="line"></div><div class="line">    <span class="comment">// ã€2.2.10ã€‘ä»å…¶ä»– Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</span></div><div class="line">    <span class="comment">// Copy registry from neighboring eureka node</span></div><div class="line">    <span class="keyword">int</span> registryCount = registry.syncUp();</div><div class="line">    registry.openForTraffic(applicationInfoManager, registryCount);</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">   <span class="comment">// Renewals happen every 30 seconds and for a minute it should be a factor of 2.</span></div><div class="line">   <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = count * <span class="number">2</span>;</div><div class="line">   <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</div><div class="line">           (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">           </div><div class="line">   <span class="comment">// ... çœç•¥å…¶å®ƒä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.3.2 å®šæ—¶é‡ç½®</h3><p>Eureka-Server <strong>å®šæ—¶</strong>é‡æ–°è®¡ç®— <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleRenewalThresholdUpdateTask</span><span class="params">()</span> </span>&#123;</div><div class="line">   timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line">                      <span class="meta">@Override</span></div><div class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                          updateRenewalThreshold();</div><div class="line">                      &#125;</div><div class="line">                  &#125;, serverConfig.getRenewalThresholdUpdateIntervalMs(),</div><div class="line">           serverConfig.getRenewalThresholdUpdateIntervalMs());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è‡ªæˆ‘ä¿æŠ¤æœºé”</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* å½“è®¡ç®—å¦‚ä¸‹å‚æ•°æ—¶ä½¿ç”¨ï¼š</span></div><div class="line"><span class="comment">*  1. &#123;<span class="doctag">@link</span> #numberOfRenewsPerMinThreshold&#125;</span></div><div class="line"><span class="comment">*  2. &#123;<span class="doctag">@link</span> #expectedNumberOfRenewsPerMin&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRenewalThreshold</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è®¡ç®— åº”ç”¨å®ä¾‹æ•°</span></div><div class="line">       Applications apps = eurekaClient.getApplications();</div><div class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;</div><div class="line">           <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line">               <span class="keyword">if</span> (<span class="keyword">this</span>.isRegisterable(instance)) &#123;</div><div class="line">                   ++count;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è®¡ç®— expectedNumberOfRenewsPerMin ã€ numberOfRenewsPerMinThreshold å‚æ•°</span></div><div class="line">       <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">           <span class="comment">// Update threshold only if the threshold is greater than the</span></div><div class="line">           <span class="comment">// current expected threshold of if the self preservation is disabled.</span></div><div class="line">           <span class="keyword">if</span> ((count * <span class="number">2</span>) &gt; (serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold)</div><div class="line">                   || (!<span class="keyword">this</span>.isSelfPreservationModeEnabled())) &#123;</div><div class="line">               <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = count * <span class="number">2</span>;</div><div class="line">               <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) ((count * <span class="number">2</span>) * serverConfig.getRenewalPercentThreshold());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       logger.info(<span class="string">"Current renewal threshold is : &#123;&#125;"</span>, numberOfRenewsPerMinThreshold);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot update renewal threshold"</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é…ç½® <code>eureka.renewalThresholdUpdateIntervalMs</code> å‚æ•°ï¼Œå®šæ—¶é‡æ–°è®¡ç®—ã€‚é»˜è®¤ï¼Œ15 åˆ†é’Ÿã€‚</li><li><strong>ä»£ç å—</strong> <code>!this.isSelfPreservationModeEnabled()</code> ï¼šå½“<strong>æœªå¼€å¯</strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œæ¯æ¬¡éƒ½è¿›è¡Œé‡æ–°è®¡ç®—ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸ä»…ä»…è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ä¼šä½¿ç”¨åˆ°ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›† <code>numberOfRenewsPerMinThreshold</code>ã€<code>expectedNumberOfRenewsPerMin</code>ã€‚</li><li><strong>ä»£ç å—</strong> <code>(count * 2) &gt; (serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold)</code> ï¼šå½“<strong>å¼€å¯</strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œåº”ç”¨å®ä¾‹æ¯åˆ†é’Ÿæœ€å¤§å¿ƒè·³æ•°( <code>count * 2</code> ) å°äºæœŸæœ›<strong>æœ€å°</strong>æ¯åˆ†é’Ÿ<strong>ç»­ç§Ÿ</strong>æ¬¡æ•°( <code>serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold</code> )ï¼Œä¸é‡æ–°è®¡ç®—ã€‚<strong>å¦‚æœé‡æ–°è®¡ç®—ï¼Œè‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ä¼šæ¯æ¬¡å®šæ—¶æ‰§è¡Œåå¤±æ•ˆ</strong>ã€‚</li></ul><h3>3.3.3 åº”ç”¨å®ä¾‹æ³¨å†Œ</h3><p>åº”ç”¨å®ä¾‹æ³¨å†Œæ—¶ï¼Œå¢åŠ  <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="comment">// The lease does not exist and hence it is a new registration</span></div><div class="line">    <span class="comment">// ã€è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‘å¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line">    <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line">             <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></div><div class="line">             <span class="comment">// (1</span></div><div class="line">             <span class="comment">// for 30 seconds, 2 for a minute)</span></div><div class="line">             <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</div><div class="line">             <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</div><div class="line">                     (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.3.4 åº”ç”¨å®ä¾‹ä¸‹çº¿</h3><p>åº”ç”¨å®ä¾‹ä¸‹çº¿æ—¶ï¼Œå‡å°‘ <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></div><div class="line"><span class="function"><span class="params">                     <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                     </div><div class="line">   <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)</span></div><div class="line">               <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin - <span class="number">2</span>;</div><div class="line">               <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">        &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>ğŸ˜ˆ ç»ˆäºå®Œæ•´ç†è§£ Eureka-Server è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œæ»¡è¶³ã€‚å™¶~~~~~~</p><p>æ¨èå¦ä¸€ç¯‡ Eureka-Server è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æºç åˆ†ææ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000009795944" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç†è§£eurekaçš„è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-self-preservation/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/str
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸‰ï¼‰ä¹‹ä¸‹çº¿</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-cancel/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-cancel/</id>
    <published>2018-06-07T16:00:00.000Z</published>
    <updated>2017-10-18T18:03:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-cancel/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">2. Eureka-Client å‘èµ·ä¸‹çº¿</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">3. Eureka-Server æ¥æ”¶ä¸‹çº¿</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">3.1 æ¥æ”¶ä¸‹çº¿è¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server ä¸‹çº¿åº”ç”¨å®ä¾‹çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> äºŒæ¬¡ç¼–è¾‘<br><img src="../../../images/Eureka/2018_06_08/01.jpeg" alt=""></p></blockquote><ul><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚</li><li>é<strong>è“æ¡†</strong>éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li></ul><h1>2. Eureka-Client å‘èµ·ä¸‹çº¿</h1><p>åº”ç”¨å®ä¾‹å…³é—­æ—¶ï¼ŒEureka-Client å‘ Eureka-Server å‘èµ·ä¸‹çº¿åº”ç”¨å®ä¾‹ã€‚éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶æ‰å¯å‘èµ·ï¼š</p><ul><li>é…ç½® <code>eureka.registration.enabled = true</code> ï¼Œåº”ç”¨å®ä¾‹å¼€å¯æ³¨å†Œå¼€å…³ã€‚é»˜è®¤ä¸º <code>false</code> ã€‚</li><li>é…ç½® <code>eureka.shouldUnregisterOnShutdown = true</code> ï¼Œåº”ç”¨å®ä¾‹å¼€å¯å…³é—­æ—¶ä¸‹çº¿å¼€å…³ã€‚é»˜è®¤ä¸º <code>true</code> ã€‚</li></ul><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="comment">// If APPINFO was registered</span></div><div class="line">    <span class="keyword">if</span> (applicationInfoManager != <span class="keyword">null</span></div><div class="line">         &amp;&amp; clientConfig.shouldRegisterWithEureka() <span class="comment">// eureka.registration.enabled = true</span></div><div class="line">         &amp;&amp; clientConfig.shouldUnregisterOnShutdown()) &#123; <span class="comment">// eureka.shouldUnregisterOnShutdown = true</span></div><div class="line">        applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</div><div class="line">        unregister();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ApplicationInfoManager#setInstanceStatus(...)</code> æ–¹æ³•ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹ä¸ºå…³é—­( DOWN )ã€‚</p></li><li><p>è°ƒç”¨ <code>#unregister()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// It can be null if shouldRegisterWithEureka == false</span></div><div class="line">   <span class="keyword">if</span>(eurekaTransport != <span class="keyword">null</span> &amp;&amp; eurekaTransport.registrationClient != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           logger.info(<span class="string">"Unregistering ..."</span>);</div><div class="line">           EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());</div><div class="line">           logger.info(PREFIX + appPathIdentifier + <span class="string">" - deregister  status: "</span> + httpResponse.getStatusCode());</div><div class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">           logger.error(PREFIX + appPathIdentifier + <span class="string">" - de-registration failed"</span> + e.getMessage(), e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">cancel</span><span class="params">(String appName, String id)</span> </span>&#123;</div><div class="line">    String urlPath = <span class="string">"apps/"</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">    ClientResponse response = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</div><div class="line">        addExtraHeaders(resourceBuilder);</div><div class="line">        response = resourceBuilder.delete(ClientResponse.class);</div><div class="line">        <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"Jersey HTTP DELETE &#123;&#125;/&#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">            response.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#cancel(...)</code> æ–¹æ³•ï¼Œ<code>DELETE</code> è¯·æ±‚ Eureka-Server çš„ <code>apps/${APP_NAME}/${INSTANCE_INFO_ID}</code> æ¥å£ï¼Œå®ç°åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ä¸‹çº¿ã€‚</li></ul></li></ul><h1>3. Eureka-Server æ¥æ”¶ä¸‹çº¿</h1><h2>3.1 æ¥æ”¶ä¸‹çº¿è¯·æ±‚</h2><p><code>com.netflix.eureka.resources.InstanceResource</code>ï¼Œå¤„ç†<strong>å•ä¸ª</strong>åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ <code>InstanceResource#cancelLease()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">cancelLease</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">       @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</div><div class="line">   <span class="comment">// ä¸‹çº¿</span></div><div class="line">   <span class="keyword">boolean</span> isSuccess = registry.cancel(app.getName(), id, <span class="string">"true"</span>.equals(isReplication));</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (isSuccess) &#123; <span class="comment">// ä¸‹çº¿æˆåŠŸ</span></div><div class="line">       logger.debug(<span class="string">"Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</div><div class="line">       <span class="keyword">return</span> Response.ok().build();</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä¸‹çº¿æˆåŠŸ</span></div><div class="line">       logger.info(<span class="string">"Not Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</div><div class="line">       <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#cancel(...)</code> æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                       <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (<span class="keyword">super</span>.cancel(appName, id, isReplication)) &#123; <span class="comment">// ä¸‹çº¿</span></div><div class="line"> <span class="number">5</span>:         <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line"> <span class="number">6</span>:         replicateToPeers(Action.Cancel, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</div><div class="line"> <span class="number">7</span>:         <span class="comment">// å‡å°‘ `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">10</span>:                 <span class="comment">// Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)</span></div><div class="line"><span class="number">11</span>:                 <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin - <span class="number">2</span>;</div><div class="line"><span class="number">12</span>:                 <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">18</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šè°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#cancel(...)</code> æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šEureka-Server å¤åˆ¶ä¸‹çº¿æ“ä½œï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 7 è‡³ 14 è¡Œ ï¼šå‡å°‘ <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code>ï¼Œè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#cancel(...)</code> æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">return</span> internalCancel(appName, id, isReplication);</div><div class="line"> <span class="number">4</span>: &#125;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">internalCancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾—è¯»é”</span></div><div class="line"> <span class="number">9</span>:         read.lock();</div><div class="line"><span class="number">10</span>:         <span class="comment">// å¢åŠ  å–æ¶ˆæ³¨å†Œæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"><span class="number">11</span>:         CANCEL.increment(isReplication);</div><div class="line"><span class="number">12</span>:         <span class="comment">// ç§»é™¤ ç§Ÿçº¦æ˜ å°„</span></div><div class="line"><span class="number">13</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line"><span class="number">14</span>:         Lease&lt;InstanceInfo&gt; leaseToCancel = <span class="keyword">null</span>;</div><div class="line"><span class="number">15</span>:         <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:             leaseToCancel = gMap.remove(id);</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:         <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘å–æ¶ˆæ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="number">19</span>:         <span class="keyword">synchronized</span> (recentCanceledQueue) &#123;</div><div class="line"><span class="number">20</span>:             recentCanceledQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(System.currentTimeMillis(), appName + <span class="string">"("</span> + id + <span class="string">")"</span>));</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:         <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„</span></div><div class="line"><span class="number">23</span>:         InstanceStatus instanceStatus = overriddenInstanceStatusMap.remove(id);</div><div class="line"><span class="number">24</span>:         <span class="keyword">if</span> (instanceStatus != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">25</span>:             logger.debug(<span class="string">"Removed instance id &#123;&#125; from the overridden map which has value &#123;&#125;"</span>, id, instanceStatus.name());</div><div class="line"><span class="number">26</span>:         &#125;</div><div class="line"><span class="number">27</span>:         <span class="comment">// ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (leaseToCancel == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             CANCEL_NOT_FOUND.increment(isReplication); <span class="comment">// æ·»åŠ  å–æ¶ˆæ³¨å†Œä¸å­˜åœ¨ åˆ° ç›‘æ§</span></div><div class="line"><span class="number">30</span>:             logger.warn(<span class="string">"DS: Registry: cancel failed because Lease is not registered for: &#123;&#125;/&#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">31</span>:             <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// å¤±è´¥</span></div><div class="line"><span class="number">32</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">33</span>:             <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„å–æ¶ˆæ³¨å†Œæ—¶é—´æˆ³</span></div><div class="line"><span class="number">34</span>:             leaseToCancel.cancel();</div><div class="line"><span class="number">35</span>:             <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="number">36</span>:             InstanceInfo instanceInfo = leaseToCancel.getHolder();</div><div class="line"><span class="number">37</span>:             String vip = <span class="keyword">null</span>;</div><div class="line"><span class="number">38</span>:             String svip = <span class="keyword">null</span>;</div><div class="line"><span class="number">39</span>:             <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">40</span>:                 instanceInfo.setActionType(ActionType.DELETED);</div><div class="line"><span class="number">41</span>:                 recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(leaseToCancel));</div><div class="line"><span class="number">42</span>:                 instanceInfo.setLastUpdatedTimestamp();</div><div class="line"><span class="number">43</span>:                 vip = instanceInfo.getVIPAddress();</div><div class="line"><span class="number">44</span>:                 svip = instanceInfo.getSecureVipAddress();</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:             <span class="comment">// è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"><span class="number">47</span>:             invalidateCache(appName, vip, svip);</div><div class="line"><span class="number">48</span>:             logger.info(<span class="string">"Cancelled instance &#123;&#125;/&#123;&#125; (replication=&#123;&#125;)"</span>, appName, id, isReplication);</div><div class="line"><span class="number">49</span>:             <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// æˆåŠŸ</span></div><div class="line"><span class="number">50</span>:         &#125;</div><div class="line"><span class="number">51</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">52</span>:         <span class="comment">// é‡Šæ”¾é”</span></div><div class="line"><span class="number">53</span>:         read.unlock();</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 9 è¡Œ ï¼šè·å–è¯»é”ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/?self">ã€ŠEurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 10 è‡³ 11 è¡Œ ï¼šå¢åŠ ä¸‹çº¿æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 12 è‡³ 17 è¡Œ ï¼šç§»é™¤ç§Ÿçº¦æ˜ å°„( <code>registry</code> )ã€‚</p></li><li><p>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ åˆ°æœ€è¿‘ä¸‹çº¿çš„<strong>è°ƒè¯•</strong>é˜Ÿåˆ—( <code>recentCanceledQueue</code> )ï¼Œç”¨äº Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤ºï¼Œæ— å®é™…ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘å–æ¶ˆæ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">* key ï¼šæ·»åŠ æ—¶çš„æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">* value ï¼šå­—ç¬¦ä¸² = åº”ç”¨å(åº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å·)</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CircularQueue&lt;Pair&lt;Long, String&gt;&gt; recentCanceledQueue;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šç§»é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 27 è‡³ 31 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›ä¸‹çº¿å¤±è´¥( <code>false</code> )ã€‚</p></li><li><p>ç¬¬ 34 è¡Œ ï¼šè°ƒç”¨ <code>Lease#cancel()</code> æ–¹æ³•ï¼Œå–æ¶ˆç§Ÿçº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lease.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (evictionTimestamp &lt;= <span class="number">0</span>) &#123;</div><div class="line">       evictionTimestamp = System.currentTimeMillis();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„<strong>æ“ä½œç±»å‹ä¸ºæ·»åŠ </strong>ï¼Œå¹¶æ·»åŠ åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( <code>recentlyChangedQueue</code> )ã€‚<code>recentlyChangedQueue</code> ç”¨äºæ³¨å†Œä¿¡æ¯çš„<strong>å¢é‡</strong>è·å–ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt;();</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 47 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜( ResponseCache )è¿‡æœŸï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 49 è¡Œ ï¼šè¿”å›ä¸‹çº¿å¤±è´¥( <code>false</code> )ã€‚</p></li><li><p>ç¬¬ 53 è¡Œ ï¼šé‡Šæ”¾é”ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>æ°´æ›´ä¸€ç¯‡ï¼Œä¸‹ä¸€ç¯‡<strong>ç§Ÿçº¦è¿‡æœŸ</strong>ï¼èµ°èµ·ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-cancel/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;u
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿ</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-renew/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-renew/</id>
    <published>2018-05-31T16:00:00.000Z</published>
    <updated>2017-10-17T14:06:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-renew/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2. Eureka-Client å‘èµ·ç»­ç§Ÿ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2.1 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2.2 HeartbeatThread</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2.3 TimedSupervisorTask</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">3. Eureka-Server æ¥æ”¶ç»­ç§Ÿ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">3.1 æ¥æ”¶ç»­ç§Ÿè¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">3.2 ç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server ç»­ç§Ÿåº”ç”¨å®ä¾‹çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> äºŒæ¬¡ç¼–è¾‘<br><img src="http://www.iocoder.cn/images/Eureka/2018_06_01/01.jpeg" alt=""></p></blockquote><ul><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚</li><li>é<strong>è“æ¡†</strong>éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li></ul><h1>2. Eureka-Client å‘èµ·ç»­ç§Ÿ</h1><p>Eureka-Client å‘ Eureka-Server å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹æˆåŠŸåè·å¾—ç§Ÿçº¦ ( Lease )ã€‚Eureka-Client <strong>å›ºå®šé—´éš”</strong>å‘ Eureka-Server å‘èµ·<strong>ç»­ç§Ÿ</strong>( renew )ï¼Œé¿å…ç§Ÿçº¦è¿‡æœŸã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç§Ÿçº¦æœ‰æ•ˆæœŸä¸º 90 ç§’ï¼Œç»­ç§Ÿé¢‘ç‡ä¸º 30 ç§’ã€‚ä¸¤è€…æ¯”ä¾‹ä¸º 1 : 3 ï¼Œä¿è¯åœ¨ç½‘ç»œå¼‚å¸¸ç­‰æƒ…å†µä¸‹ï¼Œæœ‰ä¸‰æ¬¡é‡è¯•çš„æœºä¼šã€‚</p><h2>2.1 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</h2><p>Eureka-Client åœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/?self">åˆå§‹åŒ–</a>è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º<strong>å¿ƒè·³</strong>çº¿ç¨‹ï¼Œ<strong>å›ºå®šé—´éš”</strong>å‘ Eureka-Server å‘èµ·<strong>ç»­ç§Ÿ</strong>( renew )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"></div><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">               Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">               <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                       .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">                       .setDaemon(<span class="keyword">true</span>)</div><div class="line">                       .build());</div><div class="line"></div><div class="line">    heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">              <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">              <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">              <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                      .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</div><div class="line">                      .setDaemon(<span class="keyword">true</span>)</div><div class="line">                      .build()</div><div class="line">    );  <span class="comment">// use direct handoff</span></div><div class="line">      </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">  </div><div class="line">    <span class="comment">// ã€3.2.14ã€‘åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</span></div><div class="line">    initScheduledTasks();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">    <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">        <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs(); <span class="comment">// ç»­ç§Ÿé¢‘ç‡</span></div><div class="line">        <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound(); <span class="comment">//</span></div><div class="line">        logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</div><div class="line"></div><div class="line">        <span class="comment">// Heartbeat timer</span></div><div class="line">        scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"heartbeat"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       heartbeatExecutor,</div><div class="line">                       renewalIntervalInSecs,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> HeartbeatThread()</div><div class="line">               ),</div><div class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</div><div class="line">               </div><div class="line">          <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">     &#125;</div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>scheduler</code>ï¼Œå®šæ—¶ä»»åŠ¡æœåŠ¡ï¼Œç”¨äºå®šæ—¶è§¦å‘å¿ƒè·³( ç»­ç§Ÿ )ã€‚ç»†å¿ƒå¦‚ä½ ï¼Œä¼šå‘ç°ä»»åŠ¡æäº¤çš„æ–¹å¼æ˜¯ <code>ScheduledExecutorService#schedule(...)</code> æ–¹æ³•ï¼Œ<strong>åªå»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡å¿ƒè·³ï¼Œè¯´å¥½çš„å›ºå®šé¢‘ç‡æ‰§è¡Œå¿ƒè·³å‘¢</strong>ï¼ï¼ï¼ç­”æ¡ˆåœ¨ <a href="#">ã€Œ2.3 TimedSupervisorTaskã€</a> æ­æ™“ã€‚</li><li><code>heartbeatExecutor</code>ï¼Œå¿ƒè·³ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± ã€‚ä¸ºä»€ä¹ˆæœ‰ <code>scheduler</code> çš„æƒ…å†µä¸‹ï¼Œè¿˜æœ‰ <code>heartbeatExecutor</code> ï¼Ÿï¼Ÿï¼Ÿç­”æ¡ˆä¹Ÿåœ¨ <a href="#">ã€Œ2.3 TimedSupervisorTaskã€</a> æ­æ™“ã€‚</li><li>HeartbeatThreadï¼Œå¿ƒè·³çº¿ç¨‹ï¼Œåœ¨<a href="#">ã€Œ2.2 TimedSupervisorTaskã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>2.2 HeartbeatThread</h2><p><code>com.netflix.discovery.DiscoveryClient.HeartbeatThread</code>ï¼Œå¿ƒè·³çº¿ç¨‹ï¼Œ<strong>å®ç°</strong>æ‰§è¡Œ Eureka-Client å‘ Eureka-Server å‘èµ·<strong>ç»­ç§Ÿ</strong>( renew )è¯·æ±‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸå‘ Eureka-Server å¿ƒè·³æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (renew()) &#123;</div><div class="line">           lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#renew</code> æ–¹æ³•ï¼Œæ‰§è¡Œç»­ç§Ÿé€»è¾‘ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">   EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</div><div class="line">       logger.debug(<span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</div><div class="line">       <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) &#123;</div><div class="line">           REREGISTER_COUNTER.increment();</div><div class="line">           logger.info(<span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</div><div class="line">           <span class="keyword">long</span> timestamp = instanceInfo.setIsDirtyWithTime();</div><div class="line">           <span class="comment">// å‘èµ·æ³¨å†Œ</span></div><div class="line">           <span class="keyword">boolean</span> success = register();</div><div class="line">           <span class="keyword">if</span> (success) &#123;</div><div class="line">               instanceInfo.unsetIsDirty(timestamp);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> success;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#sendHeartBeat(...)</code> æ–¹æ³•ï¼Œå‘èµ·<strong>ç»­ç§Ÿè¯·æ±‚</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;InstanceInfo&gt; <span class="title">sendHeartBeat</span><span class="params">(String appName, String id, InstanceInfo info, InstanceStatus overriddenStatus)</span> </span>&#123;</div><div class="line">   String urlPath = <span class="string">"apps/"</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">   ClientResponse response = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       WebResource webResource = jerseyClient.resource(serviceUrl)</div><div class="line">               .path(urlPath)</div><div class="line">               .queryParam(<span class="string">"status"</span>, info.getStatus().toString())</div><div class="line">               .queryParam(<span class="string">"lastDirtyTimestamp"</span>, info.getLastDirtyTimestamp().toString());</div><div class="line">       <span class="keyword">if</span> (overriddenStatus != <span class="keyword">null</span>) &#123;</div><div class="line">           webResource = webResource.queryParam(<span class="string">"overriddenstatus"</span>, overriddenStatus.name());</div><div class="line">       &#125;</div><div class="line">       Builder requestBuilder = webResource.getRequestBuilder();</div><div class="line">       addExtraHeaders(requestBuilder);</div><div class="line">       response = requestBuilder.put(ClientResponse.class);</div><div class="line">       EurekaHttpResponseBuilder&lt;InstanceInfo&gt; eurekaResponseBuilder = anEurekaHttpResponse(response.getStatus(), InstanceInfo.class).headers(headersOf(response));</div><div class="line">       <span class="keyword">if</span> (response.hasEntity()) &#123;</div><div class="line">           eurekaResponseBuilder.entity(response.getEntity(InstanceInfo.class));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> eurekaResponseBuilder.build();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Jersey HTTP PUT &#123;&#125;/&#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">           response.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>PUT è¯·æ±‚ Eureka-Server çš„ <code>apps/${APP_NAME}/${INSTANCE_INFO_ID}</code> æ¥å£ï¼Œå‚æ•°ä¸º <code>status</code>ã€<code>lastDirtyTimestamp</code>ã€<code>overriddenstatus</code>ï¼Œå®ç°ç»­ç§Ÿã€‚</li></ul></li><li><p>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#register(...)</code> æ–¹æ³•ï¼Œå½“ Eureka-Server <strong>ä¸å­˜åœ¨ç§Ÿçº¦</strong>æ—¶ï¼Œé‡æ–°å‘èµ·æ³¨å†Œï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h2>2.3 TimedSupervisorTask</h2><p><code>com.netflix.discovery.TimedSupervisorTask</code>ï¼Œç›‘ç®¡<strong>å®šæ—¶ä»»åŠ¡</strong>çš„ä»»åŠ¡ã€‚</p><blockquote><p>A supervisor task that schedules subtasks while enforce a timeout.</p></blockquote><p>åˆ›å»º TimedSupervisorTask ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimedSupervisorTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter timeoutCounter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter rejectedCounter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter throwableCounter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LongGauge threadPoolLevelGauge;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå­ä»»åŠ¡çº¿ç¨‹æ± </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor executor;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å­ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable task;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å½“å‰ä»»å­åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong delay;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€å¤§å­ä»»åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * å­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æƒ…å†µä¸‹ä½¿ç”¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> maxDelay;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimedSupervisorTask</span><span class="params">(String name, ScheduledExecutorService scheduler, ThreadPoolExecutor executor,</span></span></div><div class="line"><span class="function"><span class="params">                               <span class="keyword">int</span> timeout, TimeUnit timeUnit, <span class="keyword">int</span> expBackOffBound, Runnable task)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.scheduler = scheduler;</div><div class="line">        <span class="keyword">this</span>.executor = executor;</div><div class="line">        <span class="keyword">this</span>.timeoutMillis = timeUnit.toMillis(timeout);</div><div class="line">        <span class="keyword">this</span>.task = task;</div><div class="line">        <span class="keyword">this</span>.delay = <span class="keyword">new</span> AtomicLong(timeoutMillis);</div><div class="line">        <span class="keyword">this</span>.maxDelay = timeoutMillis * expBackOffBound;</div><div class="line"></div><div class="line">        <span class="comment">// Initialize the counters and register.</span></div><div class="line">        timeoutCounter = Monitors.newCounter(<span class="string">"timeouts"</span>);</div><div class="line">        rejectedCounter = Monitors.newCounter(<span class="string">"rejectedExecutions"</span>);</div><div class="line">        throwableCounter = Monitors.newCounter(<span class="string">"throwables"</span>);</div><div class="line">        threadPoolLevelGauge = <span class="keyword">new</span> LongGauge(MonitorConfig.builder(<span class="string">"threadPoolUsed"</span>).build());</div><div class="line">        Monitors.registerObject(name, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>scheduler</code> ï¼Œå®šæ—¶ä»»åŠ¡æœåŠ¡ï¼Œç”¨äºå®šæ—¶ã€<strong>å‘èµ·</strong>ã€‘å­ä»»åŠ¡ã€‚</li><li><code>executor</code> ï¼Œæ‰§è¡Œå­ä»»åŠ¡çº¿ç¨‹æ± ï¼Œç”¨äºã€<strong>æäº¤</strong>ã€‘å­ä»»åŠ¡æ‰§è¡Œã€‚</li><li><code>task</code> ï¼Œå­ä»»åŠ¡ã€‚</li><li><code>timeoutMillis</code> ï¼Œå­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li><li><code>delay</code> ï¼Œå½“å‰å­ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å€¼ç­‰äº <code>timeout</code> å‚æ•°ã€‚</li><li><code>maxDelay</code> ï¼Œ<strong>æœ€å¤§</strong>å­ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å€¼ç­‰äº <code>timeout * expBackOffBound</code> å‚æ•°ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_01/02.png" alt=""></p><ul><li><code>scheduler</code> åˆå§‹åŒ–å»¶è¿Ÿæ‰§è¡Œ TimedSupervisorTask ã€‚</li><li>TimedSupervisorTask æ‰§è¡Œæ—¶ï¼Œæäº¤ <code>task</code> åˆ° <code>executor</code> æ‰§è¡Œä»»åŠ¡ã€‚<ul><li>å½“ <code>task</code> æ‰§è¡Œæ­£å¸¸ï¼ŒTimedSupervisorTask <strong>å†æ¬¡</strong>æäº¤<strong>è‡ªå·±</strong>åˆ°<code>scheduler</code> å»¶è¿Ÿ <code>timeoutMillis</code> æ‰§è¡Œã€‚</li><li>å½“ <code>task</code> æ‰§è¡Œè¶…æ—¶ï¼Œé‡æ–°è®¡ç®—å»¶è¿Ÿæ—¶é—´( ä¸å…è®¸è¶…è¿‡ <code>maxDelay</code> )ï¼Œ<strong>å†æ¬¡</strong>æäº¤<strong>è‡ªå·±</strong>åˆ°<code>scheduler</code> å»¶è¿Ÿæ‰§è¡Œã€‚</li></ul></li></ul><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TimedSupervisorTask.java</span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     Future&lt;?&gt; future = <span class="keyword">null</span>;</div><div class="line">  <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">5</span>:         <span class="comment">// æäº¤ ä»»åŠ¡</span></div><div class="line">  <span class="number">6</span>:         future = executor.submit(task);</div><div class="line">  <span class="number">7</span>:         <span class="comment">//</span></div><div class="line">  <span class="number">8</span>:         threadPoolLevelGauge.set((<span class="keyword">long</span>) executor.getActiveCount());</div><div class="line">  <span class="number">9</span>:         <span class="comment">// ç­‰å¾…ä»»åŠ¡ æ‰§è¡Œå®Œæˆ æˆ– è¶…æ—¶</span></div><div class="line"> <span class="number">10</span>:         future.get(timeoutMillis, TimeUnit.MILLISECONDS);  <span class="comment">// block until done or timeout</span></div><div class="line"> <span class="number">11</span>:         <span class="comment">// è®¾ç½® ä¸‹ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"> <span class="number">12</span>:         delay.set(timeoutMillis);</div><div class="line"> <span class="number">13</span>:         <span class="comment">//</span></div><div class="line"> <span class="number">14</span>:         threadPoolLevelGauge.set((<span class="keyword">long</span>) executor.getActiveCount());</div><div class="line"> <span class="number">15</span>:     &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</div><div class="line"> <span class="number">16</span>:         logger.error(<span class="string">"task supervisor timed out"</span>, e);</div><div class="line"> <span class="number">17</span>:         timeoutCounter.increment(); <span class="comment">//</span></div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:         <span class="comment">// è®¾ç½® ä¸‹ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"> <span class="number">20</span>:         <span class="keyword">long</span> currentDelay = delay.get();</div><div class="line"> <span class="number">21</span>:         <span class="keyword">long</span> newDelay = Math.min(maxDelay, currentDelay * <span class="number">2</span>);</div><div class="line"> <span class="number">22</span>:         delay.compareAndSet(currentDelay, newDelay);</div><div class="line"> <span class="number">23</span>: </div><div class="line"> <span class="number">24</span>:     &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (executor.isShutdown() || scheduler.isShutdown()) &#123;</div><div class="line"> <span class="number">26</span>:             logger.warn(<span class="string">"task supervisor shutting down, reject the task"</span>, e);</div><div class="line"> <span class="number">27</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">28</span>:             logger.error(<span class="string">"task supervisor rejected the task"</span>, e);</div><div class="line"> <span class="number">29</span>:         &#125;</div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:         rejectedCounter.increment(); <span class="comment">//</span></div><div class="line"> <span class="number">32</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">33</span>:         <span class="keyword">if</span> (executor.isShutdown() || scheduler.isShutdown()) &#123;</div><div class="line"> <span class="number">34</span>:             logger.warn(<span class="string">"task supervisor shutting down, can't accept the task"</span>);</div><div class="line"> <span class="number">35</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">36</span>:             logger.error(<span class="string">"task supervisor threw an exception"</span>, e);</div><div class="line"> <span class="number">37</span>:         &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:         throwableCounter.increment(); <span class="comment">//</span></div><div class="line"> <span class="number">40</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">41</span>:         <span class="comment">// å–æ¶ˆ æœªå®Œæˆçš„ä»»åŠ¡</span></div><div class="line"> <span class="number">42</span>:         <span class="keyword">if</span> (future != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">43</span>:             future.cancel(<span class="keyword">true</span>);</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="comment">// è°ƒåº¦ ä¸‹æ¬¡ä»»åŠ¡</span></div><div class="line"> <span class="number">47</span>:         <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</div><div class="line"> <span class="number">48</span>:             scheduler.schedule(<span class="keyword">this</span>, delay.get(), TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">49</span>:         &#125;</div><div class="line"> <span class="number">50</span>:     &#125;</div><div class="line"> <span class="number">51</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è‡³ 6 è¡Œ ï¼šæäº¤å­ä»»åŠ¡ <code>task</code> åˆ°æ‰§è¡Œå­ä»»åŠ¡çº¿ç¨‹æ±  <code>executor</code> ã€‚</li><li>ç¬¬ 9 è‡³ 10 è¡Œ ï¼šç­‰å¾…å­ä»»åŠ¡ <code>task</code> æ‰§è¡Œå®Œæˆæˆ–æ‰§è¡Œè¶…æ—¶ã€‚</li><li>ç¬¬ 11 è‡³ 12 è¡Œ ï¼šå­ä»»åŠ¡ <code>task</code> æ‰§è¡Œå®Œæˆï¼Œè®¾ç½®ä¸‹ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿ <code>delay</code> ã€‚</li><li>ç¬¬ 19 è‡³ 22 è¡Œ ï¼šå­ä»»åŠ¡ <code>task</code> æ‰§è¡Œè¶…æ—¶ï¼Œé‡æ–°è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿ <code>delay</code> ã€‚è®¡ç®—å…¬å¼ä¸º <code>Math.min(maxDelay, currentDelay * 2)</code> ã€‚å¦‚æœå¤šæ¬¡è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´ä¸æ–­ä¹˜ä»¥ 2 ï¼Œä¸å…è®¸è¶…è¿‡æœ€å¤§å»¶è¿Ÿæ—¶é—´( <code>maxDelay</code> )ã€‚</li><li>ç¬¬ 41 è‡³ 44 è¡Œ ï¼š<strong>å¼ºåˆ¶</strong>å–æ¶ˆæœªå®Œæˆçš„å­ä»»åŠ¡ã€‚</li><li>ç¬¬ 46 è‡³ 49 è¡Œ ï¼šè°ƒåº¦ä¸‹ä¸€æ¬¡ TimedSupervisorTask ã€‚</li></ul><h1>3. Eureka-Server æ¥æ”¶ç»­ç§Ÿ</h1><h2>3.1 æ¥æ”¶ç»­ç§Ÿè¯·æ±‚</h2><p><code>com.netflix.eureka.resources.InstanceResource</code>ï¼Œå¤„ç†<strong>å•ä¸ª</strong>åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>ç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ <code>InstanceResource#renewLease()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@PUT</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">renewLease</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:         @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></div><div class="line"><span class="function"> 4:         @<span class="title">QueryParam</span><span class="params">(<span class="string">"overriddenstatus"</span>)</span> String overriddenStatus,</span></div><div class="line"><span class="function"> 5:         @<span class="title">QueryParam</span><span class="params">(<span class="string">"status"</span>)</span> String status,</span></div><div class="line"><span class="function"> 6:         @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">boolean</span> isFromReplicaNode = <span class="string">"true"</span>.equals(isReplication);</div><div class="line"> <span class="number">8</span>:     <span class="comment">// ç»­ç§Ÿ</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// ç»­ç§Ÿå¤±è´¥</span></div><div class="line"><span class="number">12</span>:     <span class="comment">// Not found in the registry, immediately ask for a register</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">if</span> (!isSuccess) &#123;</div><div class="line"><span class="number">14</span>:         logger.warn(<span class="string">"Not Found (Renew): &#123;&#125; - &#123;&#125;"</span>, app.getName(), id);</div><div class="line"><span class="number">15</span>:         <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="comment">// æ¯”è¾ƒ InstanceInfo çš„ lastDirtyTimestamp å±æ€§</span></div><div class="line"><span class="number">19</span>:     <span class="comment">// Check if we need to sync based on dirty time stamp, the client</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// instance might have changed some value</span></div><div class="line"><span class="number">21</span>:     Response response = <span class="keyword">null</span>;</div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (lastDirtyTimestamp != <span class="keyword">null</span> &amp;&amp; serverConfig.shouldSyncWhenTimestampDiffers()) &#123;</div><div class="line"><span class="number">23</span>:         response = <span class="keyword">this</span>.validateDirtyTimestamp(Long.valueOf(lastDirtyTimestamp), isFromReplicaNode);</div><div class="line"><span class="number">24</span>:         <span class="comment">// Store the overridden status since the validation found out the node that replicates wins</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">if</span> (response.getStatus() == Response.Status.NOT_FOUND.getStatusCode()</div><div class="line"><span class="number">26</span>:                 &amp;&amp; (overriddenStatus != <span class="keyword">null</span>)</div><div class="line"><span class="number">27</span>:                 &amp;&amp; !(InstanceStatus.UNKNOWN.name().equals(overriddenStatus))</div><div class="line"><span class="number">28</span>:                 &amp;&amp; isFromReplicaNode) &#123;</div><div class="line"><span class="number">29</span>:             registry.storeOverriddenStatusIfRequired(app.getAppName(), id, InstanceStatus.valueOf(overriddenStatus));</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// æˆåŠŸ</span></div><div class="line"><span class="number">32</span>:         response = Response.ok().build();</div><div class="line"><span class="number">33</span>:     &#125;</div><div class="line"><span class="number">34</span>:     logger.debug(<span class="string">"Found (Renew): &#123;&#125; - &#123;&#125;; reply status=&#123;&#125;"</span> + app.getName(), id, response.getStatus());</div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 8 è‡³ 9 è¡Œ ï¼šè°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#renew(...)</code> æ–¹æ³•ï¼Œç»­ç§Ÿã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">super</span>.renew(appName, id, isReplication)) &#123; <span class="comment">// ç»­ç§Ÿ</span></div><div class="line">       <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">       replicateToPeers(Action.Heartbeat, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#renew(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 16 è¡Œ ï¼šç»­ç§Ÿå¤±è´¥ï¼Œè¿”å› 404 å“åº”ã€‚å½“ Eureka-Client æ”¶åˆ° 404 å“åº”åï¼Œä¼šé‡æ–°å‘èµ· InstanceInfo çš„æ³¨å†Œã€‚</p></li><li><p>ç¬¬ 18 è‡³ 30 è¡Œ ï¼šæ¯”è¾ƒè¯·æ±‚çš„ <code>lastDirtyTimestamp</code> å’Œ Server çš„ InstanceInfo çš„ <code>lastDirtyTimestamp</code> å±æ€§å·®å¼‚ï¼Œéœ€è¦é…ç½® <code>eureka.syncWhenTimestampDiffers = true</code> ( é»˜è®¤å¼€å¯ )ã€‚</p><ul><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#validateDirtyTimestamp(...)</code> æ–¹æ³•ï¼Œæ¯”è¾ƒ <code>lastDirtyTimestamp</code> çš„å·®å¼‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceResource.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Response <span class="title">validateDirtyTimestamp</span><span class="params">(Long lastDirtyTimestamp, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">// è·å– InstanceInfo</span></div><div class="line">  <span class="number">3</span>:     InstanceInfo appInfo = registry.getInstanceByAppAndId(app.getName(), id, <span class="keyword">false</span>);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">5</span>:         <span class="keyword">if</span> ((lastDirtyTimestamp != <span class="keyword">null</span>) &amp;&amp; (!lastDirtyTimestamp.equals(appInfo.getLastDirtyTimestamp()))) &#123;</div><div class="line">  <span class="number">6</span>:             Object[] args = &#123;id, appInfo.getLastDirtyTimestamp(), lastDirtyTimestamp, isReplication&#125;;</div><div class="line">  <span class="number">7</span>:             <span class="comment">// è¯·æ±‚ çš„ è¾ƒå¤§</span></div><div class="line">  <span class="number">8</span>:             <span class="keyword">if</span> (lastDirtyTimestamp &gt; appInfo.getLastDirtyTimestamp()) &#123;</div><div class="line">  <span class="number">9</span>:                 logger.debug(<span class="string">"Time to sync, since the last dirty timestamp differs -"</span></div><div class="line"> <span class="number">10</span>:                                 + <span class="string">" ReplicationInstance id : &#123;&#125;,Registry : &#123;&#125; Incoming: &#123;&#125; Replication: &#123;&#125;"</span>, args);</div><div class="line"> <span class="number">11</span>:                 <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line"> <span class="number">12</span>:             <span class="comment">// Server çš„ è¾ƒå¤§</span></div><div class="line"> <span class="number">13</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (appInfo.getLastDirtyTimestamp() &gt; lastDirtyTimestamp) &#123;</div><div class="line"> <span class="number">14</span>:                 <span class="comment">// In the case of replication, send the current instance info in the registry for the</span></div><div class="line"> <span class="number">15</span>:                 <span class="comment">// replicating node to sync itself with this one.</span></div><div class="line"> <span class="number">16</span>:                 <span class="keyword">if</span> (isReplication) &#123;</div><div class="line"> <span class="number">17</span>:                     logger.debug(</div><div class="line"> <span class="number">18</span>:                             <span class="string">"Time to sync, since the last dirty timestamp differs -"</span></div><div class="line"> <span class="number">19</span>:                                     + <span class="string">" ReplicationInstance id : &#123;&#125;,Registry : &#123;&#125; Incoming: &#123;&#125; Replication: &#123;&#125;"</span>,</div><div class="line"> <span class="number">20</span>:                             args);</div><div class="line"> <span class="number">21</span>:                     <span class="keyword">return</span> Response.status(Status.CONFLICT).entity(appInfo).build();</div><div class="line"> <span class="number">22</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">23</span>:                     <span class="keyword">return</span> Response.ok().build();</div><div class="line"> <span class="number">24</span>:                 &#125;</div><div class="line"> <span class="number">25</span>:             &#125;</div><div class="line"> <span class="number">26</span>:         &#125;</div><div class="line"> <span class="number">27</span>: </div><div class="line"> <span class="number">28</span>:     &#125;</div><div class="line"> <span class="number">29</span>:     <span class="keyword">return</span> Response.ok().build();</div><div class="line"> <span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šè¯·æ±‚çš„ <code>lastDirtyTimestamp</code> è¾ƒå¤§ï¼Œ<strong>æ„å‘³ç€è¯·æ±‚æ–¹( å¯èƒ½æ˜¯ Eureka-Client ï¼Œä¹Ÿå¯èƒ½æ˜¯ Eureka-Server é›†ç¾¤å†…çš„å…¶ä»– Server )å­˜åœ¨ InstanceInfo å’Œ Eureka-Server çš„ InstanceInfo çš„æ•°æ®ä¸ä¸€è‡´ï¼Œè¿”å› 404 å“åº”ã€‚è¯·æ±‚æ–¹æ”¶åˆ° 404 å“åº”åé‡æ–°å‘èµ·æ³¨å†Œ</strong>ã€‚</li><li>ç¬¬ 16 è‡³ 21 è¡Œ ï¼š<a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 22 è‡³ 24 è¡Œ ï¼šServer çš„ <code>lastDirtyTimestamp</code> è¾ƒå¤§ï¼Œå¹¶ä¸”è¯·æ±‚æ–¹ä¸º Eureka-Clientï¼Œç»­ç§ŸæˆåŠŸï¼Œè¿”å› 200 æˆåŠŸå“åº”ã€‚</li><li>ç¬¬ 29 è¡Œ ï¼š<code>lastDirtyTimestamp</code> ä¸€è‡´ï¼Œè¿”å› 200 æˆåŠŸå“åº”ã€‚</li></ul></li><li><p>ç¬¬ 24 è‡³ 30 è¡Œ ï¼š<a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul></li><li><p>ç¬¬ 31 è‡³ 33 è¡Œ ï¼šç»­ç§ŸæˆåŠŸï¼Œè¿”å› 200 æˆåŠŸå“åº”ã€‚</p></li></ul><h2>3.2 ç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#renew(...)</code> æ–¹æ³•ï¼Œç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å¢åŠ  ç»­ç§Ÿæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"> <span class="number">3</span>:     RENEW.increment(isReplication);</div><div class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— ç§Ÿçº¦</span></div><div class="line"> <span class="number">5</span>:     Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line"> <span class="number">6</span>:     Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">8</span>:         leaseToRenew = gMap.get(id);</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>:     <span class="comment">// ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>:         RENEW_NOT_FOUND.increment(isReplication);</div><div class="line"><span class="number">13</span>:         logger.warn(<span class="string">"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">14</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">15</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>:         InstanceInfo instanceInfo = leaseToRenew.getHolder();</div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:             <span class="comment">// touchASGCache(instanceInfo.getASGName());</span></div><div class="line"><span class="number">19</span>:             <span class="comment">// override status</span></div><div class="line"><span class="number">20</span>:             InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</div><div class="line"><span class="number">21</span>:                     instanceInfo, leaseToRenew, isReplication);</div><div class="line"><span class="number">22</span>:             <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</div><div class="line"><span class="number">23</span>:                 logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></div><div class="line"><span class="number">24</span>:                         + <span class="string">"; re-register required"</span>, instanceInfo.getId());</div><div class="line"><span class="number">25</span>:                 RENEW_NOT_FOUND.increment(isReplication);</div><div class="line"><span class="number">26</span>:                 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:             <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</div><div class="line"><span class="number">29</span>:                 Object[] args = &#123;</div><div class="line"><span class="number">30</span>:                         instanceInfo.getStatus().name(),</div><div class="line"><span class="number">31</span>:                         instanceInfo.getOverriddenStatus().name(),</div><div class="line"><span class="number">32</span>:                         instanceInfo.getId()</div><div class="line"><span class="number">33</span>:                 &#125;;</div><div class="line"><span class="number">34</span>:                 logger.info(</div><div class="line"><span class="number">35</span>:                         <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></div><div class="line"><span class="number">36</span>:                                 + <span class="string">"Hence setting the status to overridden status"</span>, args);</div><div class="line"><span class="number">37</span>:                 instanceInfo.setStatusWithoutDirty(overriddenInstanceStatus);</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:         &#125;</div><div class="line"><span class="number">40</span>:         <span class="comment">// æ–°å¢ ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</span></div><div class="line"><span class="number">41</span>:         renewsLastMin.increment();</div><div class="line"><span class="number">42</span>:         <span class="comment">// è®¾ç½® ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´ï¼ˆç»­ç§Ÿï¼‰</span></div><div class="line"><span class="number">43</span>:         leaseToRenew.renew();</div><div class="line"><span class="number">44</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è‡³ 3 è¡Œ ï¼šå¢åŠ ç»­ç§Ÿæ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 4 è‡³ 9 è¡Œ ï¼šè·å¾—ç§Ÿçº¦( Lease )ã€‚</p></li><li><p>ç¬¬ 10 è‡³ 14 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›ç»­ç§Ÿå¤±è´¥( <code>false</code> )ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 21 è¡Œ ï¼šè·å¾—åº”ç”¨å®ä¾‹çš„<strong>æœ€ç»ˆçŠ¶æ€</strong>ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 22 è‡³ 27 è¡Œ ï¼šåº”ç”¨å®ä¾‹çš„<strong>æœ€ç»ˆçŠ¶æ€</strong>ä¸º <code>UNKNOWN</code>ï¼Œæ— æ³•ç»­çº¦ï¼Œè¿”å› <code>false</code> ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 28 è‡³ 37 è¡Œ ï¼šåº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸<strong>æœ€ç»ˆçŠ¶æ€</strong>ä¸ç›¸ç­‰ï¼Œä½¿ç”¨<strong>æœ€ç»ˆçŠ¶æ€</strong>è¦†ç›–åº”ç”¨å®ä¾‹çš„çŠ¶æ€ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 40 è‡³ 41 è¡Œ ï¼šæ–°å¢ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°( <code>renewsLastMin</code> )ã€‚<code>com.netflix.eureka.util.MeasuredRate</code>ï¼Œé€Ÿåº¦æµ‹é‡ç±»ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> MeasuredRate renewsLastMin;</div><div class="line"></div><div class="line"><span class="comment">// MeasuredRate.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MeasuredRate</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸Šä¸€ä¸ªé—´éš”æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastBucket = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å½“å‰é—´éš”æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong currentBucket = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é—´éš”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> sampleInterval;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer timer;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isActive;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MeasuredRate</span><span class="params">(<span class="keyword">long</span> sampleInterval)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sampleInterval = sampleInterval;</div><div class="line">        <span class="keyword">this</span>.timer = <span class="keyword">new</span> Timer(<span class="string">"Eureka-MeasureRateTimer"</span>, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">this</span>.isActive = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isActive) &#123;</div><div class="line">            timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// Zero out the current bucket.</span></div><div class="line">                        lastBucket.set(currentBucket.getAndSet(<span class="number">0</span>));</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                        logger.error(<span class="string">"Cannot reset the Measured Rate"</span>, e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;, sampleInterval, sampleInterval);</div><div class="line"></div><div class="line">            isActive = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isActive) &#123;</div><div class="line">            timer.cancel();</div><div class="line">            isActive = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Returns the count in the last sample interval.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lastBucket.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Increments the count in the current sample interval.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</div><div class="line">        currentBucket.incrementAndGet();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>timer</code> ï¼Œå®šæ—¶å™¨ï¼Œè´Ÿè´£æ¯ä¸ª <code>sampleInterval</code> é—´éš”é‡ç½®<strong>å½“å‰æ¬¡æ•°</strong>( <code>currentBucket</code> )ï¼Œå¹¶å°†<strong>åŸå½“å‰æ¬¡æ•°</strong>è®¾ç½®åˆ°<strong>ä¸Šä¸€ä¸ªæ¬¡æ•°</strong>( <code>lastBucket</code> )ã€‚</li><li><code>#increment()</code> æ–¹æ³•ï¼Œè¿”å›<strong>å½“å‰æ¬¡æ•°</strong>( <code>currentBucket</code> )ã€‚</li><li><code>#getCount()</code> æ–¹æ³•ï¼Œè¿”å›<strong>ä¸Šä¸€ä¸ªæ¬¡æ•°</strong>( <code>lastBucket</code> )ã€‚</li><li><code>renewsLastMin</code> æœ‰å¦‚ä¸‹ç”¨é€”ï¼š<ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†<strong>ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</strong>ã€‚</li><li>Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤º<strong>ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</strong>ã€‚</li><li>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul></li><li><p>ç¬¬ 42 è‡³ 43 è¡Œ ï¼šè°ƒç”¨ <code>Lease#renew()</code> æ–¹æ³•ï¼Œè®¾ç½®ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´( ç»­ç§Ÿ )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">    lastUpdateTimestamp = System.currentTimeMillis() + duration;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 44 è¡Œ ï¼šè¿”å›ç»­ç§ŸæˆåŠŸ( <code>true</code> )ã€‚</p></li><li><p><strong>æ•´ä¸ªè¿‡ç¨‹ä¿®æ”¹çš„ç§Ÿçº¦çš„è¿‡æœŸæ—¶é—´ï¼Œå³ä½¿å¹¶å‘è¯·æ±‚ï¼Œä¹Ÿä¸ä¼šå¯¹æ•°æ®çš„ä¸€è‡´æ€§äº§ç”Ÿä¸ä¸€è‡´çš„å½±å“ï¼Œå› æ­¤åƒæ³¨å†Œæ“ä½œä¸€æ ·åŠ é”</strong>ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>æ•ˆç‡æ¯”æƒ³è±¡çš„ä½ä¸€äº›ï¼ŒåŠ æ²¹ç»§ç»­æ›´æ–°ä¸‹ä¸€ç¯‡ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-renew/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œ</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-register/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-register/</id>
    <published>2018-05-27T16:00:00.000Z</published>
    <updated>2017-10-18T18:00:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-register/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2. Eureka-Client å‘èµ·æ³¨å†Œ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2.2 åˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2.3 å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3. Eureka-Server æ¥æ”¶æ³¨å†Œ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3.1 æ¥æ”¶æ³¨å†Œè¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3.2 Lease</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3.3 æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> äºŒæ¬¡ç¼–è¾‘<br><img src="http://www.iocoder.cn/images/Eureka/2018_05_28/01.jpeg" alt=""></p></blockquote><ul><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚</li><li>é<strong>è“æ¡†</strong>éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. Eureka-Client å‘èµ·æ³¨å†Œ</h1><p>Eureka-Client å‘ Eureka-Server å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹éœ€è¦ç¬¦åˆå¦‚ä¸‹æ¡ä»¶ï¼š</p><ul><li>é…ç½® <code>eureka.registration.enabled = true</code>ï¼ŒEureka-Client å‘ Eureka-Server å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹çš„<strong>å¼€å…³</strong>ã€‚</li><li>InstanceInfo åœ¨ Eureka-Client å’Œ Eureka-Server æ•°æ®ä¸ä¸€è‡´ã€‚</li></ul><p>æ¯æ¬¡ InstanceInfo å‘ç”Ÿ<strong>å±æ€§å˜åŒ–</strong>æ—¶ï¼Œæ ‡è®° <code>isInstanceInfoDirty</code> å±æ€§ä¸º <code>true</code>ï¼Œè¡¨ç¤º InstanceInfo åœ¨ Eureka-Client å’Œ Eureka-Server æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦æ³¨å†Œã€‚å¦å¤–ï¼ŒInstanceInfo åˆšè¢«åˆ›å»ºæ—¶ï¼Œåœ¨ Eureka-Server ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šè¢«æ³¨å†Œã€‚</p><p>å½“ç¬¦åˆæ¡ä»¶æ—¶ï¼ŒInstanceInfo ä¸ä¼šç«‹å³å‘ Eureka-Server æ³¨å†Œï¼Œè€Œæ˜¯åå°çº¿ç¨‹<strong>å®šæ—¶</strong>æ³¨å†Œã€‚</p><p>å½“ InstanceInfo çš„çŠ¶æ€( <code>status</code> ) å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¹¶ä¸”é…ç½® <code>eureka.shouldOnDemandUpdateStatusChange = true</code> æ—¶ï¼Œç«‹å³å‘ Eureka-Server æ³¨å†Œã€‚<strong>å› ä¸ºçŠ¶æ€å±æ€§éå¸¸é‡è¦ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å»ºè®®å¼€å¯ï¼Œå½“ç„¶é»˜è®¤æƒ…å†µä¹Ÿæ˜¯å¼€å¯çš„</strong>ã€‚</p><p>Let's Goã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä»£ç çš„å®ç°ã€‚</p><h2>2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ApplicationInfoManager.StatusChangeListener statusChangeListener;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InstanceInfoReplicator instanceInfoReplicator;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">        </div><div class="line">            <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">            </div><div class="line">            <span class="comment">// åˆ›å»º åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</span></div><div class="line">            <span class="comment">// InstanceInfo replicator</span></div><div class="line">            instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</div><div class="line">                    <span class="keyword">this</span>,</div><div class="line">                    instanceInfo,</div><div class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</div><div class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></div><div class="line"></div><div class="line">            <span class="comment">// åˆ›å»º åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line">            statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</div><div class="line">                            InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</div><div class="line">                        <span class="comment">// log at warn level if DOWN was involved</span></div><div class="line">                        logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">                    &#125;</div><div class="line">                    instanceInfoReplicator.onDemandUpdate();</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="comment">// æ³¨å†Œ åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</div><div class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// å¼€å¯ åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</span></div><div class="line">            instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.discovery.InstanceInfoReplicator</code>ï¼Œåº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€‚</p><ul><li><p>è°ƒç”¨ <code>InstanceInfoReplicator#start(...)</code> æ–¹æ³•ï¼Œ<strong>å¼€å¯</strong>åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfoReplicator.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(InstanceInfoReplicator.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo instanceInfo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> replicationIntervalSeconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶æ‰§è¡Œä»»åŠ¡çš„ Future</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Future&gt; scheduledPeriodicRef;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å¼€å¯è°ƒåº¦</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean started;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> burstSize; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> allowedRatePerMinute; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line"></div><div class="line">    InstanceInfoReplicator(DiscoveryClient discoveryClient, InstanceInfo instanceInfo, <span class="keyword">int</span> replicationIntervalSeconds, <span class="keyword">int</span> burstSize) &#123;</div><div class="line">        <span class="keyword">this</span>.discoveryClient = discoveryClient;</div><div class="line">        <span class="keyword">this</span>.instanceInfo = instanceInfo;</div><div class="line">        <span class="keyword">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="number">1</span>,</div><div class="line">                <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                        .setNameFormat(<span class="string">"DiscoveryClient-InstanceInfoReplicator-%d"</span>)</div><div class="line">                        .setDaemon(<span class="keyword">true</span>)</div><div class="line">                        .build());</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.scheduledPeriodicRef = <span class="keyword">new</span> AtomicReference&lt;Future&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.started = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">this</span>.rateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.MINUTES);</div><div class="line">        <span class="keyword">this</span>.replicationIntervalSeconds = replicationIntervalSeconds;</div><div class="line">        <span class="keyword">this</span>.burstSize = burstSize;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.allowedRatePerMinute = <span class="number">60</span> * <span class="keyword">this</span>.burstSize / <span class="keyword">this</span>.replicationIntervalSeconds;</div><div class="line">        logger.info(<span class="string">"InstanceInfoReplicator onDemand update allowed rate per min is &#123;&#125;"</span>, allowedRatePerMinute);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> initialDelayMs)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">            <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸ä¸€è‡´</span></div><div class="line">            instanceInfo.setIsDirty();  <span class="comment">// for initial register</span></div><div class="line">            <span class="comment">// æäº¤ä»»åŠ¡ï¼Œå¹¶è®¾ç½®è¯¥ä»»åŠ¡çš„ Future</span></div><div class="line">            Future next = scheduler.schedule(<span class="keyword">this</span>, initialDelayMs, TimeUnit.SECONDS);</div><div class="line">            scheduledPeriodicRef.set(next);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isInstanceInfoDirty = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Long lastDirtyTimestamp;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setIsDirty</span><span class="params">()</span> </span>&#123;</div><div class="line">   isInstanceInfoDirty = <span class="keyword">true</span>;</div><div class="line">   lastDirtyTimestamp = System.currentTimeMillis();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ‰§è¡Œ <code>instanceInfo.setIsDirty()</code> ä»£ç å—ï¼Œå› ä¸º <strong>InstanceInfo åˆšè¢«åˆ›å»ºæ—¶ï¼Œåœ¨ Eureka-Server ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šè¢«æ³¨å†Œ</strong>ã€‚</li><li>è°ƒç”¨ <code>ScheduledExecutorService#schedule(...)</code> æ–¹æ³•ï¼Œå»¶è¿Ÿ <code>initialDelayMs</code> æ¯«ç§’æ‰§è¡Œ<strong>ä¸€æ¬¡</strong>ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆæ­¤å¤„è®¾ç½® <code>scheduledPeriodicRef</code> ï¼Ÿåœ¨ <code>InstanceInfoReplicator#onDemandUpdate()</code> æ–¹æ³•ä¼šçœ‹åˆ°å…·ä½“ç”¨é€”ã€‚</li></ul></li><li><p><strong>å®šæ—¶</strong>æ£€æŸ¥ InstanceInfo çš„çŠ¶æ€( <code>status</code> ) å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚<strong>è‹¥æ˜¯</strong>ï¼Œå‘èµ·æ³¨å†Œã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfoReplicator.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åˆ·æ–° åº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">       discoveryClient.refreshInstanceInfo();</div><div class="line">       <span class="comment">// åˆ¤æ–­ åº”ç”¨å®ä¾‹ä¿¡æ¯ æ˜¯å¦æ•°æ®ä¸ä¸€è‡´</span></div><div class="line">       Long dirtyTimestamp = instanceInfo.isDirtyWithTime();</div><div class="line">       <span class="keyword">if</span> (dirtyTimestamp != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// å‘èµ·æ³¨å†Œ</span></div><div class="line">           discoveryClient.register();</div><div class="line">           <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸€è‡´</span></div><div class="line">           instanceInfo.unsetIsDirty(dirtyTimestamp);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">       logger.warn(<span class="string">"There was a problem with the instance info replicator"</span>, t);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ä»»åŠ¡ï¼Œå¹¶è®¾ç½®è¯¥ä»»åŠ¡çš„ Future</span></div><div class="line">       Future next = scheduler.schedule(<span class="keyword">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">       scheduledPeriodicRef.set(next);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">setIsDirtyWithTime</span><span class="params">()</span> </span>&#123;</div><div class="line">   setIsDirty();</div><div class="line">   <span class="keyword">return</span> lastDirtyTimestamp;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unsetIsDirty</span><span class="params">(<span class="keyword">long</span> unsetDirtyTimestamp)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (lastDirtyTimestamp &lt;= unsetDirtyTimestamp) &#123;</div><div class="line">       isInstanceInfoDirty = <span class="keyword">false</span>;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>DiscoveryClient#refreshInstanceInfo()</code> æ–¹æ³•ï¼Œåˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚<strong>æ­¤å¤„å¯èƒ½å¯¼è‡´åº”ç”¨å®ä¾‹ä¿¡æ¯æ•°æ®ä¸ä¸€è‡´</strong>ï¼Œåœ¨<a href="#">ã€Œ2.2ã€åˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯</a> è¯¦ç»†è§£æã€‚</li><li>è°ƒç”¨ <code>DiscoveryClient#register()</code> æ–¹æ³•ï¼Œ<strong>Eureka-Client å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹</strong>ã€‚</li><li>è°ƒç”¨ <code>ScheduledExecutorService#schedule(...)</code> æ–¹æ³•ï¼Œå†æ¬¡å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ï¼Œå¹¶è®¾ç½® <code>scheduledPeriodicRef</code>ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä¸æ–­<strong>å¾ªç¯</strong>å®šæ—¶æ‰§è¡Œä»»åŠ¡ã€‚</li></ul></li></ul></li><li><p><code>com.netflix.appinfo.ApplicationInfoManager.StatusChangeListener</code> <strong>å†…éƒ¨ç±»</strong>ï¼Œç›‘å¬åº”ç”¨å®ä¾‹ä¿¡æ¯çŠ¶æ€çš„å˜æ›´ã€‚</p><ul><li><p>è°ƒç”¨ <code>ApplicationInfoManager#registerStatusChangeListener(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInfoManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, StatusChangeListener&gt; listeners;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStatusChangeListener</span><span class="params">(StatusChangeListener listener)</span> </span>&#123;</div><div class="line">        listeners.put(listener.getId(), listener);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><strong>ä¸šåŠ¡é‡Œ</strong>ï¼Œè°ƒç”¨ <code>ApplicationInfoManager#setInstanceStatus(...)</code> æ–¹æ³•ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„çŠ¶æ€ï¼Œä»è€Œ<strong>é€šçŸ¥</strong> <code>InstanceInfoReplicator#onDemandUpdate()</code> æ–¹æ³•çš„è°ƒç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationInfoManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setInstanceStatus</span><span class="params">(InstanceStatus status)</span> </span>&#123;</div><div class="line">   InstanceStatus next = instanceStatusMapper.map(status);</div><div class="line">   <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   InstanceStatus prev = instanceInfo.setStatus(next);</div><div class="line">   <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (StatusChangeListener listener : listeners.values()) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               listener.notify(<span class="keyword">new</span> StatusChangeEvent(prev, next));</div><div class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">               logger.warn(<span class="string">"failed to notify listener: &#123;&#125;"</span>, listener.getId(), e);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> InstanceStatus <span class="title">setStatus</span><span class="params">(InstanceStatus status)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.status != status) &#123;</div><div class="line">       InstanceStatus prev = <span class="keyword">this</span>.status;</div><div class="line">       <span class="keyword">this</span>.status = status;</div><div class="line">       <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸€è‡´</span></div><div class="line">       setIsDirty();</div><div class="line">       <span class="keyword">return</span> prev;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>InstanceInfoReplicator#onDemandUpdate()</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfoReplicator.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDemandUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (rateLimiter.acquire(burstSize, allowedRatePerMinute)) &#123; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">       scheduler.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               logger.debug(<span class="string">"Executing on-demand update of local InstanceInfo"</span>);</div><div class="line">               <span class="comment">// å–æ¶ˆä»»åŠ¡</span></div><div class="line">               Future latestPeriodic = scheduledPeriodicRef.get();</div><div class="line">               <span class="keyword">if</span> (latestPeriodic != <span class="keyword">null</span> &amp;&amp; !latestPeriodic.isDone()) &#123;</div><div class="line">                   logger.debug(<span class="string">"Canceling the latest scheduled update, it will be rescheduled at the end of on demand update"</span>);</div><div class="line">                   latestPeriodic.cancel(<span class="keyword">false</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// å†æ¬¡è°ƒç”¨</span></div><div class="line">               InstanceInfoReplicator.<span class="keyword">this</span>.run();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.warn(<span class="string">"Ignoring onDemand update due to rate limiter"</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>Future#cancel(false)</code> æ–¹æ³•ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡ï¼Œ<strong>é¿å…æ— ç”¨çš„æ³¨å†Œ</strong>ã€‚</li><li>è°ƒç”¨ <code>InstanceInfoReplicator#run()</code> æ–¹æ³•ï¼Œå‘èµ·æ³¨å†Œã€‚</li></ul></li></ul></li></ul><h2>2.2 åˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>DiscoveryClient#refreshInstanceInfo()</code> æ–¹æ³•ï¼Œåˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚<strong>æ­¤å¤„å¯èƒ½å¯¼è‡´åº”ç”¨å®ä¾‹ä¿¡æ¯æ•°æ®ä¸ä¸€è‡´</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">refreshInstanceInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ·æ–° æ•°æ®ä¸­å¿ƒä¿¡æ¯</span></div><div class="line">   applicationInfoManager.refreshDataCenterInfoIfRequired();</div><div class="line">   <span class="comment">// åˆ·æ–° ç§Ÿçº¦ä¿¡æ¯</span></div><div class="line">   applicationInfoManager.refreshLeaseInfoIfRequired();</div><div class="line">   <span class="comment">// å¥åº·æ£€æŸ¥</span></div><div class="line">   InstanceStatus status;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       status = getHealthCheckHandler().getStatus(instanceInfo.getStatus());</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.warn(<span class="string">"Exception from healthcheckHandler.getStatus, setting status to DOWN"</span>, e);</div><div class="line">       status = InstanceStatus.DOWN;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != status) &#123;</div><div class="line">       applicationInfoManager.setInstanceStatus(status);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ApplicationInfoManager#refreshDataCenterInfoIfRequired()</code> æ–¹æ³•ï¼Œåˆ·æ–°æ•°æ®ä¸­å¿ƒç›¸å…³ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationInfoManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshDataCenterInfoIfRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// hostname</span></div><div class="line">   String existingAddress = instanceInfo.getHostName();</div><div class="line">   String newAddress;</div><div class="line">   <span class="keyword">if</span> (config <span class="keyword">instanceof</span> RefreshableInstanceConfig) &#123;</div><div class="line">       <span class="comment">// Refresh data center info, and return up to date address</span></div><div class="line">       newAddress = ((RefreshableInstanceConfig) config).resolveDefaultAddress(<span class="keyword">true</span>);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       newAddress = config.getHostName(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ip</span></div><div class="line">   String newIp = config.getIpAddress();</div><div class="line">   <span class="keyword">if</span> (newAddress != <span class="keyword">null</span> &amp;&amp; !newAddress.equals(existingAddress)) &#123;</div><div class="line">       logger.warn(<span class="string">"The address changed from : &#123;&#125; =&gt; &#123;&#125;"</span>, existingAddress, newAddress);</div><div class="line">       <span class="comment">// :( in the legacy code here the builder is acting as a mutator.</span></div><div class="line">       <span class="comment">// This is hard to fix as this same instanceInfo instance is referenced elsewhere.</span></div><div class="line">       <span class="comment">// We will most likely re-write the client at sometime so not fixing for now.</span></div><div class="line">       InstanceInfo.Builder builder = <span class="keyword">new</span> InstanceInfo.Builder(instanceInfo);</div><div class="line">       builder.setHostName(newAddress) <span class="comment">// hostname</span></div><div class="line">               .setIPAddr(newIp) <span class="comment">// ip</span></div><div class="line">               .setDataCenterInfo(config.getDataCenterInfo()); <span class="comment">// dataCenterInfo</span></div><div class="line">       instanceInfo.setIsDirty();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pair&lt;String, String&gt; hostInfo = getHostInfo();</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHostName</span><span class="params">(<span class="keyword">boolean</span> refresh)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> hostInfo.second();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIpAddress</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> hostInfo.first();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Pair&lt;String, String&gt; <span class="title">getHostInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        Pair&lt;String, String&gt; pair;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            InetAddress localHost = InetAddress.getLocalHost();</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(localHost.getHostAddress(), localHost.getHostName());</div><div class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</div><div class="line">            logger.error(<span class="string">"Cannot get host info"</span>, e);</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(<span class="string">""</span>, <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> pair;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å…³æ³¨åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ <code>hostName</code> ã€ <code>ipAddr</code> ã€ <code>dataCenterInfo</code> å±æ€§çš„å˜åŒ–ã€‚</li><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é RefreshableInstanceConfig å®ç°çš„é…ç½®ç±»( ä¸€èˆ¬æ˜¯ MyDataCenterInstanceConfig )ï¼Œå› ä¸º <code>AbstractInstanceConfig.hostInfo</code> æ˜¯<strong>é™æ€å±æ€§</strong>ï¼Œ<strong>å³ä½¿æœ¬æœºä¿®æ”¹äº† IP ç­‰ä¿¡æ¯ï¼ŒEureka-Client è¿›ç¨‹ä¹Ÿä¸ä¼šæ„ŸçŸ¥åˆ°</strong>ã€‚TODO[0022]ï¼šçœ‹ä¸‹springcloud çš„å®ç°</li></ul></li><li><p>è°ƒç”¨ <code>ApplicationInfoManager#refreshLeaseInfoIfRequired()</code> æ–¹æ³•ï¼Œåˆ·æ–°ç§Ÿçº¦ç›¸å…³ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshLeaseInfoIfRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">   LeaseInfo leaseInfo = instanceInfo.getLeaseInfo();</div><div class="line">   <span class="keyword">if</span> (leaseInfo == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> currentLeaseDuration = config.getLeaseExpirationDurationInSeconds();</div><div class="line">   <span class="keyword">int</span> currentLeaseRenewal = config.getLeaseRenewalIntervalInSeconds();</div><div class="line">   <span class="keyword">if</span> (leaseInfo.getDurationInSecs() != currentLeaseDuration <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´ æ”¹å˜</span></div><div class="line">           || leaseInfo.getRenewalIntervalInSecs() != currentLeaseRenewal) &#123; <span class="comment">// ç§Ÿçº¦ç»­çº¦é¢‘ç‡ æ”¹å˜</span></div><div class="line">       LeaseInfo newLeaseInfo = LeaseInfo.Builder.newBuilder()</div><div class="line">               .setRenewalIntervalInSecs(currentLeaseRenewal)</div><div class="line">               .setDurationInSecs(currentLeaseDuration)</div><div class="line">               .build();</div><div class="line">       instanceInfo.setLeaseInfo(newLeaseInfo);</div><div class="line">       instanceInfo.setIsDirty();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å…³æ³¨åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ <code>renewalIntervalInSecs</code> ã€ <code>durationInSecs</code> å±æ€§çš„å˜åŒ–ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>HealthCheckHandler#getStatus()</code> æ–¹æ³•ï¼Œå¥åº·æ£€æŸ¥ã€‚è¿™é‡Œå…ˆæš‚æ—¶è·³è¿‡ï¼Œæˆ‘ä»¬åœ¨<a href="#">TODO[0004]ï¼šå¥åº·æ£€æŸ¥</a> è¯¦ç»†è§£æã€‚</p></li></ul><h2>2.3 å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹</h2><p>è°ƒç”¨ <code>DiscoveryClient#register()</code> æ–¹æ³•ï¼Œ<strong>Eureka-Client å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   logger.info(PREFIX + appPathIdentifier + <span class="string">": registering service..."</span>);</div><div class="line">   EurekaHttpResponse&lt;Void&gt; httpResponse;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.warn(<span class="string">"&#123;&#125; - registration failed &#123;&#125;"</span>, PREFIX + appPathIdentifier, e.getMessage(), e);</div><div class="line">       <span class="keyword">throw</span> e;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">       logger.info(<span class="string">"&#123;&#125; - registration status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">204</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(InstanceInfo info)</span> </span>&#123;</div><div class="line">   String urlPath = <span class="string">"apps/"</span> + info.getAppName();</div><div class="line">   ClientResponse response = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</div><div class="line">       addExtraHeaders(resourceBuilder);</div><div class="line">       response = resourceBuilder</div><div class="line">               .header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>)</div><div class="line">               .type(MediaType.APPLICATION_JSON_TYPE)</div><div class="line">               .accept(MediaType.APPLICATION_JSON)</div><div class="line">               .post(ClientResponse.class, info);</div><div class="line">       <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, info.getId(),</div><div class="line">                   response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">           response.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#register(...)</code> æ–¹æ³•ï¼Œ<code>POST</code> è¯·æ±‚ Eureka-Server çš„ <code>apps/${APP_NAME}</code> æ¥å£ï¼Œå‚æ•°ä¸º InstanceInfo ï¼Œå®ç°æ³¨å†Œå®ä¾‹ä¿¡æ¯çš„æ³¨å†Œã€‚</li></ul><h1>3. Eureka-Server æ¥æ”¶æ³¨å†Œ</h1><h2>3.1 æ¥æ”¶æ³¨å†Œè¯·æ±‚</h2><p><code>com.netflix.eureka.resources.ApplicationResource</code>ï¼Œå¤„ç†<strong>å•ä¸ª</strong>åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ <code>ApplicationResource#addInstance()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"application/xml"</span>, <span class="string">"application/json"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationResource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(&#123;<span class="string">"application/json"</span>, <span class="string">"application/xml"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">addInstance</span><span class="params">(InstanceInfo info,</span></span></div><div class="line"><span class="function"><span class="params">                                @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</div><div class="line">        <span class="comment">// æ ¡éªŒå‚æ•°æ˜¯å¦åˆæ³•</span></div><div class="line">        logger.debug(<span class="string">"Registering instance &#123;&#125; (replication=&#123;&#125;)"</span>, info.getId(), isReplication);</div><div class="line">        <span class="comment">// validate that the instanceinfo contains all the necessary required fields</span></div><div class="line">        <span class="keyword">if</span> (isBlank(info.getId())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing instanceId"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getHostName())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing hostname"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getIPAddr())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing ip address"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getAppName())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing appName"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!appName.equals(info.getAppName())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Mismatched appName, expecting "</span> + appName + <span class="string">" but was "</span> + info.getAppName()).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo() == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo().getName() == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo Name"</span>).build();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// AWS ç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">        <span class="comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></div><div class="line">        DataCenterInfo dataCenterInfo = info.getDataCenterInfo();</div><div class="line">        <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</div><div class="line">            String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId();</div><div class="line">            <span class="keyword">if</span> (isBlank(dataCenterInfoId)) &#123;</div><div class="line">                <span class="keyword">boolean</span> experimental = <span class="string">"true"</span>.equalsIgnoreCase(serverConfig.getExperimental(<span class="string">"registration.validation.dataCenterInfoId"</span>));</div><div class="line">                <span class="keyword">if</span> (experimental) &#123;</div><div class="line">                    String entity = <span class="string">"DataCenterInfo of type "</span> + dataCenterInfo.getClass() + <span class="string">" must contain a valid id"</span>;</div><div class="line">                    <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(entity).build();</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> AmazonInfo) &#123;</div><div class="line">                    AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo;</div><div class="line">                    String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId);</div><div class="line">                    <span class="keyword">if</span> (effectiveId == <span class="keyword">null</span>) &#123;</div><div class="line">                        amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId());</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    logger.warn(<span class="string">"Registering DataCenterInfo of type &#123;&#125; without an appropriate id"</span>, dataCenterInfo.getClass());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">        registry.register(info, <span class="string">"true"</span>.equals(isReplication));</div><div class="line"></div><div class="line">        <span class="comment">// è¿”å› 204 æˆåŠŸ</span></div><div class="line">        <span class="keyword">return</span> Response.status(<span class="number">204</span>).build();  <span class="comment">// 204 to be backwards compatible</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¯·æ±‚å¤´ <code>isReplication</code> å‚æ•°ï¼Œå’Œ Eureka-Server é›†ç¾¤å¤åˆ¶ç›¸å…³ï¼Œæš‚æ—¶è·³è¿‡ã€‚</p></li><li><p>è°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´</span></div><div class="line">   <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</div><div class="line">   <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</div><div class="line">       leaseDuration = info.getLeaseInfo().getDurationInSecs();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">   <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</div><div class="line">   <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">   replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li></ul></li></ul><h2>3.2 Lease</h2><p>åœ¨çœ‹å…·ä½“çš„æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯çš„é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ <code>com.netflix.eureka.lease.Lease</code>ï¼Œç§Ÿçº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lease</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®ä½“</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> T holder;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> registrationTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¼€å§‹æœåŠ¡æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> serviceUpTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ³¨å†Œæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> evictionTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="comment">// Make it volatile so that the expiration task would see this quicker</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastUpdateTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç§Ÿçº¦æŒç»­æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> duration;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Lease</span><span class="params">(T r, <span class="keyword">int</span> durationInSecs)</span> </span>&#123;</div><div class="line">        holder = r;</div><div class="line">        registrationTimestamp = System.currentTimeMillis();</div><div class="line">        lastUpdateTimestamp = registrationTimestamp;</div><div class="line">        duration = (durationInSecs * <span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>holder</code> å±æ€§ï¼Œç§Ÿçº¦çš„æŒæœ‰è€…ã€‚åœ¨ Eureka-Server é‡Œï¼Œæš‚æ—¶åªæœ‰ InstanceInfo ä½¿ç”¨ã€‚</p></li><li><p><code>registrationTimestamp</code> å±æ€§ï¼Œæ³¨å†Œ( åˆ›å»º )ç§Ÿçº¦æ—¶é—´æˆ³ã€‚åœ¨<strong>æ„é€ æ–¹æ³•</strong>é‡Œå¯ä»¥çœ‹ç§Ÿçº¦å¯¹è±¡çš„åˆ›å»ºæ—¶é—´æˆ³å³ä¸ºæ³¨å†Œç§Ÿçº¦æ—¶é—´æˆ³ã€‚</p></li><li><p><code>serviceUpTimestamp</code> å±æ€§ï¼Œå¼€å§‹æœåŠ¡æ—¶é—´æˆ³ã€‚æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ä¼šä½¿ç”¨åˆ°å®ƒå¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceUp</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (serviceUpTimestamp == <span class="number">0</span>) &#123; <span class="comment">// ç¬¬ä¸€æ¬¡æœ‰æ•ˆ</span></div><div class="line">       serviceUpTimestamp = System.currentTimeMillis();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServiceUpTimestamp</span><span class="params">(<span class="keyword">long</span> serviceUpTimestamp)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.serviceUpTimestamp = serviceUpTimestamp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>lastUpdatedTimestamp</code> å±æ€§ï¼Œæœ€åæ›´æ–°ç§Ÿçº¦æ—¶é—´æˆ³ã€‚æ¯æ¬¡ç»­ç§Ÿæ—¶ï¼Œæ›´æ–°è¯¥æ—¶é—´æˆ³ã€‚æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ä¼šä½¿ç”¨åˆ°å®ƒå¦‚ä¸‹æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastUpdatedTimestamp</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.lastUpdatedTimestamp = System.currentTimeMillis();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>duration</code> å±æ€§ï¼Œç§Ÿçº¦æŒç»­æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å½“ç§Ÿçº¦è¿‡ä¹…æœªç»­ç§Ÿï¼Œå³å½“å‰æ—¶é—´ - <code>lastUpdatedTimestamp</code> &gt; <code>duration</code> æ—¶ï¼Œç§Ÿçº¦è¿‡æœŸã€‚</p></li><li><p><code>evictionTimestamp</code> å±æ€§ï¼Œç§Ÿçº¦è¿‡æœŸæ—¶é—´æˆ³ã€‚</p></li></ul><h2>3.3 æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// è·å–è¯»é”</span></div><div class="line"> <span class="number">4</span>:         read.lock();</div><div class="line"> <span class="number">5</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å¢åŠ  æ³¨å†Œæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"> <span class="number">7</span>:         REGISTER.increment(isReplication);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹ä¿¡æ¯ å¯¹åº”çš„ ç§Ÿçº¦</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">final</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();</div><div class="line"><span class="number">11</span>:             gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap); <span class="comment">// æ·»åŠ  åº”ç”¨</span></div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123; <span class="comment">// æ·»åŠ  åº”ç”¨ æˆåŠŸ</span></div><div class="line"><span class="number">13</span>:                 gMap = gNewMap;</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</div><div class="line"><span class="number">17</span>:         <span class="comment">// Retain the last dirty timestamp without overwriting it, if there is already a lease</span></div><div class="line"><span class="number">18</span>:         <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123; <span class="comment">// å·²å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ•°æ®ä¸ä¸€è‡´çš„æ—¶é—´å¤§çš„åº”ç”¨æ³¨å†Œä¿¡æ¯ä¸ºæœ‰æ•ˆçš„</span></div><div class="line"><span class="number">19</span>:             Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp(); <span class="comment">// Server æ³¨å†Œçš„ InstanceInfo</span></div><div class="line"><span class="number">20</span>:             Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp(); <span class="comment">// Client è¯·æ±‚çš„ InstanceInfo</span></div><div class="line"><span class="number">21</span>:             logger.debug(<span class="string">"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:             <span class="comment">// this is a &gt; instead of a &gt;= because if the timestamps are equal, we still take the remote transmitted</span></div><div class="line"><span class="number">24</span>:             <span class="comment">// InstanceInfo instead of the server local copy.</span></div><div class="line"><span class="number">25</span>:             <span class="keyword">if</span> (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</div><div class="line"><span class="number">26</span>:                 logger.warn(<span class="string">"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater"</span> +</div><div class="line"><span class="number">27</span>:                         <span class="string">" than the one that is being registered &#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</div><div class="line"><span class="number">28</span>:                 logger.warn(<span class="string">"Using the existing instanceInfo instead of the new instanceInfo as the registrant"</span>);</div><div class="line"><span class="number">29</span>:                 registrant = existingLease.getHolder();</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="comment">// The lease does not exist and hence it is a new registration</span></div><div class="line"><span class="number">33</span>:             <span class="comment">// ã€è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‘å¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line"><span class="number">34</span>:             <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:                     <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></div><div class="line"><span class="number">37</span>:                     <span class="comment">// (1</span></div><div class="line"><span class="number">38</span>:                     <span class="comment">// for 30 seconds, 2 for a minute)</span></div><div class="line"><span class="number">39</span>:                     <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</div><div class="line"><span class="number">40</span>:                     <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</div><div class="line"><span class="number">41</span>:                             (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">42</span>:                 &#125;</div><div class="line"><span class="number">43</span>:             &#125;</div><div class="line"><span class="number">44</span>:             logger.debug(<span class="string">"No previous lease information found; it is new registration"</span>);</div><div class="line"><span class="number">45</span>:         &#125;</div><div class="line"><span class="number">46</span>:         <span class="comment">// åˆ›å»º ç§Ÿçº¦</span></div><div class="line"><span class="number">47</span>:         Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</div><div class="line"><span class="number">48</span>:         <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123; <span class="comment">// è‹¥ç§Ÿçº¦å·²å­˜åœ¨ï¼Œè®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³</span></div><div class="line"><span class="number">49</span>:             lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</div><div class="line"><span class="number">50</span>:         &#125;</div><div class="line"><span class="number">51</span>:         <span class="comment">// æ·»åŠ åˆ° ç§Ÿçº¦æ˜ å°„</span></div><div class="line"><span class="number">52</span>:         gMap.put(registrant.getId(), lease);</div><div class="line"><span class="number">53</span>:         <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘æ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="number">54</span>:         <span class="keyword">synchronized</span> (recentRegisteredQueue) &#123;</div><div class="line"><span class="number">55</span>:             recentRegisteredQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(</div><div class="line"><span class="number">56</span>:                     System.currentTimeMillis(),</div><div class="line"><span class="number">57</span>:                     registrant.getAppName() + <span class="string">"("</span> + registrant.getId() + <span class="string">")"</span>));</div><div class="line"><span class="number">58</span>:         &#125;</div><div class="line"><span class="number">59</span>:         <span class="comment">// æ·»åŠ åˆ° åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ï¼ˆEureka-Server åˆå§‹åŒ–ä½¿ç”¨ï¼‰</span></div><div class="line"><span class="number">60</span>:         <span class="comment">// This is where the initial state transfer of overridden status happens</span></div><div class="line"><span class="number">61</span>:         <span class="keyword">if</span> (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</div><div class="line"><span class="number">62</span>:             logger.debug(<span class="string">"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the "</span></div><div class="line"><span class="number">63</span>:                             + <span class="string">"overrides"</span>, registrant.getOverriddenStatus(), registrant.getId());</div><div class="line"><span class="number">64</span>:             <span class="keyword">if</span> (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</div><div class="line"><span class="number">65</span>:                 logger.info(<span class="string">"Not found overridden id &#123;&#125; and hence adding it"</span>, registrant.getId());</div><div class="line"><span class="number">66</span>:                 overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</div><div class="line"><span class="number">67</span>:             &#125;</div><div class="line"><span class="number">68</span>:         &#125;</div><div class="line"><span class="number">69</span>:         InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</div><div class="line"><span class="number">70</span>:         <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">71</span>:             logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</div><div class="line"><span class="number">72</span>:             registrant.setOverriddenStatus(overriddenStatusFromMap);</div><div class="line"><span class="number">73</span>:         &#125;</div><div class="line"><span class="number">74</span>: </div><div class="line"><span class="number">75</span>:         <span class="comment">// è·å¾—åº”ç”¨å®ä¾‹æœ€ç»ˆçŠ¶æ€ï¼Œå¹¶è®¾ç½®åº”ç”¨å®ä¾‹çš„çŠ¶æ€</span></div><div class="line"><span class="number">76</span>:         <span class="comment">// Set the status based on the overridden status rules</span></div><div class="line"><span class="number">77</span>:         InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</div><div class="line"><span class="number">78</span>:         registrant.setStatusWithoutDirty(overriddenInstanceStatus);</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:         <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆï¼‰</span></div><div class="line"><span class="number">81</span>:         <span class="comment">// If the lease is registered with UP status, set lease service up timestamp</span></div><div class="line"><span class="number">82</span>:         <span class="keyword">if</span> (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</div><div class="line"><span class="number">83</span>:             lease.serviceUp();</div><div class="line"><span class="number">84</span>:         &#125;</div><div class="line"><span class="number">85</span>:         <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ“ä½œç±»å‹ ä¸º æ·»åŠ </span></div><div class="line"><span class="number">86</span>:         registrant.setActionType(ActionType.ADDED);</div><div class="line"><span class="number">87</span>:         <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="number">88</span>:         recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</div><div class="line"><span class="number">89</span>:         <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"><span class="number">90</span>:         registrant.setLastUpdatedTimestamp();</div><div class="line"><span class="number">91</span>:         <span class="comment">// è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"><span class="number">92</span>:         invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</div><div class="line"><span class="number">93</span>:         logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>,</div><div class="line"><span class="number">94</span>:                 registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);</div><div class="line"><span class="number">95</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">96</span>:         <span class="comment">// é‡Šæ”¾é”</span></div><div class="line"><span class="number">97</span>:         read.unlock();</div><div class="line"><span class="number">98</span>:     &#125;</div><div class="line"><span class="number">99</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šæ·»åŠ åˆ°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šå¢åŠ æ³¨å†Œæ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 5 è‡³ 16 è¡Œ ï¼šè·å¾—åº”ç”¨å®ä¾‹ä¿¡æ¯å¯¹åº”çš„<strong>ç§Ÿçº¦</strong>ã€‚<code>registry</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * ç§Ÿçº¦æ˜ å°„</span></div><div class="line"><span class="comment"> * key1 ï¼šåº”ç”¨å &#123;<span class="doctag">@link</span> InstanceInfo#appName&#125;</span></div><div class="line"><span class="comment"> * key2 ï¼šåº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å· &#123;<span class="doctag">@link</span> InstanceInfo#instanceId&#125;</span></div><div class="line"><span class="comment"> * value ï¼šç§Ÿçº¦</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 17 è‡³ 30 è¡Œ ï¼šå½“ç§Ÿçº¦<strong>å·²å­˜åœ¨</strong>ï¼Œåˆ¤æ–­ Server å·²å­˜åœ¨çš„ InstanceInfo çš„ <code>lastDirtyTimestamp</code> æ˜¯å¦<strong>å¤§äº</strong>( ä¸åŒ…æ‹¬ç­‰äº ) Client è¯·æ±‚çš„ InstanceInfo ï¼Œ<strong>è‹¥æ˜¯ï¼Œä½¿ç”¨ Server çš„ InstanceInfo è¿›è¡Œæ›¿ä»£</strong>ã€‚</p></li><li><p>ç¬¬ 31 è‡³ 44 è¡Œ ï¼šå¢åŠ  <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code>ï¼Œè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 45 è‡³ 52 è¡Œ ï¼šåˆ›å»ºç§Ÿçº¦ï¼Œå¹¶æ·»åŠ åˆ°ç§Ÿçº¦æ˜ å°„( <code>registry</code> )ã€‚</p></li><li><p>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šæ·»åŠ åˆ°æœ€è¿‘æ³¨å†Œçš„<strong>è°ƒè¯•</strong>é˜Ÿåˆ—( <code>recentRegisteredQueue</code> )ï¼Œç”¨äº Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤ºï¼Œæ— å®é™…ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘æ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">* key ï¼šæ·»åŠ æ—¶çš„æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">* value ï¼šå­—ç¬¦ä¸² = åº”ç”¨å(åº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å·)</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CircularQueue&lt;Pair&lt;Long, String&gt;&gt; recentRegisteredQueue;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¾ªç¯é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;E&gt; æ³›å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ConcurrentLinkedQueue</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * é˜Ÿåˆ—å¤§å°</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">CircularQueue</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.size = size;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.makeSpaceIfNotAvailable();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.add(e);</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä¿è¯ç©ºé—´è¶³å¤Ÿ</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * å½“ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œç§»é™¤é¦–å…ƒç´ </span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">makeSpaceIfNotAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.size() == size) &#123;</div><div class="line">           <span class="keyword">this</span>.remove();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.makeSpaceIfNotAvailable();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.offer(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 59 è‡³ 68 è¡Œ ï¼šæ·»åŠ åˆ°åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 69 è‡³ 73 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹çš„è¦†ç›–çŠ¶æ€( <code>overridestatus</code> )ï¼Œé¿å…æ³¨å†Œåº”ç”¨å®ä¾‹åï¼Œä¸¢å¤±è¦†ç›–çŠ¶æ€ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 75 è‡³ 78 è¡Œ ï¼š <strong>è·å¾—åº”ç”¨å®ä¾‹æœ€ç»ˆçŠ¶æ€</strong>ï¼Œå¹¶è®¾ç½®åº”ç”¨å®ä¾‹çš„çŠ¶æ€ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 80 è‡³ 84 è¡Œ ï¼šè®¾ç½®ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³( <strong>åªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆ</strong> )ã€‚</p></li><li><p>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„<strong>æ“ä½œç±»å‹ä¸ºæ·»åŠ </strong>ï¼Œå¹¶æ·»åŠ åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( <code>recentlyChangedQueue</code> )ã€‚<code>recentlyChangedQueue</code> ç”¨äºæ³¨å†Œä¿¡æ¯çš„<strong>å¢é‡</strong>è·å–ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/?self">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt;();</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 89 è‡³ 90 è¡Œ ï¼šè®¾ç½®ç§Ÿçº¦çš„æœ€åæ›´æ–°æ—¶é—´æˆ³ã€‚</p></li><li><p>ç¬¬ 91 è‡³ 92 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜( ResponseCache )è¿‡æœŸï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 96 è‡³ 97 è¡Œ ï¼šé‡Šæ”¾é”ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>å˜¿å˜¿ï¼Œè›®å—¨çš„ï¼Œæ¯”èµ·å‰é¢å‡ ç¯‡å†™é…ç½®ç›¸å…³çš„æ–‡ç« æ¥è¯´ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-register/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;

      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” æ³¨å†Œè¡¨ InstanceRegistry ç±»å…³ç³»</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-class-diagram/</id>
    <published>2018-05-20T16:00:00.000Z</published>
    <updated>2017-10-12T05:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-class-diagram/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">2. ç±»å›¾</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">3. LookupService</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">4. LeaseManager</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">5. InstanceRegistry</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">6. AbstractInstanceRegistry</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">7. PeerAwareInstanceRegistry</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">8. PeerAwareInstanceRegistryImpl</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">666. å½©è›‹</a></li></ul><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦ç®€ä»‹ <strong>æ³¨å†Œè¡¨ InstanceRegistry çš„ç±»å…³ç³»</strong>ï¼Œä¸ºåæ–‡çš„<strong>åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°</strong>ã€<strong>Eureka-Server é›†ç¾¤å¤åˆ¶</strong>åšæ•´ä½“çš„é“ºå«ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ç±»å›¾</h1><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_21/01.png" alt=""></p><ul><li><code>com.netflix.eureka.registry.AwsInstanceRegistry</code>ï¼Œä¸»è¦ç”¨äºäºšé©¬é€Š AWSï¼Œè·³è¿‡ã€‚</li><li><code>com.netflix.eureka.registry.RemoteRegionRegistry</code>ï¼Œç¬”è€…æš‚æ—¶ä¸å¤ªç†è§£å®ƒçš„ç”¨é€”ã€‚ç›®å‰çŒœæµ‹ Eureka-Server é›†ç¾¤å’Œé›†ç¾¤ä¹‹é—´çš„æ³¨å†Œä¿¡æ¯çš„äº¤äº’æ–¹å¼ã€‚æŸ¥é˜…å®˜æ–¹èµ„æ–™ï¼Œ<a href="https://github.com/Netflix/eureka/issues/29" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠAdd ability to retrieve instances from any remote regionã€‹</a> åœ¨åšäº†ç®€å•ä»‹ç»ã€‚ç¿»çœ‹ç›®å‰ç½‘ç»œä¸Šçš„åšå®¢ã€ä¹¦ç±ã€é¡¹ç›®å®æˆ˜ï¼Œæš‚æ—¶éƒ½æ²¡æåŠæ­¤å—ã€‚ä¼°æ‘¸å’Œäºšé©¬é€Š AWS è·¨åŒºåŸŸ( <code>region</code> ) æœºåˆ¶æœ‰ä¸€å®šå…³ç³»ï¼Œå…ˆæš‚æ—¶è·³è¿‡ã€‚æœ‰äº†è§£æ­¤å—çš„åŒå­¦ï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ç¬”è€…ï¼Œä¸‡åˆ†æ„Ÿè°¢ã€‚TODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œæœ¬æ–‡ä¸»è§’ã€‚</li></ul><h1>3. LookupService</h1><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/shared/LookupService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.shared.LookupService</code></a>ï¼ŒæŸ¥æ‰¾æœåŠ¡<strong>æ¥å£</strong>ï¼Œæä¾›<strong>ç®€å•å•ä¸€</strong>çš„æ–¹å¼è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å®ä¾‹ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LookupService</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">(String appName)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">Applications <span class="title">getApplications</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">List&lt;InstanceInfo&gt; <span class="title">getInstancesById</span><span class="params">(String id)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">InstanceInfo <span class="title">getNextServerFromEureka</span><span class="params">(String virtualHostname, <span class="keyword">boolean</span> secure)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_29/01.png" alt=""></p><ul><li>åœ¨ Eureka-Client é‡Œï¼ŒEurekaClient ç»§æ‰¿è¯¥æ¥å£ã€‚</li><li>åœ¨ Eureka-Server é‡Œï¼Œ<code>com.netflix.eureka.registry.InstanceRegistry</code> ç»§æ‰¿è¯¥æ¥å£ã€‚</li></ul><h1>4. LeaseManager</h1><p><code>com.netflix.eureka.lease.LeaseManager</code>ï¼Œç§Ÿçº¦ç®¡ç†å™¨<strong>æ¥å£</strong>ï¼Œæä¾›ç§Ÿçº¦çš„æ³¨å†Œã€ç»­ç§Ÿã€å–æ¶ˆ( ä¸»åŠ¨ä¸‹çº¿ )ã€è¿‡æœŸ( è¿‡æœŸä¸‹çº¿ )ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LeaseManager</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(T r, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">evict</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>5. InstanceRegistry</h1><p><code>com.netflix.eureka.registry.InstanceRegistry</code>ï¼Œ<strong>åº”ç”¨å®ä¾‹</strong>æ³¨å†Œè¡¨<strong>æ¥å£</strong>ã€‚å®ƒç»§æ‰¿äº† LookupService ã€LeaseManager æ¥å£ï¼Œæä¾›åº”ç”¨å®ä¾‹çš„<strong>æ³¨å†Œ</strong>ä¸<strong>å‘ç°</strong>æœåŠ¡ã€‚å¦å¤–ï¼Œå®ƒç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯ï¼Œå®šä¹‰äº†<strong>æ›´åŠ ä¸°å¯Œ</strong>çš„æ¥å£æ–¹æ³•ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstanceRegistry</span> <span class="keyword">extends</span> <span class="title">LeaseManager</span>&lt;<span class="title">InstanceInfo</span>&gt;, <span class="title">LookupService</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ====== å¼€å¯ä¸å…³é—­ç›¸å…³ ======</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearRegistry</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// ====== åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›¸å…³ ======</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">storeOverriddenStatusIfRequired</span><span class="params">(String appName, String id, InstanceStatus overriddenStatus)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">statusUpdate</span><span class="params">(String appName, String id, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                         String lastDirtyTimestamp, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">deleteStatusOverride</span><span class="params">(String appName, String id, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                                 String lastDirtyTimestamp, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Map&lt;String, InstanceStatus&gt; <span class="title">overriddenInstanceStatusesSnapshot</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// ====== å“åº”ç¼“å­˜ç›¸å…³ ======</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initializedResponseCache</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">ResponseCache <span class="title">getResponseCache</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">// ====== è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ç›¸å…³ ======</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getNumOfRenewsInLastMin</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getNumOfRenewsPerMinThreshold</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">isBelowRenewThresold</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSelfPreservationModeEnabled</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeaseExpirationEnabled</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">// ====== è°ƒè¯•/ç›‘æ§ç›¸å…³ ======</span></div><div class="line">    List&lt;Pair&lt;Long, String&gt;&gt; getLastNRegisteredInstances();</div><div class="line"></div><div class="line">    List&lt;Pair&lt;Long, String&gt;&gt; getLastNCanceledInstances();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>6. AbstractInstanceRegistry</h1><p><code>com.netflix.eureka.registry.AbstractInstanceRegistry</code>ï¼Œåº”ç”¨å¯¹è±¡æ³¨å†Œè¡¨<strong>æŠ½è±¡å®ç°</strong>ã€‚</p><p>è¿™é‡Œå…ˆä¸æ‹“å±•å¼€ï¼Œ<a href="http://www.iocoder.cn/categories/Eureka/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ã€‹ç³»åˆ—</a> é€ç¯‡åˆ†äº«ã€‚</p><h1>7. PeerAwareInstanceRegistry</h1><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistry</code>ï¼ŒPeerAware ( æš‚æ—¶æ‰¾ä¸åˆ°åˆé€‚çš„ç¿»è¯‘ ) åº”ç”¨å¯¹è±¡æ³¨å†Œè¡¨<strong>æ¥å£</strong>ï¼Œæä¾› Eureka-Server é›†ç¾¤å†…æ³¨å†Œä¿¡æ¯çš„<strong>åŒæ­¥</strong>æœåŠ¡ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PeerAwareInstanceRegistry</span> <span class="keyword">extends</span> <span class="title">InstanceRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(PeerEurekaNodes peerEurekaNodes)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">syncUp</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldAllowAccess</span><span class="params">(<span class="keyword">boolean</span> remoteRegionRequired)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo info, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> String asgName, <span class="keyword">final</span> ASGResource.ASGStatus newStatus, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>8. PeerAwareInstanceRegistryImpl</h1><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>ï¼ŒPeerAware ( æš‚æ—¶æ‰¾ä¸åˆ°åˆé€‚çš„ç¿»è¯‘ ) åº”ç”¨å¯¹è±¡æ³¨å†Œè¡¨<strong>å®ç°ç±»</strong>ã€‚</p><p>è¿™é‡Œå…ˆä¸æ‹“å±•å¼€ï¼Œ<a href="http://www.iocoder.cn/categories/Eureka/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤ã€‹ç³»åˆ—</a> é€ç¯‡åˆ†äº«ã€‚</p><h1>666. å½©è›‹</h1><p>æœ¬æ–‡æ˜¯ä¸€ç¯‡<strong>ç®€ä»‹</strong>( å•ªå•ªå•ªï¼Œæ‰“è„¸ )ï¼Œå¦‚æœèƒ–å‹æ¯”è¾ƒç€æ€¥æƒ³äº†è§£åŸç†ï¼Œå¯ä»¥é˜…è¯» <a href="http://techshow.ctrip.com/archives/1699.html?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">æºç¨‹ â€”â€”ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> å…ˆï¼Œå†™çš„éå¸¸éå¸¸éå¸¸ä¸é”™ã€‚</p><p>å¿«é©¬åŠ é­ï¼Œæ›´æ–° <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> <strong>ing</strong> ...</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-class-diagram/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆäºŒï¼‰ä¹‹ EurekaBootStrap</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-server-init-second/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-server-init-second/</id>
    <published>2018-05-13T16:00:00.000Z</published>
    <updated>2017-10-18T18:01:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">2. EurekaBootStrap</a><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">2.1 åˆå§‹åŒ– Eureka-Server é…ç½®ç¯å¢ƒ</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">2.2 åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">3. Filter</a><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">3.1 StatusFilter</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">3.2 ServerRequestAuthFilter</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">3.3 RateLimitingFilter</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">3.4 GzipEncodingEnforcingFilter</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">3.5 ServletContainer</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹ EurekaServerConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Server å¯åŠ¨çš„è¿‡ç¨‹</strong>çš„ç¬¬äºŒéƒ¨åˆ† â€”â€” <strong>EurekaBootStrap</strong>ã€‚</p><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„ä»£ç ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸¤ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/?self">ServerConfig</a></li><li>ã€æœ¬æ–‡ã€‘EurekaBootStrap</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaBootStrap</h1><p><code>com.netflix.eureka.EurekaBootStrap</code>ï¼ŒEureka-Server <strong>å¯åŠ¨å…¥å£</strong>ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_14/01.png" alt=""></p><p>EurekaBootStrap å®ç°äº† <code>javax.servlet.ServletContextListener</code> <strong>æ¥å£</strong>ï¼Œåœ¨ Servlet å®¹å™¨( ä¾‹å¦‚ Tomcatã€Jetty )å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>#contextInitialized()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Serverï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaBootStrap</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// çœç•¥æ— å…³å˜é‡å’Œæ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// åˆå§‹åŒ– Eureka-Server é…ç½®ç¯å¢ƒ</span></div><div class="line">            initEurekaEnvironment();</div><div class="line"></div><div class="line">            <span class="comment">// åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</span></div><div class="line">            initEurekaServerContext();</div><div class="line"></div><div class="line">            ServletContext sc = event.getServletContext();</div><div class="line">            sc.setAttribute(EurekaServerContext.class.getName(), serverContext);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            logger.error(<span class="string">"Cannot bootstrap eureka server :"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot bootstrap eureka server :"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#initEurekaEnvironment()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Server <strong>é…ç½®</strong>ç¯å¢ƒã€‚</li><li>è°ƒç”¨ <code>#initEurekaServerContext()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡ã€‚</li></ul><h2>2.1 åˆå§‹åŒ– Eureka-Server é…ç½®ç¯å¢ƒ</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaBootStrap.java</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* éƒ¨ç½²ç¯å¢ƒ - æµ‹æœ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST = <span class="string">"test"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* éƒ¨ç½²æ•°æ®ä¸­å¿ƒ - CLOUD</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLOUD = <span class="string">"cloud"</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* éƒ¨ç½²æ•°æ®ä¸­å¿ƒ - é»˜è®¤</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT = <span class="string">"default"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_DATACENTER = <span class="string">"archaius.deployment.datacenter"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_DATACENTER = <span class="string">"eureka.datacenter"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initEurekaEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    logger.info(<span class="string">"Setting the eureka configuration.."</span>);</div><div class="line"></div><div class="line">   <span class="comment">// è®¾ç½®é…ç½®æ–‡ä»¶çš„æ•°æ®ä¸­å¿ƒ</span></div><div class="line">   String dataCenter = ConfigurationManager.getConfigInstance().getString(EUREKA_DATACENTER);</div><div class="line">   <span class="keyword">if</span> (dataCenter == <span class="keyword">null</span>) &#123;</div><div class="line">       logger.info(<span class="string">"Eureka data center value eureka.datacenter is not set, defaulting to default"</span>);</div><div class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_DATACENTER, DEFAULT);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_DATACENTER, dataCenter);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// è®¾ç½®é…ç½®æ–‡ä»¶çš„ç¯å¢ƒ</span></div><div class="line">   String environment = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT);</div><div class="line">   <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123;</div><div class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, TEST);</div><div class="line">       logger.info(<span class="string">"Eureka environment value eureka.environment is not set, defaulting to test"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è®¾ç½®åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius</a> å®ç°çš„é…ç½®æ–‡ä»¶çš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œè¯»å–<strong>åˆé€‚</strong>çš„é…ç½®æ–‡ä»¶ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€è¦è®¾ç½® <code>EUREKA_ENVIRONMENT</code> å³å¯ï¼Œä¸åŒçš„æœåŠ¡å™¨ç¯å¢ƒ( ä¾‹å¦‚ï¼Œ<code>PROD</code> / <code>TEST</code> ç­‰) è¯»å–ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚å®ç°åŸç†ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>æ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥é˜…è¯»ï¼š<a href="https://github.com/Netflix/archaius/wiki/Deployment-context" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetflix Archaius å®˜æ–¹æ–‡æ¡£ â€”â€” Deployment contextã€‹</a>ã€‚</li></ul><h2>2.2 åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</h2><p>EurekaBootStrap çš„ <code>#initEurekaServerContext()</code> æ–¹æ³•çš„å®ç°ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œå·²ç»å°†ä»£ç <strong>åˆ‡å—</strong> + <strong>ä¸­æ–‡æ³¨å†Œ</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/a1c6074fd038f1182132a43b1ebc4cc08166f0be/eureka-core/src/main/java/com/netflix/eureka/EurekaBootStrap.java#L137" rel="external nofollow noopener noreferrer" target="_blank">EurekaBootStrap</a> é“¾æ¥ï¼Œå¯¹ç…§ä¸‹é¢æ¯ä¸ªå°ç»“é˜…è¯»ç†è§£ã€‚</p><h3>2.2.1 åˆ›å»º Eureka-Server é…ç½®</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EurekaServerConfig eurekaServerConfig = <span class="keyword">new</span> DefaultEurekaServerConfig();</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹ ServerConfigã€‹ã€Œ2.3 DefaultEurekaServerConfigã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3>2.2.2 Eureka-Server è¯·æ±‚å’Œå“åº”çš„æ•°æ®å…¼å®¹</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// For backward compatibility</span></div><div class="line">JsonXStream.getInstance().registerConverter(<span class="keyword">new</span> V1AwareInstanceInfoConverter(), XStream.PRIORITY_VERY_HIGH);</div><div class="line">XmlXStream.getInstance().registerConverter(<span class="keyword">new</span> V1AwareInstanceInfoConverter(), XStream.PRIORITY_VERY_HIGH);</div></pre></td></tr></table></figure></p><ul><li>ç›®å‰ Eureka-Server æä¾› V2 ç‰ˆæœ¬ API ï¼Œå¦‚ä¸Šä»£ç ä¸»è¦å¯¹ V1 ç‰ˆæœ¬ API åšå…¼å®¹ã€‚å¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</li></ul><h3>2.2.3 åˆ›å»º Eureka-Server è¯·æ±‚å’Œå“åº”ç¼–è§£ç å™¨</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">logger.info(<span class="string">"Initializing the eureka client..."</span>);</div><div class="line">logger.info(eurekaServerConfig.getJsonCodecName());</div><div class="line">ServerCodecs serverCodecs = <span class="keyword">new</span> DefaultServerCodecs(eurekaServerConfig);</div></pre></td></tr></table></figure></p><h3>2.2.4 åˆ›å»º Eureka-Client</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">ApplicationInfoManager applicationInfoManager;</div><div class="line"><span class="keyword">if</span> (eurekaClient == <span class="keyword">null</span>) &#123;</div><div class="line">  EurekaInstanceConfig instanceConfig = isCloud(ConfigurationManager.getDeploymentContext())</div><div class="line">          ? <span class="keyword">new</span> CloudInstanceConfig()</div><div class="line">          : <span class="keyword">new</span> MyDataCenterInstanceConfig();</div><div class="line">  </div><div class="line">  applicationInfoManager = <span class="keyword">new</span> ApplicationInfoManager(</div><div class="line">          instanceConfig, <span class="keyword">new</span> EurekaConfigBasedInstanceInfoProvider(instanceConfig).get());</div><div class="line">  </div><div class="line">  EurekaClientConfig eurekaClientConfig = <span class="keyword">new</span> DefaultEurekaClientConfig();</div><div class="line">  eurekaClient = <span class="keyword">new</span> DiscoveryClient(applicationInfoManager, eurekaClientConfig);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  applicationInfoManager = eurekaClient.getApplicationInfoManager();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>Eureka-Server å†…åµŒ Eureka-Clientï¼Œç”¨äºå’Œ Eureka-Server é›†ç¾¤é‡Œå…¶ä»–èŠ‚ç‚¹é€šä¿¡äº¤äº’ã€‚</p></li><li><p>Eureka-Client çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ EurekaClientã€‹ã€Œ3. DiscoveryClientã€</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>Eureka-Client ä¹Ÿå¯ä»¥é€šè¿‡ EurekaBootStrap æ„é€ æ–¹æ³•ä¼ é€’ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaBootStrap</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> EurekaClient eurekaClient;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EurekaBootStrap</span><span class="params">(EurekaClient eurekaClient)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.eurekaClient = eurekaClient;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>å¤§å¤šæ•°æƒ…å†µä¸‹ç”¨ä¸åˆ°</strong>ã€‚</li></ul></li></ul><h3>2.2.5 åˆ›å»ºåº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">PeerAwareInstanceRegistry registry;</div><div class="line"><span class="keyword">if</span> (isAws(applicationInfoManager.getInfo())) &#123; <span class="comment">// AWS ç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">  registry = <span class="keyword">new</span> AwsInstanceRegistry(</div><div class="line">          eurekaServerConfig,</div><div class="line">          eurekaClient.getEurekaClientConfig(),</div><div class="line">          serverCodecs,</div><div class="line">          eurekaClient</div><div class="line">  );</div><div class="line">  awsBinder = <span class="keyword">new</span> AwsBinderDelegate(eurekaServerConfig, eurekaClient.getEurekaClientConfig(), registry, applicationInfoManager);</div><div class="line">  awsBinder.start();</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  registry = <span class="keyword">new</span> PeerAwareInstanceRegistryImpl(</div><div class="line">          eurekaServerConfig,</div><div class="line">          eurekaClient.getEurekaClientConfig(),</div><div class="line">          serverCodecs,</div><div class="line">          eurekaClient</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨<strong>ç±»å…³ç³»å›¾</strong>å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_14/02.png" alt=""></p></li><li><p>æœ¬æ–‡ä¸å±•å¼€åˆ†äº«ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?self">ã€ŠEureka æºç è§£æ â€”â€” æ³¨å†Œè¡¨ InstanceRegistry ç±»å…³ç³»ã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul><h3>2.2.6 åˆ›å»º Eureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">PeerEurekaNodes peerEurekaNodes = getPeerEurekaNodes(</div><div class="line">      registry,</div><div class="line">      eurekaServerConfig,</div><div class="line">      eurekaClient.getEurekaClientConfig(),</div><div class="line">      serverCodecs,</div><div class="line">      applicationInfoManager</div><div class="line">);</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.eureka.cluster.PeerEurekaNodes</code>ï¼ŒEureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a>è¯¦ç»†è§£æã€‚</li></ul><h3>2.2.7 åˆ›å»º Eureka-Server ä¸Šä¸‹æ–‡</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">serverContext = <span class="keyword">new</span> DefaultEurekaServerContext(</div><div class="line">      eurekaServerConfig,</div><div class="line">      serverCodecs,</div><div class="line">      registry,</div><div class="line">      peerEurekaNodes,</div><div class="line">      applicationInfoManager</div><div class="line">);</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.eureka.EurekaServerContext</code>ï¼ŒEureka-Server ä¸Šä¸‹æ–‡<strong>æ¥å£</strong>ï¼Œæä¾›Eureka-Server å†…éƒ¨å„ç»„ä»¶å¯¹è±¡çš„<strong>åˆå§‹åŒ–</strong>ã€<strong>å…³é—­</strong>ã€<strong>è·å–</strong>ç­‰æ–¹æ³•ã€‚</p></li><li><p><code>com.netflix.eureka.EurekaServerContext.DefaultEurekaServerContext</code>ï¼ŒEureka-Server ä¸Šä¸‹æ–‡<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaServerContext</span> <span class="keyword">implements</span> <span class="title">EurekaServerContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaServerConfig serverConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server è¯·æ±‚å’Œå“åº”ç¼–è§£ç å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecs serverCodecs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PeerEurekaNodes peerEurekaNodes;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯ç®¡ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>2.2.8 åˆå§‹åŒ– EurekaServerContextHolder</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EurekaServerContextHolder.initialize(serverContext);</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.eureka.EurekaServerContextHolder</code>ï¼ŒEureka-Server ä¸Šä¸‹æ–‡æŒæœ‰è€…ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–åˆ° Eureka-Server ä¸Šä¸‹æ–‡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerContextHolder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æŒæœ‰è€…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EurekaServerContextHolder holder;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaServerContext serverContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">EurekaServerContextHolder</span><span class="params">(EurekaServerContext serverContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.serverContext = serverContext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> EurekaServerContext <span class="title">getServerContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.serverContext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆå§‹åŒ–</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> serverContext Eureka-Server ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(EurekaServerContext serverContext)</span> </span>&#123;</div><div class="line">        holder = <span class="keyword">new</span> EurekaServerContextHolder(serverContext);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaServerContextHolder <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> holder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>2.2.9 åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">serverContext.initialize();</div><div class="line">logger.info(<span class="string">"Initialized server context"</span>);</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ServerContext#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DefaultEurekaServerContext.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   logger.info(<span class="string">"Initializing ..."</span>);</div><div class="line"></div><div class="line">   <span class="comment">// å¯åŠ¨ Eureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆï¼ˆå¤åˆ¶ï¼‰</span></div><div class="line">   peerEurekaNodes.start();</div><div class="line">   <span class="comment">// åˆå§‹åŒ– åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨</span></div><div class="line">   registry.init(peerEurekaNodes);</div><div class="line"></div><div class="line">   logger.info(<span class="string">"Initialized"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>2.2.10 ä»å…¶ä»– Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Copy registry from neighboring eureka node</span></div><div class="line"><span class="keyword">int</span> registryCount = registry.syncUp();</div><div class="line">registry.openForTraffic(applicationInfoManager, registryCount);</div></pre></td></tr></table></figure></p><ul><li>æœ¬æ–‡ä¸å±•å¼€åˆ†äº«ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a>è¯¦ç»†è§£æã€‚</li></ul><h3>2.2.11 æ³¨å†Œç›‘æ§</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Register all monitoring statistics.</span></div><div class="line">EurekaMonitors.registerAllStats();</div></pre></td></tr></table></figure></p><ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul><h1>3. Filter</h1><p>Eureka-Server è¿‡æ»¤å™¨( <code>javax.servlet.Filter</code> ) <strong>é¡ºåº</strong>å¦‚ä¸‹ï¼š</p><ul><li>StatusFilter</li><li>ServerRequestAuthFilter</li><li>RateLimitingFilter</li><li>GzipEncodingEnforcingFilter</li><li>ServletContainer</li></ul><h2>3.1 StatusFilter</h2><p><code>com.netflix.eureka.StatusFilter</code>ï¼ŒEureka-Server çŠ¶æ€è¿‡æ»¤å™¨ã€‚å½“ Eureka-Server æœªå¤„äºå¼€å¯( <code>InstanceStatus.UP</code> )çŠ¶æ€ï¼Œè¿”å› HTTP çŠ¶æ€ç  307 é‡å®šå‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatusFilter.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SC_TEMPORARY_REDIRECT = <span class="number">307</span>;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></div><div class="line"><span class="function"><span class="params">                   FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">  InstanceInfo myInfo = ApplicationInfoManager.getInstance().getInfo();</div><div class="line">  InstanceStatus status = myInfo.getStatus();</div><div class="line">  <span class="keyword">if</span> (status != InstanceStatus.UP &amp;&amp; response <span class="keyword">instanceof</span> HttpServletResponse) &#123;</div><div class="line">      HttpServletResponse httpRespone = (HttpServletResponse) response;</div><div class="line">      httpRespone.sendError(SC_TEMPORARY_REDIRECT,</div><div class="line">              <span class="string">"Current node is currently not ready to serve requests -- current status: "</span></div><div class="line">                      + status + <span class="string">" - try another DS node: "</span>);</div><div class="line">  &#125;</div><div class="line">  chain.doFilter(request, response);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 ServerRequestAuthFilter</h2><p><code>com.netflix.eureka.ServerRequestAuthFilter</code>ï¼ŒEureka-Server è¯·æ±‚è®¤è¯è¿‡æ»¤å™¨ã€‚Eureka-Server æœªå®ç°è®¤è¯ã€‚ç›®å‰æ‰“å°è®¿é—®çš„å®¢æˆ·ç«¯åå’Œç‰ˆæœ¬å·ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerRequestAuthFilter.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">logAuth</span><span class="params">(ServletRequest request)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (serverConfig.shouldLogIdentityHeaders()) &#123;</div><div class="line">       <span class="keyword">if</span> (request <span class="keyword">instanceof</span> HttpServletRequest) &#123;</div><div class="line">           HttpServletRequest httpRequest = (HttpServletRequest) request;</div><div class="line"></div><div class="line">           String clientName = getHeader(httpRequest, AbstractEurekaIdentity.AUTH_NAME_HEADER_KEY);</div><div class="line">           String clientVersion = getHeader(httpRequest, AbstractEurekaIdentity.AUTH_VERSION_HEADER_KEY);</div><div class="line"></div><div class="line">           DynamicCounter.increment(MonitorConfig.builder(NAME_PREFIX + clientName + <span class="string">"-"</span> + clientVersion).build());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></code></pre><h2>3.3 RateLimitingFilter</h2><p><code>com.netflix.eureka.RateLimitingFilter</code>ï¼Œè¯·æ±‚é™æµè¿‡æ»¤å™¨ã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a>è¯¦ç»†è§£æã€‚</p><h2>3.4 GzipEncodingEnforcingFilter</h2><p><code>com.netflix.eureka.GzipEncodingEnforcingFilter</code>ï¼ŒGZIP ç¼–ç è¿‡æ»¤å™¨ã€‚</p><h2>3.5 ServletContainer</h2><p><code>com.sun.jersey.spi.container.servlet.ServletContainer</code>ï¼ŒJersey MVC è¯·æ±‚è¿‡æ»¤å™¨ã€‚</p><ul><li><p>Jersey MVC æ¨¡å¼å¦‚ä¸‹å›¾ï¼š</p><blockquote><p>FROM <a href="http://blog.csdn.net/wangqyoho/article/details/51981916" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJerseyæ¡†æ¶çš„MVCã€‹</a><img src="http://www.iocoder.cn/images/Eureka/2018_05_14/03.png" alt=""></p></blockquote></li><li><p>åœ¨ <code>com.netflix.eureka.resources</code> åŒ…é‡Œï¼Œæœ‰æ‰€æœ‰çš„ Eureka-Server Jersey Resource ( Controller )ã€‚</p></li><li><p>è¿‡æ»¤å™¨åœ¨ <code>web.xml</code> é…ç½®å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>jersey<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.sun.jersey.spi.container.servlet.ServletContainer<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.config.property.WebPageContentRegex<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/(flex|images|js|css|jsp)/.*<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.config.property.packages<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.sun.jersey;com.netflix<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- GZIP content encoding/decoding --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.spi.container.ContainerRequestFilters<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.sun.jersey.api.container.filter.GZIPContentEncodingFilter<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.spi.container.ContainerResponseFilters<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.sun.jersey.api.container.filter.GZIPContentEncodingFilter<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>jersey<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>å•¦å•¦å•¦ï¼ŒEureka-Server å¯åŠ¨å®Œæˆï¼</p><p>å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ›´åŠ æœ‰è¶£çš„æ³¨å†Œã€ç»­çº¦ã€å–æ¶ˆæ³¨å†Œã€è¿‡æœŸç­‰ç­‰ Eureka-Client ä¸ Eureka-Server çš„äº¤äº’ã€‚</p><p>æèµ·ï¼</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹ ServerConfig</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-server-init-first/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-server-init-first/</id>
    <published>2018-05-06T16:00:00.000Z</published>
    <updated>2017-10-18T17:58:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/">2. EurekaServerConfig</a><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/">2.1 ç±»å…³ç³»å›¾</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/">2.2 é…ç½®å±æ€§</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/">2.3 DefaultEurekaServerConfig</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server å¯åŠ¨çš„è¿‡ç¨‹</strong>ã€‚</p><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„ä»£ç ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸¤ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li>ã€æœ¬æ–‡ã€‘ServerConfig</li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/?self">EurekaBootStrap</a></li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaServerConfig</h1><p><code>com.netflix.eureka.EurekaServerConfig</code>ï¼Œ<strong>Eureka-Server</strong> é…ç½®<strong>æ¥å£</strong>ã€‚</p><h2>2.1 ç±»å…³ç³»å›¾</h2><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_07/01.png" alt=""></p><h2>2.2 é…ç½®å±æ€§</h2><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/8b0f67ac33116ee05faad1ff5125034cfcf573bf/eureka-core/src/main/java/com/netflix/eureka/EurekaServerConfig.java" rel="external nofollow noopener noreferrer" target="_blank">EurekaServerConfig</a> æŸ¥çœ‹é…ç½®å±æ€§ç®€ä»‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç€è‹±æ–‡æ³¨é‡Šä¸€èµ·ç†è§£ã€‚è¿™é‡Œç¬”è€…æ‘˜å‡ºéƒ¨åˆ†è¾ƒä¸ºé‡è¦çš„å±æ€§ï¼š</p><ul><li><p><strong>è¯·æ±‚è®¤è¯ç›¸å…³</strong></p><ul><li>Eureka-Server æœªå®ç°è®¤è¯ã€‚åœ¨ Spring-Cloud-Eureka-Serverï¼Œé€šè¿‡ <code>spring-boot-starter-security</code> æ¨¡å—æ”¯æŒã€‚<a href="http://blog.csdn.net/liuchuanhong1/article/details/54729556" rel="external nofollow noopener noreferrer" target="_blank">ã€Šspring cloud-ç»™Eureka ServeråŠ ä¸Šå®‰å…¨çš„ç”¨æˆ·è®¤è¯ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><code>#shouldLogIdentityHeaders()</code> ï¼šæ‰“å°è®¿é—®çš„å®¢æˆ·ç«¯åå’Œç‰ˆæœ¬å·ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul></li><li><p><strong>è¯·æ±‚é™æµç›¸å…³</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>#isRateLimiterEnabled()</code> ï¼šè¯·æ±‚é™æµæ˜¯å¦å¼€å¯ã€‚</li><li><code>#isRateLimiterThrottleStandardClients()</code> ï¼šæ˜¯å¦å¯¹<strong>æ ‡å‡†å®¢æˆ·ç«¯</strong>åˆ¤æ–­æ˜¯å¦é™æµã€‚<strong>æ ‡å‡†å®¢æˆ·ç«¯</strong>é€šè¿‡è¯·æ±‚å¤´( <code>header</code> )çš„ <code>&quot;DiscoveryIdentity-Name&quot;</code> æ¥åˆ¤æ–­ï¼Œæ˜¯å¦åœ¨æ ‡å‡†å®¢æˆ·ç«¯åé›†åˆé‡Œã€‚</li><li><code>#getRateLimiterPrivilegedClients()</code> ï¼š<strong>æ ‡å‡†</strong>å®¢æˆ·ç«¯åé›†åˆã€‚é»˜è®¤åŒ…å«<code>&quot;DefaultClient&quot;</code> å’Œ <code>&quot;DefaultServer&quot;</code> ã€‚</li><li><code>#getRateLimiterBurstSize()</code> ï¼šé€Ÿç‡é™åˆ¶çš„ burst size ï¼Œä½¿ç”¨<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>ã€‚</li><li><code>#getRateLimiterRegistryFetchAverageRate()</code> ï¼š<strong>å¢é‡</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯çš„é€Ÿç‡é™åˆ¶ã€‚</li><li><code>#getRateLimiterFullFetchAverageRate()</code> ï¼š<strong>å…¨é‡</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯çš„é€Ÿç‡é™åˆ¶ã€‚</li></ul></li><li><p><strong>è·å–æ³¨å†Œä¿¡æ¯è¯·æ±‚ç›¸å…³</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>#shouldUseReadOnlyResponseCache()</code> ï¼šæ˜¯å¦å¼€å¯åªè¯»è¯·æ±‚å“åº”ç¼“å­˜ã€‚å“åº”ç¼“å­˜ ( ResponseCache ) æœºåˆ¶ç›®å‰ä½¿ç”¨ä¸¤å±‚ç¼“å­˜ç­–ç•¥ã€‚ä¼˜å…ˆè¯»å–<strong>åªè¯»ç¼“å­˜</strong>ï¼Œè¯»å–ä¸åˆ°åè¯»å–<strong>å›ºå®šè¿‡æœŸ</strong>çš„<strong>è¯»å†™ç¼“å­˜</strong>ã€‚</li><li><code>#getResponseCacheUpdateIntervalMs()</code> ï¼š<strong>åªè¯»ç¼“å­˜</strong>æ›´æ–°é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚<strong>åªè¯»ç¼“å­˜</strong>å®šæ—¶æ›´æ–°ä»»åŠ¡åªæ›´æ–°è¯»å–è¿‡è¯·æ±‚ (<code>com.netflix.eureka.registry.Key</code>)ï¼Œå› æ­¤è™½ç„¶æ°¸ä¸è¿‡æœŸï¼Œä¹Ÿä¼šå­˜åœ¨è¯»å–ä¸åˆ°çš„æƒ…å†µã€‚</li><li><code>#getResponseCacheAutoExpirationInSeconds()</code> ï¼š<strong>è¯»å†™ç¼“å­˜</strong>å†™å…¥åè¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getRetentionTimeInMSInDeltaQueue()</code>ï¼šç§Ÿçº¦å˜æ›´è®°å½•è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š 3 * 60 * 1000 æ¯«ç§’ã€‚</li><li><code>#DeltaRetentionTimerIntervalInMs()</code>ï¼šç§»é™¤é˜Ÿåˆ—é‡Œè¿‡æœŸçš„ç§Ÿçº¦å˜æ›´è®°å½•çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚</li></ul></li><li><p><strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³</strong></p><ul><li><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>#shouldEnableSelfPreservation()</code> ï¼šæ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p><blockquote><p>FROM <a href="http://www.itmuch.com/spring-cloud-sum/understanding-eureka-self-preservation/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">å‘¨ç«‹â€”â€”ã€Šç†è§£Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‹</a><br>å½“Eureka ServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚<br>ä¸€æ—¦è¿›å…¥è¯¥æ¨¡å¼ï¼ŒEureka Serverå°±ä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šæ³¨é”€ä»»ä½•å¾®æœåŠ¡ï¼‰ã€‚<br>å½“ç½‘ç»œæ•…éšœæ¢å¤åï¼Œè¯¥Eureka ServerèŠ‚ç‚¹ä¼šè‡ªåŠ¨é€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p></blockquote></li><li><p><code>#getRenewalPercentThreshold()</code> ï¼šå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼æ¯”ä¾‹ï¼Œè¶…è¿‡è¯¥æ¯”ä¾‹åå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p></li><li><p><code>#getRenewalThresholdUpdateIntervalMs()</code> ï¼šè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼æ¯”ä¾‹æ›´æ–°å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</p></li></ul></li><li><p><strong>æ³¨å†Œçš„åº”ç”¨å®ä¾‹çš„ç§Ÿçº¦è¿‡æœŸç›¸å…³</strong></p><ul><li><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-evict/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>#getEvictionIntervalTimerInMs()</code> ï¼šç§Ÿçº¦è¿‡æœŸå®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</p></li></ul></li><li><p><strong>Eureka-Server è¿œç¨‹èŠ‚ç‚¹( éé›†ç¾¤ )è¯»å–ç›¸å…³</strong></p><ul><li>TODO[0009]ï¼šRemoteRegionRegistry</li><li><code>#getRemoteRegionUrlsWithName()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚<ul><li><code>key</code> ï¼šEureka-Server åŒºåŸŸ( <code>region</code> )</li><li><code>value</code> ï¼šEureka-Server åœ°å€</li></ul></li><li><code>#getRemoteRegionAppWhitelist()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><code>#getRemoteRegionRegistryFetchInterval()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><code>#getRegistrySyncRetries()</code> ï¼šEureka-Server <strong>å¯åŠ¨</strong>æ—¶ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–å¤±è´¥é‡è¯•æ¬¡æ•°ã€‚</li><li><code>#getRegistrySyncRetryWaitMs()</code> ï¼šEureka-Server <strong>å¯åŠ¨</strong>æ—¶ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–å¤±è´¥ç­‰å¾…( <code>sleep</code> )é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li><li><code>#getRemoteRegionFetchThreadPoolSize()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><code>#disableTransparentFallbackToOtherRegion()</code> ï¼šæ˜¯å¦ç¦ç”¨æœ¬åœ°è¯»å–ä¸åˆ°æ³¨å†Œä¿¡æ¯ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–ã€‚</li></ul></li><li><p><strong>Eureka-Server é›†ç¾¤åŒæ­¥ç›¸å…³</strong></p><ul><li>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a></li><li><code>#getMaxThreadsForPeerReplication()</code> ï¼šåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯æœ€å¤§çº¿ç¨‹æ•°ã€‚</li><li><code>#getMaxElementsInPeerReplicationPool()</code> ï¼šå¾…æ‰§è¡ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯äº‹ä»¶ç¼“å†²æœ€å¤§æ•°é‡ã€‚</li><li><code>#getMaxTimeForReplication()</code> ï¼šæ‰§è¡Œå•ä¸ªåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯çŠ¶æ€ä»»åŠ¡æœ€å¤§æ—¶é—´ã€‚</li><li><code>#shouldSyncWhenTimestampDiffers()</code> ï¼šæ˜¯å¦åŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå½“åº”ç”¨å®ä¾‹ä¿¡æ¯æœ€åæ›´æ–°æ—¶é—´æˆ³( <code>lastDirtyTimestamp</code> )å‘ç”Ÿæ”¹å˜ã€‚</li><li><code>#getWaitTimeInMsWhenSyncEmpty()</code> ï¼šEureka-Server <strong>å¯åŠ¨</strong>æ—¶ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–ä¸åˆ°æ³¨å†Œä¿¡æ¯æ—¶ï¼Œå¤šé•¿æ—¶é—´ä¸å…è®¸ Eureka-Client è®¿é—®ã€‚</li><li><code>#getPeerEurekaNodesUpdateIntervalMs()</code> ï¼šEureka-Server é›†ç¾¤èŠ‚ç‚¹æ›´æ–°é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li></ul></li></ul><h2>2.3 DefaultEurekaServerConfig</h2><p><code>com.netflix.eureka.DefaultEurekaServerConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„ <strong>Eureka-Server</strong> é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaServerConfig</span> <span class="keyword">implements</span> <span class="title">EurekaServerConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•å’Œå±æ€§</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST = <span class="string">"test"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance = com.netflix.config.DynamicPropertyFactory.getInstance();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DynamicStringProperty EUREKA_PROPS_FILE = DynamicPropertyFactory</div><div class="line">            .getInstance().getStringProperty(<span class="string">"eureka.server.props"</span>, <span class="string">"eureka-server"</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String namespace = <span class="string">"eureka."</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaServerConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaServerConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="comment">// è®¾ç½® namespaceï¼Œä¸º "." ç»“å°¾</span></div><div class="line">        <span class="keyword">this</span>.namespace = namespace;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        String env = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT, TEST);</div><div class="line">        ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, env);</div><div class="line">        String eurekaPropsFile = EUREKA_PROPS_FILE.get();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ConfigurationManager</span></div><div class="line">            <span class="comment">// .loadPropertiesFromResources(eurekaPropsFile);</span></div><div class="line">            ConfigurationManager.loadCascadedPropertiesFromResources(eurekaPropsFile);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.warn(<span class="string">"Cannot find the properties specified : &#123;&#125;. This may be okay if there are other environment "</span></div><div class="line">                            + <span class="string">"specific properties or the configuration is installed with a different mechanism."</span>, eurekaPropsFile);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–é…ç½®æ–‡ä»¶å¯¹è±¡ã€‚ç±»ä¼¼ PropertiesInstanceConfigï¼Œç‚¹å‡»<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æŸ¥çœ‹è¯¦ç»†è§£æã€‚<strong>é»˜è®¤é…ç½®æ–‡ä»¶å</strong>ä¸º <code>eureka-server</code>ã€‚</li><li>æ— é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY çš„æšä¸¾ç±»ã€‚</li></ul><h1>666. å½©è›‹</h1><p>æ¶‰åŠåˆ°é…ç½®ï¼Œå†…å®¹åˆçœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¤šï¼Œæ…¢æ…¢ç†è§£åï¼Œå°±ä¼šå˜å¾—å¾ˆâ€œå•°å—¦â€ï¼Œè¯·ä¿æŒè€å¿ƒã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;u
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ EurekaClient</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-third/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-third/</id>
    <published>2018-04-28T16:00:00.000Z</published>
    <updated>2017-10-16T09:46:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-third/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">2. EurekaClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">2.1 LookupService</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">3. DiscoveryClient</a><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">3.1 æ„é€ æ–¹æ³•å‚æ•°</a></li><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">3.2 æ„é€ æ–¹æ³•</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>çš„ç¬¬ä¸‰éƒ¨åˆ† â€”â€” <strong>EurekaClient</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li>ï¼ˆä¸€ï¼‰<a href="(http://www.iocoder.cn/Eureka/eureka-client-init-first/)">EurekaInstanceConfig</a></li><li>ï¼ˆäºŒï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">EurekaClientConfig</a></li><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆä¸‰ï¼‰EurekaClient</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaClient</h1><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/EurekaClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.EurekaClient</code></a>ï¼ŒEureka-Client <strong>æ¥å£</strong>ï¼Œå£°æ˜å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>æä¾›<strong>å¤šç§</strong>æ–¹æ³•è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å®ä¾‹ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚</li><li>æä¾›æ–¹æ³•è·å–<strong>æœ¬åœ°</strong>å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨ç®¡ç†å™¨( <code>com.netflix.appinfo.ApplicationInfoManager</code> )å’Œ Eureka-Client é…ç½®( <code>com.netflix.discovery.EurekaClientConfig</code> )ã€‚</li><li>æä¾›æ–¹æ³•<strong>æ³¨å†Œ</strong>æœ¬åœ°å®¢æˆ·ç«¯çš„å¥åº·æ£€æŸ¥å’Œ Eureka äº‹ä»¶ç›‘å¬å™¨ã€‚</li></ul><p>å¦å¤–ï¼ŒEureka 2.X ç‰ˆæœ¬æ­£åœ¨å¼€å‘ï¼Œè¯¥æ¥å£ä¸º Eureka 1.X å’Œ 2.X æä¾›å¹³æ»‘è¿‡æ¸¡æ¥å£ã€‚</p><blockquote><p>This interface does NOT try to clean up the current client interface for eureka 1.x. Rather it tries to provide an easier transition path from eureka 1.x to eureka 2.x.</p></blockquote><h2>2.1 LookupService</h2><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/shared/LookupService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.shared.LookupService</code></a>ï¼ŒæŸ¥æ‰¾æœåŠ¡<strong>æ¥å£</strong>ï¼Œæä¾›<strong>ç®€å•å•ä¸€</strong>çš„æ–¹å¼è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å®ä¾‹ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_29/01.png" alt=""></p><ul><li>åœ¨ Eureka-Client é‡Œï¼ŒEurekaClient ç»§æ‰¿è¯¥æ¥å£ã€‚</li><li>åœ¨ Eureka-Server é‡Œï¼Œ<code>com.netflix.eureka.registry.InstanceRegistry</code> ç»§æ‰¿è¯¥æ¥å£ã€‚</li></ul><h1>3. DiscoveryClient</h1><p><code>com.netflix.discovery.DiscoveryClient</code>ï¼Œå®ç° EurekaClient <strong>æ¥å£</strong>ï¼Œç”¨äºä¸ Eureka-Server äº¤äº’ã€‚å®ç°å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>å‘ Eureka-Server <strong>æ³¨å†Œ</strong>è‡ªèº«æœåŠ¡</li><li>å‘ Eureka-Server <strong>ç»­çº¦</strong>è‡ªèº«æœåŠ¡</li><li>å‘ Eureka-Server <strong>å–æ¶ˆ</strong>è‡ªèº«æœåŠ¡ï¼Œå½“å…³é—­æ—¶</li><li>ä» Eureka-Server <strong>æŸ¥è¯¢</strong>åº”ç”¨é›†åˆå’Œåº”ç”¨å®ä¾‹ä¿¡æ¯</li><li><em>ç®€å•æ¥ç†è§£ï¼Œå¯¹ Eureka-Server æœåŠ¡çš„å¢åˆ æ”¹æŸ¥</em></li></ul><h2>3.1 æ„é€ æ–¹æ³•å‚æ•°</h2><p>DiscoveryClient <strong>å®Œæ•´</strong>æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">     <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ApplicationInfoManagerï¼Œåœ¨<a href="ttp://www.iocoder.cn/Eureka/eureka-client-init-first/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>EurekaClientConfigï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfigã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>com.netflix.discovery.BackupRegistry</code>ï¼Œå¤‡ä»½æ³¨å†Œä¸­å¿ƒ<strong>æ¥å£</strong>ã€‚å½“ Eureka-Client å¯åŠ¨æ—¶ï¼Œæ— æ³•ä» Eureka-Server è¯»å–æ³¨å†Œä¿¡æ¯ï¼ˆå¯èƒ½æŒ‚äº†ï¼‰ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè¯»å–æ³¨å†Œä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BackupRegistry.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BackupRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Applications <span class="title">fetchRegistry</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Applications <span class="title">fetchRegistry</span><span class="params">(String[] includeRemoteRegions)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NotImplementedRegistryImpl.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotImplementedRegistryImpl</span> <span class="keyword">implements</span> <span class="title">BackupRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">(String[] includeRemoteRegions)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä» <code>com.netflix.discovery.NotImplementedRegistryImpl</code> å¯ä»¥çœ‹å‡ºï¼Œç›®å‰ Eureka-Client æœªæä¾›åˆé€‚çš„é»˜è®¤å®ç°ã€‚</li></ul></li><li><p><code>com.netflix.discovery.AbstractDiscoveryClientOptionalArgs</code>ï¼ŒDiscoveryClient å¯é€‰å‚æ•°æŠ½è±¡åŸºç±»ã€‚ä¸åŒäºä¸Šé¢ä¸‰ä¸ª<strong>å¿…å¡«</strong>å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯<strong>é€‰å¡«</strong>å‚æ•°ï¼Œå®é™…ç”Ÿäº§ä¸‹ä½¿ç”¨è¾ƒå°‘ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆå¥åº·æ£€æŸ¥å›è°ƒçš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Provider&lt;HealthCheckCallback&gt; healthCheckCallbackProvider;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆå¥åº·æ£€æŸ¥å¤„ç†å™¨çš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Provider&lt;HealthCheckHandler&gt; healthCheckHandlerProvider;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    PreRegistrationHandler preRegistrationHandler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey è¿‡æ»¤å™¨é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Collection&lt;T&gt; additionalFilters;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey å®¢æˆ·ç«¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    EurekaJerseyClient eurekaJerseyClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆ Jersey å®¢æˆ·ç«¯çš„å·¥å‚çš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TransportClientFactories transportClientFactories;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka äº‹ä»¶ç›‘å¬å™¨é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Set&lt;EurekaEventListener&gt; eventListeners;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.appinfo.HealthCheckCallback</code>ï¼Œå¥åº·æ£€æŸ¥å›è°ƒ<strong>æ¥å£</strong>ï¼Œç›®å‰å·²ç»åºŸå¼ƒï¼Œä½¿ç”¨ HealthCheckHandler æ›¿ä»£ï¼Œ<strong>ä½ å¯ä»¥ä¸å…³æ³¨è¯¥å‚æ•°</strong>ã€‚</p></li><li><p><code>com.netflix.appinfo.HealthCheckHandler</code>ï¼Œå¥åº·æ£€æŸ¥å¤„ç†å™¨<strong>æ¥å£</strong>ï¼Œç›®å‰æš‚æœªæä¾›åˆé€‚çš„<strong>é»˜è®¤</strong>å®ç°ï¼Œå”¯ä¸€æä¾›çš„ <code>com.netflix.appinfo.HealthCheckCallbackToHandlerBridge</code>ï¼Œç”¨äºå°† HealthCheckCallback <strong>æ¡¥æ¥</strong>æˆ HealthCheckHandlerï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HealthCheckHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HealthCheckHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HealthCheckCallbackToHandlerBridge.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthCheckCallbackToHandlerBridge</span> <span class="keyword">implements</span> <span class="title">HealthCheckHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthCheckCallback callback;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HealthCheckCallbackToHandlerBridge</span><span class="params">()</span> </span>&#123;</div><div class="line">        callback = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HealthCheckCallbackToHandlerBridge</span><span class="params">(HealthCheckCallback callback)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.callback = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == callback || InstanceInfo.InstanceStatus.STARTING == currentStatus</div><div class="line">                || InstanceInfo.InstanceStatus.OUT_OF_SERVICE == currentStatus) &#123; <span class="comment">// Do not go to healthcheck handler if the status is starting or OOS.</span></div><div class="line">            <span class="keyword">return</span> currentStatus;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> callback.isHealthy() ? InstanceInfo.InstanceStatus.UP : InstanceInfo.InstanceStatus.DOWN;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ Spring-Cloud-Eureka-Clientï¼Œæä¾›äº†é»˜è®¤å®ç° <a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/82991a7fc2859b6345b7f67e2461dbf5d7663836/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaHealthCheckHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.netflix.eureka.EurekaHealthCheckHandler</code></a>ï¼Œéœ€è¦ç»“åˆ <a href="https://github.com/spring-projects/spring-boot/tree/c79568886406662736dcdce78f65e7f46dd62696/spring-boot-actuator/" rel="external nofollow noopener noreferrer" target="_blank"><code>spirng-boot-actuate</code></a> ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ã€‚æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO[0004]ï¼šå¥åº·æ£€æŸ¥ï¼‰</li></ul></li><li><p><code>com.netflix.discovery.PreRegistrationHandler</code>ï¼Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨<strong>æ¥å£</strong>ï¼Œç›®å‰æš‚æœªæä¾›é»˜è®¤å®ç°ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨æ³¨å†Œå‰åšä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PreRegistrationHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeRegistration</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p><code>additionalFilters</code>ï¼ŒJersey è¿‡æ»¤å™¨é›†åˆã€‚è¿™é‡Œå£°æ˜æ³›å‹ <code>&lt;T&gt;</code> çš„åŸå› ï¼ŒJersey 1.X å’Œ Jersey 2.X çš„è¿‡æ»¤å™¨æ¥å£<strong>ä¸åŒ</strong>ï¼Œé€šè¿‡æ³›å‹æ¥æ”¯æŒã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Jersey1DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">ClientFilter</span>&gt; </span>&#123;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// Jersey2DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jersey2DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">ClientRequestFilter</span>&gt; </span>&#123;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Jersey 1.X ä½¿ç”¨ ClientFilter ã€‚ClientFilter ç›®å‰æœ‰ä¸¤ä¸ªè¿‡æ»¤å™¨å®ç°ï¼šEurekaIdentityHeaderFilter ã€DynamicGZIPContentEncodingFilter ã€‚</li><li>Jersey 2.X ä½¿ç”¨ ClientRequestFilter ã€‚</li><li>DiscoveryClient ä½¿ç”¨ DiscoveryClientOptionalArgsï¼Œå³ Jersey 1.X ã€‚</li></ul></li><li><p><code>eurekaJerseyClient</code>ï¼ŒJersey å®¢æˆ·ç«¯ã€‚è¯¥<strong>å‚æ•°</strong>ç›®å‰åºŸå¼ƒï¼Œä½¿ç”¨ä¸‹é¢ TransportClientFactories å‚æ•°æ¥è¿›è¡Œç”Ÿæˆã€‚</p></li><li><p><code>com.netflix.discovery.shared.transport.jersey.TransportClientFactories</code>ï¼Œç”Ÿæˆ Jersey å®¢æˆ·ç«¯<strong>å·¥å‚çš„å·¥å‚</strong>æ¥å£ã€‚ç›®å‰æœ‰ Jersey1TransportClientFactories ã€Jersey2TransportClientFactories ä¸¤ä¸ªå®ç°ã€‚TransportClientFactories å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransportClientFactories.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactories</span>&lt;<span class="title">F</span>&gt; </span>&#123;</div><div class="line">  </div><div class="line">      <span class="meta">@Deprecated</span></div><div class="line">      <span class="function">TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> Collection&lt;F&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> EurekaJerseyClient providedJerseyClient)</span></span>;</div><div class="line">  </div><div class="line">      <span class="function">TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> Collection&lt;F&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransportClientFactory.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="function">EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span></span>;</div><div class="line">    </div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ä¸€ä¸ªæ–¹æ³•å·²ç»åºŸå¼ƒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ä¸Šé¢çš„ <code>eurekaJerseyClient</code> <strong>å‚æ•°</strong>( ä¸æ˜¯ EurekaJerseyClient ç±»)å·²ç»åºŸå¼ƒï¼Œè¢«ç¬¬äºŒä¸ªæ–¹æ³•å–ä»£ã€‚ç›¸æ¯”æ¥è¯´ï¼Œç¬¬äºŒä¸ªæ–¹æ³•å¯¹ EurekaJerseyClient åˆ›å»ºå°è£…ä¼šæ›´å¥½ã€‚</li></ul></li></ul></li><li><p><code>com.netflix.discovery.EurekaEventListener</code>ï¼ŒEureka äº‹ä»¶ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEventListener</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// EurekaEvent.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEvent</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryEvent.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryEvent</span> <span class="keyword">implements</span> <span class="title">EurekaEvent</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timestamp;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.discovery.StatusChangeEvent</code>ï¼Œåº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>com.netflix.discovery.CacheRefreshedEvent</code>ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>3.2 æ„é€ æ–¹æ³•</h2><p>DiscoveryClient çš„æ„é€ æ–¹æ³•å®ç°ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œå·²ç»å°†ä»£ç <strong>åˆ‡å—</strong> + <strong>ä¸­æ–‡æ³¨å†Œ</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/DiscoveryClient.java#L298" rel="external nofollow noopener noreferrer" target="_blank">DiscoveryClient</a> é“¾æ¥ï¼Œå¯¹ç…§ä¸‹é¢æ¯ä¸ªå°ç»“é˜…è¯»ç†è§£ã€‚</p><h3>3.2.1 èµ‹å€¼ AbstractDiscoveryClientOptionalArgs</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.healthCheckHandlerProvider = args.healthCheckHandlerProvider;</div><div class="line">  <span class="keyword">this</span>.healthCheckCallbackProvider = args.healthCheckCallbackProvider;</div><div class="line">  <span class="keyword">this</span>.eventListeners.addAll(args.getEventListeners());</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler = args.preRegistrationHandler;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.healthCheckCallbackProvider = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.healthCheckHandlerProvider = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.2 èµ‹å€¼ ApplicationInfoManagerã€EurekaClientConfig</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</div><div class="line">InstanceInfo myInfo = applicationInfoManager.getInfo();</div><div class="line"></div><div class="line">clientConfig = config;</div><div class="line">staticClientConfig = clientConfig;</div><div class="line">transportConfig = config.getTransportConfig();</div><div class="line">instanceInfo = myInfo;</div><div class="line"><span class="keyword">if</span> (myInfo != <span class="keyword">null</span>) &#123;</div><div class="line">  appPathIdentifier = instanceInfo.getAppName() + <span class="string">"/"</span> + instanceInfo.getId(); <span class="comment">// æ— å®é™…ä¸šåŠ¡ç”¨é€”ï¼Œç”¨äºæ‰“ logger</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  logger.warn(<span class="string">"Setting instanceInfo to a passed in null value"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.3 èµ‹å€¼ BackupRegistry</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.backupRegistryProvider = backupRegistryProvider;</div></pre></td></tr></table></figure></p><h3>3.2.4 åˆå§‹åŒ– InstanceInfoBasedUrlRandomizer</h3><p>TODO[0016]ï¼šInstanceInfoBasedUrlRandomizer</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.urlRandomizer = <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(instanceInfo);</div></pre></td></tr></table></figure></p><h3>3.2.5 åˆå§‹åŒ– Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Applications&gt; localRegionApps = <span class="keyword">new</span> AtomicReference&lt;Applications&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‹‰å–æ³¨å†Œä¿¡æ¯æ¬¡æ•°</span></div><div class="line"><span class="comment">* monotonically increasing generation counter to ensure stale threads do not reset registry to an older version</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong fetchRegistryGeneration;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">localRegionApps.set(<span class="keyword">new</span> Applications());</div><div class="line"></div><div class="line">fetchRegistryGeneration = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure></p><ul><li>åœ¨åˆ›å»º DiscoveryClient æ—¶ï¼Œ<code>localRegionApps</code> ä¸ºç©ºã€‚</li><li>å®šæ—¶ä»»åŠ¡<strong>é—´éš”</strong>ä» Eureka-Server æ‹‰å–æ³¨å†Œåº”ç”¨ä¿¡æ¯åˆ°æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3>3.2.6 è·å–å“ªäº› Region é›†åˆçš„æ³¨å†Œä¿¡æ¯</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–å“ªäº›åŒºåŸŸ( Region )é›†åˆçš„æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String&gt; remoteRegionsToFetch;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–å“ªäº›åŒºåŸŸ( Region )é›†åˆçš„æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String[]&gt; remoteRegionsRef;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">remoteRegionsToFetch = <span class="keyword">new</span> AtomicReference&lt;&gt;(clientConfig.fetchRegistryForRemoteRegions());</div><div class="line">remoteRegionsRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(remoteRegionsToFetch.get() == <span class="keyword">null</span> ? <span class="keyword">null</span> : remoteRegionsToFetch.get().split(<span class="string">","</span>));</div></pre></td></tr></table></figure></p><h3>3.2.7 åˆå§‹åŒ–æ‹‰å–ã€å¿ƒè·³çš„ç›‘æ§</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulRegistryFetchTimestamp = -<span class="number">1</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸå‘ Eureka-Server å¿ƒè·³æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¿ƒè·³ç›‘æ§</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric heartbeatStalenessMonitor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‹‰å–ç›‘æ§</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric registryStalenessMonitor;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (config.shouldFetchRegistry()) &#123;</div><div class="line">  <span class="keyword">this</span>.registryStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRY_PREFIX + <span class="string">"lastUpdateSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.registryStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (config.shouldRegisterWithEureka()) &#123;</div><div class="line">  <span class="keyword">this</span>.heartbeatStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRATION_PREFIX + <span class="string">"lastHeartbeatSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.heartbeatStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ¯æ¬¡æˆåŠŸå‘ Eureka-Serve å¿ƒè·³æˆ–è€…ä»ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯åï¼Œéƒ½ä¼šæ›´æ–°ç›¸åº”æ—¶é—´æˆ³ã€‚</li><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li><li>å¯¹ <a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/util/ThresholdLevelsMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.util.ThresholdLevelsMetric</code></a> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO[0012]ï¼šç›‘æ§ç›¸å…³ï¼‰</li></ul><h3>3.2.8 ç»“æŸåˆå§‹åŒ–ï¼Œå½“æ— éœ€å’Œ Eureka-Server äº¤äº’</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (!config.shouldRegisterWithEureka() &amp;&amp; !config.shouldFetchRegistry()) &#123;</div><div class="line">  logger.info(<span class="string">"Client configured to neither register nor query for data."</span>);</div><div class="line">  scheduler = <span class="keyword">null</span>;</div><div class="line">  heartbeatExecutor = <span class="keyword">null</span>;</div><div class="line">  cacheRefreshExecutor = <span class="keyword">null</span>;</div><div class="line">  eurekaTransport = <span class="keyword">null</span>;</div><div class="line">  instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(<span class="keyword">new</span> PropertyBasedAzToRegionMapper(config), clientConfig.getRegion());</div><div class="line"></div><div class="line">  <span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></div><div class="line">  <span class="comment">// to work with DI'd DiscoveryClient</span></div><div class="line">  DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</div><div class="line">  DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line"></div><div class="line">  initTimestampMs = System.currentTimeMillis();</div><div class="line">  logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</div><div class="line">          initTimestampMs, <span class="keyword">this</span>.getApplications().size());</div><div class="line"></div><div class="line">  <span class="keyword">return</span>;  <span class="comment">// no need to setup up an network tasks and we are done</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.9 åˆå§‹åŒ–çº¿ç¨‹æ± </h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* çº¿ç¨‹æ± </span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* A scheduler to be used for the following 3 tasks: ã€ç›®å‰åªæœ‰ä¸¤ä¸ªã€‘</span></div><div class="line"><span class="comment">* - updating service urls</span></div><div class="line"><span class="comment">* - scheduling a TimedSuperVisorTask</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line"><span class="comment">// additional executors for supervised subtasks</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¿ƒè·³æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor heartbeatExecutor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* &#123;<span class="doctag">@link</span> #localRegionApps&#125; åˆ·æ–°æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cacheRefreshExecutor;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></div><div class="line">scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build());</div><div class="line"></div><div class="line">heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">     <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build()</div><div class="line">);  <span class="comment">// use direct handoff</span></div><div class="line"></div><div class="line">cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">     <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build()</div><div class="line">);  <span class="comment">// use direct handoff</span></div></pre></td></tr></table></figure></p><ul><li><code>scheduler</code>ï¼Œ<strong>å®šæ—¶ä»»åŠ¡</strong>çº¿ç¨‹æ± ï¼Œåˆå§‹åŒ–å¤§å°ä¸º 2ï¼Œä¸€ä¸ªç»™ <code>heartbeatExecutor</code>ï¼Œä¸€ä¸ªç»™ <code>cacheRefreshExecutor</code>ã€‚</li><li><code>heartbeatExecutor</code>ã€<code>cacheRefreshExecutor</code> åœ¨æäº¤ç»™ <code>scheduler</code> æ‰å£°æ˜å…·ä½“çš„<strong>ä»»åŠ¡</strong>ã€‚</li></ul><h3>3.2.10 åˆå§‹åŒ– Eureka ç½‘ç»œé€šä¿¡ç›¸å…³</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">eurekaTransport = <span class="keyword">new</span> EurekaTransport();</div><div class="line">scheduleServerEndpointTask(eurekaTransport, args);</div></pre></td></tr></table></figure></p><ul><li>æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/?self">ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹</a> å’Œ <a href="http://www.iocoder.cn/Eureka/transport/?self">ã€ŠEureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul><h3>3.2.11 åˆå§‹åŒ– InstanceRegionChecker</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">AzToRegionMapper azToRegionMapper;</div><div class="line"><span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</div><div class="line">    azToRegionMapper = <span class="keyword">new</span> DNSBasedAzToRegionMapper(clientConfig);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    azToRegionMapper = <span class="keyword">new</span> PropertyBasedAzToRegionMapper(clientConfig);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsToFetch.get()) &#123;</div><div class="line">    azToRegionMapper.setRegionsToFetch(remoteRegionsToFetch.get().split(<span class="string">","</span>));</div><div class="line">&#125;</div><div class="line">instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(azToRegionMapper, clientConfig.getRegion());</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.discovery.AzToRegionMapper</code>ï¼Œä¸»è¦ç”¨äºäºšé©¬é€Š AWSï¼Œè·³è¿‡ã€‚</p></li><li><p><code>com.netflix.discovery.InstanceRegionChecker</code>ï¼Œåº”ç”¨å®ä¾‹ä¿¡æ¯åŒºåŸŸ( <code>region</code> )æ ¡éªŒï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceRegionChecker</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å’Œäºšé©¬é€Š AWS ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ¬åœ°åŒºåŸŸ( Region )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String localRegion;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocalRegion</span><span class="params">(@Nullable String instanceRegion)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == instanceRegion || instanceRegion.equals(localRegion); <span class="comment">// no region == local</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLocalRegion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> localRegion;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>3.2.12 ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">  fetchRegistryFromBackup();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server <strong>åˆå§‹</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯ã€‚åœ¨ï¼ˆTOåæ–‡é“¾æ¥ï¼‰è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>#fetchRegistryFromBackup()</code> æ–¹æ³•ï¼Œè‹¥<strong>åˆå§‹</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯å¤±è´¥ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè·å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fetchRegistryFromBackup</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">        BackupRegistry backupRegistryInstance = newBackupRegistryInstance();</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == backupRegistryInstance) &#123; <span class="comment">// backward compatibility with the old protected method, in case it is being used.</span></div><div class="line">            backupRegistryInstance = backupRegistryProvider.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != backupRegistryInstance) &#123;</div><div class="line">            Applications apps = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (isFetchingRemoteRegionRegistries()) &#123;</div><div class="line">                String remoteRegionsStr = remoteRegionsToFetch.get();</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsStr) &#123;</div><div class="line">                    apps = backupRegistryInstance.fetchRegistry(remoteRegionsStr.split(<span class="string">","</span>));</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                apps = backupRegistryInstance.fetchRegistry();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (apps != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> Applications applications = <span class="keyword">this</span>.filterAndShuffle(apps);</div><div class="line">                applications.setAppsHashCode(applications.getReconcileHashCode());</div><div class="line">                localRegionApps.set(applications);</div><div class="line">                logTotalInstances();</div><div class="line">                logger.info(<span class="string">"Fetched registry successfully from the backup"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.warn(<span class="string">"No backup registry instance defined &amp; unable to find any discovery servers."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        logger.warn(<span class="string">"Cannot fetch applications from apps although backup registry was specified"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>BackupRegistry ç›®å‰æš‚æœªæä¾›é»˜è®¤å®ç°ï¼Œéœ€è¦è‡ªè¡Œç›¸å…³é€»è¾‘ã€‚</li></ul></li></ul><h3>3.2.13 æ‰§è¡Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// call and execute the pre registration handler before all background tasks (inc registration) is started</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.preRegistrationHandler != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler.beforeRegistration();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.14 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">initScheduledTasks();</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line">       <span class="comment">// registry cache refresh timer</span></div><div class="line">       <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"cacheRefresh"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       cacheRefreshExecutor,</div><div class="line">                       registryFetchIntervalSeconds,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> CacheRefreshThread()</div><div class="line">               ),</div><div class="line">               registryFetchIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">       <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</div><div class="line">       logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</div><div class="line"></div><div class="line">       <span class="comment">// Heartbeat timer</span></div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"heartbeat"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       heartbeatExecutor,</div><div class="line">                       renewalIntervalInSecs,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> HeartbeatThread()</div><div class="line">               ),</div><div class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">       <span class="comment">// InstanceInfo replicator</span></div><div class="line">       instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</div><div class="line">               <span class="keyword">this</span>,</div><div class="line">               instanceInfo,</div><div class="line">               clientConfig.getInstanceInfoReplicationIntervalSeconds(),</div><div class="line">               <span class="number">2</span>); <span class="comment">// burstSize</span></div><div class="line"></div><div class="line">       statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</div><div class="line">                       InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</div><div class="line">                   <span class="comment">// log at warn level if DOWN was involved</span></div><div class="line">                   logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">               &#125;</div><div class="line">               instanceInfoReplicator.onDemandUpdate();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</div><div class="line">           applicationInfoManager.registerStatusChangeListener(statusChangeListener);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>åˆå§‹åŒ–</strong>ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ‰§è¡Œå™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</li><li><strong>åˆå§‹åŒ–</strong>å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> è¯¦ç»†è§£æã€‚</li></ul><h3>3.2.15 å‘ Servo æ³¨å†Œç›‘æ§</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  Monitors.registerObject(<span class="keyword">this</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">  logger.warn(<span class="string">"Cannot register timers"</span>, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul><h3>3.2.16 åˆå§‹åŒ–å®Œæˆ</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆå§‹åŒ–å®Œæˆæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> initTimestampMs;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// ã€3.2.16ã€‘åˆå§‹åŒ–å®Œæˆ</span></div><div class="line"><span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></div><div class="line"><span class="comment">// to work with DI'd DiscoveryClient</span></div><div class="line">DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</div><div class="line">DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line"></div><div class="line">initTimestampMs = System.currentTimeMillis();</div><div class="line">logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</div><div class="line">      initTimestampMs, <span class="keyword">this</span>.getApplications().size());</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>ç”±äºç¬”è€…æ˜¯è¾¹ç†è§£æºç è¾¹è¾“å‡ºåšå®¢å†…å®¹ï¼Œå¦‚æœæœ‰é”™è¯¯æˆ–è€…ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œ<strong>æ¬¢è¿</strong>å¾®ç¬‘ç»™æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç•™è¨€ï¼Œæˆ‘ä¼š<strong>ä»”ç»†</strong>å›å¤ã€‚æ„Ÿè°¢ + 1024ã€‚</p><p>åé¢æ–‡ç« ä¸æ–­æ›´æ–°ï¼Œä¼šæ…¢æ…¢å®Œå–„æœ¬æ–‡ä¸­çš„ã€‚</p><p>æ¨èå‚è€ƒé˜…è¯»ï¼š</p><ul><li><a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ç¨‹åºçŒ¿DD â€”â€” ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a> Spring Cloud Eureka â€”â€” æºç åˆ†æ</li><li><strong>ä¹°ç›—ç‰ˆä¹¦ï¼Œç­‰äºç¼–å†™ä¸€ä¸ªåˆçº§ BUG</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-third/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;u
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
</feed>
