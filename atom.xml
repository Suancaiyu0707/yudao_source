<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-10-08T12:16:52.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/</id>
    <published>2018-07-02T16:00:00.000Z</published>
    <updated>2017-10-08T12:16:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">2.1 è®¡ç®—å…¬å¼</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">2.2 åˆç†æ€§</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3. Eureka-Client å‘èµ·å¢é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.1 åˆå¹¶åº”ç”¨é›†åˆ</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">4. Eureka-Server æ¥æ”¶å…¨é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.2 æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">3.3 ç¼“å­˜è¯»å–</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server è·å–å¢é‡æ³¨å†Œä¿¡æ¯çš„è¿‡ç¨‹</strong>ã€‚</p><p>å‰ç½®é˜…è¯»ï¼š<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a></p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/01.png" alt=""></p></blockquote><p>Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œåˆ†æˆ<strong>å…¨é‡è·å–</strong>å’Œ<strong>å¢é‡è·å–</strong>ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒEureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡<strong>å…¨é‡</strong>è·å–è¿›è¡Œ<strong>æœ¬åœ°ç¼“å­˜</strong>æ³¨å†Œä¿¡æ¯ï¼Œè€Œåæ¯ <strong>30</strong> ç§’<strong>å¢é‡</strong>è·å–åˆ·æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>( éâ€œ<strong>æ­£å¸¸</strong>â€æƒ…å†µä¸‹ä¼šæ˜¯å…¨é‡è·å– )ã€‚</p><p>æœ¬æ–‡é‡ç‚¹åœ¨äº<strong>å¢é‡è·å–</strong>ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </h1><p><code>Applications.appsHashCode</code> ï¼Œåº”ç”¨é›†åˆ<strong>ä¸€è‡´æ€§å“ˆå¸Œç </strong>ã€‚</p><p><strong>å¢é‡</strong>è·å–æ³¨å†Œçš„åº”ç”¨é›†åˆ( Applications ) æ—¶ï¼ŒEureka-Client ä¼šè·å–åˆ°ï¼š</p><ol><li>Eureka-Server è¿‘æœŸå˜åŒ–( æ³¨å†Œã€ä¸‹çº¿ )çš„åº”ç”¨é›†åˆ</li><li>Eureka-Server åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </li></ol><p>Eureka-Client å°†<strong>å˜åŒ–</strong>çš„åº”ç”¨é›†åˆå’Œ<strong>æœ¬åœ°ç¼“å­˜</strong>çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶åè¿›è¡Œè®¡ç®—æœ¬åœ°çš„åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ã€‚è‹¥ä¸¤ä¸ª<strong>å“ˆå¸Œç </strong>ç›¸ç­‰ï¼Œæ„å‘³ç€å¢é‡è·å–æˆåŠŸï¼›è‹¥ä¸ç›¸ç­‰ï¼Œæ„å‘³ç€å¢é‡è·å–å¤±è´¥ï¼ŒEureka-Client é‡æ–°å’Œ Eureka-Server <strong>å…¨é‡</strong>è·å–åº”ç”¨é›†åˆã€‚</p><p>Eureka æ¯”è¾ƒåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ï¼Œå’Œæ—¥å¸¸æˆ‘ä»¬é€šè¿‡å“ˆå¸Œç æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ç±»ä¼¼ã€‚</p><h2>2.1 è®¡ç®—å…¬å¼</h2><p><code>appsHashCode = ${status}_${count}_</code></p><ul><li><p>ä½¿ç”¨æ¯ä¸ªåº”ç”¨å®ä¾‹çŠ¶æ€( <code>status</code> ) + æ•°é‡( <code>count</code> )æ‹¼æ¥å‡ºä¸€è‡´æ€§å“ˆå¸Œç ã€‚è‹¥æ•°é‡ä¸º 0 ï¼Œè¯¥åº”ç”¨å®ä¾‹çŠ¶æ€ä¸è¿›è¡Œæ‹¼æ¥ã€‚<strong>çŠ¶æ€ä»¥å­—ç¬¦ä¸²å¤§å°æ’åº</strong>ã€‚</p></li><li><p>ä¸¾ä¸ªä¾‹å­ï¼Œ8 ä¸ª UP ï¼Œ0 ä¸ª DOWN ï¼Œåˆ™ <code>appsHashCode = UP_8_</code> ã€‚8 ä¸ª UP ï¼Œ2 ä¸ª DOWN ï¼Œåˆ™ <code>appsHashCode = DOWN_2_UP_8_</code> ã€‚</p></li><li><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getReconcileHashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è®¡æ•°é›†åˆ keyï¼šåº”ç”¨å®ä¾‹çŠ¶æ€</span></div><div class="line">   TreeMap&lt;String, AtomicInteger&gt; instanceCountMap = <span class="keyword">new</span> TreeMap&lt;String, AtomicInteger&gt;();</div><div class="line">   populateInstanceCountMap(instanceCountMap);</div><div class="line">   <span class="comment">// è®¡ç®— hashcode</span></div><div class="line">   <span class="keyword">return</span> getReconcileHashCode(instanceCountMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#populateInstanceCountMap()</code> æ–¹æ³•ï¼Œè®¡ç®—æ¯ä¸ªåº”ç”¨å®ä¾‹çŠ¶æ€çš„æ•°é‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">populateInstanceCountMap</span><span class="params">(Map&lt;String, AtomicInteger&gt; instanceCountMap)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Application app : <span class="keyword">this</span>.getRegisteredApplications()) &#123;</div><div class="line">       <span class="keyword">for</span> (InstanceInfo info : app.getInstancesAsIsFromEureka()) &#123;</div><div class="line">           <span class="comment">// è®¡æ•°</span></div><div class="line">           AtomicInteger instanceCount = instanceCountMap.computeIfAbsent(info.getStatus().name(),</div><div class="line">                   k -&gt; <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>));</div><div class="line">           instanceCount.incrementAndGet();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Application&gt; <span class="title">getRegisteredApplications</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Application&gt;(<span class="keyword">this</span>.applications);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesAsIsFromEureka</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (instances) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;InstanceInfo&gt;(<span class="keyword">this</span>.instances);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è®¡æ•°é‚£å—ä»£ç ï¼Œä½¿ç”¨ Integer å³å¯ï¼Œæ— éœ€ä½¿ç”¨ AtomicInteger ã€‚</li></ul></li></ul></li><li><p>è°ƒç”¨ <code>#getReconcileHashCode()</code> æ–¹æ³•ï¼Œè®¡ç®— <code>hashcode</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getReconcileHashCode</span><span class="params">(Map&lt;String, AtomicInteger&gt; instanceCountMap)</span> </span>&#123;</div><div class="line">   StringBuilder reconcileHashCode = <span class="keyword">new</span> StringBuilder(<span class="number">75</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, AtomicInteger&gt; mapEntry : instanceCountMap.entrySet()) &#123;</div><div class="line">       reconcileHashCode.append(mapEntry.getKey()).append(STATUS_DELIMITER) <span class="comment">// status</span></div><div class="line">               .append(mapEntry.getValue().get()).append(STATUS_DELIMITER); <span class="comment">// count</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> reconcileHashCode.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>2.2 åˆç†æ€§</h2><p><strong>æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„</strong><br><strong>æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„</strong><br><strong>æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„</strong></p><p>ç¬”è€…åˆšçœ‹å®Œåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è®¡ç®—å…¬å¼ï¼Œå¤„äºä¸€è„¸æ‡µé€¼çš„çŠ¶æ€ã€‚è¿™ä¹ˆç²¾ç®€çš„æ–¹å¼çœŸçš„èƒ½å¤Ÿæ ¡éªŒå‡ºæ•°æ®çš„ä¸€è‡´æ€§ä¹ˆï¼Ÿä¸æ™“å¾—æœ‰å¤šå°‘è¯»è€…è·Ÿç¬”è€…æœ‰ä¸€æ ·çš„ç–‘æƒ‘ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è®ºè¯è¯¥ç®—æ³•çš„åˆç†æ€§( ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“ )ã€‚</p><p>ä¸€è‡´æ€§å“ˆå¸Œå€¼é€šè¿‡<strong>çŠ¶æ€ + æ•°é‡</strong>æ¥è®¡ç®—ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯èƒ½çŠ¶æ€æ€»æ•°æ˜¯ä¸€æ ·å¤šï¼Œå®é™…åˆ†å¸ƒåœ¨ä¸åŒçš„åº”ç”¨ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬åˆ—ä¸¾æ¨¡å‹å¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th>UP</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m</td></tr><tr><td>åº”ç”¨B</td><td>n</td></tr></tbody></table><p>å¦‚æœæ­¤æ—¶åº”ç”¨A ä¸‹çº¿äº† c ä¸ªåŸåº”ç”¨å®ä¾‹ï¼Œåº”ç”¨B æ³¨å†Œäº† c ä¸ªä¿¡åº”ç”¨å®ä¾‹ï¼Œé‚£ä¹ˆå¤„äº UP çŠ¶æ€çš„æ•°é‡ä»ç„¶æ˜¯ m + n ä¸ªã€‚</p><ul><li>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒEureka-Client ä» Eureka-Server è·å–åˆ°<strong>å®Œæ•´çš„å¢é‡å˜åŒ–</strong>å¹¶åˆå¹¶ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…æ˜¯ä¸€è‡´çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>åˆç†</strong>ã€‚</li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m - c</td><td>m - c</td></tr><tr><td>åº”ç”¨B</td><td>n + c</td><td>n + c</td></tr></tbody></table><ul><li>å¼‚å¸¸æƒ…å†µä¸‹ã€1ã€‘ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—å…¨éƒ¨è¿‡æœŸã€‚é‚£ Eureka-Client ä» Eureka-Server è·å–åˆ°<strong>ç©ºçš„å¢é‡å˜åŒ–</strong>å¹¶åˆå¹¶ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œ ä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>ä¸åˆç†</strong>ã€‚</li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m - c</td><td>m</td></tr><tr><td>åº”ç”¨B</td><td>n + c</td><td>n</td></tr></tbody></table><ul><li>å¼‚å¸¸æƒ…å†µä¸‹ã€2ã€‘ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—éƒ¨åˆ†è¿‡æœŸï¼Œä¾‹å¦‚åº”ç”¨A å’Œ åº”ç”¨B éƒ½å‰©ä½™ w æ¡å˜æ›´è®°å½•ã€‚é‚£ Eureka-Client ä» Eureka-Server è·å–åˆ°<strong>éƒ¨åˆ†çš„å¢é‡å˜åŒ–</strong>å¹¶åˆå¹¶ï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>ä¸åˆç†</strong>ã€‚</li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>m - c</td><td>m - w</td></tr><tr><td>åº”ç”¨B</td><td>n + c</td><td>n + w</td></tr></tbody></table><p>What ï¼Ÿ ä»å¼‚å¸¸æƒ…å†µã€1ã€‘ã€2ã€‘å¯ä»¥çœ‹åˆ°ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ç«Ÿç„¶æ˜¯<strong>ä¸åˆç†</strong>çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰‹åŠ¨æ¥åšä¸€æ¬¡æœ€ç²¾ç®€çš„å®éªŒã€‚å®éªŒå¦‚ä¸‹ï¼š</p><ul><li>æ¨¡æ‹Ÿåœºæ™¯ï¼šå¼‚å¸¸æƒ…å†µã€1ã€‘ï¼Œm = n = c = 1 ã€‚ç®€å•ç²—æš´ã€‚</li><li>ç‰¹åˆ«é…ç½®<ul><li><code>eureka.retentionTimeInMSInDeltaQueue = 1</code> ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—æ¯æ¡è®°å½•å­˜æ´»æ—¶é•¿ 1 msã€‚ç”¨ä»¥å®ç° Eureka-Client è¯·æ±‚ä¸åˆ°å®Œæ•´çš„å¢é‡å˜åŒ–ã€‚</li><li><code>eureka.deltaRetentionTimerIntervalInMs = 1</code> ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—æ¯æ¡è®°å½•è¿‡æœŸå®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ 1 msã€‚ç”¨ä»¥å®ç° Eureka-Client è¯·æ±‚ä¸åˆ°å®Œæ•´çš„å¢é‡å˜åŒ–ã€‚</li><li><code>eureka.shouldUseReadOnlyResponseCache = false</code> ï¼Œç¦ç”¨å“åº”ç¼“å­˜çš„åªè¯»ç¼“å­˜ã€‚ç”¨ä»¥é¿å…ç­‰å¾…ç¼“å­˜åˆ·æ–°ã€‚</li><li><code>eureka.waitTimeInMsWhenSyncEmpty = 1</code> ï¼Œ</li></ul></li><li>å®éªŒè¿‡ç¨‹<ol><li>00:00 å¯åŠ¨ Eureka-Server</li><li>00:30 å¯åŠ¨åº”ç”¨A ï¼Œå‘ Eureka-Server æ³¨å†Œ</li><li>01:00 å¯åŠ¨ Eureka-Client ï¼Œå‘ Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ï¼Œç­‰å¾…è·å–åˆ°åº”ç”¨A</li><li>01:30 å…³é—­åº”ç”¨A ã€‚ç«‹å³å¯åŠ¨åº”ç”¨B ï¼Œå‘ Eureka-Server æ³¨å†Œ</li><li>ç­‰å¾… 5 åˆ†é’Ÿï¼ŒEureka-Client æ— æ³•è·å–åˆ°åº”ç”¨B</li><li>æ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•<strong>ä¸åˆç†ã€‚</strong></li></ol></li></ul><table><thead><tr><th></th><th>UP (server)</th><th>UP (client)</th></tr></thead><tbody><tr><td>åº”ç”¨A</td><td>0</td><td>1</td></tr><tr><td>åº”ç”¨B</td><td>1</td><td>0</td></tr></tbody></table><p>ğŸ™‚<strong>ç»“è®º</strong>ğŸ™‚</p><p>å½“ç„¶æ’é™¤æ‰ç‰¹åˆ«æç«¯çš„åœºæ™¯ï¼ŒEureka-Client ä» Eureka-Server å› ä¸ºç½‘ç»œå¼‚å¸¸å¯¼è‡´ä¸€ç›´åŒæ­¥ä¸åˆ°å¢é‡å˜åŒ–ï¼Œåˆæ°å¥½åº”ç”¨å…³é—­å’Œå¼€å¯æ»¡è¶³çŠ¶æ€ç»Ÿè®¡æ•°é‡ã€‚å¦å¤–ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—è®°å½•è¿‡æœŸæ—¶é•¿ä¸º 300 ç§’ï¼Œå¢é‡è·å–é¢‘ç‡ä¸º 30 ç§’ï¼Œè·å–çš„æ¬¡æ•°æœ‰ 10 æ¬¡å·¦å³ã€‚<strong>æ‰€ä»¥ï¼Œåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç åœ¨ç»å¤§å¤šæ•°åœºæ™¯æ˜¯åˆç†çš„</strong>ã€‚<strong>ç¬”è€…çš„YY</strong>ï¼Œè§£å†³è¿™ä¸ªæå°åœºæ™¯æœ‰å¦‚ä¸‹æ–¹å¼ï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼Œä¿®æ”¹è®¡ç®—å…¬å¼ <code>appsHashCode = MD5(${app_name}_${instance_id}_${status}_${count}_)</code> ï¼Œå¢åŠ å¯¹åº”ç”¨åå’Œåº”ç”¨å®ä¾‹ç¼–å·æ•æ„Ÿã€‚</li><li>ç¬¬äºŒç§ï¼Œæ¯ N åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ã€‚</li></ul><p>ps ï¼šç¬”è€…æ€€ç€å¿å¿‘çš„å¿ƒå†™å®Œäº†è¿™ä¸ªå°èŠ‚ï¼Œå¦‚æœæœ‰ä¸åˆç†çš„åœ°æ–¹ï¼Œåˆæˆ–è€…æœ‰ä¸åŒè§‚ç‚¹çš„èƒ–å‹ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨ã€‚è°¢è°¢ã€‚</p><p>TODO[0027][åæ€]ï¼šåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚</p><h1>3. Eureka-Client å‘èµ·å¢é‡è·å–</h1><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> é‡Œï¼Œè°ƒç”¨ <code>DiscoveryClient#getAndUpdateDelta(...)</code> æ–¹æ³•ï¼Œ<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶<strong>åˆ·æ–°</strong>æœ¬åœ°ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndUpdateDelta</span><span class="params">(Applications applications)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="comment">// å¢é‡è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"> <span class="number">5</span>:     Applications delta = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>:     EurekaHttpResponse&lt;Applications&gt; httpResponse = eurekaTransport.queryClient.getDelta(remoteRegionsRef.get());</div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</div><div class="line"> <span class="number">8</span>:         delta = httpResponse.getEntity();</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (delta == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>:         <span class="comment">// å¢é‡è·å–ä¸ºç©ºï¼Œå…¨é‡è·å–</span></div><div class="line"><span class="number">13</span>:         logger.warn(<span class="string">"The server does not allow the delta revision to be applied because it is not safe. "</span></div><div class="line"><span class="number">14</span>:                 + <span class="string">"Hence got the full registry."</span>);</div><div class="line"><span class="number">15</span>:         getAndStoreFullRegistry();</div><div class="line"><span class="number">16</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</div><div class="line"><span class="number">17</span>:         logger.debug(<span class="string">"Got delta update with apps hashcode &#123;&#125;"</span>, delta.getAppsHashCode());</div><div class="line"><span class="number">18</span>:         String reconcileHashCode = <span class="string">""</span>;</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (fetchRegistryUpdateLock.tryLock()) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:                 <span class="comment">// å°†å˜åŒ–çš„åº”ç”¨é›†åˆå’Œæœ¬åœ°ç¼“å­˜çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶</span></div><div class="line"><span class="number">22</span>:                 updateDelta(delta);</div><div class="line"><span class="number">23</span>:                 <span class="comment">// è®¡ç®—æœ¬åœ°çš„åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç </span></div><div class="line"><span class="number">24</span>:                 reconcileHashCode = getReconcileHashCode(applications);</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">26</span>:                 fetchRegistryUpdateLock.unlock();</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">29</span>:             logger.warn(<span class="string">"Cannot acquire update lock, aborting getAndUpdateDelta"</span>);</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:         <span class="comment">// There is a diff in number of instances for some reason</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (!reconcileHashCode.equals(delta.getAppsHashCode()) <span class="comment">// ä¸€è‡´æ€§å“ˆå¸Œå€¼ä¸ç›¸ç­‰</span></div><div class="line"><span class="number">33</span>:                 || clientConfig.shouldLogDeltaDiff()) &#123; <span class="comment">//</span></div><div class="line"><span class="number">34</span>:             reconcileAndLogDifference(delta, reconcileHashCode);  <span class="comment">// this makes a remoteCall</span></div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>:         logger.warn(<span class="string">"Not updating application delta as another thread is updating it already"</span>);</div><div class="line"><span class="number">38</span>:         logger.debug(<span class="string">"Ignoring delta update with apps hashcode &#123;&#125;, as another thread is updating it already"</span>, delta.getAppsHashCode());</div><div class="line"><span class="number">39</span>:     &#125;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 9 è¡Œ ï¼šè¯·æ±‚<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Applications&gt; <span class="title">getDelta</span><span class="params">(String... regions)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> getApplicationsInternal(<span class="string">"apps/delta"</span>, regions);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#getApplicationsInternal(...)</code> æ–¹æ³•ï¼ŒGET è¯·æ±‚ Eureka-Server çš„ <code>apps/detla</code> æ¥å£ï¼Œå‚æ•°ä¸º <code>regions</code> ï¼Œè¿”å›æ ¼å¼ä¸º JSON ï¼Œå®ç°å¢é‡è·å–æ³¨å†Œä¿¡æ¯ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 15 è¡Œ ï¼š<strong>å¢é‡</strong>è·å–å¤±è´¥ï¼Œè°ƒç”¨ <code>#getAndStoreFullRegistry()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚è¯¥æ–¹æ³•åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4.1 å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 16 è‡³ 35 è¡Œ ï¼šå¤„ç†<strong>å¢é‡</strong>è·å–çš„ç»“æœã€‚</p><ul><li>ç¬¬ 16 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</li><li>ç¬¬ 19 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</li><li>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#updateDelta(...)</code> æ–¹æ³•ï¼Œå°†<strong>å˜åŒ–</strong>çš„åº”ç”¨é›†åˆå’Œ<strong>æœ¬åœ°ç¼“å­˜</strong>çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶ã€‚</li><li>ç¬¬ 31 è‡³ 35 è¡Œ ï¼šä¸€è‡´æ€§å“ˆå¸Œå€¼ä¸ç›¸ç­‰ï¼Œè°ƒç”¨ <code>#reconcileAndLogDifference()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå’Œ <code>#getAndStoreFullRegistry()</code> åŸºæœ¬ç±»ä¼¼ã€‚<ul><li>ç¬¬ 33 è¡Œ ï¼šé…ç½® <code>eureka.printDeltaFullDiff</code> ï¼Œæ˜¯å¦æ‰“å°å¢é‡å’Œå…¨é‡å·®å¼‚ã€‚é»˜è®¤å€¼ ï¼š<code>false</code> ã€‚ä»ç›®å‰ä»£ç å®ç°ä¸Šæ¥çœ‹ï¼Œæš‚æ—¶æ²¡æœ‰ç”Ÿæ•ˆã€‚<strong>æ³¨æ„</strong> ï¼šå¼€å¯è¯¥å‚æ•°ä¼šå¯¼è‡´æ¯æ¬¡<strong>å¢é‡</strong>è·å–ååˆå‘èµ·<strong>å…¨é‡</strong>è·å–ï¼Œä¸è¦å¼€å¯ã€‚</li></ul></li></ul></li></ul><h2>3.1 åˆå¹¶åº”ç”¨é›†åˆ</h2><p>è°ƒç”¨ <code>#updateDelta(...)</code> æ–¹æ³•ï¼Œå°†<strong>å˜åŒ–</strong>çš„åº”ç”¨é›†åˆå’Œ<strong>æœ¬åœ°ç¼“å­˜</strong>çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDelta</span><span class="params">(Applications delta)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">int</span> deltaCount = <span class="number">0</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (Application app : delta.getRegisteredApplications()) &#123; <span class="comment">// å¾ªç¯å¢é‡ï¼ˆå˜åŒ–ï¼‰åº”ç”¨é›†åˆ</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line"> <span class="number">5</span>:             Applications applications = getApplications();</div><div class="line"> <span class="number">6</span>:             <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">7</span>:             String instanceRegion = instanceRegionChecker.getInstanceRegion(instance);</div><div class="line"> <span class="number">8</span>:             <span class="keyword">if</span> (!instanceRegionChecker.isLocalRegion(instanceRegion)) &#123;</div><div class="line"> <span class="number">9</span>:                 Applications remoteApps = remoteRegionVsApps.get(instanceRegion);</div><div class="line"><span class="number">10</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == remoteApps) &#123;</div><div class="line"><span class="number">11</span>:                     remoteApps = <span class="keyword">new</span> Applications();</div><div class="line"><span class="number">12</span>:                     remoteRegionVsApps.put(instanceRegion, remoteApps);</div><div class="line"><span class="number">13</span>:                 &#125;</div><div class="line"><span class="number">14</span>:                 applications = remoteApps;</div><div class="line"><span class="number">15</span>:             &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:             ++deltaCount;</div><div class="line"><span class="number">18</span>:             <span class="keyword">if</span> (ActionType.ADDED.equals(instance.getActionType())) &#123; <span class="comment">// æ·»åŠ </span></div><div class="line"><span class="number">19</span>:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());</div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:                     applications.addApplication(app);</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:                 logger.debug(<span class="string">"Added instance &#123;&#125; to the existing apps in region &#123;&#125;"</span>, instance.getId(), instanceRegion);</div><div class="line"><span class="number">24</span>:                 applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ActionType.MODIFIED.equals(instance.getActionType())) &#123; <span class="comment">// ä¿®æ”¹</span></div><div class="line"><span class="number">26</span>:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());</div><div class="line"><span class="number">27</span>:                 <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">28</span>:                     applications.addApplication(app);</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:                 logger.debug(<span class="string">"Modified instance &#123;&#125; to the existing apps "</span>, instance.getId());</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:                 applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);</div><div class="line"><span class="number">33</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ActionType.DELETED.equals(instance.getActionType())) &#123; <span class="comment">// åˆ é™¤</span></div><div class="line"><span class="number">34</span>:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (existingApp == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">36</span>:                     applications.addApplication(app);</div><div class="line"><span class="number">37</span>:                 &#125;</div><div class="line"><span class="number">38</span>:                 logger.debug(<span class="string">"Deleted instance &#123;&#125; to the existing apps "</span>, instance.getId());</div><div class="line"><span class="number">39</span>:                 applications.getRegisteredApplications(instance.getAppName()).removeInstance(instance);</div><div class="line"><span class="number">40</span>:             &#125;</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:     &#125;</div><div class="line"><span class="number">43</span>:     logger.debug(<span class="string">"The total number of instances fetched by the delta processor : &#123;&#125;"</span>, deltaCount);</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     getApplications().setVersion(delta.getVersion());</div><div class="line"><span class="number">46</span>:     <span class="comment">// è¿‡æ»¤ã€æ‰“ä¹±åº”ç”¨é›†åˆ</span></div><div class="line"><span class="number">47</span>:     getApplications().shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="number">50</span>:     <span class="keyword">for</span> (Applications applications : remoteRegionVsApps.values()) &#123;</div><div class="line"><span class="number">51</span>:         applications.setVersion(delta.getVersion());</div><div class="line"><span class="number">52</span>:         applications.shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());</div><div class="line"><span class="number">53</span>:     &#125;</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 15 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 18 è‡³ 24 è¡Œ ï¼šæ·»åŠ ( ADDED )åº”ç”¨å®ä¾‹æ—¶ï¼Œè°ƒç”¨ <code>Application#addInstance(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Application.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInstance</span><span class="params">(InstanceInfo i)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° åº”ç”¨å®ä¾‹æ˜ å°„</span></div><div class="line">   instancesMap.put(i.getId(), i);</div><div class="line">   <span class="keyword">synchronized</span> (instances) &#123;</div><div class="line">       <span class="comment">// ç§»é™¤åŸæœ‰å®ä¾‹</span></div><div class="line">       instances.remove(i);</div><div class="line">       <span class="comment">// æ·»åŠ æ–°å®ä¾‹</span></div><div class="line">       instances.add(i);</div><div class="line">       <span class="comment">// è®¾ç½® isDirty ï¼Œç›®å‰åªç”¨äº `#toString()` æ–¹æ³•æ‰“å°ï¼Œæ— ä¸šåŠ¡é€»è¾‘</span></div><div class="line">       isDirty = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123; <span class="comment">// åªä½¿ç”¨ ID è®¡ç®— hashcode</span></div><div class="line">   String id = getId();</div><div class="line">   <span class="keyword">return</span> (id == <span class="keyword">null</span>) ? <span class="number">31</span> : (id.hashCode() + <span class="number">31</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123; <span class="comment">// åªå¯¹æ¯” ID</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span> == obj) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (getClass() != obj.getClass()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   InstanceInfo other = (InstanceInfo) obj;</div><div class="line">   String id = getId();</div><div class="line">   <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">if</span> (other.getId() != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!id.equals(other.getId())) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 25 è‡³ 32 è¡Œ ï¼šä¿®æ”¹( MODIFIED )åº”ç”¨å®ä¾‹æ—¶ï¼Œ<strong>åŒæ ·</strong>è°ƒç”¨ <code>Application#addInstance(...)</code> æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 33 è‡³ 40 è¡Œ ï¼šåˆ é™¤( DELETED )åº”ç”¨å®ä¾‹æ—¶ï¼Œè°ƒç”¨ <code>Application#removeInstance(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeInstance</span><span class="params">(InstanceInfo i)</span> </span>&#123;</div><div class="line">    removeInstance(i, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeInstance</span><span class="params">(InstanceInfo i, <span class="keyword">boolean</span> markAsDirty)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹æ˜ å°„</span></div><div class="line">    instancesMap.remove(i.getId());</div><div class="line">    <span class="keyword">synchronized</span> (instances) &#123;</div><div class="line">        <span class="comment">// ç§»é™¤ åº”ç”¨å®ä¾‹</span></div><div class="line">        instances.remove(i);</div><div class="line">        <span class="keyword">if</span> (markAsDirty) &#123;</div><div class="line">            <span class="comment">// è®¾ç½® isDirty ï¼Œç›®å‰åªç”¨äº `#toString()` æ–¹æ³•æ‰“å°ï¼Œæ— ä¸šåŠ¡é€»è¾‘</span></div><div class="line">            isDirty = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>Applications#shuffleInstances(...)</code> æ–¹æ³•ï¼Œæ ¹æ®é…ç½® <code>eureka.shouldFilterOnlyUpInstances = true</code> ( é»˜è®¤å€¼ ï¼š<code>true</code> ) è¿‡æ»¤åªä¿ç•™çŠ¶æ€ä¸ºå¼€å¯( UP )çš„åº”ç”¨å®ä¾‹ï¼Œå¹¶<strong>éšæœºæ‰“ä¹±</strong>åº”ç”¨å®ä¾‹é¡ºåºã€‚æ‰“ä¹±åï¼Œå®ç°è°ƒç”¨åº”ç”¨æœåŠ¡çš„éšæœºæ€§ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/shared/Applications.java#L286" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹æ–¹æ³•å®ç°ã€‚</p></li><li><p>ç¬¬ 49 è‡³ 53 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li></ul><h1>4. Eureka-Server æ¥æ”¶å…¨é‡è·å–</h1><h2>3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</h2><p><code>com.netflix.eureka.resources.ApplicationsResource</code>ï¼Œå¤„ç†<strong>æ‰€æœ‰</strong>åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>æ¥æ”¶å¢é‡è·å–è¯·æ±‚ï¼Œæ˜ å°„ <code>ApplicationsResource#getContainers()</code> æ–¹æ³•ã€‚</p><ul><li>å’Œ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚ã€</a> ç±»ä¼¼ï¼Œå°±ä¸é‡å¤å•°å—¦å•¦ã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/225a81d9818d355503ad802363448eb29c374b6f/eureka-core/src/main/java/com/netflix/eureka/resources/ApplicationsResource.java#L190" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•çš„<strong>å¸¦ä¸­æ–‡æ³¨é‡Š</strong>ä»£ç ã€‚</li></ul><h2>3.2 æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</h2><p><code>AbstractInstanceRegistry.recentlyChangedQueue</code>ï¼Œæœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RecentlyChangedItem</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">long</span> lastUpdateTime;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ç§Ÿçº¦</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> Lease&lt;InstanceInfo&gt; leaseInfo;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">RecentlyChangedItem</span><span class="params">(Lease&lt;InstanceInfo&gt; lease)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.leaseInfo = lease;</div><div class="line">       lastUpdateTime = System.currentTimeMillis();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastUpdateTime</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.lastUpdateTime;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> Lease&lt;InstanceInfo&gt; <span class="title">getLeaseInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.leaseInfo;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å½“åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€çŠ¶æ€å˜æ›´æ—¶ï¼Œåˆ›å»ºæœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•( RecentlyChangedItem ) åˆ°é˜Ÿåˆ—ã€‚</p></li><li><p>åå°ä»»åŠ¡å®šæ—¶<strong>é¡ºåº</strong>æ‰«æé˜Ÿåˆ—ï¼Œå½“ <code>lastUpdateTime</code> è¶…è¿‡ä¸€å®šæ—¶é•¿åè¿›è¡Œç§»é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="keyword">this</span>.deltaRetentionTimer.schedule(getDeltaRetentionTask(),</div><div class="line">                serverConfig.getDeltaRetentionTimerIntervalInMs(),</div><div class="line">                serverConfig.getDeltaRetentionTimerIntervalInMs());</div><div class="line">                </div><div class="line"><span class="function"><span class="keyword">private</span> TimerTask <span class="title">getDeltaRetentionTask</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">           Iterator&lt;RecentlyChangedItem&gt; it = recentlyChangedQueue.iterator();</div><div class="line">           <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">               <span class="keyword">if</span> (it.next().getLastUpdateTime() &lt; System.currentTimeMillis() - serverConfig.getRetentionTimeInMSInDeltaQueue()) &#123;</div><div class="line">                   it.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é…ç½® <code>eureka.deltaRetentionTimerIntervalInMs</code>ï¼Œ ç§»é™¤é˜Ÿåˆ—é‡Œè¿‡æœŸçš„ç§Ÿçº¦å˜æ›´è®°å½•çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚</li><li>é…ç½® <code>eureka.retentionTimeInMSInDeltaQueue</code>ï¼Œç§Ÿçº¦å˜æ›´è®°å½•è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š 3 * 60 * 1000 æ¯«ç§’ã€‚</li></ul></li></ul><h2>3.3 ç¼“å­˜è¯»å–</h2><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.3 ç¼“å­˜è¯»å–ã€</a> é‡Œï¼Œåœ¨ <code>#generatePayload()</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>AbstractInstanceRegistry#getApplicationDeltas(...)</code> æ–¹æ³•ï¼Œè·å–è¿‘æœŸå˜åŒ–çš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationDeltas</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">// æ·»åŠ  å¢é‡è·å–æ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line">  <span class="number">3</span>:     GET_ALL_CACHE_MISS_DELTA.increment();</div><div class="line">  <span class="number">4</span>:     <span class="comment">// åˆå§‹åŒ– å˜åŒ–çš„åº”ç”¨é›†åˆ</span></div><div class="line">  <span class="number">5</span>:     Applications apps = <span class="keyword">new</span> Applications();</div><div class="line">  <span class="number">6</span>:     apps.setVersion(responseCache.getVersionDelta().get());</div><div class="line">  <span class="number">7</span>:     Map&lt;String, Application&gt; applicationInstancesMap = <span class="keyword">new</span> HashMap&lt;String, Application&gt;();</div><div class="line">  <span class="number">8</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">9</span>:         <span class="comment">// è·å–å†™é” TODO whyï¼Ÿ</span></div><div class="line"> <span class="number">10</span>:         write.lock();</div><div class="line"> <span class="number">11</span>:         <span class="comment">// è·å– æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"> <span class="number">12</span>:         Iterator&lt;RecentlyChangedItem&gt; iter = <span class="keyword">this</span>.recentlyChangedQueue.iterator();</div><div class="line"> <span class="number">13</span>:         logger.debug(<span class="string">"The number of elements in the delta queue is :"</span> + <span class="keyword">this</span>.recentlyChangedQueue.size());</div><div class="line"> <span class="number">14</span>:         <span class="comment">// æ‹¼è£… å˜åŒ–çš„åº”ç”¨é›†åˆ</span></div><div class="line"> <span class="number">15</span>:         <span class="keyword">while</span> (iter.hasNext()) &#123;</div><div class="line"> <span class="number">16</span>:             Lease&lt;InstanceInfo&gt; lease = iter.next().getLeaseInfo();</div><div class="line"> <span class="number">17</span>:             InstanceInfo instanceInfo = lease.getHolder();</div><div class="line"> <span class="number">18</span>:             Object[] args = &#123;instanceInfo.getId(), instanceInfo.getStatus().name(), instanceInfo.getActionType().name()&#125;;</div><div class="line"> <span class="number">19</span>:             logger.debug(<span class="string">"The instance id %s is found with status %s and actiontype %s"</span>, args);</div><div class="line"> <span class="number">20</span>:             Application app = applicationInstancesMap.get(instanceInfo.getAppName());</div><div class="line"> <span class="number">21</span>:             <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">22</span>:                 app = <span class="keyword">new</span> Application(instanceInfo.getAppName());</div><div class="line"> <span class="number">23</span>:                 applicationInstancesMap.put(instanceInfo.getAppName(), app);</div><div class="line"> <span class="number">24</span>:                 apps.addApplication(app);</div><div class="line"> <span class="number">25</span>:             &#125;</div><div class="line"> <span class="number">26</span>:             app.addInstance(decorateInstanceInfo(lease));</div><div class="line"> <span class="number">27</span>:         &#125;</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:         <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">30</span>:         <span class="keyword">boolean</span> disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();</div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> (!disableTransparentFallback) &#123;</div><div class="line"> <span class="number">32</span>:             Applications allAppsInLocalRegion = getApplications(<span class="keyword">false</span>);</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">for</span> (RemoteRegionRegistry remoteRegistry : <span class="keyword">this</span>.regionNameVSRemoteRegistry.values()) &#123;</div><div class="line"> <span class="number">35</span>:                 Applications applications = remoteRegistry.getApplicationDeltas();</div><div class="line"> <span class="number">36</span>:                 <span class="keyword">for</span> (Application application : applications.getRegisteredApplications()) &#123;</div><div class="line"> <span class="number">37</span>:                     Application appInLocalRegistry =</div><div class="line"> <span class="number">38</span>:                             allAppsInLocalRegion.getRegisteredApplications(application.getName());</div><div class="line"> <span class="number">39</span>:                     <span class="keyword">if</span> (appInLocalRegistry == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">40</span>:                         apps.addApplication(application);</div><div class="line"> <span class="number">41</span>:                     &#125;</div><div class="line"> <span class="number">42</span>:                 &#125;</div><div class="line"> <span class="number">43</span>:             &#125;</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="comment">// è·å–å…¨é‡åº”ç”¨é›†åˆï¼Œé€šè¿‡å®ƒè®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œå€¼</span></div><div class="line"> <span class="number">47</span>:         Applications allApps = getApplications(!disableTransparentFallback);</div><div class="line"> <span class="number">48</span>:         apps.setAppsHashCode(allApps.getReconcileHashCode());</div><div class="line"> <span class="number">49</span>:         <span class="keyword">return</span> apps;</div><div class="line"> <span class="number">50</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">51</span>:         write.unlock();</div><div class="line"> <span class="number">52</span>:     &#125;</div><div class="line"> <span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ 3 è¡Œ ï¼šæ·»åŠ å¢é‡è·å–æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li><li>ç¬¬ 4 è¡Œ ï¼šåˆå§‹åŒ–å˜åŒ–( å¢é‡ )çš„åº”ç”¨é›†åˆ( <code>apps</code> )ã€‚</li><li>ç¬¬ 9 è¡Œ ï¼šTODO[0026] ï¼šå†™é”</li><li>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šè·å–æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( <code>æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</code> )ã€‚</li><li>ç¬¬ 14 è‡³ 27 è¡Œ ï¼šæ‹¼è£…å˜åŒ–çš„åº”ç”¨é›†åˆ( <code>apps</code> )ã€‚</li><li>ç¬¬ 29 è‡³ 44 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 46 è‡³ 48 è¡Œ ï¼šè°ƒç”¨ <code>#getApplications(...)</code> æ–¹æ³•ï¼Œè·å–<strong>å…¨é‡</strong>åº”ç”¨é›†åˆ( <code>allApps</code> )ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.3.1 è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€</a> æœ‰è¯¦ç»†è§£æã€‚åé€šè¿‡ <code>allApps</code> è®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œå€¼ã€‚é€šè¿‡è¿™ä¸ªå…¨é‡åº”ç”¨é›†åˆçš„å“ˆå¸Œå€¼ï¼ŒEureka-Client è·å–åˆ°å¢é‡åº”ç”¨é›†åˆå¹¶åˆå¹¶åï¼Œå°±å¯ä»¥æ¯”å¯¹å•¦ã€‚</li><li>ç¬¬ 51 è¡Œ ï¼šé‡Šæ”¾å†™é”ã€‚</li></ul><h1>666. å½©è›‹</h1><p>åœ¨æ±‰å ¡ç‹å†™å®Œè¿™ç¯‡çƒ­æƒ…çš„åšå®¢ã€‚ä¸ºä»€ä¹ˆç”¨â€œçƒ­æƒ…â€è¿™ä¸ªå­—çœ¼å‘¢ï¼Ÿå¤§å¤å¤©çš„ï¼Œç«Ÿç„¶ä¸å¼€ç©ºè°ƒçš„ï¼å¯¹çš„ï¼Œæ²¡æœ‰å¼€ç©ºè°ƒï¼Œç®€ç›´æ˜¯ä¸ªå°ç«ç‚‰ã€‚æ©ï¼Œä¸è¿‡é™å¿ƒå†™å®Œè¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘è¿˜æ˜¯æŒºå—¨çš®çš„ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eure
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-fetch-all/</id>
    <published>2018-06-28T16:00:00.000Z</published>
    <updated>2017-10-08T03:23:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-all/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2. Eureka-Client å‘èµ·å…¨é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.1 åˆå§‹åŒ–å…¨é‡è·å–</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.2 å®šæ—¶è·å–</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.3 åˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3. Eureka-Server æ¥æ”¶å…¨é‡è·å–</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.2 å“åº”ç¼“å­˜ ResponseCache</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.3 ç¼“å­˜è¯»å–</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.4 ä¸»åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.5 è¢«åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">3.6 å®šæ—¶åˆ·æ–°åªè¯»ç¼“å­˜</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server è·å–å…¨é‡æ³¨å†Œä¿¡æ¯çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/01.png" alt=""></p></blockquote><p>Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œåˆ†æˆ<strong>å…¨é‡è·å–</strong>å’Œ<strong>å¢é‡è·å–</strong>ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒEureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡<strong>å…¨é‡</strong>è·å–è¿›è¡Œ<strong>æœ¬åœ°ç¼“å­˜</strong>æ³¨å†Œä¿¡æ¯ï¼Œè€Œåæ¯ <strong>30</strong> ç§’<strong>å¢é‡</strong>è·å–åˆ·æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>( éâ€œ<strong>æ­£å¸¸</strong>â€æƒ…å†µä¸‹ä¼šæ˜¯å…¨é‡è·å– )ã€‚</p><p>æœ¬æ–‡é‡ç‚¹åœ¨äº<strong>å…¨é‡è·å–</strong>ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. Eureka-Client å‘èµ·å…¨é‡è·å–</h1><p>æœ¬å°èŠ‚è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/03.png" alt=""></p><h2>2.1 åˆå§‹åŒ–å…¨é‡è·å–</h2><p>Eureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡<strong>å…¨é‡</strong>è·å–è¿›è¡Œ<strong>æœ¬åœ°ç¼“å­˜</strong>æ³¨å†Œä¿¡æ¯ï¼Œé¦–å…ˆä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Applications&gt; localRegionApps = <span class="keyword">new</span> AtomicReference&lt;Applications&gt;();</div><div class="line"></div><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">                    </div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">     </div><div class="line">    <span class="comment">// ã€3.2.5ã€‘åˆå§‹åŒ–åº”ç”¨é›†åˆåœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line">    localRegionApps.set(<span class="keyword">new</span> Applications());</div><div class="line">     </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç      </span></div><div class="line">     </div><div class="line">    <span class="comment">// ã€3.2.12ã€‘ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</span></div><div class="line">    <span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">        fetchRegistryFromBackup();</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç        </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.discovery.shared.Applications</code>ï¼Œæ³¨å†Œçš„åº”ç”¨é›†åˆã€‚è¾ƒä¸ºå®¹æ˜“ç†è§£ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/shared/Applications.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> é“¾æ¥æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ç±»ï¼Œè¿™é‡Œå°±ä¸å•°å—¦äº†ã€‚Applications ä¸ InstanceInfo ç±»å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/02.png" alt=""></p></li><li><p>é…ç½® <code>eureka.shouldFetchRegistry = true</code>ï¼Œå¼€å¯ä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ã€‚é»˜è®¤å€¼ï¼š<code>true</code> ã€‚</p></li><li><p>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server <strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œåœ¨ <a href="#">ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul><h2>2.2 å®šæ—¶è·å–</h2><p>Eureka-Client åœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/?self">åˆå§‹åŒ–</a>è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º<strong>è·å–æ³¨å†Œä¿¡æ¯</strong>çº¿ç¨‹ï¼Œ<strong>å›ºå®šé—´éš”</strong>å‘ Eureka-Server å‘èµ·<strong>è·å–æ³¨å†Œä¿¡æ¯</strong>( fetch )ï¼Œ<strong>åˆ·æ–°</strong>æœ¬åœ°æ³¨å†Œä¿¡æ¯<strong>ç¼“å­˜</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">               Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">               </div><div class="line">    <span class="comment">// ã€3.2.9ã€‘åˆå§‹åŒ–çº¿ç¨‹æ± </span></div><div class="line">    <span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></div><div class="line">    scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">         <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                 .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">                 .setDaemon(<span class="keyword">true</span>)</div><div class="line">                 .build());</div><div class="line">    </div><div class="line">    cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">         <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">         <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">         <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                 .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</div><div class="line">                 .setDaemon(<span class="keyword">true</span>)</div><div class="line">                 .build()</div><div class="line">     );  <span class="comment">// use direct handoff</span></div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="comment">// ã€3.2.14ã€‘åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</span></div><div class="line">    initScheduledTasks();</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">    <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line">       <span class="comment">// registry cache refresh timer</span></div><div class="line">       <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"cacheRefresh"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       cacheRefreshExecutor,</div><div class="line">                       registryFetchIntervalSeconds,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> CacheRefreshThread()</div><div class="line">               ),</div><div class="line">               registryFetchIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">     &#125;</div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ä»£ç ï¼Œå’Œ<strong>ç»­ç§Ÿ</strong>çš„å®šæ—¶ä»»åŠ¡ä»£ç ç±»ä¼¼ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> æœ‰è¯¦ç»†è§£æï¼Œè¿™é‡Œä¸é‡å¤åˆ†äº«ã€‚</p></li><li><p><code>com.netflix.discovery.DiscoveryClient.CacheRefreshThread</code>ï¼Œæ³¨å†Œä¿¡æ¯ç¼“å­˜åˆ·æ–°ä»»åŠ¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        refreshRegistry();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#refreshRegistry(false)</code> æ–¹æ³•ï¼Œåˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜ï¼Œåœ¨ <a href="#">ã€Œ2.3 åˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜ã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>2.3 åˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜</h2><p>è°ƒç”¨ <code>#refreshRegistry(false)</code> æ–¹æ³•ï¼Œåˆ·æ–°æ³¨å†Œä¿¡æ¯ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">refreshRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">3</span>:         <span class="comment">// TODO èŠ‹è‰¿ï¼šTODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">  <span class="number">4</span>:         <span class="keyword">boolean</span> isFetchingRemoteRegionRegistries = isFetchingRemoteRegionRegistries();</div><div class="line">  <span class="number">5</span>: </div><div class="line">  <span class="number">6</span>:         <span class="keyword">boolean</span> remoteRegionsModified = <span class="keyword">false</span>;</div><div class="line">  <span class="number">7</span>:         <span class="comment">// This makes sure that a dynamic change to remote regions to fetch is honored.</span></div><div class="line">  <span class="number">8</span>:         String latestRemoteRegions = clientConfig.fetchRegistryForRemoteRegions();</div><div class="line">  <span class="number">9</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> != latestRemoteRegions) &#123;</div><div class="line"> <span class="number">10</span>:             String currentRemoteRegions = remoteRegionsToFetch.get();</div><div class="line"> <span class="number">11</span>:             <span class="keyword">if</span> (!latestRemoteRegions.equals(currentRemoteRegions)) &#123;</div><div class="line"> <span class="number">12</span>:                 <span class="comment">// Both remoteRegionsToFetch and AzToRegionMapper.regionsToFetch need to be in sync</span></div><div class="line"> <span class="number">13</span>:                 <span class="keyword">synchronized</span> (instanceRegionChecker.getAzToRegionMapper()) &#123;</div><div class="line"> <span class="number">14</span>:                     <span class="keyword">if</span> (remoteRegionsToFetch.compareAndSet(currentRemoteRegions, latestRemoteRegions)) &#123;</div><div class="line"> <span class="number">15</span>:                         String[] remoteRegions = latestRemoteRegions.split(<span class="string">","</span>);</div><div class="line"> <span class="number">16</span>:                         remoteRegionsRef.set(remoteRegions);</div><div class="line"> <span class="number">17</span>:                         instanceRegionChecker.getAzToRegionMapper().setRegionsToFetch(remoteRegions);</div><div class="line"> <span class="number">18</span>:                         remoteRegionsModified = <span class="keyword">true</span>;</div><div class="line"> <span class="number">19</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">20</span>:                         logger.info(<span class="string">"Remote regions to fetch modified concurrently,"</span> +</div><div class="line"> <span class="number">21</span>:                                 <span class="string">" ignoring change from &#123;&#125; to &#123;&#125;"</span>, currentRemoteRegions, latestRemoteRegions);</div><div class="line"> <span class="number">22</span>:                     &#125;</div><div class="line"> <span class="number">23</span>:                 &#125;</div><div class="line"> <span class="number">24</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">25</span>:                 <span class="comment">// Just refresh mapping to reflect any DNS/Property change</span></div><div class="line"> <span class="number">26</span>:                 instanceRegionChecker.getAzToRegionMapper().refreshMapping();</div><div class="line"> <span class="number">27</span>:             &#125;</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         <span class="keyword">boolean</span> success = fetchRegistry(remoteRegionsModified);</div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> (success) &#123;</div><div class="line"> <span class="number">32</span>:             <span class="comment">// è®¾ç½® æ³¨å†Œä¿¡æ¯çš„åº”ç”¨å®ä¾‹æ•°</span></div><div class="line"> <span class="number">33</span>:             registrySize = localRegionApps.get().size();</div><div class="line"> <span class="number">34</span>:             <span class="comment">// è®¾ç½® æœ€åè·å–æ³¨å†Œä¿¡æ¯æ—¶é—´</span></div><div class="line"> <span class="number">35</span>:             lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">36</span>:         &#125;</div><div class="line"> <span class="number">37</span>: </div><div class="line"> <span class="number">38</span>:         <span class="comment">// æ‰“å°æ—¥å¿—</span></div><div class="line"> <span class="number">39</span>:         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"> <span class="number">40</span>:             StringBuilder allAppsHashCodes = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">41</span>:             allAppsHashCodes.append(<span class="string">"Local region apps hashcode: "</span>);</div><div class="line"> <span class="number">42</span>:             allAppsHashCodes.append(localRegionApps.get().getAppsHashCode());</div><div class="line"> <span class="number">43</span>:             allAppsHashCodes.append(<span class="string">", is fetching remote regions? "</span>);</div><div class="line"> <span class="number">44</span>:             allAppsHashCodes.append(isFetchingRemoteRegionRegistries);</div><div class="line"> <span class="number">45</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, Applications&gt; entry : remoteRegionVsApps.entrySet()) &#123;</div><div class="line"> <span class="number">46</span>:                 allAppsHashCodes.append(<span class="string">", Remote region: "</span>);</div><div class="line"> <span class="number">47</span>:                 allAppsHashCodes.append(entry.getKey());</div><div class="line"> <span class="number">48</span>:                 allAppsHashCodes.append(<span class="string">" , apps hashcode: "</span>);</div><div class="line"> <span class="number">49</span>:                 allAppsHashCodes.append(entry.getValue().getAppsHashCode());</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:             logger.debug(<span class="string">"Completed cache refresh task for discovery. All Apps hash code is &#123;&#125; "</span>,</div><div class="line"> <span class="number">52</span>:                     allAppsHashCodes.toString());</div><div class="line"> <span class="number">53</span>:         &#125;</div><div class="line"> <span class="number">54</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">55</span>:         logger.error(<span class="string">"Cannot fetch registry from server"</span>, e);</div><div class="line"> <span class="number">56</span>:     &#125;        </div><div class="line"> <span class="number">57</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 28 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 30 è¡Œ ï¼šè°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ï¼Œåœ¨ <a href="#">ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 31 è‡³ 36 è¡Œ ï¼šè·å–æ³¨å†Œä¿¡æ¯æˆåŠŸï¼Œè®¾ç½®æ³¨å†Œä¿¡æ¯çš„åº”ç”¨å®ä¾‹æ•°ï¼Œæœ€åè·å–æ³¨å†Œä¿¡æ¯æ—¶é—´ã€‚å˜é‡ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ³¨å†Œä¿¡æ¯çš„åº”ç”¨å®ä¾‹æ•°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> registrySize = <span class="number">0</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulRegistryFetchTimestamp = -<span class="number">1</span>;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 38 è‡³ 53 è¡Œ ï¼šæ‰“å°è°ƒè¯•æ—¥å¿—ã€‚</p></li><li><p>ç¬¬ 54 è‡³ 56 è¡Œ ï¼šæ‰“å°<strong>å¼‚å¸¸</strong>æ—¥å¿—ã€‚</p></li></ul><h2>2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯</h2><p>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯( æ ¹æ®æ¡ä»¶åˆ¤æ–­ï¼Œå¯èƒ½æ˜¯<strong>å…¨é‡</strong>ï¼Œä¹Ÿå¯èƒ½æ˜¯<strong>å¢é‡</strong> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     Stopwatch tracer = FETCH_REGISTRY_TIMER.start();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:         <span class="comment">// è·å– æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹é›†åˆ</span></div><div class="line"> <span class="number">6</span>:         <span class="comment">// If the delta is disabled or if it is the first time, get all</span></div><div class="line"> <span class="number">7</span>:         <span class="comment">// applications</span></div><div class="line"> <span class="number">8</span>:         Applications applications = getApplications();</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:         <span class="comment">// å…¨é‡è·å–</span></div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (clientConfig.shouldDisableDelta() <span class="comment">// ç¦ç”¨å¢é‡è·å–</span></div><div class="line"><span class="number">12</span>:                 || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</div><div class="line"><span class="number">13</span>:                 || forceFullRegistryFetch</div><div class="line"><span class="number">14</span>:                 || (applications == <span class="keyword">null</span>) <span class="comment">// ç©º</span></div><div class="line"><span class="number">15</span>:                 || (applications.getRegisteredApplications().size() == <span class="number">0</span>) <span class="comment">// ç©º</span></div><div class="line"><span class="number">16</span>:                 || (applications.getVersion() == -<span class="number">1</span>)) <span class="comment">//Client application does not have latest library supporting delta</span></div><div class="line"><span class="number">17</span>:         &#123;</div><div class="line"><span class="number">18</span>:             logger.info(<span class="string">"Disable delta property : &#123;&#125;"</span>, clientConfig.shouldDisableDelta());</div><div class="line"><span class="number">19</span>:             logger.info(<span class="string">"Single vip registry refresh property : &#123;&#125;"</span>, clientConfig.getRegistryRefreshSingleVipAddress());</div><div class="line"><span class="number">20</span>:             logger.info(<span class="string">"Force full registry fetch : &#123;&#125;"</span>, forceFullRegistryFetch);</div><div class="line"><span class="number">21</span>:             logger.info(<span class="string">"Application is null : &#123;&#125;"</span>, (applications == <span class="keyword">null</span>));</div><div class="line"><span class="number">22</span>:             logger.info(<span class="string">"Registered Applications size is zero : &#123;&#125;"</span>,</div><div class="line"><span class="number">23</span>:                     (applications.getRegisteredApplications().size() == <span class="number">0</span>));</div><div class="line"><span class="number">24</span>:             logger.info(<span class="string">"Application version is -1: &#123;&#125;"</span>, (applications.getVersion() == -<span class="number">1</span>));</div><div class="line"><span class="number">25</span>:             <span class="comment">// æ‰§è¡Œ å…¨é‡è·å–</span></div><div class="line"><span class="number">26</span>:             getAndStoreFullRegistry();</div><div class="line"><span class="number">27</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">28</span>:             <span class="comment">// æ‰§è¡Œ å¢é‡è·å–</span></div><div class="line"><span class="number">29</span>:             getAndUpdateDelta(applications);</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:         <span class="comment">// è®¾ç½® åº”ç”¨é›†åˆ hashcode</span></div><div class="line"><span class="number">32</span>:         applications.setAppsHashCode(applications.getReconcileHashCode());</div><div class="line"><span class="number">33</span>:         <span class="comment">// æ‰“å° æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•°é‡</span></div><div class="line"><span class="number">34</span>:         logTotalInstances();</div><div class="line"><span class="number">35</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">36</span>:         logger.error(PREFIX + appPathIdentifier + <span class="string">" - was unable to refresh its cache! status = "</span> + e.getMessage(), e);</div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">38</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">40</span>:             tracer.stop();</div><div class="line"><span class="number">41</span>:         &#125;</div><div class="line"><span class="number">42</span>:     &#125;</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>:     <span class="comment">// Notify about cache refresh before updating the instance remote status</span></div><div class="line"><span class="number">45</span>:     onCacheRefreshed();</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="comment">// Update remote status based on refreshed data held in the cache</span></div><div class="line"><span class="number">48</span>:     updateInstanceRemoteStatus();</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>:     <span class="comment">// registry was fetched successfully, so return true</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">52</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è‡³ 8 è¡Œ ï¼šè·å–æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> localRegionApps.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 10 è‡³ 26 è¡Œ ï¼š<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ã€‚</p><ul><li>ç¬¬ 11 è¡Œ ï¼šé…ç½® <code>eureka.disableDelta = true</code> ï¼Œç¦ç”¨<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ã€‚é»˜è®¤å€¼ï¼š<code>false</code> ã€‚</li><li>ç¬¬ 12 è¡Œ ï¼šTODO[0010]ï¼šgetRegistryRefreshSingleVipAddress</li><li>ç¬¬ 13 è¡Œ ï¼šæ–¹æ³•å‚æ•° <code>forceFullRegistryFetch</code> å¼ºåˆ¶<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ã€‚</li><li>ç¬¬ 14 è‡³ 15 è¡Œ ï¼šæœ¬åœ°ç¼“å­˜ä¸ºç©ºã€‚</li><li>ç¬¬ 25 è‡³ 26 è¡Œ ï¼šè°ƒç”¨ <code>#getAndStoreFullRegistry()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚ä¸‹æ–‡è¯¦ç»†è§£æã€‚</li></ul></li><li><p>ç¬¬ 27 è‡³ 30 è¡Œ ï¼š<strong>å¢é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶åˆ·æ–°æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 31 è‡³ 32 è¡Œ ï¼šè®¡ç®—åº”ç”¨é›†åˆ <code>hashcode</code> ã€‚è¯¥å˜é‡ç”¨äºæ ¡éªŒ<strong>å¢é‡</strong>è·å–çš„æ³¨å†Œä¿¡æ¯å’Œ Eureka-Server <strong>å…¨é‡</strong>çš„æ³¨å†Œä¿¡æ¯æ˜¯å¦ä¸€è‡´( å®Œæ•´ )ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 33 è‡³ 34 è¡Œ ï¼šæ‰“å°è°ƒè¯•æ—¥å¿—ï¼Œè¾“å‡ºæœ¬åœ°ç¼“å­˜çš„æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•°é‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logTotalInstances</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">       <span class="keyword">int</span> totInstances = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (Application application : getApplications().getRegisteredApplications()) &#123;</div><div class="line">           totInstances += application.getInstancesAsIsFromEureka().size();</div><div class="line">       &#125;</div><div class="line">       logger.debug(<span class="string">"The total number of all instances in the client now is &#123;&#125;"</span>, totInstances);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 44 è‡³ 45 è¡Œ ï¼šè§¦å‘ CacheRefreshedEvent äº‹ä»¶ï¼Œäº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œã€‚ç›®å‰ Eureka æœªæä¾›é»˜è®¤çš„è¯¥äº‹ä»¶ç›‘å¬å™¨ã€‚</p><ul><li><p><code>#onCacheRefreshed()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Eureka äº‹ä»¶ç›‘å¬å™¨</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;EurekaEventListener&gt; eventListeners = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCacheRefreshed</span><span class="params">()</span> </span>&#123;</div><div class="line">    fireEvent(<span class="keyword">new</span> CacheRefreshedEvent());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(<span class="keyword">final</span> EurekaEvent event)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (EurekaEventListener listener : eventListeners) &#123;</div><div class="line">        listener.onEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p><strong>ç¬”è€…çš„YY</strong> ï¼šä½ å¯ä»¥å®ç°è‡ªå®šä¹‰çš„äº‹ä»¶ç›‘å¬å™¨ç›‘å¬ CacheRefreshedEvent äº‹ä»¶ï¼Œä»¥è¾¾åˆ°<strong>æŒä¹…åŒ–</strong>æœ€æ–°çš„æ³¨å†Œä¿¡æ¯åˆ°å­˜å‚¨å™¨( ä¾‹å¦‚ï¼Œæœ¬åœ°æ–‡ä»¶ )ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œé…åˆå®ç° BackupRegistry æ¥å£è¯»å–å­˜å‚¨å™¨ã€‚BackupRegistry æ¥å£è°ƒç”¨å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ã€3.2.12ã€‘ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">    fetchRegistryFromBackup();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li><li><p>ç¬¬47 è‡³ 48 è¡Œ ï¼šæ›´æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>çš„å½“å‰åº”ç”¨å®ä¾‹åœ¨ Eureka-Server çš„çŠ¶æ€ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceInfo.InstanceStatus lastRemoteInstanceStatus = InstanceInfo.InstanceStatus.UNKNOWN; </div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateInstanceRemoteStatus</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="comment">// Determine this instance's status for this app and set to UNKNOWN if not found</span></div><div class="line"> <span class="number">5</span>:     InstanceInfo.InstanceStatus currentRemoteInstanceStatus = <span class="keyword">null</span>;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (instanceInfo.getAppName() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>:         Application app = getApplication(instanceInfo.getAppName());</div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:             InstanceInfo remoteInstanceInfo = app.getByInstanceId(instanceInfo.getId());</div><div class="line"><span class="number">10</span>:             <span class="keyword">if</span> (remoteInstanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">11</span>:                 currentRemoteInstanceStatus = remoteInstanceInfo.getStatus();</div><div class="line"><span class="number">12</span>:             &#125;</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (currentRemoteInstanceStatus == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:         currentRemoteInstanceStatus = InstanceInfo.InstanceStatus.UNKNOWN;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// Notify if status changed</span></div><div class="line"><span class="number">20</span>:     <span class="keyword">if</span> (lastRemoteInstanceStatus != currentRemoteInstanceStatus) &#123;</div><div class="line"><span class="number">21</span>:         onRemoteStatusChanged(lastRemoteInstanceStatus, currentRemoteInstanceStatus);</div><div class="line"><span class="number">22</span>:         lastRemoteInstanceStatus = currentRemoteInstanceStatus;</div><div class="line"><span class="number">23</span>:     &#125;</div><div class="line"><span class="number">24</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è‡³ 14 è¡Œ ï¼šä»æ³¨å†Œä¿¡æ¯ä¸­è·å–å½“å‰åº”ç”¨åœ¨ Eureka-Server çš„çŠ¶æ€ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šå¯¹æ¯”<strong>æœ¬åœ°ç¼“å­˜</strong>å’Œ<strong>æœ€æ–°çš„</strong>çš„å½“å‰åº”ç”¨å®ä¾‹åœ¨ Eureka-Server çš„çŠ¶æ€ï¼Œè‹¥ä¸åŒï¼Œæ›´æ–°<strong>æœ¬åœ°ç¼“å­˜</strong>( <strong>æ³¨æ„ï¼Œåªæ›´æ–°è¯¥ç¼“å­˜å˜é‡ï¼Œä¸æ›´æ–°æœ¬åœ°å½“å‰åº”ç”¨å®ä¾‹çš„çŠ¶æ€( <code>instanceInfo.status</code> )</strong> )ï¼Œè§¦å‘ StatusChangeEvent äº‹ä»¶ï¼Œäº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œã€‚ç›®å‰ Eureka æœªæä¾›é»˜è®¤çš„è¯¥äº‹ä»¶ç›‘å¬å™¨ã€‚<code>#onRemoteStatusChanged(...)</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRemoteStatusChanged</span><span class="params">(InstanceInfo.InstanceStatus oldStatus, InstanceInfo.InstanceStatus newStatus)</span> </span>&#123;</div><div class="line">   fireEvent(<span class="keyword">new</span> StatusChangeEvent(oldStatus, newStatus));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>TODO[0024] ï¼šclientå’Œserverä¸åŒçŠ¶æ€çš„åŸå› </p></li></ul></li></ul><h3>2.4.1 å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜</h3><p>è°ƒç”¨ <code>#getAndStoreFullRegistry()</code> æ–¹æ³•ï¼Œ<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚ä¸‹å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndStoreFullRegistry</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     logger.info(<span class="string">"Getting all instance registry info from the eureka server"</span>);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// å…¨é‡è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"> <span class="number">7</span>:     Applications apps = <span class="keyword">null</span>;</div><div class="line"> <span class="number">8</span>:     EurekaHttpResponse&lt;Applications&gt; httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></div><div class="line"> <span class="number">9</span>:             ? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get())</div><div class="line"><span class="number">10</span>:             : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</div><div class="line"><span class="number">12</span>:         apps = httpResponse.getEntity();</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>:     logger.info(<span class="string">"The response status is &#123;&#125;"</span>, httpResponse.getStatusCode());</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:     <span class="comment">// è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">if</span> (apps == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:         logger.error(<span class="string">"The application is null for some reason. Not storing this information"</span>);</div><div class="line"><span class="number">19</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</div><div class="line"><span class="number">20</span>:         localRegionApps.set(<span class="keyword">this</span>.filterAndShuffle(apps));</div><div class="line"><span class="number">21</span>:         logger.debug(<span class="string">"Got full registry with apps hashcode &#123;&#125;"</span>, apps.getAppsHashCode());</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">23</span>:         logger.warn(<span class="string">"Not updating applications as another thread is updating it already"</span>);</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 14 è¡Œ ï¼š<strong>å…¨é‡</strong>è·å–æ³¨å†Œä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Applications&gt; <span class="title">getApplications</span><span class="params">(String... regions)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> getApplicationsInternal(<span class="string">"apps/"</span>, regions);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> EurekaHttpResponse&lt;Applications&gt; <span class="title">getApplicationsInternal</span><span class="params">(String urlPath, String[] regions)</span> </span>&#123;</div><div class="line">   ClientResponse response = <span class="keyword">null</span>;</div><div class="line">   String regionsParamValue = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       WebResource webResource = jerseyClient.resource(serviceUrl).path(urlPath);</div><div class="line">       <span class="keyword">if</span> (regions != <span class="keyword">null</span> &amp;&amp; regions.length &gt; <span class="number">0</span>) &#123;</div><div class="line">           regionsParamValue = StringUtil.join(regions);</div><div class="line">           webResource = webResource.queryParam(<span class="string">"regions"</span>, regionsParamValue);</div><div class="line">       &#125;</div><div class="line">       Builder requestBuilder = webResource.getRequestBuilder();</div><div class="line">       addExtraHeaders(requestBuilder);</div><div class="line">       response = requestBuilder.accept(MediaType.APPLICATION_JSON_TYPE).get(ClientResponse.class); <span class="comment">// JSON</span></div><div class="line"></div><div class="line">       Applications applications = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (response.getStatus() == Status.OK.getStatusCode() &amp;&amp; response.hasEntity()) &#123;</div><div class="line">           applications = response.getEntity(Applications.class);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus(), Applications.class)</div><div class="line">               .headers(headersOf(response))</div><div class="line">               .entity(applications)</div><div class="line">               .build();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Jersey HTTP GET &#123;&#125;/&#123;&#125;?&#123;&#125;; statusCode=&#123;&#125;"</span>,</div><div class="line">                   serviceUrl, urlPath,</div><div class="line">                   regionsParamValue == <span class="keyword">null</span> ? <span class="string">""</span> : <span class="string">"regions="</span> + regionsParamValue,</div><div class="line">                   response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus()</div><div class="line">           );</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">           response.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#getApplications(...)</code> æ–¹æ³•ï¼ŒGET è¯·æ±‚ Eureka-Server çš„ <code>apps/</code> æ¥å£ï¼Œå‚æ•°ä¸º <code>regions</code> ï¼Œè¿”å›æ ¼å¼ä¸º JSON ï¼Œå®ç°<strong>å…¨é‡è·å–æ³¨å†Œä¿¡æ¯</strong>ã€‚</li></ul></li><li><p>ç¬¬ 16 è‡³ 24 è¡Œ ï¼šè®¾ç½®åˆ°æœ¬åœ°æ³¨å†Œä¿¡æ¯<strong>ç¼“å­˜</strong>ã€‚</p><ul><li>ç¬¬ 19 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</li><li>ç¬¬ 20 è¡Œ ï¼šè°ƒç”¨ <code>#filterAndShuffle(...)</code> æ–¹æ³•ï¼Œæ ¹æ®é…ç½® <code>eureka.shouldFilterOnlyUpInstances = true</code> ( é»˜è®¤å€¼ ï¼š<code>true</code> ) è¿‡æ»¤åªä¿ç•™çŠ¶æ€ä¸ºå¼€å¯( UP )çš„åº”ç”¨å®ä¾‹ï¼Œå¹¶<strong>éšæœºæ‰“ä¹±</strong>åº”ç”¨å®ä¾‹é¡ºåºã€‚æ‰“ä¹±åï¼Œå®ç°è°ƒç”¨åº”ç”¨æœåŠ¡çš„éšæœºæ€§ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/DiscoveryClient.java#L1603" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹æ–¹æ³•å®ç°ã€‚</li></ul></li></ul><h1>3. Eureka-Server æ¥æ”¶å…¨é‡è·å–</h1><h2>3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚</h2><p><code>com.netflix.eureka.resources.ApplicationsResource</code>ï¼Œå¤„ç†<strong>æ‰€æœ‰</strong>åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>æ¥æ”¶å…¨é‡è·å–è¯·æ±‚ï¼Œæ˜ å°„ <code>ApplicationsResource#getContainers()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@GET</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">getContainers</span><span class="params">(@PathParam(<span class="string">"version"</span>)</span> String version,</span></div><div class="line"><span class="function"> 3:                               @<span class="title">HeaderParam</span><span class="params">(HEADER_ACCEPT)</span> String acceptHeader,</span></div><div class="line"><span class="function"> 4:                               @<span class="title">HeaderParam</span><span class="params">(HEADER_ACCEPT_ENCODING)</span> String acceptEncoding,</span></div><div class="line"><span class="function"> 5:                               @<span class="title">HeaderParam</span><span class="params">(EurekaAccept.HTTP_X_EUREKA_ACCEPT)</span> String eurekaAccept,</span></div><div class="line"><span class="function"> 6:                               @Context UriInfo uriInfo,</span></div><div class="line"><span class="function"> 7:                               @Nullable @<span class="title">QueryParam</span><span class="params">(<span class="string">"regions"</span>)</span> String regionsStr) </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">boolean</span> isRemoteRegionRequested = <span class="keyword">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();</div><div class="line"><span class="number">10</span>:     String[] regions = <span class="keyword">null</span>;</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (!isRemoteRegionRequested) &#123;</div><div class="line"><span class="number">12</span>:         EurekaMonitors.GET_ALL.increment();</div><div class="line"><span class="number">13</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">14</span>:         regions = regionsStr.toLowerCase().split(<span class="string">","</span>);</div><div class="line"><span class="number">15</span>:         Arrays.sort(regions); <span class="comment">// So we don't have different caches for same regions queried in different order.</span></div><div class="line"><span class="number">16</span>:         EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// Check if the server allows the access to the registry. The server can</span></div><div class="line"><span class="number">21</span>:     <span class="comment">// restrict access if it is not</span></div><div class="line"><span class="number">22</span>:     <span class="comment">// ready to serve traffic depending on various reasons.</span></div><div class="line"><span class="number">23</span>:     <span class="keyword">if</span> (!registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</div><div class="line"><span class="number">24</span>:         <span class="keyword">return</span> Response.status(Status.FORBIDDEN).build();</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:     <span class="comment">// API ç‰ˆæœ¬</span></div><div class="line"><span class="number">28</span>:     CurrentRequestVersion.set(Version.toEnum(version));</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:     <span class="comment">// è¿”å›æ•°æ®æ ¼å¼</span></div><div class="line"><span class="number">31</span>:     KeyType keyType = Key.KeyType.JSON;</div><div class="line"><span class="number">32</span>:     String returnMediaType = MediaType.APPLICATION_JSON;</div><div class="line"><span class="number">33</span>:     <span class="keyword">if</span> (acceptHeader == <span class="keyword">null</span> || !acceptHeader.contains(HEADER_JSON_VALUE)) &#123;</div><div class="line"><span class="number">34</span>:         keyType = Key.KeyType.XML;</div><div class="line"><span class="number">35</span>:         returnMediaType = MediaType.APPLICATION_XML;</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="comment">// å“åº”ç¼“å­˜é”®( KEY )</span></div><div class="line"><span class="number">39</span>:     Key cacheKey = <span class="keyword">new</span> Key(Key.EntityType.Application,</div><div class="line"><span class="number">40</span>:             ResponseCacheImpl.ALL_APPS,</div><div class="line"><span class="number">41</span>:             keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions</div><div class="line"><span class="number">42</span>:     );</div><div class="line"><span class="number">43</span>: </div><div class="line"><span class="number">44</span>:     <span class="comment">//</span></div><div class="line"><span class="number">45</span>:     Response response;</div><div class="line"><span class="number">46</span>:     <span class="keyword">if</span> (acceptEncoding != <span class="keyword">null</span> &amp;&amp; acceptEncoding.contains(HEADER_GZIP_VALUE)) &#123;</div><div class="line"><span class="number">47</span>:         response = Response.ok(responseCache.getGZIP(cacheKey))</div><div class="line"><span class="number">48</span>:                 .header(HEADER_CONTENT_ENCODING, HEADER_GZIP_VALUE)</div><div class="line"><span class="number">49</span>:                 .header(HEADER_CONTENT_TYPE, returnMediaType)</div><div class="line"><span class="number">50</span>:                 .build();</div><div class="line"><span class="number">51</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">52</span>:         response = Response.ok(responseCache.get(cacheKey))</div><div class="line"><span class="number">53</span>:                 .build();</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">56</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 8 è‡³ 17 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 19 è‡³ 25 è¡Œ ï¼šEureka-Server å¯åŠ¨å®Œæˆï¼Œä½†æ˜¯æœªå¤„äºå°±ç»ª( Ready )çŠ¶æ€ï¼Œä¸æ¥å—è¯·æ±‚å…¨é‡åº”ç”¨æ³¨å†Œä¿¡æ¯çš„è¯·æ±‚ï¼Œä¾‹å¦‚ï¼ŒEureka-Server å¯åŠ¨æ—¶ï¼Œæœªèƒ½ä»å…¶ä»– Eureka-Server é›†ç¾¤çš„èŠ‚ç‚¹è·å–åˆ°åº”ç”¨æ³¨å†Œä¿¡æ¯ã€‚</p></li><li><p>ç¬¬ 27 è‡³ 28 è¡Œ ï¼šè®¾ç½® API ç‰ˆæœ¬å·ã€‚<strong>é»˜è®¤</strong>æœ€æ–° API ç‰ˆæœ¬ä¸º V2ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Version &#123;</div><div class="line">    V1, V2;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Version <span class="title">toEnum</span><span class="params">(String v)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Version version : Version.values()) &#123;</div><div class="line">            <span class="keyword">if</span> (version.name().equalsIgnoreCase(v)) &#123;</div><div class="line">                <span class="keyword">return</span> version;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//Defaults to v2</span></div><div class="line">        <span class="keyword">return</span> V2;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 30 è‡³ 36 è¡Œ ï¼šè®¾ç½®è¿”å›æ•°æ®æ ¼å¼ï¼Œé»˜è®¤ JSON ã€‚</p></li><li><p>ç¬¬ 38 è‡³ 42 è¡Œ ï¼šåˆ›å»ºå“åº”ç¼“å­˜( ResponseCache ) çš„é”®( KEY )ï¼Œåœ¨ <a href="#">ã€Œ3.2.1 ç¼“å­˜é”®ã€</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 44 è‡³ 55 è¡Œ ï¼šä»å“åº”ç¼“å­˜è¯»å–<strong>å…¨é‡</strong>æ³¨å†Œä¿¡æ¯ï¼Œåœ¨ <a href="#">ã€Œ3.3 ç¼“å­˜è¯»å–ã€</a>è¯¦ç»†è§£æã€‚</p></li></ul><h2>3.2 å“åº”ç¼“å­˜ ResponseCache</h2><p><code>com.netflix.eureka.registry.ResponseCache</code>ï¼Œå“åº”ç¼“å­˜<strong>æ¥å£</strong>ï¼Œæ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResponseCache</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">get</span><span class="params">(Key key)</span></span>;</div><div class="line">    </div><div class="line">    <span class="keyword">byte</span>[] getGZIP(Key key);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">AtomicLong <span class="title">getVersionDelta</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">AtomicLong <span class="title">getVersionDeltaWithRegions</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>å…¶ä¸­ï¼Œ<code>#getVersionDelta()</code> å’Œ <code>#getVersionDeltaWithRegions()</code> å·²ç»åºŸå¼ƒã€‚è¿™é‡Œä¿ç•™çš„åŸå› ä¸»è¦æ˜¯è€ƒè™‘å…¼å®¹æ€§ã€‚åˆ¤æ–­ä¾æ®æ¥è‡ªå¦‚ä¸‹ä»£ç ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Applications.java</span></div><div class="line"><span class="meta">@Deprecated</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVersion</span><span class="params">(Long version)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.versionDelta = version;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationDeltas</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ— å…³ä»£ç </span></div><div class="line">    apps.setVersion(responseCache.getVersionDelta().get()); <span class="comment">// å”¯ä¸€è°ƒç”¨åˆ° ResponseCache#getVersionDelta() æ–¹æ³•çš„åœ°æ–¹</span></div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>#get()</code> ï¼šè·å¾—ç¼“å­˜ã€‚</p></li><li><p><code>#getGZIP()</code> ï¼šè·å¾—ç¼“å­˜ï¼Œå¹¶ GZIP ã€‚</p></li><li><p><code>#invalidate()</code> ï¼šè¿‡æœŸç¼“å­˜ã€‚</p></li></ul><h3>3.2.1 ç¼“å­˜é”®</h3><p><code>com.netflix.eureka.registry.Key</code>ï¼Œç¼“å­˜é”®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Key</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> KeyType &#123;</div><div class="line">        JSON, XML</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * An enum to define the entity that is stored in this cache for this key.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> EntityType &#123;</div><div class="line">        Application, VIP, SVIP</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®ä½“å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String entityName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] regions;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚å‚æ•°ç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KeyType requestType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚ API ç‰ˆæœ¬å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Version requestVersion;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * hashKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String hashKey;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®ä½“ç±»å‹</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EntityType&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EntityType entityType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EurekaAccept&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaAccept eurekaAccept;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">(EntityType entityType, String entityName, KeyType type, Version v, EurekaAccept eurekaAccept, @Nullable String[] regions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regions = regions;</div><div class="line">        <span class="keyword">this</span>.entityType = entityType;</div><div class="line">        <span class="keyword">this</span>.entityName = entityName;</div><div class="line">        <span class="keyword">this</span>.requestType = type;</div><div class="line">        <span class="keyword">this</span>.requestVersion = v;</div><div class="line">        <span class="keyword">this</span>.eurekaAccept = eurekaAccept;</div><div class="line">        hashKey = <span class="keyword">this</span>.entityType + <span class="keyword">this</span>.entityName + (<span class="keyword">null</span> != <span class="keyword">this</span>.regions ? Arrays.toString(<span class="keyword">this</span>.regions) : <span class="string">""</span>)</div><div class="line">                + requestType.name() + requestVersion.name() + <span class="keyword">this</span>.eurekaAccept.name();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">(EntityType entityType, String entityName, KeyType type, Version v, EurekaAccept eurekaAccept, @Nullable String[] regions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regions = regions;</div><div class="line">        <span class="keyword">this</span>.entityType = entityType;</div><div class="line">        <span class="keyword">this</span>.entityName = entityName;</div><div class="line">        <span class="keyword">this</span>.requestType = type;</div><div class="line">        <span class="keyword">this</span>.requestVersion = v;</div><div class="line">        <span class="keyword">this</span>.eurekaAccept = eurekaAccept;</div><div class="line">        hashKey = <span class="keyword">this</span>.entityType + <span class="keyword">this</span>.entityName + (<span class="keyword">null</span> != <span class="keyword">this</span>.regions ? Arrays.toString(<span class="keyword">this</span>.regions) : <span class="string">""</span>)</div><div class="line">                + requestType.name() + requestVersion.name() + <span class="keyword">this</span>.eurekaAccept.name();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        String hashKey = getHashKey();</div><div class="line">        <span class="keyword">return</span> hashKey.hashCode();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (other <span class="keyword">instanceof</span> Key) &#123;</div><div class="line">            <span class="keyword">return</span> getHashKey().equals(((Key) other).getHashKey());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.2 å“åº”ç¼“å­˜å®ç°ç±»</h3><p><code>com.netflix.eureka.registry.ResponseCacheImpl</code>ï¼Œå“åº”ç¼“å­˜å®ç°ç±»ã€‚</p><p>åœ¨ ResponseCacheImpl é‡Œï¼Œå°†ç¼“å­˜æ‹†åˆ†æˆä¸¤å±‚ ï¼š</p><ul><li><strong>åªè¯»ç¼“å­˜</strong>( <code>readOnlyCacheMap</code> )</li><li><strong>å›ºå®šè¿‡æœŸ</strong> + <strong>å›ºå®šå¤§å°</strong>çš„<strong>è¯»å†™ç¼“å­˜</strong>( <code>readWriteCacheMap</code> )</li></ul><p>é»˜è®¤é…ç½®ä¸‹ï¼Œ<strong>ç¼“å­˜è¯»å–ç­–ç•¥</strong>å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_29/04.png" alt=""></p><p><strong>ç¼“å­˜è¿‡æœŸç­–ç•¥</strong>å¦‚ä¸‹ï¼š</p><ul><li>åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€è¿‡æœŸæ—¶ï¼Œ<strong>åªåªåª</strong>è¿‡æœŸ <code>readWriteCacheMap</code> ã€‚</li><li><code>readWriteCacheMap</code> å†™å…¥ä¸€æ®µæ—¶é—´( å¯é…ç½® )åè‡ªåŠ¨è¿‡æœŸã€‚</li><li><strong>å®šæ—¶</strong>ä»»åŠ¡å¯¹æ¯” <code>readWriteCacheMap</code> å’Œ <code>readOnlyCacheMap</code> çš„ç¼“å­˜å€¼ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œä»¥å‰è€…ä¸ºä¸»ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®ç°äº† <code>readOnlyCacheMap</code> çš„å®šæ—¶è¿‡æœŸã€‚</li></ul><p><strong>æ³¨æ„</strong>ï¼šåº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€è¿‡æœŸæ—¶ï¼Œä¸ä¼šå¾ˆå¿«åˆ·æ–°åˆ° <code>readWriteCacheMap</code> ç¼“å­˜é‡Œã€‚é»˜è®¤é…ç½®ä¸‹ï¼Œæœ€å¤§å»¶è¿Ÿåœ¨ 30 ç§’ã€‚</p><p><strong>ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Ÿ</strong></p><p>åœ¨ <a href="https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86" rel="external nofollow noopener noreferrer" target="_blank">CAP</a> çš„é€‰æ‹©ä¸Šï¼ŒEureka é€‰æ‹©äº† AP ï¼Œä¸åŒäº Zookeeper é€‰æ‹©äº† CP ã€‚</p><p>æ¨èé˜…è¯»ï¼š</p><ul><li><a href="http://dockone.io/article/78" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸ºä»€ä¹ˆä¸åº”è¯¥ä½¿ç”¨ZooKeeperåšæœåŠ¡å‘ç°ã€‹</a></li><li><a href="http://blog.spring-cloud.io/blog/sc-eureka.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Netflix Eurekaæºç å¯¼è¯»ä¸åŸç†åˆ†æã€‹ã€Œ4. ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ŒEurekaæ¯”Zookeeperå¥½åœ¨å“ªé‡Œã€</a></li></ul><h2>3.3 ç¼“å­˜è¯»å–</h2><p>è°ƒç”¨ <code>ResponseCacheImpl#get(...)</code> æ–¹æ³•( <code>#getGzip(...)</code> ç±»ä¼¼ )ï¼Œè¯»å–ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Key, Value&gt; readOnlyCacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Key, Value&gt;();</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Key, Value&gt; readWriteCacheMap;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> Key key)</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">return</span> get(key, shouldUseReadOnlyResponseCache);</div><div class="line"> <span class="number">7</span>: &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="function">String <span class="title">get</span><span class="params">(<span class="keyword">final</span> Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:     Value payload = getValue(key, useReadOnlyCache);</div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (payload == <span class="keyword">null</span> || payload.getPayload().equals(EMPTY_PAYLOAD)) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">13</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">return</span> payload.getPayload();</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>: &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>: <span class="function">Value <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</div><div class="line"><span class="number">19</span>:     Value payload = <span class="keyword">null</span>;</div><div class="line"><span class="number">20</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:         <span class="keyword">if</span> (useReadOnlyCache) &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">final</span> Value currentPayload = readOnlyCacheMap.get(key);</div><div class="line"><span class="number">23</span>:             <span class="keyword">if</span> (currentPayload != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>:                 payload = currentPayload;</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">26</span>:                 payload = readWriteCacheMap.get(key);</div><div class="line"><span class="number">27</span>:                 readOnlyCacheMap.put(key, payload);</div><div class="line"><span class="number">28</span>:             &#125;</div><div class="line"><span class="number">29</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">30</span>:             payload = readWriteCacheMap.get(key);</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">33</span>:         logger.error(<span class="string">"Cannot get value for key :"</span> + key, t);</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> payload;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 5 è‡³ 7 è¡Œ ï¼šè°ƒç”¨ <code>#get(key, useReadOnlyCache)</code> æ–¹æ³•ï¼Œè¯»å–ç¼“å­˜ã€‚å…¶ä¸­ <code>shouldUseReadOnlyResponseCache</code> é€šè¿‡é…ç½® <code>eureka.shouldUseReadOnlyResponseCache = true</code> (é»˜è®¤å€¼ ï¼š<code>true</code> ) å¼€å¯åªè¯»ç¼“å­˜ã€‚å¦‚æœä½ å¯¹æ•°æ®çš„ä¸€è‡´æ€§æœ‰ç›¸å¯¹é«˜çš„è¦æ±‚ï¼Œå¯ä»¥å…³é—­è¿™ä¸ªå¼€å…³ï¼Œå½“ç„¶å› ä¸ºå°‘äº† <code>readOnlyCacheMap</code> ï¼Œæ€§èƒ½ä¼šæœ‰ä¸€å®šçš„ä¸‹é™ã€‚</p></li><li><p>ç¬¬ 9 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>getValue(key, useReadOnlyCache)</code> æ–¹æ³•ï¼Œè¯»å–ç¼“å­˜ã€‚ä» <code>readOnlyCacheMap</code> å’Œ <code>readWriteCacheMap</code> å˜é‡å¯ä»¥çœ‹åˆ°ç¼“å­˜å€¼çš„ç±»ä¸º <code>com.netflix.eureka.registry.ResponseCacheImpl.Value</code> ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Value</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * åŸå§‹å€¼</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String payload;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * GZIP å‹ç¼©åçš„å€¼</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] gzipped;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Value</span><span class="params">(String payload)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.payload = payload;</div><div class="line">       <span class="keyword">if</span> (!EMPTY_PAYLOAD.equals(payload)) &#123;</div><div class="line">           <span class="comment">// ... çœç•¥ GZIP å‹ç¼©ä»£ç </span></div><div class="line">           gzipped = bos.toByteArray();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           gzipped = <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getPayload</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> payload;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="keyword">byte</span>[] getGzipped() &#123;</div><div class="line">       <span class="keyword">return</span> gzipped;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 21 è‡³ 31 è¡Œ ï¼šè¯»å–ç¼“å­˜ã€‚</p><ul><li><p>ç¬¬ 21 è‡³ 28 è¡Œ ï¼šå…ˆè¯»å– <code>readOnlyCacheMap</code> ã€‚è¯»å–ä¸åˆ°ï¼Œè¯»å– <code>readWriteCacheMap</code> ï¼Œå¹¶è®¾ç½®åˆ° <code>readOnlyCacheMap</code> ã€‚</p></li><li><p>ç¬¬ 29 è‡³ 31 è¡Œ ï¼šè¯»å– <code>readWriteCacheMap</code> ã€‚</p></li><li><p><code>readWriteCacheMap</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.readWriteCacheMap =</div><div class="line">      CacheBuilder.newBuilder().initialCapacity(<span class="number">1000</span>)</div><div class="line">              .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)</div><div class="line">              .removalListener(<span class="keyword">new</span> RemovalListener&lt;Key, Value&gt;() &#123;</div><div class="line">                  <span class="meta">@Override</span></div><div class="line">                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Key, Value&gt; notification)</span> </span>&#123;</div><div class="line">                      <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">                      Key removedKey = notification.getKey();</div><div class="line">                      <span class="keyword">if</span> (removedKey.hasRegions()) &#123;</div><div class="line">                          Key cloneWithNoRegions = removedKey.cloneWithoutRegions();</div><div class="line">                          regionSpecificKeys.remove(cloneWithNoRegions, removedKey);</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;)</div><div class="line">              .build(<span class="keyword">new</span> CacheLoader&lt;Key, Value&gt;() &#123;</div><div class="line">                  <span class="meta">@Override</span></div><div class="line">                  <span class="function"><span class="keyword">public</span> Value <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                      <span class="comment">// // TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">                      <span class="keyword">if</span> (key.hasRegions()) &#123;</div><div class="line">                          Key cloneWithNoRegions = key.cloneWithoutRegions();</div><div class="line">                          regionSpecificKeys.put(cloneWithNoRegions, key);</div><div class="line">                      &#125;</div><div class="line">                      Value value = generatePayload(key);</div><div class="line">                      <span class="keyword">return</span> value;</div><div class="line">                  &#125;</div><div class="line">              &#125;);</div></pre></td></tr></table></figure></p><ul><li><code>readWriteCacheMap</code> æœ€å¤§ç¼“å­˜æ•°é‡ä¸º 1000 ã€‚</li><li>è°ƒç”¨ <code>#generatePayload(key)</code> æ–¹æ³•ï¼Œç”Ÿæˆç¼“å­˜å€¼ã€‚</li></ul></li></ul></li><li><p><code>#generatePayload(key)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Value <span class="title">generatePayload</span><span class="params">(Key key)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     Stopwatch tracer = <span class="keyword">null</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         String payload;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">switch</span> (key.getEntityType()) &#123;</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> Application:</div><div class="line"> <span class="number">7</span>:                 <span class="keyword">boolean</span> isRemoteRegionRequested = key.hasRegions();</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (ALL_APPS.equals(key.getName())) &#123;</div><div class="line"><span class="number">10</span>:                     <span class="keyword">if</span> (isRemoteRegionRequested) &#123; <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="number">11</span>:                         tracer = serializeAllAppsWithRemoteRegionTimer.start();</div><div class="line"><span class="number">12</span>:                         payload = getPayLoad(key, registry.getApplicationsFromMultipleRegions(key.getRegions()));</div><div class="line"><span class="number">13</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">14</span>:                         tracer = serializeAllAppsTimer.start();</div><div class="line"><span class="number">15</span>:                         payload = getPayLoad(key, registry.getApplications());</div><div class="line"><span class="number">16</span>:                     &#125;</div><div class="line"><span class="number">17</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ALL_APPS_DELTA.equals(key.getName())) &#123;</div><div class="line"><span class="number">18</span>:                     <span class="comment">// ... çœç•¥å¢é‡è·å–ç›¸å…³çš„ä»£ç </span></div><div class="line"><span class="number">19</span>:                  &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:                     tracer = serializeOneApptimer.start();</div><div class="line"><span class="number">21</span>:                     payload = getPayLoad(key, registry.getApplication(key.getName()));</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:             <span class="comment">// ... çœç•¥éƒ¨åˆ†ä»£ç  </span></div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">new</span> Value(payload);</div><div class="line"><span class="number">27</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             tracer.stop();</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 10 è‡³ 12 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 13 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>AbstractInstanceRegistry#getApplications()</code> æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€‚åè°ƒç”¨ <code>#getPayLoad()</code> æ–¹æ³•ï¼Œå°†æ³¨å†Œçš„åº”ç”¨é›†åˆè½¬æ¢æˆç¼“å­˜å€¼ã€‚ğŸ™‚ è¿™ä¸¤ä¸ªæ–¹æ³•ä»£ç è¾ƒå¤šï¼Œä¸‹é¢è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 17 è‡³ 18 è¡Œ ï¼šè·å–å¢é‡æ³¨å†Œä¿¡æ¯çš„ç¼“å­˜å€¼ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h3>3.3.1 è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆ</h3><p>è°ƒç”¨ <code>AbstractInstanceRegistry#getApplications()</code> æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] EMPTY_STR_ARRAY = <span class="keyword">new</span> String[<span class="number">0</span>];</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:    <span class="keyword">boolean</span> disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();</div><div class="line"> <span class="number">7</span>:    <span class="keyword">if</span> (disableTransparentFallback) &#123; <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">8</span>:        <span class="keyword">return</span> getApplicationsFromLocalRegionOnly();</div><div class="line"> <span class="number">9</span>:    &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:        <span class="keyword">return</span> getApplicationsFromAllRemoteRegions();  <span class="comment">// Behavior of falling back to remote region can be disabled.</span></div><div class="line"><span class="number">11</span>:    &#125;</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromLocalRegionOnly</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">15</span>:    <span class="keyword">return</span> getApplicationsFromMultipleRegions(EMPTY_STR_ARRAY);</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 6 è‡³ 8 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</p></li><li><p>ç¬¬ 9 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>#getApplicationsFromMultipleRegions(...)</code> æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromMultipleRegions</span><span class="params">(String[] remoteRegions)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">boolean</span> includeRemoteRegion = <span class="keyword">null</span> != remoteRegions &amp;&amp; remoteRegions.length != <span class="number">0</span>;</div><div class="line"> <span class="number">4</span>:     logger.debug(<span class="string">"Fetching applications registry with remote regions: &#123;&#125;, Regions argument &#123;&#125;"</span>,</div><div class="line"> <span class="number">5</span>:             includeRemoteRegion, Arrays.toString(remoteRegions));</div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (includeRemoteRegion) &#123;</div><div class="line"> <span class="number">7</span>:         GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS.increment();</div><div class="line"> <span class="number">8</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">9</span>:         GET_ALL_CACHE_MISS.increment();</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>:     <span class="comment">// è·å¾—è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆ</span></div><div class="line"><span class="number">12</span>:     Applications apps = <span class="keyword">new</span> Applications();</div><div class="line"><span class="number">13</span>:     apps.setVersion(<span class="number">1L</span>);</div><div class="line"><span class="number">14</span>:     <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; entry : registry.entrySet()) &#123;</div><div class="line"><span class="number">15</span>:         Application app = <span class="keyword">null</span>;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (entry.getValue() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:             <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; stringLeaseEntry : entry.getValue().entrySet()) &#123;</div><div class="line"><span class="number">19</span>:                 Lease&lt;InstanceInfo&gt; lease = stringLeaseEntry.getValue();</div><div class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">21</span>:                     app = <span class="keyword">new</span> Application(lease.getHolder().getAppName());</div><div class="line"><span class="number">22</span>:                 &#125;</div><div class="line"><span class="number">23</span>:                 app.addInstance(decorateInstanceInfo(lease));</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">27</span>:             apps.addApplication(app);</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>:     <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line"><span class="number">31</span>:     <span class="keyword">if</span> (includeRemoteRegion) &#123;</div><div class="line"><span class="number">32</span>:         <span class="keyword">for</span> (String remoteRegion : remoteRegions) &#123;</div><div class="line"><span class="number">33</span>:             RemoteRegionRegistry remoteRegistry = regionNameVSRemoteRegistry.get(remoteRegion);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegistry) &#123;</div><div class="line"><span class="number">35</span>:                 Applications remoteApps = remoteRegistry.getApplications();</div><div class="line"><span class="number">36</span>:                 <span class="keyword">for</span> (Application application : remoteApps.getRegisteredApplications()) &#123;</div><div class="line"><span class="number">37</span>:                     <span class="keyword">if</span> (shouldFetchFromRemoteRegistry(application.getName(), remoteRegion)) &#123;</div><div class="line"><span class="number">38</span>:                         logger.info(<span class="string">"Application &#123;&#125;  fetched from the remote region &#123;&#125;"</span>,</div><div class="line"><span class="number">39</span>:                                 application.getName(), remoteRegion);</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>:                         Application appInstanceTillNow = apps.getRegisteredApplications(application.getName());</div><div class="line"><span class="number">42</span>:                         <span class="keyword">if</span> (appInstanceTillNow == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">43</span>:                             appInstanceTillNow = <span class="keyword">new</span> Application(application.getName());</div><div class="line"><span class="number">44</span>:                             apps.addApplication(appInstanceTillNow);</div><div class="line"><span class="number">45</span>:                         &#125;</div><div class="line"><span class="number">46</span>:                         <span class="keyword">for</span> (InstanceInfo instanceInfo : application.getInstances()) &#123;</div><div class="line"><span class="number">47</span>:                             appInstanceTillNow.addInstance(instanceInfo);</div><div class="line"><span class="number">48</span>:                         &#125;</div><div class="line"><span class="number">49</span>:                     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">50</span>:                         logger.debug(<span class="string">"Application &#123;&#125; not fetched from the remote region &#123;&#125; as there exists a "</span></div><div class="line"><span class="number">51</span>:                                         + <span class="string">"whitelist and this app is not in the whitelist."</span>,</div><div class="line"><span class="number">52</span>:                                 application.getName(), remoteRegion);</div><div class="line"><span class="number">53</span>:                     &#125;</div><div class="line"><span class="number">54</span>:                 &#125;</div><div class="line"><span class="number">55</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">56</span>:                 logger.warn(<span class="string">"No remote registry available for the remote region &#123;&#125;"</span>, remoteRegion);</div><div class="line"><span class="number">57</span>:             &#125;</div><div class="line"><span class="number">58</span>:         &#125;</div><div class="line"><span class="number">59</span>:     &#125;</div><div class="line"><span class="number">60</span>:     <span class="comment">// è®¾ç½® åº”ç”¨é›†åˆ hashcode</span></div><div class="line"><span class="number">61</span>:     apps.setAppsHashCode(apps.getReconcileHashCode());</div><div class="line"><span class="number">62</span>:     <span class="keyword">return</span> apps;</div><div class="line"><span class="number">63</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 2 è‡³ ç¬¬ 10 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 11 è‡³ 29 è¡Œ ï¼šè·å¾—è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€‚</li><li>ç¬¬ 30 è‡³ 59 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li>ç¬¬ 61 è¡Œ ï¼šè®¡ç®—åº”ç”¨é›†åˆ <code>hashcode</code> ã€‚è¯¥å˜é‡ç”¨äºæ ¡éªŒ<strong>å¢é‡</strong>è·å–çš„æ³¨å†Œä¿¡æ¯å’Œ Eureka-Server <strong>å…¨é‡</strong>çš„æ³¨å†Œä¿¡æ¯æ˜¯å¦ä¸€è‡´( å®Œæ•´ )ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h3>3.3.2 è½¬æ¢æˆç¼“å­˜å€¼</h3><p>è°ƒç”¨ <code>#getPayLoad()</code> æ–¹æ³•ï¼Œå°†æ³¨å†Œçš„åº”ç”¨é›†åˆè½¬æ¢æˆç¼“å­˜å€¼ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Generate pay load with both JSON and XML formats for all applications.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getPayLoad</span><span class="params">(Key key, Applications apps)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾—ç¼–ç å™¨</span></div><div class="line">   EncoderWrapper encoderWrapper = serverCodecs.getEncoder(key.getType(), key.getEurekaAccept());</div><div class="line">   String result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// ç¼–ç </span></div><div class="line">       result = encoderWrapper.encode(apps);</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.error(<span class="string">"Failed to encode the payload for all apps"</span>, e);</div><div class="line">       <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span>(logger.isDebugEnabled()) &#123;</div><div class="line">       logger.debug(<span class="string">"New application cache entry &#123;&#125; with apps hashcode &#123;&#125;"</span>, key.toStringCompact(), apps.getAppsHashCode());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.4 ä¸»åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</h2><p>åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€è¿‡æœŸæ—¶ï¼Œè°ƒç”¨ <code>ResponseCacheImpl#invalidate()</code> æ–¹æ³•ï¼Œä¸»åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜( <code>readWriteCacheMap</code> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Key.KeyType type : Key.KeyType.values()) &#123;</div><div class="line">       <span class="keyword">for</span> (Version v : Version.values()) &#123;</div><div class="line">           invalidate(</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, appName, type, v, EurekaAccept.full),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, appName, type, v, EurekaAccept.compact),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS, type, v, EurekaAccept.full),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS, type, v, EurekaAccept.compact),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS_DELTA, type, v, EurekaAccept.full),</div><div class="line">                   <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS_DELTA, type, v, EurekaAccept.compact)</div><div class="line">           );</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != vipAddress) &#123;</div><div class="line">               invalidate(<span class="keyword">new</span> Key(Key.EntityType.VIP, vipAddress, type, v, EurekaAccept.full));</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != secureVipAddress) &#123;</div><div class="line">               invalidate(<span class="keyword">new</span> Key(Key.EntityType.SVIP, secureVipAddress, type, v, EurekaAccept.full));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#invalidate(keys)</code> æ–¹æ³•ï¼Œé€ä¸ªè¿‡æœŸæ¯ä¸ªç¼“å­˜é”®å€¼ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(Key... keys)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Key key : keys) &#123;</div><div class="line">       logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;, &#123;&#125;"</span>, key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept());</div><div class="line">       <span class="comment">// è¿‡æœŸè¯»å†™ç¼“å­˜</span></div><div class="line">       readWriteCacheMap.invalidate(key);</div><div class="line">       <span class="comment">// TODO[0009]ï¼šRemoteRegionRegistry</span></div><div class="line">       Collection&lt;Key&gt; keysWithRegions = regionSpecificKeys.get(key);</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> != keysWithRegions &amp;&amp; !keysWithRegions.isEmpty()) &#123;</div><div class="line">           <span class="keyword">for</span> (Key keysWithRegion : keysWithRegions) &#123;</div><div class="line">               logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</div><div class="line">                       key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept());</div><div class="line">               readWriteCacheMap.invalidate(keysWithRegion);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>3.5 è¢«åŠ¨è¿‡æœŸè¯»å†™ç¼“å­˜</h2><p>è¯»å†™ç¼“å­˜( <code>readWriteCacheMap</code> ) å†™å…¥åï¼Œä¸€æ®µæ—¶é—´è‡ªåŠ¨è¿‡æœŸï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds())</div></pre></td></tr></table></figure></p><ul><li>é…ç½® <code>eureka.responseCacheAutoExpirationInSeconds</code> ï¼Œè®¾ç½®å†™å…¥è¿‡æœŸæ—¶é•¿ã€‚é»˜è®¤å€¼ ï¼š180 ç§’ã€‚</li></ul><h2>3.6 å®šæ—¶åˆ·æ–°åªè¯»ç¼“å­˜</h2><p><strong>å®šæ—¶</strong>ä»»åŠ¡å¯¹æ¯” <code>readWriteCacheMap</code> å’Œ <code>readOnlyCacheMap</code> çš„ç¼“å­˜å€¼ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œä»¥å‰è€…ä¸ºä¸»ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®ç°äº† <code>readOnlyCacheMap</code> çš„å®šæ—¶è¿‡æœŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: ResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) &#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// ... çœç•¥æ— å…³ä»£ç  </span></div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">long</span> responseCacheUpdateIntervalMs = serverConfig.getResponseCacheUpdateIntervalMs();</div><div class="line"> <span class="number">5</span>:     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (shouldUseReadOnlyResponseCache) &#123;</div><div class="line"> <span class="number">8</span>:         timer.schedule(getCacheUpdateTask(),</div><div class="line"> <span class="number">9</span>:                 <span class="keyword">new</span> Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)</div><div class="line"><span class="number">10</span>:                         + responseCacheUpdateIntervalMs),</div><div class="line"><span class="number">11</span>:                 responseCacheUpdateIntervalMs);</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="function"><span class="keyword">private</span> TimerTask <span class="title">getCacheUpdateTask</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">18</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</div><div class="line"><span class="number">19</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">20</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">21</span>:             logger.debug(<span class="string">"Updating the client cache from response cache"</span>);</div><div class="line"><span class="number">22</span>:             <span class="keyword">for</span> (Key key : readOnlyCacheMap.keySet()) &#123; <span class="comment">// å¾ªç¯ readOnlyCacheMap çš„ç¼“å­˜é”®</span></div><div class="line"><span class="number">23</span>:                 <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line"><span class="number">24</span>:                     Object[] args = &#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType()&#125;;</div><div class="line"><span class="number">25</span>:                     logger.debug(<span class="string">"Updating the client cache from response cache for key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, args);</div><div class="line"><span class="number">26</span>:                 &#125;</div><div class="line"><span class="number">27</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">28</span>:                     CurrentRequestVersion.set(key.getVersion());</div><div class="line"><span class="number">29</span>:                     Value cacheValue = readWriteCacheMap.get(key);</div><div class="line"><span class="number">30</span>:                     Value currentCacheValue = readOnlyCacheMap.get(key);</div><div class="line"><span class="number">31</span>:                     <span class="keyword">if</span> (cacheValue != currentCacheValue) &#123; <span class="comment">// ä¸ä¸€è‡´æ—¶ï¼Œè¿›è¡Œæ›¿æ¢</span></div><div class="line"><span class="number">32</span>:                         readOnlyCacheMap.put(key, cacheValue);</div><div class="line"><span class="number">33</span>:                     &#125;</div><div class="line"><span class="number">34</span>:                 &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line"><span class="number">35</span>:                     logger.error(<span class="string">"Error while updating the client cache from response cache for key &#123;&#125;"</span>, key.toStringCompact(), th);</div><div class="line"><span class="number">36</span>:                 &#125;</div><div class="line"><span class="number">37</span>:             &#125;</div><div class="line"><span class="number">38</span>:         &#125;</div><div class="line"><span class="number">39</span>:     &#125;;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 12 è¡Œ ï¼šåˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ã€‚é…ç½® <code>eureka.responseCacheUpdateIntervalMs</code>ï¼Œè®¾ç½®ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œé»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚</li><li>ç¬¬ 17 è‡³ 39 è¡Œ ï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚<ul><li>ç¬¬ 22 è¡Œ ï¼šå¾ªç¯ <code>readOnlyCacheMap</code> çš„ç¼“å­˜é”®ã€‚<strong>ä¸ºä»€ä¹ˆä¸å¾ªç¯ <code>readWriteCacheMap</code> å‘¢</strong>ï¼Ÿ <code>readOnlyCacheMap</code> çš„ç¼“å­˜è¿‡æœŸä¾èµ–  <code>readWriteCacheMap</code>ï¼Œå› æ­¤ç¼“å­˜é”®ä¼šæ›´å¤šã€‚</li><li>ç¬¬ 28 è¡Œ è‡³ 33 è¡Œ ï¼šå¯¹æ¯” <code>readWriteCacheMap</code> å’Œ <code>readOnlyCacheMap</code> çš„ç¼“å­˜å€¼ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œä»¥å‰è€…ä¸ºä¸»ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®ç°äº† <code>readOnlyCacheMap</code> çš„å®šæ—¶è¿‡æœŸã€‚</li></ul></li></ul><h1>666. å½©è›‹</h1><p>æ¯”é¢„æœŸï¼Œæ¯”æƒ³æƒ³ï¼Œé•¿è€å¤šè€å¤šçš„ä¸€ç¯‡æ–‡ç« ã€‚ç»†æ€ææã€‚</p><p>ä¼°è®¡ä¸‹ä¸€ç¯‡å¢é‡è·å–ä¼šç®€æ´å¾ˆå¤šã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-all/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸ</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-evict/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-evict/</id>
    <published>2018-06-21T16:00:00.000Z</published>
    <updated>2017-10-06T18:05:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-evict/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">3. EvictionTask</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">4. è¿‡æœŸé€»è¾‘</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server è¿‡æœŸè¶…æ—¶ç»­ç§Ÿçš„ç§Ÿçº¦</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_22/01.png" alt=""></p></blockquote><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</h1><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨å®ä¾‹ä¸‹çº¿æ—¶å€™ä¼šä¸»åŠ¨å‘ Eureka-Server å‘èµ·ä¸‹çº¿è¯·æ±‚ã€‚ä½†å®é™…æƒ…å†µä¸‹ï¼Œåº”ç”¨å®ä¾‹å¯èƒ½å¼‚å¸¸å´©æºƒï¼Œåˆæˆ–è€…æ˜¯ç½‘ç»œå¼‚å¸¸ç­‰åŸå› ï¼Œå¯¼è‡´ä¸‹çº¿è¯·æ±‚æ— æ³•è¢«æˆåŠŸæäº¤ã€‚</p><p>ä»‹äºè¿™ç§æƒ…å†µï¼Œé€šè¿‡ Eureka-Client å¿ƒè·³å»¶é•¿ç§Ÿçº¦ï¼Œé…åˆ Eureka-Server æ¸…ç†è¶…æ—¶çš„ç§Ÿçº¦è§£å†³ä¸Šè¿°å¼‚å¸¸ã€‚</p><h1>3. EvictionTask</h1><p><code>com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask</code>ï¼Œæ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡ã€‚åœ¨ Eureka-Server å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ– EvictionTask å®šæ—¶æ‰§è¡Œï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;EvictionTask&gt; evictionTaskRef = <span class="keyword">new</span> AtomicReference&lt;EvictionTask&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postInit</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– æ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (evictionTaskRef.get() != <span class="keyword">null</span>) &#123;</div><div class="line">       evictionTaskRef.get().cancel();</div><div class="line">   &#125;</div><div class="line">   evictionTaskRef.set(<span class="keyword">new</span> EvictionTask());</div><div class="line">   evictionTimer.schedule(evictionTaskRef.get(),</div><div class="line">           serverConfig.getEvictionIntervalTimerInMs(),</div><div class="line">           serverConfig.getEvictionIntervalTimerInMs());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>é…ç½® <code>eureka.evictionIntervalTimerInMs</code> ï¼Œæ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤ï¼Œ60000 æ¯«ç§’ã€‚</p></li><li><p>EvictionTask å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EvictionTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å– è¡¥å¿æ—¶é—´æ¯«ç§’æ•°</span></div><div class="line">           <span class="keyword">long</span> compensationTimeMs = getCompensationTimeMs();</div><div class="line">           logger.info(<span class="string">"Running the evict task with compensationTime &#123;&#125;ms"</span>, compensationTimeMs);</div><div class="line">           <span class="comment">// æ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘</span></div><div class="line">           evict(compensationTimeMs);</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">           logger.error(<span class="string">"Could not run the evict task"</span>, e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#compensationTimeMs()</code> æ–¹æ³•ï¼Œè·å¾—è¡¥å¿æ—¶é—´æ¯«ç§’æ•°ã€‚è®¡ç®—å…¬å¼ = å½“å‰æ—¶é—´ - æœ€åä»»åŠ¡æ‰§è¡Œæ—¶é—´ - ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ã€‚ä¸ºä»€ä¹ˆéœ€è¦è¡¥å¿æ—¶é—´æ¯«ç§’æ•°ï¼Œåœ¨ <a href="#">ã€Œ4. è¿‡æœŸé€»è¾‘ã€<code>Lease#isisExpired(additionalLeaseMs)</code> æ–¹æ³•</a> æ­æ™“ã€‚<code>#compensationTimeMs()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åä»»åŠ¡æ‰§è¡Œæ—¶é—´</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastExecutionNanosRef = <span class="keyword">new</span> AtomicLong(<span class="number">0L</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">getCompensationTimeMs</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> currNanos = getCurrentTimeNano();</div><div class="line">    <span class="keyword">long</span> lastNanos = lastExecutionNanosRef.getAndSet(currNanos);</div><div class="line">    <span class="keyword">if</span> (lastNanos == <span class="number">0L</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);</div><div class="line">    <span class="keyword">long</span> compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();</div><div class="line">    <span class="keyword">return</span> compensationTime &lt;= <span class="number">0L</span> ? <span class="number">0L</span> : compensationTime;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç”±äº JVM GC ï¼Œåˆæˆ–æ˜¯æ—¶é—´åç§»( clock skew ) ç­‰åŸå› ï¼Œå®šæ—¶å™¨æ‰§è¡Œå®é™…æ¯”é¢„æœŸä¼š<strong>ç•¥æœ‰å»¶è¿Ÿ</strong>ã€‚ç¬”è€…åœ¨æœ¬æœº<strong>ä½è´Ÿè½½</strong>è¿è¡Œï¼Œå¤§æ¦‚ 10 ms å†…ã€‚</p><blockquote><p>compute a compensation time defined as the actual time this task was executed since the prev iteration, vs the configured amount of time for execution. This is useful for cases where changes in time (due to clock skew or gc for example) causes the actual eviction task to execute later than the desired time according to the configured cycle.</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>#evict(compensationTime)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4. è¿‡æœŸé€»è¾‘ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h1>4. è¿‡æœŸé€»è¾‘</h1><p>è°ƒç”¨ <code>#evict(compensationTime)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     logger.debug(<span class="string">"Running the evict task"</span>);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class="line"> <span class="number">5</span>:         logger.debug(<span class="string">"DS: lease expiration is currently disabled."</span>);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="comment">// è·å¾— æ‰€æœ‰è¿‡æœŸçš„ç§Ÿçº¦</span></div><div class="line"><span class="number">10</span>:     <span class="comment">// We collect first all expired items, to evict them in random order. For large eviction sets,</span></div><div class="line"><span class="number">11</span>:     <span class="comment">// if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,</span></div><div class="line"><span class="number">12</span>:     <span class="comment">// the impact should be evenly distributed across all applications.</span></div><div class="line"><span class="number">13</span>:     List&lt;Lease&lt;InstanceInfo&gt;&gt; expiredLeases = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">14</span>:     <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; groupEntry : registry.entrySet()) &#123;</div><div class="line"><span class="number">15</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = groupEntry.getValue();</div><div class="line"><span class="number">16</span>:         <span class="keyword">if</span> (leaseMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">17</span>:             <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseEntry : leaseMap.entrySet()) &#123;</div><div class="line"><span class="number">18</span>:                 Lease&lt;InstanceInfo&gt; lease = leaseEntry.getValue();</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (lease.isExpired(additionalLeaseMs) &amp;&amp; lease.getHolder() != <span class="keyword">null</span>) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"><span class="number">20</span>:                     expiredLeases.add(lease);</div><div class="line"><span class="number">21</span>:                 &#125;</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="comment">// è®¡ç®— æœ€å¤§å…è®¸æ¸…ç†ç§Ÿçº¦æ•°é‡</span></div><div class="line"><span class="number">27</span>:     <span class="comment">// To compensate for GC pauses or drifting local time, we need to use current registry size as a base for</span></div><div class="line"><span class="number">28</span>:     <span class="comment">// triggering self-preservation. Without that we would wipe out full registry.</span></div><div class="line"><span class="number">29</span>:     <span class="keyword">int</span> registrySize = (<span class="keyword">int</span>) getLocalRegistrySize();</div><div class="line"><span class="number">30</span>:     <span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (registrySize * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">31</span>:     <span class="keyword">int</span> evictionLimit = registrySize - registrySizeThreshold;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:     <span class="comment">// è®¡ç®— æ¸…ç†ç§Ÿçº¦æ•°é‡</span></div><div class="line"><span class="number">34</span>:     <span class="keyword">int</span> toEvict = Math.min(expiredLeases.size(), evictionLimit);</div><div class="line"><span class="number">35</span>:     <span class="keyword">if</span> (toEvict &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:         logger.info(<span class="string">"Evicting &#123;&#125; items (expired=&#123;&#125;, evictionLimit=&#123;&#125;)"</span>, toEvict, expiredLeases.size(), evictionLimit);</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:         <span class="comment">// é€ä¸ªè¿‡æœŸ</span></div><div class="line"><span class="number">39</span>:         Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</div><div class="line"><span class="number">40</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toEvict; i++) &#123;</div><div class="line"><span class="number">41</span>:             <span class="comment">// Pick a random item (Knuth shuffle algorithm)</span></div><div class="line"><span class="number">42</span>:             <span class="keyword">int</span> next = i + random.nextInt(expiredLeases.size() - i);</div><div class="line"><span class="number">43</span>:             Collections.swap(expiredLeases, i, next);</div><div class="line"><span class="number">44</span>:             Lease&lt;InstanceInfo&gt; lease = expiredLeases.get(i);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:             String appName = lease.getHolder().getAppName();</div><div class="line"><span class="number">47</span>:             String id = lease.getHolder().getId();</div><div class="line"><span class="number">48</span>:             EXPIRED.increment();</div><div class="line"><span class="number">49</span>:             logger.warn(<span class="string">"DS: Registry: expired lease for &#123;&#125;/&#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">50</span>:             internalCancel(appName, id, <span class="keyword">false</span>);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>:     &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 7 è¡Œ ï¼šåˆ¤æ–­å…è®¸æ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œä¸»è¦å’Œ<strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>æœ‰å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 9 è‡³ 24 è¡Œ ï¼šè·å¾—<strong>æ‰€æœ‰è¿‡æœŸ</strong>çš„ç§Ÿçº¦é›†åˆã€‚</p><ul><li><p>ç¬¬ 19 è¡Œ ï¼šè°ƒç”¨ <code>Lease#isisExpired(additionalLeaseMs)</code> æ–¹æ³•ï¼Œåˆ¤æ–­ç§Ÿçº¦æ˜¯å¦è¿‡æœŸï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lease.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpired</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> (evictionTimestamp &gt; <span class="number">0</span> || System.currentTimeMillis() &gt; (lastUpdateTimestamp + duration + additionalLeaseMs));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">   lastUpdateTimestamp = System.currentTimeMillis() + duration;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ğŸ˜ˆ<strong>æ³¨æ„</strong>ï¼šåœ¨ä¸è€ƒè™‘ <code>additionalLeaseMs</code> å‚æ•°çš„æƒ…å†µä¸‹ï¼Œç§Ÿçº¦è¿‡æœŸæ—¶é—´æ¯”é¢„æœŸå¤šäº†<strong>ä¸€ä¸ª</strong> <code>duration</code>ï¼ŒåŸå› åœ¨äº <code>#renew()</code> æ–¹æ³•é”™è¯¯çš„è®¾ç½® <code>lastUpdateTimestamp = System.currentTimeMillis() + duration</code>ï¼Œæ­£ç¡®çš„è®¾ç½®åº”è¯¥æ˜¯ <code>lastUpdateTimestamp = System.currentTimeMillis()</code> ã€‚</p><blockquote><p>Note that due to renew() doing the 'wrong&quot; thing and setting lastUpdateTimestamp to +duration more than what it should be, the expiry will actually be 2 * duration. <strong>This is a minor bug and should only affect instances that ungracefully shutdown. Due to possible wide ranging impact to existing usage, this will not be fixed</strong>.</p></blockquote></li><li><p>TODO[0023]ï¼šadditionalLeaseMs</p></li></ul></li></ul></li><li><p>ç¬¬ 26 è‡³ 34 è¡Œ ï¼šè®¡ç®—<strong>æœ€å¤§å…è®¸</strong>æ¸…ç†ç§Ÿçº¦çš„æ•°é‡ï¼Œåè®¡ç®—å…è®¸æ¸…ç†ç§Ÿçº¦çš„æ•°é‡ã€‚</p><ul><li><p>ğŸ˜ˆ<strong>æ³¨æ„</strong>ï¼šå³ä½¿ Eureka-Server å…³é—­<strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>ï¼Œå¦‚æœä½¿ç”¨<code>renewalPercentThreshold = 0.85</code> é»˜è®¤é…ç½®ï¼Œç»“æœä¼šæ˜¯<strong>åˆ†æ‰¹é€æ­¥</strong>è¿‡æœŸã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// å‡è®¾ 20 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 10 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬ä¸€è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">20</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">20</span> * <span class="number">0.85</span>) = <span class="number">17</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">20</span> - <span class="number">17</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">10</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬ä¸€è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 17 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 7 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬äºŒè½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">17</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">17</span> * <span class="number">0.85</span>) = <span class="number">14</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">17</span> - <span class="number">14</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">7</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬äºŒè½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 14 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 4 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬ä¸‰è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">14</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">14</span> * <span class="number">0.85</span>) = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">14</span> - <span class="number">11</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">4</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬ä¸‰è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 11 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 1 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬å››è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">11</span> * <span class="number">0.85</span>) = <span class="number">9</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">11</span> - <span class="number">9</span> = <span class="number">2</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">1</span>, <span class="number">2</span>) = <span class="number">1</span>;</div><div class="line"><span class="comment">// ç¬¬å››è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 10 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 0 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚ç»“æŸã€‚</span></div></pre></td></tr></table></figure></p><ul><li>ç»“è®ºï¼šæ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤çš„å·®åˆ«ï¼Œåœ¨äºæ˜¯å¦æ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ã€‚å¦‚æœæƒ³å…³é—­<strong>åˆ†æ‰¹é€æ­¥</strong>è¿‡æœŸï¼Œè®¾ç½® <code>renewalPercentThreshold = 0</code> ã€‚</li></ul></li><li><p>ç”±äº JVM GC ï¼Œæˆ–æ˜¯æœ¬åœ°æ—¶é—´å·®å¼‚åŸå› ï¼Œå¯èƒ½è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶çš„é˜€å€¼ <code>expectedNumberOfRenewsPerMin</code>ã€<code>numberOfRenewsPerMinThreshold</code> ä¸å¤Ÿæ­£ç¡®ï¼Œåœ¨<strong>è¿‡æœŸ</strong>è¿™ä¸ªç›¸å¯¹â€œå±é™©â€çš„æ“ä½œï¼Œ<strong>é‡æ–°è®¡ç®—è‡ªæˆ‘ä¿æŠ¤</strong>çš„é˜€å€¼ã€‚</p></li></ul></li><li><p>ç¬¬ 35 è‡³ 51 è¡Œ ï¼š<strong>éšæœº</strong>æ¸…ç†è¿‡æœŸçš„ç§Ÿçº¦ã€‚ç”±äºç§Ÿçº¦æ˜¯æŒ‰ç…§<strong>åº”ç”¨é¡ºåº</strong>æ·»åŠ åˆ°æ•°ç»„ï¼Œé€šè¿‡éšæœºçš„æ–¹å¼ï¼Œ<strong>å°½é‡é¿å…å•ä¸ªåº”ç”¨è¢«å…¨éƒ¨è¿‡æœŸ</strong>ã€‚</p><ul><li>ç¬¬ 39 è¡Œ ï¼šä¼ å…¥å½“å‰æ—¶é—´ä¸ºç§å­ç”Ÿæˆéšæœºï¼Œé¿å… Java çš„ä¼ªéšæœºæƒ…å†µã€‚åœ¨ <a href="http://www.cnblogs.com/greatfish/p/5845924.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸ºä»€ä¹ˆè¯´Javaä¸­çš„éšæœºæ•°éƒ½æ˜¯ä¼ªéšæœºæ•°ï¼Ÿã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 41 è‡³ 43 è¡Œ ï¼šéšæœºè°ƒæ¢åé¢çš„å…ƒç´ åˆ°å½“å‰ä½ç½®( <code>i</code> )ã€‚</li></ul></li><li><p>ç¬¬ 50 è¡Œ ï¼šè°ƒç”¨ <code>#internalCancel()</code> æ–¹æ³•ï¼Œä¸‹çº¿å·²è¿‡æœŸçš„ç§Ÿçº¦ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹ã€Œ3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>ğŸ˜« åŸæœ¬è§‰å¾—æ¯”è¾ƒå®¹æ˜“çš„ä¸€ç¯‡æ–‡ç« ï¼Œç»“æœæ¶ˆè€—äº†æ¯”æƒ³è±¡ä¸­çš„æ—¶é—´ï¼Œå¯èƒ½æœ‰å››ä¸ªå°æ—¶ã€‚ä¸»è¦å¡åœ¨è¡¥å¿æ—¶é—´ï¼Œç›®å‰ä¹Ÿæ²¡å¼„æ‡‚ã€‚å¦‚æœæœ‰çŸ¥é“çš„èƒ–å‹ï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-evict/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka/ins
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-self-preservation/</id>
    <published>2018-06-14T16:00:00.000Z</published>
    <updated>2017-10-06T13:13:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-self-preservation/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">2. å®šä¹‰</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3. å®ç°</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3.1 è§¦å‘æ¡ä»¶</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3.2 è®¡ç®—å…¬å¼</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">3.3 è®¡ç®—æ—¶æœº</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>ï¼Œä¸ºåº”ç”¨å®ä¾‹è¿‡æœŸä¸‹çº¿åšé“ºå«ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li></ul><h1>2. å®šä¹‰</h1><p>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="http://www.itmuch.com/spring-cloud-sum/understanding-eureka-self-preservation/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">å‘¨ç«‹ â€”â€” ã€Šç†è§£Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‹</a><br>å½“Eureka ServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚ä¸€æ—¦è¿›å…¥è¯¥æ¨¡å¼ï¼ŒEureka Serverå°±ä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šæ³¨é”€ä»»ä½•å¾®æœåŠ¡ï¼‰ã€‚å½“ç½‘ç»œæ•…éšœæ¢å¤åï¼Œè¯¥Eureka ServerèŠ‚ç‚¹ä¼šè‡ªåŠ¨é€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p></blockquote><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶</strong> ï¼Ÿä½ ä¹Ÿå¯ä»¥ä»å‘¨ç«‹å…„çš„<strong>è¿™ç¯‡æ–‡ç« å¾—åˆ°ç­”æ¡ˆ</strong>ï¼Œè¿™é‡Œç¬”è€…å°±ä¸ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“äº†ã€‚</p><h1>3. å®ç°</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹åœ¨è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶é‡Œæ‰®æ¼”<strong>é‡è¦</strong>è§’è‰²çš„ä¸¤ä¸ªå˜é‡ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœŸæœ›æœ€å°æ¯åˆ†é’Ÿç»­ç§Ÿæ¬¡æ•°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">int</span> numberOfRenewsPerMinThreshold;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœŸæœ›æœ€å¤§æ¯åˆ†é’Ÿç»­ç§Ÿæ¬¡æ•°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">int</span> expectedNumberOfRenewsPerMin;</div></pre></td></tr></table></figure></p><ul><li><code>expectedNumberOfRenewsPerMin</code> ï¼ŒæœŸæœ›<strong>æœ€å¤§</strong>æ¯åˆ†é’Ÿ<strong>ç»­ç§Ÿ</strong>æ¬¡æ•°ã€‚</li><li><code>numberOfRenewsPerMinThreshold</code> ï¼ŒæœŸæœ›<strong>æœ€å°</strong>æ¯åˆ†é’Ÿ<strong>ç»­ç§Ÿ</strong>æ¬¡æ•°ã€‚</li></ul><h2>3.1 è§¦å‘æ¡ä»¶</h2><p>å½“æ¯åˆ†é’Ÿå¿ƒè·³æ¬¡æ•°( <code>renewsLastMin</code> ) <strong>å°äº</strong> <code>numberOfRenewsPerMinThreshold</code> æ—¶ï¼Œå¹¶ä¸”å¼€å¯è‡ªåŠ¨ä¿æŠ¤æ¨¡å¼å¼€å…³( <code>eureka.enableSelfPreservation = true</code> ) æ—¶ï¼Œ<strong>è§¦å‘è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ï¼Œä¸å†è‡ªåŠ¨è¿‡æœŸç§Ÿçº¦</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class="line">       logger.debug(<span class="string">"DS: lease expiration is currently disabled."</span>);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// ... çœç•¥è¿‡æœŸç§Ÿçº¦é€»è¾‘</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeaseExpirationEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!isSelfPreservationModeEnabled()) &#123;</div><div class="line">       <span class="comment">// The self preservation mode is disabled, hence allowing the instances to expire.</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> numberOfRenewsPerMinThreshold &gt; <span class="number">0</span> &amp;&amp; getNumOfRenewsInLastMin() &gt; numberOfRenewsPerMinThreshold;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 è®¡ç®—å…¬å¼</h2><p>è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><ul><li><code>expectedNumberOfRenewsPerMin</code> = å½“å‰æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•° <code>x</code> 2</li><li><code>numberOfRenewsPerMinThreshold</code> = <code>expectedNumberOfRenewsPerMin</code> <code>*</code> ç»­ç§Ÿç™¾åˆ†æ¯”( <code>eureka.renewalPercentThreshold</code> )</li></ul><p><strong>ä¸ºä»€ä¹ˆä¹˜ä»¥ 2</strong></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ³¨å†Œçš„åº”ç”¨å®ä¾‹æ¯åŠåˆ†é’Ÿç»­ç§Ÿä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€åˆ†é’Ÿå¿ƒè·³<strong>ä¸¤æ¬¡</strong>ï¼Œå› æ­¤ x 2 ã€‚</p><p>è¿™å—ä¼šæœ‰ä¸€äº›ç¡¬ç¼–ç çš„æƒ…å†µï¼Œ<strong>å› æ­¤ä¸å¤ªå»ºè®®ä¿®æ”¹åº”ç”¨å®ä¾‹çš„ç»­ç§Ÿé¢‘ç‡</strong>ã€‚</p><p><strong>ä¸ºä»€ä¹ˆä¹˜ä»¥ç»­ç§Ÿç™¾åˆ†æ¯”</strong></p><p>ä½äºè¿™ä¸ªç™¾åˆ†æ¯”ï¼Œæ„å‘³ç€å¼€å¯è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>eureka.renewalPercentThreshold = 0.85</code> ã€‚</p><p>å¦‚æœä½ çœŸçš„è°ƒæ•´äº†<strong>ç»­ç§Ÿé¢‘ç‡</strong>ï¼Œå¯ä»¥ç­‰æ¯”å»ç»­ç§Ÿç™¾åˆ†æ¯”ï¼Œä»¥ä¿è¯åˆé€‚çš„è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶çš„é˜€å€¼ã€‚å¦å¤–ï¼Œä½ éœ€è¦æ³¨æ„ï¼Œç»­ç§Ÿé¢‘ç‡æ˜¯ Client çº§åˆ«ï¼Œç»­ç§Ÿç™¾åˆ†æ¯”æ˜¯ Server çº§åˆ«ã€‚</p><h2>3.3 è®¡ç®—æ—¶æœº</h2><p>ç›®å‰æœ‰<strong>å››</strong>ä¸ªåœ°æ–¹ä¼šè®¡ç®— <code>numberOfRenewsPerMinThreshold</code> ã€ <code>expectedNumberOfRenewsPerMin</code>ï¼Œæˆ‘ä»¬é€å°èŠ‚æ¥çœ‹ã€‚</p><h3>3.3.1 Eureka-Server åˆå§‹åŒ–</h3><p>Eureka-Server åœ¨å¯åŠ¨æ—¶ï¼Œä» Eureka-Server é›†ç¾¤è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶<strong>é¦–æ¬¡</strong>åˆå§‹åŒ– <code>numberOfRenewsPerMinThreshold</code> ã€ <code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaBootStrap.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initEurekaServerContext</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒä»£ç </span></div><div class="line"></div><div class="line">    <span class="comment">// ã€2.2.10ã€‘ä»å…¶ä»– Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</span></div><div class="line">    <span class="comment">// Copy registry from neighboring eureka node</span></div><div class="line">    <span class="keyword">int</span> registryCount = registry.syncUp();</div><div class="line">    registry.openForTraffic(applicationInfoManager, registryCount);</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒä»£ç </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">   <span class="comment">// Renewals happen every 30 seconds and for a minute it should be a factor of 2.</span></div><div class="line">   <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = count * <span class="number">2</span>;</div><div class="line">   <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</div><div class="line">           (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">           </div><div class="line">   <span class="comment">// ... çœç•¥å…¶å®ƒä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.3.2 å®šæ—¶é‡ç½®</h3><p>Eureka-Server <strong>å®šæ—¶</strong>é‡æ–°è®¡ç®— <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleRenewalThresholdUpdateTask</span><span class="params">()</span> </span>&#123;</div><div class="line">   timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line">                      <span class="meta">@Override</span></div><div class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                          updateRenewalThreshold();</div><div class="line">                      &#125;</div><div class="line">                  &#125;, serverConfig.getRenewalThresholdUpdateIntervalMs(),</div><div class="line">           serverConfig.getRenewalThresholdUpdateIntervalMs());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è‡ªæˆ‘ä¿æŠ¤æœºé”</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* å½“è®¡ç®—å¦‚ä¸‹å‚æ•°æ—¶ä½¿ç”¨ï¼š</span></div><div class="line"><span class="comment">*  1. &#123;<span class="doctag">@link</span> #numberOfRenewsPerMinThreshold&#125;</span></div><div class="line"><span class="comment">*  2. &#123;<span class="doctag">@link</span> #expectedNumberOfRenewsPerMin&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRenewalThreshold</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è®¡ç®— åº”ç”¨å®ä¾‹æ•°</span></div><div class="line">       Applications apps = eurekaClient.getApplications();</div><div class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;</div><div class="line">           <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line">               <span class="keyword">if</span> (<span class="keyword">this</span>.isRegisterable(instance)) &#123;</div><div class="line">                   ++count;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è®¡ç®— expectedNumberOfRenewsPerMin ã€ numberOfRenewsPerMinThreshold å‚æ•°</span></div><div class="line">       <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">           <span class="comment">// Update threshold only if the threshold is greater than the</span></div><div class="line">           <span class="comment">// current expected threshold of if the self preservation is disabled.</span></div><div class="line">           <span class="keyword">if</span> ((count * <span class="number">2</span>) &gt; (serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold)</div><div class="line">                   || (!<span class="keyword">this</span>.isSelfPreservationModeEnabled())) &#123;</div><div class="line">               <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = count * <span class="number">2</span>;</div><div class="line">               <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) ((count * <span class="number">2</span>) * serverConfig.getRenewalPercentThreshold());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       logger.info(<span class="string">"Current renewal threshold is : &#123;&#125;"</span>, numberOfRenewsPerMinThreshold);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot update renewal threshold"</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é…ç½® <code>eureka.renewalThresholdUpdateIntervalMs</code> å‚æ•°ï¼Œå®šæ—¶é‡æ–°è®¡ç®—ã€‚é»˜è®¤ï¼Œ15 åˆ†é’Ÿã€‚</li><li><strong>ä»£ç å—</strong> <code>!this.isSelfPreservationModeEnabled()</code> ï¼šå½“<strong>æœªå¼€å¯</strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œæ¯æ¬¡éƒ½è¿›è¡Œé‡æ–°è®¡ç®—ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸ä»…ä»…è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ä¼šä½¿ç”¨åˆ°ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›† <code>numberOfRenewsPerMinThreshold</code>ã€<code>expectedNumberOfRenewsPerMin</code>ã€‚</li><li><strong>ä»£ç å—</strong> <code>(count * 2) &gt; (serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold)</code> ï¼šå½“<strong>å¼€å¯</strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œåº”ç”¨å®ä¾‹æ¯åˆ†é’Ÿæœ€å¤§å¿ƒè·³æ•°( <code>count * 2</code> ) å°äºæœŸæœ›<strong>æœ€å°</strong>æ¯åˆ†é’Ÿ<strong>ç»­ç§Ÿ</strong>æ¬¡æ•°( <code>serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold</code> )ï¼Œä¸é‡æ–°è®¡ç®—ã€‚<strong>å¦‚æœé‡æ–°è®¡ç®—ï¼Œè‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ä¼šæ¯æ¬¡å®šæ—¶æ‰§è¡Œåå¤±æ•ˆ</strong>ã€‚</li></ul><h3>3.3.3 åº”ç”¨å®ä¾‹æ³¨å†Œ</h3><p>åº”ç”¨å®ä¾‹æ³¨å†Œæ—¶ï¼Œå¢åŠ  <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    </div><div class="line">    <span class="comment">// The lease does not exist and hence it is a new registration</span></div><div class="line">    <span class="comment">// ã€è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‘å¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line">    <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line">             <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></div><div class="line">             <span class="comment">// (1</span></div><div class="line">             <span class="comment">// for 30 seconds, 2 for a minute)</span></div><div class="line">             <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</div><div class="line">             <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</div><div class="line">                     (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.3.4 åº”ç”¨å®ä¾‹ä¸‹çº¿</h3><p>åº”ç”¨å®ä¾‹ä¸‹çº¿æ—¶ï¼Œå‡å°‘ <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code> ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></div><div class="line"><span class="function"><span class="params">                     <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                     </div><div class="line">   <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)</span></div><div class="line">               <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin - <span class="number">2</span>;</div><div class="line">               <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line">        &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>ğŸ˜ˆ ç»ˆäºå®Œæ•´ç†è§£ Eureka-Server è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œæ»¡è¶³ã€‚å™¶~~~~~~</p><p>æ¨èå¦ä¸€ç¯‡ Eureka-Server è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æºç åˆ†ææ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000009795944" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç†è§£eurekaçš„è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-self-preservation/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.c
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸‰ï¼‰ä¹‹ä¸‹çº¿</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-cancel/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-cancel/</id>
    <published>2018-06-07T16:00:00.000Z</published>
    <updated>2017-10-06T13:18:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-cancel/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">2. Eureka-Client å‘èµ·ä¸‹çº¿</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">3. Eureka-Server æ¥æ”¶ä¸‹çº¿</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">3.1 æ¥æ”¶ä¸‹çº¿è¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server ä¸‹çº¿åº”ç”¨å®ä¾‹çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> äºŒæ¬¡ç¼–è¾‘<br><img src="../../../images/Eureka/2018_06_08/01.jpeg" alt=""></p></blockquote><ul><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚</li><li>é<strong>è“æ¡†</strong>éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li></ul><h1>2. Eureka-Client å‘èµ·ä¸‹çº¿</h1><p>åº”ç”¨å®ä¾‹å…³é—­æ—¶ï¼ŒEureka-Client å‘ Eureka-Server å‘èµ·ä¸‹çº¿åº”ç”¨å®ä¾‹ã€‚éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶æ‰å¯å‘èµ·ï¼š</p><ul><li>é…ç½® <code>eureka.registration.enabled = true</code> ï¼Œåº”ç”¨å®ä¾‹å¼€å¯æ³¨å†Œå¼€å…³ã€‚é»˜è®¤ä¸º <code>false</code> ã€‚</li><li>é…ç½® <code>eureka.shouldUnregisterOnShutdown = true</code> ï¼Œåº”ç”¨å®ä¾‹å¼€å¯å…³é—­æ—¶ä¸‹çº¿å¼€å…³ã€‚é»˜è®¤ä¸º <code>true</code> ã€‚</li></ul><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">    <span class="comment">// If APPINFO was registered</span></div><div class="line">    <span class="keyword">if</span> (applicationInfoManager != <span class="keyword">null</span></div><div class="line">         &amp;&amp; clientConfig.shouldRegisterWithEureka() <span class="comment">// eureka.registration.enabled = true</span></div><div class="line">         &amp;&amp; clientConfig.shouldUnregisterOnShutdown()) &#123; <span class="comment">// eureka.shouldUnregisterOnShutdown = true</span></div><div class="line">        applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</div><div class="line">        unregister();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ApplicationInfoManager#setInstanceStatus(...)</code> æ–¹æ³•ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹ä¸ºå…³é—­( DOWN )ã€‚</p></li><li><p>è°ƒç”¨ <code>#unregister()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// It can be null if shouldRegisterWithEureka == false</span></div><div class="line">   <span class="keyword">if</span>(eurekaTransport != <span class="keyword">null</span> &amp;&amp; eurekaTransport.registrationClient != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           logger.info(<span class="string">"Unregistering ..."</span>);</div><div class="line">           EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());</div><div class="line">           logger.info(PREFIX + appPathIdentifier + <span class="string">" - deregister  status: "</span> + httpResponse.getStatusCode());</div><div class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">           logger.error(PREFIX + appPathIdentifier + <span class="string">" - de-registration failed"</span> + e.getMessage(), e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">cancel</span><span class="params">(String appName, String id)</span> </span>&#123;</div><div class="line">    String urlPath = <span class="string">"apps/"</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">    ClientResponse response = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</div><div class="line">        addExtraHeaders(resourceBuilder);</div><div class="line">        response = resourceBuilder.delete(ClientResponse.class);</div><div class="line">        <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"Jersey HTTP DELETE &#123;&#125;/&#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">            response.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#cancel(...)</code> æ–¹æ³•ï¼Œ<code>DELETE</code> è¯·æ±‚ Eureka-Server çš„ <code>apps/${APP_NAME}/${INSTANCE_INFO_ID}</code> æ¥å£ï¼Œå®ç°åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ä¸‹çº¿ã€‚</li></ul></li></ul><h1>3. Eureka-Server æ¥æ”¶ä¸‹çº¿</h1><h2>3.1 æ¥æ”¶ä¸‹çº¿è¯·æ±‚</h2><p><code>com.netflix.eureka.resources.InstanceResource</code>ï¼Œå¤„ç†<strong>å•ä¸ª</strong>åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ <code>InstanceResource#cancelLease()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">cancelLease</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">       @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</div><div class="line">   <span class="comment">// ä¸‹çº¿</span></div><div class="line">   <span class="keyword">boolean</span> isSuccess = registry.cancel(app.getName(), id, <span class="string">"true"</span>.equals(isReplication));</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (isSuccess) &#123; <span class="comment">// ä¸‹çº¿æˆåŠŸ</span></div><div class="line">       logger.debug(<span class="string">"Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</div><div class="line">       <span class="keyword">return</span> Response.ok().build();</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä¸‹çº¿æˆåŠŸ</span></div><div class="line">       logger.info(<span class="string">"Not Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</div><div class="line">       <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#cancel(...)</code> æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                       <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (<span class="keyword">super</span>.cancel(appName, id, isReplication)) &#123; <span class="comment">// ä¸‹çº¿</span></div><div class="line"> <span class="number">5</span>:         <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line"> <span class="number">6</span>:         replicateToPeers(Action.Cancel, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</div><div class="line"> <span class="number">7</span>:         <span class="comment">// å‡å°‘ `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">10</span>:                 <span class="comment">// Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)</span></div><div class="line"><span class="number">11</span>:                 <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin - <span class="number">2</span>;</div><div class="line"><span class="number">12</span>:                 <span class="keyword">this</span>.numberOfRenewsPerMinThreshold = (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">18</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 4 è¡Œ ï¼šè°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#cancel(...)</code> æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li><li>ç¬¬ 6 è¡Œ ï¼šEureka-Server å¤åˆ¶ä¸‹çº¿æ“ä½œï¼Œåœ¨TODO[0021]ï¼šé›†ç¾¤åŒæ­¥ã€‚</li><li>ç¬¬ 7 è‡³ 14 è¡Œ ï¼šå‡å°‘ <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code>ï¼Œè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#cancel(...)</code> æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">return</span> internalCancel(appName, id, isReplication);</div><div class="line"> <span class="number">4</span>: &#125;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">internalCancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾—é” TODO èŠ‹è‰¿ï¼šç–‘é—®</span></div><div class="line"> <span class="number">9</span>:         read.lock();</div><div class="line"><span class="number">10</span>:         <span class="comment">// å¢åŠ  å–æ¶ˆæ³¨å†Œæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"><span class="number">11</span>:         CANCEL.increment(isReplication);</div><div class="line"><span class="number">12</span>:         <span class="comment">// ç§»é™¤ ç§Ÿçº¦æ˜ å°„</span></div><div class="line"><span class="number">13</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line"><span class="number">14</span>:         Lease&lt;InstanceInfo&gt; leaseToCancel = <span class="keyword">null</span>;</div><div class="line"><span class="number">15</span>:         <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:             leaseToCancel = gMap.remove(id);</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:         <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘å–æ¶ˆæ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="number">19</span>:         <span class="keyword">synchronized</span> (recentCanceledQueue) &#123;</div><div class="line"><span class="number">20</span>:             recentCanceledQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(System.currentTimeMillis(), appName + <span class="string">"("</span> + id + <span class="string">")"</span>));</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:         <span class="comment">// TODO èŠ‹è‰¿ï¼šçœ‹ä¸æ‡‚</span></div><div class="line"><span class="number">23</span>:         InstanceStatus instanceStatus = overriddenInstanceStatusMap.remove(id);</div><div class="line"><span class="number">24</span>:         <span class="keyword">if</span> (instanceStatus != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">25</span>:             logger.debug(<span class="string">"Removed instance id &#123;&#125; from the overridden map which has value &#123;&#125;"</span>, id, instanceStatus.name());</div><div class="line"><span class="number">26</span>:         &#125;</div><div class="line"><span class="number">27</span>:         <span class="comment">// ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (leaseToCancel == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">29</span>:             CANCEL_NOT_FOUND.increment(isReplication); <span class="comment">// æ·»åŠ  å–æ¶ˆæ³¨å†Œä¸å­˜åœ¨ åˆ° ç›‘æ§</span></div><div class="line"><span class="number">30</span>:             logger.warn(<span class="string">"DS: Registry: cancel failed because Lease is not registered for: &#123;&#125;/&#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">31</span>:             <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// å¤±è´¥</span></div><div class="line"><span class="number">32</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">33</span>:             <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„å–æ¶ˆæ³¨å†Œæ—¶é—´æˆ³</span></div><div class="line"><span class="number">34</span>:             leaseToCancel.cancel();</div><div class="line"><span class="number">35</span>:             <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="number">36</span>:             InstanceInfo instanceInfo = leaseToCancel.getHolder();</div><div class="line"><span class="number">37</span>:             String vip = <span class="keyword">null</span>;</div><div class="line"><span class="number">38</span>:             String svip = <span class="keyword">null</span>;</div><div class="line"><span class="number">39</span>:             <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">40</span>:                 instanceInfo.setActionType(ActionType.DELETED);</div><div class="line"><span class="number">41</span>:                 recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(leaseToCancel));</div><div class="line"><span class="number">42</span>:                 instanceInfo.setLastUpdatedTimestamp();</div><div class="line"><span class="number">43</span>:                 vip = instanceInfo.getVIPAddress();</div><div class="line"><span class="number">44</span>:                 svip = instanceInfo.getSecureVipAddress();</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:             <span class="comment">// è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"><span class="number">47</span>:             invalidateCache(appName, vip, svip);</div><div class="line"><span class="number">48</span>:             logger.info(<span class="string">"Cancelled instance &#123;&#125;/&#123;&#125; (replication=&#123;&#125;)"</span>, appName, id, isReplication);</div><div class="line"><span class="number">49</span>:             <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// æˆåŠŸ</span></div><div class="line"><span class="number">50</span>:         &#125;</div><div class="line"><span class="number">51</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">52</span>:         <span class="comment">// é‡Šæ”¾é”</span></div><div class="line"><span class="number">53</span>:         read.unlock();</div><div class="line"><span class="number">54</span>:     &#125;</div><div class="line"><span class="number">55</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 9 è¡Œ ï¼šTODO ä¸ºä»€ä¹ˆæ˜¯è¯»é”ã€‚</p></li><li><p>ç¬¬ 10 è‡³ 11 è¡Œ ï¼šå¢åŠ ä¸‹çº¿æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 12 è‡³ 17 è¡Œ ï¼šç§»é™¤ç§Ÿçº¦æ˜ å°„( <code>registry</code> )ã€‚</p></li><li><p>ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ åˆ°æœ€è¿‘ä¸‹çº¿çš„<strong>è°ƒè¯•</strong>é˜Ÿåˆ—( <code>recentCanceledQueue</code> )ï¼Œç”¨äº Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤ºï¼Œæ— å®é™…ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘å–æ¶ˆæ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">* key ï¼šæ·»åŠ æ—¶çš„æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">* value ï¼šå­—ç¬¦ä¸² = åº”ç”¨å(åº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å·)</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CircularQueue&lt;Pair&lt;Long, String&gt;&gt; recentCanceledQueue;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šTODO[0022]ï¼šçŠ¶æ€æ›´æ–°ã€‚</p></li><li><p>ç¬¬ 27 è‡³ 31 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›ä¸‹çº¿å¤±è´¥( <code>false</code> )ã€‚</p></li><li><p>ç¬¬ 34 è¡Œ ï¼šè°ƒç”¨ <code>Lease#cancel()</code> æ–¹æ³•ï¼Œå–æ¶ˆç§Ÿçº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lease.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (evictionTimestamp &lt;= <span class="number">0</span>) &#123;</div><div class="line">       evictionTimestamp = System.currentTimeMillis();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„<strong>æ“ä½œç±»å‹ä¸ºæ·»åŠ </strong>ï¼Œå¹¶æ·»åŠ åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( <code>recentlyChangedQueue</code> )ã€‚<code>recentlyChangedQueue</code> ç”¨äºæ³¨å†Œä¿¡æ¯çš„<strong>å¢é‡</strong>è·å–ï¼Œåœ¨<a href="TODO">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆäº”ï¼‰ä¹‹å¢é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt;();</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 47 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜( ResponseCache )è¿‡æœŸï¼Œåœ¨<a href="TODO">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆäº”ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 49 è¡Œ ï¼šè¿”å›ä¸‹çº¿å¤±è´¥( <code>false</code> )ã€‚</p></li><li><p>ç¬¬ 53 è¡Œ ï¼šé‡Šæ”¾é”ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>æ°´æ›´ä¸€ç¯‡ï¼Œä¸‹ä¸€ç¯‡<strong>ç§Ÿçº¦è¿‡æœŸ</strong>ï¼èµ°èµ·ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-cancel/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka/in
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿ</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-renew/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-renew/</id>
    <published>2018-05-31T16:00:00.000Z</published>
    <updated>2017-10-06T11:13:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-renew/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2. Eureka-Client å‘èµ·ç»­ç§Ÿ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2.1 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2.2 HeartbeatThread</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">2.3 TimedSupervisorTask</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">3. Eureka-Server æ¥æ”¶ç»­ç§Ÿ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">3.1 æ¥æ”¶ç»­ç§Ÿè¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">3.2 ç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-renew/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server ç»­ç§Ÿåº”ç”¨å®ä¾‹çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> äºŒæ¬¡ç¼–è¾‘<br><img src="http://www.iocoder.cn/images/Eureka/2018_06_01/01.jpeg" alt=""></p></blockquote><ul><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚</li><li>é<strong>è“æ¡†</strong>éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li></ul><h1>2. Eureka-Client å‘èµ·ç»­ç§Ÿ</h1><p>Eureka-Client å‘ Eureka-Server å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹æˆåŠŸåè·å¾—ç§Ÿçº¦ ( Lease )ã€‚Eureka-Client <strong>å›ºå®šé—´éš”</strong>å‘ Eureka-Server å‘èµ·<strong>ç»­ç§Ÿ</strong>( renew )ï¼Œé¿å…ç§Ÿçº¦è¿‡æœŸã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç§Ÿçº¦æœ‰æ•ˆæœŸä¸º 90 ç§’ï¼Œç»­ç§Ÿé¢‘ç‡ä¸º 30 ç§’ã€‚ä¸¤è€…æ¯”ä¾‹ä¸º 1 : 3 ï¼Œä¿è¯åœ¨ç½‘ç»œå¼‚å¸¸ç­‰æƒ…å†µä¸‹ï¼Œæœ‰ä¸‰æ¬¡é‡è¯•çš„æœºä¼šã€‚</p><h2>2.1 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</h2><p>Eureka-Client åœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/?self">åˆå§‹åŒ–</a>è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º<strong>å¿ƒè·³</strong>çº¿ç¨‹ï¼Œ<strong>å›ºå®šé—´éš”</strong>å‘ Eureka-Server å‘èµ·<strong>ç»­ç§Ÿ</strong>( renew )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"></div><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">               Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">               <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                       .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">                       .setDaemon(<span class="keyword">true</span>)</div><div class="line">                       .build());</div><div class="line"></div><div class="line">    heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">              <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">              <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">              <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                      .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</div><div class="line">                      .setDaemon(<span class="keyword">true</span>)</div><div class="line">                      .build()</div><div class="line">    );  <span class="comment">// use direct handoff</span></div><div class="line">      </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">  </div><div class="line">    <span class="comment">// ã€3.2.14ã€‘åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</span></div><div class="line">    initScheduledTasks();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">    <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">        <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs(); <span class="comment">// ç»­ç§Ÿé¢‘ç‡</span></div><div class="line">        <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound(); <span class="comment">//</span></div><div class="line">        logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</div><div class="line"></div><div class="line">        <span class="comment">// Heartbeat timer</span></div><div class="line">        scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"heartbeat"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       heartbeatExecutor,</div><div class="line">                       renewalIntervalInSecs,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> HeartbeatThread()</div><div class="line">               ),</div><div class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</div><div class="line">               </div><div class="line">          <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">     &#125;</div><div class="line">     <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>scheduler</code>ï¼Œå®šæ—¶ä»»åŠ¡æœåŠ¡ï¼Œç”¨äºå®šæ—¶è§¦å‘å¿ƒè·³( ç»­ç§Ÿ )ã€‚ç»†å¿ƒå¦‚ä½ ï¼Œä¼šå‘ç°ä»»åŠ¡æäº¤çš„æ–¹å¼æ˜¯ <code>ScheduledExecutorService#schedule(...)</code> æ–¹æ³•ï¼Œ<strong>åªå»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡å¿ƒè·³ï¼Œè¯´å¥½çš„å›ºå®šé¢‘ç‡æ‰§è¡Œå¿ƒè·³å‘¢</strong>ï¼ï¼ï¼ç­”æ¡ˆåœ¨ <a href="#">ã€Œ2.3 TimedSupervisorTaskã€</a> æ­æ™“ã€‚</li><li><code>heartbeatExecutor</code>ï¼Œå¿ƒè·³ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± ã€‚ä¸ºä»€ä¹ˆæœ‰ <code>scheduler</code> çš„æƒ…å†µä¸‹ï¼Œè¿˜æœ‰ <code>heartbeatExecutor</code> ï¼Ÿï¼Ÿï¼Ÿç­”æ¡ˆä¹Ÿåœ¨ <a href="#">ã€Œ2.3 TimedSupervisorTaskã€</a> æ­æ™“ã€‚</li><li>HeartbeatThreadï¼Œå¿ƒè·³çº¿ç¨‹ï¼Œåœ¨<a href="#">ã€Œ2.2 TimedSupervisorTaskã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>2.2 HeartbeatThread</h2><p><code>com.netflix.discovery.DiscoveryClient.HeartbeatThread</code>ï¼Œå¿ƒè·³çº¿ç¨‹ï¼Œ<strong>å®ç°</strong>æ‰§è¡Œ Eureka-Client å‘ Eureka-Server å‘èµ·<strong>ç»­ç§Ÿ</strong>( renew )è¯·æ±‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸå‘ Eureka-Server å¿ƒè·³æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (renew()) &#123;</div><div class="line">           lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#renew</code> æ–¹æ³•ï¼Œæ‰§è¡Œç»­ç§Ÿé€»è¾‘ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">   EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</div><div class="line">       logger.debug(<span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</div><div class="line">       <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) &#123;</div><div class="line">           REREGISTER_COUNTER.increment();</div><div class="line">           logger.info(<span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</div><div class="line">           <span class="keyword">long</span> timestamp = instanceInfo.setIsDirtyWithTime();</div><div class="line">           <span class="comment">// å‘èµ·æ³¨å†Œ</span></div><div class="line">           <span class="keyword">boolean</span> success = register();</div><div class="line">           <span class="keyword">if</span> (success) &#123;</div><div class="line">               instanceInfo.unsetIsDirty(timestamp);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> success;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#sendHeartBeat(...)</code> æ–¹æ³•ï¼Œå‘èµ·<strong>ç»­ç§Ÿè¯·æ±‚</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;InstanceInfo&gt; <span class="title">sendHeartBeat</span><span class="params">(String appName, String id, InstanceInfo info, InstanceStatus overriddenStatus)</span> </span>&#123;</div><div class="line">   String urlPath = <span class="string">"apps/"</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">   ClientResponse response = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       WebResource webResource = jerseyClient.resource(serviceUrl)</div><div class="line">               .path(urlPath)</div><div class="line">               .queryParam(<span class="string">"status"</span>, info.getStatus().toString())</div><div class="line">               .queryParam(<span class="string">"lastDirtyTimestamp"</span>, info.getLastDirtyTimestamp().toString());</div><div class="line">       <span class="keyword">if</span> (overriddenStatus != <span class="keyword">null</span>) &#123;</div><div class="line">           webResource = webResource.queryParam(<span class="string">"overriddenstatus"</span>, overriddenStatus.name());</div><div class="line">       &#125;</div><div class="line">       Builder requestBuilder = webResource.getRequestBuilder();</div><div class="line">       addExtraHeaders(requestBuilder);</div><div class="line">       response = requestBuilder.put(ClientResponse.class);</div><div class="line">       EurekaHttpResponseBuilder&lt;InstanceInfo&gt; eurekaResponseBuilder = anEurekaHttpResponse(response.getStatus(), InstanceInfo.class).headers(headersOf(response));</div><div class="line">       <span class="keyword">if</span> (response.hasEntity()) &#123;</div><div class="line">           eurekaResponseBuilder.entity(response.getEntity(InstanceInfo.class));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> eurekaResponseBuilder.build();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Jersey HTTP PUT &#123;&#125;/&#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">           response.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>PUT è¯·æ±‚ Eureka-Server çš„ <code>apps/${APP_NAME}/${INSTANCE_INFO_ID}</code> æ¥å£ï¼Œå‚æ•°ä¸º <code>status</code>ã€<code>lastDirtyTimestamp</code>ã€<code>overriddenstatus</code>ï¼Œå®ç°ç»­ç§Ÿã€‚</li></ul></li><li><p>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#register(...)</code> æ–¹æ³•ï¼Œå½“ Eureka-Server <strong>ä¸å­˜åœ¨ç§Ÿçº¦</strong>æ—¶ï¼Œé‡æ–°å‘èµ·æ³¨å†Œï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h2>2.3 TimedSupervisorTask</h2><p><code>com.netflix.discovery.TimedSupervisorTask</code>ï¼Œç›‘ç®¡<strong>å®šæ—¶ä»»åŠ¡</strong>çš„ä»»åŠ¡ã€‚</p><blockquote><p>A supervisor task that schedules subtasks while enforce a timeout.</p></blockquote><p>åˆ›å»º TimedSupervisorTask ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimedSupervisorTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter timeoutCounter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter rejectedCounter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter throwableCounter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LongGauge threadPoolLevelGauge;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå­ä»»åŠ¡çº¿ç¨‹æ± </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor executor;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å­ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable task;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å½“å‰ä»»å­åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong delay;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€å¤§å­ä»»åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * å­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æƒ…å†µä¸‹ä½¿ç”¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> maxDelay;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimedSupervisorTask</span><span class="params">(String name, ScheduledExecutorService scheduler, ThreadPoolExecutor executor,</span></span></div><div class="line"><span class="function"><span class="params">                               <span class="keyword">int</span> timeout, TimeUnit timeUnit, <span class="keyword">int</span> expBackOffBound, Runnable task)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.scheduler = scheduler;</div><div class="line">        <span class="keyword">this</span>.executor = executor;</div><div class="line">        <span class="keyword">this</span>.timeoutMillis = timeUnit.toMillis(timeout);</div><div class="line">        <span class="keyword">this</span>.task = task;</div><div class="line">        <span class="keyword">this</span>.delay = <span class="keyword">new</span> AtomicLong(timeoutMillis);</div><div class="line">        <span class="keyword">this</span>.maxDelay = timeoutMillis * expBackOffBound;</div><div class="line"></div><div class="line">        <span class="comment">// Initialize the counters and register.</span></div><div class="line">        timeoutCounter = Monitors.newCounter(<span class="string">"timeouts"</span>);</div><div class="line">        rejectedCounter = Monitors.newCounter(<span class="string">"rejectedExecutions"</span>);</div><div class="line">        throwableCounter = Monitors.newCounter(<span class="string">"throwables"</span>);</div><div class="line">        threadPoolLevelGauge = <span class="keyword">new</span> LongGauge(MonitorConfig.builder(<span class="string">"threadPoolUsed"</span>).build());</div><div class="line">        Monitors.registerObject(name, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>scheduler</code> ï¼Œå®šæ—¶ä»»åŠ¡æœåŠ¡ï¼Œç”¨äºå®šæ—¶ã€<strong>å‘èµ·</strong>ã€‘å­ä»»åŠ¡ã€‚</li><li><code>executor</code> ï¼Œæ‰§è¡Œå­ä»»åŠ¡çº¿ç¨‹æ± ï¼Œç”¨äºã€<strong>æäº¤</strong>ã€‘å­ä»»åŠ¡æ‰§è¡Œã€‚</li><li><code>task</code> ï¼Œå­ä»»åŠ¡ã€‚</li><li><code>timeoutMillis</code> ï¼Œå­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li><li><code>delay</code> ï¼Œå½“å‰å­ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å€¼ç­‰äº <code>timeout</code> å‚æ•°ã€‚</li><li><code>maxDelay</code> ï¼Œ<strong>æœ€å¤§</strong>å­ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å€¼ç­‰äº <code>timeout * expBackOffBound</code> å‚æ•°ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Eureka/2018_06_01/02.png" alt=""></p><ul><li><code>scheduler</code> åˆå§‹åŒ–å»¶è¿Ÿæ‰§è¡Œ TimedSupervisorTask ã€‚</li><li>TimedSupervisorTask æ‰§è¡Œæ—¶ï¼Œæäº¤ <code>task</code> åˆ° <code>executor</code> æ‰§è¡Œä»»åŠ¡ã€‚<ul><li>å½“ <code>task</code> æ‰§è¡Œæ­£å¸¸ï¼ŒTimedSupervisorTask <strong>å†æ¬¡</strong>æäº¤<strong>è‡ªå·±</strong>åˆ°<code>scheduler</code> å»¶è¿Ÿ <code>timeoutMillis</code> æ‰§è¡Œã€‚</li><li>å½“ <code>task</code> æ‰§è¡Œè¶…æ—¶ï¼Œé‡æ–°è®¡ç®—å»¶è¿Ÿæ—¶é—´( ä¸å…è®¸è¶…è¿‡ <code>maxDelay</code> )ï¼Œ<strong>å†æ¬¡</strong>æäº¤<strong>è‡ªå·±</strong>åˆ°<code>scheduler</code> å»¶è¿Ÿæ‰§è¡Œã€‚</li></ul></li></ul><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TimedSupervisorTask.java</span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     Future&lt;?&gt; future = <span class="keyword">null</span>;</div><div class="line">  <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">5</span>:         <span class="comment">// æäº¤ ä»»åŠ¡</span></div><div class="line">  <span class="number">6</span>:         future = executor.submit(task);</div><div class="line">  <span class="number">7</span>:         <span class="comment">//</span></div><div class="line">  <span class="number">8</span>:         threadPoolLevelGauge.set((<span class="keyword">long</span>) executor.getActiveCount());</div><div class="line">  <span class="number">9</span>:         <span class="comment">// ç­‰å¾…ä»»åŠ¡ æ‰§è¡Œå®Œæˆ æˆ– è¶…æ—¶</span></div><div class="line"> <span class="number">10</span>:         future.get(timeoutMillis, TimeUnit.MILLISECONDS);  <span class="comment">// block until done or timeout</span></div><div class="line"> <span class="number">11</span>:         <span class="comment">// è®¾ç½® ä¸‹ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"> <span class="number">12</span>:         delay.set(timeoutMillis);</div><div class="line"> <span class="number">13</span>:         <span class="comment">//</span></div><div class="line"> <span class="number">14</span>:         threadPoolLevelGauge.set((<span class="keyword">long</span>) executor.getActiveCount());</div><div class="line"> <span class="number">15</span>:     &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</div><div class="line"> <span class="number">16</span>:         logger.error(<span class="string">"task supervisor timed out"</span>, e);</div><div class="line"> <span class="number">17</span>:         timeoutCounter.increment(); <span class="comment">//</span></div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:         <span class="comment">// è®¾ç½® ä¸‹ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œé¢‘ç‡</span></div><div class="line"> <span class="number">20</span>:         <span class="keyword">long</span> currentDelay = delay.get();</div><div class="line"> <span class="number">21</span>:         <span class="keyword">long</span> newDelay = Math.min(maxDelay, currentDelay * <span class="number">2</span>);</div><div class="line"> <span class="number">22</span>:         delay.compareAndSet(currentDelay, newDelay);</div><div class="line"> <span class="number">23</span>: </div><div class="line"> <span class="number">24</span>:     &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (executor.isShutdown() || scheduler.isShutdown()) &#123;</div><div class="line"> <span class="number">26</span>:             logger.warn(<span class="string">"task supervisor shutting down, reject the task"</span>, e);</div><div class="line"> <span class="number">27</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">28</span>:             logger.error(<span class="string">"task supervisor rejected the task"</span>, e);</div><div class="line"> <span class="number">29</span>:         &#125;</div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:         rejectedCounter.increment(); <span class="comment">//</span></div><div class="line"> <span class="number">32</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">33</span>:         <span class="keyword">if</span> (executor.isShutdown() || scheduler.isShutdown()) &#123;</div><div class="line"> <span class="number">34</span>:             logger.warn(<span class="string">"task supervisor shutting down, can't accept the task"</span>);</div><div class="line"> <span class="number">35</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">36</span>:             logger.error(<span class="string">"task supervisor threw an exception"</span>, e);</div><div class="line"> <span class="number">37</span>:         &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:         throwableCounter.increment(); <span class="comment">//</span></div><div class="line"> <span class="number">40</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"> <span class="number">41</span>:         <span class="comment">// å–æ¶ˆ æœªå®Œæˆçš„ä»»åŠ¡</span></div><div class="line"> <span class="number">42</span>:         <span class="keyword">if</span> (future != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">43</span>:             future.cancel(<span class="keyword">true</span>);</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="comment">// è°ƒåº¦ ä¸‹æ¬¡ä»»åŠ¡</span></div><div class="line"> <span class="number">47</span>:         <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</div><div class="line"> <span class="number">48</span>:             scheduler.schedule(<span class="keyword">this</span>, delay.get(), TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">49</span>:         &#125;</div><div class="line"> <span class="number">50</span>:     &#125;</div><div class="line"> <span class="number">51</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è‡³ 6 è¡Œ ï¼šæäº¤å­ä»»åŠ¡ <code>task</code> åˆ°æ‰§è¡Œå­ä»»åŠ¡çº¿ç¨‹æ±  <code>executor</code> ã€‚</li><li>ç¬¬ 9 è‡³ 10 è¡Œ ï¼šç­‰å¾…å­ä»»åŠ¡ <code>task</code> æ‰§è¡Œå®Œæˆæˆ–æ‰§è¡Œè¶…æ—¶ã€‚</li><li>ç¬¬ 11 è‡³ 12 è¡Œ ï¼šå­ä»»åŠ¡ <code>task</code> æ‰§è¡Œå®Œæˆï¼Œè®¾ç½®ä¸‹ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿ <code>delay</code> ã€‚</li><li>ç¬¬ 19 è‡³ 22 è¡Œ ï¼šå­ä»»åŠ¡ <code>task</code> æ‰§è¡Œè¶…æ—¶ï¼Œé‡æ–°è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿ <code>delay</code> ã€‚è®¡ç®—å…¬å¼ä¸º <code>Math.min(maxDelay, currentDelay * 2)</code> ã€‚å¦‚æœå¤šæ¬¡è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´ä¸æ–­ä¹˜ä»¥ 2 ï¼Œä¸å…è®¸è¶…è¿‡æœ€å¤§å»¶è¿Ÿæ—¶é—´( <code>maxDelay</code> )ã€‚</li><li>ç¬¬ 41 è‡³ 44 è¡Œ ï¼š<strong>å¼ºåˆ¶</strong>å–æ¶ˆæœªå®Œæˆçš„å­ä»»åŠ¡ã€‚</li><li>ç¬¬ 46 è‡³ 49 è¡Œ ï¼šè°ƒåº¦ä¸‹ä¸€æ¬¡ TimedSupervisorTask ã€‚</li></ul><h1>3. Eureka-Server æ¥æ”¶ç»­ç§Ÿ</h1><h2>3.1 æ¥æ”¶ç»­ç§Ÿè¯·æ±‚</h2><p><code>com.netflix.eureka.resources.InstanceResource</code>ï¼Œå¤„ç†<strong>å•ä¸ª</strong>åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>ç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ <code>InstanceResource#renewLease()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@PUT</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">renewLease</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:         @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></div><div class="line"><span class="function"> 4:         @<span class="title">QueryParam</span><span class="params">(<span class="string">"overriddenstatus"</span>)</span> String overriddenStatus,</span></div><div class="line"><span class="function"> 5:         @<span class="title">QueryParam</span><span class="params">(<span class="string">"status"</span>)</span> String status,</span></div><div class="line"><span class="function"> 6:         @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">boolean</span> isFromReplicaNode = <span class="string">"true"</span>.equals(isReplication);</div><div class="line"> <span class="number">8</span>:     <span class="comment">// ç»­ç§Ÿ</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// ç»­ç§Ÿå¤±è´¥</span></div><div class="line"><span class="number">12</span>:     <span class="comment">// Not found in the registry, immediately ask for a register</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">if</span> (!isSuccess) &#123;</div><div class="line"><span class="number">14</span>:         logger.warn(<span class="string">"Not Found (Renew): &#123;&#125; - &#123;&#125;"</span>, app.getName(), id);</div><div class="line"><span class="number">15</span>:         <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="comment">// æ¯”è¾ƒ InstanceInfo çš„ lastDirtyTimestamp å±æ€§</span></div><div class="line"><span class="number">19</span>:     <span class="comment">// Check if we need to sync based on dirty time stamp, the client</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// instance might have changed some value</span></div><div class="line"><span class="number">21</span>:     Response response = <span class="keyword">null</span>;</div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (lastDirtyTimestamp != <span class="keyword">null</span> &amp;&amp; serverConfig.shouldSyncWhenTimestampDiffers()) &#123;</div><div class="line"><span class="number">23</span>:         response = <span class="keyword">this</span>.validateDirtyTimestamp(Long.valueOf(lastDirtyTimestamp), isFromReplicaNode);</div><div class="line"><span class="number">24</span>:         <span class="comment">// Store the overridden status since the validation found out the node that replicates wins</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">if</span> (response.getStatus() == Response.Status.NOT_FOUND.getStatusCode()</div><div class="line"><span class="number">26</span>:                 &amp;&amp; (overriddenStatus != <span class="keyword">null</span>)</div><div class="line"><span class="number">27</span>:                 &amp;&amp; !(InstanceStatus.UNKNOWN.name().equals(overriddenStatus))</div><div class="line"><span class="number">28</span>:                 &amp;&amp; isFromReplicaNode) &#123;</div><div class="line"><span class="number">29</span>:             registry.storeOverriddenStatusIfRequired(app.getAppName(), id, InstanceStatus.valueOf(overriddenStatus));</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// æˆåŠŸ</span></div><div class="line"><span class="number">32</span>:         response = Response.ok().build();</div><div class="line"><span class="number">33</span>:     &#125;</div><div class="line"><span class="number">34</span>:     logger.debug(<span class="string">"Found (Renew): &#123;&#125; - &#123;&#125;; reply status=&#123;&#125;"</span> + app.getName(), id, response.getStatus());</div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 8 è‡³ 9 è¡Œ ï¼šè°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#renew(...)</code> æ–¹æ³•ï¼Œç»­ç§Ÿã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">super</span>.renew(appName, id, isReplication)) &#123; <span class="comment">// ç»­ç§Ÿ</span></div><div class="line">       <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">       replicateToPeers(Action.Heartbeat, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#renew(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 16 è¡Œ ï¼šç»­ç§Ÿå¤±è´¥ï¼Œè¿”å› 404 å“åº”ã€‚å½“ Eureka-Client æ”¶åˆ° 404 å“åº”åï¼Œä¼šé‡æ–°å‘èµ· InstanceInfo çš„æ³¨å†Œã€‚</p></li><li><p>ç¬¬ 18 è‡³ 30 è¡Œ ï¼šæ¯”è¾ƒè¯·æ±‚çš„ <code>lastDirtyTimestamp</code> å’Œ Server çš„ InstanceInfo çš„ <code>lastDirtyTimestamp</code> å±æ€§å·®å¼‚ï¼Œéœ€è¦é…ç½® <code>eureka.syncWhenTimestampDiffers = true</code> ( é»˜è®¤å¼€å¯ )ã€‚</p><ul><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#validateDirtyTimestamp(...)</code> æ–¹æ³•ï¼Œæ¯”è¾ƒ <code>lastDirtyTimestamp</code> çš„å·®å¼‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceResource.java</span></div><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Response <span class="title">validateDirtyTimestamp</span><span class="params">(Long lastDirtyTimestamp, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="comment">// è·å– InstanceInfo</span></div><div class="line">  <span class="number">3</span>:     InstanceInfo appInfo = registry.getInstanceByAppAndId(app.getName(), id, <span class="keyword">false</span>);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">5</span>:         <span class="keyword">if</span> ((lastDirtyTimestamp != <span class="keyword">null</span>) &amp;&amp; (!lastDirtyTimestamp.equals(appInfo.getLastDirtyTimestamp()))) &#123;</div><div class="line">  <span class="number">6</span>:             Object[] args = &#123;id, appInfo.getLastDirtyTimestamp(), lastDirtyTimestamp, isReplication&#125;;</div><div class="line">  <span class="number">7</span>:             <span class="comment">// è¯·æ±‚ çš„ è¾ƒå¤§</span></div><div class="line">  <span class="number">8</span>:             <span class="keyword">if</span> (lastDirtyTimestamp &gt; appInfo.getLastDirtyTimestamp()) &#123;</div><div class="line">  <span class="number">9</span>:                 logger.debug(<span class="string">"Time to sync, since the last dirty timestamp differs -"</span></div><div class="line"> <span class="number">10</span>:                                 + <span class="string">" ReplicationInstance id : &#123;&#125;,Registry : &#123;&#125; Incoming: &#123;&#125; Replication: &#123;&#125;"</span>, args);</div><div class="line"> <span class="number">11</span>:                 <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</div><div class="line"> <span class="number">12</span>:             <span class="comment">// Server çš„ è¾ƒå¤§</span></div><div class="line"> <span class="number">13</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (appInfo.getLastDirtyTimestamp() &gt; lastDirtyTimestamp) &#123;</div><div class="line"> <span class="number">14</span>:                 <span class="comment">// In the case of replication, send the current instance info in the registry for the</span></div><div class="line"> <span class="number">15</span>:                 <span class="comment">// replicating node to sync itself with this one.</span></div><div class="line"> <span class="number">16</span>:                 <span class="keyword">if</span> (isReplication) &#123;</div><div class="line"> <span class="number">17</span>:                     logger.debug(</div><div class="line"> <span class="number">18</span>:                             <span class="string">"Time to sync, since the last dirty timestamp differs -"</span></div><div class="line"> <span class="number">19</span>:                                     + <span class="string">" ReplicationInstance id : &#123;&#125;,Registry : &#123;&#125; Incoming: &#123;&#125; Replication: &#123;&#125;"</span>,</div><div class="line"> <span class="number">20</span>:                             args);</div><div class="line"> <span class="number">21</span>:                     <span class="keyword">return</span> Response.status(Status.CONFLICT).entity(appInfo).build();</div><div class="line"> <span class="number">22</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">23</span>:                     <span class="keyword">return</span> Response.ok().build();</div><div class="line"> <span class="number">24</span>:                 &#125;</div><div class="line"> <span class="number">25</span>:             &#125;</div><div class="line"> <span class="number">26</span>:         &#125;</div><div class="line"> <span class="number">27</span>: </div><div class="line"> <span class="number">28</span>:     &#125;</div><div class="line"> <span class="number">29</span>:     <span class="keyword">return</span> Response.ok().build();</div><div class="line"> <span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šè¯·æ±‚çš„ <code>lastDirtyTimestamp</code> è¾ƒå¤§ï¼Œ<strong>æ„å‘³ç€è¯·æ±‚æ–¹( å¯èƒ½æ˜¯ Eureka-Client ï¼Œä¹Ÿå¯èƒ½æ˜¯ Eureka-Server é›†ç¾¤å†…çš„å…¶ä»– Server )å­˜åœ¨ InstanceInfo å’Œ Eureka-Server çš„ InstanceInfo çš„æ•°æ®ä¸ä¸€è‡´ï¼Œè¿”å› 404 å“åº”ã€‚è¯·æ±‚æ–¹æ”¶åˆ° 404 å“åº”åé‡æ–°å‘èµ·æ³¨å†Œ</strong>ã€‚</li><li>ç¬¬ 16 è‡³ 21 è¡Œ ï¼šTODO[0021]ï¼šé›†ç¾¤åŒæ­¥</li><li>ç¬¬ 22 è‡³ 24 è¡Œ ï¼šServer çš„ <code>lastDirtyTimestamp</code> è¾ƒå¤§ï¼Œå¹¶ä¸”è¯·æ±‚æ–¹ä¸º Eureka-Clientï¼Œç»­ç§ŸæˆåŠŸï¼Œè¿”å› 200 æˆåŠŸå“åº”ã€‚</li><li>ç¬¬ 29 è¡Œ ï¼š<code>lastDirtyTimestamp</code> ä¸€è‡´ï¼Œè¿”å› 200 æˆåŠŸå“åº”ã€‚</li></ul></li><li><p>ç¬¬ 24 è‡³ 30 è¡Œ ï¼šTODO[0022]ï¼šçŠ¶æ€æ›´æ–°ã€‚</p></li></ul></li><li><p>ç¬¬ 31 è‡³ 33 è¡Œ ï¼šç»­ç§ŸæˆåŠŸï¼Œè¿”å› 200 æˆåŠŸå“åº”ã€‚</p></li></ul><h2>3.2 ç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#renew(...)</code> æ–¹æ³•ï¼Œç»­ç§Ÿåº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å¢åŠ  ç»­ç§Ÿæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"> <span class="number">3</span>:     RENEW.increment(isReplication);</div><div class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— ç§Ÿçº¦</span></div><div class="line"> <span class="number">5</span>:     Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line"> <span class="number">6</span>:     Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">8</span>:         leaseToRenew = gMap.get(id);</div><div class="line"> <span class="number">9</span>:     &#125;</div><div class="line"><span class="number">10</span>:     <span class="comment">// ç§Ÿçº¦ä¸å­˜åœ¨</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">12</span>:         RENEW_NOT_FOUND.increment(isReplication);</div><div class="line"><span class="number">13</span>:         logger.warn(<span class="string">"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">14</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">15</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>:         InstanceInfo instanceInfo = leaseToRenew.getHolder();</div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">18</span>:             <span class="comment">// touchASGCache(instanceInfo.getASGName());</span></div><div class="line"><span class="number">19</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šover status</span></div><div class="line"><span class="number">20</span>:             InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</div><div class="line"><span class="number">21</span>:                     instanceInfo, leaseToRenew, isReplication);</div><div class="line"><span class="number">22</span>:             <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</div><div class="line"><span class="number">23</span>:                 logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></div><div class="line"><span class="number">24</span>:                         + <span class="string">"; re-register required"</span>, instanceInfo.getId());</div><div class="line"><span class="number">25</span>:                 RENEW_NOT_FOUND.increment(isReplication);</div><div class="line"><span class="number">26</span>:                 <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:             <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</div><div class="line"><span class="number">29</span>:                 Object[] args = &#123;</div><div class="line"><span class="number">30</span>:                         instanceInfo.getStatus().name(),</div><div class="line"><span class="number">31</span>:                         instanceInfo.getOverriddenStatus().name(),</div><div class="line"><span class="number">32</span>:                         instanceInfo.getId()</div><div class="line"><span class="number">33</span>:                 &#125;;</div><div class="line"><span class="number">34</span>:                 logger.info(</div><div class="line"><span class="number">35</span>:                         <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></div><div class="line"><span class="number">36</span>:                                 + <span class="string">"Hence setting the status to overridden status"</span>, args);</div><div class="line"><span class="number">37</span>:                 instanceInfo.setStatusWithoutDirty(overriddenInstanceStatus);</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:         &#125;</div><div class="line"><span class="number">40</span>:         <span class="comment">// æ–°å¢ ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</span></div><div class="line"><span class="number">41</span>:         renewsLastMin.increment();</div><div class="line"><span class="number">42</span>:         <span class="comment">// è®¾ç½® ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´ï¼ˆç»­ç§Ÿï¼‰</span></div><div class="line"><span class="number">43</span>:         leaseToRenew.renew();</div><div class="line"><span class="number">44</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 2 è‡³ 3 è¡Œ ï¼šå¢åŠ ç»­ç§Ÿæ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 4 è‡³ 9 è¡Œ ï¼šè·å¾—ç§Ÿçº¦( Lease )ã€‚</p></li><li><p>ç¬¬ 10 è‡³ 14 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›ç»­ç§Ÿå¤±è´¥( <code>false</code> )ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 39 è¡Œ ï¼šTODO[0022]ï¼šçŠ¶æ€æ›´æ–°ã€‚</p></li><li><p>ç¬¬ 40 è‡³ 41 è¡Œ ï¼šæ–°å¢ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°( <code>renewsLastMin</code> )ã€‚<code>com.netflix.eureka.util.MeasuredRate</code>ï¼Œé€Ÿåº¦æµ‹é‡ç±»ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> MeasuredRate renewsLastMin;</div><div class="line"></div><div class="line"><span class="comment">// MeasuredRate.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MeasuredRate</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸Šä¸€ä¸ªé—´éš”æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastBucket = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å½“å‰é—´éš”æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong currentBucket = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é—´éš”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> sampleInterval;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer timer;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isActive;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MeasuredRate</span><span class="params">(<span class="keyword">long</span> sampleInterval)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sampleInterval = sampleInterval;</div><div class="line">        <span class="keyword">this</span>.timer = <span class="keyword">new</span> Timer(<span class="string">"Eureka-MeasureRateTimer"</span>, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">this</span>.isActive = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isActive) &#123;</div><div class="line">            timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// Zero out the current bucket.</span></div><div class="line">                        lastBucket.set(currentBucket.getAndSet(<span class="number">0</span>));</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                        logger.error(<span class="string">"Cannot reset the Measured Rate"</span>, e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;, sampleInterval, sampleInterval);</div><div class="line"></div><div class="line">            isActive = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isActive) &#123;</div><div class="line">            timer.cancel();</div><div class="line">            isActive = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Returns the count in the last sample interval.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lastBucket.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Increments the count in the current sample interval.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</div><div class="line">        currentBucket.incrementAndGet();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>timer</code> ï¼Œå®šæ—¶å™¨ï¼Œè´Ÿè´£æ¯ä¸ª <code>sampleInterval</code> é—´éš”é‡ç½®<strong>å½“å‰æ¬¡æ•°</strong>( <code>currentBucket</code> )ï¼Œå¹¶å°†<strong>åŸå½“å‰æ¬¡æ•°</strong>è®¾ç½®åˆ°<strong>ä¸Šä¸€ä¸ªæ¬¡æ•°</strong>( <code>lastBucket</code> )ã€‚</li><li><code>#increment()</code> æ–¹æ³•ï¼Œè¿”å›<strong>å½“å‰æ¬¡æ•°</strong>( <code>currentBucket</code> )ã€‚</li><li><code>#getCount()</code> æ–¹æ³•ï¼Œè¿”å›<strong>ä¸Šä¸€ä¸ªæ¬¡æ•°</strong>( <code>lastBucket</code> )ã€‚</li><li><code>renewsLastMin</code> æœ‰å¦‚ä¸‹ç”¨é€”ï¼š<ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†<strong>ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</strong>ã€‚</li><li>Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤º<strong>ç»­ç§Ÿæ¯åˆ†é’Ÿæ¬¡æ•°</strong>ã€‚</li><li>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul></li><li><p>ç¬¬ 42 è‡³ 43 è¡Œ ï¼šè°ƒç”¨ <code>Lease#renew()</code> æ–¹æ³•ï¼Œè®¾ç½®ç§Ÿçº¦æœ€åæ›´æ–°æ—¶é—´( ç»­ç§Ÿ )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">    lastUpdateTimestamp = System.currentTimeMillis() + duration;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 44 è¡Œ ï¼šè¿”å›ç»­ç§ŸæˆåŠŸ( <code>true</code> )ã€‚</p></li><li><p><strong>æ•´ä¸ªè¿‡ç¨‹ä¿®æ”¹çš„ç§Ÿçº¦çš„è¿‡æœŸæ—¶é—´ï¼Œå³ä½¿å¹¶å‘è¯·æ±‚ï¼Œä¹Ÿä¸ä¼šå¯¹æ•°æ®çš„ä¸€è‡´æ€§äº§ç”Ÿä¸ä¸€è‡´çš„å½±å“ï¼Œå› æ­¤åƒæ³¨å†Œæ“ä½œä¸€æ ·åŠ é”</strong>ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>æ•ˆç‡æ¯”æƒ³è±¡çš„ä½ä¸€äº›ï¼ŒåŠ æ²¹ç»§ç»­æ›´æ–°ä¸‹ä¸€ç¯‡ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-renew/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka/ins
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œ</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-register/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-register/</id>
    <published>2018-05-27T16:00:00.000Z</published>
    <updated>2017-10-07T09:06:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-register/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2. Eureka-Client å‘èµ·æ³¨å†Œ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2.2 åˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">2.3 å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3. Eureka-Server æ¥æ”¶æ³¨å†Œ</a><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3.1 æ¥æ”¶æ³¨å†Œè¯·æ±‚</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3.2 Lease</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">3.3 æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-register/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹çš„è¿‡ç¨‹</strong>ã€‚</p><blockquote><p>FROM <a href="%E3%80%8Ahttp://techshow.ctrip.com/archives/1699.html%E3%80%8B">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> äºŒæ¬¡ç¼–è¾‘<br><img src="http://www.iocoder.cn/images/Eureka/2018_05_28/01.jpeg" alt=""></p></blockquote><ul><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚</li><li>é<strong>è“æ¡†</strong>éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. Eureka-Client å‘èµ·æ³¨å†Œ</h1><p>Eureka-Client å‘ Eureka-Server å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹éœ€è¦ç¬¦åˆå¦‚ä¸‹æ¡ä»¶ï¼š</p><ul><li>é…ç½® <code>eureka.registration.enabled = true</code>ï¼ŒEureka-Client å‘ Eureka-Server å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹çš„<strong>å¼€å…³</strong>ã€‚</li><li>InstanceInfo åœ¨ Eureka-Client å’Œ Eureka-Server æ•°æ®ä¸ä¸€è‡´ã€‚</li></ul><p>æ¯æ¬¡ InstanceInfo å‘ç”Ÿ<strong>å±æ€§å˜åŒ–</strong>æ—¶ï¼Œæ ‡è®° <code>isInstanceInfoDirty</code> å±æ€§ä¸º <code>true</code>ï¼Œè¡¨ç¤º InstanceInfo åœ¨ Eureka-Client å’Œ Eureka-Server æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦æ³¨å†Œã€‚å¦å¤–ï¼ŒInstanceInfo åˆšè¢«åˆ›å»ºæ—¶ï¼Œåœ¨ Eureka-Server ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šè¢«æ³¨å†Œã€‚</p><p>å½“ç¬¦åˆæ¡ä»¶æ—¶ï¼ŒInstanceInfo ä¸ä¼šç«‹å³å‘ Eureka-Server æ³¨å†Œï¼Œè€Œæ˜¯åå°çº¿ç¨‹<strong>å®šæ—¶</strong>æ³¨å†Œã€‚</p><p>å½“ InstanceInfo çš„çŠ¶æ€( <code>status</code> ) å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¹¶ä¸”é…ç½® <code>eureka.shouldOnDemandUpdateStatusChange = true</code> æ—¶ï¼Œç«‹å³å‘ Eureka-Server æ³¨å†Œã€‚<strong>å› ä¸ºçŠ¶æ€å±æ€§éå¸¸é‡è¦ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å»ºè®®å¼€å¯ï¼Œå½“ç„¶é»˜è®¤æƒ…å†µä¹Ÿæ˜¯å¼€å¯çš„</strong>ã€‚</p><p>Let's Goã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä»£ç çš„å®ç°ã€‚</p><h2>2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ApplicationInfoManager.StatusChangeListener statusChangeListener;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InstanceInfoReplicator instanceInfoReplicator;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">        </div><div class="line">            <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">            </div><div class="line">            <span class="comment">// åˆ›å»º åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</span></div><div class="line">            <span class="comment">// InstanceInfo replicator</span></div><div class="line">            instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</div><div class="line">                    <span class="keyword">this</span>,</div><div class="line">                    instanceInfo,</div><div class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</div><div class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></div><div class="line"></div><div class="line">            <span class="comment">// åˆ›å»º åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line">            statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</div><div class="line">                            InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</div><div class="line">                        <span class="comment">// log at warn level if DOWN was involved</span></div><div class="line">                        logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">                    &#125;</div><div class="line">                    instanceInfoReplicator.onDemandUpdate();</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="comment">// æ³¨å†Œ åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</div><div class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// å¼€å¯ åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨</span></div><div class="line">            instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.discovery.InstanceInfoReplicator</code>ï¼Œåº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€‚</p><ul><li><p>è°ƒç”¨ <code>InstanceInfoReplicator#start(...)</code> æ–¹æ³•ï¼Œ<strong>å¼€å¯</strong>åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfoReplicator.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(InstanceInfoReplicator.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo instanceInfo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> replicationIntervalSeconds;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶æ‰§è¡Œä»»åŠ¡çš„ Future</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Future&gt; scheduledPeriodicRef;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å¼€å¯è°ƒåº¦</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean started;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> burstSize; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> allowedRatePerMinute; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line"></div><div class="line">    InstanceInfoReplicator(DiscoveryClient discoveryClient, InstanceInfo instanceInfo, <span class="keyword">int</span> replicationIntervalSeconds, <span class="keyword">int</span> burstSize) &#123;</div><div class="line">        <span class="keyword">this</span>.discoveryClient = discoveryClient;</div><div class="line">        <span class="keyword">this</span>.instanceInfo = instanceInfo;</div><div class="line">        <span class="keyword">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="number">1</span>,</div><div class="line">                <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                        .setNameFormat(<span class="string">"DiscoveryClient-InstanceInfoReplicator-%d"</span>)</div><div class="line">                        .setDaemon(<span class="keyword">true</span>)</div><div class="line">                        .build());</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.scheduledPeriodicRef = <span class="keyword">new</span> AtomicReference&lt;Future&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.started = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">this</span>.rateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.MINUTES);</div><div class="line">        <span class="keyword">this</span>.replicationIntervalSeconds = replicationIntervalSeconds;</div><div class="line">        <span class="keyword">this</span>.burstSize = burstSize;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.allowedRatePerMinute = <span class="number">60</span> * <span class="keyword">this</span>.burstSize / <span class="keyword">this</span>.replicationIntervalSeconds;</div><div class="line">        logger.info(<span class="string">"InstanceInfoReplicator onDemand update allowed rate per min is &#123;&#125;"</span>, allowedRatePerMinute);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> initialDelayMs)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">            <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸ä¸€è‡´</span></div><div class="line">            instanceInfo.setIsDirty();  <span class="comment">// for initial register</span></div><div class="line">            <span class="comment">// æäº¤ä»»åŠ¡ï¼Œå¹¶è®¾ç½®è¯¥ä»»åŠ¡çš„ Future</span></div><div class="line">            Future next = scheduler.schedule(<span class="keyword">this</span>, initialDelayMs, TimeUnit.SECONDS);</div><div class="line">            scheduledPeriodicRef.set(next);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isInstanceInfoDirty = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Long lastDirtyTimestamp;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setIsDirty</span><span class="params">()</span> </span>&#123;</div><div class="line">   isInstanceInfoDirty = <span class="keyword">true</span>;</div><div class="line">   lastDirtyTimestamp = System.currentTimeMillis();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ‰§è¡Œ <code>instanceInfo.setIsDirty()</code> ä»£ç å—ï¼Œå› ä¸º <strong>InstanceInfo åˆšè¢«åˆ›å»ºæ—¶ï¼Œåœ¨ Eureka-Server ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šè¢«æ³¨å†Œ</strong>ã€‚</li><li>è°ƒç”¨ <code>ScheduledExecutorService#schedule(...)</code> æ–¹æ³•ï¼Œå»¶è¿Ÿ <code>initialDelayMs</code> æ¯«ç§’æ‰§è¡Œ<strong>ä¸€æ¬¡</strong>ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆæ­¤å¤„è®¾ç½® <code>scheduledPeriodicRef</code> ï¼Ÿåœ¨ <code>InstanceInfoReplicator#onDemandUpdate()</code> æ–¹æ³•ä¼šçœ‹åˆ°å…·ä½“ç”¨é€”ã€‚</li></ul></li><li><p><strong>å®šæ—¶</strong>æ£€æŸ¥ InstanceInfo çš„çŠ¶æ€( <code>status</code> ) å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚<strong>è‹¥æ˜¯</strong>ï¼Œå‘èµ·æ³¨å†Œã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfoReplicator.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åˆ·æ–° åº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">       discoveryClient.refreshInstanceInfo();</div><div class="line">       <span class="comment">// åˆ¤æ–­ åº”ç”¨å®ä¾‹ä¿¡æ¯ æ˜¯å¦æ•°æ®ä¸ä¸€è‡´</span></div><div class="line">       Long dirtyTimestamp = instanceInfo.isDirtyWithTime();</div><div class="line">       <span class="keyword">if</span> (dirtyTimestamp != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// å‘èµ·æ³¨å†Œ</span></div><div class="line">           discoveryClient.register();</div><div class="line">           <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸€è‡´</span></div><div class="line">           instanceInfo.unsetIsDirty(dirtyTimestamp);</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">       logger.warn(<span class="string">"There was a problem with the instance info replicator"</span>, t);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ä»»åŠ¡ï¼Œå¹¶è®¾ç½®è¯¥ä»»åŠ¡çš„ Future</span></div><div class="line">       Future next = scheduler.schedule(<span class="keyword">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">       scheduledPeriodicRef.set(next);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">setIsDirtyWithTime</span><span class="params">()</span> </span>&#123;</div><div class="line">   setIsDirty();</div><div class="line">   <span class="keyword">return</span> lastDirtyTimestamp;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unsetIsDirty</span><span class="params">(<span class="keyword">long</span> unsetDirtyTimestamp)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (lastDirtyTimestamp &lt;= unsetDirtyTimestamp) &#123;</div><div class="line">       isInstanceInfoDirty = <span class="keyword">false</span>;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>DiscoveryClient#refreshInstanceInfo()</code> æ–¹æ³•ï¼Œåˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚<strong>æ­¤å¤„å¯èƒ½å¯¼è‡´åº”ç”¨å®ä¾‹ä¿¡æ¯æ•°æ®ä¸ä¸€è‡´</strong>ï¼Œåœ¨<a href="#">ã€Œ2.2ã€åˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯</a> è¯¦ç»†è§£æã€‚</li><li>è°ƒç”¨ <code>DiscoveryClient#register()</code> æ–¹æ³•ï¼Œ<strong>Eureka-Client å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹</strong>ã€‚</li><li>è°ƒç”¨ <code>ScheduledExecutorService#schedule(...)</code> æ–¹æ³•ï¼Œå†æ¬¡å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ï¼Œå¹¶è®¾ç½® <code>scheduledPeriodicRef</code>ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä¸æ–­<strong>å¾ªç¯</strong>å®šæ—¶æ‰§è¡Œä»»åŠ¡ã€‚</li></ul></li></ul></li><li><p><code>com.netflix.appinfo.ApplicationInfoManager.StatusChangeListener</code> <strong>å†…éƒ¨ç±»</strong>ï¼Œç›‘å¬åº”ç”¨å®ä¾‹ä¿¡æ¯çŠ¶æ€çš„å˜æ›´ã€‚</p><ul><li><p>è°ƒç”¨ <code>ApplicationInfoManager#registerStatusChangeListener(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInfoManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, StatusChangeListener&gt; listeners;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStatusChangeListener</span><span class="params">(StatusChangeListener listener)</span> </span>&#123;</div><div class="line">        listeners.put(listener.getId(), listener);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><strong>ä¸šåŠ¡é‡Œ</strong>ï¼Œè°ƒç”¨ <code>ApplicationInfoManager#setInstanceStatus(...)</code> æ–¹æ³•ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„çŠ¶æ€ï¼Œä»è€Œ<strong>é€šçŸ¥</strong> <code>InstanceInfoReplicator#onDemandUpdate()</code> æ–¹æ³•çš„è°ƒç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationInfoManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setInstanceStatus</span><span class="params">(InstanceStatus status)</span> </span>&#123;</div><div class="line">   InstanceStatus next = instanceStatusMapper.map(status);</div><div class="line">   <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   InstanceStatus prev = instanceInfo.setStatus(next);</div><div class="line">   <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (StatusChangeListener listener : listeners.values()) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               listener.notify(<span class="keyword">new</span> StatusChangeEvent(prev, next));</div><div class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">               logger.warn(<span class="string">"failed to notify listener: &#123;&#125;"</span>, listener.getId(), e);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> InstanceStatus <span class="title">setStatus</span><span class="params">(InstanceStatus status)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.status != status) &#123;</div><div class="line">       InstanceStatus prev = <span class="keyword">this</span>.status;</div><div class="line">       <span class="keyword">this</span>.status = status;</div><div class="line">       <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ æ•°æ®ä¸€è‡´</span></div><div class="line">       setIsDirty();</div><div class="line">       <span class="keyword">return</span> prev;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>InstanceInfoReplicator#onDemandUpdate()</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfoReplicator.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDemandUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (rateLimiter.acquire(burstSize, allowedRatePerMinute)) &#123; <span class="comment">// é™æµç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">       scheduler.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               logger.debug(<span class="string">"Executing on-demand update of local InstanceInfo"</span>);</div><div class="line">               <span class="comment">// å–æ¶ˆä»»åŠ¡</span></div><div class="line">               Future latestPeriodic = scheduledPeriodicRef.get();</div><div class="line">               <span class="keyword">if</span> (latestPeriodic != <span class="keyword">null</span> &amp;&amp; !latestPeriodic.isDone()) &#123;</div><div class="line">                   logger.debug(<span class="string">"Canceling the latest scheduled update, it will be rescheduled at the end of on demand update"</span>);</div><div class="line">                   latestPeriodic.cancel(<span class="keyword">false</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// å†æ¬¡è°ƒç”¨</span></div><div class="line">               InstanceInfoReplicator.<span class="keyword">this</span>.run();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.warn(<span class="string">"Ignoring onDemand update due to rate limiter"</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>Future#cancel(false)</code> æ–¹æ³•ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡ï¼Œ<strong>é¿å…æ— ç”¨çš„æ³¨å†Œ</strong>ã€‚</li><li>è°ƒç”¨ <code>InstanceInfoReplicator#run()</code> æ–¹æ³•ï¼Œå‘èµ·æ³¨å†Œã€‚</li></ul></li></ul></li></ul><h2>2.2 åˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>DiscoveryClient#refreshInstanceInfo()</code> æ–¹æ³•ï¼Œåˆ·æ–°åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚<strong>æ­¤å¤„å¯èƒ½å¯¼è‡´åº”ç”¨å®ä¾‹ä¿¡æ¯æ•°æ®ä¸ä¸€è‡´</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">refreshInstanceInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ·æ–° æ•°æ®ä¸­å¿ƒä¿¡æ¯</span></div><div class="line">   applicationInfoManager.refreshDataCenterInfoIfRequired();</div><div class="line">   <span class="comment">// åˆ·æ–° ç§Ÿçº¦ä¿¡æ¯</span></div><div class="line">   applicationInfoManager.refreshLeaseInfoIfRequired();</div><div class="line">   <span class="comment">// å¥åº·æ£€æŸ¥</span></div><div class="line">   InstanceStatus status;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       status = getHealthCheckHandler().getStatus(instanceInfo.getStatus());</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.warn(<span class="string">"Exception from healthcheckHandler.getStatus, setting status to DOWN"</span>, e);</div><div class="line">       status = InstanceStatus.DOWN;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != status) &#123;</div><div class="line">       applicationInfoManager.setInstanceStatus(status);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ApplicationInfoManager#refreshDataCenterInfoIfRequired()</code> æ–¹æ³•ï¼Œåˆ·æ–°æ•°æ®ä¸­å¿ƒç›¸å…³ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationInfoManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshDataCenterInfoIfRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// hostname</span></div><div class="line">   String existingAddress = instanceInfo.getHostName();</div><div class="line">   String newAddress;</div><div class="line">   <span class="keyword">if</span> (config <span class="keyword">instanceof</span> RefreshableInstanceConfig) &#123;</div><div class="line">       <span class="comment">// Refresh data center info, and return up to date address</span></div><div class="line">       newAddress = ((RefreshableInstanceConfig) config).resolveDefaultAddress(<span class="keyword">true</span>);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       newAddress = config.getHostName(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ip</span></div><div class="line">   String newIp = config.getIpAddress();</div><div class="line">   <span class="keyword">if</span> (newAddress != <span class="keyword">null</span> &amp;&amp; !newAddress.equals(existingAddress)) &#123;</div><div class="line">       logger.warn(<span class="string">"The address changed from : &#123;&#125; =&gt; &#123;&#125;"</span>, existingAddress, newAddress);</div><div class="line">       <span class="comment">// :( in the legacy code here the builder is acting as a mutator.</span></div><div class="line">       <span class="comment">// This is hard to fix as this same instanceInfo instance is referenced elsewhere.</span></div><div class="line">       <span class="comment">// We will most likely re-write the client at sometime so not fixing for now.</span></div><div class="line">       InstanceInfo.Builder builder = <span class="keyword">new</span> InstanceInfo.Builder(instanceInfo);</div><div class="line">       builder.setHostName(newAddress) <span class="comment">// hostname</span></div><div class="line">               .setIPAddr(newIp) <span class="comment">// ip</span></div><div class="line">               .setDataCenterInfo(config.getDataCenterInfo()); <span class="comment">// dataCenterInfo</span></div><div class="line">       instanceInfo.setIsDirty();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pair&lt;String, String&gt; hostInfo = getHostInfo();</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHostName</span><span class="params">(<span class="keyword">boolean</span> refresh)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> hostInfo.second();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIpAddress</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> hostInfo.first();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Pair&lt;String, String&gt; <span class="title">getHostInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        Pair&lt;String, String&gt; pair;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            InetAddress localHost = InetAddress.getLocalHost();</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(localHost.getHostAddress(), localHost.getHostName());</div><div class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</div><div class="line">            logger.error(<span class="string">"Cannot get host info"</span>, e);</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(<span class="string">""</span>, <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> pair;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å…³æ³¨åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ <code>hostName</code> ã€ <code>ipAddr</code> ã€ <code>dataCenterInfo</code> å±æ€§çš„å˜åŒ–ã€‚</li><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é RefreshableInstanceConfig å®ç°çš„é…ç½®ç±»( ä¸€èˆ¬æ˜¯ MyDataCenterInstanceConfig )ï¼Œå› ä¸º <code>AbstractInstanceConfig.hostInfo</code> æ˜¯<strong>é™æ€å±æ€§</strong>ï¼Œ<strong>å³ä½¿æœ¬æœºä¿®æ”¹äº† IP ç­‰ä¿¡æ¯ï¼ŒEureka-Client è¿›ç¨‹ä¹Ÿä¸ä¼šæ„ŸçŸ¥åˆ°</strong>ã€‚TODO[0022]ï¼šçœ‹ä¸‹springcloud çš„å®ç°</li></ul></li><li><p>è°ƒç”¨ <code>ApplicationInfoManager#refreshLeaseInfoIfRequired()</code> æ–¹æ³•ï¼Œåˆ·æ–°ç§Ÿçº¦ç›¸å…³ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshLeaseInfoIfRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">   LeaseInfo leaseInfo = instanceInfo.getLeaseInfo();</div><div class="line">   <span class="keyword">if</span> (leaseInfo == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> currentLeaseDuration = config.getLeaseExpirationDurationInSeconds();</div><div class="line">   <span class="keyword">int</span> currentLeaseRenewal = config.getLeaseRenewalIntervalInSeconds();</div><div class="line">   <span class="keyword">if</span> (leaseInfo.getDurationInSecs() != currentLeaseDuration <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´ æ”¹å˜</span></div><div class="line">           || leaseInfo.getRenewalIntervalInSecs() != currentLeaseRenewal) &#123; <span class="comment">// ç§Ÿçº¦ç»­çº¦é¢‘ç‡ æ”¹å˜</span></div><div class="line">       LeaseInfo newLeaseInfo = LeaseInfo.Builder.newBuilder()</div><div class="line">               .setRenewalIntervalInSecs(currentLeaseRenewal)</div><div class="line">               .setDurationInSecs(currentLeaseDuration)</div><div class="line">               .build();</div><div class="line">       instanceInfo.setLeaseInfo(newLeaseInfo);</div><div class="line">       instanceInfo.setIsDirty();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å…³æ³¨åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ <code>renewalIntervalInSecs</code> ã€ <code>durationInSecs</code> å±æ€§çš„å˜åŒ–ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>HealthCheckHandler#getStatus()</code> æ–¹æ³•ï¼Œå¥åº·æ£€æŸ¥ã€‚è¿™é‡Œå…ˆæš‚æ—¶è·³è¿‡ï¼Œæˆ‘ä»¬åœ¨<a href="#">TODO[0004]ï¼šå¥åº·æ£€æŸ¥</a> è¯¦ç»†è§£æã€‚</p></li></ul><h2>2.3 å‘èµ·æ³¨å†Œåº”ç”¨å®ä¾‹</h2><p>è°ƒç”¨ <code>DiscoveryClient#register()</code> æ–¹æ³•ï¼Œ<strong>Eureka-Client å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   logger.info(PREFIX + appPathIdentifier + <span class="string">": registering service..."</span>);</div><div class="line">   EurekaHttpResponse&lt;Void&gt; httpResponse;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logger.warn(<span class="string">"&#123;&#125; - registration failed &#123;&#125;"</span>, PREFIX + appPathIdentifier, e.getMessage(), e);</div><div class="line">       <span class="keyword">throw</span> e;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">       logger.info(<span class="string">"&#123;&#125; - registration status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">204</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractJerseyEurekaHttpClient.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(InstanceInfo info)</span> </span>&#123;</div><div class="line">   String urlPath = <span class="string">"apps/"</span> + info.getAppName();</div><div class="line">   ClientResponse response = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</div><div class="line">       addExtraHeaders(resourceBuilder);</div><div class="line">       response = resourceBuilder</div><div class="line">               .header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>)</div><div class="line">               .type(MediaType.APPLICATION_JSON_TYPE)</div><div class="line">               .accept(MediaType.APPLICATION_JSON)</div><div class="line">               .post(ClientResponse.class, info);</div><div class="line">       <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, info.getId(),</div><div class="line">                   response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</div><div class="line">           response.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>AbstractJerseyEurekaHttpClient#register(...)</code> æ–¹æ³•ï¼Œ<code>POST</code> è¯·æ±‚ Eureka-Server çš„ <code>apps/${APP_NAME}</code> æ¥å£ï¼Œå‚æ•°ä¸º InstanceInfo ï¼Œå®ç°æ³¨å†Œå®ä¾‹ä¿¡æ¯çš„æ³¨å†Œã€‚</li></ul><h1>3. Eureka-Server æ¥æ”¶æ³¨å†Œ</h1><h2>3.1 æ¥æ”¶æ³¨å†Œè¯·æ±‚</h2><p><code>com.netflix.eureka.resources.ApplicationResource</code>ï¼Œå¤„ç†<strong>å•ä¸ª</strong>åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚</p><p>æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ <code>ApplicationResource#addInstance()</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"application/xml"</span>, <span class="string">"application/json"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationResource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(&#123;<span class="string">"application/json"</span>, <span class="string">"application/xml"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">addInstance</span><span class="params">(InstanceInfo info,</span></span></div><div class="line"><span class="function"><span class="params">                                @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</div><div class="line">        <span class="comment">// æ ¡éªŒå‚æ•°æ˜¯å¦åˆæ³•</span></div><div class="line">        logger.debug(<span class="string">"Registering instance &#123;&#125; (replication=&#123;&#125;)"</span>, info.getId(), isReplication);</div><div class="line">        <span class="comment">// validate that the instanceinfo contains all the necessary required fields</span></div><div class="line">        <span class="keyword">if</span> (isBlank(info.getId())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing instanceId"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getHostName())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing hostname"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getIPAddr())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing ip address"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getAppName())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing appName"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!appName.equals(info.getAppName())) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Mismatched appName, expecting "</span> + appName + <span class="string">" but was "</span> + info.getAppName()).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo() == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo"</span>).build();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo().getName() == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo Name"</span>).build();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// AWS ç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">        <span class="comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></div><div class="line">        DataCenterInfo dataCenterInfo = info.getDataCenterInfo();</div><div class="line">        <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</div><div class="line">            String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId();</div><div class="line">            <span class="keyword">if</span> (isBlank(dataCenterInfoId)) &#123;</div><div class="line">                <span class="keyword">boolean</span> experimental = <span class="string">"true"</span>.equalsIgnoreCase(serverConfig.getExperimental(<span class="string">"registration.validation.dataCenterInfoId"</span>));</div><div class="line">                <span class="keyword">if</span> (experimental) &#123;</div><div class="line">                    String entity = <span class="string">"DataCenterInfo of type "</span> + dataCenterInfo.getClass() + <span class="string">" must contain a valid id"</span>;</div><div class="line">                    <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(entity).build();</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> AmazonInfo) &#123;</div><div class="line">                    AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo;</div><div class="line">                    String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId);</div><div class="line">                    <span class="keyword">if</span> (effectiveId == <span class="keyword">null</span>) &#123;</div><div class="line">                        amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId());</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    logger.warn(<span class="string">"Registering DataCenterInfo of type &#123;&#125; without an appropriate id"</span>, dataCenterInfo.getClass());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">        registry.register(info, <span class="string">"true"</span>.equals(isReplication));</div><div class="line"></div><div class="line">        <span class="comment">// è¿”å› 204 æˆåŠŸ</span></div><div class="line">        <span class="keyword">return</span> Response.status(<span class="number">204</span>).build();  <span class="comment">// 204 to be backwards compatible</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¯·æ±‚å¤´ <code>isReplication</code> å‚æ•°ï¼Œå’Œ Eureka-Server é›†ç¾¤å¤åˆ¶ç›¸å…³ï¼Œæš‚æ—¶è·³è¿‡ã€‚</p></li><li><p>è°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´</span></div><div class="line">   <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</div><div class="line">   <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</div><div class="line">       leaseDuration = info.getLeaseInfo().getDurationInSecs();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">   <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</div><div class="line">   <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">   replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨çˆ¶ç±» <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚</li></ul></li></ul><h2>3.2 Lease</h2><p>åœ¨çœ‹å…·ä½“çš„æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯çš„é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ <code>com.netflix.eureka.lease.Lease</code>ï¼Œç§Ÿçº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lease</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®ä½“</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> T holder;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> registrationTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¼€å§‹æœåŠ¡æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> serviceUpTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ³¨å†Œæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> evictionTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="comment">// Make it volatile so that the expiration task would see this quicker</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastUpdateTimestamp;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç§Ÿçº¦æŒç»­æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> duration;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Lease</span><span class="params">(T r, <span class="keyword">int</span> durationInSecs)</span> </span>&#123;</div><div class="line">        holder = r;</div><div class="line">        registrationTimestamp = System.currentTimeMillis();</div><div class="line">        lastUpdateTimestamp = registrationTimestamp;</div><div class="line">        duration = (durationInSecs * <span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>holder</code> å±æ€§ï¼Œç§Ÿçº¦çš„æŒæœ‰è€…ã€‚åœ¨ Eureka-Server é‡Œï¼Œæš‚æ—¶åªæœ‰ InstanceInfo ä½¿ç”¨ã€‚</p></li><li><p><code>registrationTimestamp</code> å±æ€§ï¼Œæ³¨å†Œ( åˆ›å»º )ç§Ÿçº¦æ—¶é—´æˆ³ã€‚åœ¨<strong>æ„é€ æ–¹æ³•</strong>é‡Œå¯ä»¥çœ‹ç§Ÿçº¦å¯¹è±¡çš„åˆ›å»ºæ—¶é—´æˆ³å³ä¸ºæ³¨å†Œç§Ÿçº¦æ—¶é—´æˆ³ã€‚</p></li><li><p><code>serviceUpTimestamp</code> å±æ€§ï¼Œå¼€å§‹æœåŠ¡æ—¶é—´æˆ³ã€‚æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ä¼šä½¿ç”¨åˆ°å®ƒå¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceUp</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (serviceUpTimestamp == <span class="number">0</span>) &#123; <span class="comment">// ç¬¬ä¸€æ¬¡æœ‰æ•ˆ</span></div><div class="line">       serviceUpTimestamp = System.currentTimeMillis();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServiceUpTimestamp</span><span class="params">(<span class="keyword">long</span> serviceUpTimestamp)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.serviceUpTimestamp = serviceUpTimestamp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>lastUpdatedTimestamp</code> å±æ€§ï¼Œæœ€åæ›´æ–°ç§Ÿçº¦æ—¶é—´æˆ³ã€‚æ¯æ¬¡ç»­ç§Ÿæ—¶ï¼Œæ›´æ–°è¯¥æ—¶é—´æˆ³ã€‚æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ä¼šä½¿ç”¨åˆ°å®ƒå¦‚ä¸‹æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastUpdatedTimestamp</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.lastUpdatedTimestamp = System.currentTimeMillis();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>duration</code> å±æ€§ï¼Œç§Ÿçº¦æŒç»­æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å½“ç§Ÿçº¦è¿‡ä¹…æœªç»­ç§Ÿï¼Œå³å½“å‰æ—¶é—´ - <code>lastUpdatedTimestamp</code> &gt; <code>duration</code> æ—¶ï¼Œç§Ÿçº¦è¿‡æœŸã€‚</p></li><li><p><code>evictionTimestamp</code> å±æ€§ï¼Œç§Ÿçº¦è¿‡æœŸæ—¶é—´æˆ³ã€‚</p></li></ul><h2>3.3 æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// TODO ä¸ºä»€ä¹ˆæ˜¯è¯»é”</span></div><div class="line"> <span class="number">4</span>:         read.lock();</div><div class="line"> <span class="number">5</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å¢åŠ  æ³¨å†Œæ¬¡æ•° åˆ° ç›‘æ§</span></div><div class="line"> <span class="number">7</span>:         REGISTER.increment(isReplication);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾— åº”ç”¨å®ä¾‹ä¿¡æ¯ å¯¹åº”çš„ ç§Ÿçº¦</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">final</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();</div><div class="line"><span class="number">11</span>:             gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap); <span class="comment">// æ·»åŠ  åº”ç”¨</span></div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123; <span class="comment">// æ·»åŠ  åº”ç”¨ æˆåŠŸ</span></div><div class="line"><span class="number">13</span>:                 gMap = gNewMap;</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</div><div class="line"><span class="number">17</span>:         <span class="comment">// Retain the last dirty timestamp without overwriting it, if there is already a lease</span></div><div class="line"><span class="number">18</span>:         <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123; <span class="comment">// å·²å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æ•°æ®ä¸ä¸€è‡´çš„æ—¶é—´å¤§çš„åº”ç”¨æ³¨å†Œä¿¡æ¯ä¸ºæœ‰æ•ˆçš„</span></div><div class="line"><span class="number">19</span>:             Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp(); <span class="comment">// Server æ³¨å†Œçš„ InstanceInfo</span></div><div class="line"><span class="number">20</span>:             Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp(); <span class="comment">// Client è¯·æ±‚çš„ InstanceInfo</span></div><div class="line"><span class="number">21</span>:             logger.debug(<span class="string">"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:             <span class="comment">// this is a &gt; instead of a &gt;= because if the timestamps are equal, we still take the remote transmitted</span></div><div class="line"><span class="number">24</span>:             <span class="comment">// InstanceInfo instead of the server local copy.</span></div><div class="line"><span class="number">25</span>:             <span class="keyword">if</span> (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</div><div class="line"><span class="number">26</span>:                 logger.warn(<span class="string">"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater"</span> +</div><div class="line"><span class="number">27</span>:                         <span class="string">" than the one that is being registered &#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</div><div class="line"><span class="number">28</span>:                 logger.warn(<span class="string">"Using the existing instanceInfo instead of the new instanceInfo as the registrant"</span>);</div><div class="line"><span class="number">29</span>:                 registrant = existingLease.getHolder();</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="comment">// The lease does not exist and hence it is a new registration</span></div><div class="line"><span class="number">33</span>:             <span class="comment">// ã€è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‘å¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`</span></div><div class="line"><span class="number">34</span>:             <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:                     <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></div><div class="line"><span class="number">37</span>:                     <span class="comment">// (1</span></div><div class="line"><span class="number">38</span>:                     <span class="comment">// for 30 seconds, 2 for a minute)</span></div><div class="line"><span class="number">39</span>:                     <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</div><div class="line"><span class="number">40</span>:                     <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</div><div class="line"><span class="number">41</span>:                             (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">42</span>:                 &#125;</div><div class="line"><span class="number">43</span>:             &#125;</div><div class="line"><span class="number">44</span>:             logger.debug(<span class="string">"No previous lease information found; it is new registration"</span>);</div><div class="line"><span class="number">45</span>:         &#125;</div><div class="line"><span class="number">46</span>:         <span class="comment">// åˆ›å»º ç§Ÿçº¦</span></div><div class="line"><span class="number">47</span>:         Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</div><div class="line"><span class="number">48</span>:         <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123; <span class="comment">// è‹¥ç§Ÿçº¦å·²å­˜åœ¨ï¼Œè®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³</span></div><div class="line"><span class="number">49</span>:             lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</div><div class="line"><span class="number">50</span>:         &#125;</div><div class="line"><span class="number">51</span>:         <span class="comment">// æ·»åŠ åˆ° ç§Ÿçº¦æ˜ å°„</span></div><div class="line"><span class="number">52</span>:         gMap.put(registrant.getId(), lease);</div><div class="line"><span class="number">53</span>:         <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘æ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="number">54</span>:         <span class="keyword">synchronized</span> (recentRegisteredQueue) &#123;</div><div class="line"><span class="number">55</span>:             recentRegisteredQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(</div><div class="line"><span class="number">56</span>:                     System.currentTimeMillis(),</div><div class="line"><span class="number">57</span>:                     registrant.getAppName() + <span class="string">"("</span> + registrant.getId() + <span class="string">")"</span>));</div><div class="line"><span class="number">58</span>:         &#125;</div><div class="line"><span class="number">59</span>:         <span class="comment">// TODO èŠ‹è‰¿</span></div><div class="line"><span class="number">60</span>:         <span class="comment">// This is where the initial state transfer of overridden status happens</span></div><div class="line"><span class="number">61</span>:         <span class="keyword">if</span> (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</div><div class="line"><span class="number">62</span>:             logger.debug(<span class="string">"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the "</span></div><div class="line"><span class="number">63</span>:                             + <span class="string">"overrides"</span>, registrant.getOverriddenStatus(), registrant.getId());</div><div class="line"><span class="number">64</span>:             <span class="keyword">if</span> (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</div><div class="line"><span class="number">65</span>:                 logger.info(<span class="string">"Not found overridden id &#123;&#125; and hence adding it"</span>, registrant.getId());</div><div class="line"><span class="number">66</span>:                 overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</div><div class="line"><span class="number">67</span>:             &#125;</div><div class="line"><span class="number">68</span>:         &#125;</div><div class="line"><span class="number">69</span>:         InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</div><div class="line"><span class="number">70</span>:         <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">71</span>:             logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</div><div class="line"><span class="number">72</span>:             registrant.setOverriddenStatus(overriddenStatusFromMap);</div><div class="line"><span class="number">73</span>:         &#125;</div><div class="line"><span class="number">74</span>: </div><div class="line"><span class="number">75</span>:         <span class="comment">// TODO èŠ‹è‰¿</span></div><div class="line"><span class="number">76</span>:         <span class="comment">// Set the status based on the overridden status rules</span></div><div class="line"><span class="number">77</span>:         InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</div><div class="line"><span class="number">78</span>:         registrant.setStatusWithoutDirty(overriddenInstanceStatus);</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:         <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆï¼‰</span></div><div class="line"><span class="number">81</span>:         <span class="comment">// If the lease is registered with UP status, set lease service up timestamp</span></div><div class="line"><span class="number">82</span>:         <span class="keyword">if</span> (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</div><div class="line"><span class="number">83</span>:             lease.serviceUp();</div><div class="line"><span class="number">84</span>:         &#125;</div><div class="line"><span class="number">85</span>:         <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ“ä½œç±»å‹ ä¸º æ·»åŠ </span></div><div class="line"><span class="number">86</span>:         registrant.setActionType(ActionType.ADDED);</div><div class="line"><span class="number">87</span>:         <span class="comment">// æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="number">88</span>:         recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</div><div class="line"><span class="number">89</span>:         <span class="comment">// è®¾ç½® ç§Ÿçº¦çš„æœ€åæ›´æ–°æ—¶é—´æˆ³</span></div><div class="line"><span class="number">90</span>:         registrant.setLastUpdatedTimestamp();</div><div class="line"><span class="number">91</span>:         <span class="comment">// è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ</span></div><div class="line"><span class="number">92</span>:         invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</div><div class="line"><span class="number">93</span>:         logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>,</div><div class="line"><span class="number">94</span>:                 registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);</div><div class="line"><span class="number">95</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">96</span>:         <span class="comment">// é‡Šæ”¾é”</span></div><div class="line"><span class="number">97</span>:         read.unlock();</div><div class="line"><span class="number">98</span>:     &#125;</div><div class="line"><span class="number">99</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šTODO ä¸ºä»€ä¹ˆæ˜¯è¯»é”ã€‚</p></li><li><p>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šå¢åŠ æ³¨å†Œæ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</p></li><li><p>ç¬¬ 5 è‡³ 16 è¡Œ ï¼šè·å¾—åº”ç”¨å®ä¾‹ä¿¡æ¯å¯¹åº”çš„<strong>ç§Ÿçº¦</strong>ã€‚<code>registry</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * ç§Ÿçº¦æ˜ å°„</span></div><div class="line"><span class="comment"> * key1 ï¼šåº”ç”¨å &#123;<span class="doctag">@link</span> InstanceInfo#appName&#125;</span></div><div class="line"><span class="comment"> * key2 ï¼šåº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å· &#123;<span class="doctag">@link</span> InstanceInfo#instanceId&#125;</span></div><div class="line"><span class="comment"> * value ï¼šç§Ÿçº¦</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 17 è‡³ 30 è¡Œ ï¼šå½“ç§Ÿçº¦<strong>å·²å­˜åœ¨</strong>ï¼Œåˆ¤æ–­ Server å·²å­˜åœ¨çš„ InstanceInfo çš„ <code>lastDirtyTimestamp</code> æ˜¯å¦<strong>å¤§äº</strong>( ä¸åŒ…æ‹¬ç­‰äº ) Client è¯·æ±‚çš„ InstanceInfo ï¼Œ<strong>è‹¥æ˜¯ï¼Œä½¿ç”¨ Server çš„ InstanceInfo è¿›è¡Œæ›¿ä»£</strong>ã€‚</p></li><li><p>ç¬¬ 31 è‡³ 44 è¡Œ ï¼šå¢åŠ  <code>numberOfRenewsPerMinThreshold</code> ã€<code>expectedNumberOfRenewsPerMin</code>ï¼Œè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 45 è‡³ 52 è¡Œ ï¼šåˆ›å»ºç§Ÿçº¦ï¼Œå¹¶æ·»åŠ åˆ°ç§Ÿçº¦æ˜ å°„( <code>registry</code> )ã€‚</p></li><li><p>ç¬¬ 53 è‡³ 58 è¡Œ ï¼šæ·»åŠ åˆ°æœ€è¿‘æ³¨å†Œçš„<strong>è°ƒè¯•</strong>é˜Ÿåˆ—( <code>recentRegisteredQueue</code> )ï¼Œç”¨äº Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤ºï¼Œæ— å®é™…ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘æ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">* key ï¼šæ·»åŠ æ—¶çš„æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">* value ï¼šå­—ç¬¦ä¸² = åº”ç”¨å(åº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å·)</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CircularQueue&lt;Pair&lt;Long, String&gt;&gt; recentRegisteredQueue;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¾ªç¯é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;E&gt; æ³›å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ConcurrentLinkedQueue</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * é˜Ÿåˆ—å¤§å°</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">CircularQueue</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.size = size;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.makeSpaceIfNotAvailable();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.add(e);</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä¿è¯ç©ºé—´è¶³å¤Ÿ</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * å½“ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œç§»é™¤é¦–å…ƒç´ </span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">makeSpaceIfNotAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.size() == size) &#123;</div><div class="line">           <span class="keyword">this</span>.remove();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.makeSpaceIfNotAvailable();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.offer(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 59 è‡³ 73 è¡Œ ï¼š TODO èŠ‹è‰¿</p></li><li><p>ç¬¬ 75 è‡³ 78 è¡Œ ï¼š TODO èŠ‹è‰¿</p></li><li><p>ç¬¬ 80 è‡³ 84 è¡Œ ï¼šè®¾ç½®ç§Ÿçº¦çš„å¼€å§‹æœåŠ¡çš„æ—¶é—´æˆ³( <strong>åªæœ‰ç¬¬ä¸€æ¬¡æœ‰æ•ˆ</strong> )ã€‚</p></li><li><p>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„<strong>æ“ä½œç±»å‹ä¸ºæ·»åŠ </strong>ï¼Œå¹¶æ·»åŠ åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( <code>recentlyChangedQueue</code> )ã€‚<code>recentlyChangedQueue</code> ç”¨äºæ³¨å†Œä¿¡æ¯çš„<strong>å¢é‡</strong>è·å–ï¼Œåœ¨<a href="TODO">ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆäº”ï¼‰ä¹‹å¢é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt; recentlyChangedQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;RecentlyChangedItem&gt;();</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 89 è‡³ 90 è¡Œ ï¼šè®¾ç½®ç§Ÿçº¦çš„æœ€åæ›´æ–°æ—¶é—´æˆ³ã€‚</p></li><li><p>ç¬¬ 91 è‡³ 92 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜( ResponseCache )è¿‡æœŸï¼Œåœ¨<a href="TODO">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆäº”ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 96 è‡³ 97 è¡Œ ï¼šé‡Šæ”¾é”ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>å˜¿å˜¿ï¼Œè›®å—¨çš„ï¼Œæ¯”èµ·å‰é¢å‡ ç¯‡å†™é…ç½®ç›¸å…³çš„æ–‡ç« æ¥è¯´ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-register/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eureka/
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” æ³¨å†Œè¡¨ InstanceRegistry ç±»å…³ç³»</title>
    <link href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/"/>
    <id>http://www.iocoder.cn/Eureka/instance-registry-class-diagram/</id>
    <published>2018-05-20T16:00:00.000Z</published>
    <updated>2017-10-05T04:03:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-class-diagram/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">2. ç±»å›¾</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">3. LookupService</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">4. LeaseManager</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">5. InstanceRegistry</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">6. AbstractInstanceRegistry</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">7. PeerAwareInstanceRegistry</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">8. PeerAwareInstanceRegistryImpl</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?toc">666. å½©è›‹</a></li></ul><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦ç®€ä»‹ <strong>æ³¨å†Œè¡¨ InstanceRegistry çš„ç±»å…³ç³»</strong>ï¼Œä¸ºåæ–‡çš„<strong>åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°</strong>ã€<strong>Eureka-Server é›†ç¾¤å¤åˆ¶</strong>åšæ•´ä½“çš„é“ºå«ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ç±»å›¾</h1><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_21/01.png" alt=""></p><ul><li><code>com.netflix.eureka.registry.AwsInstanceRegistry</code>ï¼Œä¸»è¦ç”¨äºäºšé©¬é€Š AWSï¼Œè·³è¿‡ã€‚</li><li><code>com.netflix.eureka.registry.RemoteRegionRegistry</code>ï¼Œç¬”è€…æš‚æ—¶ä¸å¤ªç†è§£å®ƒçš„ç”¨é€”ã€‚ç›®å‰çŒœæµ‹ Eureka-Server é›†ç¾¤å’Œé›†ç¾¤ä¹‹é—´çš„æ³¨å†Œä¿¡æ¯çš„äº¤äº’æ–¹å¼ã€‚æŸ¥é˜…å®˜æ–¹èµ„æ–™ï¼Œ<a href="https://github.com/Netflix/eureka/issues/29" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠAdd ability to retrieve instances from any remote regionã€‹</a> åœ¨åšäº†ç®€å•ä»‹ç»ã€‚ç¿»çœ‹ç›®å‰ç½‘ç»œä¸Šçš„åšå®¢ã€ä¹¦ç±ã€é¡¹ç›®å®æˆ˜ï¼Œæš‚æ—¶éƒ½æ²¡æåŠæ­¤å—ã€‚ä¼°æ‘¸å’Œäºšé©¬é€Š AWS è·¨åŒºåŸŸ( <code>region</code> ) æœºåˆ¶æœ‰ä¸€å®šå…³ç³»ï¼Œå…ˆæš‚æ—¶è·³è¿‡ã€‚æœ‰äº†è§£æ­¤å—çš„åŒå­¦ï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ç¬”è€…ï¼Œä¸‡åˆ†æ„Ÿè°¢ã€‚TODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œæœ¬æ–‡ä¸»è§’ã€‚</li></ul><h1>3. LookupService</h1><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/shared/LookupService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.shared.LookupService</code></a>ï¼ŒæŸ¥æ‰¾æœåŠ¡<strong>æ¥å£</strong>ï¼Œæä¾›<strong>ç®€å•å•ä¸€</strong>çš„æ–¹å¼è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å®ä¾‹ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LookupService</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">(String appName)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">Applications <span class="title">getApplications</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">List&lt;InstanceInfo&gt; <span class="title">getInstancesById</span><span class="params">(String id)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">InstanceInfo <span class="title">getNextServerFromEureka</span><span class="params">(String virtualHostname, <span class="keyword">boolean</span> secure)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_29/01.png" alt=""></p><ul><li>åœ¨ Eureka-Client é‡Œï¼ŒEurekaClient ç»§æ‰¿è¯¥æ¥å£ã€‚</li><li>åœ¨ Eureka-Server é‡Œï¼Œ<code>com.netflix.eureka.registry.InstanceRegistry</code> ç»§æ‰¿è¯¥æ¥å£ã€‚</li></ul><h1>4. LeaseManager</h1><p><code>com.netflix.eureka.lease.LeaseManager</code>ï¼Œç§Ÿçº¦ç®¡ç†å™¨<strong>æ¥å£</strong>ï¼Œæä¾›ç§Ÿçº¦çš„æ³¨å†Œã€ç»­ç§Ÿã€å–æ¶ˆ( ä¸»åŠ¨ä¸‹çº¿ )ã€è¿‡æœŸ( è¿‡æœŸä¸‹çº¿ )ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LeaseManager</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(T r, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">evict</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>5. InstanceRegistry</h1><p><code>com.netflix.eureka.registry.InstanceRegistry</code>ï¼Œ<strong>åº”ç”¨å®ä¾‹</strong>æ³¨å†Œè¡¨<strong>æ¥å£</strong>ã€‚å®ƒç»§æ‰¿äº† LookupService ã€LeaseManager æ¥å£ï¼Œæä¾›åº”ç”¨å®ä¾‹çš„<strong>æ³¨å†Œ</strong>ä¸<strong>å‘ç°</strong>æœåŠ¡ã€‚å¦å¤–ï¼Œå®ƒç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯ï¼Œå®šä¹‰äº†<strong>æ›´åŠ ä¸°å¯Œ</strong>çš„æ¥å£æ–¹æ³•ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstanceRegistry</span> <span class="keyword">extends</span> <span class="title">LeaseManager</span>&lt;<span class="title">InstanceInfo</span>&gt;, <span class="title">LookupService</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ====== å¼€å¯ä¸å…³é—­ç›¸å…³ ======</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearRegistry</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// ====== åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´ç›¸å…³ ======</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">storeOverriddenStatusIfRequired</span><span class="params">(String appName, String id, InstanceStatus overriddenStatus)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">statusUpdate</span><span class="params">(String appName, String id, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                         String lastDirtyTimestamp, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">deleteStatusOverride</span><span class="params">(String appName, String id, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                                 String lastDirtyTimestamp, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Map&lt;String, InstanceStatus&gt; <span class="title">overriddenInstanceStatusesSnapshot</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// ====== å“åº”ç¼“å­˜ç›¸å…³ ======</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initializedResponseCache</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">ResponseCache <span class="title">getResponseCache</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">// ====== è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ç›¸å…³ ======</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getNumOfRenewsInLastMin</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getNumOfRenewsPerMinThreshold</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">isBelowRenewThresold</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSelfPreservationModeEnabled</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeaseExpirationEnabled</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">// ====== è°ƒè¯•/ç›‘æ§ç›¸å…³ ======</span></div><div class="line">    List&lt;Pair&lt;Long, String&gt;&gt; getLastNRegisteredInstances();</div><div class="line"></div><div class="line">    List&lt;Pair&lt;Long, String&gt;&gt; getLastNCanceledInstances();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>6. AbstractInstanceRegistry</h1><p><code>com.netflix.eureka.registry.AbstractInstanceRegistry</code>ï¼Œåº”ç”¨å¯¹è±¡æ³¨å†Œè¡¨<strong>æŠ½è±¡å®ç°</strong>ã€‚</p><p>è¿™é‡Œå…ˆä¸æ‹“å±•å¼€ï¼Œ<a href="http://www.iocoder.cn/categories/Eureka/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ã€‹ç³»åˆ—</a> é€ç¯‡åˆ†äº«ã€‚</p><h1>7. PeerAwareInstanceRegistry</h1><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistry</code>ï¼ŒPeerAware ( æš‚æ—¶æ‰¾ä¸åˆ°åˆé€‚çš„ç¿»è¯‘ ) åº”ç”¨å¯¹è±¡æ³¨å†Œè¡¨<strong>æ¥å£</strong>ï¼Œæä¾› Eureka-Server é›†ç¾¤å†…æ³¨å†Œä¿¡æ¯çš„<strong>åŒæ­¥</strong>æœåŠ¡ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PeerAwareInstanceRegistry</span> <span class="keyword">extends</span> <span class="title">InstanceRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(PeerEurekaNodes peerEurekaNodes)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">syncUp</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldAllowAccess</span><span class="params">(<span class="keyword">boolean</span> remoteRegionRequired)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo info, <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> String asgName, <span class="keyword">final</span> ASGResource.ASGStatus newStatus, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h1>8. PeerAwareInstanceRegistryImpl</h1><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>ï¼ŒPeerAware ( æš‚æ—¶æ‰¾ä¸åˆ°åˆé€‚çš„ç¿»è¯‘ ) åº”ç”¨å¯¹è±¡æ³¨å†Œè¡¨<strong>å®ç°ç±»</strong>ã€‚</p><p>è¿™é‡Œå…ˆä¸æ‹“å±•å¼€ï¼Œ<a href="http://www.iocoder.cn/categories/Eureka/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤ã€‹ç³»åˆ—</a> é€ç¯‡åˆ†äº«ã€‚</p><h1>666. å½©è›‹</h1><p>æœ¬æ–‡æ˜¯ä¸€ç¯‡<strong>ç®€ä»‹</strong>( å•ªå•ªå•ªï¼Œæ‰“è„¸ )ï¼Œå¦‚æœèƒ–å‹æ¯”è¾ƒç€æ€¥æƒ³äº†è§£åŸç†ï¼Œå¯ä»¥é˜…è¯» <a href="http://techshow.ctrip.com/archives/1699.html?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">æºç¨‹ â€”â€”ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a> å…ˆï¼Œå†™çš„éå¸¸éå¸¸éå¸¸ä¸é”™ã€‚</p><p>å¿«é©¬åŠ é­ï¼Œæ›´æ–° <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> <strong>ing</strong> ...</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-class-diagram/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Eu
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆäºŒï¼‰ä¹‹ EurekaBootStrap</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-server-init-second/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-server-init-second/</id>
    <published>2018-05-13T16:00:00.000Z</published>
    <updated>2017-10-05T04:03:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-eurekabootstrap">2. EurekaBootStrap</a><ul><li><a href="#21-%E5%88%9D%E5%A7%8B%E5%8C%96-eureka-server-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83">2.1 åˆå§‹åŒ– Eureka-Server é…ç½®ç¯å¢ƒ</a></li><li><a href="#22-%E5%88%9D%E5%A7%8B%E5%8C%96-eureka-server-%E4%B8%8A%E4%B8%8B%E6%96%87">2.2 åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</a></li></ul></li><li><a href="#3-filter">3. Filter</a><ul><li><a href="#31-statusfilter">3.1 StatusFilter</a></li><li><a href="#32-serverrequestauthfilter">3.2 ServerRequestAuthFilter</a></li><li><a href="#33-ratelimitingfilter">3.3 RateLimitingFilter</a></li><li><a href="#34-gzipencodingenforcingfilter">3.4 GzipEncodingEnforcingFilter</a></li><li><a href="#35-servletcontainer">3.5 ServletContainer</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹ EurekaServerConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Server å¯åŠ¨çš„è¿‡ç¨‹</strong>çš„ç¬¬äºŒéƒ¨åˆ† â€”â€” <strong>EurekaBootStrap</strong>ã€‚</p><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„ä»£ç ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸¤ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/?self">ServerConfig</a></li><li>ã€æœ¬æ–‡ã€‘EurekaBootStrap</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaBootStrap</h1><p><code>com.netflix.eureka.EurekaBootStrap</code>ï¼ŒEureka-Server <strong>å¯åŠ¨å…¥å£</strong>ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_14/01.png" alt=""></p><p>EurekaBootStrap å®ç°äº† <code>javax.servlet.ServletContextListener</code> <strong>æ¥å£</strong>ï¼Œåœ¨ Servlet å®¹å™¨( ä¾‹å¦‚ Tomcatã€Jetty )å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>#contextInitialized()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Serverï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaBootStrap</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// çœç•¥æ— å…³å˜é‡å’Œæ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// åˆå§‹åŒ– Eureka-Server é…ç½®ç¯å¢ƒ</span></div><div class="line">            initEurekaEnvironment();</div><div class="line"></div><div class="line">            <span class="comment">// åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</span></div><div class="line">            initEurekaServerContext();</div><div class="line"></div><div class="line">            ServletContext sc = event.getServletContext();</div><div class="line">            sc.setAttribute(EurekaServerContext.class.getName(), serverContext);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            logger.error(<span class="string">"Cannot bootstrap eureka server :"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot bootstrap eureka server :"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#initEurekaEnvironment()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Server <strong>é…ç½®</strong>ç¯å¢ƒã€‚</li><li>è°ƒç”¨ <code>#initEurekaServerContext()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡ã€‚</li></ul><h2>2.1 åˆå§‹åŒ– Eureka-Server é…ç½®ç¯å¢ƒ</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaBootStrap.java</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* éƒ¨ç½²ç¯å¢ƒ - æµ‹æœ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST = <span class="string">"test"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* éƒ¨ç½²æ•°æ®ä¸­å¿ƒ - CLOUD</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLOUD = <span class="string">"cloud"</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* éƒ¨ç½²æ•°æ®ä¸­å¿ƒ - é»˜è®¤</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT = <span class="string">"default"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_DATACENTER = <span class="string">"archaius.deployment.datacenter"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_DATACENTER = <span class="string">"eureka.datacenter"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initEurekaEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    logger.info(<span class="string">"Setting the eureka configuration.."</span>);</div><div class="line"></div><div class="line">   <span class="comment">// è®¾ç½®é…ç½®æ–‡ä»¶çš„æ•°æ®ä¸­å¿ƒ</span></div><div class="line">   String dataCenter = ConfigurationManager.getConfigInstance().getString(EUREKA_DATACENTER);</div><div class="line">   <span class="keyword">if</span> (dataCenter == <span class="keyword">null</span>) &#123;</div><div class="line">       logger.info(<span class="string">"Eureka data center value eureka.datacenter is not set, defaulting to default"</span>);</div><div class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_DATACENTER, DEFAULT);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_DATACENTER, dataCenter);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// è®¾ç½®é…ç½®æ–‡ä»¶çš„ç¯å¢ƒ</span></div><div class="line">   String environment = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT);</div><div class="line">   <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123;</div><div class="line">       ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, TEST);</div><div class="line">       logger.info(<span class="string">"Eureka environment value eureka.environment is not set, defaulting to test"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è®¾ç½®åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius</a> å®ç°çš„é…ç½®æ–‡ä»¶çš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œè¯»å–<strong>åˆé€‚</strong>çš„é…ç½®æ–‡ä»¶ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€è¦è®¾ç½® <code>EUREKA_ENVIRONMENT</code> å³å¯ï¼Œä¸åŒçš„æœåŠ¡å™¨ç¯å¢ƒ( ä¾‹å¦‚ï¼Œ<code>PROD</code> / <code>TEST</code> ç­‰) è¯»å–ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚å®ç°åŸç†ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>æ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥é˜…è¯»ï¼š<a href="https://github.com/Netflix/archaius/wiki/Deployment-context" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetflix Archaius å®˜æ–¹æ–‡æ¡£ â€”â€” Deployment contextã€‹</a>ã€‚</li></ul><h2>2.2 åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</h2><p>EurekaBootStrap çš„ <code>#initEurekaServerContext()</code> æ–¹æ³•çš„å®ç°ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œå·²ç»å°†ä»£ç <strong>åˆ‡å—</strong> + <strong>ä¸­æ–‡æ³¨å†Œ</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/a1c6074fd038f1182132a43b1ebc4cc08166f0be/eureka-core/src/main/java/com/netflix/eureka/EurekaBootStrap.java#L137" rel="external nofollow noopener noreferrer" target="_blank">EurekaBootStrap</a> é“¾æ¥ï¼Œå¯¹ç…§ä¸‹é¢æ¯ä¸ªå°ç»“é˜…è¯»ç†è§£ã€‚</p><h3>2.2.1 åˆ›å»º Eureka-Server é…ç½®</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EurekaServerConfig eurekaServerConfig = <span class="keyword">new</span> DefaultEurekaServerConfig();</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <a href="http://www.iocoder.cn/Eureka/eureka-server-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹ ServerConfigã€‹ã€Œ2.3 DefaultEurekaServerConfigã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3>2.2.2 Eureka-Server è¯·æ±‚å’Œå“åº”çš„æ•°æ®å…¼å®¹</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// For backward compatibility</span></div><div class="line">JsonXStream.getInstance().registerConverter(<span class="keyword">new</span> V1AwareInstanceInfoConverter(), XStream.PRIORITY_VERY_HIGH);</div><div class="line">XmlXStream.getInstance().registerConverter(<span class="keyword">new</span> V1AwareInstanceInfoConverter(), XStream.PRIORITY_VERY_HIGH);</div></pre></td></tr></table></figure></p><ul><li>ç›®å‰ Eureka-Server æä¾› V2 ç‰ˆæœ¬ API ï¼Œå¦‚ä¸Šä»£ç ä¸»è¦å¯¹ V1 ç‰ˆæœ¬ API åšå…¼å®¹ã€‚å¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</li></ul><h3>2.2.3 åˆ›å»º Eureka-Server è¯·æ±‚å’Œå“åº”ç¼–è§£ç å™¨</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">logger.info(<span class="string">"Initializing the eureka client..."</span>);</div><div class="line">logger.info(eurekaServerConfig.getJsonCodecName());</div><div class="line">ServerCodecs serverCodecs = <span class="keyword">new</span> DefaultServerCodecs(eurekaServerConfig);</div></pre></td></tr></table></figure></p><h3>2.2.4 åˆ›å»º Eureka-Client</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">ApplicationInfoManager applicationInfoManager;</div><div class="line"><span class="keyword">if</span> (eurekaClient == <span class="keyword">null</span>) &#123;</div><div class="line">  EurekaInstanceConfig instanceConfig = isCloud(ConfigurationManager.getDeploymentContext())</div><div class="line">          ? <span class="keyword">new</span> CloudInstanceConfig()</div><div class="line">          : <span class="keyword">new</span> MyDataCenterInstanceConfig();</div><div class="line">  </div><div class="line">  applicationInfoManager = <span class="keyword">new</span> ApplicationInfoManager(</div><div class="line">          instanceConfig, <span class="keyword">new</span> EurekaConfigBasedInstanceInfoProvider(instanceConfig).get());</div><div class="line">  </div><div class="line">  EurekaClientConfig eurekaClientConfig = <span class="keyword">new</span> DefaultEurekaClientConfig();</div><div class="line">  eurekaClient = <span class="keyword">new</span> DiscoveryClient(applicationInfoManager, eurekaClientConfig);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  applicationInfoManager = eurekaClient.getApplicationInfoManager();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>Eureka-Server å†…åµŒ Eureka-Clientï¼Œç”¨äºå’Œ Eureka-Server é›†ç¾¤é‡Œå…¶ä»–èŠ‚ç‚¹é€šä¿¡äº¤äº’ã€‚</p></li><li><p>Eureka-Client çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ EurekaClientã€‹ã€Œ3. DiscoveryClientã€</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>Eureka-Client ä¹Ÿå¯ä»¥é€šè¿‡ EurekaBootStrap æ„é€ æ–¹æ³•ä¼ é€’ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaBootStrap</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> EurekaClient eurekaClient;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EurekaBootStrap</span><span class="params">(EurekaClient eurekaClient)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.eurekaClient = eurekaClient;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>å¤§å¤šæ•°æƒ…å†µä¸‹ç”¨ä¸åˆ°</strong>ã€‚</li></ul></li></ul><h3>2.2.5 åˆ›å»ºåº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">PeerAwareInstanceRegistry registry;</div><div class="line"><span class="keyword">if</span> (isAws(applicationInfoManager.getInfo())) &#123; <span class="comment">// AWS ç›¸å…³ï¼Œè·³è¿‡</span></div><div class="line">  registry = <span class="keyword">new</span> AwsInstanceRegistry(</div><div class="line">          eurekaServerConfig,</div><div class="line">          eurekaClient.getEurekaClientConfig(),</div><div class="line">          serverCodecs,</div><div class="line">          eurekaClient</div><div class="line">  );</div><div class="line">  awsBinder = <span class="keyword">new</span> AwsBinderDelegate(eurekaServerConfig, eurekaClient.getEurekaClientConfig(), registry, applicationInfoManager);</div><div class="line">  awsBinder.start();</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  registry = <span class="keyword">new</span> PeerAwareInstanceRegistryImpl(</div><div class="line">          eurekaServerConfig,</div><div class="line">          eurekaClient.getEurekaClientConfig(),</div><div class="line">          serverCodecs,</div><div class="line">          eurekaClient</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨<strong>ç±»å…³ç³»å›¾</strong>å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_14/02.png" alt=""></p></li><li><p>æœ¬æ–‡ä¸å±•å¼€åˆ†äº«ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-class-diagram/?self">ã€ŠEureka æºç è§£æ â€”â€” æ³¨å†Œè¡¨ InstanceRegistry ç±»å…³ç³»ã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul><h3>2.2.6 åˆ›å»º Eureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">PeerEurekaNodes peerEurekaNodes = getPeerEurekaNodes(</div><div class="line">      registry,</div><div class="line">      eurekaServerConfig,</div><div class="line">      eurekaClient.getEurekaClientConfig(),</div><div class="line">      serverCodecs,</div><div class="line">      applicationInfoManager</div><div class="line">);</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.eureka.cluster.PeerEurekaNodes</code>ï¼ŒEureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆï¼Œåœ¨<a href="#">ã€ŠTODO[0019]ï¼šé›†ç¾¤åˆå§‹åŒ–ã€‹</a>è¯¦ç»†è§£æã€‚</li></ul><h3>2.2.7 åˆ›å»º Eureka-Server ä¸Šä¸‹æ–‡</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">serverContext = <span class="keyword">new</span> DefaultEurekaServerContext(</div><div class="line">      eurekaServerConfig,</div><div class="line">      serverCodecs,</div><div class="line">      registry,</div><div class="line">      peerEurekaNodes,</div><div class="line">      applicationInfoManager</div><div class="line">);</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.eureka.EurekaServerContext</code>ï¼ŒEureka-Server ä¸Šä¸‹æ–‡<strong>æ¥å£</strong>ï¼Œæä¾›Eureka-Server å†…éƒ¨å„ç»„ä»¶å¯¹è±¡çš„<strong>åˆå§‹åŒ–</strong>ã€<strong>å…³é—­</strong>ã€<strong>è·å–</strong>ç­‰æ–¹æ³•ã€‚</p></li><li><p><code>com.netflix.eureka.EurekaServerContext.DefaultEurekaServerContext</code>ï¼ŒEureka-Server ä¸Šä¸‹æ–‡<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaServerContext</span> <span class="keyword">implements</span> <span class="title">EurekaServerContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaServerConfig serverConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server è¯·æ±‚å’Œå“åº”ç¼–è§£ç å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecs serverCodecs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PeerEurekaNodes peerEurekaNodes;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯ç®¡ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>2.2.8 åˆå§‹åŒ– EurekaServerContextHolder</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EurekaServerContextHolder.initialize(serverContext);</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.eureka.EurekaServerContextHolder</code>ï¼ŒEureka-Server ä¸Šä¸‹æ–‡æŒæœ‰è€…ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–åˆ° Eureka-Server ä¸Šä¸‹æ–‡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerContextHolder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æŒæœ‰è€…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EurekaServerContextHolder holder;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaServerContext serverContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">EurekaServerContextHolder</span><span class="params">(EurekaServerContext serverContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.serverContext = serverContext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> EurekaServerContext <span class="title">getServerContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.serverContext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆå§‹åŒ–</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> serverContext Eureka-Server ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(EurekaServerContext serverContext)</span> </span>&#123;</div><div class="line">        holder = <span class="keyword">new</span> EurekaServerContextHolder(serverContext);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaServerContextHolder <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> holder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>2.2.9 åˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">serverContext.initialize();</div><div class="line">logger.info(<span class="string">"Initialized server context"</span>);</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ServerContext#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Eureka-Server ä¸Šä¸‹æ–‡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DefaultEurekaServerContext.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   logger.info(<span class="string">"Initializing ..."</span>);</div><div class="line"></div><div class="line">   <span class="comment">// å¯åŠ¨ Eureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆï¼ˆå¤åˆ¶ï¼‰</span></div><div class="line">   peerEurekaNodes.start();</div><div class="line">   <span class="comment">// åˆå§‹åŒ– åº”ç”¨å®ä¾‹ä¿¡æ¯çš„æ³¨å†Œè¡¨</span></div><div class="line">   registry.init(peerEurekaNodes);</div><div class="line"></div><div class="line">   logger.info(<span class="string">"Initialized"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>2.2.10 ä»å…¶ä»– Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Copy registry from neighboring eureka node</span></div><div class="line"><span class="keyword">int</span> registryCount = registry.syncUp();</div><div class="line">registry.openForTraffic(applicationInfoManager, registryCount);</div></pre></td></tr></table></figure></p><ul><li>æœ¬æ–‡ä¸å±•å¼€åˆ†äº«ï¼Œåœ¨<a href="#">ã€ŠTODO[0019]ï¼šé›†ç¾¤åˆå§‹åŒ–ã€‹</a>è¯¦ç»†è§£æã€‚</li></ul><h3>2.2.11 æ³¨å†Œç›‘æ§</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Register all monitoring statistics.</span></div><div class="line">EurekaMonitors.registerAllStats();</div></pre></td></tr></table></figure></p><ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul><h1>3. Filter</h1><p>Eureka-Server è¿‡æ»¤å™¨( <code>javax.servlet.Filter</code> ) <strong>é¡ºåº</strong>å¦‚ä¸‹ï¼š</p><ul><li>StatusFilter</li><li>ServerRequestAuthFilter</li><li>RateLimitingFilter</li><li>GzipEncodingEnforcingFilter</li><li>ServletContainer</li></ul><h2>3.1 StatusFilter</h2><p><code>com.netflix.eureka.StatusFilter</code>ï¼ŒEureka-Server çŠ¶æ€è¿‡æ»¤å™¨ã€‚å½“ Eureka-Server æœªå¤„äºå¼€å¯( <code>InstanceStatus.UP</code> )çŠ¶æ€ï¼Œè¿”å› HTTP çŠ¶æ€ç  307 é‡å®šå‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// StatusFilter.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SC_TEMPORARY_REDIRECT = <span class="number">307</span>;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></div><div class="line"><span class="function"><span class="params">                   FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">  InstanceInfo myInfo = ApplicationInfoManager.getInstance().getInfo();</div><div class="line">  InstanceStatus status = myInfo.getStatus();</div><div class="line">  <span class="keyword">if</span> (status != InstanceStatus.UP &amp;&amp; response <span class="keyword">instanceof</span> HttpServletResponse) &#123;</div><div class="line">      HttpServletResponse httpRespone = (HttpServletResponse) response;</div><div class="line">      httpRespone.sendError(SC_TEMPORARY_REDIRECT,</div><div class="line">              <span class="string">"Current node is currently not ready to serve requests -- current status: "</span></div><div class="line">                      + status + <span class="string">" - try another DS node: "</span>);</div><div class="line">  &#125;</div><div class="line">  chain.doFilter(request, response);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3.2 ServerRequestAuthFilter</h2><p><code>com.netflix.eureka.ServerRequestAuthFilter</code>ï¼ŒEureka-Server è¯·æ±‚è®¤è¯è¿‡æ»¤å™¨ã€‚Eureka-Server æœªå®ç°è®¤è¯ã€‚ç›®å‰æ‰“å°è®¿é—®çš„å®¢æˆ·ç«¯åå’Œç‰ˆæœ¬å·ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ServerRequestAuthFilter.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">logAuth</span><span class="params">(ServletRequest request)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (serverConfig.shouldLogIdentityHeaders()) &#123;</div><div class="line">       <span class="keyword">if</span> (request <span class="keyword">instanceof</span> HttpServletRequest) &#123;</div><div class="line">           HttpServletRequest httpRequest = (HttpServletRequest) request;</div><div class="line"></div><div class="line">           String clientName = getHeader(httpRequest, AbstractEurekaIdentity.AUTH_NAME_HEADER_KEY);</div><div class="line">           String clientVersion = getHeader(httpRequest, AbstractEurekaIdentity.AUTH_VERSION_HEADER_KEY);</div><div class="line"></div><div class="line">           DynamicCounter.increment(MonitorConfig.builder(NAME_PREFIX + clientName + <span class="string">"-"</span> + clientVersion).build());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></code></pre><h2>3.3 RateLimitingFilter</h2><p><code>com.netflix.eureka.RateLimitingFilter</code>ï¼Œè¯·æ±‚é™æµè¿‡æ»¤å™¨ã€‚åœ¨<a href="#">ã€ŠTODO[0020]ï¼šé™æµã€‹</a>è¯¦ç»†è§£æã€‚</p><h2>3.4 GzipEncodingEnforcingFilter</h2><p><code>com.netflix.eureka.GzipEncodingEnforcingFilter</code>ï¼ŒGZIP ç¼–ç è¿‡æ»¤å™¨ã€‚</p><h2>3.5 ServletContainer</h2><p><code>com.sun.jersey.spi.container.servlet.ServletContainer</code>ï¼ŒJersey MVC è¯·æ±‚è¿‡æ»¤å™¨ã€‚</p><ul><li><p>Jersey MVC æ¨¡å¼å¦‚ä¸‹å›¾ï¼š</p><blockquote><p>FROM <a href="http://blog.csdn.net/wangqyoho/article/details/51981916" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJerseyæ¡†æ¶çš„MVCã€‹</a><img src="http://www.iocoder.cn/images/Eureka/2018_05_14/03.png" alt=""></p></blockquote></li><li><p>åœ¨ <code>com.netflix.eureka.resources</code> åŒ…é‡Œï¼Œæœ‰æ‰€æœ‰çš„ Eureka-Server Jersey Resource ( Controller )ã€‚</p></li><li><p>è¿‡æ»¤å™¨åœ¨ <code>web.xml</code> é…ç½®å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>jersey<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.sun.jersey.spi.container.servlet.ServletContainer<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.config.property.WebPageContentRegex<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/(flex|images|js|css|jsp)/.*<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.config.property.packages<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.sun.jersey;com.netflix<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- GZIP content encoding/decoding --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.spi.container.ContainerRequestFilters<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.sun.jersey.api.container.filter.GZIPContentEncodingFilter<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>com.sun.jersey.spi.container.ContainerResponseFilters<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.sun.jersey.api.container.filter.GZIPContentEncodingFilter<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>jersey<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p></li></ul><h1>666. å½©è›‹</h1><p>å•¦å•¦å•¦ï¼ŒEureka-Server å¯åŠ¨å®Œæˆï¼</p><p>å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ›´åŠ æœ‰è¶£çš„æ³¨å†Œã€ç»­çº¦ã€å–æ¶ˆæ³¨å†Œã€è¿‡æœŸç­‰ç­‰ Eureka-Client ä¸ Eureka-Server çš„äº¤äº’ã€‚</p><p>æèµ·ï¼</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Server å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹ ServerConfig</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-server-init-first/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-server-init-first/</id>
    <published>2018-05-06T16:00:00.000Z</published>
    <updated>2017-10-08T04:04:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-eurekaserverconfig">2. EurekaServerConfig</a><ul><li><a href="#21-%E7%B1%BB%E5%85%B3%E7%B3%BB%E5%9B%BE">2.1 ç±»å…³ç³»å›¾</a></li><li><a href="#22-%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7">2.2 é…ç½®å±æ€§</a></li><li><a href="#23-defaulteurekaserverconfig">2.3 DefaultEurekaServerConfig</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server å¯åŠ¨çš„è¿‡ç¨‹</strong>ã€‚</p><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„ä»£ç ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸¤ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li>ã€æœ¬æ–‡ã€‘ServerConfig</li><li><a href="http://www.iocoder.cn/Eureka/eureka-server-init-second/?self">EurekaBootStrap</a></li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaServerConfig</h1><p><code>com.netflix.eureka.EurekaServerConfig</code>ï¼Œ<strong>Eureka-Server</strong> é…ç½®<strong>æ¥å£</strong>ã€‚</p><h2>2.1 ç±»å…³ç³»å›¾</h2><p><img src="http://www.iocoder.cn/images/Eureka/2018_05_07/01.png" alt=""></p><h2>2.2 é…ç½®å±æ€§</h2><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/8b0f67ac33116ee05faad1ff5125034cfcf573bf/eureka-core/src/main/java/com/netflix/eureka/EurekaServerConfig.java" rel="external nofollow noopener noreferrer" target="_blank">EurekaServerConfig</a> æŸ¥çœ‹é…ç½®å±æ€§ç®€ä»‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç€è‹±æ–‡æ³¨é‡Šä¸€èµ·ç†è§£ã€‚è¿™é‡Œç¬”è€…æ‘˜å‡ºéƒ¨åˆ†è¾ƒä¸ºé‡è¦çš„å±æ€§ï¼š</p><ul><li><p><strong>è¯·æ±‚è®¤è¯ç›¸å…³</strong></p><ul><li>Eureka-Server æœªå®ç°è®¤è¯ã€‚åœ¨ Spring-Cloud-Eureka-Serverï¼Œé€šè¿‡ <code>spring-boot-starter-security</code> æ¨¡å—æ”¯æŒã€‚<a href="http://blog.csdn.net/liuchuanhong1/article/details/54729556" rel="external nofollow noopener noreferrer" target="_blank">ã€Šspring cloud-ç»™Eureka ServeråŠ ä¸Šå®‰å…¨çš„ç”¨æˆ·è®¤è¯ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><code>#shouldLogIdentityHeaders()</code> ï¼šæ‰“å°è®¿é—®çš„å®¢æˆ·ç«¯åå’Œç‰ˆæœ¬å·ï¼Œé…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul></li><li><p><strong>è¯·æ±‚é™æµç›¸å…³</strong></p><ul><li>TODO[0020]ï¼šé™æµ</li><li><code>#isRateLimiterEnabled()</code> ï¼šè¯·æ±‚é™æµæ˜¯å¦å¼€å¯ã€‚</li><li><code>#isRateLimiterThrottleStandardClients()</code> ï¼šæ˜¯å¦é™åˆ¶<strong>éæ ‡å‡†</strong>å®¢æˆ·ç«¯çš„è®¿é—®ã€‚<strong>æ ‡å‡†å®¢æˆ·ç«¯</strong>é€šè¿‡è¯·æ±‚å¤´( <code>header</code> )çš„ <code>&quot;DiscoveryIdentity-Name&quot;</code> æ¥åˆ¤æ–­ï¼Œæ˜¯å¦åœ¨æ ‡å‡†å®¢æˆ·ç«¯åé›†åˆé‡Œã€‚</li><li><code>#getRateLimiterPrivilegedClients()</code> ï¼š<strong>æ ‡å‡†</strong>å®¢æˆ·ç«¯åé›†åˆã€‚é»˜è®¤åŒ…å«<code>&quot;DefaultClient&quot;</code> å’Œ <code>&quot;DefaultServer&quot;</code> ã€‚</li><li><code>#getRateLimiterBurstSize()</code> ï¼šé€Ÿç‡é™åˆ¶çš„ burst size ï¼Œä½¿ç”¨<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>ã€‚</li><li><code>#getRateLimiterRegistryFetchAverageRate()</code> ï¼š<strong>å¢é‡</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯çš„é€Ÿç‡é™åˆ¶ã€‚</li><li><code>#getRateLimiterFullFetchAverageRate()</code> ï¼š<strong>å…¨é‡</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯çš„é€Ÿç‡é™åˆ¶ã€‚</li></ul></li><li><p><strong>è·å–æ³¨å†Œä¿¡æ¯è¯·æ±‚ç›¸å…³</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>#shouldUseReadOnlyResponseCache()</code> ï¼šæ˜¯å¦å¼€å¯åªè¯»è¯·æ±‚å“åº”ç¼“å­˜ã€‚å“åº”ç¼“å­˜ ( ResponseCache ) æœºåˆ¶ç›®å‰ä½¿ç”¨ä¸¤å±‚ç¼“å­˜ç­–ç•¥ã€‚ä¼˜å…ˆè¯»å–<strong>åªè¯»ç¼“å­˜</strong>ï¼Œè¯»å–ä¸åˆ°åè¯»å–<strong>å›ºå®šè¿‡æœŸ</strong>çš„<strong>è¯»å†™ç¼“å­˜</strong>ã€‚</li><li><code>#getResponseCacheUpdateIntervalMs()</code> ï¼š<strong>åªè¯»ç¼“å­˜</strong>æ›´æ–°é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚<strong>åªè¯»ç¼“å­˜</strong>å®šæ—¶æ›´æ–°ä»»åŠ¡åªæ›´æ–°è¯»å–è¿‡è¯·æ±‚ (<code>com.netflix.eureka.registry.Key</code>)ï¼Œå› æ­¤è™½ç„¶æ°¸ä¸è¿‡æœŸï¼Œä¹Ÿä¼šå­˜åœ¨è¯»å–ä¸åˆ°çš„æƒ…å†µã€‚</li><li><code>#getResponseCacheAutoExpirationInSeconds()</code> ï¼š<strong>è¯»å†™ç¼“å­˜</strong>å†™å…¥åè¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getRetentionTimeInMSInDeltaQueue()</code>ï¼šç§Ÿçº¦å˜æ›´è®°å½•è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š 3 * 60 * 1000 æ¯«ç§’ã€‚</li><li><code>#DeltaRetentionTimerIntervalInMs()</code>ï¼šç§»é™¤é˜Ÿåˆ—é‡Œè¿‡æœŸçš„ç§Ÿçº¦å˜æ›´è®°å½•çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚</li></ul></li><li><p><strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³</strong></p><ul><li><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>#shouldEnableSelfPreservation()</code> ï¼šæ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p><blockquote><p>FROM <a href="http://www.itmuch.com/spring-cloud-sum/understanding-eureka-self-preservation/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">å‘¨ç«‹â€”â€”ã€Šç†è§£Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‹</a><br>å½“Eureka ServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚<br>ä¸€æ—¦è¿›å…¥è¯¥æ¨¡å¼ï¼ŒEureka Serverå°±ä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šæ³¨é”€ä»»ä½•å¾®æœåŠ¡ï¼‰ã€‚<br>å½“ç½‘ç»œæ•…éšœæ¢å¤åï¼Œè¯¥Eureka ServerèŠ‚ç‚¹ä¼šè‡ªåŠ¨é€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p></blockquote></li><li><p><code>#getRenewalPercentThreshold()</code> ï¼šå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼æ¯”ä¾‹ï¼Œè¶…è¿‡è¯¥æ¯”ä¾‹åå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚</p></li><li><p><code>#getRenewalThresholdUpdateIntervalMs()</code> ï¼šè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼æ¯”ä¾‹æ›´æ–°å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</p></li></ul></li><li><p><strong>æ³¨å†Œçš„åº”ç”¨å®ä¾‹çš„ç§Ÿçº¦è¿‡æœŸç›¸å…³</strong></p><ul><li><p>åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-evict/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>#getEvictionIntervalTimerInMs()</code> ï¼šç§Ÿçº¦è¿‡æœŸå®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</p></li></ul></li><li><p><strong>Eureka-Server è¿œç¨‹èŠ‚ç‚¹( éé›†ç¾¤ )è¯»å–ç›¸å…³</strong></p><ul><li>TODO[0009]ï¼šRemoteRegionRegistry</li><li><code>#getRemoteRegionUrlsWithName()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚<ul><li><code>key</code> ï¼šEureka-Server åŒºåŸŸ( <code>region</code> )</li><li><code>value</code> ï¼šEureka-Server åœ°å€</li></ul></li><li><code>#getRemoteRegionAppWhitelist()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><code>#getRemoteRegionRegistryFetchInterval()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><code>#getRegistrySyncRetries()</code> ï¼šEureka-Server <strong>å¯åŠ¨</strong>æ—¶ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–å¤±è´¥é‡è¯•æ¬¡æ•°ã€‚</li><li><code>#getRegistrySyncRetryWaitMs()</code> ï¼šEureka-Server <strong>å¯åŠ¨</strong>æ—¶ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–å¤±è´¥ç­‰å¾…( <code>sleep</code> )é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</li><li><code>#getRemoteRegionFetchThreadPoolSize()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistryã€‚</li><li><code>#disableTransparentFallbackToOtherRegion()</code> ï¼šæ˜¯å¦ç¦ç”¨æœ¬åœ°è¯»å–ä¸åˆ°æ³¨å†Œä¿¡æ¯ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–ã€‚</li></ul></li><li><p><strong>Eureka-Server é›†ç¾¤åŒæ­¥ç›¸å…³</strong></p><ul><li>TODO[0021]ï¼šé›†ç¾¤åŒæ­¥</li><li><code>#getMaxThreadsForPeerReplication()</code> ï¼šåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯æœ€å¤§çº¿ç¨‹æ•°ã€‚</li><li><code>#getMaxElementsInPeerReplicationPool()</code> ï¼šå¾…æ‰§è¡ŒåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯äº‹ä»¶ç¼“å†²æœ€å¤§æ•°é‡ã€‚</li><li><code>#getMaxTimeForReplication()</code> ï¼šæ‰§è¡Œå•ä¸ªåŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯çŠ¶æ€ä»»åŠ¡æœ€å¤§æ—¶é—´ã€‚</li><li><code>#shouldSyncWhenTimestampDiffers()</code> ï¼šæ˜¯å¦åŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå½“åº”ç”¨å®ä¾‹ä¿¡æ¯æœ€åæ›´æ–°æ—¶é—´æˆ³( <code>lastDirtyTimestamp</code> )å‘ç”Ÿæ”¹å˜ã€‚</li><li><code>#getWaitTimeInMsWhenSyncEmpty()</code> ï¼šEureka-Server <strong>å¯åŠ¨</strong>æ—¶ï¼Œä»è¿œç¨‹ Eureka-Server è¯»å–ä¸åˆ°æ³¨å†Œä¿¡æ¯æ—¶ï¼Œå¤šé•¿æ—¶é—´ä¸å…è®¸ Eureka-Client è®¿é—®ã€‚TODO[0019]ï¼šé›†ç¾¤åˆå§‹åŒ–</li><li><code>#getPeerEurekaNodesUpdateIntervalMs()</code> ï¼šEureka-Server é›†ç¾¤èŠ‚ç‚¹æ›´æ–°é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚TTODO[0019]ï¼šé›†ç¾¤åˆå§‹åŒ–</li></ul></li></ul><h2>2.3 DefaultEurekaServerConfig</h2><p><code>com.netflix.eureka.DefaultEurekaServerConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„ <strong>Eureka-Server</strong> é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaServerConfig</span> <span class="keyword">implements</span> <span class="title">EurekaServerConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•å’Œå±æ€§</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST = <span class="string">"test"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance = com.netflix.config.DynamicPropertyFactory.getInstance();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DynamicStringProperty EUREKA_PROPS_FILE = DynamicPropertyFactory</div><div class="line">            .getInstance().getStringProperty(<span class="string">"eureka.server.props"</span>, <span class="string">"eureka-server"</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String namespace = <span class="string">"eureka."</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaServerConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaServerConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="comment">// è®¾ç½® namespaceï¼Œä¸º "." ç»“å°¾</span></div><div class="line">        <span class="keyword">this</span>.namespace = namespace;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        String env = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT, TEST);</div><div class="line">        ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, env);</div><div class="line">        String eurekaPropsFile = EUREKA_PROPS_FILE.get();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ConfigurationManager</span></div><div class="line">            <span class="comment">// .loadPropertiesFromResources(eurekaPropsFile);</span></div><div class="line">            ConfigurationManager.loadCascadedPropertiesFromResources(eurekaPropsFile);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.warn(<span class="string">"Cannot find the properties specified : &#123;&#125;. This may be okay if there are other environment "</span></div><div class="line">                            + <span class="string">"specific properties or the configuration is installed with a different mechanism."</span>, eurekaPropsFile);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–é…ç½®æ–‡ä»¶å¯¹è±¡ã€‚ç±»ä¼¼ PropertiesInstanceConfigï¼Œç‚¹å‡»<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æŸ¥çœ‹è¯¦ç»†è§£æã€‚<strong>é»˜è®¤é…ç½®æ–‡ä»¶å</strong>ä¸º <code>eureka-server</code>ã€‚</li><li>æ— é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY çš„æšä¸¾ç±»ã€‚</li></ul><h1>666. å½©è›‹</h1><p>æ¶‰åŠåˆ°é…ç½®ï¼Œå†…å®¹åˆçœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¤šï¼Œæ…¢æ…¢ç†è§£åï¼Œå°±ä¼šå˜å¾—å¾ˆâ€œå•°å—¦â€ï¼Œè¯·ä¿æŒè€å¿ƒã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-server-init-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;u
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ EurekaClient</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-third/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-third/</id>
    <published>2018-04-28T16:00:00.000Z</published>
    <updated>2017-10-08T04:02:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-third/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-eurekaclient">2. EurekaClient</a><ul><li><a href="#21-lookupservice">2.1 LookupService</a></li></ul></li><li><a href="#3-discoveryclient">3. DiscoveryClient</a><ul><li><a href="#31-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0">3.1 æ„é€ æ–¹æ³•å‚æ•°</a></li><li><a href="#32-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">3.2 æ„é€ æ–¹æ³•</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>çš„ç¬¬ä¸‰éƒ¨åˆ† â€”â€” <strong>EurekaClient</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li>ï¼ˆä¸€ï¼‰<a href="(http://www.iocoder.cn/Eureka/eureka-client-init-first/)">EurekaInstanceConfig</a></li><li>ï¼ˆäºŒï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">EurekaClientConfig</a></li><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆä¸‰ï¼‰EurekaClient</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaClient</h1><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/EurekaClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.EurekaClient</code></a>ï¼ŒEureka-Client <strong>æ¥å£</strong>ï¼Œå£°æ˜å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>æä¾›<strong>å¤šç§</strong>æ–¹æ³•è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å®ä¾‹ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚</li><li>æä¾›æ–¹æ³•è·å–<strong>æœ¬åœ°</strong>å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨ç®¡ç†å™¨( <code>com.netflix.appinfo.ApplicationInfoManager</code> )å’Œ Eureka-Client é…ç½®( <code>com.netflix.discovery.EurekaClientConfig</code> )ã€‚</li><li>æä¾›æ–¹æ³•<strong>æ³¨å†Œ</strong>æœ¬åœ°å®¢æˆ·ç«¯çš„å¥åº·æ£€æŸ¥å’Œ Eureka äº‹ä»¶ç›‘å¬å™¨ã€‚</li></ul><p>å¦å¤–ï¼ŒEureka 2.X ç‰ˆæœ¬æ­£åœ¨å¼€å‘ï¼Œè¯¥æ¥å£ä¸º Eureka 1.X å’Œ 2.X æä¾›å¹³æ»‘è¿‡æ¸¡æ¥å£ã€‚</p><blockquote><p>This interface does NOT try to clean up the current client interface for eureka 1.x. Rather it tries to provide an easier transition path from eureka 1.x to eureka 2.x.</p></blockquote><h2>2.1 LookupService</h2><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/shared/LookupService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.shared.LookupService</code></a>ï¼ŒæŸ¥æ‰¾æœåŠ¡<strong>æ¥å£</strong>ï¼Œæä¾›<strong>ç®€å•å•ä¸€</strong>çš„æ–¹å¼è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å®ä¾‹ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_29/01.png" alt=""></p><ul><li>åœ¨ Eureka-Client é‡Œï¼ŒEurekaClient ç»§æ‰¿è¯¥æ¥å£ã€‚</li><li>åœ¨ Eureka-Server é‡Œï¼Œ<code>com.netflix.eureka.registry.InstanceRegistry</code> ç»§æ‰¿è¯¥æ¥å£ã€‚</li></ul><h1>3. DiscoveryClient</h1><p><code>com.netflix.discovery.DiscoveryClient</code>ï¼Œå®ç° EurekaClient <strong>æ¥å£</strong>ï¼Œç”¨äºä¸ Eureka-Server äº¤äº’ã€‚å®ç°å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>å‘ Eureka-Server <strong>æ³¨å†Œ</strong>è‡ªèº«æœåŠ¡</li><li>å‘ Eureka-Server <strong>ç»­çº¦</strong>è‡ªèº«æœåŠ¡</li><li>å‘ Eureka-Server <strong>å–æ¶ˆ</strong>è‡ªèº«æœåŠ¡ï¼Œå½“å…³é—­æ—¶</li><li>ä» Eureka-Server <strong>æŸ¥è¯¢</strong>åº”ç”¨é›†åˆå’Œåº”ç”¨å®ä¾‹ä¿¡æ¯</li><li><em>ç®€å•æ¥ç†è§£ï¼Œå¯¹ Eureka-Server æœåŠ¡çš„å¢åˆ æ”¹æŸ¥</em></li></ul><h2>3.1 æ„é€ æ–¹æ³•å‚æ•°</h2><p>DiscoveryClient <strong>å®Œæ•´</strong>æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">     <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>ApplicationInfoManagerï¼Œåœ¨<a href="ttp://www.iocoder.cn/Eureka/eureka-client-init-first/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p>EurekaClientConfigï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfigã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>com.netflix.discovery.BackupRegistry</code>ï¼Œå¤‡ä»½æ³¨å†Œä¸­å¿ƒ<strong>æ¥å£</strong>ã€‚å½“ Eureka-Client å¯åŠ¨æ—¶ï¼Œæ— æ³•ä» Eureka-Server è¯»å–æ³¨å†Œä¿¡æ¯ï¼ˆå¯èƒ½æŒ‚äº†ï¼‰ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè¯»å–æ³¨å†Œä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BackupRegistry.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BackupRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Applications <span class="title">fetchRegistry</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Applications <span class="title">fetchRegistry</span><span class="params">(String[] includeRemoteRegions)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NotImplementedRegistryImpl.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotImplementedRegistryImpl</span> <span class="keyword">implements</span> <span class="title">BackupRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">(String[] includeRemoteRegions)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä» <code>com.netflix.discovery.NotImplementedRegistryImpl</code> å¯ä»¥çœ‹å‡ºï¼Œç›®å‰ Eureka-Client æœªæä¾›åˆé€‚çš„é»˜è®¤å®ç°ã€‚</li></ul></li><li><p><code>com.netflix.discovery.AbstractDiscoveryClientOptionalArgs</code>ï¼ŒDiscoveryClient å¯é€‰å‚æ•°æŠ½è±¡åŸºç±»ã€‚ä¸åŒäºä¸Šé¢ä¸‰ä¸ª<strong>å¿…å¡«</strong>å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯<strong>é€‰å¡«</strong>å‚æ•°ï¼Œå®é™…ç”Ÿäº§ä¸‹ä½¿ç”¨è¾ƒå°‘ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆå¥åº·æ£€æŸ¥å›è°ƒçš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Provider&lt;HealthCheckCallback&gt; healthCheckCallbackProvider;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆå¥åº·æ£€æŸ¥å¤„ç†å™¨çš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Provider&lt;HealthCheckHandler&gt; healthCheckHandlerProvider;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    PreRegistrationHandler preRegistrationHandler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey è¿‡æ»¤å™¨é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Collection&lt;T&gt; additionalFilters;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey å®¢æˆ·ç«¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    EurekaJerseyClient eurekaJerseyClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆ Jersey å®¢æˆ·ç«¯çš„å·¥å‚çš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TransportClientFactories transportClientFactories;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka äº‹ä»¶ç›‘å¬å™¨é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Set&lt;EurekaEventListener&gt; eventListeners;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.appinfo.HealthCheckCallback</code>ï¼Œå¥åº·æ£€æŸ¥å›è°ƒ<strong>æ¥å£</strong>ï¼Œç›®å‰å·²ç»åºŸå¼ƒï¼Œä½¿ç”¨ HealthCheckHandler æ›¿ä»£ï¼Œ<strong>ä½ å¯ä»¥ä¸å…³æ³¨è¯¥å‚æ•°</strong>ã€‚</p></li><li><p><code>com.netflix.appinfo.HealthCheckHandler</code>ï¼Œå¥åº·æ£€æŸ¥å¤„ç†å™¨<strong>æ¥å£</strong>ï¼Œç›®å‰æš‚æœªæä¾›åˆé€‚çš„<strong>é»˜è®¤</strong>å®ç°ï¼Œå”¯ä¸€æä¾›çš„ <code>com.netflix.appinfo.HealthCheckCallbackToHandlerBridge</code>ï¼Œç”¨äºå°† HealthCheckCallback <strong>æ¡¥æ¥</strong>æˆ HealthCheckHandlerï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HealthCheckHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HealthCheckHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HealthCheckCallbackToHandlerBridge.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthCheckCallbackToHandlerBridge</span> <span class="keyword">implements</span> <span class="title">HealthCheckHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthCheckCallback callback;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HealthCheckCallbackToHandlerBridge</span><span class="params">()</span> </span>&#123;</div><div class="line">        callback = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HealthCheckCallbackToHandlerBridge</span><span class="params">(HealthCheckCallback callback)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.callback = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == callback || InstanceInfo.InstanceStatus.STARTING == currentStatus</div><div class="line">                || InstanceInfo.InstanceStatus.OUT_OF_SERVICE == currentStatus) &#123; <span class="comment">// Do not go to healthcheck handler if the status is starting or OOS.</span></div><div class="line">            <span class="keyword">return</span> currentStatus;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> callback.isHealthy() ? InstanceInfo.InstanceStatus.UP : InstanceInfo.InstanceStatus.DOWN;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>åœ¨ Spring-Cloud-Eureka-Clientï¼Œæä¾›äº†é»˜è®¤å®ç° <a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/82991a7fc2859b6345b7f67e2461dbf5d7663836/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaHealthCheckHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.netflix.eureka.EurekaHealthCheckHandler</code></a>ï¼Œéœ€è¦ç»“åˆ <a href="https://github.com/spring-projects/spring-boot/tree/c79568886406662736dcdce78f65e7f46dd62696/spring-boot-actuator/" rel="external nofollow noopener noreferrer" target="_blank"><code>spirng-boot-actuate</code></a> ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ã€‚æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO[0004]ï¼šå¥åº·æ£€æŸ¥ï¼‰</li></ul></li><li><p><code>com.netflix.discovery.PreRegistrationHandler</code>ï¼Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨<strong>æ¥å£</strong>ï¼Œç›®å‰æš‚æœªæä¾›é»˜è®¤å®ç°ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨æ³¨å†Œå‰åšä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PreRegistrationHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeRegistration</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p><code>additionalFilters</code>ï¼ŒJersey è¿‡æ»¤å™¨é›†åˆã€‚è¿™é‡Œå£°æ˜æ³›å‹ <code>&lt;T&gt;</code> çš„åŸå› ï¼ŒJersey 1.X å’Œ Jersey 2.X çš„è¿‡æ»¤å™¨æ¥å£<strong>ä¸åŒ</strong>ï¼Œé€šè¿‡æ³›å‹æ¥æ”¯æŒã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Jersey1DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">ClientFilter</span>&gt; </span>&#123;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// Jersey2DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jersey2DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">ClientRequestFilter</span>&gt; </span>&#123;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>Jersey 1.X ä½¿ç”¨ ClientFilter ã€‚ClientFilter ç›®å‰æœ‰ä¸¤ä¸ªè¿‡æ»¤å™¨å®ç°ï¼šEurekaIdentityHeaderFilter ã€DynamicGZIPContentEncodingFilter ã€‚</li><li>Jersey 2.X ä½¿ç”¨ ClientRequestFilter ã€‚</li><li>DiscoveryClient ä½¿ç”¨ DiscoveryClientOptionalArgsï¼Œå³ Jersey 1.X ã€‚</li></ul></li><li><p><code>eurekaJerseyClient</code>ï¼ŒJersey å®¢æˆ·ç«¯ã€‚è¯¥<strong>å‚æ•°</strong>ç›®å‰åºŸå¼ƒï¼Œä½¿ç”¨ä¸‹é¢ TransportClientFactories å‚æ•°æ¥è¿›è¡Œç”Ÿæˆã€‚</p></li><li><p><code>com.netflix.discovery.shared.transport.jersey.TransportClientFactories</code>ï¼Œç”Ÿæˆ Jersey å®¢æˆ·ç«¯<strong>å·¥å‚çš„å·¥å‚</strong>æ¥å£ã€‚ç›®å‰æœ‰ Jersey1TransportClientFactories ã€Jersey2TransportClientFactories ä¸¤ä¸ªå®ç°ã€‚TransportClientFactories å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransportClientFactories.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactories</span>&lt;<span class="title">F</span>&gt; </span>&#123;</div><div class="line">  </div><div class="line">      <span class="meta">@Deprecated</span></div><div class="line">      <span class="function">TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> Collection&lt;F&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> EurekaJerseyClient providedJerseyClient)</span></span>;</div><div class="line">  </div><div class="line">      <span class="function">TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> Collection&lt;F&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransportClientFactory.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="function">EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span></span>;</div><div class="line">    </div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ä¸€ä¸ªæ–¹æ³•å·²ç»åºŸå¼ƒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ä¸Šé¢çš„ <code>eurekaJerseyClient</code> <strong>å‚æ•°</strong>( ä¸æ˜¯ EurekaJerseyClient ç±»)å·²ç»åºŸå¼ƒï¼Œè¢«ç¬¬äºŒä¸ªæ–¹æ³•å–ä»£ã€‚ç›¸æ¯”æ¥è¯´ï¼Œç¬¬äºŒä¸ªæ–¹æ³•å¯¹ EurekaJerseyClient åˆ›å»ºå°è£…ä¼šæ›´å¥½ã€‚</li></ul></li></ul></li><li><p><code>com.netflix.discovery.EurekaEventListener</code>ï¼ŒEureka äº‹ä»¶ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEventListener</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// EurekaEvent.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEvent</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryEvent.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryEvent</span> <span class="keyword">implements</span> <span class="title">EurekaEvent</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timestamp;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.netflix.discovery.StatusChangeEvent</code>ï¼Œåº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>com.netflix.discovery.CacheRefreshedEvent</code>ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2>3.2 æ„é€ æ–¹æ³•</h2><p>DiscoveryClient çš„æ„é€ æ–¹æ³•å®ç°ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œå·²ç»å°†ä»£ç <strong>åˆ‡å—</strong> + <strong>ä¸­æ–‡æ³¨å†Œ</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/DiscoveryClient.java#L298" rel="external nofollow noopener noreferrer" target="_blank">DiscoveryClient</a> é“¾æ¥ï¼Œå¯¹ç…§ä¸‹é¢æ¯ä¸ªå°ç»“é˜…è¯»ç†è§£ã€‚</p><h3>3.2.1 èµ‹å€¼ AbstractDiscoveryClientOptionalArgs</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.healthCheckHandlerProvider = args.healthCheckHandlerProvider;</div><div class="line">  <span class="keyword">this</span>.healthCheckCallbackProvider = args.healthCheckCallbackProvider;</div><div class="line">  <span class="keyword">this</span>.eventListeners.addAll(args.getEventListeners());</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler = args.preRegistrationHandler;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.healthCheckCallbackProvider = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.healthCheckHandlerProvider = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.2 èµ‹å€¼ ApplicationInfoManagerã€EurekaClientConfig</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</div><div class="line">InstanceInfo myInfo = applicationInfoManager.getInfo();</div><div class="line"></div><div class="line">clientConfig = config;</div><div class="line">staticClientConfig = clientConfig;</div><div class="line">transportConfig = config.getTransportConfig();</div><div class="line">instanceInfo = myInfo;</div><div class="line"><span class="keyword">if</span> (myInfo != <span class="keyword">null</span>) &#123;</div><div class="line">  appPathIdentifier = instanceInfo.getAppName() + <span class="string">"/"</span> + instanceInfo.getId(); <span class="comment">// æ— å®é™…ä¸šåŠ¡ç”¨é€”ï¼Œç”¨äºæ‰“ logger</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  logger.warn(<span class="string">"Setting instanceInfo to a passed in null value"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.3 èµ‹å€¼ BackupRegistry</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.backupRegistryProvider = backupRegistryProvider;</div></pre></td></tr></table></figure></p><h3>3.2.4 åˆå§‹åŒ– InstanceInfoBasedUrlRandomizer</h3><p>TODO[0016]ï¼šInstanceInfoBasedUrlRandomizer</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.urlRandomizer = <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(instanceInfo);</div></pre></td></tr></table></figure></p><h3>3.2.5 åˆå§‹åŒ– Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Applications&gt; localRegionApps = <span class="keyword">new</span> AtomicReference&lt;Applications&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‹‰å–æ³¨å†Œä¿¡æ¯æ¬¡æ•°</span></div><div class="line"><span class="comment">* monotonically increasing generation counter to ensure stale threads do not reset registry to an older version</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong fetchRegistryGeneration;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">localRegionApps.set(<span class="keyword">new</span> Applications());</div><div class="line"></div><div class="line">fetchRegistryGeneration = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure></p><ul><li>åœ¨åˆ›å»º DiscoveryClient æ—¶ï¼Œ<code>localRegionApps</code> ä¸ºç©ºã€‚</li><li>å®šæ—¶ä»»åŠ¡<strong>é—´éš”</strong>ä» Eureka-Server æ‹‰å–æ³¨å†Œåº”ç”¨ä¿¡æ¯åˆ°æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3>3.2.6 è·å–å“ªäº› Region é›†åˆçš„æ³¨å†Œä¿¡æ¯</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–å“ªäº›åŒºåŸŸ( Region )é›†åˆçš„æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String&gt; remoteRegionsToFetch;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–å“ªäº›åŒºåŸŸ( Region )é›†åˆçš„æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String[]&gt; remoteRegionsRef;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">remoteRegionsToFetch = <span class="keyword">new</span> AtomicReference&lt;&gt;(clientConfig.fetchRegistryForRemoteRegions());</div><div class="line">remoteRegionsRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(remoteRegionsToFetch.get() == <span class="keyword">null</span> ? <span class="keyword">null</span> : remoteRegionsToFetch.get().split(<span class="string">","</span>));</div></pre></td></tr></table></figure></p><h3>3.2.7 åˆå§‹åŒ–æ‹‰å–ã€å¿ƒè·³çš„ç›‘æ§</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulRegistryFetchTimestamp = -<span class="number">1</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸå‘ Eureka-Server å¿ƒè·³æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¿ƒè·³ç›‘æ§</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric heartbeatStalenessMonitor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‹‰å–ç›‘æ§</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric registryStalenessMonitor;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (config.shouldFetchRegistry()) &#123;</div><div class="line">  <span class="keyword">this</span>.registryStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRY_PREFIX + <span class="string">"lastUpdateSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.registryStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (config.shouldRegisterWithEureka()) &#123;</div><div class="line">  <span class="keyword">this</span>.heartbeatStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRATION_PREFIX + <span class="string">"lastHeartbeatSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.heartbeatStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>æ¯æ¬¡æˆåŠŸå‘ Eureka-Serve å¿ƒè·³æˆ–è€…ä»ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯åï¼Œéƒ½ä¼šæ›´æ–°ç›¸åº”æ—¶é—´æˆ³ã€‚</li><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li><li>å¯¹ <a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/util/ThresholdLevelsMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.util.ThresholdLevelsMetric</code></a> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO[0012]ï¼šç›‘æ§ç›¸å…³ï¼‰</li></ul><h3>3.2.8 ç»“æŸåˆå§‹åŒ–ï¼Œå½“æ— éœ€å’Œ Eureka-Server äº¤äº’</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (!config.shouldRegisterWithEureka() &amp;&amp; !config.shouldFetchRegistry()) &#123;</div><div class="line">  logger.info(<span class="string">"Client configured to neither register nor query for data."</span>);</div><div class="line">  scheduler = <span class="keyword">null</span>;</div><div class="line">  heartbeatExecutor = <span class="keyword">null</span>;</div><div class="line">  cacheRefreshExecutor = <span class="keyword">null</span>;</div><div class="line">  eurekaTransport = <span class="keyword">null</span>;</div><div class="line">  instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(<span class="keyword">new</span> PropertyBasedAzToRegionMapper(config), clientConfig.getRegion());</div><div class="line"></div><div class="line">  <span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></div><div class="line">  <span class="comment">// to work with DI'd DiscoveryClient</span></div><div class="line">  DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</div><div class="line">  DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line"></div><div class="line">  initTimestampMs = System.currentTimeMillis();</div><div class="line">  logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</div><div class="line">          initTimestampMs, <span class="keyword">this</span>.getApplications().size());</div><div class="line"></div><div class="line">  <span class="keyword">return</span>;  <span class="comment">// no need to setup up an network tasks and we are done</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.9 åˆå§‹åŒ–çº¿ç¨‹æ± </h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* çº¿ç¨‹æ± </span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* A scheduler to be used for the following 3 tasks: ã€ç›®å‰åªæœ‰ä¸¤ä¸ªã€‘</span></div><div class="line"><span class="comment">* - updating service urls</span></div><div class="line"><span class="comment">* - scheduling a TimedSuperVisorTask</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line"><span class="comment">// additional executors for supervised subtasks</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¿ƒè·³æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor heartbeatExecutor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* &#123;<span class="doctag">@link</span> #localRegionApps&#125; åˆ·æ–°æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cacheRefreshExecutor;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></div><div class="line">scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build());</div><div class="line"></div><div class="line">heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">     <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build()</div><div class="line">);  <span class="comment">// use direct handoff</span></div><div class="line"></div><div class="line">cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">     <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build()</div><div class="line">);  <span class="comment">// use direct handoff</span></div></pre></td></tr></table></figure></p><ul><li><code>scheduler</code>ï¼Œ<strong>å®šæ—¶ä»»åŠ¡</strong>çº¿ç¨‹æ± ï¼Œåˆå§‹åŒ–å¤§å°ä¸º 2ï¼Œä¸€ä¸ªç»™ <code>heartbeatExecutor</code>ï¼Œä¸€ä¸ªç»™ <code>cacheRefreshExecutor</code>ã€‚</li><li><code>heartbeatExecutor</code>ã€<code>cacheRefreshExecutor</code> åœ¨æäº¤ç»™ <code>scheduler</code> æ‰å£°æ˜å…·ä½“çš„<strong>ä»»åŠ¡</strong>ã€‚</li></ul><h3>3.2.10 åˆå§‹åŒ– Eureka ç½‘ç»œé€šä¿¡ç›¸å…³</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">eurekaTransport = <span class="keyword">new</span> EurekaTransport();</div><div class="line">scheduleServerEndpointTask(eurekaTransport, args);</div></pre></td></tr></table></figure></p><ul><li>æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO[0013]ï¼šç½‘ç»œä¼ è¾“ç›¸å…³ï¼‰</li></ul><h3>3.2.11 åˆå§‹åŒ– InstanceRegionChecker</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">AzToRegionMapper azToRegionMapper;</div><div class="line"><span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</div><div class="line">    azToRegionMapper = <span class="keyword">new</span> DNSBasedAzToRegionMapper(clientConfig);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    azToRegionMapper = <span class="keyword">new</span> PropertyBasedAzToRegionMapper(clientConfig);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsToFetch.get()) &#123;</div><div class="line">    azToRegionMapper.setRegionsToFetch(remoteRegionsToFetch.get().split(<span class="string">","</span>));</div><div class="line">&#125;</div><div class="line">instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(azToRegionMapper, clientConfig.getRegion());</div></pre></td></tr></table></figure></p><ul><li><p><code>com.netflix.discovery.AzToRegionMapper</code>ï¼Œä¸»è¦ç”¨äºäºšé©¬é€Š AWSï¼Œè·³è¿‡ã€‚</p></li><li><p><code>com.netflix.discovery.InstanceRegionChecker</code>ï¼Œåº”ç”¨å®ä¾‹ä¿¡æ¯åŒºåŸŸ( <code>region</code> )æ ¡éªŒï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceRegionChecker</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å’Œäºšé©¬é€Š AWS ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ¬åœ°åŒºåŸŸ( Region )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String localRegion;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocalRegion</span><span class="params">(@Nullable String instanceRegion)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == instanceRegion || instanceRegion.equals(localRegion); <span class="comment">// no region == local</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLocalRegion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> localRegion;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h3>3.2.12 ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">  fetchRegistryFromBackup();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server <strong>åˆå§‹</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯ã€‚åœ¨ï¼ˆTOåæ–‡é“¾æ¥ï¼‰è¯¦ç»†è§£æã€‚</p></li><li><p>è°ƒç”¨ <code>#fetchRegistryFromBackup()</code> æ–¹æ³•ï¼Œè‹¥<strong>åˆå§‹</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯å¤±è´¥ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè·å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fetchRegistryFromBackup</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">        BackupRegistry backupRegistryInstance = newBackupRegistryInstance();</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == backupRegistryInstance) &#123; <span class="comment">// backward compatibility with the old protected method, in case it is being used.</span></div><div class="line">            backupRegistryInstance = backupRegistryProvider.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != backupRegistryInstance) &#123;</div><div class="line">            Applications apps = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (isFetchingRemoteRegionRegistries()) &#123;</div><div class="line">                String remoteRegionsStr = remoteRegionsToFetch.get();</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsStr) &#123;</div><div class="line">                    apps = backupRegistryInstance.fetchRegistry(remoteRegionsStr.split(<span class="string">","</span>));</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                apps = backupRegistryInstance.fetchRegistry();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (apps != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> Applications applications = <span class="keyword">this</span>.filterAndShuffle(apps);</div><div class="line">                applications.setAppsHashCode(applications.getReconcileHashCode());</div><div class="line">                localRegionApps.set(applications);</div><div class="line">                logTotalInstances();</div><div class="line">                logger.info(<span class="string">"Fetched registry successfully from the backup"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.warn(<span class="string">"No backup registry instance defined &amp; unable to find any discovery servers."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        logger.warn(<span class="string">"Cannot fetch applications from apps although backup registry was specified"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>BackupRegistry ç›®å‰æš‚æœªæä¾›é»˜è®¤å®ç°ï¼Œéœ€è¦è‡ªè¡Œç›¸å…³é€»è¾‘ã€‚</li></ul></li></ul><h3>3.2.13 æ‰§è¡Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// call and execute the pre registration handler before all background tasks (inc registration) is started</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.preRegistrationHandler != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler.beforeRegistration();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3>3.2.14 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">initScheduledTasks();</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line">       <span class="comment">// registry cache refresh timer</span></div><div class="line">       <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"cacheRefresh"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       cacheRefreshExecutor,</div><div class="line">                       registryFetchIntervalSeconds,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> CacheRefreshThread()</div><div class="line">               ),</div><div class="line">               registryFetchIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">       <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</div><div class="line">       logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</div><div class="line"></div><div class="line">       <span class="comment">// Heartbeat timer</span></div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"heartbeat"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       heartbeatExecutor,</div><div class="line">                       renewalIntervalInSecs,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> HeartbeatThread()</div><div class="line">               ),</div><div class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">       <span class="comment">// InstanceInfo replicator</span></div><div class="line">       instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</div><div class="line">               <span class="keyword">this</span>,</div><div class="line">               instanceInfo,</div><div class="line">               clientConfig.getInstanceInfoReplicationIntervalSeconds(),</div><div class="line">               <span class="number">2</span>); <span class="comment">// burstSize</span></div><div class="line"></div><div class="line">       statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</div><div class="line">                       InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</div><div class="line">                   <span class="comment">// log at warn level if DOWN was involved</span></div><div class="line">                   logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">               &#125;</div><div class="line">               instanceInfoReplicator.onDemandUpdate();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</div><div class="line">           applicationInfoManager.registerStatusChangeListener(statusChangeListener);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>åˆå§‹åŒ–</strong>ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ‰§è¡Œå™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹</a> è¯¦ç»†è§£æã€‚</li><li><strong>åˆå§‹åŒ–</strong>å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> è¯¦ç»†è§£æã€‚</li></ul><h3>3.2.15 å‘ Servo æ³¨å†Œç›‘æ§</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  Monitors.registerObject(<span class="keyword">this</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">  logger.warn(<span class="string">"Cannot register timers"</span>, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul><h3>3.2.16 åˆå§‹åŒ–å®Œæˆ</h3><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆå§‹åŒ–å®Œæˆæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> initTimestampMs;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// ã€3.2.16ã€‘åˆå§‹åŒ–å®Œæˆ</span></div><div class="line"><span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></div><div class="line"><span class="comment">// to work with DI'd DiscoveryClient</span></div><div class="line">DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</div><div class="line">DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line"></div><div class="line">initTimestampMs = System.currentTimeMillis();</div><div class="line">logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</div><div class="line">      initTimestampMs, <span class="keyword">this</span>.getApplications().size());</div></pre></td></tr></table></figure></p><h1>666. å½©è›‹</h1><p>ç”±äºç¬”è€…æ˜¯è¾¹ç†è§£æºç è¾¹è¾“å‡ºåšå®¢å†…å®¹ï¼Œå¦‚æœæœ‰é”™è¯¯æˆ–è€…ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œ<strong>æ¬¢è¿</strong>å¾®ç¬‘ç»™æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç•™è¨€ï¼Œæˆ‘ä¼š<strong>ä»”ç»†</strong>å›å¤ã€‚æ„Ÿè°¢ + 1024ã€‚</p><p>åé¢æ–‡ç« ä¸æ–­æ›´æ–°ï¼Œä¼šæ…¢æ…¢å®Œå–„æœ¬æ–‡ä¸­çš„ã€‚</p><p>æ¨èå‚è€ƒé˜…è¯»ï¼š</p><ul><li><a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ç¨‹åºçŒ¿DD â€”â€” ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a> Spring Cloud Eureka â€”â€” æºç åˆ†æ</li><li><strong>ä¹°ç›—ç‰ˆä¹¦ï¼Œç­‰äºç¼–å†™ä¸€ä¸ªåˆçº§ BUG</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-third/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;u
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfig</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-second/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-second/</id>
    <published>2018-04-22T16:00:00.000Z</published>
    <updated>2017-10-05T03:28:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. EurekaClientConfig</a><ul><li><a href="#">2.1 ç±»å…³ç³»å›¾</a></li><li><a href="#">2.2 é…ç½®å±æ€§</a></li><li><a href="#">2.3 DefaultEurekaClientConfig</a></li><li><a href="#">2.4 DefaultEurekaClientConfigProvider</a></li><li><a href="#">2.5 å°ç»“</a></li></ul></li><li><a href="#">3. EurekaTransportConfig</a><ul><li><a href="#">3.1 ç±»å…³ç³»å›¾</a></li><li><a href="#">3.2 é…ç½®å±æ€§</a></li><li><a href="#">3.3 DefaultEurekaTransportConfig</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg"></a></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>çš„ç¬¬äºŒéƒ¨åˆ† â€”â€” <strong>EurekaClientConfig</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li>ï¼ˆä¸€ï¼‰<a href="(http://www.iocoder.cn/Eureka/eureka-client-init-first/)">EurekaInstanceConfig</a></li><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆäºŒï¼‰EurekaClientConfig</li><li>ï¼ˆä¸‰ï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">EurekaClient</a></li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaClientConfig</h1><p><code>com.netflix.discovery.EurekaClientConfig</code>ï¼Œ<strong>Eureka-Client</strong> é…ç½®<strong>æ¥å£</strong>ã€‚</p><h2>2.1 ç±»å…³ç³»å›¾</h2><p>EurekaClientConfig æ•´ä½“ç±»å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_22/04.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ<strong>çº¢åœˆ</strong>éƒ¨åˆ†ç±»ã€‚</li><li>EurekaArchaius2ClientConfig åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 2.x</a> å®ç°ï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li></ul><h2>2.2 é…ç½®å±æ€§</h2><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/8b0f67ac33116ee05faad1ff5125034cfcf573bf/eureka-client/src/main/java/com/netflix/discovery/EurekaClientConfig.java" rel="external nofollow noopener noreferrer" target="_blank">EurekaClientConfig</a> æŸ¥çœ‹é…ç½®å±æ€§ç®€ä»‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç€è‹±æ–‡æ³¨é‡Šä¸€èµ·ç†è§£ã€‚è¿™é‡Œç¬”è€…æ‘˜å‡ºéƒ¨åˆ†è¾ƒä¸ºé‡è¦çš„å±æ€§ï¼š</p><ul><li><strong>Regionã€Zone ç›¸å…³</strong><ul><li><p><code>#getRegion()</code> ï¼šEureka-Client æ‰€åœ¨åŒºåŸŸ( <code>region</code> )ã€‚</p></li><li><p><code>#getAvailabilityZones()</code> ï¼šEureka-Client æ‰€åœ¨åœ°åŒº( <code>region</code> ) å¯ç”¨åŒº( <code>zone</code> )é›†åˆã€‚<strong>è¯¥å‚æ•°è™½ç„¶æ˜¯æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ä»£è¡¨å…¶æ‰€åœ¨çš„å¯ç”¨åŒº</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InstanceInfo.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getZone</span><span class="params">(String[] availZones, InstanceInfo myInfo)</span> </span>&#123;</div><div class="line">    String instanceZone = ((availZones == <span class="keyword">null</span> || availZones.length == <span class="number">0</span>) ? <span class="string">"default"</span></div><div class="line">            : availZones[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">if</span> (myInfo != <span class="keyword">null</span></div><div class="line">            &amp;&amp; myInfo.getDataCenterInfo().getName() == DataCenterInfo.Name.Amazon) &#123;</div><div class="line">    </div><div class="line">        String awsInstanceZone = ((AmazonInfo) myInfo.getDataCenterInfo())</div><div class="line">                .get(AmazonInfo.MetaDataKey.availabilityZone);</div><div class="line">        <span class="keyword">if</span> (awsInstanceZone != <span class="keyword">null</span>) &#123;</div><div class="line">            instanceZone = awsInstanceZone;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> instanceZone;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>è¿›æ­¥ä¸€æ­¥ç†è§£ Regionã€Zone æŸ¥çœ‹<a href="http://www.itmuch.com/spring-cloud-1/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå‘¨ç«‹ â€”â€” Regionã€Zoneè§£æã€‹</a>ã€‚</p></li></ul></li><li><strong>ä½¿ç”¨ DNS è·å– Eureka-Server URL ç›¸å…³</strong><ul><li><code>#shouldUseDnsForFetchingServiceUrls()</code> ï¼šæ˜¯å¦ä½¿ç”¨ DNS æ–¹å¼è·å– Eureka-Server URL åœ°å€ã€‚</li><li><code>#getEurekaServerDNSName()</code> ï¼šEureka-Server çš„ DNS åã€‚</li><li><code>#getEurekaServerPort()</code> ï¼šEureka-Server çš„ç«¯å£ã€‚</li><li><code>#getEurekaServerURLContext()</code> ï¼šEureka-Server çš„ URL Context ã€‚</li><li><code>#getEurekaServiceUrlPollIntervalSeconds()</code> ï¼šè½®è¯¢è·å– Eureka-Server åœ°å€å˜æ›´é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚é»˜è®¤ï¼š300 ç§’ã€‚</li><li><code>#shouldPreferSameZoneEureka()</code> ï¼šä¼˜å…ˆä½¿ç”¨ç›¸åŒåŒº( <code>zone</code> )çš„ Eureka-Serverã€‚</li></ul></li><li><strong>ç›´æ¥é…åˆ Eureka-Server URL ç›¸å…³</strong><ul><li><code>#getEurekaServerServiceUrls()</code> ï¼š Eureka-Server çš„ URL é›†åˆã€‚</li></ul></li><li><strong>å‘ç°ï¼šä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ç›¸å…³</strong><ul><li><code>#shouldFetchRegistry()</code> ï¼šæ˜¯å¦ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯ã€‚</li><li><code>#getRegistryFetchIntervalSeconds()</code> ï¼šä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚é»˜è®¤ï¼š30 ç§’ã€‚</li><li><code>#shouldFilterOnlyUpInstances()</code> ï¼šæ˜¯å¦è¿‡æ»¤ï¼Œåªè·å–çŠ¶æ€ä¸ºå¼€å¯( Up )çš„åº”ç”¨å®ä¾‹é›†åˆã€‚</li><li><code>#fetchRegistryForRemoteRegions()</code> ï¼šTODO[0009]ï¼šRemoteRegionRegistry</li><li><code>#getCacheRefreshExecutorThreadPoolSize()</code> ï¼šæ³¨å†Œä¿¡æ¯ç¼“å­˜åˆ·æ–°çº¿ç¨‹æ± å¤§å°ã€‚</li><li><code>#getCacheRefreshExecutorExponentialBackOffBound()</code> ï¼šæ³¨å†Œä¿¡æ¯ç¼“å­˜åˆ·æ–°æ‰§è¡Œè¶…æ—¶åçš„å»¶è¿Ÿé‡è¯•çš„æ—¶é—´ã€‚</li><li><code>#getRegistryRefreshSingleVipAddress()</code> ï¼šTODO[0010]ï¼šgetRegistryRefreshSingleVipAddress</li></ul></li><li><strong>æ³¨å†Œï¼šå‘ Eureka-Server æ³¨å†Œè‡ªèº«æœåŠ¡</strong><ul><li><code>#shouldRegisterWithEureka()</code> ï¼šæ˜¯å¦å‘ Eureka-Server æ³¨å†Œè‡ªèº«æœåŠ¡ã€‚</li><li><code>#shouldUnregisterOnShutdown()</code> ï¼šæ˜¯å¦å‘ Eureka-Server å–æ¶ˆæ³¨å†Œè‡ªèº«æœåŠ¡ï¼Œå½“è¿›ç¨‹å…³é—­æ—¶ã€‚</li><li><code>#getInstanceInfoReplicationIntervalSeconds()</code> ï¼šå‘ Eureka-Server åŒæ­¥åº”ç”¨å®ä¾‹ä¿¡æ¯å˜åŒ–é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getInitialInstanceInfoReplicationIntervalSeconds()</code> ï¼šå‘ Eureka-Server åŒæ­¥åº”ç”¨ä¿¡æ¯å˜åŒ–åˆå§‹åŒ–å»¶è¿Ÿï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getBackupRegistryImpl()</code> ï¼šè·å–å¤‡ä»½æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚å½“ Eureka-Client å¯åŠ¨æ—¶ï¼Œæ— æ³•ä» Eureka-Server è¯»å–æ³¨å†Œä¿¡æ¯ï¼ˆå¯èƒ½æŒ‚äº†ï¼‰ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè¯»å–æ³¨å†Œä¿¡æ¯ã€‚ç›®å‰ Eureka-Client æœªæä¾›åˆé€‚çš„å®ç°ã€‚</li><li><code>#getHeartbeatExecutorThreadPoolSize()</code> ï¼šå¿ƒè·³æ‰§è¡Œçº¿ç¨‹æ± å¤§å°ã€‚</li><li><code>#getHeartbeatExecutorExponentialBackOffBound()</code> ï¼šå¿ƒè·³æ‰§è¡Œè¶…æ—¶åçš„å»¶è¿Ÿé‡è¯•çš„æ—¶é—´ã€‚</li></ul></li></ul><h2>2.3 DefaultEurekaClientConfig</h2><p><code>com.netflix.discovery.DefaultEurekaClientConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„ <strong>Eureka-Client</strong> é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaClientConfig</span> <span class="keyword">implements</span> <span class="title">EurekaClientConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ZONE = <span class="string">"defaultZone"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namespace;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * HTTP ä¼ è¾“é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaTransportConfig transportConfig;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaClientConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="comment">// è®¾ç½® namespaceï¼Œä¸º "." ç»“å°¾</span></div><div class="line">        <span class="keyword">this</span>.namespace = namespace.endsWith(<span class="string">"."</span>)</div><div class="line">                ? namespace</div><div class="line">                : namespace + <span class="string">"."</span>;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.configInstance = Archaius1Utils.initConfig(CommonConstants.CONFIG_FILE_NAME);</div><div class="line">        <span class="comment">// åˆ›å»º HTTP ä¼ è¾“é…ç½®</span></div><div class="line">        <span class="keyword">this</span>.transportConfig = <span class="keyword">new</span> DefaultEurekaTransportConfig(namespace, configInstance);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç±»ä¼¼ PropertiesInstanceConfigï¼Œç‚¹å‡»<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æŸ¥çœ‹è¯¦ç»†è§£æã€‚</li><li>åœ¨ <code>com.netflix.discovery.PropertyBasedClientConfigConstants</code> å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY ã€‚</li><li><code>transportConfig</code> å±æ€§ï¼Œåœ¨ <a href="#">ã€Œ3. EurekaTransportConfigã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>2.4 DefaultEurekaClientConfigProvider</h2><p><code>com.netflix.discovery.providers.DefaultEurekaClientConfigProvider</code>ï¼Œåˆ›å»º DefaultEurekaClientConfig çš„å·¥å‚ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaClientConfigProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">EurekaClientConfig</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span>(optional = <span class="keyword">true</span>)</div><div class="line">    <span class="meta">@EurekaNamespace</span></div><div class="line">    <span class="keyword">private</span> String namespace;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DefaultEurekaClientConfig config;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> EurekaClientConfig <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</div><div class="line">            config = (namespace == <span class="keyword">null</span>)</div><div class="line">                    ? <span class="keyword">new</span> DefaultEurekaClientConfig()</div><div class="line">                    : <span class="keyword">new</span> DefaultEurekaClientConfig(namespace);</div><div class="line">                    </div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> Remove this when DiscoveryManager is finally no longer used</span></div><div class="line">            DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> config;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>2.5 å°ç»“</h2><p>æ¨èå‚è€ƒé˜…è¯»ï¼š</p><ul><li><a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ç¨‹åºçŒ¿DD â€”â€” ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a> Spring Cloud Eureka â€”â€” é…ç½®è¯¦è§£</li><li><a href="http://www.cnblogs.com/fangfuhai/p/7070325.html" rel="external nofollow noopener noreferrer" target="_blank">é£ä¸­ç¨‹åºçŒ¿ â€”â€” ã€Šå¾®æœåŠ¡æ¶æ„ï¼šEurekaå‚æ•°é…ç½®é¡¹è¯¦è§£ã€‹</a></li></ul><h1>3. EurekaTransportConfig</h1><h2>3.1 ç±»å…³ç³»å›¾</h2><p>EurekaTransportConfig æ•´ä½“ç±»å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_22/05.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ<strong>çº¢åœˆ</strong>éƒ¨åˆ†ç±»ã€‚</li><li>EurekaArchaius2TransportConfig åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 2.x</a> å®ç°ï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li></ul><h2>3.2 é…ç½®å±æ€§</h2><p>TODO[0011]ï¼šEurekaTransportConfig åé¢çœ‹åˆ°é‚£éƒ¨åˆ†æºç åœ¨è¡¥å……ï¼Œæ²¡ç†é¡ºã€‚</p><h2>3.3 DefaultEurekaTransportConfig</h2><p><code>com.netflix.discovery.shared.transport.DefaultEurekaTransportConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„<strong>ç½‘ç»œä¼ è¾“</strong>é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaTransportConfig</span> <span class="keyword">implements</span> <span class="title">EurekaTransportConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUB_NAMESPACE = TRANSPORT_CONFIG_SUB_NAMESPACE + <span class="string">"."</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namespace;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaTransportConfig</span><span class="params">(String parentNamespace, DynamicPropertyFactory configInstance)</span> </span>&#123;</div><div class="line">        <span class="comment">// å‘½åç©ºé—´</span></div><div class="line">        <span class="keyword">this</span>.namespace = parentNamespace == <span class="keyword">null</span></div><div class="line">                ? SUB_NAMESPACE</div><div class="line">                : (parentNamespace.endsWith(<span class="string">"."</span>)</div><div class="line">                    ? parentNamespace + SUB_NAMESPACE</div><div class="line">                    : parentNamespace + <span class="string">"."</span> + SUB_NAMESPACE);</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.configInstance = configInstance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç±»ä¼¼ PropertiesInstanceConfigï¼Œç‚¹å‡»<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æŸ¥çœ‹è¯¦ç»†è§£æã€‚</li><li>åœ¨ <code>com.netflix.discovery.shared.transport.PropertyBasedTransportConfigConstants</code> å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY ã€‚</li></ul><h1>666. å½©è›‹</h1><p>æ¶‰åŠåˆ°é…ç½®ï¼Œå†…å®¹åˆçœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¤šï¼Œæ…¢æ…¢ç†è§£åï¼Œå°±ä¼šå˜å¾—å¾ˆâ€œå•°å—¦â€ï¼Œè¯·ä¿æŒè€å¿ƒã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfig</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-first/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-first/</id>
    <published>2018-04-14T16:00:00.000Z</published>
    <updated>2017-10-05T03:12:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-eurekainstanceconfig">2. EurekaInstanceConfig</a><ul><li><a href="#21-%E7%B1%BB%E5%85%B3%E7%B3%BB%E5%9B%BE">2.1 ç±»å…³ç³»å›¾</a></li><li><a href="#22-%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7">2.2 é…ç½®å±æ€§</a></li><li><a href="#23-abstractinstanceconfig">2.3 AbstractInstanceConfig</a></li><li><a href="#24-propertiesinstanceconfig">2.4 PropertiesInstanceConfig</a></li><li><a href="#25-mydatacenterinstanceconfig">2.5 MyDataCenterInstanceConfig</a></li><li><a href="#26-%E5%B0%8F%E7%BB%93">2.6 å°ç»“</a></li></ul></li><li><a href="#3-instanceinfo">3. InstanceInfo</a></li><li><a href="#4-applicationinfomanager">4. ApplicationInfoManager</a></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆä¸€ï¼‰EurekaInstanceConfig</li><li>ï¼ˆäºŒï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">EurekaClientConfig</a></li><li>ï¼ˆä¸‰ï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">EurekaClient</a></li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. EurekaInstanceConfig</h1><p><code>com.netflix.appinfo.EurekaInstanceConfig</code>ï¼ŒEureka <strong>åº”ç”¨å®ä¾‹</strong>é…ç½®<strong>æ¥å£</strong>ã€‚åœ¨ä¸‹æ–‡ä½ ä¼šçœ‹åˆ° EurekaClientConfig <strong>æ¥å£</strong>ï¼Œä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>EurekaInstanceConfigï¼Œé‡åœ¨<strong>åº”ç”¨å®ä¾‹</strong>ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨åã€åº”ç”¨çš„ç«¯å£ç­‰ç­‰ã€‚æ­¤å¤„åº”ç”¨æŒ‡çš„æ˜¯ï¼ŒApplication Consumer å’Œ Application Providerã€‚</li><li>EurekaClientConfigï¼Œé‡åœ¨ <strong>Eureka-Client</strong>ï¼Œä¾‹å¦‚ï¼Œ è¿æ¥çš„ Eureka-Server çš„åœ°å€ã€è·å–æœåŠ¡æä¾›è€…åˆ—è¡¨çš„é¢‘ç‡ã€æ³¨å†Œè‡ªèº«ä¸ºæœåŠ¡æä¾›è€…çš„é¢‘ç‡ç­‰ç­‰ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/02.jpeg" alt=""></p><h2>2.1 ç±»å…³ç³»å›¾</h2><p>EurekaInstanceConfig æ•´ä½“ç±»å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/03.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ<strong>çº¢åœˆ</strong>éƒ¨åˆ†ç±»ã€‚</li><li>EurekaArchaius2ClientConfig åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 2.x</a> å®ç°ï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li><li>CloudInstanceConfigã€Ec2EurekaArchaius2InstanceConfig åŸºäºäºšé©¬é€Š AWSï¼Œå¤§å¤šæ•°è¯»è€…å’Œæˆ‘å¯¹ AWS éƒ½ä¸äº†è§£ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li></ul><h2>2.2 é…ç½®å±æ€§</h2><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/8b0f67ac33116ee05faad1ff5125034cfcf573bf/eureka-client/src/main/java/com/netflix/appinfo/EurekaInstanceConfig.java" rel="external nofollow noopener noreferrer" target="_blank">EurekaInstanceConfig</a> æŸ¥çœ‹é…ç½®å±æ€§ç®€ä»‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç€è‹±æ–‡æ³¨é‡Šä¸€èµ·ç†è§£ã€‚è¿™é‡Œç¬”è€…æ‘˜å‡ºéƒ¨åˆ†è¾ƒä¸ºé‡è¦çš„å±æ€§ï¼š</p><ul><li><p><code>#getLeaseRenewalIntervalInSeconds()</code> ï¼šç§Ÿçº¦ç»­çº¦é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚åº”ç”¨ä¸æ–­é€šè¿‡æŒ‰ç…§è¯¥é¢‘ç‡å‘é€å¿ƒè·³ç»™ Eureka-Server ä»¥è¾¾åˆ°ç»­çº¦çš„ä½œç”¨ã€‚å½“ Eureka-Server è¶…è¿‡æœ€å¤§é¢‘ç‡æœªæ”¶åˆ°ç»­çº¦ï¼ˆå¿ƒè·³ï¼‰ï¼Œå¥‘çº¦å¤±æ•ˆï¼Œè¿›è¡Œåº”ç”¨ç§»é™¤ã€‚åº”ç”¨ç§»é™¤åï¼Œå…¶ä»–åº”ç”¨æ— æ³•ä» Eureka-Server è·å–è¯¥åº”ç”¨ã€‚</p></li><li><p><code>#getLeaseExpirationDurationInSeconds()</code> ï¼šå¥‘çº¦è¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</p></li><li><p><code>#getDataCenterInfo()</code> ï¼šæ•°æ®ä¸­å¿ƒä¿¡æ¯ã€‚<code>com.netflix.appinfo.DataCenterInfo</code>ï¼Œæ•°æ®ä¸­å¿ƒä¿¡æ¯<strong>æ¥å£</strong>ï¼Œç›®å‰è¾ƒä¸ºç®€å•ï¼Œæ ‡è®°æ‰€å±æ•°æ®ä¸­å¿ƒåã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Name.MyOwn</code>ã€‚æ¥å£å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataCenterInfo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒåæšä¸¾</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">enum</span> Name &#123;</div><div class="line">        Netflix,</div><div class="line">        Amazon,</div><div class="line">        MyOwn</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å½’å±çš„æ•°æ®ä¸­å¿ƒå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Name <span class="title">getName</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p><code>#getNamespace()</code> ï¼šé…ç½®å‘½åç©ºé—´ï¼Œé»˜è®¤ä½¿ç”¨ <code>eureka</code>ã€‚ä»¥ <code>eureka-client.properties</code> ä¸¾ä¸ªä¾‹å­ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">eureka.name=eureka</div><div class="line">eureka.port=<span class="number">8080</span></div><div class="line">eureka.vipAddress=eureka.mydomain.net</div></pre></td></tr></table></figure></p><ul><li>æ¯ä¸ªå±æ€§<strong>æœ€å‰é¢</strong>çš„ <code>eureka</code> å³æ˜¯é…ç½®å‘½åç©ºé—´ï¼Œä¸€èˆ¬æƒ…å†µæ— éœ€ä¿®æ”¹ã€‚</li></ul></li><li><p>TODO[0004]ï¼šå¥åº·æ£€æŸ¥</p></li><li><p>TODO[0006]ï¼šgetDefaultAddressResolutionOrder</p></li><li><p><code>#isInstanceEnabledOnit()</code> ï¼šåº”ç”¨åˆå§‹åŒ–åæ˜¯å¦å¼€å¯ã€‚åœ¨<a href="#">ã€Œ3. InstanceInfoã€</a>è¯¦ç»†è§£æã€‚</p></li></ul><h2>2.3 AbstractInstanceConfig</h2><p><code>com.netflix.appinfo.AbstractInstanceConfig</code>ï¼ŒEureka <strong>åº”ç”¨å®ä¾‹</strong>é…ç½®<strong>æŠ½è±¡åŸºç±»</strong>ï¼Œä¸»è¦å®ç°ä¸€äº›ç›¸å¯¹<strong>é€šç”¨</strong>çš„é…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¥‘çº¦è¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LEASE_EXPIRATION_DURATION_SECONDS = <span class="number">90</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç§Ÿçº¦ç»­çº¦é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LEASE_RENEWAL_INTERVAL_SECONDS = <span class="number">30</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ https ç«¯å£å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SECURE_PORT_ENABLED = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ http ç«¯å£å¼€å¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> NON_SECURE_PORT_ENABLED = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ http ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NON_SECURE_PORT = <span class="number">80</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ https ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SECURE_PORT = <span class="number">443</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨åˆå§‹åŒ–åå¼€å¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> INSTANCE_ENABLED_ON_INIT = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœºä¿¡æ¯</span></div><div class="line"><span class="comment">     * keyï¼šä¸»æœº IP åœ°å€</span></div><div class="line"><span class="comment">     * valueï¼šä¸»æœºå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pair&lt;String, String&gt; hostInfo = getHostInfo();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> DataCenterInfo info = <span class="keyword">new</span> DataCenterInfo() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Name <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Name.MyOwn;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Pair&lt;String, String&gt; <span class="title">getHostInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        Pair&lt;String, String&gt; pair;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            InetAddress localHost = InetAddress.getLocalHost();</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(localHost.getHostAddress(), localHost.getHostName());</div><div class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</div><div class="line">            logger.error(<span class="string">"Cannot get host info"</span>, e);</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(<span class="string">""</span>, <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> pair;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥ setting / getting æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#getHostInfo()</code> æ–¹æ³•ï¼Œè·å–æœ¬åœ°æœåŠ¡å™¨çš„ä¸»æœºåå’Œä¸»æœº IP åœ°å€ã€‚<strong>å¦‚æœä¸»æœºæœ‰å¤šç½‘å¡æˆ–è€…è™šæ‹Ÿæœºç½‘å¡</strong>ï¼Œè¿™å—è¦å°å¿ƒï¼Œè§£å†³æ–¹å¼å¦‚ä¸‹ï¼š<ul><li>æ‰‹åŠ¨é…ç½®æœ¬æœºçš„ <code>hostname</code> + <code>etc/hosts</code> æ–‡ä»¶ï¼Œä»è€Œæ˜ å°„ä¸»æœºåå’Œ IP åœ°å€ã€‚</li><li>ä½¿ç”¨ Spring-Cloud-Eureka-Client çš„è¯ï¼Œå‚è€ƒ<a href="http://www.itmuch.com/spring-cloud-code-read/spring-cloud-code-read-eureka-registry-ip/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">å‘¨ç«‹ â€”â€” ã€ŠEurekaæœåŠ¡æ³¨å†Œè¿‡ç¨‹è¯¦è§£ä¹‹IpAddressã€‹</a>è§£å†³ã€‚</li></ul></li></ul><h2>2.4 PropertiesInstanceConfig</h2><p><code>com.netflix.appinfo.PropertiesInstanceConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„ Eureka <strong>åº”ç”¨å®ä¾‹</strong>é…ç½®<strong>æŠ½è±¡åŸºç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesInstanceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String namespace;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨åˆ†ç»„</span></div><div class="line"><span class="comment">     * ä» ç¯å¢ƒå˜é‡ è·å–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String appGrpNameFromEnv;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertiesInstanceConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(CommonConstants.DEFAULT_CONFIG_NAMESPACE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertiesInstanceConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(namespace, <span class="keyword">new</span> DataCenterInfo() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Name <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> Name.MyOwn;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertiesInstanceConfig</span><span class="params">(String namespace, DataCenterInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(info);</div><div class="line">        <span class="comment">// è®¾ç½® namespaceï¼Œä¸º "." ç»“å°¾</span></div><div class="line">        <span class="keyword">this</span>.namespace = namespace.endsWith(<span class="string">"."</span>)</div><div class="line">                ? namespace</div><div class="line">                : namespace + <span class="string">"."</span>;</div><div class="line">        <span class="comment">// ä» ç¯å¢ƒå˜é‡ è·å– åº”ç”¨åˆ†ç»„</span></div><div class="line">        appGrpNameFromEnv = ConfigurationManager.getConfigInstance()</div><div class="line">                .getString(FALLBACK_APP_GROUP_KEY, Values.UNKNOWN_APPLICATION);</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.configInstance = Archaius1Utils.initConfig(CommonConstants.CONFIG_FILE_NAME);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> configInstance.getStringProperty(namespace + APP_GROUP_KEY, appGrpNameFromEnv).get().trim();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>configInstance</code> å±æ€§ï¼Œé…ç½®æ–‡ä»¶å¯¹è±¡ï¼ŒåŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 1.x</a> å®ç°é…ç½®æ–‡ä»¶çš„è¯»å–ã€‚åœ¨ <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/PropertyBasedInstanceConfigConstants.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.PropertyBasedInstanceConfigConstants</code></a> å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY ã€‚</p></li><li><p><code>appGrpNameFromEnv</code> å±æ€§ï¼Œåº”ç”¨åˆ†ç»„ï¼Œä»<strong>ç¯å¢ƒå˜é‡</strong>ä¸­è·å–ã€‚ä» <code>#getAppGroupName()</code> æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¼˜å…ˆè¿˜æ˜¯ä»é…ç½®æ–‡ä»¶è¯»å–ã€‚è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">System.setProperty(FALLBACK_APP_GROUP_KEY, <span class="string">"app_gropu_name"</span>);</div></pre></td></tr></table></figure></p><ul><li><code>FALLBACK_APP_GROUP_KEY</code>ï¼Œç§æœ‰é™æ€å˜é‡ï¼Œå®é™…å¾—ä½¿ç”¨ <code>NETFLIX_APP_GROUP</code>ã€‚</li><li><code>com.netflix.config.ConfigurationManager</code> å¯ä»¥ä»<strong>ç¯å¢ƒå˜é‡</strong>è·å–åˆ°å€¼ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>Archaius1Utils#initConfig(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–è¯»å–çš„é…ç½®æ–‡ä»¶å¯¹è±¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Archaius1Utils</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(Archaius1Utils.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DynamicPropertyFactory <span class="title">initConfig</span><span class="params">(String configName)</span> </span>&#123;</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        DynamicPropertyFactory configInstance = DynamicPropertyFactory.getInstance();</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶å</span></div><div class="line">        DynamicStringProperty EUREKA_PROPS_FILE = configInstance.getStringProperty(<span class="string">"eureka.client.props"</span>, configName);</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶ç¯å¢ƒ</span></div><div class="line">        String env = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT, <span class="string">"test"</span>);</div><div class="line">        ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, env);</div><div class="line">        <span class="comment">// å°†é…ç½®æ–‡ä»¶åŠ è½½åˆ°ç¯å¢ƒå˜é‡</span></div><div class="line">        String eurekaPropsFile = EUREKA_PROPS_FILE.get();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ConfigurationManager.loadCascadedPropertiesFromResources(eurekaPropsFile);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.warn(</div><div class="line">                    <span class="string">"Cannot find the properties specified : &#123;&#125;. This may be okay if there are other environment "</span></div><div class="line">                            + <span class="string">"specific properties or the configuration is installed with a different mechanism."</span>,</div><div class="line">                    eurekaPropsFile);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> configInstance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä»ç¯å¢ƒå˜é‡ <code>eureka.client.props</code>ï¼Œè·å–é…ç½®æ–‡ä»¶åã€‚å¦‚æœæœªé…ç½®ï¼Œä½¿ç”¨å‚æ•° <code>configName</code>ï¼Œå³ <code>CommonConstants.CONFIG_FILE_NAME</code> ( <code>&quot;eureka-client&quot;</code> )ã€‚</li><li>ä»ç¯å¢ƒå˜é‡ <code>eureka.environment</code> ( EUREKA_ENVIRONMENT )ï¼Œè·å–é…ç½®æ–‡ä»¶ç¯å¢ƒã€‚</li><li>è°ƒç”¨ <code>ConfigurationManager#loadCascadedPropertiesFromResources(...)</code> æ–¹æ³•ï¼Œè¯»å–é…ç½®æ–‡ä»¶åˆ°ç¯å¢ƒå˜é‡ï¼Œé¦–å…ˆè¯»å– <code>${eureka.client.props}</code> å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼›ç„¶åè¯»å– <code>${eureka.client.props}-${eureka.environment}</code> å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚è‹¥æœ‰ç›¸åŒå±æ€§ï¼Œè¿›è¡Œè¦†ç›–ã€‚</li></ul></li></ul><h2>2.5 MyDataCenterInstanceConfig</h2><p><code>com.netflix.appinfo.MyDataCenterInstanceConfig</code>ï¼Œé AWS æ•°æ®ä¸­å¿ƒçš„ Eureka <strong>åº”ç”¨å®ä¾‹</strong>é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDataCenterInstanceConfig</span> <span class="keyword">extends</span> <span class="title">PropertiesInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataCenterInstanceConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataCenterInstanceConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(namespace);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataCenterInstanceConfig</span><span class="params">(String namespace, DataCenterInfo dataCenterInfo)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(namespace, dataCenterInfo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>2.6 å°ç»“</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨ MyDataCenterInstanceConfig é…ç½® Eureka åº”ç”¨å®ä¾‹ã€‚</p><p>åœ¨ Spring-Cloud-Eureka é‡Œï¼Œ<strong>ç›´æ¥</strong>åŸºäº EurekaInstanceConfig æ¥å£é‡æ–°å®ç°äº†é…ç½®ç±»ï¼Œå®é™…é€»è¾‘å·®åˆ«ä¸å¤§ï¼Œåœ¨<a href="#">TODO[0007] ï¼šã€ŠSpring-Cloud-Eureka-Clientã€‹</a>è¯¦ç»†è§£æã€‚</p><h1>3. InstanceInfo</h1><p><code>com.netflix.appinfo.InstanceInfo</code>ï¼Œ<strong>åº”ç”¨å®ä¾‹</strong>ä¿¡æ¯ã€‚Eureka-Client å‘ Eureka-Server <strong>æ³¨å†Œ</strong>è¯¥å¯¹è±¡ä¿¡æ¯ã€‚æ³¨å†ŒæˆåŠŸåï¼Œå¯ä»¥è¢«å…¶ä»– Eureka-Client <strong>å‘ç°</strong>ã€‚</p><p><strong>æœ¬æ–‡ä»…åˆ†äº« InstanceInfo çš„åˆå§‹åŒ–</strong>ã€‚InstanceInfo é‡Œå’Œæ³¨å†Œå‘ç°ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•ï¼Œæš‚æ—¶è·³è¿‡ã€‚</p><p><code>com.netflix.appinfo.providers.EurekaConfigBasedInstanceInfoProvider</code>ï¼ŒåŸºäº EurekaInstanceConfig åˆ›å»º InstanceInfo çš„å·¥å‚ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="meta">@Singleton</span></div><div class="line">  <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConfigBasedInstanceInfoProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">InstanceInfo</span>&gt; </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(EurekaConfigBasedInstanceInfoProvider.class);</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">final</span> EurekaInstanceConfig config;</div><div class="line">  <span class="number">6</span>: </div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> InstanceInfo instanceInfo;</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="meta">@Inject</span>(optional = <span class="keyword">true</span>)</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> VipAddressResolver vipAddressResolver = <span class="keyword">null</span>;</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:     <span class="meta">@Inject</span></div><div class="line"> <span class="number">13</span>:     <span class="function"><span class="keyword">public</span> <span class="title">EurekaConfigBasedInstanceInfoProvider</span><span class="params">(EurekaInstanceConfig config)</span> </span>&#123;</div><div class="line"> <span class="number">14</span>:         <span class="keyword">this</span>.config = config;</div><div class="line"> <span class="number">15</span>:     &#125;</div><div class="line"> <span class="number">16</span>: </div><div class="line"> <span class="number">17</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">18</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> InstanceInfo <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">if</span> (instanceInfo == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">20</span>:             <span class="comment">// Build the lease information to be passed to the server based on config</span></div><div class="line"> <span class="number">21</span>:             <span class="comment">// åˆ›å»º ç§Ÿçº¦ä¿¡æ¯æ„å»ºå™¨ï¼Œå¹¶è®¾ç½®å±æ€§</span></div><div class="line"> <span class="number">22</span>:             LeaseInfo.Builder leaseInfoBuilder = LeaseInfo.Builder.newBuilder()</div><div class="line"> <span class="number">23</span>:                     .setRenewalIntervalInSecs(config.getLeaseRenewalIntervalInSeconds())</div><div class="line"> <span class="number">24</span>:                     .setDurationInSecs(config.getLeaseExpirationDurationInSeconds());</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:             <span class="comment">// åˆ›å»º VIPåœ°å€è§£æå™¨</span></div><div class="line"> <span class="number">27</span>:             <span class="keyword">if</span> (vipAddressResolver == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">28</span>:                 vipAddressResolver = <span class="keyword">new</span> Archaius1VipAddressResolver();</div><div class="line"> <span class="number">29</span>:             &#125;</div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:             <span class="comment">// Builder the instance information to be registered with eureka server</span></div><div class="line"> <span class="number">32</span>:             <span class="comment">// åˆ›å»º åº”ç”¨å®ä¾‹ä¿¡æ¯æ„å»ºå™¨</span></div><div class="line"> <span class="number">33</span>:             InstanceInfo.Builder builder = InstanceInfo.Builder.newBuilder(vipAddressResolver);</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:             <span class="comment">// åº”ç”¨å®ä¾‹ç¼–å·</span></div><div class="line"> <span class="number">36</span>:             <span class="comment">// set the appropriate id for the InstanceInfo, falling back to datacenter Id if applicable, else hostname</span></div><div class="line"> <span class="number">37</span>:             String instanceId = config.getInstanceId();</div><div class="line"> <span class="number">38</span>:             DataCenterInfo dataCenterInfo = config.getDataCenterInfo();</div><div class="line"> <span class="number">39</span>:             <span class="keyword">if</span> (instanceId == <span class="keyword">null</span> || instanceId.isEmpty()) &#123;</div><div class="line"> <span class="number">40</span>:                 <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</div><div class="line"> <span class="number">41</span>:                     instanceId = ((UniqueIdentifier) dataCenterInfo).getId();</div><div class="line"> <span class="number">42</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">43</span>:                     instanceId = config.getHostName(<span class="keyword">false</span>);</div><div class="line"> <span class="number">44</span>:                 &#125;</div><div class="line"> <span class="number">45</span>:             &#125;</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:             <span class="comment">// è·å¾— ä¸»æœºå</span></div><div class="line"> <span class="number">48</span>:             String defaultAddress;</div><div class="line"> <span class="number">49</span>:             <span class="keyword">if</span> (config <span class="keyword">instanceof</span> RefreshableInstanceConfig) &#123;</div><div class="line"> <span class="number">50</span>:                 <span class="comment">// Refresh AWS data center info, and return up to date address</span></div><div class="line"> <span class="number">51</span>:                 defaultAddress = ((RefreshableInstanceConfig) config).resolveDefaultAddress(<span class="keyword">false</span>);</div><div class="line"> <span class="number">52</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">53</span>:                 defaultAddress = config.getHostName(<span class="keyword">false</span>);</div><div class="line"> <span class="number">54</span>:             &#125;</div><div class="line"> <span class="number">55</span>:             <span class="comment">// fail safe</span></div><div class="line"> <span class="number">56</span>:             <span class="keyword">if</span> (defaultAddress == <span class="keyword">null</span> || defaultAddress.isEmpty()) &#123;</div><div class="line"> <span class="number">57</span>:                 defaultAddress = config.getIpAddress();</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯æ„å»ºå™¨ çš„ å±æ€§</span></div><div class="line"> <span class="number">61</span>:             builder.setNamespace(config.getNamespace())</div><div class="line"> <span class="number">62</span>:                     .setInstanceId(instanceId)</div><div class="line"> <span class="number">63</span>:                     .setAppName(config.getAppname())</div><div class="line"> <span class="number">64</span>:                     .setAppGroupName(config.getAppGroupName())</div><div class="line"> <span class="number">65</span>:                     .setDataCenterInfo(config.getDataCenterInfo())</div><div class="line"> <span class="number">66</span>:                     .setIPAddr(config.getIpAddress())</div><div class="line"> <span class="number">67</span>:                     .setHostName(defaultAddress) <span class="comment">// ä¸»æœºå</span></div><div class="line"> <span class="number">68</span>:                     .setPort(config.getNonSecurePort())</div><div class="line"> <span class="number">69</span>:                     .enablePort(PortType.UNSECURE, config.isNonSecurePortEnabled())</div><div class="line"> <span class="number">70</span>:                     .setSecurePort(config.getSecurePort())</div><div class="line"> <span class="number">71</span>:                     .enablePort(PortType.SECURE, config.getSecurePortEnabled())</div><div class="line"> <span class="number">72</span>:                     .setVIPAddress(config.getVirtualHostName()) <span class="comment">// VIP åœ°å€</span></div><div class="line"> <span class="number">73</span>:                     .setSecureVIPAddress(config.getSecureVirtualHostName())</div><div class="line"> <span class="number">74</span>:                     .setHomePageUrl(config.getHomePageUrlPath(), config.getHomePageUrl())</div><div class="line"> <span class="number">75</span>:                     .setStatusPageUrl(config.getStatusPageUrlPath(), config.getStatusPageUrl())</div><div class="line"> <span class="number">76</span>:                     .setASGName(config.getASGName())</div><div class="line"> <span class="number">77</span>:                     .setHealthCheckUrls(config.getHealthCheckUrlPath(),</div><div class="line"> <span class="number">78</span>:                             config.getHealthCheckUrl(), config.getSecureHealthCheckUrl());</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:             <span class="comment">// åº”ç”¨åˆå§‹åŒ–åæ˜¯å¦å¼€å¯</span></div><div class="line"> <span class="number">81</span>:             <span class="comment">// Start off with the STARTING state to avoid traffic</span></div><div class="line"> <span class="number">82</span>:             <span class="keyword">if</span> (!config.isInstanceEnabledOnit()) &#123;</div><div class="line"> <span class="number">83</span>:                 InstanceStatus initialStatus = InstanceStatus.STARTING;</div><div class="line"> <span class="number">84</span>:                 LOG.info(<span class="string">"Setting initial instance status as: "</span> + initialStatus);</div><div class="line"> <span class="number">85</span>:                 builder.setStatus(initialStatus);</div><div class="line"> <span class="number">86</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">87</span>:                 LOG.info(<span class="string">"Setting initial instance status as: &#123;&#125;. This may be too early for the instance to advertise "</span></div><div class="line"> <span class="number">88</span>:                          + <span class="string">"itself as available. You would instead want to control this via a healthcheck handler."</span>,</div><div class="line"> <span class="number">89</span>:                          InstanceStatus.UP);</div><div class="line"> <span class="number">90</span>:             &#125;</div><div class="line"> <span class="number">91</span>: </div><div class="line"> <span class="number">92</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯æ„å»ºå™¨ çš„ å…ƒæ•°æ®( Metadata )é›†åˆ</span></div><div class="line"> <span class="number">93</span>:             <span class="comment">// Add any user-specific metadata information</span></div><div class="line"> <span class="number">94</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; mapEntry : config.getMetadataMap().entrySet()) &#123;</div><div class="line"> <span class="number">95</span>:                 String key = mapEntry.getKey();</div><div class="line"> <span class="number">96</span>:                 String value = mapEntry.getValue();</div><div class="line"> <span class="number">97</span>:                 builder.add(key, value);</div><div class="line"> <span class="number">98</span>:             &#125;</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:             <span class="comment">// åˆ›å»º åº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line"><span class="number">101</span>:             instanceInfo = builder.build();</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å®ä¾‹ä¿¡æ¯ çš„ ç§Ÿçº¦ä¿¡æ¯</span></div><div class="line"><span class="number">104</span>:             instanceInfo.setLeaseInfo(leaseInfoBuilder.build());</div><div class="line"><span class="number">105</span>:         &#125;</div><div class="line"><span class="number">106</span>:         <span class="keyword">return</span> instanceInfo;</div><div class="line"><span class="number">107</span>:     &#125;</div><div class="line"><span class="number">108</span>: </div><div class="line"><span class="number">109</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>è¯¥ç±»å®ç° <code>javax.inject.Provider</code> æ¥å£ï¼Œè®¾ç½® InstanceInfo çš„ç”Ÿæˆå·¥å‚ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="http://blog.csdn.net/derekjiang/article/details/7231490" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle-Guiceå…¥é—¨ä»‹ç»ã€‹</a>æœç´¢ <strong>Provider</strong> å…³é”®å­—ã€‚ç›®å‰å¤„äº<strong>è¯•éªŒ</strong>é˜¶æ®µï¼Œæœªå®Œæˆã€‚</p></li><li><p><code>EurekaConfigBasedInstanceInfoProvider(config)</code> æ„é€ æ–¹æ³•ï¼Œè®¾ç½®ç”Ÿæˆ InstanceInfo çš„ EurekaInstanceConfig é…ç½®ã€‚</p></li><li><p>è°ƒç”¨ <code>#get()</code> æ–¹æ³•ï¼Œæ ¹æ® EurekaInstanceConfig åˆ›å»º InstanceInfoã€‚InstanceInfo çš„ç»å¤§æ•°å±æ€§å’Œ EurekaInstanceConfig æ˜¯ä¸€è‡´çš„ ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><p>ç¬¬ 21 è‡³ 24 è¡Œ ï¼šåˆ›å»ºç§Ÿçº¦ä¿¡æ¯æ„å»ºå™¨( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/LeaseInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.LeaseInfo.Builder</code></a> )ï¼Œå¹¶è®¾ç½® <code>renewalIntervalInSecs</code> / <code>durationInSecs</code> å±æ€§ã€‚</p></li><li><p>ç¬¬ 26 è‡³ 29 è¡Œ ï¼šåˆ›å»º VIPåœ°å€è§£æå™¨( <code>com.netflix.appinfo.providers.VipAddressResolver</code> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// VipAddressResolver.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">VipAddressResolver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">resolveDeploymentContextBasedVipAddresses</span><span class="params">(String vipAddressMacro)</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Archaius1VipAddressResolver</span> <span class="keyword">implements</span> <span class="title">VipAddressResolver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern VIP_ATTRIBUTES_PATTERN = Pattern.compile(<span class="string">"\\$\\&#123;(.*?)\\&#125;"</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">resolveDeploymentContextBasedVipAddresses</span><span class="params">(String vipAddressMacro)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (vipAddressMacro == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        String result = vipAddressMacro;</div><div class="line">        <span class="comment">// æ›¿æ¢è¡¨è¾¾å¼</span></div><div class="line">        Matcher matcher = VIP_ATTRIBUTES_PATTERN.matcher(result);</div><div class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">            String key = matcher.group(<span class="number">1</span>);</div><div class="line">            String value = DynamicPropertyFactory.getInstance().getStringProperty(key, <span class="string">""</span>).get();</div><div class="line"></div><div class="line">            logger.debug(<span class="string">"att:"</span> + matcher.group());</div><div class="line">            logger.debug(<span class="string">", att key:"</span> + key);</div><div class="line">            logger.debug(<span class="string">", att value:"</span> + value);</div><div class="line">            logger.debug(<span class="string">""</span>);</div><div class="line"></div><div class="line">            result = result.replaceAll(<span class="string">"\\$\\&#123;"</span> + key + <span class="string">"\\&#125;"</span>, value);</div><div class="line">            matcher = VIP_ATTRIBUTES_PATTERN.matcher(result);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ <code>#resolveDeploymentContextBasedVipAddresses()</code> æ–¹æ³•ï¼Œå°† <strong>VIPåœ°å€</strong> é‡Œçš„ <code>${(.*?)}</code> æŸ¥æ‰¾é…ç½®æ–‡ä»¶é‡Œçš„é”®å€¼è¿›è¡Œæ›¿æ¢ã€‚ä¾‹å¦‚ï¼Œ<code>${eureka.env}.domain.com</code>ï¼ŒæŸ¥æ‰¾é…ç½®æ–‡ä»¶é‡Œçš„é”® <code>${eureka.env}</code> å¯¹åº”å€¼è¿›è¡Œæ›¿æ¢ã€‚TODO[0005]ï¼šè°ƒè¯•ä¸‹æ¥ï¼Œå‘ç° Archaius å·²ç»æ›¿æ¢ï¼Œç­‰åˆ°æ‰¾åˆ°ç­”æ¡ˆä¿®æ”¹æ­¤å¤„ã€‚</li></ul></li><li><p>ç¬¬ 32 è‡³ 33 è¡Œ ï¼šåˆ›å»ºåº”ç”¨å®ä¾‹ä¿¡æ¯æ„å»ºå™¨( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.InstanceInfo.Builder</code></a> )ã€‚</p></li><li><p>ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè·å¾—åº”ç”¨å®ä¾‹ç¼–å·( <code>instanceId</code> )ã€‚</p></li><li><p>ç¬¬ 47 è‡³ 58 è¡Œ ï¼šè·å¾—ä¸»æœºåã€‚</p></li><li><p>ç¬¬ 60 è‡³ 78 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯æ„å»ºå™¨çš„å±æ€§ã€‚</p></li><li><p>ç¬¬ 80 è‡³ 90 è¡Œ ï¼šåº”ç”¨åˆå§‹åŒ–åæ˜¯å¦å¼€å¯ã€‚</p><ul><li>ç¬¬ 82 è‡³ 85 è¡Œ ï¼šåº”ç”¨<strong>ä¸å¼€å¯</strong>ï¼Œåº”ç”¨å®ä¾‹å¤„äº STARTING çŠ¶æ€ã€‚</li><li>ç¬¬ 86 è‡³ 90 è¡Œ ï¼šåº”ç”¨<strong>å¼€å¯</strong>ï¼Œåº”ç”¨å®ä¾‹å¤„äº UP çŠ¶æ€ã€‚</li><li><strong>ä½¿ç”¨åº”ç”¨åˆå§‹åŒ–åä¸å¼€å¯</strong>ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ <code>ApplicationInfoManager#setInstanceStatus(...)</code> æ–¹æ³•æ”¹å˜åº”ç”¨å®ä¾‹çŠ¶æ€ï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li><li><p>ç¬¬ 92 è‡³ 98 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯æ„å»ºå™¨çš„å…ƒæ•°æ®( Metadata )é›†åˆã€‚</p></li><li><p>ç¬¬ 100 è‡³ 101 è¡Œ ï¼šåˆ›å»ºåº”ç”¨å®ä¾‹ä¿¡æ¯( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.InstanceInfo</code></a> )ã€‚</p></li><li><p>ç¬¬ 103 è‡³ 104 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ç§Ÿçº¦ä¿¡æ¯( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.InstanceInfo</code></a> )ã€‚</p></li></ul></li></ul><h1>4. ApplicationInfoManager</h1><p><code>com.netflix.appinfo.ApplicationInfoManager</code>ï¼Œåº”ç”¨ä¿¡æ¯ç®¡ç†å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInfoManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationInfoManager instance = <span class="keyword">new</span> ApplicationInfoManager(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, StatusChangeListener&gt; listeners;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹çŠ¶æ€åŒ¹é…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceStatusMapper instanceStatusMapper;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InstanceInfo instanceInfo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> EurekaInstanceConfig config;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ„é€ æ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationInfoManager</span><span class="params">(EurekaInstanceConfig config, InstanceInfo instanceInfo, OptionalArgs optionalArgs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.config = config;</div><div class="line">        <span class="keyword">this</span>.instanceInfo = instanceInfo;</div><div class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> ConcurrentHashMap&lt;String, StatusChangeListener&gt;();</div><div class="line">        <span class="keyword">if</span> (optionalArgs != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.instanceStatusMapper = optionalArgs.getInstanceStatusMapper();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.instanceStatusMapper = NO_OP_MAPPER;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Hack to allow for getInstance() to use the DI'd ApplicationInfoManager</span></div><div class="line">        instance = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>listeners</code> å±æ€§ï¼ŒçŠ¶æ€å˜æ›´ç›‘å¬å™¨é›†åˆã€‚åœ¨<a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹ã€Œ2.1 åº”ç”¨å®ä¾‹ä¿¡æ¯å¤åˆ¶å™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p></li><li><p><code>instanceStatusMapper</code> å±æ€§ï¼Œåº”ç”¨å®ä¾‹çŠ¶æ€åŒ¹é…ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationInfoManager.java</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstanceStatusMapper</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InstanceStatusMapper NO_OP_MAPPER = <span class="keyword">new</span> InstanceStatusMapper() &#123;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> InstanceStatus <span class="title">map</span><span class="params">(InstanceStatus prev)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> prev;</div><div class="line">   &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><ul><li><code>#map</code> æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥ <code>pre</code> å‚æ•°ï¼Œè½¬æ¢æˆå¯¹åº”çš„åº”ç”¨å®ä¾‹çŠ¶æ€ã€‚</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ NO_OP_MAPPER ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦å…³æ³¨è¯¥ç±»ã€‚</li></ul></li></ul><h1>666. å½©è›‹</h1><p>æ¶‰åŠåˆ°é…ç½®ï¼Œå†…å®¹åˆçœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¤šï¼Œæ…¢æ…¢ç†è§£åï¼Œå°±ä¼šå˜å¾—å¾ˆâ€œå•°å—¦â€ï¼Œè¯·ä¿æŒè€å¿ƒã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/eureka-client-init-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;u
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/Eureka/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/Eureka/build-debugging-environment/</id>
    <published>2018-04-07T16:00:00.000Z</published>
    <updated>2017-10-05T02:35:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#">1. ä¾èµ–å·¥å…·</a></li><li><a href="#">2. æºç æ‹‰å–</a></li><li><a href="#">3. Eureka-Server å¯åŠ¨</a><ul><li><a href="#">3.1 MockRemoteEurekaServer</a></li><li><a href="#">3.2 Eureka-Server war åŒ…</a></li><li><a href="#">3.3 Eureka-Server ç›´æ¥å¯åŠ¨</a></li></ul></li><li><a href="#">4. Eureka-Client å¯åŠ¨</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. ä¾èµ–å·¥å…·</h1><ul><li>Gradle</li><li>JDK</li><li>IntelliJ IDEA</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/Netflix/eureka.git" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/eureka.git</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Gradle</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p><p>æœ¬æ–‡åŸºäº <code>master</code> åˆ†æ”¯ã€‚</p><h1>3. Eureka-Server å¯åŠ¨</h1><p>Eureka-Server å¯åŠ¨è°ƒè¯•æ–¹å¼ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼Œæˆ‘ä»¬æ¥å°è¯•æ¯ä¸€ç§ã€‚</p><h2>3.1 MockRemoteEurekaServer</h2><p><code>com.netflix.eureka.AbstractTester</code>ï¼Œæµ‹è¯•æŠ½è±¡ç±»ï¼Œæœ‰å¦‚ä¸‹å®ç°å­ç±»ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_08/01.png" alt=""></p><p>ä½¿ç”¨ä»»æ„ä¸€ä¸ªå­ç±»çš„å•å…ƒæµ‹è¯•æ‰§è¡Œå³å¯æ‰§è¡Œ Eureka-Server é€»è¾‘çš„è°ƒè¯•ï¼Œè¿™é‡Œä»¥ <code>com.netflix.eureka.resources.ApplicationsResourceTest</code> ä½œä¸ºä¾‹å­ã€‚</p><p>Debug è¿è¡Œ <code>ApplicationsResourceTest#testFullAppsGetJson()</code> å•å…ƒæµ‹è¯•ã€‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ï¼Œ<code>ApplicationsResourceTest#setUp()</code> ä¼šè¿è¡Œï¼Œåˆå§‹åŒ– Eureka-Server <strong>æ¨¡æ‹Ÿç¯å¢ƒ</strong>ï¼Œä¾‹å¦‚ï¼š<code>com.netflix.eureka.mock.MockRemoteEurekaServer</code> ( æ¨¡æ‹Ÿ Eureka-Server )ã€‚</p><p>å› ä¸ºæ˜¯<strong>æ¨¡æ‹Ÿç¯å¢ƒ</strong>ï¼Œå¯¹ Eureka-Server çš„æ“ä½œä¸æ˜¯ Eureka-Client è¯·æ±‚ Eureka-Server çš„æ–¹å¼ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨å•å…ƒæµ‹è¯•å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationsResourceTest.java</span></div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFullAppsGetJson</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   Response response = applicationsResource.getContainers(</div><div class="line">           Version.V2.name(),</div><div class="line">           MediaType.APPLICATION_JSON,</div><div class="line">           <span class="keyword">null</span>, <span class="comment">// encoding</span></div><div class="line">           EurekaAccept.full.name(),</div><div class="line">           <span class="keyword">null</span>,  <span class="comment">// uriInfo</span></div><div class="line">           <span class="keyword">null</span>  <span class="comment">// remote regions</span></div><div class="line">   );</div><div class="line"></div><div class="line">   String json = String.valueOf(response.getEntity());</div><div class="line">   DecoderWrapper decoder = CodecWrappers.getDecoder(CodecWrappers.LegacyJacksonJson.class);</div><div class="line"></div><div class="line">   Applications decoded = decoder.decode(json, Applications.class);</div><div class="line">   <span class="comment">// test per app as the full apps list include the mock server that is not part of the test apps</span></div><div class="line">   <span class="keyword">for</span> (Application application : testApplications.getRegisteredApplications()) &#123;</div><div class="line">       Application decodedApp = decoded.getRegisteredApplications(application.getName());</div><div class="line">       assertThat(EurekaEntityComparators.equal(application, decodedApp), is(<span class="keyword">true</span>));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç›´æ¥è°ƒç”¨ <code>ApplicationsResource#getContainers(...)</code> æ–¹æ³•ã€‚</li></ul><p><strong>æ€»ç»“</strong>ï¼šè¿™ç§æ–¹å¼ï¼Œç®€å•ç²—æš´ï¼Œå®¹æ˜“ä¸Šæ‰‹ã€‚å½“ç„¶ï¼Œå®ƒçš„ç¼ºç‚¹æ˜¯<strong>æ¨¡æ‹Ÿ</strong>ã€‚åˆšå¼€å§‹è°ƒè¯• Eureka-Server å¯ä»¥å°è¯•è¿™ç§æ–¹å¼ã€‚</p><h2>3.2 Eureka-Server war åŒ…</h2><p>ç¬¬ä¸€æ­¥ï¼Œç¼–è¯‘ Eureka-Server war åŒ…ã€‚è¯¥æ­¥éª¤å¯èƒ½æ¶ˆè€—æ¼«é•¿çš„æ—¶é—´ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œè¯·ä¸æ–­é‡è¯•ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š</p><p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> eureka</div><div class="line">./gradlew clean build</div></pre></td></tr></table></figure></p><p>ç¬¬äºŒæ­¥ï¼ŒDebug è¿è¡Œ<code>com.netflix.eureka.resources.EurekaClientServerRestIntegrationTest</code> ä»»æ„å•å…ƒæµ‹è¯•æ–¹æ³•ã€‚</p><p><strong>æ€»ç»“</strong>ï¼šè¿™ç§æ–¹å¼ï¼Œç¼–è¯‘çš„è¿‡ç¨‹æ¯”è¾ƒç—›è‹¦ï¼Œä¸æ’é™¤å¤±è´¥çš„å¯èƒ½æ€§ã€‚æ¯æ¬¡å¢åŠ å¯¹ä»£ç çš„æ³¨å†Œåï¼Œéƒ½éœ€è¦é‡æ–°ç¼–è¯‘æ‰“åŒ…ã€‚å› æ­¤ä¸å»ºè®®é‡‡ç”¨ã€‚é‚£å’‹åŠå‘¢ï¼Ÿè§ç¬¬ä¸‰ç§ã€‚è‰¯å¿ƒå¦‚åšä¸»ï¼Œèµ¶ç´§å…³æ³¨åšä¸»çš„å¾®ä¿¡å…¬ä¼—å·ï¼šã€<strong>èŠ‹é“æºç </strong>ã€‘ã€‚</p><h2>3.3 Eureka-Server ç›´æ¥å¯åŠ¨</h2><p>ç¬¬ä¸€æ­¥ï¼Œä¿®æ”¹ <code>EurekaClientServerRestIntegrationTest#startServer()</code> æ–¹æ³•ï¼Œè§£å†³ç¬¬äºŒç§æ–¹å¼ä½¿ç”¨ war åŒ…è¿è¡Œæ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½éœ€è¦é‡æ–°ç¼–è¯‘çš„é—®é¢˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaClientServerRestIntegrationTest.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line"></div><div class="line">   <span class="comment">// TODO Thread.currentThread().getContextClassLoader() è·å–ä¸åˆ°è·¯å¾„ï¼Œå…ˆæš‚æ—¶è¿™æ ·ï¼›</span></div><div class="line">   WebAppContext webAppCtx = <span class="keyword">new</span> WebAppContext(<span class="keyword">new</span> File(<span class="string">"./eureka-server/src/main/webapp"</span>).getAbsolutePath(), <span class="string">"/"</span>);</div><div class="line">   webAppCtx.setDescriptor(<span class="keyword">new</span> File(<span class="string">"./eureka-server/src/main/webapp/WEB-INF/web.xml"</span>).getAbsolutePath());</div><div class="line">   webAppCtx.setResourceBase(<span class="keyword">new</span> File(<span class="string">"./eureka-server/src/main/resources"</span>).getAbsolutePath());</div><div class="line">   webAppCtx.setClassLoader(Thread.currentThread().getContextClassLoader());</div><div class="line">   server.setHandler(webAppCtx);</div><div class="line">   server.start();</div><div class="line"></div><div class="line">   eurekaServiceUrl = <span class="string">"http://localhost:8080/v2"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬”è€…ä¸å¤ªç†Ÿæ‚‰ Gradle çš„æ‰“åŒ…æ–¹å¼ï¼Œä½¿ç”¨ <code>Thread.currentThread().getContextClassLoader().getResource()</code> æ–¹æ³•ï¼Œä¸€ç›´æ— æ³•æ‹¿åˆ°è·¯å¾„ï¼Œæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚</li></ul><p>ç¬¬äºŒæ­¥ï¼ŒDebug è¿è¡Œ<code>com.netflix.eureka.resources.EurekaClientServerRestIntegrationTest</code> ä»»æ„å•å…ƒæµ‹è¯•æ–¹æ³•ã€‚TODO[0003]ï¼šThread.currentThread().getContextClassLoader() è·å–ä¸åˆ°è·¯å¾„ï¼Œå…ˆæš‚æ—¶è¿™æ ·ï¼›</p><p><strong>æ€»ç»“</strong>ï¼šè¿™ç§æ–¹å¼ï¼Œå®Œç¾ã€‚å»ºè®®ä½¿ç”¨è¯¥æ–¹å¼è°ƒè¯•ã€‚</p><h1>4. Eureka-Client å¯åŠ¨</h1><p>æˆ‘ä»¬ä»¥ <code>com.netflix.eureka.ExampleEurekaClient</code> ä¸ºä¾‹å­ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåœ¨ <code>EurekaClientServerRestIntegrationTest#setUp()</code> æ–¹æ³•æœ«å°¾æ·»åŠ  <code>Thread.sleep(Long.MAX_VALUE)</code> ä»£ç ã€‚</p><p>ç¬¬äºŒæ­¥ï¼ŒæŒ‰ç…§<a href="#">ã€Œ 3.3 Eureka-Server ç›´æ¥å¯åŠ¨ã€</a>æ–¹æ³•å¯åŠ¨ Eureka-Serverã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œå°† <code>EurekaClientServerRestIntegrationTest#injectEurekaConfiguration</code> å¤åˆ¶åˆ° ExampleEurekaClient ç±»é‡Œã€‚</p><p>ç¬¬å››æ­¥ï¼Œåœ¨ <code>ExampleEurekaClient#main()</code> æ–¹æ³•çš„ç¬¬ä¸€è¡Œï¼Œæ·»åŠ  <code>injectEurekaConfiguration()</code> ä»£ç ã€‚</p><p>ç¬¬äº”æ­¥ï¼ŒDebug è¿è¡Œ <code>ExampleEurekaClient#main()</code> æ–¹æ³•ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_08/02.png" alt=""></p><p><code>eureka-examples</code> æ¨¡å—è¿˜æä¾›åˆ«çš„ä¾‹å­ï¼Œå¯ä»¥é€ä¸ªè°ƒè¯•ã€‚</p><h1>666. å½©è›‹</h1><p>æœ¬æ–‡å†™çš„ï¼Œç›¸å¯¹æ¯”è¾ƒç®€æ´ï¼Œå¦‚æœæœ‰ä»»ä½•ç–‘é—®ï¼Œå¯ä»¥ç»™æˆ‘å…¬ä¼—å·ç•™è¨€ã€‚</p><p>ä¸‹ä¸€ç¯‡æ›´æ–°ï¼Ÿæ©ï¼Œæˆ‘è¿˜æ²¡æƒ³å¥½ï¼Œæ•´ç†<a href="#">ã€ŠEureka æºç è§£æã€‹</a>æ•´ä¸ªç³»åˆ—çš„ç›®å½•ingã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” é¡¹ç›®ç»“æ„ç®€ä»‹</title>
    <link href="http://www.iocoder.cn/Eureka/project-structure/"/>
    <id>http://www.iocoder.cn/Eureka/project-structure/</id>
    <published>2018-03-31T16:00:00.000Z</published>
    <updated>2017-10-05T02:31:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/project-structure/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a><ul><li><a href="#">1.1 ç®€ä»‹</a></li><li><a href="#">1.2 é¡¹ç›®ç»“æ„</a></li></ul></li><li><a href="#">2. eureka-client</a><ul><li><a href="#">2.1 eureka-client-archaius2</a></li><li><a href="#">2.2 eureka-client-jersey2</a></li></ul></li><li><a href="#">3. eureka-core</a><ul><li><a href="#">3.1 eureka-core-jersey2</a></li></ul></li><li><a href="#">4. eureka-resources</a></li><li><a href="#">5. eureka-server</a><ul><li><a href="#">5.1 eureka-server-governator</a></li></ul></li><li><a href="#">6. eureka-examples</a></li><li><a href="#">7. eureka-test-utils</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka çš„é¡¹ç›®ç»“æ„</strong>ï¼Œé™„å¸¦éƒ¨åˆ†ç®€ä»‹å’ŒåŸç†ã€‚</p><p>Eureka é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Netflix/eureka" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/eureka</a></p><ul><li>è¯·æ³¨æ„ä¸‹ï¼Œä¸æ˜¯ <code>spring-cloud-netflix-eureka-client</code> / <code>spring-cloud-netflix-eureka-server</code> ã€‚</li><li>ç¬”è€… Fork çš„ä»£ç ä»“åº“ <a href="https://github.com/YunaiV/eureka" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/eureka</a>ï¼Œä¼šéšç€è¿™ä¸ªç³»åˆ—çš„æ–‡ç« é€æ¸å¢åŠ <strong>ä¸­æ–‡æ³¨é‡Š</strong>ï¼Œå¯ä»¥å…ˆ Star ä¸€ä¸‹ã€‚</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h2>1.1 ç®€ä»‹</h2><p>Eureka æ˜¯ <a href="https://zh.wikipedia.org/wiki/Netflix" rel="external nofollow noopener noreferrer" target="_blank">Netflix</a> å¼€æºçš„æœåŠ¡æ³¨å†Œå‘ç°ç»„ä»¶ï¼Œåˆ†æˆ Client å’Œ Server ä¸¤éƒ¨åˆ†ã€‚ç®€åŒ–æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/01.png" alt=""></p><ul><li>Eureka-Server ï¼šé€šè¿‡ REST åè®®æš´éœ²æœåŠ¡ï¼Œæä¾›åº”ç”¨æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°çš„åŠŸèƒ½ã€‚</li><li>Application Provider ï¼šåº”ç”¨æœåŠ¡æä¾›è€…ï¼Œå†…åµŒ Eureka-Client ï¼Œé€šè¿‡å®ƒå‘ Eureka-Server æ³¨å†Œè‡ªèº«æœåŠ¡ã€‚</li><li>Application Consumer ï¼šåº”ç”¨æœåŠ¡æ¶ˆè´¹è€…ï¼Œå†…åµŒ Eureka-Client ï¼Œé€šè¿‡å®ƒä» Eureka-Server è·å–æœåŠ¡åˆ—è¡¨ã€‚</li><li>è¯·æ³¨æ„ä¸‹ï¼ŒApplication Provider å’Œ Application Consumer å¼ºè°ƒæ‰®æ¼”çš„è§’è‰²ï¼Œå®é™…å¯ä»¥åœ¨åŒä¸€ JVM è¿›ç¨‹ï¼Œå³æ˜¯æœåŠ¡çš„æä¾›è€…ï¼Œåˆæ˜¯æœåŠ¡çš„æ¶ˆè´¹è€…ã€‚</li></ul><h2>1.2 é¡¹ç›®ç»“æ„</h2><p>Eureka é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/02.png" alt=""></p><p>â“â“â“ä¸åª Eureka-Client ã€ Eureka-Server â“â“â“</p><p>æ·¡å®šã€‚æˆ‘ä»¬ä¸€èµ·æ¥äº†è§£æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½å’Œç»“æ„ã€‚</p><h1>2. <code>eureka-client</code></h1><p><code>eureka-client</code> æ¨¡å—ä¸º Eureka-Client çš„åŠŸèƒ½å®ç°ï¼š</p><ul><li><code>com.netflix.appinfo</code> åŒ…ï¼šEureka-Client çš„åº”ç”¨é…ç½®ã€‚æ­¤å¤„çš„åº”ç”¨æŒ‡çš„å°±æ˜¯ä¸Šæ–‡æåˆ°çš„ Application Providerï¼ŒApplication Consumerã€‚</li><li><code>com.netflix.discovery</code> åŒ…ï¼šEureka-Client çš„æ³¨å†Œä¸å‘ç°ç›¸å…³åŠŸèƒ½ã€‚<ul><li><p><code>com.netflix.discovery.DiscoveryClient</code> ç±»ï¼šæ³¨å†Œå‘ç°å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p></li><li><p><code>com.netflix.discovery.guice</code> åŒ…ï¼šEureka <strong>è®¡åˆ’</strong>ä½¿ç”¨ <a href="https://github.com/google/guice" rel="external nofollow noopener noreferrer" target="_blank">Google Guice</a> å®ç°ä¾èµ–æ³¨å…¥ï¼Œå‚è§æœ¬æ–‡ã€Œ5.1 <code>eureka-server-governator</code>ã€ã€‚ä¸€æ–¹é¢ Guice æ˜¯è½»é‡çº§çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œå¦ä¸€æ–¹é¢é¿å…å’Œä¸šåŠ¡ä»£ç çš„ Spring ç‰ˆæœ¬å†²çªã€‚</p><blockquote><p>Guice (pronounced 'juice') is a lightweight dependency injection framework for Java 6 and above, brought to you by Google.</p></blockquote></li><li><p><code>com.netflix.discovery.converters</code> åŒ…ï¼šEureka å†…éƒ¨ä¼ è¾“æ•°æ®ç¼–è§£ç è½¬æ¢å™¨ï¼Œæ”¯æŒ XML / JSON æ ¼å¼ã€‚</p></li><li><p><code>com.netflix.discovery.endpoint</code> åŒ…ï¼šç›®å‰è¯¥åŒ…æ­£åœ¨é‡æ„ï¼Œå’Œä¸‹æ–‡çš„ <code>com.netflix.discovery.shared.dns</code> å’Œ <code>com.netflix.discovery.shared.resolver</code> ç”¨é€”ç›¸è¿‘ã€‚</p></li><li><p><code>com.netflix.disvoery.provider</code> åŒ…ï¼šç›®å‰ä»…æœ‰ DiscoveryJerseyProvider ç±»ã€‚è¯¥ç±»å£°æ˜è‡ªå®šä¹‰çš„ Jersey è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®ç°ã€‚</p></li><li><p><code>com.netflix.disvoery.providers</code> åŒ…ï¼šç›®å‰ä»…æœ‰ DefaultEurekaClientConfigProvider ç±»ã€‚è¯¥ç±»å®ç° <code>javax.inject.Provider</code> æ¥å£ï¼Œè®¾ç½® EurekaClientConfig ( Eureka å®¢æˆ·ç«¯é…ç½® ) çš„ç”Ÿæˆå·¥å‚ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="http://blog.csdn.net/derekjiang/article/details/7231490" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle-Guiceå…¥é—¨ä»‹ç»ã€‹</a>æœç´¢ <strong>Provider</strong> å…³é”®å­—ã€‚</p></li><li><p><code>com.netflix.discovery.shared</code> åŒ…ï¼šEureka-Client å’Œ Eureka-Server æ³¨å†Œå‘ç°ç›¸å…³çš„å…±äº«é‡ç”¨çš„ä»£ç ã€‚ä¸‹æ–‡ä½ ä¼šçœ‹åˆ°ï¼ŒEureka-Server é€šè¿‡ <code>eureka-core</code> æ¨¡å—å®ç°ï¼Œ<code>eureka-core</code> ä¾èµ– <code>eureka-client</code>ã€‚<strong>ç²—ä¸€çœ‹ï¼Œæˆ‘ä»¬ä¼šæ„Ÿè§‰ What ï¼ŸEureka-Server ä»£ç ä¾èµ– Eureka-Client ä»£ç </strong>ï¼ï¼Ÿè¿™ä¸ªå’Œ Eureka-Server å¤šèŠ‚ç‚¹æ³¨å†Œä¿¡æ¯ P2P åŒæ­¥çš„å®ç°æœ‰å…³ã€‚ä¸€ä¸ª Eureka-Server æ”¶åˆ° Eureka-Client æ³¨å†Œè¯·æ±‚åï¼ŒEureka-Server ä¼šè‡ªå·±æ¨¡æ‹Ÿ Eureka-Client å‘é€æ³¨å†Œè¯·æ±‚åˆ°å…¶å®ƒçš„ Eureka-Serverï¼Œå› æ­¤éƒ¨åˆ†å®ç°ä»£ç å°±ä½¿ç”¨åˆ°äº†è¿™ä¸ªåŒ…ï¼Œåœ¨<a href="#">TODO[0002]ï¼šã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤ï¼ˆäºŒï¼‰ä¹‹åŒæ­¥æ³¨å†Œè¡¨ã€‹</a>è¯¦ç»†è§£æã€‚</p><ul><li><code>com.netflix.discovery.shared.transport</code> åŒ…ï¼šEureka-Client å¯¹ Eureka-Server RESTful çš„ HTTP å®¢æˆ·ç«¯ï¼ŒåŸºäº Jersey Client å®ç°ã€‚Jersey åœ¨ä¸‹æ–‡ã€Œ2.1 <code>eureka-client-jersey2</code>ã€è¯¦ç»†è§£æã€‚</li><li><code>com.netflix.discovery.shared.dns</code> åŒ… ï¼šDNS è§£æå™¨ã€‚</li><li><code>com.netflix.discovery.shared.resolver</code> åŒ…ï¼šEurekaEndpoint è§£æå™¨ã€‚ã€TODO[0001]ï¼š<code>com.netflix.discovery.shared.resolver</code>ã€‘</li></ul></li><li><p><code>com.netflix.discovery.util</code> åŒ… ï¼šå·¥å…·ç±»ã€‚</p></li></ul></li></ul><h2>2.1 <code>eureka-client-archaius2</code></h2><p><a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Archaius</a> æ˜¯ Netflix å¼€æºçš„é…ç½®ç®¡ç†ç»„ä»¶ã€‚</p><p>Archaius ç›®å‰æœ‰ 1.x å’Œ 2.x ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒEureka ä½¿ç”¨ 1.x ç‰ˆæœ¬ã€‚ä»å®˜æ–¹æ–‡æ¡£ä¸Šæ¥çœ‹ï¼Œ2.x ç‰ˆæœ¬ä»ç„¶åœ¨å¼€å‘ä¸­ã€‚</p><blockquote><p>FROM <a href="https://github.com/YunaiV/eureka/blob/103e0875b08c9ff4abb85eaab672df2041b63558/eureka-client-archaius2/README.md" rel="external nofollow noopener noreferrer" target="_blank">eureka-client-archaius2 README</a><br>This is a version of eureka-client that has been ported to use Archaius 2.x as the backing configuration system. Please note that this client is still work in progress. This client is also only java8 compatible (as Archaius 2.x is only java8 compatible).</p></blockquote><h2>2.2 <code>eureka-client-jersey2</code></h2><p><a href="https://github.com/jersey/jersey" rel="external nofollow noopener noreferrer" target="_blank">Jersey</a> æ˜¯ JAX-RSï¼ˆJSR311ï¼‰å¼€æºå‚è€ƒå®ç°ï¼Œç”¨äºæ„å»º RESTful Web Serviceã€‚</p><ul><li>Eureka-Server ä½¿ç”¨ <a href="https://github.com/jersey/jersey/tree/9fdb7e386dc56b33f569ab198caf818d7a18525d/core-server/" rel="external nofollow noopener noreferrer" target="_blank">Jersey Server</a> åˆ›å»º RESTful Server ã€‚</li><li>Eureka-Client ä½¿ç”¨ <a href="https://github.com/jersey/jersey/tree/9fdb7e386dc56b33f569ab198caf818d7a18525d/core-client/" rel="external nofollow noopener noreferrer" target="_blank">Jersey Client</a> è¯·æ±‚ Eureka-Server ã€‚</li></ul><p>Jersey ç›®å‰æœ‰ 1.x å’Œ 2.x ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒEureka ä½¿ç”¨ 1.x ç‰ˆæœ¬ã€‚ä»å®˜æ–¹æ–‡æ¡£ä¸Šæ¥çœ‹ï¼Œ2.x ç‰ˆæœ¬ç”±ç¤¾åŒºå®ç°ï¼ŒNetflix è‡ªå·±æš‚æœªä½¿ç”¨ã€‚</p><blockquote><p>FROM <a href="https://github.com/Netflix/eureka/tree/30a85dc31be1c9d399e4e6ec5150759fb8777edf/eureka-client-jersey2/" rel="external nofollow noopener noreferrer" target="_blank">eureka-client-jersey2 README</a><br>Please note that this jersey2 compatible Eureka client (eureka-client-jersey2) is created and maintained by the community. Netflix does not currently use this library internally.</p></blockquote><h1>3. <code>eureka-core</code></h1><p><code>eureka-core</code> æ¨¡å—ä¸º Eureka-Server çš„åŠŸèƒ½å®ç°ï¼š</p><ul><li><code>com.netflix.eureka.EurekaBootStrap</code> ç±»ï¼šEureka-Server å¯åŠ¨ç±»ã€‚</li><li><code>com.netflix.eureka.aws</code> åŒ…ï¼šä¸äºšé©¬é€Š AWS æœåŠ¡ç›¸å…³çš„ç±»ã€‚ç”±äºç¬”è€…å’Œå¤§å¤šæ•°è¯»è€…éƒ½å¯¹ AWS æš‚ä¸äº†è§£ï¼Œæœ¬ç³»åˆ—<a href="#">ã€ŠEureka æºç è§£æã€‹</a>ä¼šè·³è¿‡å’Œ AWS ç›¸å…³çš„ä»£ç ã€‚</li><li><code>com.netflix.eureka.cluster</code> åŒ…ï¼šEureka-Server é›†ç¾¤æ•°æ®å¤åˆ¶ç›¸å…³çš„ä»£ç ã€‚</li><li><code>com.netflix.eureka.lease</code> åŒ…ï¼šåº”ç”¨æ³¨å†Œåçš„<strong>ç§Ÿçº¦</strong>ç®¡ç†( æ³¨å†Œ / å–æ¶ˆ / ç»­æœŸ / è¿‡æœŸ )ã€‚</li><li><code>com.netflix.eureka.resousrces</code> åŒ…ï¼šèµ„æºï¼ŒåŸºäº Jersey Server å®ç°ï¼Œç›¸å½“äº Spring MVC çš„æ§åˆ¶å±‚ä»£ç ã€‚</li><li><code>com.netflix.eureka.transport</code> åŒ…ï¼šEureka-Server å¯¹ Eureka-Server çš„ RESTful HTTP å®¢æˆ·ç«¯ï¼ŒåŸºäº <code>com.netflix.discovery.shared.transport</code> å°è£…å®ç°ã€‚</li><li><code>com.netflix.eureka.util</code> åŒ…ï¼šå·¥å…·ç±»ã€‚</li></ul><h2>3.1 <code>eureka-core-jersey2</code></h2><p>å‚è§æœ¬æ–‡ã€Œ2.1 <code>eureka-client-jersey2</code>ã€ã€‚</p><h1>4. <code>eureka-resources</code></h1><p><code>eureka-resources</code> æ¨¡å—ï¼Œä½¿ç”¨ JSP å®ç° Eureka-Server çš„è¿ç»´åå°ç•Œé¢ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/03.png" alt=""></p><h1>5. <code>eureka-server</code></h1><p><code>eureka-server</code> æ¨¡å—ï¼Œå°† <code>eureka-client</code> + <code>eureka-core</code> + <code>eureka-resources</code> ä¸‰è€…æ‰“åŒ…æˆ Eureka-Server çš„ <code>war</code> åŒ…ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/04.png" alt=""></p><h2>5.1 <code>eureka-server-governator</code></h2><p><code>eureka-server-governator</code> æ¨¡å—ï¼Œä½¿ç”¨ <a href="https://github.com/Netflix/governator" rel="external nofollow noopener noreferrer" target="_blank">Netflix Governator</a> ç®¡ç† Eureka-Server çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><blockquote><p>FROM <a href="http://www.infoq.com/cn/news/2013/02/netflix-opensource" rel="external nofollow noopener noreferrer" target="_blank">http://www.infoq.com/cn/news/2013/02/netflix-opensource</a><br><strong>Governator</strong>ï¼Œä¸€æ¬¾å¯¹ Google Guice è¿›è¡Œæ‰©å±•çš„ç±»åº“ï¼Œæä¾›äº†Classpathæ‰«æåŠè‡ªåŠ¨ç»‘å®šã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æˆå‘˜å±æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚</p></blockquote><p>ç›®å‰è¯¥æ¨¡å—æ­£åœ¨å®ç°é˜¶æ®µã€‚</p><blockquote><p>FROM <a href="https://github.com/Netflix/eureka/tree/30a85dc31be1c9d399e4e6ec5150759fb8777edf/eureka-server-governator/" rel="external nofollow noopener noreferrer" target="_blank">eureka-server-governator README</a><br>This server build is still experimental.</p></blockquote><h1>6. <code>eureka-examples</code></h1><p><code>eureka-examples</code> æ¨¡å—ï¼Œæä¾› Eureka-Client ä½¿ç”¨ä¾‹å­ã€‚</p><h1>7. <code>eureka-test-utils</code></h1><p><code>eureka-test-utils</code> æ¨¡å—ï¼Œæä¾› Eureka å•å…ƒæµ‹è¯•å·¥å…·ç±»ã€‚</p><h1>666. å½©è›‹</h1><p>ç¬¬ä¸€ç¯‡ Eureka çš„æ–‡ç« ï¼Œå¦‚æœæœ‰åœ°æ–¹å†™çš„ä¸æ­£ç¡®ï¼Œè¿˜æœ›æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</p><p>ä¸‹ä¸€ç¯‡ Eureka è°ƒè¯•ç¯å¢ƒæ­å»ºã€‚</p><p>æ›´å¤š Eureka å†…å®¹ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li>æºç¨‹ â€”â€” <a href="http://techshow.ctrip.com/archives/1699.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a></li><li>ç¨‹åºå‘˜DD â€”â€” <a href="http://blog.didispace.com/springcloud-sourcecode-eureka/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudæºç åˆ†æï¼ˆä¸€ï¼‰Eurekaã€‹</a></li><li>ç‹é¸¿é£ â€”â€” <a href="http://blog.spring-cloud.io/blog/sc-eureka.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Netflix Eurekaæºç å¯¼è¯»ä¸åŸç†åˆ†æã€‹</a></li><li>è®¸è¿› â€”â€” <a href="http://xujin.org/sc/sc-netflix-eureka/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Netflixä¹‹Eurekaä¸Šç¯‡ã€‹</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/project-structure/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” é¡¹ç›®å®æˆ˜</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/http-sample/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/http-sample/</id>
    <published>2018-03-14T16:00:00.000Z</published>
    <updated>2017-09-18T08:14:58.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-%E5%AE%9E%E4%BD%93%E7%BB%93%E6%9E%84">2. å®ä½“ç»“æ„</a><ul><li><a href="#21-%E5%95%86%E5%9F%8E%E6%9C%8D%E5%8A%A1">2.1 å•†åŸæœåŠ¡</a></li><li><a href="#22-%E8%B5%84%E9%87%91%E6%9C%8D%E5%8A%A1">2.2 èµ„é‡‘æœåŠ¡</a></li><li><a href="#23-%E7%BA%A2%E5%8C%85%E6%9C%8D%E5%8A%A1">2.3 çº¢åŒ…æœåŠ¡</a></li></ul></li><li><a href="#3-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8">3. æœåŠ¡è°ƒç”¨</a></li><li><a href="#4-%E4%B8%8B%E5%8D%95%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B">4. ä¸‹å•æ”¯ä»˜æµç¨‹</a><ul><li><a href="#41-try-%E9%98%B6%E6%AE%B5">4.1 Try é˜¶æ®µ</a></li><li><a href="#42-confirm--cancel-%E9%98%B6%E6%AE%B5">4.2 Confirm / Cancel é˜¶æ®µ</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC é¡¹ç›®å®æˆ˜</strong>ã€‚ä»¥å®˜æ–¹ Mavené¡¹ç›® <code>tcc-transaction-http-sample</code> ä¸ºä¾‹å­( <code>tcc-transaction-dubbo-sample</code> ç±»ä¼¼ )ã€‚</p><p>å»ºè®®ä½ å·²ç»æˆåŠŸå¯åŠ¨äº†è¯¥é¡¹ç›®ã€‚å¦‚æœä¸çŸ¥é“å¦‚ä½•å¯åŠ¨ï¼Œå¯ä»¥å…ˆæŸ¥çœ‹<a href="http://www.iocoder.cn/TCC-Transaction/build-debugging-environment/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»ºã€‹</a>ã€‚å¦‚æœå†ç¢°åˆ°é—®é¢˜ï¼Œæ¬¢è¿åŠ å¾®ä¿¡å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> )ï¼Œæˆ‘ä¼šä¸€ä¸€ä»”ç»†å›å¤ã€‚</p><p>OKï¼Œé¦–å…ˆæˆ‘ä»¬ç®€å•äº†è§£ä¸‹è¿™ä¸ªé¡¹ç›®ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/01.png" alt=""></p><ul><li>é¦–é¡µ =&gt; å•†å“åˆ—è¡¨ =&gt; ç¡®è®¤æ”¯ä»˜é¡µ =&gt; æ”¯ä»˜ç»“æœé¡µ</li><li>ä½¿ç”¨è´¦æˆ·ä½™é¢ + çº¢åŒ…ä½™é¢<strong>è”åˆ</strong>æ”¯ä»˜è´­ä¹°å•†å“ï¼Œå¹¶è´¦æˆ·ä¹‹é—´<strong>è½¬è´¦</strong>ã€‚</li></ul><p>é¡¹ç›®æ‹†åˆ†ä¸‰ä¸ªå­ Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-http-order</code> ï¼šå•†åŸæœåŠ¡ï¼Œæä¾›å•†å“å’Œå•†å“è®¢å•é€»è¾‘ã€‚</li><li><code>tcc-transaction-http-capital</code> ï¼šèµ„é‡‘æœåŠ¡ï¼Œæä¾›è´¦æˆ·ä½™é¢é€»è¾‘ã€‚</li><li><code>tcc-transaction-http-redpacket</code> ï¼šçº¢åŒ…æœåŠ¡ï¼Œæä¾›çº¢åŒ…ä½™é¢é€»è¾‘ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/03.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1>2. å®ä½“ç»“æ„</h1><h2>2.1 å•†åŸæœåŠ¡</h2><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/02.png" alt=""></p><ul><li><p>Shopï¼Œå•†åº—è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†åº—ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰€æœ‰è€…ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> ownerUserId;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>Productï¼Œå•†å“è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†å“ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> productId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†åº—ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> shopId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†å“å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String productName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä»·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal price;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>Orderï¼Œè®¢å•è¡¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5908730245224893590L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯ä»˜( ä¸‹å• )ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> payerUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¶æ¬¾( å•†åº—æ‹¥æœ‰è€… )ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> payeeUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çº¢åŒ…æ”¯ä»˜é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal redPacketPayAmount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è´¦æˆ·ä½™é¢æ”¯ä»˜é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal capitalPayAmount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•çŠ¶æ€</span></div><div class="line"><span class="comment">     * - DRAFT ï¼šè‰ç¨¿</span></div><div class="line"><span class="comment">     * - PAYING ï¼šæ”¯ä»˜ä¸­</span></div><div class="line"><span class="comment">     * - CONFIRMED ï¼šæ”¯ä»˜æˆåŠŸ</span></div><div class="line"><span class="comment">     * - PAY_FAILED ï¼šæ”¯ä»˜å¤±è´¥</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String status = <span class="string">"DRAFT"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†æˆ·è®¢å•å·ï¼Œä½¿ç”¨ UUID ç”Ÿæˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String merchantOrderNo;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•æ˜ç»†æ•°ç»„</span></div><div class="line"><span class="comment">     * éå­˜å‚¨å­—æ®µ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;OrderLine&gt; orderLines = <span class="keyword">new</span> ArrayList&lt;OrderLine&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>OrderLineï¼Œè®¢å•æ˜ç»†ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderLine</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2300754647209250837L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†å“ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> productId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> quantity;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä»·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal unitPrice;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p><strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼š</p><p>ä¸‹å•æ—¶ï¼Œæ’å…¥è®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„è®¢å•( Order )è®°å½•ï¼Œå¹¶æ’å…¥è´­ä¹°çš„å•†å“è®¢å•æ˜ç»†( OrderLine )è®°å½•ã€‚æ”¯ä»˜æ—¶ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸º <code>&quot;PAYING&quot;</code>ã€‚</p><ul><li>è®¢å•æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸º <code>&quot;CONFIRMED&quot;</code>ã€‚</li><li>è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°è®¢å•çŠ¶ä½“ä¸º <code>&quot;PAY_FAILED&quot;</code>ã€‚</li></ul><h2>2.2 èµ„é‡‘æœåŠ¡</h2><p>å…³ç³»è¾ƒä¸ºç®€å•ï¼Œæœ‰ä¸¤ä¸ªå®ä½“ï¼š</p><ul><li><p>CapitalAccountï¼Œèµ„é‡‘è´¦æˆ·ä½™é¢ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CapitalAccount</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è´¦æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½™é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal balanceAmount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>TradeOrderï¼Œäº¤æ˜“è®¢å•è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradeOrder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å‡ºç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> selfUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å…¥ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> oppositeUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†æˆ·è®¢å•å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String merchantOrderNo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal amount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•çŠ¶æ€</span></div><div class="line"><span class="comment">     * - DRAFT ï¼šè‰ç¨¿</span></div><div class="line"><span class="comment">     * - CONFIRM ï¼šäº¤æ˜“æˆåŠŸ</span></div><div class="line"><span class="comment">     * - CANCEL ï¼šäº¤æ˜“å–æ¶ˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String status = <span class="string">"DRAFT"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p><strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼š</p><p>è®¢å•æ”¯ä»˜æ”¯ä»˜ä¸­ï¼Œæ’å…¥äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„è®¢å•( TradeOrder )è®°å½•ï¼Œå¹¶æ›´æ–°<strong>å‡å°‘</strong>ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚</p><ul><li>è®¢å•æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CONFIRM&quot;</code>ï¼Œå¹¶æ›´æ–°<strong>å¢åŠ </strong>å•†åº—æ‹¥æœ‰ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚</li><li>è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CANCEL&quot;</code>ï¼Œå¹¶æ›´æ–°**å¢åŠ ( æ¢å¤ )**ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚</li></ul><h2>2.3 çº¢åŒ…æœåŠ¡</h2><p>å…³ç³»è¾ƒä¸ºç®€å•ï¼Œ<strong>å’Œèµ„é‡‘æœåŠ¡ 99.99% ç›¸åŒ</strong>ï¼Œæœ‰ä¸¤ä¸ªå®ä½“ï¼š</p><ul><li><p>RedPacketAccountï¼Œçº¢åŒ…è´¦æˆ·ä½™é¢ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPacketAccount</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è´¦æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½™é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal balanceAmount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>TradeOrderï¼Œäº¤æ˜“è®¢å•è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradeOrder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å‡ºç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> selfUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å…¥ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> oppositeUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†æˆ·è®¢å•å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String merchantOrderNo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal amount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•çŠ¶æ€</span></div><div class="line"><span class="comment">     * - DRAFT ï¼šè‰ç¨¿</span></div><div class="line"><span class="comment">     * - CONFIRM ï¼šäº¤æ˜“æˆåŠŸ</span></div><div class="line"><span class="comment">     * - CANCEL ï¼šäº¤æ˜“å–æ¶ˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String status = <span class="string">"DRAFT"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><p><strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼š</p><p>è®¢å•æ”¯ä»˜æ”¯ä»˜ä¸­ï¼Œæ’å…¥äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„è®¢å•( TradeOrder )è®°å½•ï¼Œå¹¶æ›´æ–°<strong>å‡å°‘</strong>ä¸‹å•ç”¨æˆ·çš„çº¢åŒ…è´¦æˆ·ä½™é¢ã€‚</p><ul><li>è®¢å•æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CONFIRM&quot;</code>ï¼Œå¹¶æ›´æ–°<strong>å¢åŠ </strong>å•†åº—æ‹¥æœ‰ç”¨æˆ·çš„çº¢åŒ…è´¦æˆ·ä½™é¢ã€‚</li><li>è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CANCEL&quot;</code>ï¼Œå¹¶æ›´æ–°**å¢åŠ ( æ¢å¤ )**ä¸‹å•ç”¨æˆ·çš„çº¢åŒ…è´¦æˆ·ä½™é¢ã€‚</li></ul><h1>3. æœåŠ¡è°ƒç”¨</h1><p>æœåŠ¡ä¹‹é—´ï¼Œé€šè¿‡ <strong>HTTP</strong> è¿›è¡Œè°ƒç”¨ã€‚</p><p><strong>çº¢åŒ…æœåŠ¡å’Œèµ„é‡‘æœåŠ¡ä¸ºå•†åŸæœåŠ¡æä¾›è°ƒç”¨( ä»¥èµ„é‡‘æœåŠ¡ä¸ºä¾‹å­ )</strong>ï¼š</p><ul><li><p>XML é…ç½®å¦‚ä¸‹ ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-service-provider.xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalAccountRepository"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.domain.repository.CapitalAccountRepository"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"tradeOrderRepository"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.domain.repository.TradeOrderRepository"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalTradeOrderService"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.service.CapitalTradeOrderServiceImpl"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalAccountService"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.service.CapitalAccountServiceImpl"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalTradeOrderServiceExporter"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.SimpleHttpInvokerServiceExporter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span> <span class="attr">ref</span>=<span class="string">"capitalTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalTradeOrderService"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalAccountServiceExporter"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.SimpleHttpInvokerServiceExporter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span> <span class="attr">ref</span>=<span class="string">"capitalAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalAccountService"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"httpServer"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.support.SimpleHttpServerFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"contexts"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">util:map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalTradeOrderService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalTradeOrderServiceExporter"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalAccountService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalAccountServiceExporter"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"8081"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p></li><li><p>Java ä»£ç å®ç°å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CapitalAccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">CapitalAccountService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    CapitalAccountRepository capitalAccountRepository;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getCapitalAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> capitalAccountRepository.findByUserId(userId).getBalanceAmount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CapitalAccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">CapitalAccountService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    CapitalAccountRepository capitalAccountRepository;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getCapitalAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> capitalAccountRepository.findByUserId(userId).getBalanceAmount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p><strong>å•†åŸæœåŠ¡è°ƒç”¨</strong></p><ul><li><p>XML é…ç½®å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-service-consumer.xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"httpInvokerRequestExecutor"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.CommonsHttpInvokerRequestExecutor"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpClient"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.httpclient.HttpClient"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpConnectionManager"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"multiThreadHttpConnectionManager"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"multiThreadHttpConnectionManager"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.apache.commons.httpclient.MultiThreadedHttpConnectionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"params"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.httpclient.params.HttpConnectionManagerParams"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionTimeout"</span> <span class="attr">value</span>=<span class="string">"200000"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotalConnections"</span> <span class="attr">value</span>=<span class="string">"600"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultMaxConnectionsPerHost"</span> <span class="attr">value</span>=<span class="string">"512"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"soTimeout"</span> <span class="attr">value</span>=<span class="string">"5000"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"captialTradeOrderService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8081/remoting/CapitalTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"capitalAccountService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8081/remoting/CapitalAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redPacketAccountService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8082/remoting/RedPacketAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.redpacket.api.RedPacketAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redPacketTradeOrderService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8082/remoting/RedPacketTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.redpacket.api.RedPacketTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p></li><li><p>Java æ¥å£æ¥å£å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalAccountService</span> </span>&#123;</div><div class="line">    <span class="function">BigDecimal <span class="title">getCapitalAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketAccountService</span> </span>&#123;</div><div class="line">    <span class="function">BigDecimal <span class="title">getRedPacketAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, RedPacketTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h1>4. ä¸‹å•æ”¯ä»˜æµç¨‹</h1><p><strong>ps</strong>ï¼šæ•°æ®è®¿é—®çš„æ–¹æ³•ï¼Œè¯·è‡ªå·±æ‹‰å–ä»£ç ï¼Œä½¿ç”¨ IDE æŸ¥çœ‹ã€‚è°¢è°¢ã€‚ğŸ™‚</p><p>ä¸‹å•æ”¯ä»˜æµç¨‹ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾( <a href="./../../images/TCC-Transaction/2018_03_15/04.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/04.png" alt=""></p><p>ç‚¹å‡»**ã€æ”¯ä»˜ã€‘**æŒ‰é’®ï¼Œä¸‹å•æ”¯ä»˜æµç¨‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">""</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="meta">@RequestMapping</span>(value = <span class="string">"/placeorder"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">placeOrder</span><span class="params">(@RequestParam String redPacketPayAmount,</span></span></div><div class="line"><span class="function"><span class="params">                                   @RequestParam <span class="keyword">long</span> shopId,</span></span></div><div class="line"><span class="function"><span class="params">                                   @RequestParam <span class="keyword">long</span> payerUserId,</span></span></div><div class="line"><span class="function"><span class="params">                                   @RequestParam <span class="keyword">long</span> productId)</span> </span>&#123;</div><div class="line">        PlaceOrderRequest request = buildRequest(redPacketPayAmount, shopId, payerUserId, productId);</div><div class="line">        <span class="comment">// ä¸‹å•å¹¶æ”¯ä»˜è®¢å•</span></div><div class="line">        String merchantOrderNo = placeOrderService.placeOrder(request.getPayerUserId(), request.getShopId(),</div><div class="line">                request.getProductQuantities(), request.getRedPacketPayAmount());</div><div class="line">        <span class="comment">// è¿”å›</span></div><div class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView(<span class="string">"pay_success"</span>);</div><div class="line">        <span class="comment">// æŸ¥è¯¢è®¢å•çŠ¶æ€</span></div><div class="line">        String status = orderService.getOrderStatusByMerchantOrderNo(merchantOrderNo);</div><div class="line">        <span class="comment">// æ”¯ä»˜ç»“æœæç¤º</span></div><div class="line">        String payResultTip = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"CONFIRMED"</span>.equals(status)) &#123;</div><div class="line">            payResultTip = <span class="string">"æ”¯ä»˜æˆåŠŸ"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"PAY_FAILED"</span>.equals(status)) &#123;</div><div class="line">            payResultTip = <span class="string">"æ”¯ä»˜å¤±è´¥"</span>;</div><div class="line">        &#125;</div><div class="line">        mv.addObject(<span class="string">"payResult"</span>, payResultTip);</div><div class="line">        <span class="comment">// å•†å“ä¿¡æ¯</span></div><div class="line">        mv.addObject(<span class="string">"product"</span>, productRepository.findById(productId));</div><div class="line">        <span class="comment">// èµ„é‡‘è´¦æˆ·é‡‘é¢ å’Œ çº¢åŒ…è´¦æˆ·é‡‘é¢</span></div><div class="line">        mv.addObject(<span class="string">"capitalAmount"</span>, accountService.getCapitalAccountByUserId(payerUserId));</div><div class="line">        mv.addObject(<span class="string">"redPacketAmount"</span>, accountService.getRedPacketAccountByUserId(payerUserId));</div><div class="line">        <span class="keyword">return</span> mv;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>PlaceOrderService#placeOrder(...)</code> æ–¹æ³•ï¼Œä¸‹å•å¹¶æ”¯ä»˜è®¢å•ã€‚</li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-order/src/main/java/org/mengyun/tcctransaction/sample/http/order/domain/service/OrderServiceImpl.java" rel="external nofollow noopener noreferrer" target="_blank"><code>OrderService#getOrderStatusByMerchantOrderNo(...)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢è®¢å•çŠ¶æ€ã€‚</li></ul><hr><p>è°ƒç”¨ <code>PlaceOrderService#placeOrder(...)</code> æ–¹æ³•ï¼Œä¸‹å•å¹¶æ”¯ä»˜è®¢å•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlaceOrderServiceImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">placeOrder</span><span class="params">(<span class="keyword">long</span> payerUserId, <span class="keyword">long</span> shopId, List&lt;Pair&lt;Long, Integer&gt;&gt; productQuantities, BigDecimal redPacketPayAmount)</span> </span>&#123;</div><div class="line">        <span class="comment">// è·å–å•†åº—</span></div><div class="line">        Shop shop = shopRepository.findById(shopId);</div><div class="line">        <span class="comment">// åˆ›å»ºè®¢å•</span></div><div class="line">        Order order = orderService.createOrder(payerUserId, shop.getOwnerUserId(), productQuantities);</div><div class="line">        <span class="comment">// å‘èµ·æ”¯ä»˜</span></div><div class="line">        Boolean result = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            paymentService.makePayment(order, redPacketPayAmount, order.getTotalAmount().subtract(redPacketPayAmount));</div><div class="line">        &#125; <span class="keyword">catch</span> (ConfirmingException confirmingException) &#123;</div><div class="line">            <span class="comment">// exception throws with the tcc transaction status is CONFIRMING,</span></div><div class="line">            <span class="comment">// when tcc transaction is confirming status,</span></div><div class="line">            <span class="comment">// the tcc transaction recovery will try to confirm the whole transaction to ensure eventually consistent.</span></div><div class="line">            result = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (CancellingException cancellingException) &#123;</div><div class="line">            <span class="comment">// exception throws with the tcc transaction status is CANCELLING,</span></div><div class="line">            <span class="comment">// when tcc transaction is under CANCELLING status,</span></div><div class="line">            <span class="comment">// the tcc transaction recovery will try to cancel the whole transaction to ensure eventually consistent.</span></div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="comment">// other exceptions throws at TRYING stage.</span></div><div class="line">            <span class="comment">// you can retry or cancel the operation.</span></div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> order.getMerchantOrderNo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è°ƒç”¨ <code>ShopRepository#findById(...)</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢å•†åº—ã€‚</p></li><li><p>è°ƒç”¨ <code>OrderService#createOrder(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºè®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„<strong>å•†åŸ</strong>è®¢å•ã€‚å®é™…ä¸šåŠ¡ä¸ä¼šè¿™ä¹ˆåšï¼Œæ­¤å¤„ä»…ä»…æ˜¯ä¾‹å­ï¼Œç®€åŒ–æµç¨‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Transactional</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">createOrder</span><span class="params">(<span class="keyword">long</span> payerUserId, <span class="keyword">long</span> payeeUserId, List&lt;Pair&lt;Long, Integer&gt;&gt; productQuantities)</span> </span>&#123;</div><div class="line">        Order order = orderFactory.buildOrder(payerUserId, payeeUserId, productQuantities);</div><div class="line">        orderRepository.createOrder(order);</div><div class="line">        <span class="keyword">return</span> order;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li>è°ƒç”¨ <code>PaymentService#makePayment(...)</code> æ–¹æ³•ï¼Œå‘èµ·æ”¯ä»˜ï¼Œ<strong>TCC æµç¨‹</strong>ã€‚</li><li><strong>ç”Ÿäº§ä»£ç å¯¹äºå¼‚å¸¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</li><li><strong>ç”Ÿäº§ä»£ç å¯¹äºå¼‚å¸¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</li><li><strong>ç”Ÿäº§ä»£ç å¯¹äºå¼‚å¸¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</li></ul><h2>4.1 Try é˜¶æ®µ</h2><p><strong>å•†åŸæœåŠ¡</strong></p><p>è°ƒç”¨ <code>PaymentService#makePayment(...)</code> æ–¹æ³•ï¼Œå‘èµ· Try æµç¨‹ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmMakePayment"</span>, cancelMethod = <span class="string">"cancelMakePayment"</span>)</div><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order, BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   System.out.println(<span class="string">"order try make payment called.time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜ä¸­</span></div><div class="line">   order.pay(redPacketPayAmount, capitalPayAmount);</div><div class="line">   orderRepository.updateOrder(order);</div><div class="line">   <span class="comment">// èµ„é‡‘è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•</span></div><div class="line">   String result = tradeOrderServiceProxy.record(<span class="keyword">null</span>, buildCapitalTradeOrderDto(order));</div><div class="line">   <span class="comment">// çº¢åŒ…è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•</span></div><div class="line">   String result2 = tradeOrderServiceProxy.record(<span class="keyword">null</span>, buildRedPacketTradeOrderDto(order));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Compensable</p><ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ« Propagation.REQUIRED ( <strong>é»˜è®¤å€¼</strong> )</li><li>è®¾ç½® <code>confirmMethod</code> /  <code>cancelMethod</code> æ–¹æ³•å</li><li>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ç±» DefaultTransactionContextEditor ( <strong>é»˜è®¤å€¼</strong> )</li></ul></li><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</p></li><li><p>è°ƒç”¨ <code>OrderRepository#updateOrder(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸º<strong>æ”¯ä»˜ä¸­</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Order.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.redPacketPayAmount = redPacketPayAmount;</div><div class="line">   <span class="keyword">this</span>.capitalPayAmount = capitalPayAmount;</div><div class="line">   <span class="keyword">this</span>.status = <span class="string">"PAYING"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><ul><li><p>è°ƒç”¨ <code>TradeOrderServiceProxy#record(...)</code> æ–¹æ³•ï¼Œ<strong>èµ„é‡‘</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TradeOrderServiceProxy.java</span></div><div class="line"><span class="meta">@Compensable</span>(propagation = Propagation.SUPPORTS, confirmMethod = <span class="string">"record"</span>, cancelMethod = <span class="string">"record"</span>, transactionContextEditor = Compensable.DefaultTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> capitalTradeOrderService.record(transactionContext, tradeOrderDto);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CapitalTradeOrderService.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Compensable</p><ul><li><code>propagation=Propagation.SUPPORTS</code> ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚<strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ REQUIRED</strong> ï¼Ÿå¦‚æœä½¿ç”¨ REQUIRED äº‹åŠ¡ä¼ æ’­çº§åˆ«ï¼Œäº‹åŠ¡æ¢å¤é‡è¯•æ—¶ï¼Œä¼šå‘èµ·æ–°çš„äº‹åŠ¡ã€‚</li><li><code>confirmMethod</code>ã€<code>cancelMethod</code> ä½¿ç”¨å’Œ try æ–¹æ³•<strong>ç›¸åŒæ–¹æ³•å</strong>ï¼š<strong>æœ¬åœ°å‘èµ·</strong>è¿œç¨‹æœåŠ¡ TCC confirm / cancel é˜¶æ®µï¼Œè°ƒç”¨ç›¸åŒæ–¹æ³•è¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚è¿œç¨‹æœåŠ¡çš„ CompensableTransactionInterceptor ä¼šæ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æ˜¯ CONFIRMING / CANCELLING æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CapitalTradeOrderService#record(...)</code> æ–¹æ³•ï¼Œè¿œç¨‹è°ƒç”¨ï¼Œå‘èµ·<strong>èµ„é‡‘</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚</p><ul><li>æœ¬åœ°æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå‚æ•° <code>transactionContext</code> ä¼ é€’ <code>null</code> å³å¯ï¼ŒTransactionContextEditor ä¼šè®¾ç½®ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/tcc-core/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°ã€‹ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>è¿œç¨‹æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå‚æ•° <code>transactionContext</code> éœ€è¦ä¼ é€’ã€‚Dubbo è¿œç¨‹æ–¹æ³•è°ƒç”¨å®é™…ä¹Ÿè¿›è¡Œäº†ä¼ é€’ï¼Œä¼ é€’æ–¹å¼è¾ƒä¸ºç‰¹æ®Šï¼Œé€šè¿‡éšå¼èˆ¹èˆ±ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒã€‹ã€Œ3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul></li><li><p>è°ƒç”¨ <code>TradeOrderServiceProxy#record(...)</code> æ–¹æ³•ï¼Œ<strong>çº¢åŒ…</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚å’Œ<strong>èµ„é‡‘</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å• 99.99% ç±»ä¼¼ï¼Œä¸é‡å¤â€œå¤åˆ¶ç²˜è´´â€ã€‚</p></li></ul><hr><p><strong>èµ„é‡‘æœåŠ¡</strong></p><p>è°ƒç”¨ <code>CapitalTradeOrderServiceImpl#record(...)</code> æ–¹æ³•ï¼Œ<strong>çº¢åŒ…</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmRecord"</span>, cancelMethod = <span class="string">"cancelRecord"</span>, transactionContextEditor = Compensable.DefaultTransactionContextEditor.class)</div><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line"><span class="comment">//            Thread.sleep(10000000L);</span></div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"capital try record called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// ç”Ÿæˆäº¤æ˜“è®¢å•</span></div><div class="line">   TradeOrder tradeOrder = <span class="keyword">new</span> TradeOrder(</div><div class="line">           tradeOrderDto.getSelfUserId(),</div><div class="line">           tradeOrderDto.getOppositeUserId(),</div><div class="line">           tradeOrderDto.getMerchantOrderNo(),</div><div class="line">           tradeOrderDto.getAmount()</div><div class="line">   );</div><div class="line">   tradeOrderRepository.insert(tradeOrder);</div><div class="line">   <span class="comment">// æ›´æ–°å‡å°‘ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢</span></div><div class="line">   CapitalAccount transferFromAccount = capitalAccountRepository.findByUserId(tradeOrderDto.getSelfUserId());</div><div class="line">   transferFromAccount.transferFrom(tradeOrderDto.getAmount());</div><div class="line">   capitalAccountRepository.save(transferFromAccount);</div><div class="line">   <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Compensable</p><ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ« Propagation.REQUIRED ( <strong>é»˜è®¤å€¼</strong> )</li><li>è®¾ç½® <code>confirmMethod</code> /  <code>cancelMethod</code> æ–¹æ³•å</li><li>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ç±» DefaultTransactionContextEditor ( <strong>é»˜è®¤å€¼</strong> )</li></ul></li><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</p></li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/TradeOrderRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>TradeOrderRepository#insert(...)</code></a> æ–¹æ³•ï¼Œç”Ÿæˆè®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„äº¤æ˜“è®¢å•ã€‚</p></li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/CapitalAccountRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CapitalAccountRepository#save(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°å‡å°‘ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚<strong>Try é˜¶æ®µé”å®šèµ„æºæ—¶ï¼Œä¸€å®šè¦å…ˆæ‰£ã€‚TCC æ˜¯æœ€ç»ˆäº‹åŠ¡ä¸€è‡´æ€§ï¼Œå¦‚æœå…ˆæ·»åŠ ï¼Œå¯èƒ½è¢«ä½¿ç”¨</strong>ã€‚</p></li></ul><h2>4.2 Confirm / Cancel é˜¶æ®µ</h2><p>å½“ Try æ“ä½œ<strong>å…¨éƒ¨</strong>æˆåŠŸæ—¶ï¼Œå‘èµ· Confirm æ“ä½œã€‚<br>å½“ Try æ“ä½œå­˜åœ¨<strong>ä»»åŠ¡</strong>å¤±è´¥æ—¶ï¼Œå‘èµ· Cancel æ“ä½œã€‚</p><h3>4.2.1 Confirm</h3><p><strong>å•†åŸæœåŠ¡</strong></p><p>è°ƒç”¨ <code>PaymentServiceImpl#confirmMakePayment(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜<strong>æˆåŠŸ</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmMakePayment</span><span class="params">(Order order, BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"order confirm make payment called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜æˆåŠŸ</span></div><div class="line">   order.confirm();</div><div class="line">   orderRepository.updateOrder(order);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><strong>ç”Ÿäº§ä»£ç è¯¥æ–¹æ³•éœ€è¦åŠ ä¸‹ @Transactional æ³¨è§£ï¼Œä¿è¯åŸå­æ€§</strong>ã€‚</p></li><li><p>è°ƒç”¨ <code>OrderRepository#updateOrder(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜æˆåŠŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Order.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.status = <span class="string">"CONFIRMED"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p><strong>èµ„é‡‘æœåŠ¡</strong></p><p>è°ƒç”¨ <code>CapitalTradeOrderServiceImpl#confirmRecord(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>æˆåŠŸ</strong>ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"capital confirm record called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æŸ¥è¯¢äº¤æ˜“è®°å½•</span></div><div class="line">   TradeOrder tradeOrder = tradeOrderRepository.findByMerchantOrderNo(tradeOrderDto.getMerchantOrderNo());</div><div class="line">   <span class="comment">// åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€ã€‚å› ä¸º `#record()` æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != tradeOrder &amp;&amp; <span class="string">"DRAFT"</span>.equals(tradeOrder.getStatus())) &#123;</div><div class="line">       <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“æˆåŠŸ</span></div><div class="line">       tradeOrder.confirm();</div><div class="line">       tradeOrderRepository.update(tradeOrder);</div><div class="line">       <span class="comment">// æ›´æ–°å¢åŠ å•†åº—æ‹¥æœ‰è€…ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢</span></div><div class="line">       CapitalAccount transferToAccount = capitalAccountRepository.findByUserId(tradeOrderDto.getOppositeUserId());</div><div class="line">       transferToAccount.transferTo(tradeOrderDto.getAmount());</div><div class="line">       capitalAccountRepository.save(transferToAccount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</p></li><li><p><strong>åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€</strong>ã€‚å› ä¸º <code>#record()</code> æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹ã€‚</p></li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/TradeOrderRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>TradeOrderRepository#update(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>æˆåŠŸ</strong>ã€‚</p></li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/CapitalAccountRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CapitalAccountRepository#save(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°å¢åŠ å•†åº—æ‹¥æœ‰è€…ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CapitalAccount.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transferTo</span><span class="params">(BigDecimal amount)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.balanceAmount = <span class="keyword">this</span>.balanceAmount.add(amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p><strong>çº¢åŒ…æœåŠ¡</strong></p><p>å’Œ<strong>èµ„æºæœåŠ¡</strong> 99.99% ç›¸åŒï¼Œä¸é‡å¤â€œå¤åˆ¶ç²˜è´´â€ã€‚</p><h3>4.2.2 Cancel</h3><p><strong>å•†åŸæœåŠ¡</strong></p><p>è°ƒç”¨ <code>PaymentServiceImpl#cancelMakePayment(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜<strong>å¤±è´¥</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelMakePayment</span><span class="params">(Order order, BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"order cancel make payment called.time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜å¤±è´¥</span></div><div class="line">   order.cancelPayment();</div><div class="line">   orderRepository.updateOrder(order);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><strong>ç”Ÿäº§ä»£ç è¯¥æ–¹æ³•éœ€è¦åŠ ä¸‹ @Transactional æ³¨è§£ï¼Œä¿è¯åŸå­æ€§</strong>ã€‚</p></li><li><p>è°ƒç”¨ <code>OrderRepository#updateOrder(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜å¤±è´¥ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Order.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelPayment</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.status = <span class="string">"PAY_FAILED"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p><strong>èµ„é‡‘æœåŠ¡</strong></p><p>è°ƒç”¨ <code>CapitalTradeOrderServiceImpl#cancelRecord(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>å¤±è´¥</strong>ã€‚</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"capital cancel record called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æŸ¥è¯¢äº¤æ˜“è®°å½•</span></div><div class="line">   TradeOrder tradeOrder = tradeOrderRepository.findByMerchantOrderNo(tradeOrderDto.getMerchantOrderNo());</div><div class="line">   <span class="comment">// åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€ã€‚å› ä¸º `#record()` æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != tradeOrder &amp;&amp; <span class="string">"DRAFT"</span>.equals(tradeOrder.getStatus())) &#123;</div><div class="line">       <span class="comment">// / æ›´æ–°è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“å¤±è´¥</span></div><div class="line">       tradeOrder.cancel();</div><div class="line">       tradeOrderRepository.update(tradeOrder);</div><div class="line">       <span class="comment">// æ›´æ–°å¢åŠ ( æ¢å¤ )ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢</span></div><div class="line">       CapitalAccount capitalAccount = capitalAccountRepository.findByUserId(tradeOrderDto.getSelfUserId());</div><div class="line">       capitalAccount.cancelTransfer(tradeOrderDto.getAmount());</div><div class="line">       capitalAccountRepository.save(capitalAccount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</p></li><li><p><strong>åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€</strong>ã€‚å› ä¸º <code>#record()</code> æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹ã€‚</p></li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/TradeOrderRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>TradeOrderRepository#update(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>å¤±è´¥</strong>ã€‚</p></li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/CapitalAccountRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CapitalAccountRepository#save(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°å¢åŠ ( æ¢å¤ )ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CapitalAccount.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelTransfer</span><span class="params">(BigDecimal amount)</span> </span>&#123;</div><div class="line">    transferTo(amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><hr><p><strong>çº¢åŒ…æœåŠ¡</strong></p><p>å’Œ<strong>èµ„æºæœåŠ¡</strong> 99.99% ç›¸åŒï¼Œä¸é‡å¤â€œå¤åˆ¶ç²˜è´´â€ã€‚</p><h1>666. å½©è›‹</h1><p>å˜¿å˜¿ï¼Œä»£ç åªæ˜¯çœ‹èµ·æ¥æ¯”è¾ƒå¤šï¼Œå®é™…ä¸å¤šã€‚</p><p>èš‚èšé‡‘èäº‘æä¾›äº†é“¶è¡Œé—´è½¬è´¦çš„ TCC è¿‡ç¨‹ä¾‹å­ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ï¼š<a href="https://www.cloud.alipay.com/docs/2/46886" rel="external nofollow noopener noreferrer" target="_blank">ã€Šèš‚èšé‡‘èäº‘ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼ˆDTSï¼‰ â€”â€” åœºæ™¯ä»‹ç»ã€‹</a>ã€‚</p><p>æœ¬ç³»åˆ— EOF ~æ’’èŠ±</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆï¼Œå¯å¥½ï¼Ÿï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-%E5%AE%9E
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/dubbo-support/</id>
    <published>2018-02-27T16:00:00.000Z</published>
    <updated>2017-09-26T18:05:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-dubbo-%E4%BB%A3%E7%90%86">2. Dubbo ä»£ç†</a><ul><li><a href="#21-javassistproxyfactory">2.1 JavassistProxyFactory</a><ul><li><a href="#211-javassist">2.1.1 Javassist</a></li><li><a href="#212-tccjavassistproxyfactory">2.1.2 TccJavassistProxyFactory</a></li><li><a href="#213-tccproxy--tccclassgenerator">2.1.3 TccProxy &amp; TccClassGenerator</a></li><li><a href="#214-%E9%85%8D%E7%BD%AE-dubbo-proxy">2.1.4 é…ç½® Dubbo Proxy</a></li></ul></li><li><a href="#22-jdkproxyfactory">2.2 JdkProxyFactory</a><ul><li><a href="#221-jdk-proxy">2.2.1 JDK Proxy</a></li><li><a href="#222-tccjdkproxyfactory">2.2.2 TccJdkProxyFactory</a></li><li><a href="#223-tccinvokerinvocationhandler">2.2.3 TccInvokerInvocationHandler</a></li><li><a href="#224-%E9%85%8D%E7%BD%AE-dubbo-proxy">2.2.4 é…ç½® Dubbo Proxy</a></li></ul></li></ul></li><li><a href="#3-dubbo-%E4%BA%8B%E5%8A%A1%E4%B8%8A%E4%B8%8B%E6%96%87%E7%BC%96%E8%BE%91%E5%99%A8">3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</a></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>Dubbo æ”¯æŒ</strong>ã€‚</p><p>TCC-Transaction é€šè¿‡ Dubbo <strong>éšå¼ä¼ å‚</strong>çš„åŠŸèƒ½ï¼Œé¿å…è‡ªå·±å¯¹ä¸šåŠ¡ä»£ç çš„å…¥ä¾µã€‚å¯èƒ½æœ‰åŒå­¦ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆè¯´ TCC-Transaction å¯¹ä¸šåŠ¡ä»£ç æœ‰ä¸€å®šçš„å…¥ä¾µæ€§ï¼Œä¸€èµ·æ¥çœ‹ä¸ªä»£ç ä¾‹å­ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä»£ç æ¥è‡ª <code>tcc-transaction-http-sample</code> ã€‚å£°æ˜è¿œç¨‹è°ƒç”¨æ—¶ï¼Œå¢åŠ äº†å‚æ•° TransactionContextã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå·±ä½¿ç”¨çš„è¿œç¨‹è°ƒç”¨æ¡†æ¶åšä¸€å®šå°è£…ï¼Œé¿å…å…¥ä¾µã€‚</li></ul><p>å¦‚ä¸‹æ˜¯å¯¹ Dubbo å°è£…äº†åï¼ŒDubbo Service æ–¹æ³•çš„ä¾‹å­ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä»£ç æ¥è‡ª <code>http-transaction-dubbo-sample</code> ã€‚æ˜¯ä¸æ˜¯ä¸éœ€è¦ä¼ å…¥å‚æ•° TransactionContextã€‚å½“ç„¶ï¼Œæ³¨è§£æ˜¯è‚¯å®šéœ€è¦çš„ï¼Œå¦åˆ™ TCC-Transaction æ€ä¹ˆçŸ¥é“å“ªäº›æ–¹æ³•æ˜¯ TCC æ–¹æ³•ã€‚</li></ul><p>TCC-Transaction é€šè¿‡ Dubbo Proxy çš„æœºåˆ¶ï¼Œå®ç° <code>@Compensable</code> å±æ€§è‡ªåŠ¨ç”Ÿæˆï¼Œå¢åŠ å¼€å‘ä½“éªŒï¼Œä¹Ÿé¿å…å‡ºé”™ã€‚</p><hr><p>Dubbo æ”¯æŒ( Maven é¡¹ç›® <code>tcc-transaction-dubbo</code> ) æ•´ä½“ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/01.png" alt=""></p><ul><li><code>proxy</code></li><li><code>context</code></li></ul><p>æˆ‘ä»¬åˆ†æˆä¸¤ä¸ªå°èŠ‚åˆ†äº«è¿™ä¸¤ä¸ªåŒ…å®ç°çš„åŠŸèƒ½ã€‚</p><p><strong>ç¬”è€…æš‚æ—¶å¯¹ Dubbo äº†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¦‚æœæœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜çƒ¦è¯·æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</strong></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1>2. Dubbo ä»£ç†</h1><p>å°† Dubbo Service æ–¹æ³•ä¸Šçš„<strong>æ³¨è§£</strong> <code>@Compensable</code> ï¼Œè‡ªåŠ¨ç”Ÿæˆæ³¨è§£çš„ <code>confirmMethod</code>ã€<code>cancelMethod</code>ã€<code>transactionContextEditor</code> å±æ€§ï¼Œä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Compensable</span>(propagation=Propagation.SUPPORTS, confirmMethod=<span class="string">"record"</span>, cancelMethod=<span class="string">"record"</span>, transactionContextEditor=DubboTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¯¥ä»£ç é€šè¿‡ Javassist ç”Ÿæˆçš„ Proxy ä»£ç çš„ç¤ºä¾‹ã€‚</li><li><code>propagation=Propagation.SUPPORTS</code> ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚<strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ REQUIRED</strong> ï¼Ÿå¦‚æœä½¿ç”¨ REQUIRED äº‹åŠ¡ä¼ æ’­çº§åˆ«ï¼Œäº‹åŠ¡æ¢å¤é‡è¯•æ—¶ï¼Œä¼šå‘èµ·æ–°çš„äº‹åŠ¡ã€‚</li><li><code>confirmMethod</code>ã€<code>cancelMethod</code> ä½¿ç”¨å’Œ try æ–¹æ³•<strong>ç›¸åŒæ–¹æ³•å</strong>ï¼š<strong>æœ¬åœ°å‘èµ·</strong>è¿œç¨‹æœåŠ¡ TCC confirm / cancel é˜¶æ®µï¼Œè°ƒç”¨ç›¸åŒæ–¹æ³•è¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚è¿œç¨‹æœåŠ¡çš„ CompensableTransactionInterceptor ä¼šæ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æ˜¯ CONFIRMING / CANCELLING æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•ã€‚<ul><li><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/02.png" alt=""></li></ul></li><li><code>transactionContextEditor=DubboTransactionContextEditor.class</code>ï¼Œä½¿ç”¨ Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ï¼Œåœ¨<a href="#">ã€Œ3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ã€</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul><p>Dubbo Service Proxy æä¾›äº†ä¸¤ç§ç”Ÿæˆæ–¹å¼ï¼š</p><ul><li>JavassistProxyFactoryï¼ŒåŸºäº Javassist æ–¹å¼</li><li>JdkProxyFactoryï¼ŒåŸºäº JDK åŠ¨æ€ä»£ç†æœºåˆ¶</li></ul><p>è¿™å—å†…å®¹æˆ‘ä»¬ä¸æ‹“å±•å¼€ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»å¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li><a href="http://daveztong.github.io/2016/11/23/Dubbo%E5%AD%A6%E4%B9%A0-%E7%90%86%E8%A7%A3%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboå­¦ä¹ -ç†è§£åŠ¨æ€ä»£ç†ã€‹</a></li><li><a href="http://javatar.iteye.com/blog/814426" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubbo ä½œè€…åšå®¢ â€”â€” åŠ¨æ€ä»£ç†æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”ã€‹</a></li><li><a href="http://blog.csdn.net/quhongwei_zhanqiu/article/details/41597261" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboåŸç†è§£æ-ä»£ç†ä¹‹Javassistç”Ÿæˆçš„ä¼ªä»£ç ã€‹</a></li><li><strong><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboçš„æœåŠ¡æš´éœ²ç»†èŠ‚ã€‹</a></strong></li></ul><p>Dubbo çš„ Invoker æ¨¡å‹æ˜¯éå¸¸å…³é”®çš„æ¦‚å¿µï¼Œçœ‹ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/03.jpeg" alt=""></p><h2>2.1 JavassistProxyFactory</h2><h3>2.1.1 Javassist</h3><blockquote><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»º Java å­—èŠ‚ç çš„ç±»åº“ã€‚é€šè¿‡ä½¿ç”¨Javassist å¯¹å­—èŠ‚ç æ“ä½œå¯ä»¥å®ç°åŠ¨æ€ â€AOPâ€ æ¡†æ¶ã€‚</p><p>å…³äº Java å­—èŠ‚ç çš„å¤„ç†ï¼Œç›®å‰æœ‰å¾ˆå¤šå·¥å…·ï¼Œå¦‚ bcelï¼Œasm( cglibåªæ˜¯å¯¹asmåˆå°è£…äº†ä¸€å±‚ )ã€‚ä¸è¿‡è¿™äº›éƒ½éœ€è¦ç›´æ¥è·Ÿè™šæ‹ŸæœºæŒ‡ä»¤æ‰“äº¤é“ã€‚</p><p>Javassist çš„ä¸»è¦çš„ä¼˜ç‚¹ï¼Œåœ¨äºç®€å•ï¼Œè€Œä¸”å¿«é€Ÿï¼Œç›´æ¥ä½¿ç”¨ Java ç¼–ç çš„å½¢å¼ï¼Œè€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„ï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚</p></blockquote><ul><li>ç²—ç•¥ä¸€çœ‹ï¼Œå¯èƒ½ä¸å¤Ÿå½¢è±¡ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡çœ‹ TCC-Transaction å¦‚ä½•ä½¿ç”¨æ¥ç†è§£ç†è§£ã€‚</li><li><a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­¦ä¹ ä¹‹javassistã€‹</a></li><li><a href="http://blog.csdn.net/qbg19881206/article/details/8993562" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavassist å­—èŠ‚ç æ“ä½œã€‹</a></li></ul><h3>2.1.2 TccJavassistProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</code>ï¼ŒTCC Javassist ä»£ç†å·¥å‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJavassistProxyFactory</span> <span class="keyword">extends</span> <span class="title">JavassistProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) TccProxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>é¡¹ç›®å¯åŠ¨æ—¶</strong>ï¼Œè°ƒç”¨ <code>TccJavassistProxyFactory#getProxy(...)</code> æ–¹æ³•ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxyã€‚</li><li><code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>ï¼ŒDubbo è°ƒç”¨å¤„ç†å™¨ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li></ul><h3>2.1.3 TccProxy &amp; TccClassGenerator</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy</code>ï¼ŒTCC Proxy å·¥å‚ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy ã€‚ç¬”è€…è®¤ä¸ºï¼ŒTccProxy æ”¹æˆ TccProxyFactory æ›´åˆé€‚ï¼ŒåŸå› åœ¨ä¸‹æ–‡ã€‚</p><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator</code>ï¼ŒTCC ç±»ä»£ç ç”Ÿæˆå™¨ï¼ŒåŸºäº Javassist å®ç°ã€‚</p><p><strong>ğŸ¦…æ¡ˆä¾‹</strong></p><p>ä¸€ä¸ª Dubbo Serviceï¼ŒTccProxy ä¼šåŠ¨æ€ç”Ÿæˆä¸¤ä¸ªç±»ï¼š</p><ul><li>Dubbo Service è°ƒç”¨ Proxy</li><li>Dubbo Service è°ƒç”¨ ProxyFactoryï¼Œç”Ÿæˆå¯¹åº”çš„ Dubbo Service Proxy</li></ul><p>ä¾‹å¦‚ Dubbo Service æ¥å£å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>ProxyFactory</strong> å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccProxy3</span> <span class="keyword">extends</span> <span class="title">TccProxy</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>TccProxy æä¾› <code>#newInstance(handler)</code> æ–¹æ³•ï¼Œåˆ›å»º Proxyï¼Œæ‰€ä»¥ç¬”è€…è®¤ä¸ºï¼ŒTccProxy æ”¹æˆ TccProxyFactory æ›´åˆé€‚ã€‚</li><li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li></ul><p>ç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy3</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span>, <span class="title">RedPacketTradeOrderService</span>, <span class="title">EchoService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method[] methods;</div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.handler = paramInvocationHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span>(propagation = Propagation.SUPPORTS, confirmMethod = <span class="string">"record"</span>, cancelMethod = <span class="string">"record"</span>, transactionContextEditor = DubboTransactionContextEditor.class)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (String) localObject;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Object $echo(Object paramObject) &#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramObject;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">1</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (Object) localObject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>com.alibaba.dubbo.rpc.service.EchoService</code>ï¼ŒDubbo Service å›å£°æœåŠ¡æ¥å£ï¼Œç”¨äºæœåŠ¡å¥åº·æ£€æŸ¥ï¼ŒDubbo Service é»˜è®¤è‡ªåŠ¨å®ç°è¯¥æ¥å£ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/EchoService.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li><li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li></ul><p><strong>ğŸ¦…å®ç°</strong></p><p>è°ƒç”¨ <code>TccProxy#getProxy(...)</code> æ–¹æ³•ï¼Œè·å¾— <strong>TCC Proxy å·¥å‚</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// ã€TccProxy.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccProxy <span class="title">getProxy</span><span class="params">(ClassLoader cl, Class&lt;?&gt;... ics)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="comment">// æ ¡éªŒæ¥å£è¶…è¿‡ä¸Šé™</span></div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (ics.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">  <span class="number">5</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// use interface class name list as key.</span></div><div class="line">  <span class="number">9</span>:     StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">10</span>:     <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">11</span>:         String itf = ic.getName();</div><div class="line"> <span class="number">12</span>:         <span class="comment">// æ ¡éªŒæ˜¯å¦ä¸ºæ¥å£</span></div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (!ic.isInterface()) &#123;</div><div class="line"> <span class="number">14</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(itf + <span class="string">" is not a interface."</span>);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:         <span class="comment">// åŠ è½½æ¥å£ç±»</span></div><div class="line"> <span class="number">17</span>:         Class&lt;?&gt; tmp = <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:             tmp = Class.forName(itf, <span class="keyword">false</span>, cl);</div><div class="line"> <span class="number">20</span>:         &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line"> <span class="number">21</span>:         &#125;</div><div class="line"> <span class="number">22</span>:         <span class="keyword">if</span> (tmp != ic) &#123; <span class="comment">// åŠ è½½æ¥å£ç±»å¤±è´¥</span></div><div class="line"> <span class="number">23</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ic + <span class="string">" is not visible from class loader"</span>);</div><div class="line"> <span class="number">24</span>:         &#125;</div><div class="line"> <span class="number">25</span>:         sb.append(itf).append(<span class="string">';'</span>);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>:     String key = sb.toString();</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:     <span class="comment">// get cache by class loader.</span></div><div class="line"> <span class="number">30</span>:     Map&lt;String, Object&gt; cache;</div><div class="line"> <span class="number">31</span>:     <span class="keyword">synchronized</span> (ProxyCacheMap) &#123;</div><div class="line"> <span class="number">32</span>:         cache = ProxyCacheMap.get(cl);</div><div class="line"> <span class="number">33</span>:         <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">34</span>:             cache = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line"> <span class="number">35</span>:             ProxyCacheMap.put(cl, cache);</div><div class="line"> <span class="number">36</span>:         &#125;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// è·å¾— TccProxy å·¥å‚</span></div><div class="line"> <span class="number">40</span>:     TccProxy proxy = <span class="keyword">null</span>;</div><div class="line"> <span class="number">41</span>:     <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"> <span class="number">42</span>:         <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">43</span>:             <span class="comment">// ä»ç¼“å­˜ä¸­è·å– TccProxy å·¥å‚</span></div><div class="line"> <span class="number">44</span>:             Object value = cache.get(key);</div><div class="line"> <span class="number">45</span>:             <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Reference&lt;?&gt;) &#123;</div><div class="line"> <span class="number">46</span>:                 proxy = (TccProxy) ((Reference&lt;?&gt;) value).get();</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">if</span> (proxy != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">48</span>:                     <span class="keyword">return</span> proxy;</div><div class="line"> <span class="number">49</span>:                 &#125;</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:             <span class="comment">// ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè®¾ç½®ç”Ÿæˆ TccProxy ä»£ç æ ‡è®°ã€‚åˆ›å»ºä¸­æ—¶ï¼Œå…¶ä»–åˆ›å»ºè¯·æ±‚ç­‰å¾…ï¼Œé¿å…å¹¶å‘ã€‚</span></div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (value == PendingGenerationMarker) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">54</span>:                     cache.wait();</div><div class="line"> <span class="number">55</span>:                 &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">58</span>:                 cache.put(key, PendingGenerationMarker);</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">60</span>:             &#125;</div><div class="line"> <span class="number">61</span>:         &#125;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">while</span> (<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="keyword">long</span> id = PROXY_CLASS_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">66</span>:     String pkg = <span class="keyword">null</span>;</div><div class="line"> <span class="number">67</span>:     TccClassGenerator ccp = <span class="keyword">null</span>; <span class="comment">// proxy class generator</span></div><div class="line"> <span class="number">68</span>:     TccClassGenerator ccm = <span class="keyword">null</span>; <span class="comment">// proxy factory class generator</span></div><div class="line"> <span class="number">69</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">70</span>:         <span class="comment">// åˆ›å»º Tcc class ä»£ç ç”Ÿæˆå™¨</span></div><div class="line"> <span class="number">71</span>:         ccp = TccClassGenerator.newInstance(cl);</div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:         Set&lt;String&gt; worked = <span class="keyword">new</span> HashSet&lt;String&gt;(); <span class="comment">// å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆã€‚keyï¼šæ–¹æ³•ç­¾å</span></div><div class="line"> <span class="number">74</span>:         List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;(); <span class="comment">// å·²å¤„ç†æ–¹æ³•é›†åˆã€‚</span></div><div class="line"> <span class="number">75</span>: </div><div class="line"> <span class="number">76</span>:         <span class="comment">// å¤„ç†æ¥å£</span></div><div class="line"> <span class="number">77</span>:         <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">78</span>:             <span class="comment">// é public æ¥å£ï¼Œä½¿ç”¨æ¥å£åŒ…å</span></div><div class="line"> <span class="number">79</span>:             <span class="keyword">if</span> (!Modifier.isPublic(ic.getModifiers())) &#123;</div><div class="line"> <span class="number">80</span>:                 String npkg = ic.getPackage().getName();</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">82</span>:                     pkg = npkg;</div><div class="line"> <span class="number">83</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">84</span>:                     <span class="keyword">if</span> (!pkg.equals(npkg)) &#123; <span class="comment">// å®ç°äº†ä¸¤ä¸ªé public çš„æ¥å£ï¼Œ</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"non-public interfaces from different packages"</span>);</div><div class="line"> <span class="number">86</span>:                     &#125;</div><div class="line"> <span class="number">87</span>:                 &#125;</div><div class="line"> <span class="number">88</span>:             &#125;</div><div class="line"> <span class="number">89</span>:             <span class="comment">// æ·»åŠ æ¥å£</span></div><div class="line"> <span class="number">90</span>:             ccp.addInterface(ic);</div><div class="line"> <span class="number">91</span>:             <span class="comment">// å¤„ç†æ¥å£æ–¹æ³•</span></div><div class="line"> <span class="number">92</span>:             <span class="keyword">for</span> (Method method : ic.getMethods()) &#123;</div><div class="line"> <span class="number">93</span>:                 <span class="comment">// æ·»åŠ æ–¹æ³•ç­¾ååˆ°å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆ</span></div><div class="line"> <span class="number">94</span>:                 String desc = ReflectUtils.getDesc(method);</div><div class="line"> <span class="number">95</span>:                 <span class="keyword">if</span> (worked.contains(desc)) &#123;</div><div class="line"> <span class="number">96</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">97</span>:                 &#125;</div><div class="line"> <span class="number">98</span>:                 worked.add(desc);</div><div class="line"> <span class="number">99</span>:                 <span class="comment">// ç”Ÿæˆæ¥å£æ–¹æ³•å®ç°ä»£ç </span></div><div class="line"><span class="number">100</span>:                 <span class="keyword">int</span> ix = methods.size();</div><div class="line"><span class="number">101</span>:                 Class&lt;?&gt; rt = method.getReturnType();</div><div class="line"><span class="number">102</span>:                 Class&lt;?&gt;[] pts = method.getParameterTypes();</div><div class="line"><span class="number">103</span>:                 StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="string">"Object[] args = new Object["</span>).append(pts.length).append(<span class="string">"];"</span>);</div><div class="line"><span class="number">104</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; pts.length; j++) &#123;</div><div class="line"><span class="number">105</span>:                     code.append(<span class="string">" args["</span>).append(j).append(<span class="string">"] = ($w)$"</span>).append(j + <span class="number">1</span>).append(<span class="string">";"</span>);</div><div class="line"><span class="number">106</span>:                 &#125;</div><div class="line"><span class="number">107</span>:                 code.append(<span class="string">" Object ret = handler.invoke(this, methods["</span>).append(ix).append(<span class="string">"], args);"</span>);</div><div class="line"><span class="number">108</span>:                 <span class="keyword">if</span> (!Void.TYPE.equals(rt)) &#123;</div><div class="line"><span class="number">109</span>:                     code.append(<span class="string">" return "</span>).append(asArgument(rt, <span class="string">"ret"</span>)).append(<span class="string">";"</span>);</div><div class="line"><span class="number">110</span>:                 &#125;</div><div class="line"><span class="number">111</span>:                 methods.add(method);</div><div class="line"><span class="number">112</span>:                 <span class="comment">// æ·»åŠ æ–¹æ³•</span></div><div class="line"><span class="number">113</span>:                 Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">114</span>:                 <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">115</span>:                     ccp.addMethod(<span class="keyword">true</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">116</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">117</span>:                     ccp.addMethod(<span class="keyword">false</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">118</span>:                 &#125;</div><div class="line"><span class="number">119</span>:             &#125;</div><div class="line"><span class="number">120</span>:         &#125;</div><div class="line"><span class="number">121</span>: </div><div class="line"><span class="number">122</span>:         <span class="comment">// è®¾ç½®åŒ…è·¯å¾„</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">124</span>:             pkg = PACKAGE_NAME;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>: </div><div class="line"><span class="number">127</span>:         <span class="comment">// create ProxyInstance class.</span></div><div class="line"><span class="number">128</span>:         <span class="comment">// è®¾ç½®ç±»å</span></div><div class="line"><span class="number">129</span>:         String pcn = pkg + <span class="string">".proxy"</span> + id;</div><div class="line"><span class="number">130</span>:         ccp.setClassName(pcn);</div><div class="line"><span class="number">131</span>:         <span class="comment">// æ·»åŠ é™æ€å±æ€§ methods</span></div><div class="line"><span class="number">132</span>:         ccp.addField(<span class="string">"public static java.lang.reflect.Method[] methods;"</span>);</div><div class="line"><span class="number">133</span>:         <span class="comment">// æ·»åŠ å±æ€§ handler</span></div><div class="line"><span class="number">134</span>:         ccp.addField(<span class="string">"private "</span> + InvocationHandler.class.getName() + <span class="string">" handler;"</span>);</div><div class="line"><span class="number">135</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° handler</span></div><div class="line"><span class="number">136</span>:         ccp.addConstructor(Modifier.PUBLIC, <span class="keyword">new</span> Class&lt;?&gt;[]&#123;InvocationHandler.class&#125;, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="string">"handler=$1;"</span>);</div><div class="line"><span class="number">137</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></div><div class="line"><span class="number">138</span>:         ccp.addDefaultConstructor();</div><div class="line"><span class="number">139</span>:         <span class="comment">// ç”Ÿæˆç±»</span></div><div class="line"><span class="number">140</span>:         Class&lt;?&gt; clazz = ccp.toClass();</div><div class="line"><span class="number">141</span>:         <span class="comment">// è®¾ç½®é™æ€å±æ€§ methods</span></div><div class="line"><span class="number">142</span>:         clazz.getField(<span class="string">"methods"</span>).set(<span class="keyword">null</span>, methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]));</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:         <span class="comment">// create TccProxy class.</span></div><div class="line"><span class="number">145</span>:         <span class="comment">// åˆ›å»º Tcc class ä»£ç ç”Ÿæˆå™¨</span></div><div class="line"><span class="number">146</span>:         ccm = TccClassGenerator.newInstance(cl);</div><div class="line"><span class="number">147</span>:         <span class="comment">// è®¾ç½®ç±»å</span></div><div class="line"><span class="number">148</span>:         String fcn = TccProxy.class.getName() + id;</div><div class="line"><span class="number">149</span>:         ccm.setClassName(fcn);</div><div class="line"><span class="number">150</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></div><div class="line"><span class="number">151</span>:         ccm.addDefaultConstructor();</div><div class="line"><span class="number">152</span>:         <span class="comment">// è®¾ç½®çˆ¶ç±»ä¸º TccProxy.class</span></div><div class="line"><span class="number">153</span>:         ccm.setSuperClass(TccProxy.class);</div><div class="line"><span class="number">154</span>:         <span class="comment">// æ·»åŠ æ–¹æ³• #newInstance(handler)</span></div><div class="line"><span class="number">155</span>:         ccm.addMethod(<span class="string">"public Object newInstance("</span> + InvocationHandler.class.getName() + <span class="string">" h)&#123; return new "</span> + pcn + <span class="string">"($1); &#125;"</span>);</div><div class="line"><span class="number">156</span>:         <span class="comment">// ç”Ÿæˆç±»</span></div><div class="line"><span class="number">157</span>:         Class&lt;?&gt; pc = ccm.toClass();</div><div class="line"><span class="number">158</span>:         <span class="comment">// åˆ›å»º TccProxy å¯¹è±¡</span></div><div class="line"><span class="number">159</span>:         proxy = (TccProxy) pc.newInstance();</div><div class="line"><span class="number">160</span>:     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">161</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">162</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">163</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">164</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">165</span>:         <span class="comment">// release TccClassGenerator</span></div><div class="line"><span class="number">166</span>:         <span class="keyword">if</span> (ccp != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">167</span>:             ccp.release();</div><div class="line"><span class="number">168</span>:         &#125;</div><div class="line"><span class="number">169</span>:         <span class="keyword">if</span> (ccm != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">170</span>:             ccm.release();</div><div class="line"><span class="number">171</span>:         &#125;</div><div class="line"><span class="number">172</span>:         <span class="comment">// å”¤é†’ç¼“å­˜ wait</span></div><div class="line"><span class="number">173</span>:         <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"><span class="number">174</span>:             <span class="keyword">if</span> (proxy == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">175</span>:                 cache.remove(key);</div><div class="line"><span class="number">176</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">177</span>:                 cache.put(key, <span class="keyword">new</span> WeakReference&lt;TccProxy&gt;(proxy));</div><div class="line"><span class="number">178</span>:             &#125;</div><div class="line"><span class="number">179</span>:             cache.notifyAll();</div><div class="line"><span class="number">180</span>:         &#125;</div><div class="line"><span class="number">181</span>:     &#125;</div><div class="line"><span class="number">182</span>:     <span class="keyword">return</span> proxy;</div><div class="line"><span class="number">183</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 3 è‡³ 7 è¡Œ ï¼šæ ¡éªŒæ¥å£è¶…è¿‡ä¸Šé™ã€‚</p></li><li><p>ç¬¬ 8 è‡³ 27 è¡Œ ï¼šä½¿ç”¨æ¥å£é›†åˆç±»åä»¥ <code>;</code> åˆ†éš”æ‹¼æ¥ï¼Œä½œä¸º Proxy çš„å”¯ä¸€æ ‡è¯†ã€‚ä¾‹å¦‚ ï¼š<code>key=org.mengyun.tcctransaction.sample.dubbo.redpacket.api.RedPacketAccountService;com.alibaba.dubbo.rpc.service.EchoService;</code> ã€‚</p></li><li><p>ç¬¬ 29 è‡³ 37 è¡Œ ï¼šè·å¾— Proxy å¯¹åº”çš„ ClassLoaderã€‚è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹é™æ€å±æ€§ <code>ProxyCacheMap</code> çš„å®šä¹‰ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Proxy å¯¹è±¡ç¼“å­˜</span></div><div class="line"><span class="comment">* key ï¼šClassLoader</span></div><div class="line"><span class="comment">* value.key ï¼šTcc Proxy æ ‡è¯†ã€‚ä½¿ç”¨ Tcc Proxy å®ç°æ¥å£åæ‹¼æ¥</span></div><div class="line"><span class="comment">* value.value ï¼šTcc Proxy å·¥å‚å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, Map&lt;String, Object&gt;&gt; ProxyCacheMap = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, Map&lt;String, Object&gt;&gt;();</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ WeakHashMapï¼Œå½“ ClassLoader è¢«å›æ”¶æ—¶ï¼Œå…¶å¯¹åº”çš„å€¼ä¸€èµ·è¢«ç§»é™¤ã€‚</li><li><a href="http://blog.csdn.net/yangzl2008/article/details/6980709" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠWeakHashMapå’ŒHashMapçš„åŒºåˆ«ã€‹</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3311092.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava é›†åˆç³»åˆ—13ä¹‹ WeakHashMapè¯¦ç»†ä»‹ç»(æºç è§£æ)å’Œä½¿ç”¨ç¤ºä¾‹ã€‹</a></li></ul></li><li><p>ç¬¬ 39 è‡³ 63 è¡Œ ï¼šä¸€ç›´è·å¾— <strong>TCC Proxy å·¥å‚</strong>ç›´åˆ°æˆåŠŸã€‚</p><ul><li>ç¬¬ 43 è‡³ 50 è¡Œ ï¼šä»<strong>ç¼“å­˜</strong>ä¸­è·å– TCC Proxy å·¥å‚ã€‚</li><li>ç¬¬ 51 è‡³ 60 è¡Œ ï¼šè‹¥ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè®¾ç½®<strong>æ­£åœ¨ç”Ÿæˆ TccProxy ä»£ç æ ‡è®°</strong>ã€‚åˆ›å»ºä¸­æ—¶ï¼Œå…¶ä»–åˆ›å»ºè¯·æ±‚ç­‰å¾…ï¼Œé¿å…å¹¶å‘ã€‚</li></ul></li><li><p>ç¬¬ 65 è¡Œ ï¼š<code>PROXY_CLASS_COUNTER</code>ï¼ŒProxy Class è®¡æ•°ï¼Œç”¨äºç”Ÿæˆ Proxy ç±»åè‡ªå¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong PROXY_CLASS_COUNTER = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 66 è‡³ 67 è¡Œ</p><ul><li><code>ccm</code>ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>ProxyFactory</strong> çš„ä»£ç ç”Ÿæˆå™¨</li><li><code>ccp</code>ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> çš„ä»£ç ç”Ÿæˆå™¨</li></ul></li><li><p><strong>ç¬¬ 70 è‡³ 142 è¡Œ ï¼šç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy çš„ä»£ç </strong>ã€‚</p><ul><li><p>ç¬¬ 70 è‡³ 71 è¡Œ ï¼šè°ƒç”¨ <code>TccClassGenerator#newInstance(loader)</code> æ–¹æ³•ï¼Œ åˆ›å»ºç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> çš„ä»£ç ç”Ÿæˆå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TccClassGenerator.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TccClassGenerator</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * CtClass hash é›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šç±»å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ClassPool mPool;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccClassGenerator <span class="title">newInstance</span><span class="params">(ClassLoader loader)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TccClassGenerator(getClassPool(loader));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">TccClassGenerator</span><span class="params">(ClassPool pool)</span> </span>&#123;</div><div class="line">        mPool = pool;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>ClassPool</strong> æ˜¯ä¸€ä¸ª CtClass å¯¹è±¡çš„ hash è¡¨ï¼Œç±»ååšä¸º key ã€‚ClassPool çš„ <code>#get(key)</code> æœç´¢ hash è¡¨æ‰¾åˆ°ä¸æŒ‡å®š key å…³è”çš„ CtClass å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° CtClass å¯¹è±¡ï¼Œ<code>#get(key)</code> è¯»ä¸€ä¸ªç±»æ–‡ä»¶æ„å»ºæ–°çš„ CtClass å¯¹è±¡ï¼Œå®ƒæ˜¯è¢«è®°å½•åœ¨ hash è¡¨ä¸­ç„¶åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</li></ul></li><li><p>ç¬¬ 76 è‡³ 120 è¡Œï¼Œå¤„ç†æ¥å£ã€‚</p><ul><li><p>ç¬¬ 79 è‡³ 88 è¡Œï¼Œç”Ÿæˆç±»çš„åŒ…åã€‚</p></li><li><p>ç¬¬ 89 è‡³ 90 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addInterface(cl)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆç±»çš„æ¥å£( <strong>Dubbo Service æ¥å£</strong> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„æ¥å£é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; mInterfaces;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> addInterface(cl.getName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(String cn)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mInterfaces == <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mInterfaces.add(cn);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 93 è‡³ 98 è¡Œï¼Œæ·»åŠ æ–¹æ³•ç­¾ååˆ°å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆã€‚å¤šä¸ªæ¥å£å¯èƒ½å­˜åœ¨ç›¸åŒçš„æ¥å£æ–¹æ³•ï¼Œè·³è¿‡ç›¸åŒçš„æ–¹æ³•ï¼Œé¿å…å†²çªã€‚</p></li><li><p>ç¬¬ 99 è‡³ 110 è¡Œï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨å®ç°ä»£ç ã€‚æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">  Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">  arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">  Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">  <span class="keyword">return</span> (String)localObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/04.png" alt=""></li></ul></li><li><p>ç¬¬ 112 è‡³ 118 è¡Œ ï¼šè°ƒç”¨ <code>TccClassGenerator#addMethod(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆçš„æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mMethods;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¸¦ <span class="doctag">@Compensable</span> æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; compensableMethods = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(<span class="keyword">boolean</span> isCompensableMethod, String name, <span class="keyword">int</span> mod, Class&lt;?&gt; rt, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥æ–¹æ³•</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(ReflectUtils.getName(rt)).append(<span class="string">' '</span>).append(name);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">// æ˜¯å¦æœ‰ @Compensable æ³¨è§£</span></div><div class="line">   <span class="keyword">if</span> (isCompensableMethod) &#123;</div><div class="line">       compensableMethods.add(sb.toString());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> addMethod(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mMethods == <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mMethods.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul></li><li><p>ç¬¬ 122 è‡³ 130 è¡Œï¼Œç”Ÿæˆç±»å( ä¾‹å¦‚ï¼Œ<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.proxy3</code> )ï¼Œå¹¶è°ƒç”¨ <code>TccClassGenerator#setClassName(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç±»åã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„ç±»å</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mClassName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setClassName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">   mClassName = name;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 131 è‡³ 134 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addField(...)</code> æ–¹æ³•ï¼Œæ·»åŠ <strong>é™æ€</strong>å±æ€§ <code>methods</code> ( Dubbo Service æ–¹æ³•é›†åˆ )å’Œå±æ€§ <code>handler</code> ( Dubbo InvocationHandler )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„å±æ€§é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mFields;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addField</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mFields == <span class="keyword">null</span>) &#123;</div><div class="line">       mFields = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mFields.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 135 è‡³ 136 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addConstructor(...)</code> æ–¹æ³•ï¼Œæ·»åŠ å‚æ•°ä¸º <code>handler</code> çš„æ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„éç©ºæ„é€ æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mConstructors;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(<span class="keyword">int</span> mod, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ„é€ æ–¹æ³•ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(SIMPLE_NAME_TAG);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> addConstructor(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 137 è‡³ 138 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addDefaultConstructor()</code> æ–¹æ³•ï¼Œæ·»åŠ é»˜è®¤ç©ºæ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* é»˜è®¤ç©ºæ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDefaultConstructor = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addDefaultConstructor</span><span class="params">()</span> </span>&#123;</div><div class="line">   mDefaultConstructor = <span class="keyword">true</span>;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 139 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#toClass()</code> æ–¹æ³•ï¼Œ<strong>ç”Ÿæˆç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> Class&lt;?&gt; toClass() &#123;</div><div class="line"> <span class="number">2</span>:    <span class="comment">// mCtc éç©ºæ—¶ï¼Œè¿›è¡Œé‡Šæ”¾ï¼›ä¸‹é¢ä¼šè¿›è¡Œåˆ›å»º mCtc</span></div><div class="line"> <span class="number">3</span>:    <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:        mCtc.detach();</div><div class="line"> <span class="number">5</span>:    &#125;</div><div class="line"> <span class="number">6</span>:    <span class="keyword">long</span> id = CLASS_NAME_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">7</span>:    <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:        CtClass ctcs = mSuperClass == <span class="keyword">null</span> ? <span class="keyword">null</span> : mPool.get(mSuperClass);</div><div class="line"> <span class="number">9</span>:        <span class="keyword">if</span> (mClassName == <span class="keyword">null</span>) &#123; <span class="comment">// ç±»å</span></div><div class="line"><span class="number">10</span>:            mClassName = (mSuperClass == <span class="keyword">null</span> || javassist.Modifier.isPublic(ctcs.getModifiers())</div><div class="line"><span class="number">11</span>:                    ? TccClassGenerator.class.getName() : mSuperClass + <span class="string">"$sc"</span>) + id;</div><div class="line"><span class="number">12</span>:        &#125;</div><div class="line"><span class="number">13</span>:        <span class="comment">// åˆ›å»º mCtc</span></div><div class="line"><span class="number">14</span>:        mCtc = mPool.makeClass(mClassName);</div><div class="line"><span class="number">15</span>:        <span class="keyword">if</span> (mSuperClass != <span class="keyword">null</span>) &#123; <span class="comment">// ç»§æ‰¿ç±»</span></div><div class="line"><span class="number">16</span>:            mCtc.setSuperclass(ctcs);</div><div class="line"><span class="number">17</span>:        &#125;</div><div class="line"><span class="number">18</span>:        mCtc.addInterface(mPool.get(DC.class.getName())); <span class="comment">// add dynamic class tag.</span></div><div class="line"><span class="number">19</span>:        <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123; <span class="comment">// å®ç°æ¥å£é›†åˆ</span></div><div class="line"><span class="number">20</span>:            <span class="keyword">for</span> (String cl : mInterfaces) &#123;</div><div class="line"><span class="number">21</span>:                mCtc.addInterface(mPool.get(cl));</div><div class="line"><span class="number">22</span>:            &#125;</div><div class="line"><span class="number">23</span>:        &#125;</div><div class="line"><span class="number">24</span>:        <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123; <span class="comment">// å±æ€§é›†åˆ</span></div><div class="line"><span class="number">25</span>:            <span class="keyword">for</span> (String code : mFields) &#123;</div><div class="line"><span class="number">26</span>:                mCtc.addField(CtField.make(code, mCtc));</div><div class="line"><span class="number">27</span>:            &#125;</div><div class="line"><span class="number">28</span>:        &#125;</div><div class="line"><span class="number">29</span>:        <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123; <span class="comment">// æ–¹æ³•é›†åˆ</span></div><div class="line"><span class="number">30</span>:            <span class="keyword">for</span> (String code : mMethods) &#123;</div><div class="line"><span class="number">31</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">32</span>:                    mCtc.addMethod(CtNewMethod.copy(getCtMethod(mCopyMethods.get(code.substring(<span class="number">1</span>))), code.substring(<span class="number">1</span>, code.indexOf(<span class="string">'('</span>)), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">33</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">34</span>:                    CtMethod ctMethod = CtNewMethod.make(code, mCtc);</div><div class="line"><span class="number">35</span>:                    <span class="keyword">if</span> (compensableMethods.contains(code)) &#123;</div><div class="line"><span class="number">36</span>:                        <span class="comment">// è®¾ç½® @Compensable å±æ€§</span></div><div class="line"><span class="number">37</span>:                        ConstPool constpool = mCtc.getClassFile().getConstPool();</div><div class="line"><span class="number">38</span>:                        AnnotationsAttribute attr = <span class="keyword">new</span> AnnotationsAttribute(constpool, AnnotationsAttribute.visibleTag);</div><div class="line"><span class="number">39</span>:                        Annotation annot = <span class="keyword">new</span> Annotation(<span class="string">"org.mengyun.tcctransaction.api.Compensable"</span>, constpool);</div><div class="line"><span class="number">40</span>:                        EnumMemberValue enumMemberValue = <span class="keyword">new</span> EnumMemberValue(constpool);</div><div class="line"><span class="number">41</span>:                        enumMemberValue.setType(<span class="string">"org.mengyun.tcctransaction.api.Propagation"</span>);</div><div class="line"><span class="number">42</span>:                        enumMemberValue.setValue(<span class="string">"SUPPORTS"</span>);</div><div class="line"><span class="number">43</span>:                        annot.addMemberValue(<span class="string">"propagation"</span>, enumMemberValue);</div><div class="line"><span class="number">44</span>:                        annot.addMemberValue(<span class="string">"confirmMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">45</span>:                        annot.addMemberValue(<span class="string">"cancelMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">46</span>:                        ClassMemberValue classMemberValue = <span class="keyword">new</span> ClassMemberValue(<span class="string">"org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor"</span>, constpool);</div><div class="line"><span class="number">47</span>:                        annot.addMemberValue(<span class="string">"transactionContextEditor"</span>, classMemberValue);</div><div class="line"><span class="number">48</span>:                        attr.addAnnotation(annot);</div><div class="line"><span class="number">49</span>:                        ctMethod.getMethodInfo().addAttribute(attr);</div><div class="line"><span class="number">50</span>:                    &#125;</div><div class="line"><span class="number">51</span>:                    mCtc.addMethod(ctMethod);</div><div class="line"><span class="number">52</span>:                &#125;</div><div class="line"><span class="number">53</span>:            &#125;</div><div class="line"><span class="number">54</span>:        &#125;</div><div class="line"><span class="number">55</span>:        <span class="keyword">if</span> (mDefaultConstructor) &#123; <span class="comment">// ç©ºå‚æ•°æ„é€ æ–¹æ³•</span></div><div class="line"><span class="number">56</span>:            mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));</div><div class="line"><span class="number">57</span>:        &#125;</div><div class="line"><span class="number">58</span>:        <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123; <span class="comment">// å¸¦å‚æ•°æ„é€ æ–¹æ³•</span></div><div class="line"><span class="number">59</span>:            <span class="keyword">for</span> (String code : mConstructors) &#123;</div><div class="line"><span class="number">60</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">61</span>:                    mCtc.addConstructor(CtNewConstructor.copy(getCtConstructor(mCopyConstructors.get(code.substring(<span class="number">1</span>))), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">62</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">63</span>:                    String[] sn = mCtc.getSimpleName().split(<span class="string">"\\$+"</span>); <span class="comment">// inner class name include $.</span></div><div class="line"><span class="number">64</span>:                    mCtc.addConstructor(CtNewConstructor.make(code.replaceFirst(SIMPLE_NAME_TAG, sn[sn.length - <span class="number">1</span>]), mCtc));</div><div class="line"><span class="number">65</span>:                &#125;</div><div class="line"><span class="number">66</span>:            &#125;</div><div class="line"><span class="number">67</span>:        &#125;</div><div class="line"><span class="number">68</span>: <span class="comment">//            mCtc.debugWriteFile("/Users/yunai/test/" + mCtc.getSimpleName().replaceAll(".", "/") + ".class");</span></div><div class="line"><span class="number">69</span>:        <span class="comment">// ç”Ÿæˆ</span></div><div class="line"><span class="number">70</span>:        <span class="keyword">return</span> mCtc.toClass();</div><div class="line"><span class="number">71</span>:    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">72</span>:        <span class="keyword">throw</span> e;</div><div class="line"><span class="number">73</span>:    &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line"><span class="number">74</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">75</span>:    &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</div><div class="line"><span class="number">76</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">77</span>:    &#125;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>åŸºäº Javassist ç”Ÿæˆç±»ã€‚è¿™é‡Œä¸åšæ‹“å±•è§£é‡Šï¼Œé…åˆ<a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­¦ä¹ ä¹‹javassistã€‹</a>ä¸€èµ·ç†è§£ã€‚</li><li>ç¬¬ 18 è¡Œï¼Œæ·»åŠ  <code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li><li>ç¬¬ 34 è‡³ 50 è¡Œï¼Œè®¾ç½® @Compensable é»˜è®¤å±æ€§ã€‚</li></ul></li><li><p>ç¬¬ 141 è‡³ 142 è¡Œï¼Œè®¾ç½® Dubbo Service æ–¹æ³•é›†åˆè®¾ç½®åˆ°é™æ€å±æ€§ <code>methods</code> ä¸Šã€‚</p></li></ul></li><li><p><strong>ç¬¬ 144 è‡³ 157 è¡Œï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy å·¥å‚çš„ä»£ç </strong>ã€‚</p><ul><li><p>ç¬¬ 146 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#newInstance(loader)</code> æ–¹æ³•ï¼Œ åˆ›å»ºç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy å·¥å‚</strong> çš„ä»£ç ç”Ÿæˆå™¨ã€‚</p></li><li><p>ç¬¬ 147 è‡³ 149 è¡Œï¼Œç”Ÿæˆç±»å( ä¾‹å¦‚ï¼Œ<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy3</code> )ï¼Œå¹¶è°ƒç”¨ <code>TccClassGenerator#setClassName(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç±»åã€‚</p></li><li><p>ç¬¬ 150 è‡³ 151 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addDefaultConstructor()</code> æ–¹æ³•ï¼Œæ·»åŠ é»˜è®¤ç©ºæ„é€ æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 152 è‡³ 153 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#mSuperClass()</code> æ–¹æ³•ï¼Œè®¾ç½®ç»§æ‰¿çˆ¶ç±» <strong><code>TccProxy</code></strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„çˆ¶ç±»åå­—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mSuperClass;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setSuperClass</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   mSuperClass = cl.getName();</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 154 è‡³ 155 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addInterface(cl)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆ Proxy å®ç°ä»£ç çš„æ–¹æ³•ã€‚ä»£ç æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li><li><p>ç¬¬ 156 è‡³ 157 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#toClass()</code> æ–¹æ³•ï¼Œ<strong>ç”Ÿæˆç±»</strong>ã€‚</p></li></ul></li><li><p>ç¬¬ 159 è¡Œï¼Œè°ƒç”¨ <code>TccProxy#newInstance()</code> æ–¹æ³•ï¼Œåˆ›å»º Proxy ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with default handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> newInstance(THROW_UNSUPPORTED_INVOKER);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with special handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler handler)</span></span>;</div></pre></td></tr></table></figure></p><ul><li><code>#newInstance(handler)</code>ï¼ŒæŠ½è±¡æ–¹æ³•ï¼Œä¸Šé¢ç¬¬ 154 è‡³ 155 è¡Œç”Ÿæˆã€‚TccJavassistProxyFactory è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾— Proxy ã€‚</li></ul></li><li><p>ç¬¬ 165 è‡³ 171 è¡Œï¼Œé‡Šæ”¾ TccClassGenerator ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line">       mCtc.detach();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123;</div><div class="line">       mFields.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyConstructors.clear();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 172 è‡³ 180 è¡Œï¼Œè®¾ç½® Proxy å·¥å‚ç¼“å­˜ï¼Œå¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚</p></li></ul><p>**psï¼š**ä»£ç æ¯”è¾ƒå¤šï¼Œæ”¶è·ä¼šæ¯”è¾ƒå¤šï¼Œç®—æ˜¯ Javassist å®æˆ˜æ¡ˆä¾‹äº†ã€‚TCC-Transaction ä½œè€…åœ¨å®ç°ä¸Šè¿°ç±»ï¼Œå¯èƒ½å‚è€ƒäº† Dubbo è‡ªå¸¦çš„å®ç°ï¼š</p><ul><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Proxy.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Proxy</code></a></li><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.ClassGenerator</code></a></li><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Wrapper.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Wrapper</code></a></li></ul><h3>2.1.4 é…ç½® Dubbo Proxy</h3><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJavassist=org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</div><div class="line"></div><div class="line">// tcc-transaction-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJavassist"</span>/&gt;</span></div></pre></td></tr></table></figure></p><p>ç›®å‰ Maven é¡¹ç›® <code>tcc-transaction-dubbo</code> å·²ç»<strong>é»˜è®¤</strong>é…ç½®ï¼Œå¼•å…¥å³å¯ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/05.png" alt=""></p><h2>2.2 JdkProxyFactory</h2><h3>2.2.1 JDK Proxy</h3><p><a href="http://blog.csdn.net/jiankunking/article/details/52143504#" rel="external nofollow noopener noreferrer" target="_blank">ã€Š Java JDK åŠ¨æ€ä»£ç†ï¼ˆAOPï¼‰ä½¿ç”¨åŠå®ç°åŸç†åˆ†æã€‹</a></p><h3>2.2.2 TccJdkProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jd.TccJdkProxyFactory</code>ï¼ŒTCC JDK ä»£ç†å·¥å‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJdkProxyFactory</span> <span class="keyword">extends</span> <span class="title">JdkProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        T proxy = (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> TccInvokerInvocationHandler(proxy, invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>é¡¹ç›®å¯åŠ¨æ—¶</strong>ï¼Œè°ƒç”¨ <code>TccJavassistProxyFactory#getProxy(...)</code> æ–¹æ³•ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxyã€‚</li><li><strong>ç¬¬ä¸€æ¬¡</strong>è°ƒç”¨ <code>Proxy#newProxyInstance(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºè°ƒç”¨ Dubbo Service æœåŠ¡çš„ Proxyã€‚<code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>ï¼ŒDubbo è°ƒç”¨å¤„ç†å™¨ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li><li><strong>ç¬¬äºŒæ¬¡</strong>è°ƒç”¨ <code>Proxy#newProxyInstance(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå¯¹è°ƒç”¨ Dubbo Service çš„ Proxy çš„ Proxyã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤å±‚ Proxyï¼Ÿç­”æ¡ˆåœ¨ä¸‹èŠ‚ TccInvokerInvocationHandler ã€‚</li></ul><h3>2.2.3 TccInvokerInvocationHandler</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jdk.TccInvokerInvocationHandler</code>ï¼ŒTCC è°ƒç”¨å¤„ç†å™¨ï¼Œåœ¨è°ƒç”¨ Dubbo Service æœåŠ¡æ—¶ï¼Œä½¿ç”¨ ResourceCoordinatorInterceptor æ‹¦æˆªå¤„ç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccInvokerInvocationHandler</span> <span class="keyword">extends</span> <span class="title">InvokerInvocationHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * proxy</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> Object target;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="title">TccInvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">super</span>(handler);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="keyword">public</span> &lt;T&gt; TccInvokerInvocationHandler(T target, Invoker&lt;T&gt; invoker) &#123;</div><div class="line"><span class="number">13</span>:         <span class="keyword">super</span>(invoker);</div><div class="line"><span class="number">14</span>:         <span class="keyword">this</span>.target = target;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"><span class="number">18</span>:         Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:             <span class="comment">// è®¾ç½® @Compensable å±æ€§</span></div><div class="line"><span class="number">21</span>:             <span class="keyword">if</span> (StringUtils.isEmpty(compensable.confirmMethod())) &#123;</div><div class="line"><span class="number">22</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"confirmMethod"</span>, method.getName());</div><div class="line"><span class="number">23</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"cancelMethod"</span>, method.getName());</div><div class="line"><span class="number">24</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"transactionContextEditor"</span>, DubboTransactionContextEditor.class);</div><div class="line"><span class="number">25</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"propagation"</span>, Propagation.SUPPORTS);</div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:             <span class="comment">// ç”Ÿæˆåˆ‡é¢</span></div><div class="line"><span class="number">28</span>:             ProceedingJoinPoint pjp = <span class="keyword">new</span> MethodProceedingJoinPoint(proxy, target, method, args);</div><div class="line"><span class="number">29</span>:             <span class="comment">// æ‰§è¡Œ</span></div><div class="line"><span class="number">30</span>:             <span class="keyword">return</span> FactoryBuilder.factoryOf(ResourceCoordinatorAspect.class).getInstance().interceptTransactionContextMethod(pjp);</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">return</span> <span class="keyword">super</span>.invoke(target, method, args);</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 18 è‡³ 26 è¡Œï¼Œè®¾ç½®å¸¦æœ‰ @Compensable å±æ€§çš„é»˜è®¤å±æ€§ã€‚</p></li><li><p>ç¬¬ 28 è¡Œï¼Œç”Ÿæˆæ–¹æ³•åˆ‡é¢ <code>org.mengyun.tcctransaction.dubbo.proxy.jdk.MethodProceedingJoinPoint</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodProceedingJoinPoint</span> <span class="keyword">implements</span> <span class="title">ProceedingJoinPoint</span>, <span class="title">JoinPoint</span>.<span class="title">StaticPart</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»£ç†å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object proxy;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›®æ ‡å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object target;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Method method;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// Use reflection to invoke the method.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ReflectionUtils.makeAccessible(method);</div><div class="line">            <span class="keyword">return</span> method.invoke(target, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">            <span class="comment">// Invoked method threw a checked exception.</span></div><div class="line">            <span class="comment">// We must rethrow it. The client won't see the interceptor.</span></div><div class="line">            <span class="keyword">throw</span> ex.getTargetException();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Tried calling method ["</span> +</div><div class="line">                    method + <span class="string">"] on target ["</span> + target + <span class="string">"] failed"</span>, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Could not access method ["</span> + method + <span class="string">"]"</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//        throw new UnsupportedOperationException(); // TODO èŠ‹è‰¿ï¼šç–‘é—®</span></div><div class="line">        <span class="keyword">return</span> proceed();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ä¸é‡è¦çš„æ–¹æ³•å’Œå¯¹è±¡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¯¥ç±»å‚è€ƒ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-aop/src/main/java/org/springframework/aop/aspectj/MethodInvocationProceedingJoinPoint.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint</code></a> å®ç°ã€‚</li><li>TODOã€1ã€‘ proxy å’Œ target æ˜¯å¦ä¿ç•™ä¸€ä¸ªå³å¯ï¼Ÿ</li><li>åœ¨åˆ‡é¢å¤„ç†å®Œæˆåï¼Œè°ƒç”¨ <code>#proceed(...)</code> æ–¹æ³•ï¼Œè¿›è¡Œè¿œç¨‹ Dubbo Service æœåŠ¡è°ƒç”¨ã€‚</li><li>TODOã€2ã€‘<code>#proceed(objects)</code> æŠ›å‡º throw new UnsupportedOperationException();ã€‚éœ€è¦è·Ÿä½œè€…ç¡®è®¤ä¸‹ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>ResourceCoordinatorAspect#interceptTransactionContextMethod(...)</code> æ–¹æ³•ï¼Œå¯¹æ–¹æ³•åˆ‡é¢æ‹¦æˆªå¤„ç†ã€‚<strong>ä¸ºä»€ä¹ˆæ— éœ€è°ƒç”¨ CompensableTransactionAspect åˆ‡é¢</strong>ï¼Ÿå› ä¸ºä¼ æ’­çº§åˆ«ä¸º Propagation.SUPPORTSï¼Œä¸ä¼šå‘èµ·äº‹åŠ¡ã€‚</p></li></ul><h3>2.2.4 é…ç½® Dubbo Proxy</h3><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJdk=org.mengyun.tcctransaction.dubbo.proxy.jdk.TccJdkProxyFactory</div><div class="line"></div><div class="line">// appcontext-service-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span> <span class="attr">id</span>=<span class="string">"captialTradeOrderService"</span></span></div><div class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">"org.mengyun.tcctransaction.sample.dubbo.capital.api.CapitalTradeOrderService"</span> <span class="attr">timeout</span>=<span class="string">"5000"</span>/&gt;</span></div></pre></td></tr></table></figure></p><ul><li>ProxyFactory çš„ <code>tccJdk</code> åœ¨ Maven é¡¹ <code>tcc-transaction-dubbo</code> å·²ç»å£°æ˜ã€‚</li><li>å£°æ˜ <code>dubbo:provider</code> çš„ <code>proxy=&quot;tccJdk&quot;</code>ã€‚</li><li>å£°æ˜ <code>dubbo:reference</code> çš„ <code>proxy=&quot;tccJdk&quot;</code>ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚</li></ul><h1>3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</h1><p><code>org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor</code>ï¼ŒDubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        String context = RpcContext.getContext().getAttachment(TransactionContextConstants.TRANSACTION_CONTEXT);</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(context)) &#123;</div><div class="line">            <span class="keyword">return</span> JSON.parseObject(context, TransactionContext.class);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        RpcContext.getContext().setAttachment(TransactionContextConstants.TRANSACTION_CONTEXT, JSON.toJSONString(transactionContext));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡ Dubbo çš„éšå¼ä¼ å‚çš„æ–¹å¼ï¼Œé¿å…åœ¨ Dubbo Service æ¥å£ä¸Šå£°æ˜ TransactionContext å‚æ•°ï¼Œå¯¹æ¥å£äº§ç”Ÿä¸€å®šçš„å…¥ä¾µã€‚</li></ul><h1>666. å½©è›‹</h1><p>HOHOï¼Œå¯¹åŠ¨æ€ä»£ç†åˆå­¦ä¹ äº†ä¸€éï¼Œè›® High çš„ã€‚</p><p>è¿™é‡Œæ¨èåŠ¨æ€ä»£ç†æ— å…³ï¼Œå’Œ Dubbo ç›¸å…³çš„æ–‡ç« ï¼š</p><ul><li><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboçš„æœåŠ¡æš´éœ²ç»†èŠ‚ã€‹</a>ã€‚</li><li><a href="http://weifuwu.io/2016/01/03/dubbo-provider-start/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubbo Providerå¯åŠ¨ä¸»æµç¨‹ã€‹</a></li></ul><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-dubbo-%E4
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” è¿ç»´å¹³å°</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/console/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/console/</id>
    <published>2018-02-27T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. æ•°æ®è®¿é—®å±‚</a><ul><li><a href="#">2.1 JDBC äº‹åŠ¡ DAO</a></li><li><a href="#">2.2 Redis äº‹åŠ¡ DAO</a></li></ul></li><li><a href="#">3. æ§åˆ¶å±‚</a><ul><li><a href="#">3.1 æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨</a></li><li><a href="#">3.2 é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>è¿ç»´å¹³å°</strong>ã€‚TCC-Transaction æä¾›äº†ç›¸å¯¹ç²¾ç®€çš„è¿ç»´å¹³å°ï¼Œç”¨äºæŸ¥çœ‹åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>æåˆ°çš„<strong>äº‹åŠ¡å­˜å‚¨</strong>ã€‚ç›®å‰æš‚æ—¶åªæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul><li>æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨</li><li>é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°</li></ul><p>è¿ç»´å¹³å°( Maven é¡¹ç›® <code>tcc-transaction-server</code> ) æ•´ä½“ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/01.png" alt=""></p><p>æœ¬æ–‡è‡ªä¸‹è€Œä¸Šï¼ŒDao =&gt; Controller =&gt; UI çš„é¡ºåºè¿›è¡Œè§£æå®ç°ã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1>2. æ•°æ®è®¿é—®å±‚</h1><p><code>org.mengyun.tcctransaction.server.dao.TransactionDao</code>ï¼Œäº‹åŠ¡Dao <strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDao</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡ VO æ•°ç»„</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> domain é¢†åŸŸ</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum ç¬¬å‡ é¡µ</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize åˆ†é¡µå¤§å°</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡ VO æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;TransactionVo&gt; <span class="title">findTransactions</span><span class="params">(String domain, Integer pageNum, <span class="keyword">int</span> pageSize)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡æ€»æ•°é‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> domain é¢†åŸŸ</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Integer <span class="title">countOfFindTransactions</span><span class="params">(String domain)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡ç½®äº‹åŠ¡é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> domain é¢†åŸŸ</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> globalTxId å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> branchQualifier åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦é‡ç½®æˆåŠŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resetRetryCount</span><span class="params">(String domain, <span class="keyword">byte</span>[] globalTxId, <span class="keyword">byte</span>[] branchQualifier)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>TCC-Transaction æä¾›äº†å››ç§äº‹åŠ¡å­˜å‚¨å™¨ï¼Œä½†æ˜¯ç›®å‰åªæ”¯æŒä¸¤ç§æ•°æ®è®¿é—®å±‚çš„å®ç°ï¼š</p><ul><li>JDBC äº‹åŠ¡ DAO</li><li>Redis äº‹åŠ¡ DAO</li></ul><h2>2.1 JDBC äº‹åŠ¡ DAO</h2><p><code>org.mengyun.tcctransaction.server.dao.JdbcTransactionDao</code>ï¼ŒJDBC äº‹åŠ¡ DAO å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Repository</span>(<span class="string">"jdbcTransactionDao"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionDao</span> <span class="keyword">implements</span> <span class="title">TransactionDao</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_NAME_PREFIX = <span class="string">"TCC_TRANSACTION"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯»å– jdbc-domain-suffix.properties</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;jdbcDomainSuffix&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> Properties domainSuffix;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>dataSource</code>ï¼Œæ•°æ®æºã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-server-dao.xml </div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span></span></div><div class="line"><span class="tag">     <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></div><div class="line"><span class="tag">     <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"50"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"30"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandonedTimeout"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"1000"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeBetweenEvictionRunsMillis"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"numTestsPerEvictionRun"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validationQuery"</span> <span class="attr">value</span>=<span class="string">"SELECT NOW() FROM DUAL"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">// tcc-transaction-server.properties</div><div class="line">jdbc.url=jdbc:mysql://127.0.0.1:33061/TCC?useUnicode=true&amp;characterEncoding=UTF-8</div><div class="line">jdbc.username=root</div><div class="line">jdbc.password=123456</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <code>appcontext-server-dao.xml</code>ï¼Œé…ç½®æ•°æ®æº Bean å¯¹è±¡ã€‚</li><li>åœ¨ <code>tcc-transaction-server.properties</code>ï¼Œé…ç½®æ•°æ®æºå±æ€§ã€‚</li></ul></li><li><p><code>domainSuffix</code>ï¼Œ<code>domian</code> å’Œ è¡¨åç¼€( <code>suffix</code> ) çš„æ˜ å°„å…³ç³»ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// jdbc-domain-suffix.properties</div><div class="line">CAPITAL=_CAP</div><div class="line">ORDER=_ORD</div><div class="line">REDPACKET=_RED</div></pre></td></tr></table></figure></p><ul><li>é”® ï¼šdomainã€‚</li><li>å€¼ ï¼šsuffixã€‚</li></ul></li></ul><p>JdbcTransactionDao ä»£ç å®ç°ä¸Šæ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/e54c3e43a2e47a7765bdb18a485860cb31acbb72/tcc-transaction-server/src/main/java/org/mengyun/tcctransaction/server/dao/JdbcTransactionDao.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šã€‚</p><h2>2.2 Redis äº‹åŠ¡ DAO</h2><p><code>org.mengyun.tcctransaction.server.dao.RedisTransactionDao</code>ï¼ŒRedis äº‹åŠ¡ DAOã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Repository</span>(<span class="string">"redisTransactionDao"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTransactionDao</span> <span class="keyword">implements</span> <span class="title">TransactionDao</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * redis pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> JedisPool jedisPool;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯»å– redis-domain-key-prefix.properties</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;redisDomainKeyPrefix&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> Properties domainKeyPrefix;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>jedisPool</code>ï¼ŒRedis è¿æ¥æ± ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-server-dao.xml</div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"300"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"3000"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPool"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPool"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"jedisPoolConfig"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.host&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.port&#125;"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"3"</span> <span class="attr">value</span>=<span class="string">"6000"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"4"</span> <span class="attr">type</span>=<span class="string">"java.lang.String"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">null</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"5"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.db&#125;"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">// tcc-transaction-server.properties</div><div class="line">redis.host=127.0.0.1</div><div class="line">redis.port=6379</div><div class="line">redis.password=</div><div class="line">redis.db=0</div></pre></td></tr></table></figure></p><ul><li>åœ¨ <code>appcontext-server-dao.xml</code>ï¼Œé…ç½® Redis è¿æ¥æ±  Bean å¯¹è±¡ã€‚</li><li>åœ¨ <code>tcc-transaction-server.properties</code>ï¼Œé…ç½® Redis è¿æ¥æ± å±æ€§ã€‚</li></ul></li><li><p><code>domainKeyPrefix</code>ï¼Œdomain å’Œ Redis Key å‰ç¼€( <code>prefix</code> )çš„æ˜ å°„ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">CAPITAL=TCC:CAP:</div><div class="line">ORDER=TCC:ORD:</div><div class="line">REDPACKET=TCC:RED:</div></pre></td></tr></table></figure></p><ul><li>é”® ï¼šdomainã€‚</li><li>å€¼ ï¼šsuffixã€‚</li></ul></li></ul><p>RedisTransactionDao ä»£ç å®ç°ä¸Šæ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»[é“¾æ¥]https://github.com/YunaiV/tcc-transaction/blob/e54c3e43a2e47a7765bdb18a485860cb31acbb72/tcc-transaction-server/src/main/java/org/mengyun/tcctransaction/server/dao/RedisTransactionDao.java)æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šã€‚</p><h1>3. æ§åˆ¶å±‚</h1><p><code>org.mengyun.tcctransaction.server.controller.TransactionController</code>ï¼Œäº‹åŠ¡ Controllerã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEFAULT_PAGE_NUM = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PAGE_SIZE = <span class="number">10</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®è®¿é—®å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="meta">@Qualifier</span>(<span class="string">"jdbcTransactionDao"</span>)</div><div class="line">    <span class="keyword">private</span> TransactionDao transactionDao;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¡¹ç›®è®¿é—®æ ¹ç›®å½•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;tcc_domain&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String tccDomain;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>transactionDao</code>ï¼Œæ•°æ®è®¿é—®å¯¹è±¡ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-server-dao.xml</div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionDao"</span> <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.server.dao.JdbcTransactionDao"</span>/&gt;</span></div></pre></td></tr></table></figure></p><ul><li>ç›®å‰è¿ç»´å¹³å°åªèƒ½è¯»å–ä¸€ä¸ªæ•°æ®æºï¼Œå¦‚æœä½ çš„æ•°æ®æºæ˜¯å¤šä¸ªï¼Œéœ€è¦å¯¹è¿ç»´å¹³å°åšä¸€å®šçš„æ”¹é€ ï¼Œæˆ–å¯åŠ¨å¤šä¸ªé¡¹ç›®ã€‚</li></ul></li><li><p><code>tccDomain</code>ï¼Œé¡¹ç›®è®¿é—®æ ¹ç›®å½•ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p><p><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// tcc-transaction-server.properties</div><div class="line">tcc_domain=</div></pre></td></tr></table></figure></p><ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ä¸ç”¨é…ç½®ï¼Œå¦‚æœä½ æ”¾åœ¨ Tomcat æ ¹ç›®å½•ã€‚</li></ul></li></ul><h2>3.1 æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨</h2><p>è°ƒç”¨ <code>TransactionController#manager(...)</code> æ–¹æ³•ï¼ŒæŸ¥çœ‹äº‹åŠ¡åˆ—è¡¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/management"</span>, method = RequestMethod.GET)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">manager</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"manager"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/management/domain/&#123;domain&#125;"</span>, method = RequestMethod.GET)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">manager</span><span class="params">(@PathVariable String domain)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> manager(domain, DEFAULT_PAGE_NUM);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/management/domain/&#123;domain&#125;/pagenum/&#123;pageNum&#125;"</span>, method = RequestMethod.GET)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">manager</span><span class="params">(@PathVariable String domain, @PathVariable Integer pageNum)</span> </span>&#123;</div><div class="line">   ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView(<span class="string">"manager"</span>);</div><div class="line">   <span class="comment">// è·å¾—äº‹åŠ¡ VO æ•°ç»„</span></div><div class="line">   List&lt;TransactionVo&gt; transactionVos = transactionDao.findTransactions(domain, pageNum, DEFAULT_PAGE_SIZE);</div><div class="line">   <span class="comment">// è·å¾—äº‹åŠ¡æ€»æ•°é‡</span></div><div class="line">   Integer totalCount = transactionDao.countOfFindTransactions(domain);</div><div class="line">   <span class="comment">// è®¡ç®—æ€»é¡µæ•°</span></div><div class="line">   Integer pages = totalCount / DEFAULT_PAGE_SIZE;</div><div class="line">   <span class="keyword">if</span> (totalCount % DEFAULT_PAGE_SIZE &gt; <span class="number">0</span>) &#123;</div><div class="line">       pages++;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›</span></div><div class="line">   modelAndView.addObject(<span class="string">"transactionVos"</span>, transactionVos);</div><div class="line">   modelAndView.addObject(<span class="string">"pageNum"</span>, pageNum);</div><div class="line">   modelAndView.addObject(<span class="string">"pageSize"</span>, DEFAULT_PAGE_SIZE);</div><div class="line">   modelAndView.addObject(<span class="string">"pages"</span>, pages);</div><div class="line">   modelAndView.addObject(<span class="string">"domain"</span>, domain);</div><div class="line">   modelAndView.addObject(<span class="string">"urlWithoutPaging"</span>, tccDomain + <span class="string">"/management/domain/"</span> + domain);</div><div class="line">   <span class="keyword">return</span> modelAndView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>UI ç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/02.png" alt=""></p><h2>3.2 é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°</h2><p>è°ƒç”¨ <code>TransactionController#reset(...)</code> æ–¹æ³•ï¼Œäº‹åŠ¡é‡ç½®é‡è¯•æ¬¡æ•°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/domain/&#123;domain&#125;/retry/reset"</span>, method = RequestMethod.PUT)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> CommonResponse&lt;Void&gt; <span class="title">reset</span><span class="params">(@PathVariable String domain, String globalTxId, String branchQualifier)</span> </span>&#123;</div><div class="line">   transactionDao.resetRetryCount(domain,</div><div class="line">           DatatypeConverter.parseHexBinary(globalTxId),</div><div class="line">           DatatypeConverter.parseHexBinary(branchQualifier));</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse&lt;Void&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>UI ç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/03.png" alt=""></p><h1>666. å½©è›‹</h1><p>å¯èƒ½æœ‰äººä¼šåæ§½è¿ç»´å¹³å°æ€ä¹ˆåšçš„è¿™ä¹ˆç®€é™‹ã€‚è¿™ä¸ªä¸æ˜¯ TCC-Transaction ä¸€ä¸ªå¼€æºé¡¹ç›®å­˜åœ¨çš„é—®é¢˜ï¼Œå…¶ä»–ä¾‹å¦‚ Dubboã€Disconf ç­‰ç­‰éƒ½ä¼šå­˜åœ¨è¿™ä¸ªæƒ…å†µã€‚</p><p>å¼€æºä½œè€…å› ä¸ºæ—¶é—´å…³ç³»ï¼Œæ›´å¤šçš„ç²¾åŠ›å…³æ³¨åœ¨æ ¸å¿ƒä»£ç ï¼Œæ‰€ä»¥å¯¹è¿ç»´å‹å¥½æ€§å¯èƒ½èŠ±è´¹çš„ç²¾åŠ›è¾ƒå°‘ã€‚</p><p>å½“ç„¶ï¼Œå› ä¸ºæ˜¯å¼€æºçš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±åšè¿ç»´å¹³å°åå‘çš„è´¡çŒ®åˆ°è¿™äº›é¡¹ç›®ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. æ•°æ®è®¿é—®å±‚&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/transaction-recovery/</id>
    <published>2018-02-21T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:38.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‹åŠ¡é‡è¯•é…ç½®</a></li><li><a href="#">3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡</a></li><li><a href="#">4. å¼‚å¸¸äº‹åŠ¡æ¢å¤</a><ul><li><a href="#">4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</a></li><li><a href="#">4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC æ¢å¤</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹äºŒä¸ª package è·¯å¾„ä¸‹çš„ç±»ï¼š</p><ul><li><code>org.mengyun.tcctransaction.recover</code><ul><li>RecoverConfigï¼Œäº‹åŠ¡æ¢å¤é…ç½®<strong>æ¥å£</strong></li><li>TransactionRecoveryï¼Œäº‹åŠ¡æ¢å¤é€»è¾‘</li></ul></li><li><code>org.mengyun.tcctransaction.spring.recover</code> ï¼š<ul><li>DefaultRecoverConfigï¼Œé»˜è®¤äº‹åŠ¡æ¢å¤é…ç½®<strong>å®ç°</strong></li><li>RecoverScheduledJobï¼Œäº‹åŠ¡æ¢å¤å®šæ—¶ä»»åŠ¡</li></ul></li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/01.png" alt=""></p><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>ä¸­ï¼Œäº‹åŠ¡ä¿¡æ¯è¢«æŒä¹…åŒ–åˆ°å¤–éƒ¨çš„å­˜å‚¨å™¨ä¸­ã€‚<strong>äº‹åŠ¡å­˜å‚¨æ˜¯äº‹åŠ¡æ¢å¤çš„åŸºç¡€</strong>ã€‚é€šè¿‡è¯»å–å¤–éƒ¨å­˜å‚¨å™¨ä¸­çš„å¼‚å¸¸äº‹åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ä¼šæŒ‰ç…§ä¸€å®šé¢‘ç‡å¯¹äº‹åŠ¡è¿›è¡Œé‡è¯•ï¼Œç›´åˆ°äº‹åŠ¡å®Œæˆæˆ–è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1>2. äº‹åŠ¡é‡è¯•é…ç½®</h1><p><code>org.mengyun.tcctransaction.recover.RecoverConfig</code>ï¼Œäº‹åŠ¡æ¢å¤é…ç½®<strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RecoverConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMaxRetryCount</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ¢å¤é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getRecoverDuration</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> cron è¡¨è¾¾å¼</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getCronExpression</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Set&lt;Class&lt;? extends Exception&gt;&gt; getDelayCancelExceptions();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¾ç½®å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> delayRecoverExceptions å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDelayCancelExceptions</span><span class="params">(Set&lt;Class&lt;? extends Exception&gt;&gt; delayRecoverExceptions)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>#getMaxRetryCount()</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œç›®å‰ä»…æ‰“å‡ºé”™è¯¯æ—¥å¿—ï¼Œä¸‹æ–‡ä¼šçœ‹åˆ°å®ç°ã€‚</li><li><code>#getRecoverDuration()</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤é‡è¯•çš„é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getCronExpression()</code>ï¼Œå®šæ—¶ä»»åŠ¡ cron è¡¨è¾¾å¼ã€‚</li><li><code>#getDelayCancelExceptions()</code>ï¼Œå»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆã€‚</li></ul><hr><p><code>org.mengyun.tcctransaction.spring.recover.DefaultRecoverConfig</code>ï¼Œ<strong>é»˜è®¤</strong>äº‹åŠ¡æ¢å¤é…ç½®å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRecoverConfig</span> <span class="keyword">implements</span> <span class="title">RecoverConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RecoverConfig INSTANCE = <span class="keyword">new</span> DefaultRecoverConfig();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxRetryCount = <span class="number">30</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ¢å¤é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> recoverDuration = <span class="number">120</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron è¡¨è¾¾å¼</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String cronExpression = <span class="string">"0 */1 * * * ?"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends Exception&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultRecoverConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        delayCancelExceptions.add(OptimisticLockException.class);</div><div class="line">        delayCancelExceptions.add(SocketTimeoutException.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDelayCancelExceptions</span><span class="params">(Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delayCancelExceptions.addAll(delayCancelExceptions);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>maxRetryCount</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤æœ€å¤§é‡è¯•æ¬¡æ•° ä¸º 30ã€‚</li><li><code>recoverDuration</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤é‡è¯•çš„é—´éš”æ—¶é—´ä¸º 120 ç§’ã€‚</li><li><code>cronExpression</code>ï¼Œå®šæ—¶ä»»åŠ¡ cron è¡¨è¾¾å¼ä¸º <code>&quot;0 */1 * * * ?&quot;</code>ï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœä½ å¸Œæœ›å®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„æ›´é¢‘ç¹ï¼Œå¯ä»¥ä¿®æ”¹ cron è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ <code>0/30 * * * * ?</code>ï¼Œæ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡ã€‚</li><li><code>delayCancelExceptions</code>ï¼Œå»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆã€‚åœ¨ DefaultRecoverConfig æ„é€ æ–¹æ³•é‡Œï¼Œé¢„å…ˆæ·»åŠ äº† OptimisticLockException / SocketTimeoutException ã€‚<ul><li>é’ˆå¯¹ <strong>SocketTimeoutException</strong> ï¼štry é˜¶æ®µï¼Œæœ¬åœ°å‚ä¸è€…è°ƒç”¨è¿œç¨‹å‚ä¸è€…( è¿œç¨‹æœåŠ¡ï¼Œä¾‹å¦‚ Dubboï¼ŒHttp æœåŠ¡)ï¼Œè¿œç¨‹å‚ä¸è€… try é˜¶æ®µçš„æ–¹æ³•é€»è¾‘æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¶…è¿‡ Socket ç­‰å¾…æ—¶é•¿ï¼Œå‘ç”Ÿ SocketTimeoutExceptionï¼Œå¦‚æœç«‹åˆ»æ‰§è¡Œäº‹åŠ¡å›æ»šï¼Œè¿œç¨‹å‚ä¸è€… try çš„æ–¹æ³•æœªæ‰§è¡Œå®Œæˆï¼Œå¯èƒ½å¯¼è‡´ cancel çš„æ–¹æ³•å®é™…æœªæ‰§è¡Œ( try çš„æ–¹æ³•æœªæ‰§è¡Œå®Œæˆï¼Œæ•°æ®åº“äº‹åŠ¡ã€é TCC äº‹åŠ¡ã€‘æœªæäº¤ï¼Œcancel çš„æ–¹æ³•è¯»å–æ•°æ®æ—¶å‘ç°æœªå˜æ›´ï¼Œå¯¼è‡´æ–¹æ³•å®é™…æœªæ‰§è¡Œï¼Œæœ€ç»ˆ try çš„æ–¹æ³•æ‰§è¡Œå®Œåï¼Œæäº¤æ•°æ®åº“äº‹åŠ¡ã€é TCC äº‹åŠ¡ã€‘ï¼Œè¾ƒä¸ºæç«¯ )ï¼Œæœ€ç»ˆå¼•èµ·æ•°æ®ä¸ä¸€è‡´ã€‚åœ¨<strong>äº‹åŠ¡æ¢å¤</strong>æ—¶ï¼Œä¼šå¯¹è¿™ç§æƒ…å†µçš„äº‹åŠ¡è¿›è¡Œå–æ¶ˆå›æ»šï¼Œå¦‚æœæ­¤æ—¶è¿œç¨‹å‚ä¸è€…çš„ try çš„æ–¹æ³•è¿˜æœªç»“æŸï¼Œè¿˜æ˜¯å¯èƒ½å‘ç”Ÿæ•°æ®ä¸ä¸€è‡´ã€‚<ul><li>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/87" rel="external nofollow noopener noreferrer" target="_blank">ä¸ºä»€ä¹ˆ tcc äº‹åŠ¡åˆ‡é¢ä¸­å¯¹ä¹è§‚é”ä¸socketè¶…æ—¶å¼‚å¸¸ä¸åšå›æ»šå¤„ç†ï¼ŒåªæŠ›å¼‚å¸¸ï¼Ÿ</a></li></ul></li><li>é’ˆå¯¹ OptimisticLockException ï¼šè¿˜æ˜¯ SocketTimeoutException çš„æƒ…å†µï¼Œäº‹åŠ¡æ¢å¤é—´éš”æ—¶é—´å°äº Socket è¶…æ—¶æ—¶é—´ï¼Œæ­¤æ—¶äº‹åŠ¡æ¢å¤è°ƒç”¨è¿œç¨‹å‚ä¸è€…å–æ¶ˆå›æ»šäº‹åŠ¡ï¼Œè¿œç¨‹å‚ä¸è€…ä¸‹æ¬¡æ›´æ–°äº‹åŠ¡æ—¶ï¼Œä¼šå› ä¸ºä¹è§‚é”æ›´æ–°å¤±è´¥ï¼ŒæŠ›å‡º OptimisticLockExceptionã€‚å¦‚æœ CompensableTransactionInterceptor æ­¤æ—¶ç«‹åˆ»å–æ¶ˆå›æ»šï¼Œå¯èƒ½ä¼šå’Œå®šæ—¶ä»»åŠ¡çš„å–æ¶ˆå›æ»šå†²çªï¼Œå› æ­¤ç»Ÿä¸€äº¤ç»™å®šæ—¶ä»»åŠ¡å¤„ç†ã€‚<ul><li>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/53" rel="external nofollow noopener noreferrer" target="_blank">äº‹åŠ¡æ¢å¤çš„ç–‘é—®</a></li><li>è¿™å—ç¬”è€…è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œå¦‚æœæœ‰åˆ«çš„å¯èƒ½æ€§å¯¼è‡´è¿™ä¸ªæƒ…å†µï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ç¬”è€…ã€‚è°¢è°¢ã€‚</li></ul></li></ul></li></ul><h1>3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡</h1><p><code>org.mengyun.tcctransaction.spring.recover.RecoverScheduledJob</code>ï¼Œäº‹åŠ¡æ¢å¤å®šæ—¶ä»»åŠ¡ï¼ŒåŸºäº Quartz å®ç°è°ƒåº¦ï¼Œä¸æ–­ä¸æ–­ä¸æ–­æ‰§è¡Œäº‹åŠ¡æ¢å¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecoverScheduledJob</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionRecovery transactionRecovery;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionConfigurator transactionConfigurator;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Scheduler scheduler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Quartz JobDetail</span></div><div class="line">            MethodInvokingJobDetailFactoryBean jobDetail = <span class="keyword">new</span> MethodInvokingJobDetailFactoryBean();</div><div class="line">            jobDetail.setTargetObject(transactionRecovery);</div><div class="line">            jobDetail.setTargetMethod(<span class="string">"startRecover"</span>);</div><div class="line">            jobDetail.setName(<span class="string">"transactionRecoveryJob"</span>);</div><div class="line">            jobDetail.setConcurrent(<span class="keyword">false</span>); <span class="comment">// ç¦æ­¢å¹¶å‘</span></div><div class="line">            jobDetail.afterPropertiesSet();</div><div class="line">            <span class="comment">// Quartz CronTriggerFactoryBean</span></div><div class="line">            CronTriggerFactoryBean cronTrigger = <span class="keyword">new</span> CronTriggerFactoryBean();</div><div class="line">            cronTrigger.setBeanName(<span class="string">"transactionRecoveryCronTrigger"</span>);</div><div class="line">            cronTrigger.setCronExpression(transactionConfigurator.getRecoverConfig().getCronExpression());</div><div class="line">            cronTrigger.setJobDetail(jobDetail.getObject());</div><div class="line">            cronTrigger.afterPropertiesSet();</div><div class="line">            <span class="comment">// å¯åŠ¨ä»»åŠ¡è°ƒåº¦</span></div><div class="line">            scheduler.scheduleJob(jobDetail.getObject(), cronTrigger.getObject());</div><div class="line">            <span class="comment">// å¯åŠ¨ Quartz Scheduler</span></div><div class="line">            scheduler.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>MethodInvokingJobDetailFactoryBean#setConcurrent(false)</code> æ–¹æ³•ï¼Œç¦ç”¨ä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</li><li>è°ƒç”¨ <code>MethodInvokingJobDetailFactoryBean#setTargetObject(...)</code> + <code>MethodInvokingJobDetailFactoryBean#setTargetMethod(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ä»»åŠ¡è°ƒç”¨ <code>TransactionRecovery#startRecover(...)</code> æ–¹æ³•æ‰§è¡Œã€‚</li></ul><p><strong>å¦‚æœåº”ç”¨é›†ç¾¤éƒ¨ç½²ï¼Œä¼šä¸ä¼šç›¸åŒäº‹åŠ¡è¢«å¤šä¸ªå®šæ—¶ä»»åŠ¡åŒæ—¶é‡è¯•</strong>ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œäº‹åŠ¡åœ¨é‡è¯•æ—¶ä¼šä¹è§‚é”æ›´æ–°ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªåº”ç”¨èŠ‚ç‚¹èƒ½æ›´æ–°æˆåŠŸã€‚</p><p>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/98" rel="external nofollow noopener noreferrer" target="_blank">å¤šæœºéƒ¨ç½²ä¸‹ï¼Œæ‰€æœ‰æœºå™¨éƒ½å®•æœºï¼Œä»å¼‚å¸¸ä¸­æ¢å¤æ—¶ï¼Œæ‰€æœ‰çš„æœºå™¨å²‚ä¸æ˜¯éƒ½å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰çš„éœ€è¦æ¢å¤çš„æœåŠ¡ï¼Ÿ</a></p><p>å½“ç„¶æç«¯æƒ…å†µä¸‹ï¼ŒSocket è°ƒç”¨è¶…æ—¶æ—¶é—´å¤§äºäº‹åŠ¡é‡è¯•é—´éš”ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹åœ¨é‡è¯•æŸä¸ªäº‹åŠ¡ï¼Œä¸€ç›´æœªæ‰§è¡Œå®Œæˆï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹å·²ç»å¯ä»¥é‡è¯•ã€‚</p><p>psï¼šå»ºè®®ï¼ŒSocket è°ƒç”¨è¶…æ—¶æ—¶é—´å°äºäº‹åŠ¡é‡è¯•é—´éš”ã€‚</p><p><strong>æ˜¯å¦å®šæ—¶ä»»åŠ¡å’Œåº”ç”¨æœåŠ¡å™¨è§£è€¦</strong>ï¼Ÿ</p><p>èš‚èšé‡‘æœçš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ DTS é‡‡ç”¨ client-server æ¨¡å¼ï¼š</p><ul><li>xts-client ï¼šè´Ÿè´£äº‹åŠ¡çš„åˆ›å»ºã€æäº¤ã€å›æ»šã€è®°å½•ã€‚</li><li>xts-server ï¼šè´Ÿè´£å¼‚å¸¸äº‹åŠ¡çš„æ¢å¤ã€‚</li></ul><blockquote><p>FROM <a href="https://www.cloud.alipay.com/docs/2/46887" rel="external nofollow noopener noreferrer" target="_blank">ã€Šèš‚èšé‡‘èäº‘ DTS æ–‡æ¡£ã€‹</a><br>åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ (Distributed Transaction Service, DTS) æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œç”¨æ¥ä¿éšœåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚DTS ä»æ¶æ„ä¸Šåˆ†ä¸º xts-client å’Œ xts-server ä¸¤éƒ¨åˆ†ï¼Œå‰è€…æ˜¯ä¸€ä¸ªåµŒå…¥å®¢æˆ·ç«¯åº”ç”¨çš„ JAR åŒ…ï¼Œä¸»è¦è´Ÿè´£äº‹åŠ¡æ•°æ®çš„å†™å…¥å’Œå¤„ç†ï¼›åè€…æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿï¼Œä¸»è¦è´Ÿè´£å¼‚å¸¸äº‹åŠ¡çš„æ¢å¤ã€‚</p></blockquote><h1>4. å¼‚å¸¸äº‹åŠ¡æ¢å¤</h1><p><code>org.mengyun.tcctransaction.recover.TransactionRecovery</code>ï¼Œå¼‚å¸¸äº‹åŠ¡æ¢å¤ï¼Œå®ç°ä¸»ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionRecovery</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯åŠ¨æ¢å¤äº‹åŠ¡é€»è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecover</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</span></div><div class="line">        List&lt;Transaction&gt; transactions = loadErrorTransactions();</div><div class="line">        <span class="comment">// æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</span></div><div class="line">        recoverErrorTransactions(transactions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</h2><p>è°ƒç”¨ <code>#loadErrorTransactions()</code> æ–¹æ³•ï¼ŒåŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Transaction&gt; <span class="title">loadErrorTransactions</span><span class="params">()</span> </span>&#123;</div><div class="line">   TransactionRepository transactionRepository = transactionConfigurator.getTransactionRepository();</div><div class="line">   <span class="keyword">long</span> currentTimeInMillis = Calendar.getInstance().getTimeInMillis();</div><div class="line">   RecoverConfig recoverConfig = transactionConfigurator.getRecoverConfig();</div><div class="line">   <span class="keyword">return</span> transactionRepository.findAllUnmodifiedSince(<span class="keyword">new</span> Date(currentTimeInMillis - recoverConfig.getRecoverDuration() * <span class="number">1000</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><strong>å¼‚å¸¸äº‹åŠ¡çš„å®šä¹‰</strong>ï¼šå½“å‰æ—¶é—´è¶…è¿‡ - äº‹åŠ¡å˜æ›´æ—¶é—´( æœ€åæ‰§è¡Œæ—¶é—´ ) &gt;= äº‹åŠ¡æ¢å¤é—´éš”( <code>RecoverConfig#getRecoverDuration()</code> )ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå·²å®Œæˆçš„äº‹åŠ¡ä¼šä»äº‹åŠ¡å­˜å‚¨å™¨åˆ é™¤ã€‚</li></ul><h2>4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</h2><p>è°ƒç”¨ <code>#recoverErrorTransactions(...)</code> æ–¹æ³•ï¼Œæ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverErrorTransactions</span><span class="params">(List&lt;Transaction&gt; transactions)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       <span class="comment">// è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line">       <span class="keyword">if</span> (transaction.getRetriedCount() &gt; transactionConfigurator.getRecoverConfig().getMaxRetryCount()) &#123;</div><div class="line">           logger.error(String.format(<span class="string">"recover failed with max retry count,will not try again. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ†æ”¯äº‹åŠ¡è¶…è¿‡æœ€å¤§å¯é‡è¯•æ—¶é—´</span></div><div class="line">       <span class="keyword">if</span> (transaction.getTransactionType().equals(TransactionType.BRANCH)</div><div class="line">               &amp;&amp; (transaction.getCreateTime().getTime() +</div><div class="line">               transactionConfigurator.getRecoverConfig().getMaxRetryCount() *</div><div class="line">                       transactionConfigurator.getRecoverConfig().getRecoverDuration() * <span class="number">1000</span></div><div class="line">               &gt; System.currentTimeMillis())) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Confirm / Cancel</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// å¢åŠ é‡è¯•æ¬¡æ•°</span></div><div class="line">           transaction.addRetriedCount();</div><div class="line">           <span class="comment">// Confirm</span></div><div class="line">           <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CONFIRMING)) &#123;</div><div class="line">               transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div class="line">               transactionConfigurator.getTransactionRepository().update(transaction);</div><div class="line">               transaction.commit();</div><div class="line">               transactionConfigurator.getTransactionRepository().delete(transaction);</div><div class="line">           <span class="comment">// Cancel</span></div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CANCELLING)</div><div class="line">                   || transaction.getTransactionType().equals(TransactionType.ROOT)) &#123; <span class="comment">// å¤„ç†å»¶è¿Ÿå–æ¶ˆçš„æƒ…å†µ</span></div><div class="line">               transaction.changeStatus(TransactionStatus.CANCELLING);</div><div class="line">               transactionConfigurator.getTransactionRepository().update(transaction);</div><div class="line">               transaction.rollback();</div><div class="line">               transactionConfigurator.getTransactionRepository().delete(transaction);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">           <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> OptimisticLockException</div><div class="line">                   || ExceptionUtils.getRootCause(throwable) <span class="keyword">instanceof</span> OptimisticLockException) &#123;</div><div class="line">               logger.warn(String.format(<span class="string">"optimisticLockException happened while recover. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               logger.error(String.format(<span class="string">"recover failed, txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>å½“å•ä¸ªäº‹åŠ¡è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°æ—¶ï¼Œä¸å†é‡è¯•ï¼Œåªæ‰“å°å¼‚å¸¸ï¼Œæ­¤æ—¶éœ€è¦<strong>äººå·¥ä»‹å…¥</strong>è§£å†³ã€‚å¯ä»¥æ¥å…¥ ELK æ”¶é›†æ—¥å¿—ç›‘æ§æŠ¥è­¦ã€‚</li><li>å½“<strong>åˆ†æ”¯äº‹åŠ¡</strong>è¶…è¿‡æœ€å¤§å¯é‡è¯•æ—¶é—´æ—¶ï¼Œä¸å†é‡è¯•ã€‚å¯èƒ½æœ‰åŒå­¦å’Œæˆ‘ä¸€å¼€å§‹ç†è§£çš„æ˜¯ç›¸åŒçš„ï¼Œå®é™…<strong>åˆ†æ”¯äº‹åŠ¡</strong>å¯¹åº”çš„åº”ç”¨æœåŠ¡å™¨ä¹Ÿå¯ä»¥é‡è¯•<strong>åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œä¸æ˜¯å¿…é¡»<strong>æ ¹äº‹åŠ¡</strong>å‘èµ·é‡è¯•ï¼Œä»è€Œä¸€èµ·é‡è¯•<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚è¿™ç‚¹è¦æ³¨æ„ä¸‹ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING çŠ¶æ€æ—¶ï¼Œæäº¤äº‹åŠ¡ï¼Œé€»è¾‘å’Œ <code>TransactionManager#commit()</code> ç±»ä¼¼ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING çŠ¶æ€ï¼Œæˆ–è€…<strong>äº‹åŠ¡ç±»å‹ä¸ºæ ¹äº‹åŠ¡</strong>ï¼Œå›æ»šäº‹åŠ¡ï¼Œé€»è¾‘å’Œ <code>TransactionManager#rollback()</code> ç±»ä¼¼ã€‚è¿™é‡ŒåŠ åˆ¤æ–­çš„<strong>äº‹åŠ¡ç±»å‹ä¸ºæ ¹äº‹åŠ¡</strong>ï¼Œç”¨äºå¤„ç†å»¶è¿Ÿå›æ»šå¼‚å¸¸çš„äº‹åŠ¡çš„å›æ»šã€‚</li></ul><h1>666. å½©è›‹</h1><p>åœ¨å†™æœ¬æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œæ— æ„ä¸­ç¿»åˆ°èš‚èšäº‘çš„æ–‡æ¡£ï¼Œåˆ†äº«ç»™çœ‹åˆ°æ­¤å¤„çš„çœŸçˆ±ä»¬ã€‚</p><p>çœŸçˆ±ä»¬ï¼Œè¯·çŒ›å‡»<a href="https://git.cloud.alipay.com/dx/AntCloudPayPublic" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠAntCloudPayPublicã€‹</a>è·³è½¬ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‹åŠ¡é‡è¯•é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a hre
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/transaction-repository/</id>
    <published>2018-02-14T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:30.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. åºåˆ—åŒ–</a><ul><li><a href="#">2.1 JDK åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.2 Kyro åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.3 JSON åºåˆ—åŒ–å®ç°</a></li></ul></li><li><a href="#">3. å­˜å‚¨å™¨</a><ul><li><a href="#">3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</a></li><li><a href="#">3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.5 File äº‹åŠ¡å­˜å‚¨å™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>äº‹åŠ¡å­˜å‚¨å™¨</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li></ul><p>åœ¨ TCC çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®åº”ç”¨å†…å­˜ä¸­çš„äº‹åŠ¡ä¿¡æ¯å®Œæˆæ•´ä¸ªäº‹åŠ¡æµç¨‹ã€‚But å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå°†äº‹åŠ¡ä¿¡æ¯åªæ”¾åœ¨åº”ç”¨å†…å­˜ä¸­æ˜¯è¿œè¿œä¸å¤Ÿå¯é çš„ã€‚ä¾‹å¦‚ï¼š</p><ol><li>åº”ç”¨è¿›ç¨‹å¼‚å¸¸å´©æºƒï¼Œæœªå®Œæˆçš„äº‹åŠ¡ä¿¡æ¯å°†ä¸¢å¤±ã€‚</li><li>åº”ç”¨è¿›ç¨‹é›†ç¾¤ï¼Œå½“æä¾›è¿œç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡ä¿¡æ¯éœ€è¦é›†ç¾¤å†…å…±äº«ã€‚</li><li>å‘èµ·äº‹åŠ¡çš„åº”ç”¨éœ€è¦é‡å¯éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼Œå› ä¸ºå„ç§åŸå› ï¼Œæœ‰æœªå®Œæˆçš„äº‹åŠ¡ã€‚</li></ol><p>å› æ­¤ï¼ŒTCC-Transaction å°†äº‹åŠ¡ä¿¡æ¯æ·»åŠ åˆ°å†…å­˜ä¸­çš„åŒæ—¶ï¼Œä¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨è¿›è¡ŒæŒä¹…åŒ–ã€‚ç›®å‰æä¾›å››ç§å¤–éƒ¨å­˜å‚¨ï¼š</p><ul><li>JdbcTransactionRepositoryï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨</li><li>RedisTransactionRepositoryï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨</li><li>ZooKeeperTransactionRepositoryï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨</li><li>FileSystemTransactionRepositoryï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨</li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1>2. åºåˆ—åŒ–</h1><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/tcc-core/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°ã€‹ã€Œ4. äº‹åŠ¡ä¸å‚ä¸è€…ã€</a>ï¼Œå¯ä»¥çœ‹åˆ° Transaction æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒ Participant æ•°ç»„ï¼Œè€Œ Participant æœ¬èº«ä¹Ÿæ˜¯å¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒäº†æ›´å¤šçš„å…¶ä»–å¯¹è±¡ï¼Œå› æ­¤ï¼Œå­˜å‚¨å™¨åœ¨æŒä¹…åŒ– Transaction æ—¶ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰èƒ½å­˜å‚¨ã€‚</p><p><code>org.mengyun.tcctransaction.serializer.ObjectSerializer</code>ï¼Œå¯¹è±¡åºåˆ—åŒ–<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">byte</span>[] serialize(T t);</div><div class="line">    </div><div class="line">    <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ç›®å‰æä¾› <strong>JDKè‡ªå¸¦åºåˆ—åŒ–</strong> å’Œ <strong>Kyroåºåˆ—åŒ–</strong> ä¸¤ç§å®ç°ã€‚</p><h2>2.1 JDK åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.JdkSerializationSerializer</code>ï¼ŒJDK åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/JdkSerializationSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><p><strong>TCC-Transaction ä½¿ç”¨çš„é»˜è®¤çš„åºåˆ—åŒ–</strong>ã€‚</p><h2>2.2 Kyro åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.KryoTransactionSerializer</code>ï¼ŒKyro åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/KryoTransactionSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><h2>2.3 JSON åºåˆ—åŒ–å®ç°</h2><p>JDK å’Œ Kyro çš„åºåˆ—åŒ–å®ç°ï¼Œè‚‰çœ¼æ— æ³•ç›´è§‚å…·ä½“å­˜å‚¨äº‹åŠ¡çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥é€šè¿‡å®ç° ObjectSerializer æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰çš„ JSON åºåˆ—åŒ–ã€‚</p><h1>3. å­˜å‚¨å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionRepository</code>ï¼Œäº‹åŠ¡å­˜å‚¨å™¨<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Transaction <span class="title">findByXid</span><span class="params">(TransactionXid xid)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ä¸åŒçš„å­˜å‚¨å™¨é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæä¾›äº‹åŠ¡çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</p><h2>3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</h2><p><code>org.mengyun.tcctransaction.repository.CachableTransactionRepository</code>ï¼Œ<strong>å¯ç¼“å­˜</strong>çš„äº‹åŠ¡å­˜å‚¨å™¨<strong>æŠ½è±¡ç±»</strong>ï¼Œå®ç°å¢åˆ æ”¹æŸ¥äº‹åŠ¡æ—¶ï¼ŒåŒæ—¶ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ã€‚åœ¨ä¸Šé¢ç±»å›¾ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ° TCC-Transaction è‡ªå¸¦çš„å¤šç§å­˜å‚¨å™¨éƒ½ç»§æ‰¿è¯¥æŠ½è±¡ç±»ã€‚</p><p><strong>CachableTransactionRepository æ„é€ æ–¹æ³•</strong>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CachableTransactionRepository</span> <span class="keyword">implements</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜è¿‡æœŸæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireDuration = <span class="number">120</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Cache&lt;Xid, Transaction&gt; transactionXidCompensableTransactionCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachableTransactionRepository</span><span class="params">()</span> </span>&#123;</div><div class="line">        transactionXidCompensableTransactionCache = CacheBuilder.newBuilder().expireAfterAccess(expireDuration, TimeUnit.SECONDS).maximumSize(<span class="number">1000</span>).build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ <a href="https://github.com/google/guava/wiki/CachesExplained" rel="external nofollow noopener noreferrer" target="_blank">Guava Cache</a> å†…å­˜ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ï¼Œè®¾ç½®æœ€å¤§ç¼“å­˜ä¸ªæ•°ä¸º 1000 ä¸ªï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ä¸ºæœ€åè®¿é—®æ—¶é—´ 120 ç§’ã€‚</li></ul><hr><p><strong><code>#create(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = doCreate(transaction);</div><div class="line">   <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">putToCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.put(transaction.getXid(), transaction);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doCreate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#doCreate(...)</code> æ–¹æ³•ï¼Œæ–°å¢äº‹åŠ¡ã€‚æ–°å¢æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li><code>#doCreate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ–°å¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#update(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doUpdate(transaction);</div><div class="line">       <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> OptimisticLockException();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123; <span class="comment">// æ›´æ–°å¤±è´¥ï¼Œç§»é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡è®¿é—®ï¼Œä»å­˜å‚¨å™¨è¯»å–</span></div><div class="line">           removeFromCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç§»é™¤äº‹åŠ¡ä»ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">removeFromCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.invalidate(transaction.getXid());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#doUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‹åŠ¡ã€‚<ul><li>è‹¥æ›´æ–°æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li>è‹¥æ›´æ–°å¤±è´¥åï¼ŒæŠ›å‡º OptimisticLockException å¼‚å¸¸ã€‚æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´æ›´æ–°å¤±è´¥ï¼š(1) è¯¥äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¢«åˆ é™¤ï¼›(2) ä¹è§‚é”æ›´æ–°æ—¶ï¼Œç¼“å­˜çš„äº‹åŠ¡çš„ç‰ˆæœ¬å·( <code>Transaction.version</code> )å’Œå­˜å‚¨å™¨é‡Œçš„äº‹åŠ¡çš„ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°å¤±è´¥ã€‚<strong>ä¸ºä»€ä¹ˆ</strong>ï¼Ÿåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚æ›´æ–°å¤±è´¥ï¼Œæ„å‘³ç€ç¼“å­˜å·²ç»ä¸ä¸ä¸€è‡´ï¼Œè°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li></ul></li><li><code>#doUpdate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ›´æ–°äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#delete(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doDelete(transaction);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       removeFromCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doDelete</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#doDelete(...)</code> æ–¹æ³•ï¼Œåˆ é™¤äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li><li><code>#doDelete(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›åˆ é™¤äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findByXid(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">findByXid</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   Transaction transaction = findFromCache(transactionXid);</div><div class="line">   <span class="keyword">if</span> (transaction == <span class="keyword">null</span>) &#123;</div><div class="line">       transaction = doFindOne(transactionXid);</div><div class="line">       <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—äº‹åŠ¡ä»ç¼“å­˜ä¸­</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionXid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Transaction <span class="title">findFromCache</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> transactionXidCompensableTransactionCache.getIfPresent(transactionXid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æŸ¥è¯¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Transaction <span class="title">doFindOne</span><span class="params">(Xid xid)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#findFromCache()</code> æ–¹æ³•ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#doFindOne()</code> æ–¹æ³•ï¼Œç¼“å­˜ä¸­äº‹åŠ¡ä¸å­˜åœ¨ï¼Œä»å­˜å‚¨å™¨ä¸­è·å–ã€‚è·å–åˆ°åï¼Œè°ƒç”¨ <code>#putToCache()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ä¸­ã€‚</li><li><code>#doFindOne(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æŸ¥è¯¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findAllUnmodifiedSince(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   List&lt;Transaction&gt; transactions = doFindAllUnmodifiedSince(date);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transactions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div></pre></td></tr></table></figure></p><ul><li>è°ƒç”¨ <code>#findAllUnmodifiedSince(...)</code> æ–¹æ³•ï¼Œä»å­˜å‚¨å™¨è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆã€‚è°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œå¾ªç¯äº‹åŠ¡é›†åˆæ·»åŠ åˆ°ç¼“å­˜ã€‚</li><li><code>#doFindAllUnmodifiedSince(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆåŠŸèƒ½ã€‚</li></ul><h2>3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.JdbcTransactionRepository</code>ï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨ï¼Œé€šè¿‡ JDBC é©±åŠ¨ï¼Œå°† Transaction å­˜å‚¨åˆ° MySQL / Oracle / PostgreSQL / SQLServer ç­‰å…³ç³»æ•°æ®åº“ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¢†åŸŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String domain;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¡¨åç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String tbSuffix;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>domain</code>ï¼Œé¢†åŸŸï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç§°ä¸ºæ¨¡å—åï¼Œåº”ç”¨åï¼Œ<strong>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªèµ„æº</strong>ã€‚ä¾‹å¦‚ï¼ŒMaven æ¨¡å— <code>xxx-order</code>ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®è¯¥å±æ€§ä¸º <code>ORDER</code>ã€‚</li><li><code>tbSuffix</code>ï¼Œè¡¨åç¼€ã€‚é»˜è®¤å­˜å‚¨è¡¨åä¸º <code>TCC_TRANSACTION</code>ï¼Œé…ç½®è¡¨ååï¼Œä¸º <code>TCC_TRANSACTION${tbSuffix}</code>ã€‚</li><li><code>dataSource</code>ï¼Œå­˜å‚¨æ•°æ®çš„æ•°æ®æºã€‚</li><li><code>serializer</code>ï¼Œåºåˆ—åŒ–ã€‚**å½“æ•°æ®åº“é‡Œå·²ç»æœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¸è¦æ›´æ¢åˆ«çš„åºåˆ—åŒ–ï¼Œå¦åˆ™ä¼šå¯¼è‡´ååºåˆ—åŒ–æŠ¥é”™ã€‚**å»ºè®®ï¼šTCC-Transaction å­˜å‚¨æ—¶ï¼Œæ–°å¢å­—æ®µï¼Œè®°å½•åºåˆ—åŒ–çš„æ–¹å¼ã€‚</li></ul><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">CREATE TABLE `TCC_TRANSACTION` (</div><div class="line">  `TRANSACTION_ID` <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</div><div class="line">  `DOMAIN` varchar(<span class="number">100</span>) DEFAULT NULL,</div><div class="line">  `GLOBAL_TX_ID` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `BRANCH_QUALIFIER` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `CONTENT` varbinary(<span class="number">8000</span>) DEFAULT NULL,</div><div class="line">  `STATUS` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `TRANSACTION_TYPE` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `RETRIED_COUNT` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `CREATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `LAST_UPDATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `VERSION` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`TRANSACTION_ID`)</span>,</span></div><div class="line"><span class="function">  UNIQUE KEY `UX_TX_BQ` <span class="params">(`GLOBAL_TX_ID`,`BRANCH_QUALIFIER`)</span></span></div><div class="line"><span class="function">) ENGINE</span>=InnoDB DEFAULT CHARSET=utf8</div></pre></td></tr></table></figure></p><ul><li><code>TRANSACTION_ID</code>ï¼Œä»…ä»…æ•°æ®åº“è‡ªå¢ï¼Œæ— å®é™…ç”¨é€”ã€‚</li><li><code>CONTENT</code>ï¼ŒTransaction åºåˆ—åŒ–ã€‚</li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/JdbcTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ JdbcTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><h2>3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.RedisTransactionRepository</code>ï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Redisã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jedis Pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> JedisPool jedisPool;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * key å‰ç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String keyPrefix = <span class="string">"TCC:"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>keyPrefix</code>ï¼Œkey å‰ç¼€ã€‚ç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Reidsï¼Œä½¿ç”¨ Redis çš„æ•°æ®ç»“æ„ä¸º <a href="https://redis.io/commands#hash" rel="external nofollow noopener noreferrer" target="_blank">HASHES</a>ã€‚</p><ul><li><p>key : ä½¿ç”¨ <code>keyPrefix</code> + <code>xid</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºäº‹åŠ¡çš„ Redis Key</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> keyPrefix key å‰ç¼€</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> Redis Key</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getRedisKey(String keyPrefix, Xid xid) &#123;</div><div class="line">   <span class="keyword">byte</span>[] prefix = keyPrefix.getBytes();</div><div class="line">   <span class="keyword">byte</span>[] globalTransactionId = xid.getGlobalTransactionId();</div><div class="line">   <span class="keyword">byte</span>[] branchQualifier = xid.getBranchQualifier();</div><div class="line">   <span class="comment">// æ‹¼æ¥ key</span></div><div class="line">   <span class="keyword">byte</span>[] key = <span class="keyword">new</span> <span class="keyword">byte</span>[prefix.length + globalTransactionId.length + branchQualifier.length];</div><div class="line">   System.arraycopy(prefix, <span class="number">0</span>, key, <span class="number">0</span>, prefix.length);</div><div class="line">   System.arraycopy(globalTransactionId, <span class="number">0</span>, key, prefix.length, globalTransactionId.length);</div><div class="line">   System.arraycopy(branchQualifier, <span class="number">0</span>, key, prefix.length + globalTransactionId.length, branchQualifier.length);</div><div class="line">   <span class="keyword">return</span> key;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>HASHES çš„ key ï¼šä½¿ç”¨ <code>version</code>ã€‚</p><ul><li>æ·»åŠ å’Œæ›´æ–° Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hsetnx" rel="external nofollow noopener noreferrer" target="_blank">HSETNX</a>ï¼Œä¸å­˜åœ¨å½“å‰ç‰ˆæœ¬çš„å€¼æ—¶ï¼Œè¿›è¡Œè®¾ç½®ï¼Œé‡è€Œå®ç°ç±»ä¼¼ä¹è§‚é”çš„æ›´æ–°ã€‚</li><li>è¯»å– Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hgetall" rel="external nofollow noopener noreferrer" target="_blank">HGETALL</a>ï¼Œå°† Transaction æ‰€æœ‰ <code>version</code> å¯¹åº”çš„å€¼è¯»å–åˆ°å†…å­˜åï¼Œå– <code>version</code> å€¼æœ€å¤§çš„å¯¹åº”çš„å€¼ã€‚</li></ul></li><li><p>HASHES çš„ value ï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(ObjectSerializer serializer, Transaction transaction) &#123;</div><div class="line">   Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">   map.put(<span class="string">"GLOBAL_TX_ID"</span>, transaction.getXid().getGlobalTransactionId());</div><div class="line">   map.put(<span class="string">"BRANCH_QUALIFIER"</span>, transaction.getXid().getBranchQualifier());</div><div class="line">   map.put(<span class="string">"STATUS"</span>, transaction.getStatus().getId());</div><div class="line">   map.put(<span class="string">"TRANSACTION_TYPE"</span>, transaction.getTransactionType().getId());</div><div class="line">   map.put(<span class="string">"RETRIED_COUNT"</span>, transaction.getRetriedCount());</div><div class="line">   map.put(<span class="string">"CREATE_TIME"</span>, transaction.getCreateTime());</div><div class="line">   map.put(<span class="string">"LAST_UPDATE_TIME"</span>, transaction.getLastUpdateTime());</div><div class="line">   map.put(<span class="string">"VERSION"</span>, transaction.getVersion());</div><div class="line">   <span class="comment">// åºåˆ—åŒ–</span></div><div class="line">   map.put(<span class="string">"CONTENT"</span>, serializer.serialize(transaction));</div><div class="line">   <span class="keyword">return</span> serializer.serialize(map);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>TODO ä¸ºä»€ä¹ˆåºåˆ—åŒ–ä¸¤æ¬¡</li></ul></li></ul><p>åœ¨å®ç° <code>#doFindAllUnmodifiedSince(date)</code> æ–¹æ³•ï¼Œæ— æ³•åƒæ•°æ®åº“ä½¿ç”¨æ—¶é—´æ¡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œå› æ­¤ï¼ŒåŠ è½½æ‰€æœ‰äº‹åŠ¡ååœ¨å†…å­˜ä¸­è¿‡æ»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾—æ‰€æœ‰äº‹åŠ¡</span></div><div class="line">   List&lt;Transaction&gt; allTransactions = doFindAll();</div><div class="line">   <span class="comment">// è¿‡æ»¤æ—¶é—´</span></div><div class="line">   List&lt;Transaction&gt; allUnmodifiedSince = <span class="keyword">new</span> ArrayList&lt;Transaction&gt;();</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : allTransactions) &#123;</div><div class="line">       <span class="keyword">if</span> (transaction.getLastUpdateTime().compareTo(date) &lt; <span class="number">0</span>) &#123;</div><div class="line">           allUnmodifiedSince.add(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> allUnmodifiedSince;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/RedisTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ RedisTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><blockquote><p>FROM <a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x#%E9%85%8D%E7%BD%AEtcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCC-Transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a><br>ä½¿ç”¨ RedisTransactionRepository éœ€è¦é…ç½® Redis æœåŠ¡å™¨å¦‚ä¸‹ï¼š<br>appendonly yes<br>appendfsync always</p></blockquote><h2>3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.ZooKeeperTransactionRepository</code>ï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Zookeeperã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper æœåŠ¡å™¨åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkServers;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> zkTimeout;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * TCC å­˜å‚¨ Zookeeper æ ¹ç›®å½•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkRootPath = <span class="string">"/tcc"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¿æ¥</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ZooKeeper zk;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>zkRootPath</code>ï¼Œå­˜å‚¨ Zookeeper æ ¹ç›®å½•ï¼Œç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Zookeeperï¼Œä½¿ç”¨ Zookeeper çš„<strong>æŒä¹…æ•°æ®èŠ‚ç‚¹</strong>ã€‚</p><ul><li><p>pathï¼š<code>${zkRootPath}</code> + <code>/</code> + <code>${xid}</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZooKeeperTransactionRepository.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getTxidPath</span><span class="params">(Xid xid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> String.format(<span class="string">"%s/%s"</span>, zkRootPath, xid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransactionXid.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">   stringBuilder.append(<span class="string">"globalTransactionId:"</span>).append(UUID.nameUUIDFromBytes(globalTransactionId).toString());</div><div class="line">   stringBuilder.append(<span class="string">","</span>).append(<span class="string">"branchQualifier:"</span>).append(UUID.nameUUIDFromBytes(branchQualifier).toString());</div><div class="line">   <span class="keyword">return</span> stringBuilder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>dataï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚</p></li><li><p>versionï¼šä½¿ç”¨ Zookeeper æ•°æ®èŠ‚ç‚¹è‡ªå¸¦ç‰ˆæœ¬åŠŸèƒ½ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼ŒTransaction çš„ç‰ˆæœ¬ä» 1 å¼€å§‹ï¼Œè€Œ Zookeeper æ•°æ®èŠ‚ç‚¹ç‰ˆæœ¬ä» 0 å¼€å§‹ã€‚</p></li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/ZooKeeperTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ ZooKeeperTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šæš‚æ—¶ä¸å»ºè®®ä½¿ç”¨ ZooKeeperTransactionRepositoryï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒ Zookeeper å®‰å…¨è®¤è¯ã€‚</li><li>ä½¿ç”¨ Zookeeper æ—¶ï¼Œæœªè€ƒè™‘æ–­ç½‘é‡è¿ç­‰æƒ…å†µã€‚</li></ul><p>å¦‚æœä½ è¦ä½¿ç”¨ Zookeeper è¿›è¡Œäº‹åŠ¡çš„å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> æ“ä½œ Zookeeperï¼Œé‡å†™ ZooKeeperTransactionRepository éƒ¨åˆ†ä»£ç ã€‚</p><h2>3.5 File äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.FileSystemTransactionRepository</code>ï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å®ç°ä¸Šå’Œ ZooKeeperTransactionRepositoryï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºä¸æ”¯æŒä¹è§‚é”æ›´æ–°ã€‚æœ‰å…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/FileSystemTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸æ‹“å±•å¼€æ¥ã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šä¸å»ºè®®ä½¿ç”¨ FileSystemTransactionRepositoryï¼Œå› ä¸ºä¸æ”¯æŒå¤šèŠ‚ç‚¹å…±äº«ã€‚ç”¨åˆ†å¸ƒå¼å­˜å‚¨æŒ‚è½½æ–‡ä»¶å¦è¯´ï¼Œå½“ç„¶è¿˜æ˜¯ä¸å»ºè®®ï¼Œå› ä¸ºä¸æ”¯æŒä¹è§‚é”å¹¶å‘æ›´æ–°ã€‚</p><h1>666. å½©è›‹</h1><p>è¿™ç¯‡ç•¥( è¶… )å¾®( çº§ )æ°´æ›´ï¼Œå“ˆå“ˆå“ˆï¼Œä¸º<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recover/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>åšé“ºå«å•¦ã€‚</p><p>ä½¿ç”¨ RedisTransactionRepository å’Œ ZooKeeperTransactionRepository å­˜å‚¨äº‹åŠ¡è¿˜æ˜¯ Get è›®å¤šç‚¹çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. åºåˆ—åŒ–&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
</feed>
