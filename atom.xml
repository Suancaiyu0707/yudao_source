<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-12-21T13:52:14.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>èŠ‹é“æºç </name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-streaming-first/</id>
    <published>2020-08-19T16:00:00.000Z</published>
    <updated>2017-12-21T13:52:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-streaming-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">2. apm-collector-core/graph</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">2.1 Graph åˆ›å»º</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">2.2 Graph å¯åŠ¨</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">3. apm-collector-stream</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">3.1 WayToNode å®ç°ç±»</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">3.2 NodeProcessor å®ç°ç±»</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Collector Streaming æµå¼å¤„ç†</strong>ã€‚ä¸»è¦åŒ…å«å¦‚ä¸‹éƒ¨åˆ†ï¼š</p><ul><li><p><code>apm-collector-core</code> æ¨¡å—çš„ <code>graph</code> åŒ…ï¼Œæä¾›<strong>æœ€ç²¾ç®€</strong>ã€<strong>å•èŠ‚ç‚¹</strong>çš„æµå¼å¤„ç†çš„å°è£…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/01.png" alt=""></p></li><li><p><code>apm-collector-stream</code> æ¨¡å—ï¼Œåœ¨ <code>graph</code> åŒ…çš„åŸºç¡€ä¸Šï¼Œæä¾›<strong>å¼‚æ­¥</strong>ã€<strong>è·¨èŠ‚ç‚¹</strong>ç­‰ç­‰çš„æµå¼å¤„ç†çš„å°è£…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/02.png" alt=""></p></li></ul><blockquote><p>å…æ‰“è„¸å¤§ä¿å¥ï¼šç¬”è€…å¯¹æµå¼å¤„ç†éå¸¸ä¸äº†è§£ï¼Œæœ¬æ–‡å¯èƒ½æ˜¯ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“ã€‚è€ƒè™‘åˆ°ç¬”è€…æ˜¯é è„¸åƒé¥­ï¼ˆé¢œå€¼æˆ‘åªæœæˆ‘çº¢é›·å“¥ï¼‰ï¼Œæ‰€ä»¥è¯»è€…è€çˆ·è¯·çˆ±æŠ¤ä¸‹ç¬”è€…ã€‚</p></blockquote><p>Collector Streaming åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/03.jpeg" alt=""></p></blockquote><p>OKï¼Œä¸‹é¢æ¥ä¸€æœ¬æ­£ç»çš„ä»£ç èµ°èµ·ï¼</p><h1>2. apm-collector-core/graph</h1><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/04.png" alt=""></p><p>çœ‹èµ·æ¥ç•¥å¤æ‚ï¼Œä¸è¦æ–¹ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæµå¼å¤§æ•°æ®å¤„ç†æ¡†æ¶ Apache Storm çš„è¯´æ˜ï¼š</p><blockquote><p>FROM <a href="http://www.csdn.net/article/2015-03-09/2824135" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæµå¼å¤§æ•°æ®å¤„ç†çš„ä¸‰ç§æ¡†æ¶ï¼šStormï¼ŒSparkå’ŒSamzaã€‹</a><br>åœ¨ <a href="https://storm.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Storm</a> ä¸­ï¼Œå…ˆè¦è®¾è®¡ä¸€ä¸ªç”¨äºå®æ—¶è®¡ç®—çš„å›¾çŠ¶ç»“æ„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ‹“æ‰‘ï¼ˆtopologyï¼‰ã€‚è¿™ä¸ªæ‹“æ‰‘å°†ä¼šè¢«æäº¤ç»™é›†ç¾¤ï¼Œç”±é›†ç¾¤ä¸­çš„ä¸»æ§èŠ‚ç‚¹ï¼ˆmaster nodeï¼‰åˆ†å‘ä»£ç ï¼Œå°†ä»»åŠ¡åˆ†é…ç»™å·¥ä½œèŠ‚ç‚¹ï¼ˆworker nodeï¼‰æ‰§è¡Œã€‚</p></blockquote><ul><li>Graph ï¼šå®šä¹‰äº†ä¸€ä¸ª<strong>æ•°æ®</strong>åœ¨<strong>å„ä¸ª</strong> Node çš„å¤„ç†æ‹“æ‰‘å›¾ã€‚</li><li>WayToNode ï¼šæäº¤<strong>æ•°æ®</strong>ç»™ Node çš„<strong>æ–¹å¼</strong>ã€‚</li><li>Node ï¼šèŠ‚ç‚¹ï¼ŒåŒ…å«ä¸€ä¸ª NodeProcessor å’Œ ä¸€ä¸ª Next ã€‚<ul><li>NodeProcessor ï¼šNode å¤„ç†å™¨ï¼Œå¤„ç†<strong>æ•°æ®</strong>ã€‚</li><li>Next ï¼šåŒ…å« WayToNode æ•°ç»„ï¼Œå³ Node æäº¤<strong>æ•°æ®</strong>ç»™ Next çš„ Node <strong>æ•°ç»„</strong>çš„<strong>æ–¹å¼</strong>ã€‚</li></ul></li></ul><p>æ•´ä½“äº¤äº’æµç¨‹å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/05.png" alt=""></p><ul><li><strong>ç²‰è‰²</strong>ç®­å¤´ï¼šå½“æ•°æ®è¿›æ¥æ—¶ï¼Œæäº¤ç»™ Grpah ã€‚æŒ‰ç…§å®šä¹‰çš„æ‹“æ‰‘å›¾ï¼Œä½¿ç”¨ NodeWay æäº¤ç»™ Node ï¼ŒNodeProcessor è¿›è¡Œå¤„ç†ã€‚</li><li><strong>è“è‰²</strong>ç®­å¤´ï¼šå½“ NodeProcessor å¤„ç†å®Œæˆåï¼ŒNext <strong>é€ä¸ª</strong>ä½¿ç”¨ NodeWay <strong>æ•°ç»„</strong>æäº¤ç»™ä¸‹é¢çš„ Node ï¼Œç»§ç»­å¤„ç†ã€‚<ul><li>ps ï¼š<strong>æ³¨æ„</strong>ï¼Œè¿™å—æµç¨‹ï¼Œæ ¹æ®ä¸åŒçš„ NodeProcessor çš„å®ç°ç±»ä¼šæœ‰ä¸åŒï¼Œ<strong>è“è‰²</strong>ç®­å¤´çš„è¿‡ç¨‹ï¼Œåªæ˜¯<strong>å…¶ä¸­çš„ä¸€ç§</strong>ï¼Œä¸‹é¢ä¼šè¯¦ç»†è§£æã€‚</li></ul></li></ul><p>æ•´ä½“é¡ºåºå›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/06.png" alt=""></p><ul><li>DirectWay æ˜¯ WayToNode <strong>æ¥å£</strong>çš„ä¸€ç§å®ç°ï¼Œæ­£å¦‚å…¶åï¼Œ<strong>ç›´æ¥</strong>æäº¤æ•°æ®ç»™ Node ã€‚åœ¨ <a href="#">ã€Œ3. apm-collector-streamã€</a> ä¼šçœ‹åˆ°å…¶ä»–å®ç°ï¼Œä¾‹å¦‚æäº¤åˆ°å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹çš„ Nodeï¼Œä»è€Œå®ç°è·¨æœåŠ¡å™¨èŠ‚ç‚¹çš„æµå¼å¤„ç†ã€‚</li><li>AbstractWorker åœ¨ <code>apm-collector-stream</code> æ¨¡å—ï¼Œæ˜¯ NodeProcessor <strong>æ¥å£</strong>çš„ä¸€ç§å®ç°ï¼Œå¤„ç†æäº¤ç»™ Node çš„æ•°æ®ã€‚åœ¨ <code>#onWork(message)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•é‡Œï¼Œå­ç±»å¯ä»¥å®ç°è¯¥æ–¹æ³•ï¼Œæ ¹æ®è‡ªèº«éœ€æ±‚ï¼Œæ˜¯å¦è°ƒç”¨ <code>#onNext(message)</code> æ–¹æ³•ï¼ŒNext é€ä¸ªä½¿ç”¨ NodeWay æ•°ç»„æäº¤ç»™ä¸‹é¢çš„ Node ï¼Œç»§ç»­å¤„ç†ã€‚</li></ul><hr><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†åˆ†åˆ«çœ‹çœ‹å¦‚ä¸‹é€»è¾‘çš„è¯¦ç»†ä»£ç å®ç°ï¼š</p><ul><li>Graph åˆ›å»º</li><li>Graph å¯åŠ¨</li></ul><h2>2.1 Graph åˆ›å»º</h2><p>åˆ›å»º Graph çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/07.png" alt=""></p><ul><li>ç¬¬ä¸€æ­¥ï¼Œè°ƒç”¨ <code>GraphManager#createIfAbsent(graphId, input)</code> æ–¹æ³•( <code>input</code> å‚æ•°æ²¡ç”¨ )ï¼Œåˆ›å»ºä¸€ä¸ª Graph å¯¹è±¡ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨ <code>Graph#addNode(WayToNode)</code> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Graph çš„<strong>é¦–ä¸ª</strong> Node å¯¹è±¡ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨ <code>Node#addNext(WayToNode)</code> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Node çš„ä¸‹ä¸€ä¸ª Node å¯¹è±¡ã€‚</li></ul><p>å¦‚ä¸‹æ˜¯ <code>collector-agent-stream-provider</code> æ¨¡å—ï¼Œ<code>TraceStreamGraph#createServiceReferenceGraph()</code> æ–¹æ³•çš„ä»£ç ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createServiceReferenceGraph</span><span class="params">()</span> </span>&#123;</div><div class="line">    QueueCreatorService&lt;ServiceReference&gt; queueCreatorService = moduleManager.find(QueueModule.NAME).getService(QueueCreatorService.class);</div><div class="line">    RemoteSenderService remoteSenderService = moduleManager.find(RemoteModule.NAME).getService(RemoteSenderService.class);</div><div class="line"></div><div class="line">    Graph&lt;ServiceReference&gt; graph = GraphManager.INSTANCE.createIfAbsent(SERVICE_REFERENCE_GRAPH_ID, ServiceReference.class);</div><div class="line">    graph.addNode(<span class="keyword">new</span> ServiceReferenceAggregationWorker.Factory(moduleManager, queueCreatorService).create(workerCreateListener))</div><div class="line">        .addNext(<span class="keyword">new</span> ServiceReferenceRemoteWorker.Factory(moduleManager, remoteSenderService, SERVICE_REFERENCE_GRAPH_ID).create(workerCreateListener))</div><div class="line">        .addNext(<span class="keyword">new</span> ServiceReferencePersistenceWorker.Factory(moduleManager, queueCreatorService).create(workerCreateListener));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªæ–¹æ³•çš„å…·ä½“ä»£ç å®ç°ã€‚</p><hr><p><strong>ç¬¬ä¸€æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/GraphManager.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>GraphManager#createIfAbsent(graphId, input)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Graph å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° Graph æ˜ å°„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>INSTANCE</code> å±æ€§ï¼Œå•ä¾‹ã€‚</li><li><code>allGraphs</code> å±æ€§ï¼ŒGraph æ˜ å°„ã€‚å…¶ä¸­æ˜ å°„çš„ KEY ä¸º<strong>æ¯ä¸ª</strong> Graph å…¨å±€å”¯ä¸€ç¼–å·ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/JvmMetricStreamGraph.java" rel="external nofollow noopener noreferrer" target="_blank">JvmMetricStreamGraph</a> ã€<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/RegisterStreamGraph.java" rel="external nofollow noopener noreferrer" target="_blank">RegisterStreamGraph</a> ã€<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/graph/TraceStreamGraph.java" rel="external nofollow noopener noreferrer" target="_blank">TraceStreamGraph</a> ç±»ä¸­ï¼Œæšä¸¾äº†å®é™…ä½¿ç”¨çš„ Graph ç¼–å·ä»¬ã€‚</li><li>ç¬¬ 50 è‡³ 58 è¡Œï¼šå½“ Graph æ˜ å°„é‡Œä¸å­˜åœ¨æŒ‡å®š Graph ç¼–å·æ—¶ï¼Œåˆ›å»º Graph å¯¹è±¡ï¼Œå¹¶è¿”å›ã€‚</li></ul><hr><p><strong>ç¬¬äºŒæ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Graph.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph#addNode(WayToNode)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Graph çš„<strong>é¦–ä¸ª</strong> Node å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>id</code> å±æ€§ï¼ŒGraph ç¼–å·ã€‚</li><li><code>entryWay</code>ï¼Œ<strong>é¦–ä¸ª</strong>æäº¤æ•°æ®ç»™ Node çš„æ–¹å¼ã€‚</li><li>ç¬¬ 58 è¡Œ ï¼šå°†æ–¹æ³•å‚æ•° <code>entryWay</code> èµ‹å€¼ç»™ <code>this.entryWay</code> å±æ€§ã€‚åœ¨ä¸‹åˆ†äº«çš„ <code>Graph#start(input)</code> æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ˜¯ Graph å¯åŠ¨çš„å…¥å£ï¼Œ<strong>é¦–ä¸ª</strong>æäº¤ç»™ Node çš„æ–¹å¼ã€‚</li><li>ç¬¬ 60 è‡³ 62 è¡Œ ï¼šè°ƒç”¨ <code>WayToNode#buildDestination(Graph)</code> æ–¹æ³•ï¼Œåˆ›å»º Node å¯¹è±¡ï¼Œå¹¶<strong>è¿”å›è¯¥ Node</strong> ã€‚åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯´è¿‡åˆ›å»ºçš„ Node å¯¹è±¡ï¼Œä¸ºè¯¥ Graph çš„<strong>é¦–ä¸ª</strong> Node ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/WayToNode.java#L41" rel="external nofollow noopener noreferrer" target="_blank"><code>WayToNode#buildDestination()</code></a> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ <strong>WayToNode</strong> çš„ Node å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>destination</code> å±æ€§ï¼Œç›®æ ‡ Node ã€‚å³è¯¥ WayToNode æäº¤<strong>æ•°æ®</strong>åˆ°çš„ Node ã€‚</li><li><code>destinationHandler</code> å±æ€§ï¼Œç›®æ ‡ Node çš„å¤„ç†å™¨ã€‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/WayToNode.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#out(INPUT)</code></a> æ–¹æ³•ã€‚</li><li>ç¬¬ 42 è¡Œï¼šåˆ›å»º Node å¯¹è±¡ã€‚<ul><li>ç›®å‰ï¼Œ<code>destinationHandler</code> å±æ€§ï¼Œé™¤äº†ç”¨äºåˆ›å»º Node å¯¹è±¡ï¼Œæ— å…¶ä»–ç”¨é€”ã€‚</li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Node.java#L40" rel="external nofollow noopener noreferrer" target="_blank">Node <code>æ„é€ æ–¹æ³•</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeProcessor</code> å±æ€§ï¼ŒèŠ‚ç‚¹å¤„ç†å™¨ã€‚</li><li><code>next</code> å±æ€§ï¼ŒåŒ…å« WayToNode æ•°ç»„ï¼Œå³ Node æäº¤æ•°æ®ç»™ Next çš„ Node æ•°ç»„çš„æ–¹å¼ã€‚</li><li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨ <code>Graph#checkForNewNode(Node)</code> æ–¹æ³•ï¼Œæ ¡éªŒ Node çš„ NodeProcessor åœ¨å…¶ Graph é‡Œï¼Œ<strong>ç¼–å·å”¯ä¸€</strong>ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Graph.java#L71" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph#checkForNewNode(Node)</code></a> æ–¹æ³•ï¼Œæ ¡éªŒ Node çš„ NodeProcessor åœ¨ Graph é‡Œï¼Œ<strong>ç¼–å·å”¯ä¸€</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>nodeIndex</code> å±æ€§ï¼Œå¤„ç†å™¨ç¼–å·ä¸ Node çš„æ˜ å°„ã€‚å…¶ä¸­æ˜ å°„çš„ KEY ä¸º <code>NodeProcessor#id()</code> ã€‚</li><li>ç¬¬ 72 è‡³ 78 è¡Œï¼šæ ¡éªŒ Node çš„ NodeProcessor åœ¨ Graph é‡Œï¼Œ<strong>ç¼–å·å”¯ä¸€</strong>ã€‚</li></ul><hr><p><strong>ç¬¬ä¸‰æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Node.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>Node#addNext(WayToNode)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Node çš„ä¸‹ä¸€ä¸ª Node å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 54 è¡Œï¼šè°ƒç”¨ <code>WayToNode#buildDestination(Graph)</code> æ–¹æ³•ï¼Œåˆ›å»ºè¯¥ Node çš„ä¸‹é¢çš„ Node å¯¹è±¡ã€‚</li><li>ç¬¬ 56 è¡Œï¼šæ·»åŠ åˆ›å»ºçš„ Node å¯¹è±¡åˆ° <code>next</code> å±æ€§ã€‚</li><li>ç¬¬ 58 è¡Œï¼šè¿”å›åˆ›å»ºçš„ Node å¯¹è±¡ã€‚</li></ul><h2>2.2 Graph å¯åŠ¨</h2><p>åˆ›å»º Graph çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/08.png" alt=""></p><table><thead><tr><th>æ•°æ®æµå‘</th><th>FROM</th><th>TO</th><th>é€»è¾‘</th></tr></thead><tbody><tr><td>ç¬¬ä¸€æ­¥</td><td>Graph</td><td>WayToNode</td><td></td></tr><tr><td>ç¬¬äºŒæ­¥</td><td>WayToNode</td><td>Node</td><td></td></tr><tr><td>ç¬¬ä¸‰æ­¥</td><td>Node</td><td>NodeProcessor</td><td></td></tr><tr><td>ç¬¬å››æ­¥</td><td>NodeProcessor</td><td>Next</td><td>æ ¹æ®å…·ä½“å®ç°ï¼Œè‹¥åˆ° Next ï¼Œé‡å¤ç¬¬ä¸€æ­¥</td></tr></tbody></table><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/09.png" alt=""></p><hr><p><strong>ç¬¬ä¸€æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Graph.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>Graph#start(input)</code></a> æ–¹æ³•ï¼Œå¯åŠ¨ Graph ï¼Œå¤„ç†æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 49 è¡Œï¼šè°ƒç”¨ <code>WayToNode#in(input)</code> æ–¹æ³•ï¼Œè¾“å…¥æ•°æ®ç»™ WayToNode ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/WayToNode.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>WayToNode#in(input)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œä»¥ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/DirectWay.java#L29" rel="external nofollow noopener noreferrer" target="_blank"><code>DirectWay#in(input)</code></a> <strong>å®ç°</strong>æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨ <code>super#out(input)</code> æ–¹æ³•ï¼Œ<strong>ç›´æ¥</strong>è¾“å‡ºæ•°æ®ï¼Œè°ƒç”¨ <code>Node#execute(input)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®ç»™ Node ï¼Œè¿›è¡Œå¤„ç†ã€‚</li></ul><hr><p><strong>ç¬¬äºŒæ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Node.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>Node#execute</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>NodeProcessor#process(input, next)</code> æ–¹æ³•ï¼Œå¤„ç†æ•°æ®ã€‚</p><hr><p><strong>ç¬¬ä¸‰æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/NodeProcessor.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>NodeProcessor#process(input, next)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œä»¥ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorker.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>AbstractWorker#process(input, next)</code></a> <strong>å®ç°</strong>æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 64 è¡Œï¼šå°†æ–¹æ³•å‚æ•° <code>next</code> èµ‹å€¼ç»™ <code>this.next</code> å±æ€§ã€‚<code>this.next</code> å±æ€§ï¼Œç”¨äºå°è£…çš„ <code>#onNext(OUTPUT)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®ç»™å½“å‰ Node çš„ Next ( ä¸‹é¢çš„ Node ä»¬ )ç»§ç»­å¤„ç†æ•°æ®ã€‚</li><li>ç¬¬ 67 è¡Œï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorker.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#onWork</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå¤„ç†æ•°æ®ã€‚å½“ AbstractWorker <strong>æŠ½è±¡ç±»</strong>çš„å®ç°ç±»éœ€è¦ç»§ç»­è®²æ•°æ®æäº¤ç»™ Next æ—¶ï¼Œéœ€è¦åœ¨ <code>#onWork</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>#onNext(OUTPUT)</code> æ–¹æ³•ï¼Œä¾‹å¦‚ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationRegisterRemoteWorker#onWork(Application)</code></a> ã€‚</li></ul><hr><p><strong>ç¬¬å››æ­¥</strong></p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/graph/Next.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>Next#execute(INPUT)</code></a> æ–¹æ³•ï¼Œ<strong>å¾ªç¯</strong> WayToNode æ•°ç»„ï¼Œè¾“å…¥æ•°æ®ç»™ WayNode ï¼Œç›¸å½“äº&quot;<strong>é‡å›</strong>&quot;ã€ç¬¬ä¸€æ­¥ã€‘ã€‚</p><h1>3. apm-collector-stream</h1><p>åœ¨æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬æåˆ°äº† <code>apm-collector-stream</code> æ¨¡å—ï¼Œåœ¨ <code>graph</code> åŒ…çš„åŸºç¡€ä¸Šï¼Œæä¾›<strong>å¼‚æ­¥</strong>ã€<strong>è·¨èŠ‚ç‚¹</strong>ç­‰ç­‰çš„æµå¼å¤„ç†çš„å°è£…ã€‚ä¸»è¦åœ¨ WayToNode ã€NodeProcessor çš„å®ç°ç±»ä¸Šåšæ–‡ç« ã€‚</p><h2>3.1 WayToNode å®ç°ç±»</h2><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/10.png" alt=""></p><h3>3.1.1 WorkerRef</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/WorkerRef.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.WorkerRef</code></a> ï¼ŒWorker å¼•ç”¨<strong>æŠ½è±¡ç±»</strong>ã€‚</p><p>åœ¨ <code>apm-collector-stream</code> æ¨¡å—é‡Œï¼Œæˆ‘ä»¬ä¼šå‘ç°ç±»çš„å‘½åä» Node / NodeProcessor è½¬å‘äº† Worker ï¼Ÿ<strong>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢</strong>ï¼Ÿå…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç‰¹æ„<s>é‡‡è®¿</s>( è¯·æ•™ )äº†å®˜æ–¹å¤§ä½¬ã€‚</p><blockquote><p>Worker æ›´å…·ä¸šåŠ¡å«ä¹‰<br>Node / Processor æ›´åæŠ€æœ¯å«ä¹‰</p></blockquote><p>ç›®å‰ï¼ŒWorkerRef æ— å…·ä½“çš„æ–¹æ³•ã€‚</p><h3>3.1.2 LocalAsyncWorkerRef</h3><p><code>org.skywalking.apm.collector.stream.worker.base.LocalAsyncWorkerRef</code> ï¼Œå¼‚æ­¥ Worker å¼•ç”¨<strong>å®ç°ç±»</strong>ï¼Œæä¾›äº†<strong>å¼‚æ­¥</strong>çš„æµå¼å¤„ç†å°è£…ã€‚</p><p>æˆ‘ä»¬å›åˆ° <a href="#">ã€Œ2.2 Graph åˆ›å»ºã€</a> çš„ã€ç¬¬ä¸€æ­¥ã€‘ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/LocalAsyncWorkerRef.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>LocalAsyncWorkerRef#in(INPUT)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/LocalAsyncWorkerRef.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>queueEventHandler</code></a> å±æ€§ï¼Œé˜Ÿåˆ—äº‹ä»¶å¤„ç†å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶ã€‹</a> æˆ‘ä»¬ä¼šè¯¦ç»†è§£æå®ƒçš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªç®€å•ä»‹ç»ä¸‹ã€‚</li><li>ç¬¬ 47 è¡Œï¼šå°†è¾“å…¥çš„æ•°æ®ï¼Œä½œä¸º&quot;<strong>äº‹ä»¶</strong>&quot;ï¼Œæäº¤åˆ°é˜Ÿåˆ—äº‹ä»¶å¤„ç†å™¨ä¸­ï¼Œä¸å†æ‰§è¡Œåç»­é€»è¾‘ã€‚æ­¤åï¼Œé˜Ÿåˆ—äº‹ä»¶å¤„ç†å™¨ï¼Œä¼šåœ¨<strong>åå°</strong>å¤„ç†åˆ°è¯¥&quot;<strong>äº‹ä»¶</strong>&quot;( æ•°æ® )ï¼Œå›è°ƒ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/LocalAsyncWorkerRef.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>LocalAsyncWorkerRef#execute</code></a> æ–¹æ³•ï¼Œä»è€Œæäº¤æ•°æ®åˆ° Worker ( Node )ã€‚è¯¦ç»†å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorEventHandler.java#L54" rel="external nofollow noopener noreferrer" target="_blank">DisruptorEventHandler#onEvent(...)</a> æ–¹æ³•ã€‚</li></ul><p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå›è°ƒå‘¢</strong>ï¼ŸLocalAsyncWorkerRef å®ç°äº† <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/QueueExecutor.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.base.QueueExecutor</code></a> æ¥å£ï¼Œå®ƒè‡ªèº«è¢«è®¾ç½®åˆ° QueueEventHandler ä¸­ï¼Œ ä½œä¸º&quot;<strong>äº‹ä»¶</strong>&quot;çš„æ‰§è¡Œå™¨ã€‚</p><p>æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/11.png" alt=""></p><h3>3.1.3 RemoteWorkerRef</h3><p><code>org.skywalking.apm.collector.stream.worker.base.RemoteWorkerRef</code> ï¼Œè¿œç¨‹ Worker å¼•ç”¨<strong>å®ç°ç±»</strong>ï¼Œæä¾›äº†<strong>è¿œç¨‹è·¨èŠ‚ç‚¹</strong>çš„æµå¼å¤„ç†çš„å°è£…ã€‚</p><p>æˆ‘ä»¬å†å›åˆ° <a href="#">ã€Œ2.2 Graph åˆ›å»ºã€</a> çš„ã€ç¬¬ä¸€æ­¥ã€‘ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/RemoteWorkerRef.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteWorkerRef#in(INPUT)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li><code>remoteSenderService</code> å±æ€§ï¼Œè¿œç¨‹å‘é€æœåŠ¡ã€‚åœ¨ <a href="todo">TODOã€4005ã€‘</a> æˆ‘ä»¬ä¼šè¯¦ç»†è§£æå®ƒçš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªç®€å•ä»‹ç»ä¸‹ã€‚</li><li><code>remoteWorker</code> å±æ€§ï¼Œè¿œç¨‹ Worker ã€‚åœ¨ä¸‹æ–‡ä¼šè¯¦ç»†åˆ†äº«å®ƒçš„å®ç°ã€‚</li><li>ç¬¬ 56 è¡Œï¼šè°ƒç”¨ <code>RemoteSenderService#send(...)</code> æ–¹æ³•ï¼Œæ ¹æ®è¿œç¨‹ Worker çš„ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/Selector.java" rel="external nofollow noopener noreferrer" target="_blank">Selector é€‰æ‹©å™¨</a>ï¼Œé€‰æ‹©ä¸€ä¸ª Worker è¿›è¡Œå‘é€ã€‚</li><li>ç¬¬ 58 è‡³ 60 è¡Œï¼šå½“é€‰æ‹©çš„ Worker ä¸ºæœ¬åœ°æ¨¡å¼( <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-remote/collector-remote-define/src/main/java/org/skywalking/apm/collector/remote/service/RemoteSenderService.java#L36" rel="external nofollow noopener noreferrer" target="_blank">Mode</a> )æ—¶ï¼Œè°ƒç”¨ <code>#out(INPUT)</code> æ–¹æ³•ï¼Œæäº¤æ•°æ®åˆ°æœ¬åœ°çš„ Worker ( Node )ã€‚</li></ul><h2>3.2 NodeProcessor å®ç°ç±»</h2><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/12.png" alt=""></p><ul><li><a href="todo"><code>org.skywalking.apm.collector.stream.worker.base.Provider</code></a> ï¼ŒWorker ä¾›åº”è€…<strong>æ¥å£</strong>ï¼Œç”¨äºåˆ›å»º Worker å’Œ WorkerRef å¯¹è±¡çš„<strong>å·¥å‚</strong>ã€‚</li></ul><h3>3.2.1 AbstractWorker</h3><p>AbstractWorker çš„ä»£ç å®ç°ï¼Œåœ¨ <a href="#">ã€Œ2.2 Graph å¯åŠ¨ã€</a> å·²ç»è¯¦ç»†è§£æã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorkerProvider.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.AbstractWorkerProvider</code></a> ï¼ŒWorker ä¾›åº”è€…<strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractWorkerProvider.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#workerInstance(ModuleManager)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œç”¨äºåˆ›å»º Worker å¯¹è±¡ã€‚</p><h3>3.2.2 AbstractLocalAsyncWorker</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractLocalAsyncWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.AbstractLocalAsyncWorker</code></a> ï¼Œå¼‚æ­¥ Worker <strong>æŠ½è±¡ç±»</strong>ã€‚</p><p>ç›®å‰ï¼ŒAbstractLocalAsyncWorker æ— å…·ä½“çš„æ–¹æ³•ã€‚</p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker ç±»ï¼Œå®ç° <code>#work(INPUT)</code> æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L56" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterSerialWorker</a> ã€‚</p><hr><p><code>org.skywalking.apm.collector.stream.worker.base.AbstractLocalAsyncWorkerProvider</code> ï¼ŒLocalAsyncWorker ä¾›åº”è€…<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractLocalAsyncWorkerProvider.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>queueCreatorService</code></a> å±æ€§ï¼Œé˜Ÿåˆ—åˆ›å»ºæœåŠ¡ï¼Œç”¨äºåˆ›å»º QueueEventHandler å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractLocalAsyncWorkerProvider.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#queueSize()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå£°æ˜é˜Ÿåˆ—å¤§å°ã€‚</li><li><a href=""><code>#create(WorkerCreateListener)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º AbstractLocalAsyncWorker å’Œ LocalAsyncWorkerRef å¯¹è±¡ã€‚<ul><li>ç¬¬ 51 è¡Œï¼šåˆ›å»º AbstractLocalAsyncWorker <strong>å®ç°ç±»</strong>çš„å¯¹è±¡ã€‚å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterSerialWorker.java#L90" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterSerialWorker.Factory#workerInstance(ModuleManager)</a> æ–¹æ³•ã€‚</li><li>ç¬¬ 54 è¡Œï¼šæ·»åŠ  AbstractLocalAsyncWorker åˆ° WorkerCreateListener ( Worker åˆ›å»ºç›‘å¬å™¨ )ã€‚WorkerCreateListener åœ¨ <a href="todo">TODO ã€4006ã€‘</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 57 è¡Œï¼šåˆ›å»º LocalAsyncWorkerRef å¯¹è±¡ã€‚</li><li>ç¬¬ 60 è¡Œï¼šè°ƒç”¨ <code>QueueCreatorService#create(...)</code> æ–¹æ³•ï¼Œåˆ›å»º QueueEventHandler å¯¹è±¡ï¼Œ<strong>å¹¶è®¾ç½® LocalAsyncWorkerRef ä½œä¸ºå®ƒçš„æ‰§è¡Œå™¨</strong>ã€‚</li><li>ç¬¬ 63 è¡Œï¼šè®¾ç½® LocalAsyncWorkerRef çš„ QueueEventHandler å±æ€§ã€‚</li></ul></li></ul><h3>3.2.3 AbstractRemoteWorker</h3><p><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.stream.worker.base.AbstractRemoteWorker</code></a> ï¼Œè¿œç¨‹ Worker <strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorker.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>#selector()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—é€‰æ‹©å™¨ã€‚RemoteSenderService æ ¹æ®é€‰æ‹©å™¨ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/service/selector/RemoteClientSelector.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteClientSelector#select(...)</code></a> æ–¹æ³•ï¼Œé€‰æ‹©å¥½è¿œç¨‹èŠ‚ç‚¹ï¼Œè€Œåè¿›è¡Œå‘é€æ•°æ®ã€‚</p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œç»§æ‰¿ AbstractLocalAsyncWorker ç±»ï¼Œå®ç° <code>#work(INPUT)</code> æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterRemoteWorker</a> ã€‚</p><hr><p><code>org.skywalking.apm.collector.stream.worker.base.AbstractRemoteWorkerProvider</code> ï¼ŒAbstractRemoteWorker ä¾›åº”è€…<strong>æŠ½è±¡ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorkerProvider.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>remoteSenderService</code></a> å±æ€§ï¼Œè¿œç¨‹å‘é€æœåŠ¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-stream/src/main/java/org/skywalking/apm/collector/stream/worker/base/AbstractRemoteWorkerProvider.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(WorkerCreateListener)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º AbstractRemoteWorker å’Œ RemoteWorkerRef å¯¹è±¡ã€‚<ul><li>ç¬¬ 58 è¡Œï¼šåˆ›å»º AbstractRemoteWorker <strong>å®ç°ç±»</strong>çš„å¯¹è±¡ã€‚å‚è§ <a href="https://github.com/YunaiV/skywalking/blob/a0d559d08e87879a08bd7269b9651188083ce05e/apm-collector/apm-collector-agent-stream/collector-agent-stream-provider/src/main/java/org/skywalking/apm/collector/agent/stream/worker/register/ApplicationRegisterRemoteWorker.java#L61" rel="external nofollow noopener noreferrer" target="_blank">ApplicationRegisterRemoteWorker.Factory#workerInstance(ModuleManager)</a> æ–¹æ³•ã€‚</li><li>ç¬¬ 61 è¡Œï¼šæ·»åŠ  AbstractLocalAsyncWorker åˆ° WorkerCreateListener ( Worker åˆ›å»ºç›‘å¬å™¨ )ã€‚WorkerCreateListener åœ¨ <a href="todo">TODO ã€4006ã€‘</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 64 è¡Œï¼šåˆ›å»º RemoteWorkerRef å¯¹è±¡ã€‚</li></ul></li></ul><h1>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œè›®å—¨çš®çš„ã€‚å¡äº†ä¸€ä¸ªå‘¨æœ«ï¼Œå·®ç‚¹åˆå •è½äº†ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_20/13.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-streaming-first/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyW
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-queue-module/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-queue-module/</id>
    <published>2020-08-14T16:00:00.000Z</published>
    <updated>2017-12-21T13:53:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-queue-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2. collector-queue-define</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2.1 QueueModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2.2 QueueCreatorService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2.3 MessageHolder</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2.4 QueueEventHandler</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2.5 DaemonThreadFactory</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">3. collector-queue-disruptor-provider</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">3.1 QueueModuleDisruptorProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">2.2 DisruptorQueueCreatorService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">3.3 DisruptorEventHandler</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">4. collector-queue-datacarrier-provider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Queue Module</strong>ï¼Œé˜Ÿåˆ—ç»„ä»¶ã€‚è¯¥ç»„ä»¶è¢« Collector Streaming Module æµå¼å¤„ç†ä½¿ç”¨ï¼Œæä¾›<strong>å¼‚æ­¥</strong>æ‰§è¡Œçš„ç‰¹æ€§ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šå»ºè®®å…ˆé˜…è¯» <a href="http://www.iocoder.cn/SkyWalking/collector-init/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector åˆå§‹åŒ–ã€‹</a> ï¼Œä»¥äº†è§£ Collector ç»„ä»¶ä½“ç³»ã€‚</p></blockquote><p>Cluster Module åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/02.png" alt=""></p><ul><li><code>collector-queue-define</code> ï¼šå®šä¹‰é˜Ÿåˆ—ç»„ä»¶æ¥å£ã€‚</li><li><code>collector-queue-datacarrier-provider</code> ï¼šåŸºäº <a href="https://github.com/YunaiV/skywalking/tree/master/apm-commons/apm-datacarrier" rel="external nofollow noopener noreferrer" target="_blank">apm-datacarrier</a> çš„é˜Ÿåˆ—ç»„ä»¶å®ç°ã€‚<em>ç›®å‰æš‚æœªå®Œæˆ</em>ã€‚</li><li><code>collector-queue-zookeeper-provider</code> ï¼šåŸºäº <a href="https://github.com/LMAX-Exchange/disruptor" rel="external nofollow noopener noreferrer" target="_blank">Disruptor</a> çš„é˜Ÿåˆ—ç»„ä»¶å®ç°ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1>2. collector-queue-define</h1><p><code>collector-queue-define</code> ï¼šå®šä¹‰é˜Ÿåˆ—ç»„ä»¶æ¥å£ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/03.png" alt=""></p><h2>2.1 QueueModule</h2><p><code>org.skywalking.apm.collector.queue.QueueModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼Œé˜Ÿåˆ— Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/QueueModule.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;queue&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/QueueModule.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šQueueCreatorService ã€‚</p><h2>2.2 QueueCreatorService</h2><p><code>org.skywalking.apm.collector.queue.service.QueueCreatorService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œé˜Ÿåˆ—åˆ›å»ºæœåŠ¡<strong>æ¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/service/QueueCreatorService.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(queueSize, executor)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ›å»ºé˜Ÿåˆ—å¤„ç†å™¨ã€‚</p><ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ç°è¯¥æ¥å£æ–¹æ³•ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/QueueCreator.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.base.QueueCreator#create(queueSize, executor)</code></a> æ–¹æ³•ï¼Œåˆ›å»ºé˜Ÿåˆ—å¤„ç†å™¨ã€‚</li></ul><h2>2.3 MessageHolder</h2><p><code>org.skywalking.apm.collector.queue.base.MessageHolder</code> ï¼Œæ¶ˆæ¯æŒæœ‰è€…ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/MessageHolder.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>message</code></a> å±æ€§ï¼ŒæŒæœ‰çš„æ¶ˆæ¯ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/MessageHolder.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#reset()</code></a> æ–¹æ³•ï¼Œ<strong>æ¸…ç©º</strong>æ¶ˆæ¯ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä¸‹æ–‡èƒ–å‹ä¼šçœ‹åˆ°ã€‚</li></ul><h2>2.4 QueueEventHandler</h2><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/QueueEventHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.base.QueueEventHandler</code></a>ï¼Œé˜Ÿåˆ—å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚å®ƒå®šä¹‰äº† <a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/QueueEventHandler.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#tell(message)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè¾“å…¥æ¶ˆæ¯ç»™è‡ªå·±ã€‚æœ€ç»ˆï¼ŒQueueEventHandler ä¼š&quot;<strong>æäº¤</strong>&quot;æ¶ˆæ¯ç»™ <a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/QueueExecutor.java#L28" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.base.QueueExecutor</code></a>ï¼Œæ‰§è¡Œå¤„ç†è¯¥æ¶ˆæ¯ã€‚</p><p>LocalAsyncWorkerRef å®ç° QueueEventHandler æ¥å£ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-streaming-first/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Streaming Computing æµå¼å¤„ç†ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.1.2 LocalAsyncWorkerRefã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2>2.5 DaemonThreadFactory</h2><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-define/src/main/java/org/skywalking/apm/collector/queue/base/DaemonThreadFactory.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.base.DaemonThreadFactory</code></a>ï¼Œå®ˆæŠ¤è¿›ç¨‹çº¿ç¨‹<strong>å·¥å‚</strong>ï¼Œè¢«ç”¨äºåˆ›å»ºæ¶ˆæ¯å¤„ç†å™¨çš„çº¿ç¨‹ã€‚</p><h1>3. collector-queue-disruptor-provider</h1><p><code>collector-queue-disruptor-provider</code> ï¼ŒåŸºäº <a href="https://github.com/LMAX-Exchange/disruptor" rel="external nofollow noopener noreferrer" target="_blank">Disruptor</a> çš„é˜Ÿåˆ—ç»„ä»¶å®ç°ã€‚</p><p>é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/04.png" alt=""></p><p><strong>é»˜è®¤é…ç½®</strong>ï¼Œåœ¨ <a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-core/src/main/resources/application-default.yml#L7" rel="external nofollow noopener noreferrer" target="_blank"><code>application-default.yml</code></a> <strong>å·²ç»</strong>é…ç½®å¦‚ä¸‹ï¼š</p><p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">queue:</div><div class="line">  disruptor:</div></pre></td></tr></table></figure></p><h2>3.1 QueueModuleDisruptorProvider</h2><p><code>org.skywalking.apm.collector.queue.disruptor.CQueueModuleDisruptorProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº Disruptor çš„é˜Ÿåˆ—æœåŠ¡æä¾›è€…ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/QueueModuleDisruptorProvider.java#L35" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;disruptor&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/QueueModuleDisruptorProvider.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º QueueModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/QueueModuleDisruptorProvider.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸ºç©ºã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/QueueModuleDisruptorProvider.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 44 è¡Œ ï¼šåˆ›å»º DisruptorQueueCreatorService å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation()</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/QueueModuleDisruptorProvider.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ–¹æ³•ä¸ºç©ºã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/QueueModuleDisruptorProvider.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ–¹æ³•ä¸ºç©ºã€‚</p><h2>2.2 DisruptorQueueCreatorService</h2><p><code>org.skywalking.apm.collector.queue.disruptor.service.DisruptorQueueCreatorService</code> ï¼Œå®ç° QueueCreatorService <strong>æ¥å£</strong>ï¼ŒåŸºäº Disruptor çš„é˜Ÿåˆ—åˆ›å»ºæœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/service/DisruptorQueueCreatorService.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(queueSize, executor)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>DisruptorQueueCreator#register(queueSize, executor)</code> æ–¹æ³•ï¼Œåˆ›å»ºé˜Ÿåˆ—å¤„ç†å™¨ã€‚</p><h3>3.2.1 DisruptorQueueCreator</h3><blockquote><p>å‹æƒ…æç¤ºï¼šå¦‚æœèƒ–å‹å¯¹ Disruptor æš‚æ—¶ä¸äº†è§£ï¼Œå»ºè®®å…ˆä½¿ç”¨ Disruptor å†™ä¸ªå° Demo ã€‚</p><p>å¦‚ä¸‹æ˜¯ç¬”è€…é˜…è¯»çš„æ–‡ç« ï¼š</p><ul><li><a href="http://colobu.com/2014/08/01/3-steps-to-create-a-disruptor-application/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸‰æ­¥åˆ›å»ºDisruptoråº”ç”¨ã€‹</a></li><li><a href="http://ifeve.com/disruptor-getting-started/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDisruptorå…¥é—¨ã€‹</a></li><li><a href="http://ifeve.com/dissecting-disruptor-whats-so-special/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå‰–æDisruptor:ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆå¿«ï¼Ÿï¼ˆä¸€ï¼‰Ringbufferçš„ç‰¹åˆ«ä¹‹å¤„ã€‹</a></li></ul></blockquote><p><code>org.skywalking.apm.collector.queue.disruptor.base.DisruptorQueueCreator</code> ï¼Œå®ç° QueueCreator <strong>æ¥å£</strong>ï¼ŒåŸºäº Disruptor çš„é˜Ÿåˆ—åˆ›å»ºå™¨<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorQueueCreator.java#L41" rel="external nofollow noopener noreferrer" target="_blank"><code>#create(queueSize, executor)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 42 è‡³ 45 è¡Œï¼š<strong>æ ¡éªŒ</strong>é˜Ÿåˆ—å¤§å°ä¸º 2 çš„æŒ‡æ•°ï¼Œå¦åˆ™åˆ›å»º Disruptor å¯¹è±¡ä¼šæŠ¥ <code>&quot;bufferSize must be a power of 2&quot;</code> çš„å¼‚å¸¸ï¼Œå‚è§ <a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/AbstractSequencer.java#L50" rel="external nofollow noopener noreferrer" target="_blank">AbstractSequencer</a> çš„ä»£ç ã€‚</li><li>ç¬¬ 49 è¡Œï¼š<strong>åˆ›å»º</strong> Disruptor å¯¹è±¡ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/8b7205313e60e84d50579261992042c8b581492f/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/MessageHolderFactory.java#L29" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.queue.disruptor.base.MessageHolderFactory</code></a> ï¼ŒMessageHolder <strong>å·¥å‚</strong>ã€‚</li></ul></li><li>ç¬¬ 51 è‡³ 64 è¡Œï¼šè®¾ç½® Disruptor å¯¹è±¡çš„<strong>é»˜è®¤å¼‚å¸¸å¤„ç†å™¨</strong>ã€‚</li><li>ç¬¬ 67 è‡³ 70 è¡Œï¼šåˆ›å»º DisruptorEventHandler å¯¹è±¡ï¼Œå¹¶è®¾ç½®ä¸º Disruptor å¯¹è±¡çš„<strong>äº‹ä»¶å¤„ç†å™¨</strong>ã€‚</li><li>ç¬¬ 74 è¡Œï¼š<strong>å¯åŠ¨</strong> Disruptor å¯¹è±¡ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆ Disruptor è¦æ±‚é˜Ÿåˆ—å¤§å°ä¸º 2 çš„æŒ‡æ•°å‘¢</strong>ï¼Ÿå¦‚ä¸‹æ˜¯ç›¸å…³èµ„æ–™ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹( å¯è·³è¿‡ )ï¼š</p><ul><li>FROM <a href="https://zh.wikipedia.org/wiki/%E7%92%B0%E5%BD%A2%E7%B7%A9%E8%A1%9D%E5%8D%80#Linux.E5.86.85.E6.A0.B8.E7.9A.84kfifo" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç¯å½¢ç¼“å†²å™¨ã€‹</a></li></ul><blockquote><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/05.png" alt=""></p></blockquote><ul><li><code>SingleProducerSequencer#hasAvailableCapacity(requiredCapacity)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/06.png" alt=""></li></ul><h2>3.3 DisruptorEventHandler</h2><p><code>org.skywalking.apm.collector.queue.disruptor.base.DisruptorEventHandler</code> ï¼ŒåŸºäº Disruptor çš„é˜Ÿåˆ—å¤„ç†å™¨<strong>å®ç°ç±»</strong>ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/0feb6bce291fa945eff5bf52100c82c960851143/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorEventHandler.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>ringBuffer</code></a> å±æ€§ï¼ŒDisruptor RingBuffer å¯¹è±¡ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/0feb6bce291fa945eff5bf52100c82c960851143/apm-collector/apm-collector-queue/c%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0ollector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorEventHandler.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>executor</code></a> å±æ€§ï¼Œæ‰§è¡Œå™¨ã€‚</li><li>å®ç° <code>org.skywalking.apm.collector.queue.base.QueueEventHandler</code> <strong>æ¥å£</strong> çš„ <a href="https://github.com/YunaiV/skywalking/blob/0feb6bce291fa945eff5bf52100c82c960851143/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorEventHandler.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#tell(message)</code></a> æ¥å£æ–¹æ³•ï¼Œæ ‡å‡†çš„ Disruptor å‘å¸ƒäº‹ä»¶çš„ä»£ç ã€‚</li><li>å®ç° <a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/EventHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.lmax.disruptor.EventHandler</code></a> çš„ <a href="https://github.com/YunaiV/skywalking/blob/0feb6bce291fa945eff5bf52100c82c960851143/apm-collector/apm-collector-queue/collector-queue-disruptor-provider/src/main/java/org/skywalking/apm/collector/queue/disruptor/base/DisruptorEventHandler.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#onEvent(event, sequence, endOfBatch)</code></a> æ¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š<ul><li><code>endOfBatch</code> <strong>æ–¹æ³•å‚æ•°</strong>ï¼Œæ ‡è®°è¯¥äº‹ä»¶( æ¶ˆæ¯ )æ˜¯å¦æ˜¯ Disruptor <strong>æ¯æ¬¡æ‰¹å¤„ç†</strong>çš„æœ€åä¸€ä¸ªäº‹ä»¶ã€‚èƒ–å‹å¯ä»¥å‚è§ <a href="https://stackoverflow.com/questions/33716825/lmax-disruptor-what-determines-the-batch-size" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠLMAX Disruptor - what determines the batch size?ã€‹</a> è¿™ç¯‡æ–‡ç« ï¼Œè‡ªå·±æ­å»ºä¸€ä¸ª Demo ç†è§£ä¸‹è¯¥å‚æ•°ã€‚</li><li>ç¬¬ 66 è¡Œï¼šè°ƒç”¨ <code>MessageHolder#reset()</code> æ–¹æ³•ï¼Œæ¸…ç©ºæ¶ˆæ¯ï¼Œå› ä¸ºåœ¨ Disruptor RingBuffer é‡Œï¼Œäº‹ä»¶( æ¶ˆæ¯ )å¯¹è±¡æ˜¯<strong>é‡ç”¨</strong>çš„ï¼Œè™½ç„¶åç»­å‘å¸ƒäº‹ä»¶( æ¶ˆæ¯ )å¯ä»¥è¿›è¡Œ<strong>è¦†ç›–</strong>ï¼Œè€ƒè™‘åˆ°å®‰å…¨æ€§è¿›è¡Œæ¸…ç©ºã€‚</li><li>ç¬¬ 69 è¡Œï¼šè®¾ç½®æ¶ˆæ¯ä¸ºè¯¥æ‰¹é‡çš„ç»“å°¾( æœ€åä¸€æ¡ )ã€‚<strong>ä¸ºä»€ä¹ˆ</strong>ï¼Ÿåœ¨ <a href="">ã€ŠTODO ã€4006ã€‘ã€‹</a> æ­æ™“ç­”æ¡ˆã€‚</li><li>ç¬¬ 72 è¡Œï¼šè°ƒç”¨ <code>QueueExecutor#execute(message)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå¤„ç†æ¶ˆæ¯ã€‚</li></ul></li></ul><h1>4. collector-queue-datacarrier-provider</h1><p><code>collector-queue-datacarrier-provider</code> ï¼šåŸºäº <a href="https://github.com/YunaiV/skywalking/tree/master/apm-commons/apm-datacarrier" rel="external nofollow noopener noreferrer" target="_blank">apm-datacarrier</a> çš„é˜Ÿåˆ—ç»„ä»¶å®ç°ã€‚</p><p><em>ç›®å‰æš‚æœªå®Œæˆ</em>ã€‚</p><h1>666. å½©è›‹</h1><p>åœ¨åœ°é“é‡Œï¼Œå¤¹ç¼ä¸­å†™ä»£ç ( ğŸ˜ˆ å½“ç„¶æœ‰åº§ä½ )ã€‚</p><p>ä¸å®¹æ˜“ï¼Œå›å®¶çœ‹ã€Šèœ˜è››ä¾ ã€‹ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_15/07.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-queue-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyWalk
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Naming Server å‘½åæœåŠ¡</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-naming-server/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-naming-server/</id>
    <published>2020-08-09T16:00:00.000Z</published>
    <updated>2017-12-15T11:36:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-naming-server/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">2. Collector Naming Server</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">2.1 NamingModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">2.2 NamingModuleJettyProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">2.3 NamingHandlerRegisterService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">2.4 é…ç½®æ–‡ä»¶</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">3. CollectorDiscoveryService</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">3.1 CollectorDiscoveryService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">3.2 é…ç½®æ–‡ä»¶</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-naming-server/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Collector Naming Server å‘½åæœåŠ¡</strong>ã€‚ä¸»è¦åŒ…å«å¦‚ä¸‹éƒ¨åˆ†ï¼š</p><ul><li>Collector Naming Server æä¾› Http ä¸¤ä¸ªæ¥å£ï¼Œæä¾› Agent <strong>åˆ†åˆ«</strong>æŸ¥è¯¢ Collector Agent Jetty Server ã€Collector Agent gRPC Server é›†ç¾¤ã€‚</li><li>Collector Agent Jetty Server ã€Collector Agent gRPC Server é›†ç¾¤å†…éƒ¨çš„æ³¨å†Œä¸å‘ç°ã€‚</li></ul><blockquote><p>å‹æƒ…æç¤ºï¼Œå»ºè®®èƒ–å‹å·²ç»è¯»è¿‡ <a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module//?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶ã€‹</a> ã€<a href="http://www.iocoder.cn/SkyWalking/collector-server-component/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶ã€‹</a></p></blockquote><p>Collector Agent Server ( åŒ…æ‹¬ Jetty å’Œ gRPC )ï¼Œæä¾›ä¸Šä¼ è°ƒç”¨é“¾è·¯ï¼ŒJVM Metric ç­‰ç­‰ API ç»™ Agent è°ƒç”¨ã€‚<br>Agent é€šè¿‡ Collector Naming Server è°ƒç”¨ Collector Agent Server çš„ API ï¼ŒæŸ¥è¯¢ Collector Agent Server <strong>æœ€æ–°</strong>çš„é›†ç¾¤åœ°å€ã€‚</p><p>Naming Server åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_10/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_10/02.png" alt=""></p><h1>2. Collector Naming Server</h1><p>Collector Naming Server é€šè¿‡ <code>apm-collector-naming</code> é¡¹ç›®å®ç°ï¼Œå…¶ä¸­ï¼š</p><ul><li><code>collector-naming-define</code> é¡¹ç›®ï¼šå®šä¹‰äº† Naming Server çš„æ¥å£ã€‚</li><li><code>collector-naming-jetty-provider</code> é¡¹ç›®ï¼šåŸºäº Jetty Server çš„ Naming Server å®ç°ã€‚</li></ul><h2>2.1 NamingModule</h2><p><code>org.skywalking.apm.collector.cluster.ClusterModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼Œé›†ç¾¤ç®¡ç† Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-define/src/main/java/org/skywalking/apm/collector/naming/NamingModule.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;naming&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-define/src/main/java/org/skywalking/apm/collector/naming/NamingModule.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šNamingHandlerRegisterService ã€‚</p><h2>2.2 NamingModuleJettyProvider</h2><p><code>org.skywalking.apm.collector.naming.jetty.NamingModuleJettyProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº Jetty çš„å‘½åç»„ä»¶æœåŠ¡æä¾›è€…å®ç°ç±»ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-jetty-provider/src/main/java/org/skywalking/apm/collector/naming/jetty/NamingModuleJettyProvider.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;jetty&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-jetty-provider/src/main/java/org/skywalking/apm/collector/naming/jetty/NamingModuleJettyProvider.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º NamingModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸º ClusterModule ã€JettyManagerModuleã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 55 è¡Œ ï¼šåˆ›å»º ZookeeperModuleListenerService / NamingJettyHandlerRegisterService å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation()</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-jetty-provider/src/main/java/org/skywalking/apm/collector/naming/jetty/NamingModuleJettyProvider.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 65 è¡Œ ï¼šè°ƒç”¨ <code>JettyManagerService#createIfAbsent(host, port, contextPath)</code> æ–¹æ³•ï¼Œåˆ›å»º Jetty Server ï¼Œ<strong>æ­¤æ—¶ä¸ä¼šå¯åŠ¨ Jetty Server</strong>ã€‚åœ¨ <code>JettyManagerProvider#notifyAfterCompleted()</code> æ–¹æ³•ï¼Œç»Ÿä¸€å¯åŠ¨æ‰€æœ‰ Jetty Serverï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Jetty Server Managerã€‹ã€Œ3. JettyManagerProviderã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-jetty-provider/src/main/java/org/skywalking/apm/collector/naming/jetty/NamingModuleJettyProvider.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨å®Œæˆé€»è¾‘ã€‚ç›®å‰æ˜¯ä¸ªç©ºæ–¹æ³•ã€‚</p><h2>2.3 NamingHandlerRegisterService</h2><p><code>org.skywalking.apm.collector.naming.service.NamingHandlerRegisterService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œå‘½åå¤„ç†å™¨æ³¨å†ŒæœåŠ¡<strong>æ¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-define/src/main/java/org/skywalking/apm/collector/naming/service/NamingHandlerRegisterService.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(ServerHandler)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ³¨å†Œ Server è¯·æ±‚å¤„ç†å™¨ã€‚Collector Agent Server ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå°†å…¶å®ç°çš„ ç”¨äº Naming çš„ ServerHandler è¿›è¡Œæ³¨å†Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_10/03.png" alt=""></p><h3>2.3.1 NamingJettyHandlerRegisterService</h3><p><code>org.skywalking.apm.collector.naming.jetty.service.service.NamingJettyHandlerRegisterService</code> ï¼ŒåŸºäº Jetty çš„å‘½åå¤„ç†å™¨æ³¨å†ŒæœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-naming/collector-naming-jetty-provider/src/main/java/org/skywalking/apm/collector/naming/jetty/service/NamingJettyHandlerRegisterService.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(moduleName, providerName, registration)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>JettyManagerService#addHandler(path, registration)</code> æ–¹æ³•ï¼Œæ³¨å†Œ Jetty Server è¯·æ±‚å¤„ç†å™¨ã€‚</p><h3>2.3.2 AgentJettyNamingHandler</h3><p><code>org.skywalking.apm.collector.agent.jetty.handler.naming.AgentJettyNamingHandler</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java" rel="external nofollow noopener noreferrer" target="_blank">JettyHandler</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒCollector Agent Jetty Server å®ç°çš„å‘½åå¤„ç†å™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-agent-jetty/collector-agent-jetty-provider/src/main/java/org/skywalking/apm/collector/agent/jetty/handler/naming/AgentJettyNamingHandler.java#L39" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚è·¯å¾„ä¸º <code>&quot;/agent/jetty&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-agent-jetty/collector-agent-jetty-provider/src/main/java/org/skywalking/apm/collector/agent/jetty/handler/naming/AgentJettyNamingHandler.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>AgentJettyNamingListener#getAddresses()</code> æ–¹æ³•ï¼Œè·å¾— Collector Agent Jetty Server é›†ç¾¤åœ°å€ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-agent-jetty/collector-agent-jetty-provider/src/main/java/org/skywalking/apm/collector/agent/jetty/handler/naming/AgentJettyNamingListener.java#L28" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.jetty.handler.naming.AgentJettyNamingListener</code></a> åŸºäº Collector Cluster ç»„ä»¶ï¼Œ<strong>å®ç°äº†é›†ç¾¤åœ°å€å˜åŒ–çš„å‘ç°</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3>2.3.3 AgentGRPCNamingHandler</h3><p><code>org.skywalking.apm.collector.agent.grpc.handler.naming.AgentGRPCNamingHandler</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/8eece7df8a9174067793f0714b8b71d09f142312/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java" rel="external nofollow noopener noreferrer" target="_blank">JettyHandler</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒCollector Agent gRPC Server å®ç°çš„å‘½åå¤„ç†å™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ac6c98c1732d6aa62b9d244369478654411ac203/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/naming/AgentGRPCNamingHandler.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚è·¯å¾„ä¸º <code>&quot;/agent/gRPC&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ac6c98c1732d6aa62b9d244369478654411ac203/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/naming/AgentGRPCNamingHandler.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>AgentGRPCNamingListener#getAddresses()</code> æ–¹æ³•ï¼Œè·å¾— Collector Agent gRPC Server é›†ç¾¤åœ°å€ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/ac6c98c1732d6aa62b9d244369478654411ac203/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/handler/naming/AgentGRPCNamingListener.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.agent.grpc.handler.naming.AgentGRPCNamingListener</code></a> åŸºäº Collector Cluster ç»„ä»¶ï¼Œ<strong>å®ç°äº†é›†ç¾¤åœ°å€å˜åŒ–çš„å‘ç°</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h2>2.4 é…ç½®æ–‡ä»¶</h2><p>é…ç½®æ–‡ä»¶å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_10/02.png" alt=""></p><ul><li>é…ç½® Naming Server å¯åŠ¨åœ¨ 10800 ç«¯å£ã€‚</li><li>Naming Server <strong>å†…åµŒ</strong>åœ¨ Collector Server ã€‚é€šè¿‡å¯åŠ¨å¤šä¸ª Collector Server èŠ‚ç‚¹ï¼Œå½¢æˆ Naming Server é›†ç¾¤ã€‚Agent é…ç½®å¤šä¸ª Naming Server åœ°å€ã€‚</li></ul><h1>3. CollectorDiscoveryService</h1><p><code>org.skywalking.apm.agent.core.remote.CollectorDiscoveryService</code> ï¼Œ å®ç° Agent çš„ <a href="https://github.com/YunaiV/skywalking/blob/ac6c98c1732d6aa62b9d244369478654411ac203/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/BootService.java" rel="external nofollow noopener noreferrer" target="_blank">BootService</a> <strong>æ¥å£</strong>ï¼ŒCollector Agent Server åœ°å€<strong>å‘ç°</strong>æœåŠ¡ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ac6c98c1732d6aa62b9d244369478654411ac203/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/CollectorDiscoveryService.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>ScheduledExecutorService#scheduleAtFixedRate(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚è¯¥å®šæ—¶ä»»åŠ¡<strong>æ— åˆå§‹åŒ–å»¶è¿Ÿ</strong>ï¼Œæ¯ <code>Config.Collector.DISCOVERY_CHECK_INTERVAL</code> ( é»˜è®¤ï¼š60 s ) æ‰§è¡Œä¸€æ¬¡ã€‚</p><ul><li>DiscoveryRestServiceClient å®ç° <code>java.lang.Runnable</code> <strong>æ¥å£</strong>ï¼Œå³åˆ›å»ºçš„ä»»åŠ¡ã€‚</li></ul><h2>3.1 CollectorDiscoveryService</h2><p><code>org.skywalking.apm.agent.core.remote.CollectorDiscoveryService</code> ï¼Œå®ç° <code>java.lang.Runnable</code> <strong>æ¥å£</strong>ï¼ŒCollector æœåŠ¡å‘ç°å®¢æˆ·ç«¯ï¼ŒåŸºäº <strong>Rest</strong> æ–¹å¼é€šä¿¡ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/e30787c3a7ce91ae6314003cd488e71c1a534d7c/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/DiscoveryRestServiceClient.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a> ï¼Œé¦–å…ˆéšæœºé€‰æ‹©ä¸€ä¸ª Collector Naming Server ï¼Œç”¨äºä¸‹é¢ <code>#findServerList()</code> æ–¹æ³•ï¼Œé¦–æ¬¡è·å– Collector Agent Server é›†ç¾¤åœ°å€ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/e30787c3a7ce91ae6314003cd488e71c1a534d7c/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/DiscoveryRestServiceClient.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>#run()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>#findServerList()</code> æ–¹æ³•ï¼Œè·å– Collector Agent Server é›†ç¾¤åœ°å€ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/e30787c3a7ce91ae6314003cd488e71c1a534d7c/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/DiscoveryRestServiceClient.java#L84" rel="external nofollow noopener noreferrer" target="_blank"><code>#findServerList()</code></a> æ–¹æ³•ï¼Œè·å– Collector Agent Server é›†ç¾¤åœ°å€ã€‚</p><ul><li>ç¬¬ 85 è¡Œ ï¼šåˆ›å»º <code>org.apache.http.impl.client.CloseableHttpClient</code> å¯¹è±¡ã€‚ç›®å‰ä½¿ç”¨ HttpClient <code>4.5.3</code> ç‰ˆæœ¬ã€‚</li><li>ç¬¬ 87 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/e30787c3a7ce91ae6314003cd488e71c1a534d7c/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/remote/DiscoveryRestServiceClient.java#L142" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildGet()</code></a> æ–¹æ³•ï¼Œåˆ›å»º <code>org.apache.http.client.methods.HttpGet</code> å¯¹è±¡ã€‚ç›®å‰ Agent æŸ¥è¯¢çš„æ˜¯ Collector Agent gRPC Server é›†ç¾¤åœ°å€ï¼Œå› ä¸º gRPC çš„æ€§èƒ½ç›¸æ¯” HTTP æ›´ä¼˜ç§€ã€‚</li><li>ç¬¬ 89 è¡Œ ï¼šå‘ Collector Naming Server å‘èµ·è¯·æ±‚ã€‚</li><li>ç¬¬ 90 è‡³ 93 è¡Œ ï¼šå½“å“åº”çŠ¶æ€ç é <code>200</code> æ—¶ï¼Œè°ƒç”¨ <code>#findBackupServer()</code> æ–¹æ³•ï¼Œ<strong>é¡ºåº</strong>é€‰æ‹© Collector Naming Server åˆ—è¡¨çš„ä¸‹ä¸€ä¸ªã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤æ—¶ä¸ä¼šå†å‘èµ·è¯·æ±‚ï¼Œéœ€è¦ç­‰ä¸‹ä¸€æ¬¡æ‰§è¡Œã€‚</li><li>ç¬¬ 95 è‡³ 111 è¡Œ ï¼šå¤„ç†å“åº”ç»“æœï¼Œè‹¥ Collector Agent gRPC Server é›†ç¾¤åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè¿›è¡Œæ›´æ–°åˆ° <code>RemoteDownstreamConfig.Collector.GRPC_SERVERS</code> ã€‚</li><li>ç¬¬ 114 è‡³ 117 è¡Œ ï¼šè¯·æ±‚å‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <code>#findBackupServer()</code> æ–¹æ³•ï¼Œ<strong>é¡ºåº</strong>é€‰æ‹© Collector Naming Server åˆ—è¡¨çš„ä¸‹ä¸€ä¸ªã€‚</li><li>ç¬¬ 119 è¡Œ ï¼šè°ƒç”¨ <code>CloseableHttpClient#close()</code> æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚</li></ul><h2>3.2 é…ç½®æ–‡ä»¶</h2><p>é…ç½®æ–‡ä»¶å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_10/05.png" alt=""></p><ul><li>ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ—¶ï¼Œ<strong>æ¨è</strong> Agent é…ç½®å¤šä¸ª Naming Server åœ°å€ã€‚</li></ul><h1>666. å½©è›‹</h1><p>2017.12.15 å½’é€” ä»åŒ—äº¬å›ä¸Šæµ·ã€‚</p><p>çªç„¶æœ‰ç§æ„Ÿè§‰ï¼Œè·å¾—åƒåŒ…æ–¹ä¾¿é¢ï¼Œå¿«æ·è€Œä¸è¥å…»ã€‚</p><p>æœ‰ç‚¹&quot;ä¸§&quot;ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_10/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-naming-server/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyWal
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector gRPC Server Manager</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/</id>
    <published>2020-08-04T16:00:00.000Z</published>
    <updated>2017-12-14T16:41:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/">2. GRPCManagerModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/">3. GRPCManagerProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/">4. GRPCManagerService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Collector gRPC Server Manager</strong>ã€‚Collector é€šè¿‡è¯¥ç®¡ç†å™¨ï¼Œç®¡ç†å¯åŠ¨çš„å¤šä¸ª gRPC Serverï¼Œä¾‹å¦‚ Agent gRPC Serverã€Remote gRPC Server ã€‚<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_05/02.png" alt=""></p><blockquote><p>å‹æƒ…æç¤ºï¼šå»ºè®®èƒ–å‹å·²ç»è¯»è¿‡ <a href="http://www.iocoder.cn/SkyWalking/collector-server-component/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶ã€‹</a></p><p>å¦å¤–ï¼Œæœ¬æ–‡å’Œ <a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Jetty Server Managerã€‹</a> ç›¸ä¼¼åº¦ 99%</p></blockquote><p>gRPC Server Manager åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_05/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_05/03.png" alt=""></p><p>ğŸ˜ˆ ä»£ç é‡éå¸¸å°‘ï¼Œè€ƒè™‘åˆ°è¿™æ˜¯ä¸ªå•ç‹¬çš„é¡¹ç›®ï¼Œæ‰€ä»¥å•ç‹¬æˆæ–‡ã€‚</p><h1>2. GRPCManagerModule</h1><p><code>org.skywalking.apm.collector.grpc.manager.GRPCManagerModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼ŒgRPC Server ç®¡ç†å™¨ Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/621598af465bfcefee3432c2ef80aff25a33f1bf/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-define/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerModule.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;gRPC_manager&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/621598af465bfcefee3432c2ef80aff25a33f1bf/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-define/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerModule.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šGRPCManagerService ã€‚</p><h1>3. GRPCManagerProvider</h1><p><code>org.skywalking.apm.collector.grpc.manager.GRPCManagerProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒgRPC Server ç®¡ç†å™¨ç»„ä»¶æœåŠ¡æä¾›è€…ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/f9de7bf75f62c16fd05cc0d1beb8f5b756108ec3/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerProvider.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;gRPC&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/f9de7bf75f62c16fd05cc0d1beb8f5b756108ec3/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerProvider.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º GRPCManagerModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/f9de7bf75f62c16fd05cc0d1beb8f5b756108ec3/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerProvider.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸ºç©ºã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/f9de7bf75f62c16fd05cc0d1beb8f5b756108ec3/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerProvider.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 55 è¡Œ ï¼šåˆ›å»º GRPCManagerServiceImpl å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation(...)</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/f9de7bf75f62c16fd05cc0d1beb8f5b756108ec3/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerProvider.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚ç›®å‰æ˜¯ä¸ª<strong>ç©ºæ–¹æ³•</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/f9de7bf75f62c16fd05cc0d1beb8f5b756108ec3/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/GRPCManagerProvider.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨å®Œæˆé€»è¾‘ã€‚</p><ul><li>ç¬¬ 63 è‡³ 69 è¡Œ ï¼šéå†æ³¨å†Œçš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œé€ä¸ªè°ƒç”¨ <code>GRPCServer#start()</code> æ–¹æ³•ï¼Œè¿›è¡Œå¯åŠ¨ã€‚</li></ul><h1>4. GRPCManagerService</h1><p><code>org.skywalking.apm.collector.grpc.manager.service.GRPCManagerService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> <strong>æ¥å£</strong>ï¼ŒgRPC Server ç®¡ç†å™¨æœåŠ¡<strong>æ¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/48f76a555c043fee2932230077a8112d4888d10f/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-define/src/main/java/org/skywalking/apm/collector/grpc/manager/service/GRPCManagerService.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#createIfAbsent(host, port)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ›å»º gRPC Server ï¼Œè‹¥ä¸å­˜åœ¨ã€‚</p><p><strong>æ€ä¹ˆæ²¡æœ‰ç±»ä¼¼ JettyManagerService çš„ <code>#addHandler(...)</code> æ–¹æ³•</strong>ï¼Ÿç›®å‰æ˜¯è°ƒç”¨æ–¹ç›´æ¥è°ƒç”¨ <code>#createIfAbsent(host, port)</code> æ–¹æ³•ï¼Œè·å¾— gRPC Server åï¼Œåè°ƒç”¨ <code>Server#addHandler(ServerHandler)</code> æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/9c586ca730cc89d4d5ad6b4294f2779a23925a8c/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/src/main/java/org/skywalking/apm/collector/agent/grpc/AgentModuleGRPCProvider.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>AgentModuleGRPCProvider#start(Properties)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/9c586ca730cc89d4d5ad6b4294f2779a23925a8c/apm-collector/apm-collector-remote/collector-remote-grpc-provider/src/main/java/org/skywalking/apm/collector/remote/grpc/RemoteModuleGRPCProvider.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>RemoteModuleGRPCProvider#start(Properties)</code></a></li></ul><h2>4.1 GRPCManagerServiceImpl</h2><p><code>org.skywalking.apm.collector.grpc.manager.service.GRPCManagerServiceImpl</code> ï¼ŒgRPC Server ç®¡ç†å™¨æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/9c586ca730cc89d4d5ad6b4294f2779a23925a8c/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/service/GRPCManagerServiceImpl.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a> ï¼Œä½¿ç”¨æ¥è‡ª GRPCManagerProvider çš„ <code>servers</code> æœåŠ¡å™¨æ•°ç»„ã€‚<strong>è¿™æ˜¯ä¸ºä»€ä¹ˆ GRPCManagerProvider æ²¡æœ‰å¯¹ <code>servers</code> åšæ–°å¢æ“ä½œï¼Œç»“æœé‡Œé¢æœ‰æ•°æ®çš„åŸå› </strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/9c586ca730cc89d4d5ad6b4294f2779a23925a8c/apm-collector/apm-collector-grpc-manager/collector-grpc-manager-provider/src/main/java/org/skywalking/apm/collector/grpc/manager/service/GRPCManagerServiceImpl.java#L48" rel="external nofollow noopener noreferrer" target="_blank"><code>#createIfAbsent(host, port)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º gRPC Server ï¼Œè‹¥ä¸å­˜åœ¨ã€‚åˆ¤æ–­æ–¹å¼ä¸º <code>host + port</code> ä¸ºå”¯ä¸€ã€‚</p><h1>666. å½©è›‹</h1><p>å‘µå‘µå“’çš„ä¸€ç¯‡ï¼Œå˜¿å˜¿ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_05/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/S
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Jetty Server Manager</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/</id>
    <published>2020-07-31T16:00:00.000Z</published>
    <updated>2017-12-14T16:30:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/">2. JettyManagerModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/">3. JettyManagerProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/">4. JettyManagerService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Collector Jetty Server Manager</strong>ã€‚Collector é€šè¿‡è¯¥ç®¡ç†å™¨ï¼Œç®¡ç†å¯åŠ¨çš„å¤šä¸ª Jetty Serverï¼Œä¾‹å¦‚ Agent Jetty Serverã€Naming Jetty Serverã€UI Jetty Serverã€‚<img src="http://www.iocoder.cn/images/SkyWalking/2020_08_01/02.png" alt=""></p><blockquote><p>å‹æƒ…æç¤ºï¼šå»ºè®®èƒ–å‹å·²ç»è¯»è¿‡ <a href="http://www.iocoder.cn/SkyWalking/collector-server-component/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶ã€‹</a></p></blockquote><p>Jetty Server Manager åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_01/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_01/03.png" alt=""></p><p>ğŸ˜ˆ ä»£ç é‡éå¸¸å°‘ï¼Œè€ƒè™‘åˆ°è¿™æ˜¯ä¸ªå•ç‹¬çš„é¡¹ç›®ï¼Œæ‰€ä»¥å•ç‹¬æˆæ–‡ã€‚</p><h1>2. JettyManagerModule</h1><p><code>org.skywalking.apm.collector.jetty.manager.JettyManagerModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼ŒJetty ç®¡ç†å™¨ Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-define/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerModule.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;jetty_manager&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-define/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerModule.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šJettyManagerService ã€‚</p><h1>3. JettyManagerProvider</h1><p><code>org.skywalking.apm.collector.jetty.manager.JettyManagerProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒJetty ç®¡ç†å™¨ç»„ä»¶æœåŠ¡æä¾›è€…ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerProvider.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;jetty&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerProvider.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º JettyManagerModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerProvider.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸ºç©ºã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerProvider.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 55 è¡Œ ï¼šåˆ›å»º JettyManagerServiceImpl å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation(...)</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerProvider.java#L58" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚ç›®å‰æ˜¯ä¸ª<strong>ç©ºæ–¹æ³•</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/39ee2260b8463316550c52276109a5af917e34e8/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/JettyManagerProvider.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨å®Œæˆé€»è¾‘ã€‚</p><ul><li>ç¬¬ 63 è‡³ 69 è¡Œ ï¼šéå†æ³¨å†Œçš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œé€ä¸ªè°ƒç”¨ <code>JettyServer#start()</code> æ–¹æ³•ï¼Œè¿›è¡Œå¯åŠ¨ã€‚</li></ul><h1>4. JettyManagerService</h1><p><code>org.skywalking.apm.collector.jetty.manager.service.JettyManagerService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> <strong>æ¥å£</strong>ï¼ŒJetty ç®¡ç†å™¨æœåŠ¡<strong>æ¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/71993b1790b29df66644334dcfe1796e889ddc9b/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-define/src/main/java/org/skywalking/apm/collector/jetty/manager/service/JettyManagerService.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#createIfAbsent(host, port, contextPath)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆ›å»º Jetty Server ï¼Œè‹¥ä¸å­˜åœ¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/71993b1790b29df66644334dcfe1796e889ddc9b/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-define/src/main/java/org/skywalking/apm/collector/jetty/manager/service/JettyManagerService.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>#addHandler(host, port, serverHandler)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ·»åŠ  Jetty Server è¯·æ±‚å¤„ç†å™¨ã€‚</p><h2>4.1 JettyManagerServiceImpl</h2><p><code>org.skywalking.apm.collector.jetty.manager.service.JettyManagerServiceImpl</code> ï¼ŒJetty ç®¡ç†å™¨æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/21a84f89165f74c7fe702650ff4d12db5a9613e4/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/service/JettyManagerServiceImpl.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a> ï¼Œä½¿ç”¨æ¥è‡ª JettyManagerProvider çš„ <code>servers</code> æœåŠ¡å™¨æ•°ç»„ã€‚<strong>è¿™æ˜¯ä¸ºä»€ä¹ˆ JettyManagerProvider æ²¡æœ‰å¯¹ <code>servers</code> åšæ–°å¢æ“ä½œï¼Œç»“æœé‡Œé¢æœ‰æ•°æ®çš„åŸå› </strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/21a84f89165f74c7fe702650ff4d12db5a9613e4/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/service/JettyManagerServiceImpl.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#createIfAbsent(host, port, contextPath)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º Jetty Server ï¼Œè‹¥ä¸å­˜åœ¨ã€‚åˆ¤æ–­æ–¹å¼ä¸º <code>host + port</code> ä¸ºå”¯ä¸€ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/21a84f89165f74c7fe702650ff4d12db5a9613e4/apm-collector/apm-collector-jetty-manager/collector-jetty-manager-provider/src/main/java/org/skywalking/apm/collector/jetty/manager/service/JettyManagerServiceImpl.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#addHandler(host, port, serverHandler)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ·»åŠ  Jetty Server è¯·æ±‚å¤„ç†å™¨ã€‚åˆ¤æ–­æ–¹å¼ä¸º <code>host + port</code> ä¸ºå”¯ä¸€ã€‚</p><h1>666. å½©è›‹</h1><p>å‘µå‘µå“’çš„ä¸€ç¯‡ï¼Œå˜¿å˜¿ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_08_01/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-server-component/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-server-component/</id>
    <published>2020-07-27T16:00:00.000Z</published>
    <updated>2017-12-14T14:44:47.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-server-component/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">2. æ¥å£</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">2.1 Server</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">2.2 ServerHandler</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">3. gRPC å®ç°</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">3.1 GRPCServer</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">3.2 GRPCHandler</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">4. Jetty å®ç°</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">3.1 JettyServer</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">3.2 JettyHandler</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-server-component/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Server Component æœåŠ¡å™¨ç»„ä»¶</strong>ã€‚Collector é€šè¿‡æœåŠ¡å™¨ï¼Œæä¾› API æ¥å£ç»™è°ƒç”¨æ–¹ï¼Œä¾‹å¦‚ Agent ã€WebUI ã€‚</p><p>Server Component åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_25/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_28/02.png" alt=""></p><p>OKï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1>2. æ¥å£</h1><h2>2.1 Server</h2><p><code>org.skywalking.apm.collector.server.Server</code> ï¼ŒæœåŠ¡å™¨<strong>æ¥å£</strong>ã€‚å…¶å®ç°å­ç±»ï¼Œå¦‚ä¸‹ç±»å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_28/03.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/Server.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>#hostPort()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åœ°å€ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/Server.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverClassify()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åˆ†ç±»ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/Server.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#initialize()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œåˆå§‹åŒ–æœåŠ¡å™¨ã€‚<a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/Server.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡å™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/Server.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>#addHandler()</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ·»åŠ è¯·æ±‚å¤„ç†å™¨( ServerHandler )</p><h2>2.2 ServerHandler</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/ServerHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.server.ServerHandler</code></a> ï¼ŒæœåŠ¡å™¨å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚å…¶å®ç°å­ç±»ï¼Œå¦‚ä¸‹ç±»å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_28/04.png" alt=""></p><p>ServerHandler æ— ä»»ä½•æ¥å£æ–¹æ³•ã€‚</p><p>ä¸€ä¸ª ServerHandler å¯¹åº”ä¸€ä¸ªè¯·æ±‚çš„å¤„ç†ã€‚</p><h1>3. gRPC å®ç°</h1><h2>3.1 GRPCServer</h2><p><code>org.skywalking.apm.collector.server.grpc.GRPCServer</code> ï¼ŒåŸºäº gRPC çš„æœåŠ¡å™¨å®ç°ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/grpc/GRPCServer.java#L47" rel="external nofollow noopener noreferrer" target="_blank"><code>#hostPort()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åœ°å€ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/grpc/GRPCServer.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverClassify()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åˆ†ç±»ä¸º <code>&quot;Google-RPC&quot;</code>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/grpc/GRPCServer.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#initialize()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>io.grpc.netty.NettyServerBuilder#forAddress(address)</code> æ–¹æ³•ï¼ŒNettyServerBuilder ã€‚æ­¤å¤„ï¼ŒæœåŠ¡å™¨å¹¶æœªåˆ›å»ºä¸å¯åŠ¨ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/grpc/GRPCServer.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º <code>io.grpc.Server</code> å¯¹è±¡ï¼Œå¹¶å¯åŠ¨æœåŠ¡å™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/grpc/GRPCServer.java#L70" rel="external nofollow noopener noreferrer" target="_blank"><code>#addHandler(handler)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>NettyServerBuilder#addService(...)</code> æ–¹æ³•ï¼Œæ·»åŠ  gRPC è¯·æ±‚å¤„ç†å™¨( GRPCHandler )ã€‚</p><p>ç›®å‰ï¼ŒGRPCServer ä½¿ç”¨åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-agent-grpc/collector-agent-grpc-provider/" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-agent-grpc-provider</code></a> / <a href="https://github.com/YunaiV/skywalking/tree/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-remote/collector-remote-grpc-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-remote-grpc-provider</code></a> é¡¹ç›®ã€‚</p><h2>3.2 GRPCHandler</h2><p><a href="https://github.com/YunaiV/skywalking/blob/ceee65ca1e03c34a756922034f85c5d95b8f2178/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/ServerHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.server.grpc.GRPCHandler</code></a> ï¼ŒgRPC è¯·æ±‚å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚å…¶å®ç°å­ç±»ï¼Œå¦‚ä¸‹ç±»å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_28/05.png" alt=""></p><p>GRPCHandler æ— ä»»ä½•æ¥å£æ–¹æ³•ã€‚</p><h1>4. Jetty å®ç°</h1><h2>3.1 JettyServer</h2><p><code>org.skywalking.apm.collector.server.jetty.JettyServer</code> ï¼ŒåŸºäº Jetty çš„æœåŠ¡å™¨å®ç°ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyServer.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><code>#hostPort()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åœ°å€ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyServer.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverClassify()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åˆ†ç±»ä¸º <code>&quot;Jetty&quot;</code>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyServer.java#L60" rel="external nofollow noopener noreferrer" target="_blank"><code>#initialize()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œåˆ›å»º <code>org.eclipse.jetty.server.Server</code> å’Œ <code>org.eclipse.jetty.servle.ServletContextHandler</code> å¯¹è±¡ã€‚æ­¤å¤„ï¼ŒæœåŠ¡å™¨å¹¶æœªå¯åŠ¨ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyServer.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡å™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyServer.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#addHandler(handler)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œä½¿ç”¨ ServerHandler åˆ›å»º <code>org.eclipse.jetty.servlet.ServletHolder</code> å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>ServletContextHandler#addServlet(servlet, pathSpec)</code> æ–¹æ³•è¿›è¡Œæ·»åŠ ã€‚</p><p>ç›®å‰ï¼ŒJettyServer ä½¿ç”¨åœ¨ <a href="https://github.com/YunaiV/skywalking/tree/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-agent-jetty/collector-agent-jetty-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-agent-jetty-provider</code></a> / <a href="https://github.com/YunaiV/skywalking/tree/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-ui/collector-ui-jetty-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-ui-jetty-provider</code></a> é¡¹ç›®ã€‚</p><h2>3.2 JettyHandler</h2><p><code>org.skywalking.apm.collector.server.jetty.JettyHandler</code> ï¼Œç»§æ‰¿ <code>javax.servlet.http.HttpServlet</code> <strong>æŠ½è±¡ç±»</strong>ï¼ŒJetty è¯·æ±‚å¤„ç†ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#pathSpec()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¯·æ±‚è·¯å¾„å®šä¹‰ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet(HttpServletRequest)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå¤„ç† Get è¯·æ±‚ï¼Œå¹¶è¿”å› <code>com.google.gson.JsonElement</code> å¯¹è±¡ã€‚</p><ul><li>è¯¥æŠ½è±¡æ–¹æ³•ä¼šè¢« <a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#doGet(HttpServletRequest, HttpServletResponse)</code></a> æ–¹æ³•è°ƒç”¨ã€‚<ul><li>æˆåŠŸæ—¶ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L174" rel="external nofollow noopener noreferrer" target="_blank"><code>#reply(HttpServletResponse, JsonElement)</code></a> æ–¹æ³•ï¼Œè¿”å› JSON ã€‚</li><li>é”™è¯¯æ—¶ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L195" rel="external nofollow noopener noreferrer" target="_blank"><code>#replyError(HttpServletResponse, errorMessage, status)</code></a> æ–¹æ³•ï¼Œè¿”å› JSON ã€‚</li></ul></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>#doPost(HttpServletRequest)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå¤„ç† Post è¯·æ±‚ï¼Œå¹¶è¿”å› <code>com.google.gson.JsonElement</code> å¯¹è±¡ã€‚</p><ul><li>è¯¥æŠ½è±¡æ–¹æ³•ä¼šè¢« <a href="https://github.com/YunaiV/skywalking/blob/3c964d8b5678cf6f715dc252e6fe48ba87d0f9e9/apm-collector/apm-collector-component/server-component/src/main/java/org/skywalking/apm/collector/server/jetty/JettyHandler.java#L64" rel="external nofollow noopener noreferrer" target="_blank"><code>#doPost(HttpServletRequest, HttpServletResponse)</code></a> æ–¹æ³•è°ƒç”¨ã€‚</li></ul><p><strong>HttpServlet æ‰€æœ‰æ–¹æ³•è¢«é‡å†™ï¼Œå¹¶æ ‡è®° <code>final</code> ä¿®é¥°ç¬¦ï¼Œä¸å…è®¸å­ç±»é‡å†™</strong>ã€‚</p><h1>666. å½©è›‹</h1><p>åˆåŒå’å•æˆåŠŸæ›´æ–°äº†ä¸€ç¯‡æ°´æ–‡ã€‚ğŸ˜œ</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_28/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-server-component/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Sky
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Client Component å®¢æˆ·ç«¯ç»„ä»¶</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-client-component/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-client-component/</id>
    <published>2020-07-24T16:00:00.000Z</published>
    <updated>2017-12-14T14:44:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-client-component/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">2. Client</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">3. ElasticSearchClient</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">4. GRPCClient</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">5. H2Client</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">6. RedisClient</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">7. ZookeeperClient</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-client-component/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Client Component å®¢æˆ·ç«¯ç»„ä»¶</strong>ã€‚Collector é€šè¿‡å®¢æˆ·ç«¯ï¼Œå’Œå…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œä¾‹å¦‚ Elastic Search ã€Zookeeper ã€H2 ç­‰ç­‰ã€‚</p><p>Client Component åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_25/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_25/02.png" alt=""></p><p>OKï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1>2. Client</h1><p><a href="https://github.com/YunaiV/skywalking/blob/c546a9a4d4588d99bf532da519ae721ef60b918e/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/Client.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.Client</code></a> ï¼Œå®¢æˆ·ç«¯<strong>æ¥å£</strong>ã€‚å…¶å®šä¹‰æ¥å£æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><code>#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯ã€‚</li><li><code>#shutdown()</code> æ–¹æ³•ï¼Œå…³é—­å®¢æˆ·ç«¯ã€‚</li></ul><p>Client çš„å®ç°ç±»ï¼Œå¦‚ä¸‹ç±»å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_25/03.png" alt=""></p><h1>3. ElasticSearchClient</h1><p><a href="https://github.com/YunaiV/skywalking/blob/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/elasticsearch/ElasticSearchClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.elasticsearch.ElasticSearchClient</code></a> ï¼ŒElastic Search å®¢æˆ·ç«¯ã€‚</p><p>åŸºäº <code>org.elasticsearch.client.transport</code> çš„ <code>5.5.0</code> ç‰ˆæœ¬ï¼Œå°è£… SkyWalking éœ€è¦çš„ Elastic Search æ“ä½œã€‚ç›®å‰ç”¨äº <a href="https://github.com/YunaiV/skywalking/blob/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-storage/collector-storage-es-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-storage-es-provider</code></a> æ¨¡å—ã€‚</p><h1>4. GRPCClient</h1><p><a href="https://github.com/YunaiV/skywalking/blob/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/grpc/GRPCClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.grpc.GRPCClient</code></a> ï¼ŒgRPC å®¢æˆ·ç«¯ã€‚</p><p>åŸºäº <code>io.grpc.grpc-core</code> çš„ <code>1.8.0</code> ç‰ˆæœ¬ï¼Œå°è£… SkyWalking éœ€è¦çš„ gRPC æ“ä½œã€‚ç›®å‰ç”¨äº <a href="https://github.com/YunaiV/skywalking/tree/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-remote/collector-remote-grpc-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-remote-grpc-provider</code></a> æ¨¡å—ã€‚</p><h1>5. H2Client</h1><p><a href="https://github.com/YunaiV/skywalking/blob/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/h2/H2Client.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.h2.H2Client</code></a> ï¼ŒH2 æ•°æ®åº“å®¢æˆ·ç«¯ã€‚</p><p>åŸºäº <code>com.h2database.h2</code> çš„ <code>1.4.196</code> ç‰ˆæœ¬ï¼Œå°è£… SkyWalking éœ€è¦çš„ H2 æ•°æ®åº“æ“ä½œã€‚ç›®å‰ç”¨äº <a href="https://github.com/YunaiV/skywalking/tree/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-storage/collector-storage-h2-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-storage-h2-provider</code></a> / <a href="https://github.com/YunaiV/skywalking/tree/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-cluster/collector-cluster-standalone-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-cluster-standalone-provider</code></a> æ¨¡å—ã€‚</p><h1>6. RedisClient</h1><p><a href="https://github.com/YunaiV/skywalking/blob/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/redis/RedisClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.redis.RedisClient</code></a> ï¼ŒRedis å®¢æˆ·ç«¯ã€‚</p><p>åŸºäº <code>redis.clients.jedis</code> çš„ <code>2.9.0</code> ç‰ˆæœ¬ï¼Œå°è£… SkyWalking éœ€è¦çš„ Reids æ“ä½œã€‚é¢„è®¡æœªæ¥ç”¨äº <a href="https://github.com/YunaiV/skywalking/tree/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-cluster/collector-cluster-redis-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-cluster-redis-provider</code></a> æ¨¡å—ã€‚</p><h1>7. ZookeeperClient</h1><p><a href="https://github.com/YunaiV/skywalking/blob/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/zookeeper/ZookeeperClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.zookeeper.ZookeeperClient</code></a> ï¼ŒZookeeper å®¢æˆ·ç«¯ã€‚</p><p>åŸºäº <code>org.apache.zookeeper.zookeeper</code> çš„ <code>3.4.10</code> ç‰ˆæœ¬ï¼Œå°è£… SkyWalking éœ€è¦çš„ Zookeeper æ“ä½œã€‚é¢„è®¡æœªæ¥ç”¨äº <a href="https://github.com/YunaiV/skywalking/tree/001f700612ad52bc1eb1a278bc0e2ff9e5330df8/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider" rel="external nofollow noopener noreferrer" target="_blank"><code>collector-cluster-zookeeper-provider</code></a> æ¨¡å—ã€‚</p><h1>666. å½©è›‹</h1><p>å“ˆå“ˆå“ˆï¼Œæ˜¯ä¸æ˜¯çœ‹çš„å¾ˆæœ‰æˆå°±æ„Ÿ( ç¬”è€…åˆåœ¨æ°´æ›´äº† )ã€‚</p><p>ä¸è¦æ–¹ï¼Œä¸‹é¢è¿˜æœ‰ä¸€ç¯‡æ°´æ›´ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_25/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-client-component/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Sky
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-cluster-module/</id>
    <published>2020-07-19T16:00:00.000Z</published>
    <updated>2017-12-15T08:29:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-cluster-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">2. collector-cluster-define</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">2.1 ClusterModule</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">2.2 ModuleRegisterService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">2.3 ModuleListenerService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">2.4 DataMonitor</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">3. collector-cluster-zookeeper-provider</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">3.1 ClusterModuleZookeeperProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">3.2 ZookeeperModuleRegisterService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">3.3 ZookeeperModuleListenerService</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">3.4 ClusterZKDataMonitor</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">3.5 ZookeeperClient</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">4. collector-cluster-standalone-provider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">5. collector-cluster-redis-provider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector Cluster Module</strong>ï¼Œè´Ÿè´£é›†ç¾¤çš„ç®¡ç†ï¼Œå³ Collector èŠ‚ç‚¹çš„æ³¨å†Œäºå‘ç°ã€‚</p><blockquote><p>å‹æƒ…æç¤ºï¼šå»ºè®®å…ˆé˜…è¯» <a href="http://www.iocoder.cn/SkyWalking/collector-init/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector åˆå§‹åŒ–ã€‹</a> ï¼Œä»¥äº†è§£ Collector ç»„ä»¶ä½“ç³»ã€‚</p></blockquote><p>Cluster Module åœ¨ SkyWalking æ¶æ„å›¾å¤„äºå¦‚ä¸‹ä½ç½®( <strong>çº¢æ¡†</strong> ) ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/01.jpeg" alt=""></p></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ•´ä½“çš„é¡¹ç›®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/02.png" alt=""></p><ul><li><code>collector-cluster-define</code> ï¼šå®šä¹‰é›†ç¾¤ç®¡ç†æ¥å£ã€‚</li><li><code>collector-cluster-standalone-provider</code> ï¼šåŸºäº H2 çš„ é›†ç¾¤ç®¡ç†å®ç°ã€‚<strong>è¯¥å®ç°æ˜¯å•æœºç‰ˆï¼Œå»ºè®®ä»…ç”¨äº SkyWalking å¿«é€Ÿä¸Šæ‰‹ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</strong>ã€‚</li><li><code>collector-cluster-redis-provider</code> ï¼šåŸºäº Redis çš„é›†ç¾¤ç®¡ç†å®ç°ã€‚<em>ç›®å‰æš‚æœªå®Œæˆ</em>ã€‚</li><li><code>collector-cluster-zookeeper-provider</code> ï¼šåŸºäº Zookeeper çš„é›†ç¾¤ç®¡ç†å®ç°ã€‚<strong>ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨</strong></li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»<strong>æ¥å£åˆ°å®ç°</strong>çš„é¡ºåºè¿›è¡Œåˆ†äº«ã€‚</p><h1>2. collector-cluster-define</h1><p><code>collector-cluster-define</code> ï¼šå®šä¹‰é›†ç¾¤ç®¡ç†æ¥å£ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/03.png" alt=""></p><ul><li><p>äº¤äº’å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/04.png" alt=""></p></li><li><p>ModuleListenerService æš´éœ²ç»™å…¶ä»– Module æ³¨å†Œç›‘å¬å™¨ ( ClusterModuleListener ) åˆ° DataMonitor ã€‚</p></li><li><p>ModuleRegisterService æš´éœ²ç»™å…¶ä»– Module æ³¨å†Œç»„ä»¶ç™»è®°( ModuleRegistration ) åˆ° DataMonitor ã€‚</p></li><li><p>é€šè¿‡å®ç° DataMonitor æ¥å£ï¼ŒåŸºäºä¸åŒçš„å­˜å‚¨å™¨å®ç°æ³¨å†Œå‘ç°ã€‚</p></li></ul><h2>2.1 ClusterModule</h2><p><code>org.skywalking.apm.collector.cluster.ClusterModule</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> æŠ½è±¡ç±»ï¼Œé›†ç¾¤ç®¡ç† Module ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ClusterModule.java#L33" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›æ¨¡å—åä¸º <code>&quot;cluster&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ClusterModule.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å› Service ç±»åï¼šModuleListenerService / ModuleRegisterService ã€‚</p><h2>2.2 ModuleRegisterService</h2><p><code>org.skywalking.apm.collector.cluster.service.ModuleRegisterService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œæ¨¡å—æ³¨å†ŒæœåŠ¡<strong>æ¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/service/ModuleRegisterService.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(moduleName, providerName, registration)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ³¨å†Œæ¨¡å—æ³¨å†Œä¿¡æ¯ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ç°è¯¥æ¥å£æ–¹æ³•ï¼Œè°ƒç”¨ <code>DataMonitor#register(path, registration)</code> æ–¹æ³•ã€‚</p><h3>2.2.1 ModuleRegistration</h3><p><code>org.skywalking.apm.collector.cluster.ModuleRegistration</code> ï¼Œæ¨¡å—æ³¨å†Œä¿¡æ¯<strong>æŠ½è±¡ç±»</strong>ã€‚ä¸åŒ Module é€šè¿‡å®ç° ModuleRegistration ï¼Œå°†å®ƒä»¬æ³¨å†Œåˆ° ModuleRegisterServiceã€‚ç›®å‰å­ç±»å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/05.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ModuleRegistration.java" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildValue()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—æ¨¡å—æ³¨å†Œä¿¡æ¯( <a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ModuleRegistration.java#L30" rel="external nofollow noopener noreferrer" target="_blank">Value</a> )ã€‚</p><h2>2.3 ModuleListenerService</h2><p><code>org.skywalking.apm.collector.cluster.service.ModuleListenerService</code> ï¼Œç»§æ‰¿ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Service.java" rel="external nofollow noopener noreferrer" target="_blank">Service</a> æ¥å£ï¼Œæ³¨å†Œç›‘å¬å™¨æœåŠ¡<strong>æ¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/service/ModuleListenerService.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#addListener(listener)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ·»åŠ ç›‘å¬å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ç°è¯¥æ¥å£æ–¹æ³•ï¼Œè°ƒç”¨ <code>DataMonitor#addListener(listener)</code> æ–¹æ³•ã€‚</p><h3>2.3.1 ClusterModuleListener</h3><p><code>org.skywalking.apm.collector.cluster.ClusterModuleListener</code> ï¼Œé›†ç¾¤ç»„ä»¶ç›‘å¬å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚ç›®å‰å­ç±»å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/11.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ClusterModuleListener.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a>ï¼Œåˆ›å»ºåœ°å€æ•°ç»„( <code>addresses</code> )ã€‚è¯¥æ•°ç»„çš„è¯»å†™æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><code>#addAddress(address)</code></li><li><code>#removeAddress(address)</code></li><li><code>#getAddresses()</code></li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ClusterModuleListener.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>#path()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¿”å›è·¯å¾„ã€‚è¯¥è·¯å¾„å³ä¸º ClusterModuleListener ç›‘å¬çš„**&quot;äº‹ä»¶&quot;**ã€‚å¤šä¸ª Collector èŠ‚ç‚¹çš„ç›¸åŒ Module ï¼Œ<strong>é€šè¿‡è·¯å¾„åˆ†ç»„å½¢æˆé›†ç¾¤</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ClusterModuleListener.java#L62" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverJoinNotify(serverAddress)</code></a> / <a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/ClusterModuleListener.java#L69" rel="external nofollow noopener noreferrer" target="_blank"><code>#serverQuitNotify(serverAddress)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œé€šçŸ¥æœåŠ¡çš„åŠ å…¥ / ä¸‹çº¿ã€‚ç›®å‰åªæœ‰ GRPCRemoteSenderService <strong>çœŸæ­£</strong>( å…¶å®ƒéƒ½æ˜¯ç©ºæ–¹æ³• )å®ç°è¯¥æ–¹æ³•ï¼Œåœ¨ <a href="">TODO ã€4002ã€‘Remote</a> è¯¦ç»†è§£æã€‚</p><h2>2.4 DataMonitor</h2><p><code>org.skywalking.apm.collector.cluster.DataMonitor</code> ï¼Œæ•°æ®ç›‘<strong>è§†</strong>å™¨<strong>æ¥å£</strong>ã€‚é€šè¿‡å®ç° DataMonitor æ¥å£ï¼ŒåŸºäºä¸åŒçš„å­˜å‚¨å™¨å®ç°æ³¨å†Œå‘ç°ã€‚ç›®å‰å­ç±»å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/06.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L40" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(path, registration)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ³¨å†Œæ¨¡å—æ³¨å†Œä¿¡æ¯ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#addListener(ClusterModuleListener)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œæ·»åŠ ç›‘å¬å™¨ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><code>#getListener(path)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè·å¾—ç›‘å¬<strong>æŒ‡å®šè·¯å¾„</strong>çš„ç›‘å¬å™¨ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L36" rel="external nofollow noopener noreferrer" target="_blank"><code>#setClient(Client)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œè®¾ç½® <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/Client.java" rel="external nofollow noopener noreferrer" target="_blank">Client</a> ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/tree/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client" rel="external nofollow noopener noreferrer" target="_blank"><code>client-component</code></a> æœ‰ ZookeeperClient / H2Client / ElasticSearchClient ç­‰å¤šç§å®ç°ã€‚</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L34" rel="external nofollow noopener noreferrer" target="_blank"><code>BASE_CATALOG</code></a> å±æ€§ï¼ŒåŸºç¡€ç›®å½•ä¸º <code>&quot;/skywalking&quot;</code> ã€‚ä¾‹å¦‚è¯´ï¼Œåœ¨ Zookeeper ä¸ºæ ¹èŠ‚ç‚¹çš„è·¯å¾„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L44" rel="external nofollow noopener noreferrer" target="_blank"><code>#createPath(path)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œä½¿ç”¨ Client åˆ›å»ºè·¯å¾„ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-define/src/main/java/org/skywalking/apm/collector/cluster/DataMonitor.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#setData(path)</code></a> <strong>æ¥å£</strong>æ–¹æ³•ï¼Œä½¿ç”¨ Client è®¾ç½®è·¯å¾„çš„å€¼ã€‚</li></ul><h1>3. collector-cluster-zookeeper-provider</h1><p><code>collector-cluster-zookeeper-provider</code> ï¼ŒåŸºäº Zookeeper çš„é›†ç¾¤ç®¡ç†å®ç°ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/07.png" alt=""></p><p>å®é™…ä½¿ç”¨æ—¶ï¼Œé€šè¿‡ <code>application.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p><p><figure class="highlight"><table><tr><td class="code"><pre><div class="line">cluster:</div><div class="line">  zookeeper:</div><div class="line">    hostPort: localhost:2181</div><div class="line">    sessionTimeout: 100000</div></pre></td></tr></table></figure></p><ul><li>ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæ¨è Zookeeper é…ç½®æˆé›†ç¾¤ã€‚</li></ul><h2>3.1 ClusterModuleZookeeperProvider</h2><p><code>org.skywalking.apm.collector.cluster.zookeeper.ClusterModuleZookeeperProvider</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> <strong>æŠ½è±¡ç±»</strong>ï¼ŒåŸºäº Zookeeper çš„é›†ç¾¤ç®¡ç†æœåŠ¡æä¾›è€…ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶æœåŠ¡æä¾›è€…åä¸º <code>&quot;zookeeper&quot;</code> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L57" rel="external nofollow noopener noreferrer" target="_blank"><code>module()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ç»„ä»¶ç±»ä¸º ClusterModule ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L94" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè¿”å›ä¾èµ–ç»„ä»¶ä¸ºç©ºã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L61" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 63 è¡Œ ï¼šåˆ›å»º ClusterZKDataMonitor å¯¹è±¡ã€‚</li><li>ç¬¬ 69 è¡Œ ï¼šåˆ›å»º ZookeeperClient å¯¹è±¡ã€‚<strong>æ³¨æ„ï¼Œæ­¤æ—¶å¹¶æœªè¿æ¥ Zookeeper</strong> ã€‚</li><li>ç¬¬ 71 è‡³ 73 è¡Œ ï¼šåˆ›å»º ZookeeperModuleListenerService / ZookeeperModuleRegisterService å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ <code>#registerServiceImplementation()</code> <strong>çˆ¶ç±»</strong>æ–¹æ³•ï¼Œæ³¨å†Œåˆ° <code>services</code> ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚</p><ul><li>ç¬¬ 79 è¡Œ ï¼šè°ƒç”¨ <code>ZookeeperClient#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– ZookeeperClient ï¼Œ<strong>æ­¤æ—¶ä¼šè¿æ¥ Zookeeper</strong>ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterModuleZookeeperProvider.java#L85" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨å®Œæˆé€»è¾‘ã€‚</p><ul><li>ç¬¬ 88 è¡Œ ï¼šè°ƒç”¨ <code>ClusterZKDataMonitor#start()</code> æ–¹æ³•ï¼Œå¯åŠ¨ ClusterZKDataMonitor ã€‚åœ¨æœ¬æ–‡ <a href="#">ã€Œ3.4 ClusterZKDataMonitorã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>3.2 ZookeeperModuleRegisterService</h2><p><code>org.skywalking.apm.collector.cluster.zookeeper.service.ZookeeperModuleRegisterService</code> ï¼ŒåŸºäº Zookeeper çš„æ¨¡å—æ³¨å†ŒæœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/service/ZookeeperModuleRegisterService.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(moduleName, providerName, registration)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>ClusterZKDataMonitor#register(path, registration)</code> æ–¹æ³•ï¼Œæ³¨å†Œæ¨¡å—æ³¨å†Œä¿¡æ¯ã€‚</p><h2>3.3 ZookeeperModuleListenerService</h2><p><code>org.skywalking.apm.collector.cluster.zookeeper.service.ZookeeperModuleListenerService</code> ï¼ŒåŸºäº Zookeeper çš„æ³¨å†Œç›‘å¬å™¨æœåŠ¡<strong>å®ç°ç±»</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/service/ZookeeperModuleListenerService.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#addListener(ClusterModuleListener)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œè°ƒç”¨ <code>ClusterZKDataMonitor#addListener(ClusterModuleListener)</code> æ–¹æ³•ï¼Œæ³¨å†Œæ¨¡å—æ³¨å†Œä¿¡æ¯ã€‚</p><h2>3.4 ClusterZKDataMonitor</h2><p><code>org.skywalking.apm.collector.cluster.zookeeper.ClusterZKDataMonitor</code> ï¼ŒåŸºäº Zookeeper çš„æ•°æ®ç›‘è§†å™¨<strong>å®ç°ç±»</strong>ã€‚</p><p>åœ¨çœ‹å…·ä½“ä»£ç å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Zookeeper æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/08.png" alt=""></p><ul><li><p>ç´«è‰²éƒ¨åˆ†ï¼Œé€šè¿‡è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterZKDataMonitor.java#L172" rel="external nofollow noopener noreferrer" target="_blank"><code>#createPath(path)</code></a> æ–¹æ³•ï¼Œé¡ºç€è·¯å¾„ï¼Œé€å±‚åˆ›å»º<strong>æŒä¹…</strong>èŠ‚ç‚¹ã€‚</p></li><li><p>é»„è‰²éƒ¨åˆ†ï¼Œé€šè¿‡è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterZKDataMonitor.java#L184" rel="external nofollow noopener noreferrer" target="_blank"><code>#setData(path)</code></a> æ–¹æ³•ï¼Œåˆ›å»º<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ï¼Œè®¾ç½® Collector æ¨¡å—åœ°å€ã€‚è‹¥ Collector é›†ç¾¤æœ‰ N ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ­¤å¤„ä¼šæœ‰ N ä¸ª<strong>ä¸´æ—¶</strong>èŠ‚ç‚¹ã€‚</p></li><li><p>æ‰“å¼€ <code>zkClient.sh</code> ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ ï¼š</p><p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] ls /skywalking</div><div class="line">[remote, ui, agent_jetty, agent_gRPC]</div><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /skywalking/ui</div><div class="line">[jetty]</div><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) 3] ls /skywalking/ui/jetty</div><div class="line">[localhost:12800]</div><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) 4] get /skywalking/ui/jetty/localhost:12800</div><div class="line">/</div><div class="line">cZxid = 0x24</div><div class="line">ctime = Thu Dec 14 16:05:25 CST 2017</div><div class="line">mZxid = 0x24</div><div class="line">mtime = Thu Dec 14 16:05:25 CST 2017</div><div class="line">pZxid = 0x24</div><div class="line">cversion = 0</div><div class="line">dataVersion = 0</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x16052d8b9f40006</div><div class="line">dataLength = 1</div><div class="line">numChildren = 0</div></pre></td></tr></table></figure></p></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterZKDataMonitor.java#L163" rel="external nofollow noopener noreferrer" target="_blank"><code>#register(path, registration)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ·»åŠ åˆ°ç»„ä»¶æ³¨å†Œä¿¡æ¯é›†åˆ( <code>registrations</code> )ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterZKDataMonitor.java#L123" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> æ–¹æ³•ï¼Œå¯åŠ¨ ClusterZKDataMonitor ï¼Œå°†ç»„ä»¶æ³¨å†Œä¿¡æ¯( <code>registrations</code> ) å†™åˆ° Zookeeper ä¸­ã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterZKDataMonitor.java#L157" rel="external nofollow noopener noreferrer" target="_blank"><code>#addListener(listener)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œæ·»åŠ åˆ°ç›‘å¬å™¨é›†åˆ( <code>listeners</code> )ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-cluster/collector-cluster-zookeeper-provider/src/main/java/org/skywalking/apm/collector/cluster/zookeeper/ClusterZKDataMonitor.java#L123" rel="external nofollow noopener noreferrer" target="_blank"><code>#process(WatchedEvent)</code></a> <strong>å®ç°</strong>æ–¹æ³•ï¼Œå¤„ç†æœ‰ Collector èŠ‚ç‚¹çš„ç»„ä»¶åŠ å…¥æˆ–ä¸‹çº¿ã€‚æ€»ä½“é€»è¾‘æ˜¯ï¼Œä» Zookeeper è·å–å˜æ›´çš„è·¯å¾„ä¸‹çš„åœ°å€æ•°ç»„ï¼Œå’Œæœ¬åœ°çš„åœ°å€( <code>ClusterModuleListener.addresses</code> )æ¯”è¾ƒï¼Œå¤„ç†åŠ å…¥æˆ–ç§»é™¤é€»è¾‘çš„åœ°å€ã€‚</p><ul><li>ClusterZKDataMonitor å®ç° <code>org.apache.zookeeper.Watcher</code> <strong>æ¥å£</strong>ï¼Œæ‰€ä»¥å®ç°è¯¥æ–¹æ³•ã€‚</li><li>è¯¥æ–¹æ³•æ˜¯ <code>synchronized</code> æ–¹æ³•ï¼Œä»¥ä¿è¯ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚</li></ul><h2>3.5 ZookeeperClient</h2><p><a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/zookeeper/ZookeeperClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.client.zookeeper.ZookeeperClient</code></a> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/20d38d7fcbbaac65e10eb8d256881fc9c0cedd87/apm-collector/apm-collector-component/client-component/src/main/java/org/skywalking/apm/collector/client/Client.java" rel="external nofollow noopener noreferrer" target="_blank">Client</a> <strong>æ¥å£</strong>ï¼ŒZookeeper å®¢æˆ·ç«¯ã€‚</p><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚</p><h1>4. collector-cluster-standalone-provider</h1><p><code>collector-cluster-standalone-provider.ClusterStandaloneDataMonitor</code> ï¼ŒåŸºäº H2 çš„ é›†ç¾¤ç®¡ç†å®ç°ã€‚<strong>è¯¥å®ç°æ˜¯å•æœºç‰ˆï¼Œå»ºè®®ä»…ç”¨äº SkyWalking å¿«é€Ÿä¸Šæ‰‹ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</strong>ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/09.png" alt=""></p><p>å¤§ä½“å®ç°å’Œ <code>collector-cluster-zookeeper-provider</code> å·®ä¸å¤šï¼Œå·®å¼‚åœ¨å¯¹ DataMonitor çš„å®ç°ç±» ClusterStandaloneDataMonitor ä¸Šã€‚</p><p>åœ¨ ClusterStandaloneDataMonitor é‡Œï¼Œå®é™…å¹¶æœªä½¿ç”¨ H2Client ï¼Œè€Œæ˜¯åŸºäºå†…å­˜ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±æŸ¥çœ‹ä¸‹ã€‚</p><h1>5. collector-cluster-redis-provider</h1><p><code>collector-cluster-redis-provider</code> ï¼šåŸºäº Redis çš„é›†ç¾¤ç®¡ç†å®ç°ã€‚<em>ç›®å‰æš‚æœªå®Œæˆ</em>ã€‚</p><p>ã€TODO 4003ã€‘ç­‰å®ç°åæ¥å†™å†™ï¼ŒåŸºäº Redis Pub Sub ä¿è¯å®æ—¶æ€§</p><h1>666. å½©è›‹</h1><p>æœ‰ä¸€ç§ç¡¬ç”Ÿç”ŸæŠŠå¾ˆç®€å•çš„ä¸œè¥¿ï¼Œå†™çš„å¾ˆå¤æ‚çš„æ„Ÿè§‰ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_20/10.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-cluster-module/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyWa
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Collector åˆå§‹åŒ–</title>
    <link href="http://www.iocoder.cn/SkyWalking/collector-init/"/>
    <id>http://www.iocoder.cn/SkyWalking/collector-init/</id>
    <published>2020-07-14T16:00:00.000Z</published>
    <updated>2017-12-21T13:52:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-init/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">2. CollectorBootStartUp</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">2. ApplicationConfigLoader</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">3. ModuleManager</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">3.1 Module</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">3.2 ModuleProvider</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">3.3 Service</a></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">3.4 BootstrapFlow</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/collector-init/">4. Module å®ç°ç±»ç®€ä»‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Collector å¯åŠ¨åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>ã€‚åœ¨åˆ†äº«çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼š<strong>ç®€å•</strong>ä»‹ç» Collector æ¯ä¸ªæ¨¡å—åŠå…¶ç”¨é€”ã€‚</p><p>ps ï¼šCollector æ˜¯ SkyWalking çš„ Server ç«¯ã€‚æ•´ä½“å¦‚ä¸‹å›¾ ï¼š</p><blockquote><p>FROM https://github.com/apache/incubating-skywalking<br><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/01.png" alt=""></p></blockquote><h1>2. CollectorBootStartUp</h1><p><code>org.skywalking.apm.collector.boot.CollectorBootStartUp</code> ï¼Œåœ¨ <code>apm-sniffer/apm-agent</code> Maven æ¨¡å—é¡¹ç›®é‡Œï¼ŒSkyWalking Collector <strong>å¯åŠ¨å…¥å£</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-boot/src/main/java/org/skywalking/apm/collector/boot/CollectorBootStartUp.java#L38" rel="external nofollow noopener noreferrer" target="_blank"><code>#main(args)</code></a> æ–¹æ³•ï¼Œå¯åŠ¨ Collector ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 45 è¡Œ ï¼šè°ƒç”¨ <code>ApplicationConfiguration#load()</code> æ–¹æ³•ï¼ŒåŠ è½½ Collector <strong>é…ç½®</strong>ã€‚</li><li>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>ModuleManager#init(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Collector <strong>ç»„ä»¶</strong>ä»¬ã€‚</li><li>ç¬¬ 60 è¡Œ ï¼šè°ƒç”¨ <code>Thread#sleep(60000)</code> æ–¹æ³•ï¼Œç­‰å¾… Collector å†…åµŒçš„ Jetty Server å¯åŠ¨å®Œæˆã€‚</li></ul><h1>2. ApplicationConfigLoader</h1><p><code>org.skywalking.apm.collector.boot.config.ApplicationConfigLoader</code> ï¼Œå®ç° <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-boot/src/main/java/org/skywalking/apm/collector/boot/config/ConfigLoader.java#L24" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.boot.config.ConfigLoader</code></a> æ¥å£ï¼ŒCollector é…ç½®( <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ApplicationConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.module.ApplicationConfiguration</code></a> )åŠ è½½å™¨ã€‚</p><p>åœ¨çœ‹å…·ä½“ä»£ç å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ ApplicationConfiguration æ•´ä½“ç±»ç»“æ„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/02.png" alt=""></p><ul><li>Collector ä½¿ç”¨ç»„ä»¶ç®¡ç†å™¨( ModuleManager )ï¼Œç®¡ç†<strong>å¤šä¸ª</strong>ç»„ä»¶( <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java" rel="external nofollow noopener noreferrer" target="_blank">Module</a> )ã€‚<ul><li>ä¸€ä¸ªç»„ä»¶æœ‰å¤šç§ç»„ä»¶æœåŠ¡æä¾›è€…( <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java" rel="external nofollow noopener noreferrer" target="_blank">ModuleProvider</a> )ï¼Œ<strong>åŒæ—¶</strong>ä¸€ä¸ªç»„ä»¶åªå…è®¸ä½¿ç”¨<strong>ä¸€ä¸ª</strong>ç»„ä»¶æœåŠ¡æä¾›è€…ã€‚è¿™å—ä¸‹é¢ä¼šæœ‰ä»£ç è§£æè¯´æ˜ã€‚</li></ul></li><li>Collector ä½¿ç”¨ä¸€ä¸ªåº”ç”¨é…ç½®ç±»( <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ApplicationConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">ApplicationConfiguration</a> )ã€‚<ul><li>ä¸€ä¸ªåº”ç”¨é…ç½®ç±»åŒ…å«å¤šä¸ªç»„ä»¶é…ç½®ç±»( <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ApplicationConfiguration.java#L62" rel="external nofollow noopener noreferrer" target="_blank">ModuleConfiguration</a> )ã€‚æ¯ä¸ªç»„ä»¶å¯¹åº”ä¸€ä¸ªç»„ä»¶é…ç½®ç±»ã€‚</li><li>ä¸€ä¸ªç»„ä»¶é…ç½®ç±»åŒ…å«å¤šä¸ªç»„ä»¶æœåŠ¡æä¾›è€…é…ç½®( <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ApplicationConfiguration.java#L93" rel="external nofollow noopener noreferrer" target="_blank">ProviderConfiguration</a> )ã€‚æ¯ä¸ªç»„ä»¶æœåŠ¡æä¾›è€…å¯¹åº”ä¸€ä¸ªç»„ä»¶é…ç½®ç±»ã€‚<strong>æ³¨æ„</strong>ï¼šå› ä¸ºä¸€ä¸ªç»„ä»¶åªå…è®¸<strong>åŒæ—¶</strong>ä½¿ç”¨<strong>ä¸€ä¸ª</strong>ç»„ä»¶æœåŠ¡æä¾›è€…ï¼Œæ‰€ä»¥ä¸€ä¸ªç»„ä»¶é…ç½®ç±»<strong>åªè®¾ç½®</strong>ä¸€ä¸ªç»„ä»¶æœåŠ¡æä¾›è€…é…ç½®ã€‚</li></ul></li><li>æ•´ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯¹åº”åº”ç”¨é…ç½®ç±»ã€‚<strong>ç»¿æ¡†</strong>éƒ¨åˆ†ï¼Œå¯¹åº”ä¸€ä¸ªç»„ä»¶é…ç½®ç±»ã€‚<strong>çº¢æ¡†</strong>éƒ¨åˆ†ï¼Œå¯¹åº”ä¸€ä¸ªç»„ä»¶æœåŠ¡æä¾›è€…é…ç½®ç±»ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-boot/src/main/java/org/skywalking/apm/collector/boot/config/ApplicationConfigLoader.java#L43" rel="external nofollow noopener noreferrer" target="_blank"><code>ApplicationConfigLoader#load()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>#loadConfig()</code> æ–¹æ³•ï¼Œä» <code>apm-collector-core</code> çš„ <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/resources/application-default.yml" rel="external nofollow noopener noreferrer" target="_blank"><code>application.yml</code></a> åŠ è½½è‡ªå®šä¹‰é…ç½®ã€‚</li><li>ç¬¬ 49 è¡Œ ï¼šè°ƒç”¨ <code>#loadDefaultConfig()</code> æ–¹æ³•ï¼Œä» <code>apm-collector-core</code> çš„ <a href="https://github.com/YunaiV/skywalking/blob/c633c1f0e143d1df2457926ab239350a642f7be2/apm-collector/apm-collector-core/src/main/resources/application-default.yml" rel="external nofollow noopener noreferrer" target="_blank"><code>application-default.yml</code></a> åŠ è½½é»˜è®¤é…ç½®ã€‚</li><li>ä¸¤ä¸ªæ–¹æ³•é€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œå·²ç»æ·»åŠ ä»£ç æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±é˜…è¯»ç†è§£ã€‚</li></ul><h1>3. ModuleManager</h1><p><code>org.skywalking.apm.collector.core.module.ModuleManager</code> ï¼Œç»„ä»¶ç®¡ç†å™¨ï¼Œè´Ÿè´£ç»„ä»¶çš„ç®¡ç†ä¸åˆå§‹åŒ–ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ff055ee52da855ef6cc8bfdfae7c2758ae3c61cd/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleManager.java#L49" rel="external nofollow noopener noreferrer" target="_blank"><code>#init()</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ–ç»„ä»¶ä»¬ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li><p>ç¬¬ 51 è‡³ 53 è¡Œ ï¼šè°ƒç”¨ <code>java.util.ServiceLoader#load(Module.class)</code> æ–¹æ³•ï¼ŒåŠ è½½æ‰€æœ‰ Module å®ç°ç±»çš„å®ä¾‹æ•°ç»„ã€‚ServiceManager åŸºäº SPI (Service Provider Interface) æœºåˆ¶ï¼Œåœ¨æ¯ä¸ª <code>apm-collector-xxx-define</code> é¡¹ç›®çš„ <code>/resources/META-INF.services/org.skywalking.apm.collector.core.module.Module</code> æ–‡ä»¶é‡Œï¼Œå®šä¹‰äº†è¯¥é¡¹ç›® Module çš„å®ç°ç±»ã€‚å¦‚æœèƒ–å‹å¯¹ SPI æœºåˆ¶ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥çœ‹ä¸‹å¦‚ä¸‹æ–‡ç«  ï¼š</p><ul><li><a href="http://www.jianshu.com/p/32d3e108f30a" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSPI å’Œ ServiceLoaderã€‹</a></li><li><a href="http://www.jianshu.com/p/46aa69643c97" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè·Ÿæˆ‘å­¦Dubboç³»åˆ—ä¹‹Java SPIæœºåˆ¶ç®€ä»‹ã€‹</a></li></ul></li><li><p>ç¬¬ 55 è‡³ 75 è¡Œ ï¼šéå†æ‰€æœ‰ Module å®ç°ç±»çš„å®ä¾‹æ•°ç»„ï¼Œåˆ›å»º<strong>åœ¨é…ç½®ä¸­</strong>çš„ Module å®ç°ç±»çš„å®ä¾‹ï¼Œå¹¶æ‰§è¡Œ Module å‡†å¤‡é˜¶æ®µçš„é€»è¾‘ï¼Œåæ·»åŠ åˆ°åŠ è½½çš„ç»„ä»¶å®ä¾‹çš„æ˜ å°„( <code>loadedModules</code> )ã€‚</p><ul><li>ç¬¬ 59 è‡³ 67 è¡Œ ï¼šåˆ›å»º Module å¯¹è±¡ã€‚</li><li>ç¬¬ 69 è¡Œ ï¼šè°ƒç”¨ <code>Module#prepare(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Module å‡†å¤‡é˜¶æ®µçš„é€»è¾‘ã€‚åœ¨æ”¹æ–¹æ³•å†…éƒ¨ï¼Œä¼šåˆ›å»º Module å¯¹åº”çš„ ModuleProvider ã€‚åœ¨ <a href="#">ã€Œ3.1 Moduleã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 71 è¡Œ ï¼šæ·»åŠ åˆ° <code>loadedModules</code> ã€‚</li></ul></li><li><p>ç¬¬ 77 è‡³ 80 è¡Œ ï¼šæ ¡éªŒ<strong>åœ¨é…ç½®ä¸­</strong>çš„ Module å®ç°ç±»çš„å®ä¾‹éƒ½åˆ›å»ºäº†ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p></li><li><p>ç¬¬ 84 è¡Œ ï¼šè°ƒç”¨ <code>BootstrapFlow#start(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Module å¯åŠ¨é€»è¾‘ã€‚<a href="#">ã€Œ3.4 BootstrapFlowã€</a> è¯¦ç»†è§£æã€‚</p></li><li><p>ç¬¬ 86 è¡Œ ï¼šè°ƒç”¨ <code>BootstrapFlow#notifyAfterCompleted()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Module å¯åŠ¨å®Œæˆï¼Œé€šçŸ¥ ModuleProvider ã€‚<a href="#">ã€Œ3.4 BootstrapFlowã€</a> è¯¦ç»†è§£æã€‚</p></li><li><p>æ€»çš„æ¥è¯´ï¼ŒModule åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œå¯ä»¥ç†è§£æˆä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/03.png" alt=""></p></li></ul><h2>3.1 Module</h2><p><code>org.skywalking.apm.collector.core.module.Module</code> ï¼Œç»„ä»¶<strong>æŠ½è±¡ç±»</strong>ã€‚é€šè¿‡å®ç° Module æŠ½è±¡ç±»ï¼Œå®ç°ä¸åŒåŠŸèƒ½çš„ç»„ä»¶ã€‚ç›®å‰ Collector çš„ Module å®ç°ç±»å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/04.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/204a9e658dd95cc8ee5d4e65d7ca1ed58f3a71da/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—ç»„ä»¶åã€‚ç›®å‰ç»„ä»¶åæœ‰ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/05.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/204a9e658dd95cc8ee5d4e65d7ca1ed58f3a71da/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java#L110" rel="external nofollow noopener noreferrer" target="_blank"><code>#providers()</code></a> æ–¹æ³•ï¼Œè·å¾— ModuleProvider æ•°ç»„ã€‚å®é™…ä¸Šï¼Œä¸€ä¸ª Module <strong>åŒæ—¶</strong>åªèƒ½æœ‰ä¸€ä¸ª ModuleProvider ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/204a9e658dd95cc8ee5d4e65d7ca1ed58f3a71da/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>#provider()</code></a> æ–¹æ³•ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/204a9e658dd95cc8ee5d4e65d7ca1ed58f3a71da/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#services()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— Service <strong>ç±»</strong>æ•°ç»„ã€‚å…·ä½“ Service <strong>å¯¹è±¡</strong>ï¼Œåœ¨ ModuleProvider å¯¹è±¡é‡Œè·å–ï¼Œå‚è§ <a href="https://github.com/YunaiV/skywalking/blob/204a9e658dd95cc8ee5d4e65d7ca1ed58f3a71da/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java#L122" rel="external nofollow noopener noreferrer" target="_blank"><code>#getService(serviceType)</code></a> æ–¹æ³•ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/204a9e658dd95cc8ee5d4e65d7ca1ed58f3a71da/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/Module.java#L66" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(...)</code></a> æ–¹æ³•ï¼Œæ‰§è¡Œ Module <strong>å‡†å¤‡é˜¶æ®µ</strong>çš„é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 69 è¡Œ ï¼šè°ƒç”¨ <code>java.util.ServiceLoader#load(ModuleProvider.class)</code> æ–¹æ³•ï¼ŒåŠ è½½æ‰€æœ‰ ModuleProvider å®ç°ç±»çš„å®ä¾‹æ•°ç»„ã€‚ServiceManager åŸºäº SPI (Service Provider Interface) æœºåˆ¶ï¼Œåœ¨æ¯ä¸ª <code>apm-collector-xxx-yyy-provider</code> é¡¹ç›®çš„ <code>/resources/META-INF.services/org.skywalking.apm.collector.core.module.ModuleProvider</code> æ–‡ä»¶é‡Œï¼Œå®šä¹‰äº†è¯¥é¡¹ç›® ModuleProvider çš„å®ç°ç±»ã€‚</li><li>ç¬¬ 72 è‡³ 93 è¡Œ ï¼šéå†æ‰€æœ‰ ModuleProvider å®ç°ç±»çš„å®ä¾‹æ•°ç»„ï¼Œåˆ›å»º<strong>åœ¨é…ç½®ä¸­</strong>çš„ ModuleProvider å®ç°ç±»çš„å®ä¾‹ï¼Œåæ·»åŠ åˆ°åŠ è½½çš„ç»„ä»¶æœåŠ¡æä¾›è€…å®ä¾‹çš„æ˜ å°„( <code>loadedProviders</code> )ã€‚</li><li>ç¬¬ 95 è‡³ 98 è¡Œ ï¼šæ ¡éªŒæœ‰ ModuleProvider åˆå§‹åŒ–ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li><li>ç¬¬ 100 è‡³ 104 è¡Œ ï¼šè°ƒç”¨ <code>ModuleProvider#prepare(...)</code>  æ–¹æ³•ï¼Œæ‰§è¡Œ ModuleProvider å‡†å¤‡é˜¶æ®µçš„é€»è¾‘ã€‚åœ¨æ”¹æ–¹æ³•å†…éƒ¨ï¼Œä¼šåˆ›å»º ModuleProvider å¯¹åº”çš„ Service ã€‚åœ¨ <a href="#">ã€Œ3.2 ModuleProviderã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>3.2 ModuleProvider</h2><p><code>org.skywalking.apm.collector.core.module.ModuleProvider</code> ï¼Œç»„ä»¶æœåŠ¡æä¾›è€…<strong>æŠ½è±¡ç±»</strong>ã€‚é€šè¿‡å®ç° ModuleProvider æŠ½è±¡ç±»ï¼Œå®ç°ä¸åŒåŠŸèƒ½çš„ç»„ä»¶æœåŠ¡æä¾›è€…ã€‚ç›®å‰ Collector çš„ ModuleProvider å®ç°ç±»å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/06.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L64" rel="external nofollow noopener noreferrer" target="_blank"><code>#name()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—ç»„ä»¶æœåŠ¡æä¾›è€…åã€‚ç›®å‰ç»„ä»¶æœåŠ¡æä¾›è€…åæœ‰ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/07.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L69" rel="external nofollow noopener noreferrer" target="_blank"><code>#module()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— ModuleProvider å¯¹åº”çš„ Module <strong>ç±»</strong>ã€‚æ³¨æ„ï¼ŒModuleProvider çš„åå­—å¯ä»¥é‡å¤ï¼Œä¾‹å¦‚ä¸Šå›¾çš„ <code>jetty</code> ï¼Œé€šè¿‡å¯¹åº”çš„ Module <strong>ç±»</strong>æ¥åŒºåˆ†ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L95" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredModules()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— ModuleProvider ä¾èµ–çš„ Module <strong>åå­—</strong>æ•°ç»„ã€‚</p><p>---------- Service ç›¸å…³æ–¹æ³• Begin ----------</p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L103" rel="external nofollow noopener noreferrer" target="_blank"><code>#registerServiceImplementation(Class&lt;? extends Service&gt;, Service)</code></a> æ–¹æ³•ï¼Œæ³¨å†Œ Service å¯¹è±¡ã€‚ä¸€ä¸ª ModuleProvider å¯ä»¥æœ‰ 0 åˆ° N ä¸ª Service å¯¹è±¡ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L133" rel="external nofollow noopener noreferrer" target="_blank"><code>#getService(Class&lt;T&gt;)</code></a> æ–¹æ³•ï¼Œè·å¾— Service å¯¹è±¡ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L118" rel="external nofollow noopener noreferrer" target="_blank"><code>#requiredCheck(...)</code></a> æ–¹æ³•ï¼Œ<strong>æ ¡éªŒ</strong> ModuleProvider åŒ…å«çš„ Service ä»¬éƒ½åˆ›å»ºæˆåŠŸã€‚</p><ul><li><strong>æ–¹æ³•å‚æ•°</strong>ï¼Œä» <code>Module#services()</code> æ–¹æ³•è·å¾—ã€‚</li><li>è¯¥æ–¹æ³•ä¼šè¢« <code>BootstrapFlow#start()</code> æ–¹æ³•è°ƒç”¨ï¼Œåœ¨ <a href="#">ã€Œ3.4 BootstrapFlowã€</a> è¯¦ç»†è§£æã€‚</li></ul><p>---------- Service ç›¸å…³æ–¹æ³• End ----------</p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L76" rel="external nofollow noopener noreferrer" target="_blank"><code>#prepare(Properties)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ ModuleProvider å‡†å¤‡é˜¶æ®µçš„é€»è¾‘ï¼šService çš„åˆ›å»ºï¼Œç§æœ‰å˜é‡çš„åˆ›å»ºç­‰ç­‰ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-storage/collector-storage-h2-provider/src/main/java/org/skywalking/apm/collector/storage/h2/StorageModuleH2Provider.java#L123" rel="external nofollow noopener noreferrer" target="_blank"><code>StorageModuleH2Provider#prepare(Properties)</code></a> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L83" rel="external nofollow noopener noreferrer" target="_blank"><code>#start(Properties)</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ ModuleProvider å¯åŠ¨é˜¶æ®µçš„é€»è¾‘ï¼šç§æœ‰å˜é‡çš„åˆå§‹åŒ–ç­‰ç­‰ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-storage/collector-storage-h2-provider/src/main/java/org/skywalking/apm/collector/storage/h2/StorageModuleH2Provider.java#L136" rel="external nofollow noopener noreferrer" target="_blank"><code>StorageModuleH2Provider#start(Properties)</code></a> ã€‚</p><ul><li>è¯¥æ–¹æ³•ä¼šè¢« <code>BootstrapFlow#start()</code> æ–¹æ³•è°ƒç”¨ï¼Œåœ¨ <a href="#">ã€Œ3.4 BootstrapFlowã€</a> è¯¦ç»†è§£æã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/ModuleProvider.java#L90" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ ModuleProvider å¯åŠ¨å®Œæˆé˜¶æ®µçš„é€»è¾‘ï¼šç§æœ‰å˜é‡çš„åˆå§‹åŒ–ç­‰ç­‰ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/3fb837104a111ff94abef9c871c814fb60c18340/apm-collector/apm-collector-storage/collector-storage-es-provider/src/main/java/org/skywalking/apm/collector/storage/es/StorageModuleEsProvider.java#L170" rel="external nofollow noopener noreferrer" target="_blank"><code>StorageModuleEsProvider#notifyAfterCompleted(Properties)</code></a> ã€‚</p><ul><li>è¯¥æ–¹æ³•ä¼šè¢« <code>BootstrapFlow#notifyAfterCompleted()</code> æ–¹æ³•è°ƒç”¨ï¼Œåœ¨ <a href="#">ã€Œ3.4 BootstrapFlowã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2>3.3 Service</h2><p><code>org.skywalking.apm.collector.core.module.Service</code> ï¼ŒæœåŠ¡<strong>æ¥å£</strong>ã€‚é€šè¿‡å®ç° Service æ¥å£ï¼Œå®ç°ä¸åŒåŠŸèƒ½çš„æœåŠ¡ã€‚ç›®å‰ Collector çš„ Service å®ç°ç±»å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/08.png" alt=""></p><p>è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œå®é™…ä¸Š Module æ˜¯ä¸ Service <strong>&quot;ç›´æ¥&quot;</strong> ä¸€å¯¹å¤šçš„å…³ç³»ã€‚ä¸­é—´ æœ‰ä¸€å±‚ ModuleProvider å­˜åœ¨çš„åŸå› æ˜¯ï¼Œç›¸åŒ Module å¯ä»¥æœ‰å¤šç§ ModuleProvider å®ç°ï¼Œè€Œ ModuleProvider æä¾›æä¾›ç›¸åŒåŠŸèƒ½çš„ Service ï¼Œä½†æ˜¯å®ç°ä¸åŒã€‚</p><p>ä»¥ <code>apm-collector-storage</code> ä¸¾ä¾‹å­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/09.png" alt=""></p><ul><li>StorageModuleEsProvider / StorageModuleH2Provider åˆ†åˆ«åŸºäº ES / H2 å®ç°ï¼Œå…¶æä¾›å­˜å‚¨ç›¸åŒæ•°æ®çš„ä¸åŒå®ç°ã€‚ä¾‹å¦‚ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/10.png" alt=""></li></ul><p>ä¸€èˆ¬ <code>collector-xxx-define</code> çš„ <code>service</code> åŒ…ä¸‹ï¼Œä¼šå®šä¹‰å½“å‰æ¨¡å—æä¾›çš„ Service æ¥å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/12.png" alt=""></p><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰ <code>Module#services()</code> å’Œ <code>#requiredCheck(Class&lt;? extends Service&gt;[])</code> è¿™æ ·çš„æ–¹æ³•æ¶‰åŠçš„åŸå› ã€‚</p><p>å¦å¤–ï¼Œå¦‚ä¸‹æ˜¯ Service æ¥å£çš„è§£é‡Šï¼š</p><blockquote><p>The &lt;code&gt;Service&lt;/code&gt; implementation is a service provided by its own modules.</p><p>And every {@link ModuleProvider} must provide all the given services of the {@link Module}.</p></blockquote><h2>3.4 BootstrapFlow</h2><p><a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/BootstrapFlow.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.collector.core.module.BootstrapFlow</code></a>ï¼Œç»„ä»¶å¯åŠ¨æµç¨‹ã€‚</p><p>BootstrapFlow <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/BootstrapFlow.java#L42" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a>ï¼Œè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/BootstrapFlow.java#L86" rel="external nofollow noopener noreferrer" target="_blank"><code>#makeSequence()</code></a> æ–¹æ³•ï¼Œè·å¾— ModuleProvider å¯åŠ¨é¡ºåºï¼Œè¿™ä¸ªæ˜¯è¯¥ç±»çš„<strong>é‡ç‚¹</strong>ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/BootstrapFlow.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>#start()</code></a> æ–¹æ³•ï¼Œæ‰§è¡Œ Module å¯åŠ¨é€»è¾‘ã€‚</p><ul><li>ç¬¬ 54 è‡³ 63 è¡Œ ï¼šæ ¡éªŒ<strong>ä¾èµ–</strong> Module å·²ç»éƒ½å­˜åœ¨ã€‚</li><li>ç¬¬ 67 è¡Œ ï¼šæ ¡éªŒ ModuleProvider åŒ…å«çš„ Service ä»¬éƒ½<strong>åˆ›å»ºæˆåŠŸ</strong>ã€‚</li><li>ç¬¬ 70 è¡Œ ï¼šè°ƒç”¨ <code>ModuleProvider#start(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ ModuleProvider å¯åŠ¨é˜¶æ®µé€»è¾‘ã€‚</li></ul><p><a href="https://github.com/YunaiV/skywalking/blob/40823179d7228207b06b603b9a1c09dfc4f78593/apm-collector/apm-collector-core/src/main/java/org/skywalking/apm/collector/core/module/BootstrapFlow.java#L74" rel="external nofollow noopener noreferrer" target="_blank"><code>#notifyAfterCompleted()</code></a> æ–¹æ³•ï¼Œè°ƒç”¨ <code>ModuleProvider#notifyAfterCompleted()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ ModuleProvider å¯åŠ¨å®Œæˆé˜¶æ®µçš„é€»è¾‘ã€‚</p><h1>4. Module å®ç°ç±»ç®€ä»‹</h1><p><img src="https://camo.githubusercontent.com/2a00cb347f6a7d7afb8faef8d8b0f2a0d3215d9d/68747470733a2f2f736b7977616c6b696e67746573742e6769746875622e696f2f706167652d7265736f75726365732f332e322e352532625f6172636869746563747572652e6a7067" alt=""></p><ul><li><code>Naming Module</code> ï¼šTODO</li><li><code>UI Module</code> ï¼š</li><li>Queue Module ï¼š<a href="http://www.iocoder.cn/SkyWalking/collector-queue-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Queue é˜Ÿåˆ—ç»„ä»¶ã€‹</a></li><li><code>Cache Module</code> ï¼šTODO</li><li>Cluster Module ï¼š<a href="http://www.iocoder.cn/SkyWalking/collector-cluster-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Cluster é›†ç¾¤ç®¡ç†ã€‹</a></li><li>Component Libraries ï¼š<a href="http://www.iocoder.cn/SkyWalking/collector-client-component/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Client Component å®¢æˆ·ç«¯ç»„ä»¶ã€‹</a> ã€<a href="http://www.iocoder.cn/SkyWalking/collector-server-component/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Server Component æœåŠ¡å™¨ç»„ä»¶ã€‹</a></li><li>Core ï¼šTODO</li><li>Storage Module ï¼šTODO</li><li>Agent Module ï¼šTODO</li><li>Jetty Manager Module ï¼š<a href="http://www.iocoder.cn/SkyWalking/collector-jetty-server-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector Jetty Server Managerã€‹</a></li><li>gRPC Manager Module ï¼š<a href="http://www.iocoder.cn/SkyWalking/collector-grpc-server-module/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Collector gRPC Server Managerã€‹</a></li><li>Agent Streaming Computing ï¼šTODO</li><li>Baseline Module ï¼štodo</li><li>Alerting Module ï¼štodo</li></ul><p>TODO ã€4001ã€‘Module å®ç°æ–‡ç« é“¾æ¥</p><h1>666. å½©è›‹</h1><p>å¯èƒ½è¦è¿›å…¥ç‰¹åˆ«å¿™ç¢Œçš„ä¸€æ®µæ—¶é—´ï¼Œä¸ç¡®å®š SkyWalking æ–‡ç« åç»­çš„æ›´æ–°é¢‘ç‡ã€‚</p><p>ç»§ç»­åŠ æ²¹ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_15/11.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/collector-init/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyWalking/coll
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent æ’ä»¶ä½“ç³»</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-plugin-system/</id>
    <published>2020-07-09T16:00:00.000Z</published>
    <updated>2017-12-12T09:06:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/agent-plugin-system/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">2. æ’ä»¶çš„åŠ è½½</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">2.1 AgentClassLoader</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">2.2 PluginResourcesResolver</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">2.3 PluginCfg</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">2.4 AbstractClassEnhancePluginDefine</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">2.5 å°ç»“</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">3. æ’ä»¶çš„åŒ¹é…</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">3.1 InstrumentDebuggingClass</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">3.2 ClassMatch</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">3.3 PluginFinder</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">4. æ’ä»¶çš„æ‹¦æˆª</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">4.1 ClassEnhancePluginDefine</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">4.2 InterceptPoint</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">4.3 Interceptor</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">4.4 Inter</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">4.5 å°ç»“</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Agent æ’ä»¶ä½“ç³»</strong>ã€‚ä¸»è¦æ¶‰åŠä¸‰ä¸ªæµç¨‹ ï¼š</p><ul><li>æ’ä»¶çš„åŠ è½½</li><li>æ’ä»¶çš„åŒ¹é…</li><li>æ’ä»¶çš„æ‹¦æˆª</li></ul><p>å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œä¸å¤ªå®¹æ˜“ç†è§£ã€‚æ·¡å®šï¼Œæˆ‘ä»¬æ¯ä¸ªå°ç« èŠ‚è¿›è¡Œè§£æã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»ä¸»è¦åœ¨ <a href="https://github.com/YunaiV/skywalking/tree/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin</code></a> åŒ…é‡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/01.png" alt=""></p><p>æ¯ä¸ªæµç¨‹ä¼šæ¶‰åŠåˆ°è¾ƒå¤šçš„ç±»ï¼Œæˆ‘ä»¬ä¼šè´¯ç©¿ç€è§£æä»£ç å®ç°ã€‚</p><h1>2. æ’ä»¶çš„åŠ è½½</h1><p>åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-init/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent åˆå§‹åŒ–ã€‹</a> ä¸€æ–‡ä¸­ï¼ŒAgent åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>PluginBootstrap#loadPlugins()</code> æ–¹æ³•ï¼ŒåŠ è½½æ‰€æœ‰çš„æ’ä»¶ã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/03.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/130f0a5a3438663b393e53ba2cca02a8d13c258a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginBootstrap.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>PluginBootstrap#loadPlugins()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <code>AgentClassLoader#initDefaultLoader()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– AgentClassLoader ã€‚åœ¨æœ¬æ–‡ <a href="#">ã€Œ2.1 AgentClassLoaderã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 50 è‡³ 56 è¡Œ ï¼šè·å¾—æ’ä»¶<strong>å®šä¹‰è·¯å¾„</strong>æ•°ç»„ã€‚åœ¨æœ¬æ–‡ <a href="#">ã€Œ2.2 PluginResourcesResolverã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 59 è‡³ 66 è¡Œ ï¼šè·å¾—æ’ä»¶<strong>å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.PluginDefine</code></a> )æ•°ç»„ã€‚åœ¨æœ¬æ–‡ <a href="#">ã€Œ2.3 PluginCfgã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 69 è‡³ 82 è¡Œ ï¼šåˆ›å»º<strong>ç±»å¢å¼ºæ’ä»¶å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code></a> )å¯¹è±¡æ•°ç»„ã€‚ä¸åŒæ’ä»¶é€šè¿‡å®ç° AbstractClassEnhancePluginDefine <strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰ä¸åŒæ¡†æ¶çš„<strong>åˆ‡é¢</strong>ï¼Œ<strong>è®°å½•è°ƒç”¨é“¾è·¯</strong>ã€‚åœ¨æœ¬æ–‡ <a href="#">ã€Œ2.4 AbstractClassEnhancePluginDefineã€</a> ç®€å•è§£æã€‚</li></ul><h2>2.1 AgentClassLoader</h2><p><code>org.skywalking.apm.agent.core.plugin.loader.AgentClassLoader</code> ï¼Œç»§æ‰¿ <code>java.lang.ClassLoader</code> ï¼ŒAgent ç±»åŠ è½½å™¨ã€‚</p><p><strong>ä¸ºä»€ä¹ˆå®ç°è‡ªå®šä¹‰çš„ ClassLoader</strong> ï¼Ÿåº”ç”¨<strong>é€æ˜</strong>æ¥å…¥ SkyWalking ï¼Œä¸ä¼š<strong>æ˜¾ç¤º</strong>å¯¼å…¥ SkyWalking çš„æ’ä»¶ä¾èµ–ã€‚é€šè¿‡å®ç°è‡ªå®šä¹‰çš„ ClassLoader ï¼Œä»æ’ä»¶ Jar ä¸­æŸ¥æ‰¾ç›¸å…³ç±»ã€‚ä¾‹å¦‚è¯´ï¼Œä» <code>apm-dubbo-plugin-3.2.6-2017.jar</code> æŸ¥æ‰¾ <code>org.skywalking.apm.plugin.dubbo.DubboInstrumentation</code> ã€‚</p><hr><p>AgentClassLoader <strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * The default class loader for the agent.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AgentClassLoader DEFAULT_LOADER;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * classpath</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;File&gt; classpath;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jar æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;Jar&gt; allJars;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jar è¯»å–æ—¶çš„é”</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ReentrantLock jarScanLock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AgentClassLoader</span><span class="params">(ClassLoader parent)</span> <span class="keyword">throws</span> AgentPackageNotFoundException </span>&#123;</div><div class="line">        <span class="keyword">super</span>(parent);</div><div class="line">        File agentDictionary = AgentPackagePath.getPath();</div><div class="line">        classpath = <span class="keyword">new</span> LinkedList&lt;File&gt;();</div><div class="line">        classpath.add(<span class="keyword">new</span> File(agentDictionary, <span class="string">"plugins"</span>));</div><div class="line">        classpath.add(<span class="keyword">new</span> File(agentDictionary, <span class="string">"activations"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>DEFAULT_LOADER</code> <strong>é™æ€</strong>å±æ€§ï¼Œé»˜è®¤å•ä¾‹ã€‚é€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/loader/AgentClassLoader.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#getDefault()</code></a> æ–¹æ³•ï¼Œå¯ä»¥è·å–åˆ°å®ƒã€‚</li><li><code>classpath</code> å±æ€§ï¼ŒJava ç±»æ‰€åœ¨çš„ç›®å½•ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>${AGENT_PACKAGE_PATH}/plugins</code> / <code>${AGENT_PACKAGE_PATH}/activations</code> æ·»åŠ åˆ° <code>classpath</code> ã€‚åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/loader/AgentClassLoader.java#L163" rel="external nofollow noopener noreferrer" target="_blank"><code>#getAllJars()</code></a>  æ–¹æ³•ä¸­ï¼ŒåŠ è½½è¯¥ç›®å½•ä¸‹çš„ Jar ä¸­çš„ Class æ–‡ä»¶ã€‚</li><li><code>allJars</code> å±æ€§ï¼ŒJar æ•°ç»„ã€‚</li><li><code>jarScanLock</code> å±æ€§ï¼ŒJar è¯»å–æ—¶çš„<strong>é”</strong>ã€‚</li></ul><hr><p><code>#initDefaultLoader()</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆå§‹åŒ–<strong>é»˜è®¤</strong>çš„ AgentClassLoader ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AgentClassLoader <span class="title">initDefaultLoader</span><span class="params">()</span> <span class="keyword">throws</span> AgentPackageNotFoundException </span>&#123;</div><div class="line">    DEFAULT_LOADER = <span class="keyword">new</span> AgentClassLoader(PluginBootstrap.class.getClassLoader());</div><div class="line">    <span class="keyword">return</span> getDefault();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨ <code>org.skywalking.apm.agent.core.plugin.PluginBootstrap</code> çš„ç±»åŠ è½½å™¨ä½œä¸º AgentClassLoader çš„<strong>çˆ¶ç±»åŠ è½½å™¨</strong>ã€‚</li></ul><hr><p>å¦‚ä¸‹æ–¹æ³•å·²ç»æ·»åŠ ç›¸å…³ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è¯·è‡ªè¡Œé˜…è¯»ç†è§£ ï¼š</p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/778093d38a0a820b90092c2ed77a08e3393169eb/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/loader/AgentClassLoader.java#L132" rel="external nofollow noopener noreferrer" target="_blank"><code>#findResource(name)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/778093d38a0a820b90092c2ed77a08e3393169eb/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/loader/AgentClassLoader.java#L150" rel="external nofollow noopener noreferrer" target="_blank"><code>#findResources(String name)</code></a></li><li><a href="https://github.com/YunaiV/skywalking/blob/778093d38a0a820b90092c2ed77a08e3393169eb/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/loader/AgentClassLoader.java#L182" rel="external nofollow noopener noreferrer" target="_blank"><code>#getAllJars()</code></a></li></ul><p>åœ¨ ClassLoader åŠ è½½èµ„æº( ä¾‹å¦‚ï¼Œç±» )ï¼Œä¼šè°ƒç”¨ <code>#findResource(name)</code> / <code>#findResources(name)</code> æ–¹æ³•ã€‚</p><h2>2.2 PluginResourcesResolver</h2><p><code>org.skywalking.apm.agent.core.plugin.PluginResourcesResolver</code> ï¼Œæ’ä»¶èµ„æºè§£æå™¨ï¼Œè¯»å–æ‰€æœ‰æ’ä»¶çš„å®šä¹‰æ–‡ä»¶ã€‚æ’ä»¶å®šä¹‰æ–‡ä»¶å¿…é¡»ä»¥ <code>skywalking-plugin.def</code> <strong>å‘½å</strong>ï¼Œä¾‹å¦‚ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/02.png" alt=""></p><p><a href="https://github.com/YunaiV/skywalking/blob/d4a6ba291419ab90379a3d1c423b747f682f857f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginResourcesResolver.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>#getResources()</code></a> æ–¹æ³•ï¼Œè·å¾—æ’ä»¶å®šä¹‰è·¯å¾„æ•°ç»„ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 50 è¡Œ ï¼šä½¿ç”¨ AgentClassLoader è·å¾—æ‰€æœ‰ <code>skywalking-plugin.def</code> çš„è·¯å¾„ã€‚</li></ul><h2>2.3 PluginCfg</h2><p><code>org.skywalking.apm.agent.core.plugin.PluginCfg</code> ï¼Œæ’ä»¶å®šä¹‰é…ç½®ï¼Œè¯»å– <code>skywalking-plugin.def</code> æ–‡ä»¶ï¼Œç”Ÿæˆæ’ä»¶å®šä¹‰( <a href="https://github.com/YunaiV/skywalking/blob/43241fff19e17f19b918c96ffd588787f8f05519/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginDefine.java#L27" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.PluginDefinie</code></a> )æ•°ç»„ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/43241fff19e17f19b918c96ffd588787f8f05519/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginCfg.java#L55" rel="external nofollow noopener noreferrer" target="_blank"><code>#load(InputStream)</code></a> æ–¹æ³•ï¼Œè¯»å– <code>skywalking-plugin.def</code> æ–‡ä»¶ï¼Œæ·»åŠ åˆ° <code>pluginClassList</code> ã€‚å¦‚ä¸‹æ˜¯ <code>apm-springmvc-annotation-4.x-plugin-3.2.6-2017.jar</code> æ’ä»¶çš„å®šä¹‰æ–‡ä»¶ ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">spring-mvc-annotation-4.x=org.skywalking.apm.plugin.spring.mvc.v4.define.ControllerInstrumentation</div><div class="line">spring-mvc-annotation-4.x=org.skywalking.apm.plugin.spring.mvc.v4.define.RestControllerInstrumentation</div><div class="line">spring-mvc-annotation-4.x=org.skywalking.apm.plugin.spring.mvc.v4.define.HandlerMethodInstrumentation</div><div class="line">spring-mvc-annotation-4.x=org.skywalking.apm.plugin.spring.mvc.v4.define.InvocableHandlerInstrumentation</div></pre></td></tr></table></figure></p><h2>2.4 AbstractClassEnhancePluginDefine</h2><p><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code> ï¼Œç±»å¢å¼ºæ’ä»¶å®šä¹‰<strong>æŠ½è±¡åŸºç±»</strong>ã€‚ä¸åŒæ’ä»¶é€šè¿‡å®ç° AbstractClassEnhancePluginDefine <strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰ä¸åŒæ¡†æ¶çš„<strong>åˆ‡é¢</strong>ï¼Œ<strong>è®°å½•è°ƒç”¨é“¾è·¯</strong>ã€‚ä»¥ Spring æ’ä»¶ä¸ºä¾‹å­ï¼Œå¦‚ä¸‹æ˜¯ç›¸å…³ç±»å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/06.png" alt=""></p><p>PluginDefine å¯¹è±¡çš„ <code>defineClass</code> å±æ€§ï¼Œå³å¯¹åº”ä¸åŒæ’ä»¶å¯¹AbstractClassEnhancePluginDefine çš„<strong>å®ç°ç±»</strong>ã€‚æ‰€ä»¥åœ¨ <a href="https://github.com/YunaiV/skywalking/blob/130f0a5a3438663b393e53ba2cca02a8d13c258a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginBootstrap.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>PluginBootstrap#loadPlugins()</code></a> æ–¹æ³•çš„ã€<strong>ç¬¬ 74 è¡Œ</strong>ã€‘ï¼Œæˆ‘ä»¬çœ‹åˆ°é€šè¿‡è¯¥å±æ€§ï¼Œåˆ›å»ºåˆ›å»º<strong>ç±»å¢å¼ºæ’ä»¶å®šä¹‰</strong>å¯¹è±¡ã€‚</p><h2>2.5 å°ç»“</h2><p>èƒ–å‹ï¼Œå›è¿‡å¤´ï¼Œåœ¨çœ‹ä¸€ä¸‹æµç¨‹å›¾ï¼Œç†è§£ç†è§£ã€‚</p><h1>3. æ’ä»¶çš„åŒ¹é…</h1><p>åœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-init/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent åˆå§‹åŒ–ã€‹</a> ä¸€æ–‡ï¼Œæˆ‘ä»¬æåˆ°ï¼ŒSkyWalking Agent åŸºäº <strong>JavaAgent</strong> æœºåˆ¶ï¼Œå®ç°åº”ç”¨<strong>é€æ˜</strong>æ¥å…¥ SkyWalking ã€‚ä¸‹é¢ç¬”è€…é»˜è®¤èƒ–å‹å·²ç»å¯¹ JavaAgent æœºåˆ¶å·²ç»æœ‰ä¸€å®šçš„äº†è§£ã€‚å¦‚æœèƒ–å‹æš‚æ—¶ä¸äº†è§£ï¼Œå»ºè®®å…ˆé˜…è¯»å¦‚ä¸‹æ–‡ç«  ï¼š</p><ul><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠInstrumentation æ–°åŠŸèƒ½ã€‹</a></li><li><a href="http://www.infoq.com/cn/articles/javaagent-illustrated" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJVMæºç åˆ†æä¹‹javaagentåŸç†å®Œå…¨è§£è¯»ã€‹</a></li></ul><blockquote><p>å‹æƒ…æç¤º ï¼šå»ºè®®è‡ªå·±æ‰‹æ’¸ä¸€ä¸ªç®€å•çš„ JavaAgent ï¼Œæ›´å®¹æ˜“ç†è§£ SkyWalking Agent ã€‚</p><p>ç¬”è€…ç»ƒæ‰‹çš„ JavaAgent é¡¹ç›®åœ°å€ ï¼šhttps://github.com/YunaiV/learning/tree/master/javaagent01</p></blockquote><p>é€šè¿‡ JavaAgent æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>#premain(String, Instrumentation)</code> æ–¹æ³•é‡Œï¼Œè°ƒç”¨ <code>Instrumentation#addTransformer(ClassFileTransformer)</code> æ–¹æ³•ï¼Œå‘ Instrumentation æ³¨å†Œ <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/ClassFileTransformer.html" rel="external nofollow noopener noreferrer" target="_blank"><code>java.lang.instrument.ClassFileTransformer</code></a> å¯¹è±¡ï¼Œå¯ä»¥ä¿®æ”¹ Java ç±»çš„äºŒè¿›åˆ¶ï¼Œä»è€Œ<strong>åŠ¨æ€</strong>ä¿®æ”¹ Java ç±»çš„ä»£ç å®ç°ã€‚</p><p>å¦‚æœèƒ–å‹ä½¿ç”¨è¿‡ AOP å®ç°åˆ‡é¢è®°å½•æ—¥å¿—ï¼Œé‚£ä¹ˆå°±å¾ˆå®¹æ˜“ç†è§£ï¼ŒSkyWalking é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä½¿ç”¨ä¸åŒæ¡†æ¶å®šä¹‰<strong>æ–¹æ³•åˆ‡é¢</strong>ï¼Œä»è€Œåœ¨åœ¨åˆ‡é¢<strong>è®°å½•è°ƒç”¨é“¾è·¯</strong>ã€‚</p><hr><p>ç›´æ¥ä¿®æ”¹ Java ç±»çš„äºŒè¿›åˆ¶ï¼Œæ˜¯éå¸¸ç¹æ‚çš„ã€‚å› æ­¤ï¼ŒSkyWalking å¼•å…¥äº† <a href="https://github.com/raphw/byte-buddy" rel="external nofollow noopener noreferrer" target="_blank"><code>byte-buddy</code></a> ã€‚</p><blockquote><p><code>byte-buddy</code> æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå’Œæ“ä½œåº“ï¼Œç”¨äºåœ¨ Java åº”ç”¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºå’Œä¿®æ”¹ Java ç±»ï¼Œè€Œå¾æ— éœ€ç¼–è¯‘å™¨çš„å¸®åŠ©ã€‚</p><p>é™¤äº†å‚ä¸ Java ç±»åº“ä¸€èµ·æä¾›ä»£ç ç”Ÿæˆå·¥å…·å¤–ï¼Œ<code>byte-buddy</code> å…è®¸åˆ›å»ºä»»æ„ç±»ï¼Œå¹¶ä¸é™äºå®ç°ç”¨äºåˆ›å»ºè¿è¡Œæ—¶ä»£ç†çš„æ¥å£ã€‚</p><p>æ­¤å¤–ï¼Œ<code>byte-buddy</code> æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„ API ï¼Œç”¨äº Java Agent æˆ–åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ›´æ”¹ç±»ã€‚</p></blockquote><p>ä¸‹é¢ç¬”è€…é»˜è®¤èƒ–å‹å·²ç»å¯¹ <code>byte-buddy</code> æœ‰ä¸€å®šçš„äº†è§£ã€‚å¦‚æœèƒ–å‹æš‚ä¸äº†è§£ï¼Œå»ºè®®å…ˆé˜…è¯»å¦‚ä¸‹æ–‡ç«  ï¼š</p><ul><li><a href="http://www.jianshu.com/p/fe1448bf7d31" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­—èŠ‚ç 3-ä½¿ç”¨ByteBuddyå®ç°ä¸€ä¸ªJava-Agentã€‹</a></li><li><a href="https://notes.diguage.com/byte-buddy-tutorial/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠByte Buddy æ•™ç¨‹ã€‹</a></li><li><a href="https://www.infoq.com/articles/Easily-Create-Java-Agents-with-ByteBuddy" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠEasily Create Java Agents with Byte Buddyã€‹</a></li><li><a href="http://www.kailing.pub/article/index/arcid/178.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šskywalkingæºç åˆ†æä¹‹javaAgentå·¥å…·ByteBuddyçš„åº”ç”¨ã€‹</a> æœç´¢ &quot;BYTE BUDDYåº”ç”¨&quot; éƒ¨åˆ†</li></ul><blockquote><p>å‹æƒ…æç¤º ï¼šå»ºè®®è‡ªå·±ç®€å•ä½¿ç”¨ä¸‹ <code>byte-buddy</code> ï¼Œæ›´å®¹æ˜“ç†è§£ SkyWalking Agent ã€‚</p><p>ç¬”è€…ç»ƒæ‰‹çš„ <code>byte-buddy</code> é¡¹ç›®åœ°å€ ï¼šhttps://github.com/YunaiV/learning/tree/master/bytebuddy</p></blockquote><hr><p>ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ‰“å¼€ <a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent/src/main/java/org/skywalking/apm/agent/SkyWalkingAgent.java#L79" rel="external nofollow noopener noreferrer" target="_blank"><code>SkyWalkingAgent#premain(String, Instrumentation)</code></a> æ–¹æ³•ï¼Œä»ã€ç¬¬ 79 è¡Œã€‘ä»£ç å¼€å§‹çœ‹ ï¼š</p><ul><li>ç¬¬ 79 è‡³ 104 è¡Œ ï¼šåˆ›å»º <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/agent/builder/AgentBuilder.java" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.agent.builder.AgentBuilder</code></a> å¯¹è±¡ï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ã€‚<ul><li>AgentBuilder ï¼Œæä¾›ä¾¿åˆ©çš„ API ï¼Œåˆ›å»º Java Agent ã€‚</li><li>ç¬¬ 79 è¡Œ ï¼šè°ƒç”¨ <code>AgentBuilder#type(ElementMatcher)</code> æ–¹æ³•ï¼Œå®ç° <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/matcher/ElementMatcher.java#L13" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.matcher.ElementMatcher</code></a> æ¥å£ï¼Œè®¾ç½®éœ€è¦æ‹¦æˆªçš„ç±»ã€‚<code>PluginFinder#buildMatch()</code> æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡ <a href="#">ã€Œ3.3 PluginFinderã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 79 è‡³ 104 è¡Œ ï¼šè°ƒç”¨ <code>AgentBuilder#transform(Transformer)</code> æ–¹æ³•ï¼Œè®¾ç½® Java ç±»çš„ä¿®æ”¹é€»è¾‘ã€‚<ul><li>ç¬¬ 84 è¡Œ ï¼šè°ƒç”¨ <code>PluginFinder#find(TypeDescription, ClassLoader)</code> æ–¹æ³•ï¼Œè·å¾—<strong>åŒ¹é…</strong>çš„ AbstractClassEnhancePluginDefine æ•°ç»„ã€‚å› ä¸ºåœ¨ã€<strong>ç¬¬ 79 è¡Œ</strong>ã€‘çš„ä»£ç ï¼Œè®¾ç½®äº†<strong>æ‰€æœ‰</strong>æ’ä»¶éœ€è¦æ‹¦æˆªçš„ç±»ï¼Œæ‰€ä»¥æ­¤å¤„éœ€è¦åŒ¹é…<strong>è¯¥ç±»å¯¹åº”</strong>çš„ AbstractClassEnhancePluginDefine æ•°ç»„ã€‚<code>PluginFinder#find(TypeDescription, ClassLoader)</code> æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡ <a href="#">ã€Œ3.3 PluginFinderã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 85 è¡Œ ï¼šåˆ¤æ–­åŒ¹é…çš„ AbstractClassEnhancePluginDefine æ•°ç»„å¤§äºé›¶ã€‚ä»ç›®å‰çš„ä»£ç çœ‹ä¸‹æ¥ï¼Œæ­¤å¤„å±äº<strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>ï¼Œåœ¨ã€<strong>ç¬¬ 79 è¡Œ</strong>ã€‘çš„ä»£ç ä¿è¯ä¸€å®šèƒ½åŒ¹é…åˆ° AbstractClassEnhancePluginDefine ã€‚</li><li>ç¬¬ 86 è‡³ 100 è¡Œ ï¼šå¾ªç¯åŒ¹é…åˆ° AbstractClassEnhancePluginDefine æ•°ç»„ï¼Œè°ƒç”¨ <code>AbstractClassEnhancePluginDefine#define(...)</code> æ–¹æ³•ï¼Œè®¾ç½® <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/dynamic/DynamicType.java" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.dynamic.DynamicType.Builder</code></a> å¯¹è±¡ã€‚é€šè¿‡è¯¥å¯¹è±¡ï¼Œå®šä¹‰<strong>å¦‚ä½•æ‹¦æˆª</strong>éœ€è¦ä¿®æ”¹çš„ Java ç±»ã€‚åœ¨ <code>AbstractClassEnhancePluginDefine#define(...)</code> æ–¹æ³•çš„å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/dynamic/DynamicType.java#L1512" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.dynamic.DynamicType.ImplementationDefinition#intercept(Implementation)</code></a> æ–¹æ³•ï¼Œæœ¬æ–‡ <a href="#">ã€Œ4. æ’ä»¶çš„æ‹¦æˆªã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li><li>ç¬¬ 91 è¡Œ ï¼šä¸ºä»€ä¹ˆä¼šå‡ºç°è¿”å›ä¸º<strong>ç©º</strong>çš„æƒ…å†µå‘¢ï¼ŸåŒä¸€ä¸ªæ¡†æ¶åœ¨ä¸åŒçš„<strong>å¤§</strong>ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„æ–¹å¼ç›¸åŒï¼Œä½†æ˜¯å®ç°çš„ä»£ç å´ä¸å°½ç›¸åŒã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒSpringMVC 3 å’Œ SpringMVC 4 ï¼Œ<strong>éƒ½</strong>æœ‰ <code>@RequestMapping</code> æ³¨è§£å®šä¹‰ URL ï¼Œæ‰€ä»¥ã€<strong>ç¬¬ 84 è¡Œ</strong>ã€‘ä¼šåŒ¹é…åˆ° <code>AbstractSpring3Instrumentation</code> / <code>AbstractSpring4Instrumentation</code> <strong>ä¸¤ä¸ª</strong>ã€‚å½“åº”ç”¨ä½¿ç”¨çš„æ˜¯ Spring MVC 4 æ—¶ï¼Œè°ƒç”¨ <code>AbstractSpring3Instrumentation#define(...)</code> æ–¹æ³•ä¼šè¿”å›ç©ºï¼Œè€Œè°ƒç”¨ <code>AbstractSpring4Instrumentation#define(...)</code> æ–¹æ³•ä¼šæœ‰è¿”å›å€¼ã€‚è¿™æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæœ¬æ–‡ <a href="#">ã€Œ4. æ’ä»¶çš„æ‹¦æˆªã€</a> ä¹Ÿä¼šè¯¦ç»†è§£æã€‚</li></ul></li></ul></li><li>ç¬¬ 105 è‡³ 134 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/agent/builder/AgentBuilder.java#L114" rel="external nofollow noopener noreferrer" target="_blank"><code>AgentBuilder#with(Listener)</code></a> æ–¹æ³•ï¼Œæ·»åŠ ç›‘å¬å™¨ã€‚<ul><li><code>#onTransformation(...)</code> æ–¹æ³•ï¼Œå½“ Java ç±»çš„ä¿®æ”¹<strong>æˆåŠŸ</strong>ï¼Œè¿›è¡Œè°ƒç”¨ã€‚</li><li><code>#onError(...)</code> æ–¹æ³•ï¼Œå½“ Java ç±»çš„ä¿®æ”¹<strong>å¤±è´¥</strong>ï¼Œè¿›è¡Œè°ƒç”¨ã€‚InstrumentDebuggingClass åœ¨æœ¬æ–‡ <a href="#">ã€Œ3.1 InstrumentDebuggingClassã€</a> è¯¦ç»†è§£æã€‚</li></ul></li><li>ç¬¬ 135 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/raphw/byte-buddy/blob/master/byte-buddy-dep/src/main/java/net/bytebuddy/agent/builder/AgentBuilder.java#L620" rel="external nofollow noopener noreferrer" target="_blank"><code>AgentBuilder#installOn(Instrumentation)</code></a> æ–¹æ³•ï¼Œæ ¹æ®<strong>ä¸Šé¢</strong> AgentBuilder è®¾ç½®çš„å±æ€§ï¼Œåˆ›å»º <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/agent/builder/ResettableClassFileTransformer.java" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.agent.builder.ResettableClassFileTransformer</code></a> å¯¹è±¡ï¼Œé…ç½®åˆ° Instrumentation å¯¹è±¡ä¸Šã€‚åœ¨ <code>AgentBuilder#installOn(Instrumentation)</code> æ–¹æ³•çš„å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>Instrumentation#addTransformer(ClassFileTransformer)</code> æ–¹æ³•ã€‚</li></ul><hr><p>ğŸ˜ˆ è¿™ä¸ªæ–¹æ³•ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œç¬”è€…å¯¹ <code>byte-buddy</code> ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼ŒèŠ±è´¹äº†è¾ƒå¤šæ—¶é—´æ¢³ç†ä¸ç†è§£ã€‚å»ºè®®ï¼Œå¦‚æœèƒ–å‹æ­¤å¤„ä¸æ˜¯ç†è§£çš„å¾ˆæ¸…æ™°ï¼Œå¯ä»¥é˜…è¯»å®Œå…¨æ–‡ï¼Œåœ¨å›è¿‡å¤´å†æ‹ä¸€æ‹è¿™å—çš„ä»£ç å®ç°ã€‚</p><h2>3.1 InstrumentDebuggingClass</h2><p><code>org.skywalking.apm.agent.InstrumentDebuggingClass</code> ï¼ŒInstrument è°ƒè¯•ç±»ï¼Œç”¨äºå°†è¢« JavaAgent ä¿®æ”¹çš„<strong>æ‰€æœ‰</strong>ç±»å­˜å‚¨åˆ° <code>${JAVA_AGENT_PACKAGE}/debugger</code> ç›®å½•ä¸‹ã€‚éœ€è¦é…ç½® <code>agent.is_open_debugging_class = true</code> ï¼Œæ•ˆæœå¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/04.png" alt=""></p><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡» <a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent/src/main/java/org/skywalking/apm/agent/InstrumentDebuggingClass.java" rel="external nofollow noopener noreferrer" target="_blank">InstrumentDebuggingClass</a> ç†è§£ã€‚</p><h2>3.2 ClassMatch</h2><p>åœ¨åˆ†äº«æœ¬èŠ‚ç›¸å…³å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ <code>bytebuddy</code> çš„ <a href="https://github.com/raphw/byte-buddy/tree/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/matcher" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.matcher</code></a> æ¨¡å—ã€‚è¯¥æ¨¡å—æä¾›äº†å„ç§çµæ´»çš„åŒ¹é…æ–¹æ³•ã€‚é‚£ä¹ˆ SkyWalking ä¸ºä»€ä¹ˆå®ç°è‡ªå·±çš„ <a href="https://github.com/YunaiV/skywalking/tree/43241fff19e17f19b918c96ffd588787f8f05519/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/match" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.match</code></a> æ¨¡å—ï¼Ÿç¬”è€…è®¤ä¸ºï¼Œä»…å®šä½äº<strong>ç±»çº§åˆ«çš„åŒ¹é…</strong>ï¼Œæ›´å¸¸ç”¨è€Œåˆç²¾ç®€çš„ API ã€‚</p><hr><p><code>org.skywalking.apm.agent.core.plugin.match.ClassMatch</code> ï¼Œç±»åŒ¹é…<strong>æ¥å£</strong>ã€‚ç›®å‰å­ç±»å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/05.png" alt=""></p><ul><li><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/match/NameMatch.java#L28" rel="external nofollow noopener noreferrer" target="_blank">NameMatch</a> ï¼šåŸºäº<strong>å®Œæ•´çš„ç±»å</strong>è¿›è¡ŒåŒ¹é…ï¼Œä¾‹å¦‚ï¼š<code>&quot;com.alibaba.dubbo.monitor.support.MonitorFilter&quot;</code> ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/match/IndirectMatch.java" rel="external nofollow noopener noreferrer" target="_blank">IndirectMatch</a> ï¼š<strong>é—´æ¥</strong>åŒ¹é…<strong>æ¥å£</strong>ã€‚ç›¸æ¯” NameMatch æ¥è¯´ï¼Œç¡®å®æ¯”è¾ƒ &quot;å§”å©‰&quot; ğŸ™‚ ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/match/ClassAnnotationMatch.java" rel="external nofollow noopener noreferrer" target="_blank">ClassAnnotationMatch</a> ï¼šåŸºäº<strong>ç±»æ³¨è§£</strong>è¿›è¡ŒåŒ¹é…ï¼Œå¯è®¾ç½®<strong>åŒæ—¶</strong>åŒ¹é…å¤šä¸ªã€‚ä¾‹å¦‚ï¼š<code>&quot;@RequestMapping&quot;</code>ã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/match/HierarchyMatch.java" rel="external nofollow noopener noreferrer" target="_blank">HierarchyMatch</a> ï¼šåŸºäº<strong>çˆ¶ç±» / æ¥å£</strong>è¿›è¡ŒåŒ¹é…ï¼Œå¯è®¾ç½®<strong>åŒæ—¶</strong>åŒ¹é…å¤šä¸ªã€‚</li><li><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/match/MethodAnnotationMatch.java" rel="external nofollow noopener noreferrer" target="_blank">MethodAnnotationMatch</a> ï¼šåŸºäº<strong>æ–¹æ³•æ³¨è§£</strong>è¿›è¡ŒåŒ¹é…ï¼Œå¯è®¾ç½®<strong>åŒæ—¶</strong>åŒ¹é…å¤šä¸ªã€‚ç›®å‰é¡¹ç›®é‡Œä¸»è¦ç”¨äºåŒ¹é…æ–¹æ³•ä¸Šçš„  <a href="https://github.com/OpenSkywalking/skywalking/blob/8d9820322bdfc956d9d4f0d04f55ce985926cfae/apm-application-toolkit/apm-toolkit-trace/src/main/java/org/apache/skywalking/apm/toolkit/trace/Trace.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.toolkit.trace.@Trace</code></a> æ³¨è§£ã€‚</li></ul></li></ul><p>æ¯ä¸ªç±»å·²ç»æ·»åŠ è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹å–œæ¬¢å“ªä¸ªç‚¹å“ªä¸ªå“Ÿã€‚</p><h2>3.3 PluginFinder</h2><p><code>org.skywalking.apm.agent.core.plugin.PluginFinder</code> ï¼Œæ’ä»¶å‘ç°è€…ã€‚å…¶æä¾› <a href="https://github.com/YunaiV/skywalking/blob/09c654af33081e56547cb8b3b9e0c8525ddce32f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginFinder.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#find(...)</code></a> æ–¹æ³•ï¼Œè·å¾—<strong>ç±»å¢å¼ºæ’ä»¶å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code></a> )å¯¹è±¡ã€‚</p><p>PluginFinder <strong><a href="https://github.com/YunaiV/skywalking/blob/09c654af33081e56547cb8b3b9e0c8525ddce32f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginFinder.java#L56" rel="external nofollow noopener noreferrer" target="_blank">æ„é€ æ–¹æ³•</a></strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 57 è‡³ 77 è¡Œ ï¼šå¾ªç¯ AbstractClassEnhancePluginDefine å¯¹è±¡æ•°ç»„ï¼Œæ·»åŠ åˆ° <code>nameMatchDefine</code> / <code>signatureMatchDefine</code> å±æ€§ï¼Œæ–¹ä¾¿ <code>#find(...)</code> æ–¹æ³•æŸ¥æ‰¾ AbstractClassEnhancePluginDefine å¯¹è±¡ã€‚<ul><li>ç¬¬ 65 è‡³ 72 è¡Œ ï¼šå¤„ç† NameMatch ä¸ºåŒ¹é…çš„ AbstractClassEnhancePluginDefine å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nameMatchDefine</code>  å±æ€§ã€‚</li><li>ç¬¬ 74 è‡³ 76 è¡Œ ï¼šå¤„ç†<strong>é</strong> NameMatch ä¸ºåŒ¹é…çš„ AbstractClassEnhancePluginDefine å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>signatureMatchDefine</code> å±æ€§ã€‚</li></ul></li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginFinder.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#find(...)</code></a> æ–¹æ³•ï¼Œè·å¾—<strong>ç±»å¢å¼ºæ’ä»¶å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code></a> )å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 92 è‡³ 96 è¡Œ ï¼šä»¥ <code>nameMatchDefine</code> å±æ€§æ¥åŒ¹é… AbstractClassEnhancePluginDefine å¯¹è±¡ã€‚</li><li>ç¬¬ 98 è‡³ 104 è¡Œ ï¼šä»¥ <code>signatureMatchDefine</code> å±æ€§æ¥åŒ¹é… AbstractClassEnhancePluginDefine å¯¹è±¡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ <code>IndirectMatch#isMatch(TypeDescription)</code> æ–¹æ³•ï¼Œè¿›è¡ŒåŒ¹é…ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/b68162306b4db7adfd4a2c2891a205b7085f38f0/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginFinder.java#L116" rel="external nofollow noopener noreferrer" target="_blank"><code>#buildMatch()</code></a> æ–¹æ³•ï¼Œè·å¾—å…¨éƒ¨æ’ä»¶çš„ç±»åŒ¹é…ï¼Œå¤šä¸ªæ’ä»¶çš„ç±»åŒ¹é…æ¡ä»¶ä»¥ <code>or</code> åˆ†éš”ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 117 è‡³ 123 è¡Œ ï¼šä»¥ <code>nameMatchDefine</code> å±æ€§æ¥åŒ¹é…ã€‚</li><li>ç¬¬ 124 è‡³ 132 è¡Œ ï¼šä»¥ <code>signatureMatchDefine</code> å±æ€§æ¥åŒ¹é…ã€‚</li><li><strong>å®é™…ä¸Šï¼Œè¯¥æ–¹æ³•å’Œ <code>#find(...)</code> æ–¹æ³•é€»è¾‘æ˜¯ä¸€è‡´çš„</strong>ã€‚</li></ul><h1>4. æ’ä»¶çš„æ‹¦æˆª</h1><p>åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»æåˆ°ï¼ŒSkyWalking é€šè¿‡ JavaAgent æœºåˆ¶ï¼Œå¯¹éœ€è¦æ‹¦æˆªçš„ç±»çš„æ–¹æ³•ï¼Œä½¿ç”¨ <code>byte-buddy</code> <strong>åŠ¨æ€</strong>ä¿®æ”¹ Java ç±»çš„äºŒè¿›åˆ¶ï¼Œä»è€Œè¿›è¡Œæ–¹æ³•åˆ‡é¢æ‹¦æˆªï¼Œè®°å½•è°ƒç”¨é“¾è·¯ã€‚</p><p>çœ‹å…·ä½“çš„ä»£ç å®ç°ä¹‹å‰ï¼Œæƒ³ä¸€ä¸‹<strong>æ‹¦æˆª</strong>ä¼šæ¶‰åŠåˆ°å“ªäº›å…ƒç´  ï¼š</p><ul><li>æ‹¦æˆªåˆ‡é¢ InterceptPoint</li><li>æ‹¦æˆªå™¨ Interceptor</li><li>æ‹¦æˆªç±»çš„å®šä¹‰ Define ï¼šä¸€ä¸ªç±»æœ‰å“ªäº›æ‹¦æˆªåˆ‡é¢åŠå¯¹åº”çš„æ‹¦æˆªå™¨</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æœ¬å°èŠ‚ä¼šæ¶‰åŠåˆ°çš„ç±»ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/06.png" alt=""></p><p>çœ‹èµ·æ¥ç±»æ¯”æƒ³è±¡çš„å¤šï¼Ÿæ¢³ç†ä¹‹ï¼Œç»“æœå¦‚å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/07.png" alt=""></p><ul><li><p>æ ¹æ®æ–¹æ³•ç±»å‹çš„ä¸åŒï¼Œä½¿ç”¨ä¸åŒ ClassEnhancePluginDefine çš„å®ç°ç±»ã€‚å…¶ä¸­ï¼Œæ„é€ æ–¹æ³•å’Œé™æ€æ–¹æ³•ä½¿ç”¨ç›¸åŒçš„å®ç°ç±»ã€‚</p></li><li><p>ç›¸æ¯”ä¸Šé¢æåˆ°<strong>æ‹¦æˆª</strong>ä¼šæ¶‰åŠåˆ°çš„å…ƒç´ ï¼Œå¤šäº†ä¸€ä¸ª <strong>Inter</strong> ï¼Ÿå¦‚ä¸‹æ˜¯å®˜æ–¹çš„è¯´æ˜ ï¼š</p><blockquote><p>In this class, it provide a bridge between <code>byte-buddy</code> and <code>sky-walking</code> plugin.</p></blockquote></li></ul><h2>4.1 ClassEnhancePluginDefine</h2><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/08.png" alt=""></p><ul><li>AbstractClassEnhancePluginDefine ï¼šSkyWalking ç±»å¢å¼ºæ’ä»¶å®šä¹‰<strong>æŠ½è±¡åŸºç±»</strong>ã€‚</li><li>ClassEnhancePluginDefine ï¼šSkyWalking ç±»å¢å¼ºæ’ä»¶å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ã€‚</li><li>ä» UML å›¾ä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒAbstractClassEnhancePluginDefine æ³¨é‡åœ¨<strong>å®šä¹‰</strong>( Define )ï¼ŒClassEnhancePluginDefine æ³¨é‡åœ¨<strong>å¢å¼º</strong>( Enhance )ã€‚</li></ul><p>æ•´ä½“æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/09.png" alt=""></p><p>OK ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹çœ‹çœ‹ä»£ç æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h3>4.1.1 AbstractClassEnhancePluginDefine</h3><p><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code> ï¼ŒSkyWalking ç±»å¢å¼ºæ’ä»¶å®šä¹‰<strong>æŠ½è±¡åŸºç±»</strong>ã€‚å®ƒæ³¨é‡åœ¨<strong>å®šä¹‰</strong>( Define )çš„æŠ½è±¡ä¸å®ç°ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/30683167c79c71ad088666c587a05c6d9f0daf3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java#L93" rel="external nofollow noopener noreferrer" target="_blank"><code>#enhanceClass()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®šä¹‰äº†ç±»åŒ¹é…( ClassMatch ) ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/30683167c79c71ad088666c587a05c6d9f0daf3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java#L105" rel="external nofollow noopener noreferrer" target="_blank"><code>#witnessClasses()</code></a> æ–¹æ³•ï¼Œè§è¯ç±»åˆ—è¡¨ã€‚å½“ä¸”ä»…å½“åº”ç”¨å­˜åœ¨è§è¯ç±»åˆ—è¡¨ï¼Œæ’ä»¶æ‰ç”Ÿæ•ˆã€‚<strong>ä»€ä¹ˆæ„æ€</strong>ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹è¿™ç§æƒ…å†µï¼šä¸€ä¸ª<strong>ç±»åº“</strong>å­˜åœ¨ä¸¤ä¸ªå‘å¸ƒçš„ç‰ˆæœ¬( å¦‚ <code>1.0</code> å’Œ <code>2.0</code> )ï¼Œå…¶ä¸­åŒ…æ‹¬<strong>ç›¸åŒ</strong>çš„ç›®æ ‡ç±»ï¼Œä½†ä¸åŒçš„æ–¹æ³•æˆ–ä¸åŒçš„æ–¹æ³•å‚æ•°åˆ—è¡¨ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®åº“çš„ä¸åŒç‰ˆæœ¬ä½¿ç”¨æ’ä»¶çš„ä¸åŒç‰ˆæœ¬ã€‚ç„¶è€Œç‰ˆæœ¬æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªé€‰é¡¹ï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨è§è¯ç±»åˆ—è¡¨ï¼Œåˆ¤æ–­å‡ºå½“å‰å¼•ç”¨ç±»åº“çš„å‘å¸ƒç‰ˆæœ¬ã€‚</p><ul><li>ä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼ŒSpringMVC 3 å’Œ SpringMVC 4 ï¼Œ<strong>éƒ½</strong>æœ‰ <code>@RequestMapping</code> æ³¨è§£å®šä¹‰ URL ã€‚<ul><li>é€šè¿‡åˆ¤æ–­å­˜åœ¨ <code>org.springframework.web.servlet.view.xslt.AbstractXsltView</code> ç±»ï¼Œåº”ç”¨ä½¿ç”¨ SpringMVC 3 ï¼Œä½¿ç”¨ <code>apm-springmvc-annotation-3.x-plugin.jar</code> ã€‚</li><li>é€šè¿‡åˆ¤æ–­å­˜åœ¨ <code>org.springframework.web.servlet.tags.ArgumentTag</code> ç±»ï¼Œåº”ç”¨ä½¿ç”¨ SpringMVC 4 ï¼Œä½¿ç”¨ <code>apm-springmvc-annotation-4.x-plugin.jar</code> ã€‚</li></ul></li><li><strong>å¦å¤–</strong>ï¼Œè¯¥æ–¹æ³•è¿”å›<strong>ç©ºæ•°ç»„</strong>ã€‚å³é»˜è®¤æƒ…å†µï¼Œæ’ä»¶ç”Ÿæ•ˆï¼Œæ— éœ€è§è¯ç±»åˆ—è¡¨ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/30683167c79c71ad088666c587a05c6d9f0daf3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java#L46" rel="external nofollow noopener noreferrer" target="_blank"><code>#define(...)</code></a> æ–¹æ³•ï¼Œè®¾ç½® <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/dynamic/DynamicType.java" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.dynamic.DynamicType.Builder</code></a> å¯¹è±¡ã€‚é€šè¿‡è¯¥å¯¹è±¡ï¼Œå®šä¹‰<strong>å¦‚ä½•æ‹¦æˆª</strong>éœ€è¦ä¿®æ”¹çš„ç›®æ ‡ Java ç±»(æ–¹æ³•çš„ <code>transformClassName</code> å‚æ•°)ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 57 è‡³ 70 è¡Œ ï¼šåˆ¤æ–­è§è¯ç±»åˆ—è¡¨æ˜¯å¦éƒ½å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™æ’ä»¶ä¸ç”Ÿæ•ˆã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/30683167c79c71ad088666c587a05c6d9f0daf3f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/WitnessClassFinder.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.WitnessClassFinder</code></a> ï¼Œå·²ç»æ·»åŠ å®Œæ•´æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚</li></ul></li><li>ç¬¬ 72 è‡³ 76 è¡Œ ï¼šè°ƒç”¨ <code>#enhance(...)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å¢å¼ºç›®æ ‡ç±»ã€‚</li></ul><h3>4.1.2 ClassEnhancePluginDefine</h3><p><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassEnhancePluginDefine</code> ï¼ŒSkyWalking ç±»å¢å¼ºæ’ä»¶å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ã€‚å®ƒæ³¨é‡åœ¨<strong>å¢å¼º</strong>( Enhance )çš„æŠ½è±¡ä¸å®ç°ã€‚åŒ…æ‹¬å¦‚ä¸‹ ï¼š</p><ul><li>é™æ€æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€å®ä¾‹æ–¹æ³•çš„<strong>å¢å¼º</strong></li><li>é™æ€æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€å®ä¾‹æ–¹æ³•çš„<strong>æ‹¦æˆªåˆ‡é¢</strong></li></ul><hr><p>æ‹¦æˆªåˆ‡é¢ï¼Œåœ¨ <a href="#">ã€Œ4.2 InterceptPointã€</a> æœ‰ç›¸å…³è§£æã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassEnhancePluginDefine.java#L248" rel="external nofollow noopener noreferrer" target="_blank"><code>#getStaticMethodsInterceptPoints()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— StaticMethodsInterceptPoint <strong>æ•°ç»„</strong>ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassEnhancePluginDefine.java#L185" rel="external nofollow noopener noreferrer" target="_blank"><code>#getConstructorsInterceptPoints()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— ConstructorInterceptPoint <strong>æ•°ç»„</strong>ã€‚<br><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassEnhancePluginDefine.java#L192" rel="external nofollow noopener noreferrer" target="_blank"><code>#getInstanceMethodsInterceptPoints()</code></a> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— InstanceMethodsInterceptPoint <strong>æ•°ç»„</strong>ã€‚</p><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassEnhancePluginDefine.java#L67" rel="external nofollow noopener noreferrer" target="_blank"><code>#enhance(...)</code></a> æ–¹æ³•ï¼Œå¢å¼ºé™æ€æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€å®ä¾‹æ–¹æ³•ã€‚</p><h4>4.1.2.1 å¢å¼ºé™æ€æ–¹æ³•</h4><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassEnhancePluginDefine.java#L203" rel="external nofollow noopener noreferrer" target="_blank"><code>#enhanceClass(...)</code></a> æ–¹æ³•ï¼Œå¢å¼ºé™æ€æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 206 è‡³ 210 è¡Œ ï¼šè°ƒç”¨ <code>#getStaticMethodsInterceptPoints()</code> æ–¹æ³•ï¼Œè·å¾— StaticMethodsInterceptPoint æ•°ç»„ã€‚è‹¥ä¸º<strong>ç©º</strong>ï¼Œä¸è¿›è¡Œå¢å¼ºã€‚</li><li>ç¬¬ 212 è‡³ 238 è¡Œ ï¼š<strong>éå†</strong> StaticMethodsInterceptPoint æ•°ç»„ï¼Œé€ä¸ªå¢å¼ºStaticMethodsInterceptPoint å¯¹åº”çš„é™æ€æ–¹æ³•ã€‚<ul><li>ç¬¬ 214 è‡³ 218 è¡Œ ï¼šè·å¾—æ‹¦æˆªå™¨çš„<strong>ç±»å</strong>ã€‚æ‹¦æˆªå™¨çš„å®ä¾‹ï¼Œåœ¨ <strong>Inter ç±»</strong>é‡Œè·å–ã€‚</li><li>ç¬¬ 221 è‡³ 229 è¡Œ ï¼šå½“ <code>StaticMethodsInterceptPoint#isOverrideArgs()</code> æ–¹æ³•è¿”å› <code>true</code> æ—¶ï¼Œä½¿ç”¨ StaticMethodsInterWithOverrideArgs å¤„ç†æ‹¦æˆªé€»è¾‘ã€‚åœ¨ <a href="#">ã€Œ4.4.3 é™æ€æ–¹æ³• Interã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 230 è‡³ 236 è¡Œ ï¼šå½“ <code>StaticMethodsInterceptPoint#isOverrideArgs()</code> æ–¹æ³•è¿”å› <code>false</code> æ—¶ï¼Œä½¿ç”¨ StaticMethodsInter å¤„ç†æ‹¦æˆªé€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4.4.3 é™æ€æ–¹æ³• Interã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h4>4.1.2.2 å¢å¼ºæ„é€ æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•</h4><p>è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassEnhancePluginDefine.java#L89" rel="external nofollow noopener noreferrer" target="_blank"><code>#enhanceInstance()</code></a> æ–¹æ³•ï¼Œå¢å¼ºæ„é€ æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 92 è‡³ 110 è¡Œ ï¼šè°ƒç”¨ <code>#getConstructorsInterceptPoints()</code> / <code>#getInstanceMethodsInterceptPoints()</code>  æ–¹æ³•ï¼Œè·å¾— ConstructorInterceptPoint / InstanceMethodsInterceptPoint æ•°ç»„ã€‚è‹¥<strong>éƒ½</strong>ä¸º<strong>ç©º</strong>ï¼Œä¸è¿›è¡Œå¢å¼ºã€‚</li><li>ç¬¬ 112 è‡³ 128 è¡Œ ï¼šä½¿ç”¨ <code>byte-buddy</code> ï¼Œä¸ºç›®æ ‡ Java ç±»**&quot;è‡ªåŠ¨&quot;<strong>å®ç° <a href="https://github.com/OpenSkywalking/skywalking/blob/15328202b8b7df89a609885d9110361ff29ce668/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/plugin/interceptor/enhance/EnhancedInstance.java#L25" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.EnhancedInstance</code></a> æ¥å£ã€‚è¿™æ ·ï¼Œç›®æ ‡ Java ç±»å°±æœ‰ä¸€ä¸ªç§æœ‰å˜é‡ï¼Œæ‹¦æˆªå™¨åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å­˜å‚¨çŠ¶æ€åˆ°è¯¥ç§æœ‰å˜é‡ã€‚è¿™é‡Œå¦‚æœæš‚æ—¶ä¸ç†è§£</strong>æ²¡å…³ç³»**ï¼Œåé¢åˆ†äº«æ¯ä¸ªæ’ä»¶çš„å®ç°æ—¶ï¼Œä¼šæœ‰å®é™…çš„ä¾‹å­ï¼Œæ›´æ˜“æ‡‚ã€‚</li><li>---------- æ„é€ æ–¹æ³• ----------</li><li>ç¬¬ 130 è‡³ 143 è¡Œ ï¼š<strong>éå†</strong> ConstructorInterceptPoint æ•°ç»„ï¼Œé€ä¸ªå¢å¼º ConstructorInterceptPoint å¯¹åº”çš„æ„é€ æ–¹æ³•ã€‚ä½¿ç”¨ ConstructorInter å¤„ç†æ‹¦æˆªé€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4.4.1 æ„é€ æ–¹æ³• Interã€</a> è¯¦ç»†è§£æã€‚</li><li>---------- å®ä¾‹æ–¹æ³• ----------</li><li>ç¬¬ 145 è‡³ 175 è¡Œ ï¼š<strong>éå†</strong> InstanceMethodsInterceptPoint æ•°ç»„ï¼Œé€ä¸ªå¢å¼º InstanceMethodsInterceptPoint å¯¹åº”çš„é™æ€æ–¹æ³•ã€‚<ul><li>ç¬¬ 151 è‡³ 154 è¡Œ ï¼šè·å¾—æ‹¦æˆªå™¨çš„<strong>ç±»å</strong>ã€‚æ‹¦æˆªå™¨çš„å®ä¾‹ï¼Œåœ¨ <strong>Inter ç±»</strong>é‡Œè·å–ã€‚</li><li>ç¬¬ 156 è‡³ 165 è¡Œ ï¼šå½“ <code>InstanceMethodsInterceptPoint#isOverrideArgs()</code> æ–¹æ³•è¿”å› <code>true</code> æ—¶ï¼Œä½¿ç”¨ InstMethodsInterWithOverrideArgs å¤„ç†æ‹¦æˆªé€»è¾‘ã€‚åœ¨ <a href="#">ã€Œ4.4.2 å®ä¾‹æ–¹æ³• Interã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 166 è‡³ 173 è¡Œ ï¼šå½“ <code>InstanceMethodsInterceptPoint#isOverrideArgs()</code> æ–¹æ³•è¿”å› <code>false</code> æ—¶ï¼Œä½¿ç”¨ InstMethodsInter å¤„ç†æ‹¦æˆªé€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4.4.2 å®ä¾‹æ–¹æ³• Interã€</a> è¯¦ç»†è§£æã€‚</li></ul></li></ul><h3>4.1.3 ClassStaticMethodsEnhancePluginDefine</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c7c800bba485dcb9d532d6cb5686df273ae53d6d/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassStaticMethodsEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassStaticMethodsEnhancePluginDefine</code></a> ï¼Œç±»<strong>å¢å¼ºé™æ€æ–¹æ³•</strong>çš„æ’ä»¶å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ï¼Œå’Œæœ¬æ–‡ <a href="#">ã€Œ4.1.2.1 å¢å¼ºé™æ€æ–¹æ³•ã€</a> å¯¹åº”ã€‚</p><p>å®ç° <code>#getConstructorsInterceptPoints()</code> / <code>#getInstanceMethodsInterceptPoints()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¿”å›ç©ºï¼Œè¡¨ç¤ºä¸å¢å¼ºæ„é€ æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ã€‚<strong>å³åªå¢å¼ºé™æ€æ–¹æ³•</strong>ã€‚</p><h3>4.1.4 ClassInstanceMethodsEnhancePluginDefine</h3><p><a href="https://github.com/YunaiV/skywalking/blob/c7c800bba485dcb9d532d6cb5686df273ae53d6d/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ClassInstanceMethodsEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.ClassInstanceMethodsEnhancePluginDefine</code></a> ï¼Œç±»<strong>å¢å¼ºæ„é€ æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•</strong>çš„æ’ä»¶å®šä¹‰<strong>æŠ½è±¡ç±»</strong>ï¼Œå’Œæœ¬æ–‡ <a href="#">ã€Œ4.1.2.2 å¢å¼ºæ„é€ æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ã€</a> å¯¹åº”ã€‚</p><p>å®ç° <code>#getStaticMethodsInterceptPoints()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¿”å›ç©ºï¼Œè¡¨ç¤ºä¸å¢å¼ºé™æ€æ–¹æ³•ã€‚<strong>å³åªå¢å¼ºæ„é€ æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•</strong>ã€‚</p><h2>4.2 InterceptPoint</h2><table><thead><tr><th>InterceptPoint</th><th>æ–¹æ³•ç±»å‹</th><th>æ–¹æ³•åŒ¹é…</th><th>æ‹¦æˆªå™¨</th><th><code>#isOverrideArgs()</code></th></tr></thead><tbody><tr><td>StaticMethodsInterceptPoint</td><td>é™æ€æ–¹æ³•</td><td><code>#getMethodsMatcher()</code></td><td><code>#getMethodsInterceptor()</code></td><td>æœ‰</td></tr><tr><td>ConstructorInterceptPoint</td><td>æ„é€ æ–¹æ³•</td><td><code>#getConstructorMatcher()</code></td><td><code>#getConstructorInterceptor()</code></td><td>æ— </td></tr><tr><td>InstanceMethodsInterceptPoint</td><td>å®ä¾‹æ–¹æ³•</td><td><code>#getMethodsMatcher()</code></td><td><code>#getMethodsInterceptor()</code></td><td>æœ‰</td></tr></tbody></table><p>XXXInterceptPoint <strong>æ¥å£</strong>ï¼Œå¯¹åº”ä¸€ä¸ª <code>net.bytebuddy.matcher.ElementMatcher</code>  å’Œä¸€ä¸ªæ‹¦æˆªå™¨ã€‚</p><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</p><h2>4.3 Interceptor</h2><p>åœ¨å¼€å§‹åˆ†äº« <strong>Inter</strong> ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Interceptor ç›¸å…³æ¥å£ã€‚å¦‚ä¸‹å›¾æ‰€è§ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/10.png" alt=""></p><ul><li>InstanceConstructorInterceptor ï¼Œæ„é€ æ–¹æ³•æ‹¦æˆªå™¨<strong>æ¥å£</strong>ã€‚</li><li><em>AroundInterceptor</em><ul><li>StaticMethodsAroundInterceptor ï¼Œé™æ€æ–¹æ³•æ‹¦æˆªå™¨<strong>æ¥å£</strong>ã€‚</li><li>InstanceMethodsAroundInterceptor ï¼Œå®ä¾‹æ–¹æ³•æ‹¦æˆªå™¨<strong>æ¥å£</strong>ã€‚</li><li>æ¥å£æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢ Inter é€»è¾‘ä¹ŸåŸºæœ¬ä¸€è‡´ã€‚</li></ul></li></ul><p>åœ¨ <a href="#">ã€Œ4. 2 InterceptPointã€</a> é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ° <code>#getXXXInterceptor()</code> æ–¹æ³•è¿”å›çš„æ‹¦æˆªå™¨ç±»åï¼Œéœ€è¦é€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/loader/InterceptorInstanceLoader.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.loader.InterceptorInstanceLoader</code></a> åŠ è½½ä¸åˆ›å»ºæ‹¦æˆªå™¨å®ä¾‹ã€‚</p><h2>4.4 Inter</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ Inter çš„å®šä¹‰ ï¼š</p><blockquote><p>In this class, it provide a bridge between byte-buddy and sky-walking plugin.</p></blockquote><p>æ ¹æ®æ–¹æ³•ç±»å‹ï¼Œå°† Inter æ•´ç†å¦‚ä¸‹ ï¼š</p><table><thead><tr><th>æ–¹æ³•ç±»å‹</th><th></th><th></th></tr></thead><tbody><tr><td>æ„é€ æ–¹æ³•</td><td>ConstructorInter</td><td></td></tr><tr><td>å®ä¾‹æ–¹æ³•</td><td>InstMethodsInter</td><td>InstMethodsInterWithOverrideArgs</td></tr><tr><td>é™æ€æ–¹æ³•</td><td>StaticMethodsInter</td><td>StaticMethodsInterWithOverrideArgs</td></tr></tbody></table><h3>4.4.1 æ„é€ æ–¹æ³• Inter</h3><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ConstructorInter.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.ConstructorInter</code></a> ï¼Œæ„é€ æ–¹æ³• Inter ã€‚</p><p>ConstructorInter <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ConstructorInter.java#L52" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a>ï¼Œè°ƒç”¨ <code>InterceptorInstanceLoader#load(String, classLoader)</code> æ–¹æ³•ï¼ŒåŠ è½½æ„é€ æ–¹æ³•æ‹¦æˆªå™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/ConstructorInter.java#L68" rel="external nofollow noopener noreferrer" target="_blank"><code>#intercept(Object)</code></a> æ–¹æ³•ï¼Œ<strong>åœ¨æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæˆåè¿›è¡Œæ‹¦æˆª</strong>ï¼Œè°ƒç”¨ <code>InstanceConstructorInterceptor#onConstruct(...)</code> æ–¹æ³•ã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ²¡æœ‰ ConstructorInterWithOverrideArgs</strong>ï¼Ÿ<code>InstanceConstructorInterceptor#onConstruct(...)</code> æ–¹æ³•ï¼Œæ˜¯<strong>åœ¨æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæˆåè¿›è¡Œè°ƒç”¨æ‹¦æˆª</strong>ï¼ŒOverrideArgs ç”¨äºåœ¨è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œ<strong>æ”¹å˜ä¼ å…¥æ–¹æ³•çš„å‚æ•°</strong>ã€‚æ‰€ä»¥ï¼Œåœ¨æ­¤å¤„æš‚æ—¶æ²¡è¿™å—éœ€è¦ï¼Œå› è€Œæ²¡æœ‰ ConstructorInterWithOverrideArgs ã€‚</p><h3>4.4.2 å®ä¾‹æ–¹æ³• Inter</h3><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/InstMethodsInter.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.InstMethodsInter</code></a> ï¼Œå®ä¾‹æ–¹æ³• Inter ã€‚</p><p>ConstructorInter <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/InstMethodsInter.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><strong>æ„é€ æ–¹æ³•</strong></a>ï¼Œè°ƒç”¨ <code>InterceptorInstanceLoader#load(String, classLoader)</code> æ–¹æ³•ï¼ŒåŠ è½½å®ä¾‹æ–¹æ³•æ‹¦æˆªå™¨ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/InstMethodsInter.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#intercept(...)</code></a> æ–¹æ³•ï¼Œ<strong>Before-After</strong> æ–¹å¼æ‹¦æˆªå®ä¾‹æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 79 è‡³ 86 è¡Œ ï¼šè°ƒç”¨ <code>InstanceMethodsAroundInterceptor#beforeMethod(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œåœ¨å®ä¾‹æ–¹æ³•ä¹‹å‰çš„é€»è¾‘ã€‚<ul><li><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/MethodInterceptResult.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.MethodInterceptResult</code></a> ï¼Œæ–¹æ³•æ‹¦æˆªå™¨æ‰§è¡Œç»“æœã€‚å½“è°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/MethodInterceptResult.java#L51" rel="external nofollow noopener noreferrer" target="_blank"><code>MethodInterceptResult#defineReturnValue(Object)</code></a> æ–¹æ³•ï¼Œè®¾ç½®æ‰§è¡Œç»“æœï¼Œå¹¶æ ‡è®°ä¸å†ç»§ç»­æ‰§è¡Œã€‚</li></ul></li><li>ç¬¬ 90 è‡³ 92 è¡Œ ï¼šå½“ MethodInterceptResult å·²ç»æœ‰æ‰§è¡Œç»“æœï¼Œ<strong>ä¸å†æ‰§è¡ŒåŸæœ‰æ–¹æ³•ï¼Œç›´æ¥è¿”å›ç»“æœ</strong>ã€‚</li><li>ç¬¬ 94 è‡³ 96 è¡Œ ï¼šè°ƒç”¨ <code>Callable#call()</code> æ–¹æ³•ï¼Œæ‰§è¡ŒåŸæœ‰å®ä¾‹æ–¹æ³•ã€‚</li><li>ç¬¬ 97 è‡³ 105 è¡Œ ï¼šè°ƒç”¨ <code>InstanceMethodsAroundInterceptor#handleMethodException(...)</code> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ã€‚</li><li>ç¬¬ 107 è‡³ 113 è¡Œ ï¼šè°ƒç”¨ <code>InstanceMethodsAroundInterceptor#afterMethod(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œåç½®é€»è¾‘ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/InstMethodsInterWithOverrideArgs.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.InstMethodsInterWithOverrideArgs</code></a> ï¼Œ<strong>è¦†å†™å‚æ•°</strong>çš„å®ä¾‹æ–¹æ³• Inter ã€‚</p><p>ä¸å¤ªç†è§£<strong>è¦†å†™å‚æ•°</strong>ï¼Ÿæœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œ<code>InstanceMethodsAroundInterceptor#beforeMethod(...)</code> æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ–¹æ³•å‚æ•°ï¼Œå¹¶ä¸”å¸Œæœ›åŸæœ‰å®ä¾‹æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œ<strong>ä½¿ç”¨çš„æ˜¯ä¿®æ”¹äº†çš„æ–¹æ³•å‚æ•°</strong>ï¼Œæ­¤æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ InstMethodsInterWithOverrideArgs ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/InstMethodsInterWithOverrideArgs.java#L73" rel="external nofollow noopener noreferrer" target="_blank"><code>InstMethodsInterWithOverrideArgs#intercept(...)</code></a> æ–¹æ³•ï¼Œæ€»ä½“é€»è¾‘å’Œ InstMethodsInter æ˜¯ä¸€è‡´çš„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å·®å¼‚ç‚¹ ï¼š</p><ul><li>ç¬¬ 76 è¡Œ ï¼šæ–¹æ³•å‚æ•°ç±»å‹æ˜¯ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/OverrideCallable.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.OverrideCallable</code></a>ï¼Œå¹¶ä¸”å¸¦æœ‰ <a href="https://github.com/raphw/byte-buddy/blob/188366ace6e16ec167a00b144c9048d78495165f/byte-buddy-dep/src/main/java/net/bytebuddy/implementation/bind/annotation/Morph.java" rel="external nofollow noopener noreferrer" target="_blank"><code>net.bytebuddy.implementation.bind.annotation.@Morph</code></a> æ³¨è§£ã€‚</li><li>ç¬¬ 96 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/OverrideCallable.java#L37" rel="external nofollow noopener noreferrer" target="_blank"><code>OverrideCallable#call(args)</code></a> æ–¹æ³•ï¼Œä½¿ç”¨è¢«å‰ç½®æ–¹æ³•ä¿®æ”¹è¿‡çš„å‚æ•°ï¼Œæ‰§è¡ŒåŸæœ‰å®ä¾‹æ–¹æ³•ã€‚</li></ul><p>å…ˆæ¥ç…ç… <code>@Morph</code> æ³¨è§£çš„å®šä¹‰ ï¼š</p><blockquote><p>This annotation instructs Byte Buddy to inject a proxy class that calls a method's super method with explicit arguments.</p><p>For this, the {@link Morph.Binder} needs to be installed for an interface type that takes an argument of the array type {@link java.lang.Object} and returns a non-array type of {@link java.lang.Object}.</p><p>This is an alternative to using the {@link net.bytebuddy.implementation.bind.annotation.SuperCall} or {@link net.bytebuddy.implementation.bind.annotation.DefaultCall} annotations which call a super method using the same arguments as the intercepted method was invoked with.</p></blockquote><p>ç®€å•çš„æ¥è¯´ ï¼š</p><ul><li><p><code>@Morph</code> æ³¨è§£ï¼Œæ³¨å…¥ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œè°ƒç”¨è¢«ä»£ç†çš„æ–¹æ³•ã€‚ä¾‹å¦‚åœ¨ InstMethodsInterWithOverrideArgs é‡Œï¼Œè°ƒç”¨ <code>OverrideCallable#call(args)</code> æ–¹æ³•ï¼Œä¼šè°ƒç”¨åŸæœ‰å®ä¾‹æ–¹æ³•ã€‚</p></li><li><p>éœ€è¦ä½¿ç”¨ <code>Morph.Binder</code> è®¾ç½®ä¸€ä¸ªæ¥å£ï¼Œå¹¶ä¸”è¯¥æ¥å£çš„æ–¹æ³•å®šä¹‰ä¸º <code>Object methodName(Object[])</code> ã€‚åœ¨ InstMethodsInterWithOverrideArgs ä½¿ç”¨çš„æ˜¯  <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/OverrideCallable.java#L29" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.OverrideCallable</code></a> æ¥å£ã€‚å¦å¤–ï¼Œè°ƒç”¨ <code>Morph.Binder#install(Class&lt;?&gt;)</code> æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ClassEnhancePluginDefine.java </span></div><div class="line"><span class="comment">// `#enhanceInstance(...)` æ–¹æ³•</span></div><div class="line">newClassBuilder =</div><div class="line">    newClassBuilder.method(not(isStatic()).and(instanceMethodsInterceptPoint.getMethodsMatcher())) <span class="comment">// åŒ¹é…</span></div><div class="line">        .intercept( <span class="comment">// æ‹¦æˆª</span></div><div class="line">            MethodDelegation.withDefaultConfiguration()</div><div class="line">                .withBinders(</div><div class="line">                    Morph.Binder.install(OverrideCallable.class) <span class="comment">// è¦†å†™å‚æ•°</span></div><div class="line">                )</div><div class="line">                .to(<span class="keyword">new</span> InstMethodsInterWithOverrideArgs(interceptor, classLoader))</div><div class="line">        );</div></pre></td></tr></table></figure></p></li></ul><h3>4.4.3 é™æ€æ–¹æ³• Inter</h3><p><a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/StaticMethodsInter.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.StaticMethodsInter</code></a> å’Œ <a href="https://github.com/YunaiV/skywalking/blob/ea8b4e879092b39070215b1a2d194e6df12f0ef8/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/interceptor/enhance/StaticMethodsInterWithOverrideArgs.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.interceptor.enhance.StaticMethodsInterWithOverrideArgs</code></a> å’Œ<strong>å®ä¾‹æ–¹æ³• Inter</strong>åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±æ‹ä¸€æ‹ï¼Œç¬”è€…å°±ä¸çæ¯”æ¯”äº†ã€‚</p><h2>4.5 å°ç»“</h2><p>æ€»çš„æ¥è¯´ï¼Œæ¶‰åŠåˆ°çš„ç»„ä»¶ï¼Œå¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/11.png" alt=""></p><p>èƒ–å‹å†æ¢³ç†æ¢³ç†ã€‚</p><h1>666. å½©è›‹</h1><p>å†™å®Œï¼Œè›®å—¨çš®ğŸ˜œã€‚</p><p>è¿‘æœŸæœ€è®¤çœŸçš„ä¸€ç¯‡æ–‡ç« ï¼Œæ²¡æœ‰ä¹‹ä¸€ï¼Œæ»¡è¶³ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_10/12.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/agent-plugin-system/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyWalking
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” Agent åˆå§‹åŒ–</title>
    <link href="http://www.iocoder.cn/SkyWalking/agent-init/"/>
    <id>http://www.iocoder.cn/SkyWalking/agent-init/</id>
    <published>2020-07-04T16:00:00.000Z</published>
    <updated>2017-12-13T18:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/agent-init/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">2. SkyWalkingAgent</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">3. SnifferConfigInitializer</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">3.1 Config</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">3.2 RemoteDownstreamConfig</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">4. Plugin</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">4.1 PluginBootstrap</a></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">4.2 PluginFinder</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">5. ServiceManager</a><ul><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">5.1 BootService</a></li></ul></li><li><a href="http://www.iocoder.cn/SkyWalking/agent-init/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>SkyWalking Agent å¯åŠ¨åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>ã€‚</p><p>SkyWalking Agent åŸºäº <strong>JavaAgent</strong> æœºåˆ¶ï¼Œå®ç°åº”ç”¨<strong>é€æ˜</strong>æ¥å…¥ SkyWalking ã€‚å…³äº JavaAgent æœºåˆ¶ï¼Œç¬”è€…æ¨èå¦‚ä¸‹ä¸¤ç¯‡æ–‡ç«  ï¼š</p><ul><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠInstrumentation æ–°åŠŸèƒ½ã€‹</a></li><li><a href="http://www.infoq.com/cn/articles/javaagent-illustrated" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJVMæºç åˆ†æä¹‹javaagentåŸç†å®Œå…¨è§£è¯»ã€‹</a></li></ul><blockquote><p>å‹æƒ…æç¤º ï¼šå»ºè®®è‡ªå·±æ‰‹æ’¸ä¸€ä¸ªç®€å•çš„ JavaAgent ï¼Œæ›´å®¹æ˜“ç†è§£ SkyWalking Agent ã€‚</p><p>ç¬”è€…ç»ƒæ‰‹çš„ JavaAgent é¡¹ç›®åœ°å€ ï¼šhttps://github.com/YunaiV/learning/tree/master/javaagent01</p></blockquote><h1>2. SkyWalkingAgent</h1><p><code>org.skywalking.apm.agent.SkyWalkingAgent</code> ï¼Œåœ¨ <code>apm-sniffer/apm-agent</code> Maven æ¨¡å—é¡¹ç›®é‡Œï¼ŒSkyWalking Agent <strong>å¯åŠ¨å…¥å£</strong>ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯å¯åŠ¨å…¥å£å‘¢ï¼Ÿåœ¨ <code>apm-sniffer/apm-agent</code> çš„ <a href="https://github.com/OpenSkywalking/skywalking/blob/23133f7d97d17b471f69e7214a01885ebcd2e882/apm-sniffer/apm-agent/pom.xml#L53" rel="external nofollow noopener noreferrer" target="_blank"><code>pom.xml</code></a> æ–‡ä»¶çš„ã€ç¬¬ 73 è¡Œã€‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° SkyWalkingAgent è¢«é…ç½®æˆ JavaAgent çš„ <strong>PremainClass</strong> ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/c51dbc997348111674dbeedb71d22b0414936cdb/apm-sniffer/apm-agent/src/main/java/org/skywalking/apm/agent/SkyWalkingAgent.java#L54" rel="external nofollow noopener noreferrer" target="_blank"><code>#premain(...)</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 58 è¡Œ ï¼šè°ƒç”¨ <code>SnifferConfigInitializer#initialize()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Agent é…ç½®ã€‚</li><li>ç¬¬ 61 è¡Œ ï¼šè°ƒç”¨ <code>PluginBootstrap#loadPlugins()</code> æ–¹æ³•ï¼ŒåŠ è½½ Agent æ’ä»¶ä»¬ã€‚è€Œåï¼Œåˆ›å»º PluginFinder ã€‚</li><li>ç¬¬ 64 è¡Œ ï¼šè°ƒç”¨ <code>ServiceManager#boot()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Agent æœåŠ¡ç®¡ç†ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ï¼ŒAgent æœåŠ¡ä»¬ä¼šè¢«åˆå§‹åŒ–ã€‚</li><li>ç¬¬ 79 è‡³ 133 è¡Œ ï¼šåŸºäº <a href="https://github.com/raphw/byte-buddy" rel="external nofollow noopener noreferrer" target="_blank">byte-buddy</a> ï¼Œåˆå§‹åŒ– Instrumentation çš„ <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/ClassFileTransformer.html" rel="external nofollow noopener noreferrer" target="_blank"><code>java.lang.instrument.ClassFileTransformer</code></a> ã€‚</li></ul><h1>3. SnifferConfigInitializer</h1><p><code>org.skywalking.apm.agent.core.conf.SnifferConfigInitializer</code> ï¼ŒAgent é…ç½®åˆå§‹åŒ–å™¨ã€‚</p><p>åœ¨çœ‹å…·ä½“ä»£ç å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ <code>org.skywalking.apm.agent.core.conf</code> åŒ…çš„å¤§ä½“ç»“æ„ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/02.png" alt=""></p><p>é…ç½®ç±»æœ‰ Config å’Œ RemoteDownstreamConfig ä¸¤ç§ã€‚ä»å‘½åä¸Šå¯ä»¥çœ‹å‡º ï¼š</p><ul><li>Config ä¸º Agent <strong>æœ¬åœ°</strong>é…ç½®ç±»ï¼Œä½¿ç”¨ SnifferConfigInitializer è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>RemoteDownstreamConfig ä¸º Agent <strong>è¿œç¨‹</strong>é…ç½®ç±»ï¼Œä» <a href="https://github.com/OpenSkywalking/skywalking/wiki/3.2.3-%E9%83%A8%E7%BD%B2Collector" rel="external nofollow noopener noreferrer" target="_blank">Collector Server</a> è¯»å–ã€‚</li></ul><hr><p><a href="https://github.com/YunaiV/skywalking/blob/cea46a7e93437bbb16db2bfe0fae5c6fcf733fc2/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/conf/SnifferConfigInitializer.java#L56" rel="external nofollow noopener noreferrer" target="_blank"><code>#initialize()</code></a> æ–¹æ³•ï¼Œåˆå§‹åŒ– Agent æœ¬åœ°é…ç½®ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 59 è‡³ 67 è¡Œ ï¼šä»é…ç½®æ–‡ä»¶( <code>agent.config</code> ) åŠ è½½é…ç½®ã€‚é…ç½®æ–‡ä»¶æ‰€åœ¨<strong>å›ºå®š</strong>è·¯å¾„ä¸º <code>${AGENT_PACKAGE_PATH}/config/agent.config</code> ï¼Œå…¶ä¸­ <code>${AGENT_PACKAGE_PATH}</code> é€šè¿‡ <a href="https://github.com/YunaiV/skywalking/blob/c51dbc997348111674dbeedb71d22b0414936cdb/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/AgentPackagePath.java#L31" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.boot.AgentPackagePath</code></a> åˆå§‹åŒ–ã€‚Agent æ•´ç†ç›®å½•å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/01.png" alt=""></li><li>ç¬¬ 70 è‡³ 74 è¡Œ ï¼šä»ç¯å¢ƒå˜é‡<strong>è¦†ç›–</strong>é…ç½®ã€‚ç¯å¢ƒå˜é‡ <strong>Key</strong> éœ€ä»¥ <code>&quot;skywalking.&quot;</code> å¼€å¤´ã€‚ä¾‹å¦‚ï¼Œ<code>Config.Agent.APPLICATION_CODE</code> åœ¨ <code>agent.config</code> ä¸º <code>agent.application_code</code> ï¼Œç¯å¢ƒå˜é‡ä¸º <code>skywalking.agent.application_code</code> ã€‚å¦å¤–ï¼Œç¯å¢ƒå˜é‡åŒ…æ‹¬ JVM è¿›ç¨‹çš„å’Œç³»ç»Ÿçš„ã€‚</li><li>ç¬¬ 77 è‡³ 82 è¡Œ ï¼šæ ¡éªŒé…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½ã€‚</li></ul><h2>3.1 Config</h2><p><code>org.skywalking.apm.agent.core.conf.Config</code> ï¼ŒAgent æœ¬åœ°é…ç½®ç±»ã€‚</p><p>æ‰“å¼€ <a href="https://github.com/YunaiV/skywalking/blob/cea46a7e93437bbb16db2bfe0fae5c6fcf733fc2/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/conf/Config.java#L32" rel="external nofollow noopener noreferrer" target="_blank">Config</a> ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ‹†åˆ†äº† Agent / Collector / Jvm / Buffer / Dictionary / Logging / Plugin ä¸ƒä¸ªå°ç±»ã€‚å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/03.png" alt=""></p><p>æœ¬æ–‡æš‚ä¸å¯¹é…ç½®é¡¹è¯¦ç»†è§£æï¼Œèƒ–å‹å¯ä»¥çœ‹ä¸‹æ¯ä¸ªå±æ€§çš„è‹±æ–‡æ³¨é‡Šã€‚</p><h2>3.2 RemoteDownstreamConfig</h2><p><code>org.skywalking.apm.agent.core.conf.RemoteDownstreamConfig</code> ï¼ŒAgent è¿œç¨‹é…ç½®ç±»ã€‚</p><p>æ‰“å¼€ <a href="https://github.com/YunaiV/skywalking/blob/cea46a7e93437bbb16db2bfe0fae5c6fcf733fc2/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/conf/RemoteDownstreamConfig.java" rel="external nofollow noopener noreferrer" target="_blank">RemoteDownstreamConfig</a> ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ‹†åˆ†äº† Agent / Collector ä¸¤å°ç±»ã€‚å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/04.png" alt=""></p><p>æœ¬æ–‡æš‚ä¸å¯¹é…ç½®é¡¹è¯¦ç»†è§£æï¼Œèƒ–å‹å¯ä»¥çœ‹ä¸‹æ¯ä¸ªå±æ€§çš„è‹±æ–‡æ³¨é‡Šã€‚</p><h1>4. Plugin</h1><p>SkyWalking Agent æä¾›äº†å¤šç§æ’ä»¶ï¼Œå®ç°ä¸åŒæ¡†æ¶çš„<strong>é€æ˜</strong>æ¥å…¥ SkyWalking ã€‚åœ¨ <a href="https://github.com/OpenSkywalking/skywalking/wiki/3.2.3-supported-list" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” supported listã€‹</a> é‡Œï¼Œæœ‰ç›®å‰çš„æ’ä»¶åˆ—è¡¨ã€‚</p><p>å¦å¤–ï¼Œåœ¨ <code>apm-sniffer/apm-sdk-plugin</code> ç›®å½•ä¸‹ï¼Œæœ‰æ’ä»¶çš„å®ç°ä»£ç  ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/05.png" alt=""></p><p>æœ¬å°èŠ‚ä¼šåˆ†äº«çš„è¾ƒä¸ºç®€å•ï¼Œåœ¨ <a href="http://www.iocoder.cn/SkyWalking/agent-plugin-system/?self">ã€ŠSkyWalking æºç åˆ†æ â€”â€” Agent æ’ä»¶ä½“ç³»ã€‹</a> è¯¦ç»†è§£æã€‚</p><h2>4.1 PluginBootstrap</h2><p><code>org.skywalking.apm.agent.core.plugin.PluginBootstrap</code> ï¼Œæ’ä»¶å¼•å¯¼ç¨‹åºç±»ï¼Œåˆ›å»ºéœ€è¦åŠ è½½çš„æ’ä»¶å¯¹è±¡æ•°ç»„ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/130f0a5a3438663b393e53ba2cca02a8d13c258a/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginBootstrap.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>#loadPlugins()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 47 è¡Œ ï¼šåˆå§‹åŒ– AgentClassLoader ã€‚</li><li>ç¬¬ 50 è‡³ 56 è¡Œ ï¼šè·å¾—æ’ä»¶<strong>å®šä¹‰è·¯å¾„</strong>æ•°ç»„ã€‚</li><li>ç¬¬ 59 è‡³ 66 è¡Œ ï¼šè·å¾—æ’ä»¶<strong>å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.PluginDefine</code></a> )æ•°ç»„ã€‚</li><li>ç¬¬ 69 è‡³ 82 è¡Œ ï¼šåˆ›å»º<strong>ç±»å¢å¼ºæ’ä»¶å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code></a> )å¯¹è±¡æ•°ç»„ã€‚ä¸åŒæ’ä»¶é€šè¿‡å®ç° AbstractClassEnhancePluginDefine <strong>æŠ½è±¡ç±»</strong>ï¼Œå®šä¹‰ä¸åŒæ¡†æ¶çš„<strong>åˆ‡é¢</strong>ï¼Œ<strong>è®°å½•è°ƒç”¨é“¾è·¯</strong>ã€‚ä»¥ Spring æ’ä»¶ä¸ºä¾‹å­ï¼Œå¦‚ä¸‹æ˜¯ç›¸å…³ç±»å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/06.png" alt=""></li></ul><h2>4.2 PluginFinder</h2><p><code>org.skywalking.apm.agent.core.plugin.PluginFinder</code> ï¼Œæ’ä»¶å‘ç°è€…ã€‚å…¶æä¾› <a href="https://github.com/YunaiV/skywalking/blob/09c654af33081e56547cb8b3b9e0c8525ddce32f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginFinder.java#L80" rel="external nofollow noopener noreferrer" target="_blank"><code>#find(...)</code></a> æ–¹æ³•ï¼Œè·å¾—<strong>ç±»å¢å¼ºæ’ä»¶å®šä¹‰</strong>( <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/AbstractClassEnhancePluginDefine.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine</code></a> )å¯¹è±¡ã€‚</p><p>PluginFinder <strong><a href="https://github.com/YunaiV/skywalking/blob/09c654af33081e56547cb8b3b9e0c8525ddce32f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/plugin/PluginFinder.java#L56" rel="external nofollow noopener noreferrer" target="_blank">æ„é€ æ–¹æ³•</a></strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li>ç¬¬ 57 è‡³ 77 è¡Œ ï¼šå¾ªç¯ AbstractClassEnhancePluginDefine å¯¹è±¡æ•°ç»„ï¼Œæ·»åŠ åˆ° <code>nameMatchDefine</code> / <code>signatureMatchDefine</code> å±æ€§ï¼Œæ–¹ä¾¿ <code>#find(...)</code> æ–¹æ³•æŸ¥æ‰¾ AbstractClassEnhancePluginDefine å¯¹è±¡ã€‚<ul><li>ç¬¬ 65 è‡³ 72 è¡Œ ï¼šå¤„ç† NameMatch ä¸ºåŒ¹é…çš„ AbstractClassEnhancePluginDefine å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>nameMatchDefine</code>  å±æ€§ã€‚</li><li>ç¬¬ 74 è‡³ 76 è¡Œ ï¼šå¤„ç†<strong>é</strong> NameMatch ä¸ºåŒ¹é…çš„ AbstractClassEnhancePluginDefine å¯¹è±¡ï¼Œæ·»åŠ åˆ° <code>signatureMatchDefine</code> å±æ€§ã€‚</li></ul></li></ul><h1>5. ServiceManager</h1><p><code>org.skywalking.apm.agent.core.boot.ServiceManager</code> ï¼Œ<a href="https://github.com/YunaiV/skywalking/blob/09c654af33081e56547cb8b3b9e0c8525ddce32f/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/BootService.java" rel="external nofollow noopener noreferrer" target="_blank">BootService</a> ç®¡ç†å™¨ã€‚è´Ÿè´£ç®¡ç†ã€åˆå§‹åŒ– BootService å®ä¾‹ä»¬ã€‚</p><p><a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/ServiceManager.java#L45" rel="external nofollow noopener noreferrer" target="_blank"><code>#boot()</code></a> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><ul><li><p>ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/ServiceManager.java#L72" rel="external nofollow noopener noreferrer" target="_blank"><code>#loadAllServices()</code></a> æ–¹æ³•ï¼ŒåŠ è½½æ‰€æœ‰ BootService å®ç°ç±»çš„å®ä¾‹æ•°ç»„ã€‚ServiceManager åŸºäº SPI (Service Provider Interface) æœºåˆ¶ï¼Œåœ¨ <a href="https://github.com/OpenSkywalking/skywalking/blob/b16d23c1484bec941367d6b36fa932b8ace40971/apm-sniffer/apm-agent-core/src/main/resources/META-INF/services/org.skywalking.apm.agent.core.boot.BootService" rel="external nofollow noopener noreferrer" target="_blank">/resources/META-INF.services/org.skywalking.apm.agent.core.boot.BootService</a> æ–‡ä»¶é‡Œï¼Œå®šä¹‰äº†æ‰€æœ‰ BootService çš„å®ç°ç±»ã€‚å¦‚æœèƒ–å‹å¯¹ SPI æœºåˆ¶ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥çœ‹ä¸‹å¦‚ä¸‹æ–‡ç«  ï¼š</p><ul><li><a href="http://www.jianshu.com/p/32d3e108f30a" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSPI å’Œ ServiceLoaderã€‹</a></li><li><a href="http://www.jianshu.com/p/46aa69643c97" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè·Ÿæˆ‘å­¦Dubboç³»åˆ—ä¹‹Java SPIæœºåˆ¶ç®€ä»‹ã€‹</a></li></ul></li><li><p>ç¬¬ 50 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/ServiceManager.java#L82" rel="external nofollow noopener noreferrer" target="_blank"><code>#beforeBoot()</code></a> æ–¹æ³•ï¼Œè°ƒç”¨æ¯ä¸ª <code>BootService#beforeBoot()</code> æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 52 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/ServiceManager.java#L92" rel="external nofollow noopener noreferrer" target="_blank"><code>#startup()</code></a> æ–¹æ³•ï¼Œè°ƒç”¨æ¯ä¸ª <code>BootService#boot()</code> æ–¹æ³•ã€‚</p></li><li><p>ç¬¬ 54 è¡Œ ï¼šè°ƒç”¨ <a href="https://github.com/YunaiV/skywalking/blob/3de8a6c15d07aa3b2c3b4e732e6654fc87c4e70e/apm-sniffer/apm-agent-core/src/main/java/org/skywalking/apm/agent/core/boot/ServiceManager.java#L102" rel="external nofollow noopener noreferrer" target="_blank"><code>#afterBoot()</code></a> æ–¹æ³•ï¼Œè°ƒç”¨æ¯ä¸ª <code>BootService#afterBoot()</code> æ–¹æ³•ã€‚</p></li></ul><h2>5.1 BootService</h2><p><code>org.skywalking.apm.agent.core.boot.BootService</code> ï¼ŒAgent å¯åŠ¨æœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº† <code>#beforeBoot()</code> / <code>#boot()</code> / <code>#afterBoot()</code> / <code>#shutdown()</code> æ¥å£æ–¹æ³•ã€‚</p><p>BootService ç›®å‰æœ‰<strong>ä¸ƒä¸ª</strong>å®ç°ç±»ï¼Œåœ¨åç»­çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šè§£æç›¸å…³å®ç°ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/07.png" alt=""></p><h1>666. å½©è›‹</h1><p>æ¯æ¬¡å†™åˆå§‹åŒ–ç›¸å…³çš„æ–‡ç« ï¼Œå†™å°‘äº†ï¼Œæ€•å¤ªæ°´ï¼›å†™å¤šäº†ï¼Œåˆæ€•å¤ªå¤æ‚ã€‚</p><p>å—¯ï¼Œé€ä¸€å‘å¦¹å­ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_05/08.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/agent-init/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/SkyWalking/agent-in
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>SkyWalking æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/SkyWalking/build-debugging-environment/</id>
    <published>2020-06-30T16:00:00.000Z</published>
    <updated>2017-12-10T02:02:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><ul><li><a href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/">1. ä¾èµ–å·¥å…·</a></li><li><a href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/">2. æºç æ‹‰å–</a></li><li><a href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/">3. å¯åŠ¨ SkyWalking Collector</a></li><li><a href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/">4. å¯åŠ¨ SkyWalking Agent</a></li><li><a href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/">5. å¯åŠ¨ SkyWalking Web UI</a></li><li><a href="http://www.iocoder.cn/SkyWalking/build-debugging-environment/">6. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. ä¾èµ–å·¥å…·</h1><ul><li>Maven</li><li>Git</li><li>JDK</li><li>IntelliJ IDEA</li></ul><h1>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/OpenSkywalking/skywalking" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/OpenSkywalking/skywalking</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Maven</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p><p>æœ¬æ–‡åŸºäº <code>master</code> åˆ†æ”¯ã€‚</p><h1>3. å¯åŠ¨ SkyWalking Collector</h1><p>å‚è€ƒ <a href="https://github.com/OpenSkywalking/skywalking/wiki/How-to-build" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” How to buildã€‹</a></p><ol><li><p>åœ¨ IntelliJ IDEA Terminal ä¸­ï¼Œæ‰§è¡Œ <code>mvn compile -Dmaven.test.skip=true</code> è¿›è¡Œç¼–è¯‘ã€‚</p></li><li><p>è®¾ç½® gRPC çš„<strong>è‡ªåŠ¨ç”Ÿæˆ</strong>çš„ä»£ç ç›®å½•ï¼Œä¸º<strong>æºç </strong>ç›®å½• ï¼š</p><ul><li>/apm-network/target/generated-sources/protobuf/ ä¸‹çš„ <code>grpc-java</code> å’Œ <code>java</code> ç›®å½•</li><li>/apm-collector-remote/collector-remote-grpc-provider/target/generated-sources/protobuf/ ä¸‹çš„ <code>grpc-java</code> å’Œ <code>java</code> ç›®å½•</li><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/01.png" alt=""></li></ul><blockquote><p>ä» 3.2 å¼€å§‹ï¼Œç½‘ç»œé€šè®¯åè®®å¼•å…¥ GRPC ï¼Œæ‰€ä»¥å¢åŠ ä¸Šè¿°çš„æ­¥éª¤</p></blockquote></li><li><p>è¿è¡Œ <code>org.skywalking.apm.collector.bootCollectorBootStartUp</code> çš„ <code>#main(args)</code> æ–¹æ³•ï¼Œå¯åŠ¨ Collector ã€‚</p></li><li><p>è®¿é—® <code>http://127.0.0.1:10800/agent/jetty</code> åœ°å€ï¼Œè¿”å› <code>[&quot;localhost:12800/&quot;]</code> ï¼Œè¯´æ˜å¯åŠ¨<strong>æˆåŠŸ</strong>ã€‚</p></li></ol><h1>4. å¯åŠ¨ SkyWalking Agent</h1><p>æ„Ÿè°¢ <a href="https://github.com/wu-sheng" rel="external nofollow noopener noreferrer" target="_blank">å´æ™Ÿ</a> æŒ‡å¯¼å¦‚ä½•æ­å»º Agent è°ƒè¯•ç¯å¢ƒã€‚</p><ol><li><p>åœ¨ IntelliJ IDEA Terminal ä¸­ï¼Œæ‰§è¡Œ <code>mvn compile -Dmaven.test.skip=true</code> è¿›è¡Œç¼–è¯‘ã€‚åœ¨ /packages/skywalking-agent ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¼–è¯‘å‡ºæ¥çš„ Agent ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/02.png" alt=""></p></li><li><p>ä½¿ç”¨ Spring Boot åˆ›å»ºä¸€ä¸ªç®€å•çš„ Web é¡¹ç›®ã€‚ç±»ä¼¼å¦‚ä¸‹ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/03.png" alt=""></p><blockquote><p>å‹æƒ…æç¤º ï¼š<strong>è¿™é‡Œä¸€å®šè¦æ³¨æ„ä¸‹</strong>ã€‚åˆ›å»ºçš„ Web é¡¹ç›®ï¼Œä½¿ç”¨  IntelliJ IDEA çš„<strong>èœå•</strong> File / New / Module æˆ– File / New / Module from Existing Sources ï¼Œ<strong>ä¿è¯ Web é¡¹ç›®å’Œ skywalking é¡¹ç›®å¹³çº§</strong>ã€‚è¿™æ ·ï¼Œæ‰å¯ä»¥ä½¿ç”¨ IntelliJ IDEA è°ƒè¯•  Agent ã€‚</p></blockquote><ul><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/04.png" alt=""></li><li><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/05.png" alt=""></li></ul></li><li><p>åœ¨ <code>org.skywalking.apm.agent.SkyWalkingAgent</code> çš„ <code>#premain(...)</code> æ–¹æ³•ï¼Œæ‰“ä¸Šè°ƒè¯•æ–­ç‚¹ã€‚</p></li><li><p>è¿è¡Œ Web é¡¹ç›®çš„ Application çš„ <code>#main(args)</code> æ–¹æ³•ï¼Œå¹¶å¢åŠ  JVM å¯åŠ¨å‚æ•°ï¼Œ<code>-javaagent:/path/to/skywalking-agent/skywalking-agent.jar</code>ã€‚<code>/path/to</code> <strong>å‚æ•°å€¼</strong>ä¸ºä¸Šé¢æˆ‘ä»¬ç¼–è¯‘å‡ºæ¥çš„ /packages/skywalking-agent ç›®å½•çš„ç»å¯¹è·¯å¾„ã€‚å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/06.png" alt=""></p></li><li><p>å¦‚æœåœ¨ã€<strong>ç¬¬ä¸‰æ­¥</strong>ã€‘çš„è°ƒè¯•æ–­ç‚¹åœä½ï¼Œè¯´æ˜ Agent å¯åŠ¨<strong>æˆåŠŸ</strong>ã€‚</p></li></ol><hr><p>è€ƒè™‘åˆ°å¯èƒ½æˆ‘ä»¬ä¼šåœ¨ Agent ä¸Šå¢åŠ ä»£ç æ³¨é‡Šï¼Œè¿™æ ·æ¯æ¬¡ä¸å¾—ä¸é‡æ–°ç¼–è¯‘ Agent ã€‚å¯ä»¥é…ç½®å¦‚ä¸‹å›¾ï¼Œè‡ªåŠ¨ç¼–è¯‘ Agent ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/07.png" alt=""></p><ul><li><code>-T 1C clean package -Dmaven.test.skip=true -Dmaven.compile.fork=true</code> ã€‚</li></ul><hr><p>å¦å¤–ï¼Œä½¿ç”¨ IntelliJ IDEA Remote è¿œç¨‹è°ƒè¯•ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚å¦‚ä¸‹å›¾ ï¼š<img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/10.png" alt=""></p><h1>5. å¯åŠ¨ SkyWalking Web UI</h1><p>è€ƒè™‘åˆ°è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦çœ‹ä¸‹æ˜¯å¦æ”¶é›†åˆ°è¿½è¸ªæ—¥å¿—ï¼Œå¯ä»¥å®‰è£… SkyWalking Web UI è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>å‚è€ƒ <a href="https://github.com/OpenSkywalking/skywalking-ui#quickstart-zh" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” Sky Walking Web UIã€‹</a> å®‰è£…ã€‚</p><h1>6. å½©è›‹</h1><p>SkyWalking ç¯å¢ƒæ­å»ºå®Œæˆï¼Œèƒ–å‹ä»¬å¯ä»¥èµ·é£ï¼Œæºç è¯»èµ·æ¥ã€‚</p><p>è¿™ä¼šæ˜¯ä¸ªç³»åˆ—æ–‡ç« ï¼Œç¬”è€…ä¼šæ…¢æ…¢æ›´æ–°ã€‚</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/08.png" alt=""></p><p>å¦‚ä¸‹æ˜¯ç¬”è€…å¯¹ä»£ç é‡å’Œç”¨é€”çš„ç®€å•æ•´ç†ï¼Œå®Œå–„åº¦æ¯”è¾ƒä½ï¼Œå¯èƒ½æœ‰ä¸€ä¸¢ä¸¢çš„å¸®åŠ© ï¼š</p><p><img src="http://www.iocoder.cn/images/SkyWalking/2020_07_01/09.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SkyWalking/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.iocoder.cn/Sk
      
    
    </summary>
    
      <category term="SkyWalking" scheme="http://www.iocoder.cn/categories/SkyWalking/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³ç®¡ç† HTTP API</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/</id>
    <published>2020-04-14T16:00:00.000Z</published>
    <updated>2017-12-01T16:48:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">1. æ¦‚è¿°</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2. è¿‡æ»¤å™¨ HTTP API</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.1 å…¨å±€è¿‡æ»¤å™¨åˆ—è¡¨</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.2 è·¯ç”±è¿‡æ»¤å™¨å·¥å‚åˆ—è¡¨</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">3. è·¯ç”± HTTP API</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.1 è·¯ç”±åˆ—è¡¨</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.2 å•ä¸ªè·¯ç”±ä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.3 å•ä¸ªè·¯ç”±çš„è¿‡æ»¤å™¨</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.4 æ·»åŠ /ä¿®æ”¹å•ä¸ªè·¯ç”±</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.5 åˆ é™¤å•ä¸ªè·¯ç”±</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">2.6 åˆ·æ–°è·¯ç”±ç¼“å­˜</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº«<strong>ç½‘å…³ç®¡ç† HTTP API</strong>ã€‚</p><p><code>org.springframework.cloud.gateway.actuate.GatewayWebfluxEndpoint</code> ï¼Œæä¾›<strong>ç®¡ç†</strong>ç½‘å…³çš„ HTTP API ã€‚<strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;management.context-path:/application&#125;/gateway"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayWebfluxEndpoint</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(GatewayWebfluxEndpoint.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·¯ç”±å®šä¹‰å®šä½å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> RouteDefinitionLocator routeDefinitionLocator;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…¨å±€è¿‡æ»¤å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> List&lt;GlobalFilter&gt; globalFilters;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç½‘å…³è¿‡æ»¤å™¨å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> List&lt;GatewayFilterFactory&gt; gatewayFilters;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å­˜å‚¨å™¨ RouteDefinitionLocator å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·¯ç”±å®šä½å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> RouteLocator routeLocator;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨äº‹ä»¶å‘å¸ƒå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> ApplicationEventPublisher publisher;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">GatewayWebfluxEndpoint</span><span class="params">(RouteDefinitionLocator routeDefinitionLocator, List&lt;GlobalFilter&gt; globalFilters,</span></span></div><div class="line"><span class="function"><span class="params">  List&lt;GatewayFilterFactory&gt; GatewayFilters, RouteDefinitionWriter routeDefinitionWriter,</span></span></div><div class="line"><span class="function"><span class="params">  RouteLocator routeLocator)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.routeDefinitionLocator = routeDefinitionLocator;</div><div class="line"><span class="keyword">this</span>.globalFilters = globalFilters;</div><div class="line"><span class="keyword">this</span>.gatewayFilters = GatewayFilters;</div><div class="line"><span class="keyword">this</span>.routeDefinitionWriter = routeDefinitionWriter;</div><div class="line"><span class="keyword">this</span>.routeLocator = routeLocator;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>@RequestMapping</code> æ³¨è§£ï¼ŒHTTP  API ä»¥ <code>&quot;${management.context-path:/application}/gateway&quot;</code> ã€‚</li><li><code>routeDefinitionLocator</code> å±æ€§ï¼Œè·¯ç”±å®šä¹‰å®šä½å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-route-definition/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.2ï¼‰ä¹‹ RouteDefinitionRouteLocator è·¯ç”±é…ç½®ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>globalFilters</code> å±æ€§ï¼Œå…¨å±€è¿‡æ»¤å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>gatewayFilters</code> å±æ€§ï¼Œç½‘å…³è¿‡æ»¤å™¨å·¥å‚ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹</a></li><li><code>routeLocator</code> å±æ€§ï¼Œè·¯ç”±å®šä½å™¨ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.1ï¼‰ä¹‹ RouteLocator ä¸€è§ˆã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><code>publisher</code> å±æ€§ï¼Œåº”ç”¨äº‹ä»¶å‘å¸ƒå™¨ã€‚åœ¨ <a href="https://muyinchen.github.io/2017/09/27/Spring5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring5æºç è§£æ-Springæ¡†æ¶ä¸­çš„äº‹ä»¶å’Œç›‘å¬å™¨ã€‹</a> æœ‰ç›¸å…³è§£æã€‚</li></ul><hr><p>GatewayWebfluxEndpoint æä¾›ä¸¤ç±» HTTP API ï¼š</p><ul><li>è¿‡æ»¤å™¨ HTTP API</li><li>è·¯ç”± HTTP API</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h2>2. è¿‡æ»¤å™¨ HTTP API</h2><h2>2.1 å…¨å±€è¿‡æ»¤å™¨åˆ—è¡¨</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/globalfilters"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;HashMap&lt;String, Object&gt;&gt; globalfilters() &#123;</div><div class="line"><span class="keyword">return</span> getNamesToOrders(<span class="keyword">this</span>.globalFilters);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> &lt;T&gt; Mono&lt;HashMap&lt;String, Object&gt;&gt; getNamesToOrders(List&lt;T&gt; list) &#123;</div><div class="line"><span class="keyword">return</span> Flux.fromIterable(list).reduce(<span class="keyword">new</span> HashMap&lt;&gt;(), <span class="keyword">this</span>::putItem);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> HashMap&lt;String, Object&gt; <span class="title">putItem</span><span class="params">(HashMap&lt;String, Object&gt; map, Object o)</span> </span>&#123;</div><div class="line">Integer order = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> Ordered) &#123;</div><div class="line">order = ((Ordered)o).getOrder();</div><div class="line">&#125;</div><div class="line"><span class="comment">//filters.put(o.getClass().getName(), order);</span></div><div class="line">map.put(o.toString(), order);</div><div class="line"><span class="keyword">return</span> map;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>2.2 è·¯ç”±è¿‡æ»¤å™¨å·¥å‚åˆ—è¡¨</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/routefilters"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;HashMap&lt;String, Object&gt;&gt; routefilers() &#123;</div><div class="line"><span class="keyword">return</span> getNamesToOrders(<span class="keyword">this</span>.gatewayFilters);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>3. è·¯ç”± HTTP API</h2><h2>2.1 è·¯ç”±åˆ—è¡¨</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/routes"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;Map&lt;String, List&gt;&gt; routes() &#123;</div><div class="line">Mono&lt;List&lt;RouteDefinition&gt;&gt; routeDefs = <span class="keyword">this</span>.routeDefinitionLocator.getRouteDefinitions().collectList();</div><div class="line">Mono&lt;List&lt;Route&gt;&gt; routes = <span class="keyword">this</span>.routeLocator.getRoutes().collectList();</div><div class="line"><span class="keyword">return</span> Mono.zip(routeDefs, routes).map(tuple -&gt; &#123;</div><div class="line">Map&lt;String, List&gt; allRoutes = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">allRoutes.put(<span class="string">"routeDefinitions"</span>, tuple.getT1());</div><div class="line">allRoutes.put(<span class="string">"routes"</span>, tuple.getT2());</div><div class="line"><span class="keyword">return</span> allRoutes;</div><div class="line">&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>2.2 å•ä¸ªè·¯ç”±ä¿¡æ¯</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/routes/&#123;id&#125;"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;ResponseEntity&lt;RouteDefinition&gt;&gt; route(<span class="meta">@PathVariable</span> String id) &#123;</div><div class="line"><span class="comment">//<span class="doctag">TODO:</span> missing RouteLocator</span></div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionLocator.getRouteDefinitions()</div><div class="line">.filter(route -&gt; route.getId().equals(id))</div><div class="line">.singleOrEmpty()</div><div class="line">.map(route -&gt; ResponseEntity.ok(route))</div><div class="line">.switchIfEmpty(Mono.just(ResponseEntity.notFound().build()));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä» <code>TODO: missing RouteLocator</code> ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰ä¸æ”¯æŒä» RouteLocator è·å– Route ï¼Œåªè¿”å› RouteDefinition ã€‚ç­‰å¾…æœªæ¥çš„ç‰ˆæœ¬æ”¯æŒã€‚</li></ul><h2>2.3 å•ä¸ªè·¯ç”±çš„è¿‡æ»¤å™¨</h2><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/routes/&#123;id&#125;/combinedfilters"</span>)</div><div class="line"><span class="keyword">public</span> Mono&lt;HashMap&lt;String, Object&gt;&gt; combinedfilters(<span class="meta">@PathVariable</span> String id) &#123;</div><div class="line"><span class="comment">//<span class="doctag">TODO:</span> missing global filters</span></div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>.routeLocator.getRoutes()</div><div class="line">.filter(route -&gt; route.getId().equals(id))</div><div class="line">.reduce(<span class="keyword">new</span> HashMap&lt;&gt;(), <span class="keyword">this</span>::putItem);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä» <code>TODO: missing global filters</code> ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰è¿”å›çš„è¿‡æ»¤å™¨ä¸åŒ…æ‹¬ GlobalFilter ï¼Œå¯ä»¥è°ƒç”¨ <code>/globalfilters</code> æŸ¥çœ‹ã€‚ç­‰å¾…æœªæ¥çš„ç‰ˆæœ¬æ”¯æŒã€‚</li></ul><h2>2.4 æ·»åŠ /ä¿®æ”¹å•ä¸ªè·¯ç”±</h2><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.3ï¼‰ä¹‹ RouteDefinitionRepository å­˜å‚¨å™¨ã€‹ã€Œ5. GatewayWebfluxEndpointã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2>2.5 åˆ é™¤å•ä¸ªè·¯ç”±</h2><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-repository/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.3ï¼‰ä¹‹ RouteDefinitionRepository å­˜å‚¨å™¨ã€‹ã€Œ5. GatewayWebfluxEndpointã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2>2.6 åˆ·æ–°è·¯ç”±ç¼“å­˜</h2><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-locator-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ2.1ï¼‰ä¹‹ RouteLocator ä¸€è§ˆã€‹ã€Œ5. CachingRouteLocatorã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><h1>666. å½©è›‹</h1><p>æ°´æ›´ä¸€ç¯‡ï¼Œå“ˆå“ˆå“ˆã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_15/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/manager-http-api/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.10) ä¹‹ RequestRateLimiterGatewayFilterFactory è¯·æ±‚é™æµ</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/</id>
    <published>2020-04-09T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">3. RequestRateLimiterGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4. KeyResolver</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4.1 PrincipalNameKeyResolver</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4.2 è‡ªå®šä¹‰ KeyResolver</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5. RateLimiter</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5.1 GatewayRedisAutoConfiguration</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5.2 RedisRateLimiter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">5.3 Redis Lua è„šæœ¬</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>RequestRateLimiterGatewayFilterFactory çš„ä»£ç å®ç°</strong>ã€‚</p><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° Spring Cloud Gateway æä¾›äº†å¤šç§ GatewayFilterFactory çš„å®ç°ï¼Œè€Œ RequestRateLimiterGatewayFilterFactory ä¹Ÿæ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚</p><p>é€šè¿‡ RequestRateLimiterGatewayFilterFactory ï¼Œå¯ä»¥åˆ›å»º RequestRateLimiterGatewayFilter ( å®é™…æ˜¯å†…éƒ¨åŒ¿åç±»ï¼Œä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼Œä¸‹é¢ç»§ç»­è¿™ä¹ˆç§°å‘¼ ) ã€‚</p><p>RequestRateLimiterGatewayFilter ä½¿ç”¨ <strong>Redis + Lua</strong> å®ç°åˆ†å¸ƒå¼é™æµã€‚è€Œé™æµçš„ç²’åº¦ï¼Œä¾‹å¦‚ URL / ç”¨æˆ· / IP ç­‰ï¼Œé€šè¿‡ <code>org.springframework.cloud.gateway.filter.ratelimit.KeyResolver</code> <strong>å®ç°ç±»</strong>å†³å®šï¼Œåœ¨ <a href="#">ã€Œ4. KeyResolverã€</a> è¯¦ç»†è§£æã€‚</p><p>è¿™é‡Œï¼Œç¬”è€…ä¸€æœ¬æ­£ç»çš„æ¨èä¸‹è‡ªå·±åˆ†äº«çš„ <a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a> ï¼Œç®€ç›´ä¸šç•Œè‰¯å¿ƒã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ç¯å¢ƒæ­å»º</h1><p>ç¬¬ä¸€æ­¥ï¼Œä»¥ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ä¸ºåŸºç¡€ï¼Œåœ¨ <code>pom.xml</code> æ–‡ä»¶æ·»åŠ ä¾èµ–åº“ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ <code>application.yml</code> é…ç½®<strong>ä¸€ä¸ª</strong> RouteDefinition ã€‚</p><p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">default_path_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://127.0.0.1:8081</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RequestRateLimiter=10,</span> <span class="number">20</span><span class="string">,</span> <span class="comment">#&#123;@principalNameKeyResolver&#125;</span></div></pre></td></tr></table></figure></p><ul><li><code>- RequestRateLimiter=10, 20, #{@principalNameKeyResolver}</code> ï¼Œé…ç½® RequestRateLimiterGatewayFilterFactory ã€‚<ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŸºäº<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>å®ç°é™æµã€‚</li><li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>burstCapacity</code> ï¼Œä»¤ç‰Œæ¡¶ä¸Šé™ ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<code>replenishRate</code> ï¼Œä»¤ç‰Œæ¡¶å¡«å……å¹³å‡é€Ÿç‡ï¼Œå•ä½ï¼šç§’ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œ<code>keyResolver</code> ï¼Œé™æµ<strong>é”®</strong>è§£æå™¨ Bean å¯¹è±¡åå­—ï¼Œæ ¹æ® <code>#{@beanName}</code> ï¼Œä½¿ç”¨ SpEL è¡¨è¾¾å¼ï¼Œä» Spring å®¹å™¨ä¸­è·å– Bean å¯¹è±¡ï¼Œè¯¦ç»†å‚è§ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/83496b78944269050373bb92bb2181e1b7c070e8/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RouteDefinitionRouteLocator.java#L182" rel="external nofollow noopener noreferrer" target="_blank"><code>RouteDefinitionRouteLocator#getTuple(ArgumentHints, Map&lt;String, String&gt;, SpelExpressionParser, BeanFactory)</code></a> å¤„çš„ä»£ç ã€‚å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª BUG ï¼šåœ¨ YAML é‡Œï¼Œ<code>#</code> ä»£è¡¨æ³¨é‡Šï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ªå‚æ•°æ— æ³•æ­£ç¡®è¢«è¯»å–ï¼Œéœ€è¦ç­‰å¾…å®˜æ–¹ä¿®å¤ã€‚å¦‚æœæ¯”è¾ƒç€æ€¥ä½¿ç”¨ï¼Œå¯ä»¥è€ƒè™‘å°†æ­¤å¤„çš„ <code>#</code> ä¿®æ”¹æˆ <code>\#</code> ï¼Œå¹¶ä¿®æ”¹éƒ¨åˆ†ç›¸å…³ä»£ç ä»¥è§£å†³è¯¥ BUG ã€‚</li></ul></li></ul><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®Œæˆï¼Œå¯åŠ¨ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ã€‚</p><blockquote><p><strong>å‹æƒ…æç¤º</strong>ï¼ŒRequestRateLimiterGatewayFilter ä½¿ç”¨äº† RedisTemplate ï¼Œç”Ÿäº§ç¯å¢ƒè¯·é…ç½®ã€‚</p></blockquote><h1>3. RequestRateLimiterGatewayFilterFactory</h1><p><code>org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory</code> ï¼Œè¯·æ±‚é™æµç½‘å…³è¿‡æ»¤å™¨<strong>å·¥å‚</strong>ç±»ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestRateLimiterGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_RESOLVER_KEY = <span class="string">"keyResolver"</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter;</div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> KeyResolver defaultKeyResolver;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">RequestRateLimiterGatewayFilterFactory</span><span class="params">(RateLimiter rateLimiter,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">9</span>: KeyResolver defaultKeyResolver)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: <span class="keyword">this</span>.rateLimiter = rateLimiter;</div><div class="line"><span class="number">11</span>: <span class="keyword">this</span>.defaultKeyResolver = defaultKeyResolver;</div><div class="line"><span class="number">12</span>: &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> Arrays.asList(</div><div class="line"><span class="number">17</span>:                 RedisRateLimiter.REPLENISH_RATE_KEY,</div><div class="line"><span class="number">18</span>:                 RedisRateLimiter.BURST_CAPACITY_KEY,</div><div class="line"><span class="number">19</span>:                 KEY_RESOLVER_KEY</div><div class="line"><span class="number">20</span>:         );</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">24</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validateArgs</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">25</span>:  <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="number">29</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">30</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">31</span>:         validateMin(<span class="number">2</span>, args);</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:         <span class="comment">// è·å¾— KeyResolver</span></div><div class="line"><span class="number">34</span>: KeyResolver keyResolver;</div><div class="line"><span class="number">35</span>: <span class="keyword">if</span> (args.hasFieldName(KEY_RESOLVER_KEY)) &#123;</div><div class="line"><span class="number">36</span>: keyResolver = args.getValue(KEY_RESOLVER_KEY, KeyResolver.class);</div><div class="line"><span class="number">37</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">38</span>: keyResolver = defaultKeyResolver;</div><div class="line"><span class="number">39</span>: &#125;</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="keyword">return</span> (exchange, chain) -&gt; keyResolver.resolve(exchange).flatMap(key -&gt;</div><div class="line"><span class="number">42</span>:             <span class="comment">// <span class="doctag">TODO:</span> if key is empty?</span></div><div class="line"><span class="number">43</span>:             rateLimiter.isAllowed(key, args).flatMap(response -&gt; &#123;</div><div class="line"><span class="number">44</span>:                 <span class="comment">// <span class="doctag">TODO:</span> set some headers for rate, tokens left</span></div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:                 <span class="comment">// å…è®¸è®¿é—®</span></div><div class="line"><span class="number">47</span>:                 <span class="keyword">if</span> (response.isAllowed()) &#123;</div><div class="line"><span class="number">48</span>:                     <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">49</span>:                 &#125;</div><div class="line"><span class="number">50</span>: </div><div class="line"><span class="number">51</span>:                 <span class="comment">// è¢«é™æµï¼Œä¸å…è®¸è®¿é—®</span></div><div class="line"><span class="number">52</span>:                 exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</div><div class="line"><span class="number">53</span>:                 <span class="keyword">return</span> exchange.getResponse().setComplete();</div><div class="line"><span class="number">54</span>:             &#125;));</div><div class="line"><span class="number">55</span>: &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>rateLimiter</code> å±æ€§ï¼Œé™æµå™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ RedisRateLimiter ã€‚</li><li><code>defaultKeyResolver</code> å±æ€§ï¼Œé»˜è®¤é™æµ<strong>é”®</strong>è§£æå™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ PrincipalNameKeyResolver ã€‚</li><li><code>#argNames()</code> æ–¹æ³•ï¼Œå®šä¹‰äº† Tuple å‚æ•°çš„ Key ä¸º <code>replenishRate</code> / <code>burstCapacity</code> / <code>keyResolver</code> ã€‚</li><li><code>#validateArgs()</code> æ–¹æ³•ï¼Œå®šä¹‰åœ¨ <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/83496b78944269050373bb92bb2181e1b7c070e8/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RouteDefinitionRouteLocator.java#L182" rel="external nofollow noopener noreferrer" target="_blank"><code>RouteDefinitionRouteLocator#getTuple(ArgumentHints, Map&lt;String, String&gt;, SpelExpressionParser, BeanFactory)</code></a> æ— éœ€æ ¡éªŒ Tuple ç»“æœã€‚å› ä¸º <code>keyResolver</code> éå¿…å¡«é¡¹ï¼Œåœ¨ <code>#apply()</code> æ–¹æ³•ï¼Œåˆ›å»º RequestRateLimiterGatewayFilter æ—¶<strong>æ ¡éªŒ</strong>ã€‚</li><li><code>#apply()</code> æ–¹æ³•ï¼Œåˆ›å»º RequestRateLimiterGatewayFilter å¯¹è±¡ã€‚</li><li>ç¬¬ 31 è¡Œ ï¼šæ ¡éªŒ Tuple å‚æ•°è‡³å°‘æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œå³ <code>replenishRate</code> å’Œ <code>burstCapacity</code> ã€‚è€Œ <code>keyResolver</code> æ˜¯<strong>é€‰å¡«</strong>ï¼Œä¸ºç©ºæ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼ <code>defaultKeyResolver</code> ã€‚</li><li>ç¬¬ 34 è‡³ 39 è¡Œ ï¼šè·å¾— <code>keyResolver</code> ã€‚é€šè¿‡å®ƒï¼Œè·å¾—è¯·æ±‚çš„é™æµ<strong>é”®</strong>ï¼Œä¾‹å¦‚URL / ç”¨æˆ· / IP ç­‰ã€‚</li><li>--------- ç¬¬ 41 è‡³ 54 è¡Œ ï¼š<strong>åˆ›å»º RequestRateLimiterGatewayFilter å¯¹è±¡å¹¶è¿”å›</strong>ã€‚</li><li>ç¬¬ 41 è¡Œ ï¼šè°ƒç”¨ <code>KeyResolver#resolve(ServerWebExchange)</code> æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚çš„é™æµ<strong>é”®</strong>ã€‚<ul><li><strong>æ³¨æ„ä¸‹</strong>ï¼Œè¿™é‡Œæœªå¤„ç†é™æµ<strong>é”®</strong>ä¸ºç©ºçš„æƒ…å†µ( <code>TODO: if key is empty?</code> )ã€‚æ‰€ä»¥ï¼Œå½“é™æµ<strong>é”®</strong>ä¸ºç©ºæ—¶ï¼Œè¿‡æ»¤å™¨é“¾ä¸ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šè¯·æ±‚åç«¯ Http / Websocket æœåŠ¡ï¼Œå¹¶ä¸”æœ€ç»ˆè¿”å›å®¢æˆ·ç«¯ <strong>200</strong> çŠ¶æ€ç ï¼Œå†…å®¹ä¸º<strong>ç©º</strong>ã€‚</li></ul></li><li>ç¬¬ 43 è‡³ 54 è¡Œ ï¼šè°ƒç”¨ <code>RateLimiter#isAllowed(ServerWebExchange, Tuple)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¢«é™æµã€‚<ul><li>ç¬¬ 47 è‡³ 49 è¡Œ ï¼š<strong>æœª</strong>è¢«é™æµï¼Œå…è®¸è®¿é—®ï¼Œæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</li><li>ç¬¬ 52 è‡³ 53 è¡Œ ï¼šè¢«é™æµï¼Œ <strong>ä¸</strong>å…è®¸è®¿é—®ï¼Œè®¾ç½®å“åº” 429 çŠ¶æ€ç ï¼Œå¹¶å›å†™å®¢æˆ·ç«¯<strong>å“åº”</strong>( <code>exchange.getResponse().setComplete()</code> ) ã€‚</li></ul></li></ul><h1>4. KeyResolver</h1><p><code>org.springframework.cloud.gateway.filter.ratelimit.KeyResolver</code> ï¼Œè¯·æ±‚<strong>é”®</strong>è§£æå™¨<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyResolver</span> </span>&#123;</div><div class="line"><span class="function">Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>KeyResolver#resolve(ServerWebExchange)</code> æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚çš„é™æµ<strong>é”®</strong>ã€‚</li></ul><p>é€šè¿‡å®ç° KeyResolver æ¥å£ï¼Œå®ç°è·å¾—ä¸åŒçš„è¯·æ±‚çš„é™æµ<strong>é”®</strong>ï¼Œä¾‹å¦‚URL / ç”¨æˆ· / IP ç­‰ã€‚</p><p>ç›®å‰ç‰ˆæœ¬ï¼ŒSpring Cloud Gateway æä¾›çš„ KeyResolver å®ç°ç±»åªæœ‰ PrincipalNameKeyResolver ã€‚æ®å®˜æ–¹è¯´æ³•ï¼Œåœ¨æœªæ¥çš„é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¸­ï¼Œå°†ä¼šæœ‰ä¸€äº› KeyResolver å…·ä½“å®ç°ç±»ã€‚</p><h2>4.1 PrincipalNameKeyResolver</h2><p><code>org.springframework.cloud.gateway.filter.ratelimit.PrincipalNameKeyResolver</code> ï¼Œä½¿ç”¨è¯·æ±‚è®¤è¯çš„ <code>java.security.Principal</code> ä½œä¸ºé™æµ<strong>é”®</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrincipalNameKeyResolver</span> <span class="keyword">implements</span> <span class="title">KeyResolver</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"principalNameKeyResolver"</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> exchange.getPrincipal().map(Principal::getName).switchIfEmpty(Mono.empty());</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2>4.2 è‡ªå®šä¹‰ KeyResolver</h2><p>é€šè¿‡å®ç° KeyResolver æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰ KeyResolver ã€‚ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸ªä½¿ç”¨è¯·æ±‚ IP ä½œä¸ºé™æµ<strong>é”®</strong>çš„ KeyResolver ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º RemoteAddrKeyResolver ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteAddrKeyResolver</span> <span class="keyword">implements</span> <span class="title">KeyResolver</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"remoteAddrKeyResolver"</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Mono.just(exchange.getRequest().getRemoteAddress().getAddress().getHostAddress());</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ç¬¬äºŒæ­¥ï¼Œé…ç½® RemoteAddrKeyResolver Bean å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Bean</span>(name = RemoteAddrKeyResolver.BEAN_NAME)</div><div class="line"><span class="meta">@ConditionalOnBean</span>(RateLimiter.class)</div><div class="line"><span class="function"><span class="keyword">public</span> RemoteAddrKeyResolver <span class="title">remoteAddrKeyResolver</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RemoteAddrKeyResolver();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½® RouteDefinition è·¯ç”±é…ç½®ï¼Œé…ç½®å¦‚ä¸‹ ï¼š</p><p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">default_path_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://127.0.0.1:8081</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">RequestRateLimiter=10,</span> <span class="number">20</span><span class="string">,</span> <span class="comment">#&#123;@remoteAddrKeyResolver&#125;</span></div></pre></td></tr></table></figure></p><p>ç¬¬å››æ­¥ï¼Œ<strong>å¤§åŠŸå‘Šæˆ</strong>ï¼Œå¯åŠ¨ Spring Cloud Gateway å³å¯ã€‚</p><p>å¦å¤–ï¼Œæ¨è <a href="https://mp.weixin.qq.com/s?__biz=MzI4ODQ3NjE2OA==&amp;mid=2247483811&amp;idx=1&amp;sn=16fe7e25a90635e93c60048ebe8b40a2&amp;chksm=ec3c9cc4db4b15d2937fb8b2ef571c941b2bb9fefcf5ed8232e3699b4868392022a62b963699&amp;mpshare=1&amp;scene=1&amp;srcid=1201O46Ma9D5ln5TuxHUgziY#rd" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå‘¨ç«‹ â€”â€” Spring Cloudé™æµè¯¦è§£ï¼ˆé™„æºç ï¼‰ã€‹</a>ï¼Œé‡Œé¢æœ‰ä¸€äº›é™æµç»´åº¦çš„åˆ†æã€‚</p><h1>5. RateLimiter</h1><p><code>org.springframework.cloud.gateway.filter.ratelimit.RateLimiter</code> ï¼Œé™æµå™¨<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="function">Mono&lt;Response&gt; <span class="title">isAllowed</span><span class="params">(String id, Tuple args)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>#isAllowed(String id, Tuple args)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¢«é™æµã€‚</p></li><li><p>Response ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å…è®¸è®¿é—®( æœªè¢«é™æµ )</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> allowed;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»¤ç‰Œæ¡¶å‰©ä½™æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> tokensRemaining;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(<span class="keyword">boolean</span> allowed, <span class="keyword">long</span> tokensRemaining)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.allowed = allowed;</div><div class="line"><span class="keyword">this</span>.tokensRemaining = tokensRemaining;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li></ul><h2>5.1 GatewayRedisAutoConfiguration</h2><p><code>org.springframework.cloud.gateway.config.GatewayRedisAutoConfiguration</code> ï¼ŒRedis ç›¸å…³é…ç½®ç±»ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Configuration</span></div><div class="line"> <span class="number">2</span>: <span class="meta">@AutoConfigureAfter</span>(RedisReactiveAutoConfiguration.class)</div><div class="line"> <span class="number">3</span>: <span class="meta">@AutoConfigureBefore</span>(GatewayAutoConfiguration.class)</div><div class="line"> <span class="number">4</span>: <span class="meta">@ConditionalOnBean</span>(ReactiveRedisTemplate.class)</div><div class="line"> <span class="number">5</span>: <span class="meta">@ConditionalOnClass</span>(&#123;RedisTemplate.class, DispatcherHandler.class&#125;)</div><div class="line"> <span class="number">6</span>: <span class="class"><span class="keyword">class</span> <span class="title">GatewayRedisAutoConfiguration</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Bean</span></div><div class="line"> <span class="number">9</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> RedisScript <span class="title">redisRequestRateLimiterScript</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">11</span>: DefaultRedisScript redisScript = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</div><div class="line"><span class="number">12</span>: redisScript.setScriptSource(<span class="keyword">new</span> ResourceScriptSource(<span class="keyword">new</span> ClassPathResource(<span class="string">"META-INF/scripts/request_rate_limiter.lua"</span>)));</div><div class="line"><span class="number">13</span>: redisScript.setResultType(List.class);</div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> redisScript;</div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="meta">@Bean</span></div><div class="line"><span class="number">18</span>: <span class="comment">//<span class="doctag">TODO:</span> replace with ReactiveStringRedisTemplate in future</span></div><div class="line"><span class="number">19</span>: <span class="function"><span class="keyword">public</span> ReactiveRedisTemplate&lt;String, String&gt; <span class="title">stringReactiveRedisTemplate</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>: ReactiveRedisConnectionFactory reactiveRedisConnectionFactory,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">21</span>: ResourceLoader resourceLoader)</span> </span>&#123;</div><div class="line"><span class="number">22</span>: RedisSerializer&lt;String&gt; serializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line"><span class="number">23</span>: RedisSerializationContext&lt;String , String&gt; serializationContext = RedisSerializationContext</div><div class="line"><span class="number">24</span>: .&lt;String, String&gt;newSerializationContext()</div><div class="line"><span class="number">25</span>: .key(serializer)</div><div class="line"><span class="number">26</span>: .value(serializer)</div><div class="line"><span class="number">27</span>: .hashKey(serializer)</div><div class="line"><span class="number">28</span>: .hashValue(serializer)</div><div class="line"><span class="number">29</span>: .build();</div><div class="line"><span class="number">30</span>: <span class="keyword">return</span> <span class="keyword">new</span> ReactiveRedisTemplate&lt;&gt;(reactiveRedisConnectionFactory,</div><div class="line"><span class="number">31</span>: serializationContext);</div><div class="line"><span class="number">32</span>: &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="meta">@Bean</span></div><div class="line"><span class="number">35</span>: <span class="function"><span class="keyword">public</span> RedisRateLimiter <span class="title">redisRateLimiter</span><span class="params">(ReactiveRedisTemplate&lt;String, String&gt; redisTemplate,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">36</span>:  @Qualifier(<span class="string">"redisRequestRateLimiterScript"</span>)</span> RedisScript&lt;List&lt;Long&gt;&gt; redisScript) </span>&#123;</div><div class="line"><span class="number">37</span>: <span class="keyword">return</span> <span class="keyword">new</span> RedisRateLimiter(redisTemplate, redisScript);</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 8 è‡³ 15 è¡Œ ï¼šåˆ›å»º <code>org.springframework.data.redis.core.script.RedisScript</code> Bean å¯¹è±¡ï¼ŒåŠ è½½ <code>META-INF/scripts/request_rate_limiter.lua</code> è·¯å¾„ä¸‹çš„ Redis Lua è„šæœ¬ã€‚è¯¥è„šæœ¬ä½¿ç”¨ Redis åŸºäº<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>å®ç°é™æµã€‚åœ¨æœ¬æ–‡ <a href="#">ã€ŒRedis Lua è„šæœ¬ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 17 è‡³ 32 è¡Œ ï¼šåˆ›å»º <code>org.springframework.data.redis.core.ReactiveRedisTemplate</code> Bean å¯¹è±¡ã€‚</li><li>ç¬¬ 34 è‡³ 38 è¡Œ ï¼šä½¿ç”¨ RedisScript å’Œ ReactiveRedisTemplate Bean å¯¹è±¡ï¼Œåˆ›å»º RedisRateLimiter Bean å¯¹è±¡ã€‚</li></ul><h2>5.2 RedisRateLimiter</h2><p><code>org.springframework.cloud.gateway.filter.ratelimit.RedisRateLimiter</code> ï¼ŒåŸºäº Redis çš„åˆ†å¸ƒå¼é™æµå™¨<strong>å®ç°ç±»</strong>ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisRateLimiter</span> <span class="keyword">implements</span> <span class="title">RateLimiter</span> </span>&#123;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPLENISH_RATE_KEY = <span class="string">"replenishRate"</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BURST_CAPACITY_KEY = <span class="string">"burstCapacity"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, String&gt; redisTemplate;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> RedisScript&lt;List&lt;Long&gt;&gt; script;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">RedisRateLimiter</span><span class="params">(ReactiveRedisTemplate&lt;String, String&gt; redisTemplate,</span></span></div><div class="line"><span class="function"><span class="params">RedisScript&lt;List&lt;Long&gt;&gt; script)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.redisTemplate = redisTemplate;</div><div class="line"><span class="keyword">this</span>.script = script;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>redisTemplate</code> å±æ€§ï¼ŒRedisTemplate ã€‚</li><li><code>script</code> å±æ€§ï¼ŒLua è„šæœ¬ã€‚</li></ul><hr><p><code>#isAllowed(id, Tuple)</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Response&gt; <span class="title">isAllowed</span><span class="params">(String id, Tuple args)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: <span class="comment">// How many requests per second do you want a user to be allowed to do?</span></div><div class="line"> <span class="number">3</span>: <span class="keyword">int</span> replenishRate = args.getInt(REPLENISH_RATE_KEY);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="comment">// How much bursting do you want to allow?</span></div><div class="line"> <span class="number">6</span>: <span class="keyword">int</span> burstCapacity;</div><div class="line"> <span class="number">7</span>: <span class="keyword">if</span> (args.hasFieldName(BURST_CAPACITY_KEY)) &#123;</div><div class="line"> <span class="number">8</span>: burstCapacity = args.getInt(BURST_CAPACITY_KEY);</div><div class="line"> <span class="number">9</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>: burstCapacity = <span class="number">0</span>;</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>: <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>: <span class="comment">// Make a unique key per user.</span></div><div class="line"><span class="number">15</span>: String prefix = <span class="string">"request_rate_limiter."</span> + id;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// You need two Redis keys for Token Bucket.</span></div><div class="line"><span class="number">18</span>: List&lt;String&gt; keys = Arrays.asList(prefix + <span class="string">".tokens"</span>, prefix + <span class="string">".timestamp"</span>);</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="comment">// The arguments to the LUA script. time() returns unixtime in seconds.</span></div><div class="line"><span class="number">21</span>: List&lt;String&gt; scriptArgs = Arrays.asList(replenishRate + <span class="string">""</span>, burstCapacity + <span class="string">""</span>,</div><div class="line"><span class="number">22</span>:  Instant.now().getEpochSecond() + <span class="string">""</span>, <span class="string">"1"</span>);</div><div class="line"><span class="number">23</span>: <span class="comment">// allowed, tokens_left = redis.eval(SCRIPT, keys, args)</span></div><div class="line"><span class="number">24</span>: Flux&lt;List&lt;Long&gt;&gt; flux = <span class="keyword">this</span>.redisTemplate.execute(<span class="keyword">this</span>.script, keys, scriptArgs);</div><div class="line"><span class="number">25</span>: <span class="comment">// .log("redisratelimiter", Level.FINER);</span></div><div class="line"><span class="number">26</span>: <span class="keyword">return</span> flux</div><div class="line"><span class="number">27</span>: <span class="comment">// Throwable =&gt; Flux.just(Arrays.asList(1L, -1L)) ã€‚</span></div><div class="line"><span class="number">28</span>: .onErrorResume(throwable -&gt; Flux.just(Arrays.asList(<span class="number">1L</span>, -<span class="number">1L</span>)))</div><div class="line"><span class="number">29</span>: <span class="comment">// Flux&lt;List&lt;Long&gt;&gt; =&gt; Mono&lt;List&lt;Long&gt;&gt;</span></div><div class="line"><span class="number">30</span>: .reduce(<span class="keyword">new</span> ArrayList&lt;Long&gt;(), (longs, l) -&gt; &#123;</div><div class="line"><span class="number">31</span>: longs.addAll(l);</div><div class="line"><span class="number">32</span>: <span class="keyword">return</span> longs;</div><div class="line"><span class="number">33</span>: &#125;)</div><div class="line"><span class="number">34</span>: <span class="comment">// Mono&lt;List&lt;Long&gt;&gt; =&gt; Mono&lt;Response&gt;</span></div><div class="line"><span class="number">35</span>: .map(results -&gt; &#123;</div><div class="line"><span class="number">36</span>: <span class="keyword">boolean</span> allowed = results.get(<span class="number">0</span>) == <span class="number">1L</span>;</div><div class="line"><span class="number">37</span>: Long tokensLeft = results.get(<span class="number">1</span>);</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>: Response response = <span class="keyword">new</span> Response(allowed, tokensLeft);</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line"><span class="number">42</span>: log.debug(<span class="string">"response: "</span> + response);</div><div class="line"><span class="number">43</span>: &#125;</div><div class="line"><span class="number">44</span>: <span class="keyword">return</span> response;</div><div class="line"><span class="number">45</span>: &#125;);</div><div class="line"><span class="number">46</span>: &#125;</div><div class="line"><span class="number">47</span>: <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">48</span>: <span class="comment">/*</span></div><div class="line"><span class="comment">49:  * We don't want a hard dependency on Redis to allow traffic. Make sure to set</span></div><div class="line"><span class="comment">50:  * an alert so you know if this is happening too much. Stripe's observed</span></div><div class="line"><span class="comment">51:  * failure rate is 0.01%.</span></div><div class="line"><span class="comment">52:  */</span></div><div class="line"><span class="number">53</span>: log.error(<span class="string">"Error determining if user allowed from redis"</span>, e);</div><div class="line"><span class="number">54</span>: &#125;</div><div class="line"><span class="number">55</span>: <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> Response(<span class="keyword">true</span>, -<span class="number">1</span>));</div><div class="line"><span class="number">56</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>id</code> æ–¹æ³•å‚æ•°ï¼Œä»¤ç‰Œæ¡¶ç¼–å·ã€‚ä¸€ä¸ªä»¤ç‰Œæ¡¶ç¼–å·å¯¹åº”ä»¤ç‰Œæ¡¶ã€‚</p><ul><li>åœ¨æœ¬æ–‡åœºæ™¯ä¸­ä¸ºè¯·æ±‚é™æµ<strong>é”®</strong>ã€‚</li></ul></li><li><p>ç¬¬ 3 è¡Œ ï¼šè·å¾— <code>burstCapacity</code> ä»¤ç‰Œæ¡¶ä¸Šé™ã€‚</p></li><li><p>ç¬¬ 5 è‡³ 11 è¡Œ ï¼šè·å¾— <code>replenishRate</code> ï¼Œä»¤ç‰Œæ¡¶å¡«å……å¹³å‡é€Ÿç‡ï¼Œå•ä½ï¼šç§’ã€‚</p></li><li><p>ç¬¬ 15 è¡Œ ï¼šè·å¾—ä»¤ç‰Œæ¡¶å‰ç¼€ï¼Œ<code>request_rate_limiter.${id}</code> ã€‚</p></li><li><p>ç¬¬ 18 è¡Œ ï¼šè·å¾—ä»¤ç‰Œæ¡¶é”®æ•°ç»„ ï¼š</p><ul><li><code>request_rate_limiter.${id}.tokens</code> ï¼šä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°ã€‚</li><li><code>request_rate_limiter.${id}.timestamp</code> ï¼šä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li></ul></li><li><p>ç¬¬ 21 è‡³ 22 è¡Œ ï¼šè·å¾— Lua è„šæœ¬å‚æ•° ï¼š</p><ul><li><p>ç¬¬ä¸€ä¸ªå‚æ•° ï¼š<code>replenishRate</code> ã€‚</p></li><li><p>ç¬¬äºŒä¸ªå‚æ•° ï¼š<code>burstCapacity</code> ã€‚</p></li><li><p>ç¬¬ä¸‰ä¸ªå‚æ•° ï¼šå¾—åˆ°ä» <code>1970-01-01 00:00:00</code> å¼€å§‹çš„ç§’æ•°ã€‚<strong>ä¸ºä»€ä¹ˆåœ¨ Java ä»£ç é‡Œè·å–ï¼Œè€Œä¸ä½¿ç”¨ Lua åœ¨ Reids é‡Œè·å–</strong>ï¼Ÿ</p><blockquote><p>FROM <a href="https://union-click.jd.com/jdc?d=pT3LH8" rel="external nofollow noopener noreferrer" target="_blank">ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹</a><br>å› ä¸º Redis çš„é™åˆ¶ï¼ˆ Luaä¸­æœ‰å†™æ“ä½œä¸èƒ½ä½¿ç”¨å¸¦éšæœºæ€§è´¨çš„è¯»æ“ä½œï¼Œå¦‚TIME ï¼‰ä¸èƒ½åœ¨ Redis Luaä¸­ ä½¿ç”¨ TIME è·å–æ—¶é—´æˆ³ï¼Œå› æ­¤åªå¥½ä»åº”ç”¨è·å–ç„¶åä¼ å…¥ï¼Œåœ¨æŸäº›æç«¯æƒ…å†µä¸‹ï¼ˆæœºå™¨æ—¶é’Ÿä¸å‡†çš„æƒ…å†µä¸‹ï¼‰ï¼Œé™æµä¼šå­˜åœ¨ä¸€äº›å°é—®é¢˜ã€‚* æ¶›å“¥è¿™æœ¬ä¹¦éå¸¸ä¸é”™ï¼Œæ¨èè´­ä¹°ã€‚</p></blockquote></li><li><p>ç¬¬å››ä¸ªå‚æ•° ï¼šæ¶ˆè€—ä»¤ç‰Œæ•°é‡ï¼Œé»˜è®¤ 1 ã€‚</p></li></ul></li><li><p>ç¬¬ 24 è¡Œ ï¼šè°ƒç”¨ <code>ReactiveRedisTemplate#execute(RedisScript&lt;T&gt;, List&lt;K&gt;, List&lt;?&gt;)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Redis Lua è„šæœ¬ï¼Œè·å–ä»¤ç‰Œã€‚è¿”å›ç»“æœä¸º <code>[æ˜¯å¦è·å–ä»¤ç‰ŒæˆåŠŸ, å‰©ä½™ä»¤ç‰Œæ•°]</code> ï¼Œå…¶ä¸­ï¼Œ<code>1</code> ä»£è¡¨è·å–ä»¤ç‰Œ<strong>æˆåŠŸ</strong>ï¼Œ<code>0</code> ä»£è¡¨ä»¤ç‰Œè·å–<strong>å¤±è´¥</strong>ã€‚</p></li><li><p>ç¬¬ 25 è¡Œ ï¼šå½“ Redis Lua è„šæœ¬è¿‡ç¨‹ä¸­å‘ç”Ÿ<strong>å¼‚å¸¸</strong>ï¼Œå¿½ç•¥å¼‚å¸¸ï¼Œè¿”å› <code>Flux.just(Arrays.asList(1L, -1L))</code> ï¼Œå³è®¤ä¸º<strong>è·å–ä»¤ç‰ŒæˆåŠŸ</strong>ã€‚ä¸ºä»€ä¹ˆï¼Ÿåœ¨ Redis å‘ç”Ÿæ•…éšœæ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›é™æµå™¨å¯¹ Reids æ˜¯<strong>å¼ºä¾èµ–</strong>ï¼Œå¹¶ä¸” Redis å‘ç”Ÿæ•…éšœçš„æ¦‚ç‡æœ¬èº«å°±å¾ˆä½ã€‚</p><blockquote><p>We don't want a hard dependency on Redis to allow traffic.<br>Make sure to set an alert so you know if this is happening too much. Stripe's observed failure rate is 0.01%.</p></blockquote></li><li><p>ç¬¬ 30 è‡³ 33 è¡Œ ï¼šè°ƒç”¨ <code>Flux#reduce(A, BiFunction&lt;A, ? super T, A&gt;)</code> æ–¹æ³•ï¼Œå°† <code>Flux&lt;List&lt;Long&gt;&gt;</code> è½¬æ¢æˆ <code>Mono&lt;List&lt;Long&gt;&gt;</code> ã€‚å› ä¸º <code>ReactiveRedisTemplate#execute(RedisScript&lt;T&gt;, List&lt;K&gt;, List&lt;?&gt;)</code> æ–¹æ³•çš„æ‰§è¡Œç»“æœä¸º Flux ( å¤šæ¬¡ )ï¼Œå®é™…åœ¨å½“å‰åœºæ™¯é‡Œï¼Œè‡ªè¡Œ Redis Lua è„šæœ¬åªä¼šè¿”å›<strong>ä¸€æ¬¡</strong>æ•°ç»„ï¼Œæ‰€ä»¥è½¬æ¢æˆ Mono (ä¸€æ¬¡)ã€‚</p></li><li><p>ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè°ƒç”¨ <code>Mono#map(Function&lt;? super T, ? extends R&gt;)</code> æ–¹æ³•ï¼Œå°† <code>Mono&lt;List&lt;Long&gt;&gt;</code> =&gt; <code>Mono&lt;Response&gt;</code> ã€‚</p></li><li><p>ç¬¬ 47 è‡³ 55 è¡Œ ï¼šå½“ã€ç¬¬ 15 è‡³ 24 è¡Œã€‘ä»£ç éƒ¨åˆ†æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¾‹å¦‚ Redis æŒ‚äº†ï¼Œè¿”å› <code>Flux.just(Arrays.asList(1L, -1L))</code> ï¼Œå³è®¤ä¸º<strong>è·å–ä»¤ç‰ŒæˆåŠŸ</strong>ã€‚</p></li></ul><h2>5.3 Redis Lua è„šæœ¬</h2><p><code>META-INF/scripts/request_rate_limiter.lua</code> ï¼ŒRedis Lua è„šæœ¬ï¼Œå®ç°åŸºäº<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>å®ç°é™æµã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight lua"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">local</span> tokens_key = KEYS[<span class="number">1</span>]</div><div class="line"> <span class="number">2</span>: <span class="keyword">local</span> timestamp_key = KEYS[<span class="number">2</span>]</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</div><div class="line"> <span class="number">5</span>: <span class="keyword">local</span> capacity = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</div><div class="line"> <span class="number">6</span>: <span class="keyword">local</span> now = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</div><div class="line"> <span class="number">7</span>: <span class="keyword">local</span> requested = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>: <span class="keyword">local</span> fill_time = capacity/rate</div><div class="line"><span class="number">10</span>: <span class="keyword">local</span> ttl = <span class="built_in">math</span>.<span class="built_in">floor</span>(fill_time*<span class="number">2</span>)</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="keyword">local</span> last_tokens = <span class="built_in">tonumber</span>(redis.call(<span class="string">"get"</span>, tokens_key))</div><div class="line"><span class="number">13</span>: <span class="keyword">if</span> last_tokens == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line"><span class="number">14</span>:   last_tokens = capacity</div><div class="line"><span class="number">15</span>: <span class="keyword">end</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="keyword">local</span> last_refreshed = <span class="built_in">tonumber</span>(redis.call(<span class="string">"get"</span>, timestamp_key))</div><div class="line"><span class="number">18</span>: <span class="keyword">if</span> last_refreshed == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line"><span class="number">19</span>:   last_refreshed = <span class="number">0</span></div><div class="line"><span class="number">20</span>: <span class="keyword">end</span></div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="keyword">local</span> delta = <span class="built_in">math</span>.<span class="built_in">max</span>(<span class="number">0</span>, now-last_refreshed)</div><div class="line"><span class="number">23</span>: <span class="keyword">local</span> filled_tokens = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, last_tokens+(delta*rate))</div><div class="line"><span class="number">24</span>: <span class="keyword">local</span> allowed = filled_tokens &gt;= requested</div><div class="line"><span class="number">25</span>: <span class="keyword">local</span> new_tokens = filled_tokens</div><div class="line"><span class="number">26</span>: <span class="keyword">local</span> allowed_num = <span class="number">0</span></div><div class="line"><span class="number">27</span>: <span class="keyword">if</span> allowed <span class="keyword">then</span></div><div class="line"><span class="number">28</span>:   new_tokens = filled_tokens - requested</div><div class="line"><span class="number">29</span>:   allowed_num = <span class="number">1</span></div><div class="line"><span class="number">30</span>: <span class="keyword">end</span></div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>: redis.call(<span class="string">"setex"</span>, tokens_key, ttl, new_tokens)</div><div class="line"><span class="number">33</span>: redis.call(<span class="string">"setex"</span>, timestamp_key, ttl, now)</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> &#123; allowed_num, new_tokens &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 1 è‡³ 2 è¡Œ ï¼šKEYS æ–¹æ³•å‚æ•° ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•° ï¼š<code>request_rate_limiter.${id}.tokens</code> ï¼Œä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° ï¼š<code>request_rate_limiter.${id}.timestamp</code> ï¼Œä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li></ul></li><li><p>ç¬¬ 4 è‡³ 7 è¡Œ ï¼šARGV æ–¹æ³•å‚æ•° ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•° ï¼š<code>replenishRate</code> ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° ï¼š<code>burstCapacity</code> ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•° ï¼šå¾—åˆ°ä» <code>1970-01-01 00:00:00</code> å¼€å§‹çš„ç§’æ•°ã€‚</li><li>ç¬¬å››ä¸ªå‚æ•° ï¼šæ¶ˆè€—ä»¤ç‰Œæ•°é‡ï¼Œé»˜è®¤ 1 ã€‚</li></ul></li><li><p>ç¬¬ 9 è¡Œ ï¼šè®¡ç®—ä»¤ç‰Œæ¡¶å¡«å……<strong>æ»¡</strong>ä»¤ç‰Œéœ€è¦å¤šä¹…æ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</p></li><li><p>ç¬¬ 10 è¡Œ ï¼šè®¡ç®— <code>request_rate_limiter.${id}.tokens</code> / <code>request_rate_limiter.${id}.timestamp</code> çš„ <strong>ttl</strong> ã€‚<code>* 2</code> ä¿è¯æ—¶é—´å……è¶³ã€‚</p></li><li><p>ç¬¬ 12 è‡³ 20 è¡Œ ï¼šè°ƒç”¨ <code>get</code> å‘½ä»¤ï¼Œè·å¾—ä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°( <code>last_tokens</code> ) ï¼Œä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´(<code>last_refreshed</code>) ã€‚</p></li><li><p>ç¬¬ 22 è‡³ 23 è¡Œ ï¼šå¡«å……ä»¤ç‰Œï¼Œè®¡ç®—<strong>æ–°</strong>çš„ä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°( <code>filled_tokens</code> )ã€‚å¡«å……ä¸è¶…è¿‡ä»¤ç‰Œæ¡¶ä»¤ç‰Œ<strong>ä¸Šé™</strong>ã€‚</p></li><li><p>ç¬¬ 24 è‡³ 30 è¡Œ ï¼šè·å–ä»¤ç‰Œæ˜¯å¦æˆåŠŸã€‚</p><ul><li>è‹¥<strong>æˆåŠŸ</strong>ï¼Œä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°(<code>new_tokens</code>) <strong>å‡</strong>æ¶ˆè€—ä»¤ç‰Œæ•°( <code>requested</code> )ï¼Œå¹¶è®¾ç½®è·å–æˆåŠŸ( <code>allowed_num = 1</code> ) ã€‚</li><li>è‹¥<strong>å¤±è´¥</strong>ï¼Œè®¾ç½®è·å–å¤±è´¥( <code>allowed_num = 0</code> ) ã€‚</li></ul></li><li><p>ç¬¬ 32 è‡³ 33 è¡Œ ï¼šè®¾ç½®ä»¤ç‰Œæ¡¶<strong>å‰©ä½™</strong>ä»¤ç‰Œæ•°( <code>new_tokens</code> ) ï¼Œä»¤ç‰Œæ¡¶<strong>æœ€å</strong>å¡«å……ä»¤ç‰Œæ—¶é—´(<code>now</code>) ã€‚</p></li><li><p>ç¬¬ 35 è¡Œ ï¼šè¿”å›æ•°ç»„ç»“æœï¼Œ<code>[æ˜¯å¦è·å–ä»¤ç‰ŒæˆåŠŸ, å‰©ä½™ä»¤ç‰Œæ•°]</code> ã€‚</p></li></ul><p><strong>Redis Lua è„šæœ¬ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ä¹ˆ</strong>ï¼Ÿ</p><blockquote><p>FROM <a href="https://union-click.jd.com/jdc?d=pT3LH8" rel="external nofollow noopener noreferrer" target="_blank">ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹</a><br>å›  Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œå› æ­¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></blockquote><h1>666. å½©è›‹</h1><p>å“‡å“ˆå“ˆï¼Œè¿‡æ»¤å™¨å…¨éƒ¨å®Œæˆã€‚æ©ï¼Œå½“ç„¶åé¢éœ€è¦åœ¨è€ƒè™‘ä¸€ä¸‹ï¼Œä¾‹å¦‚è®¤è¯è¿‡æ»¤å™¨ç­‰ç­‰ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_10/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-G
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.9) ä¹‹ HystrixGatewayFilterFactory ç†”æ–­</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/</id>
    <published>2020-04-04T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">3. HystrixGatewayFilterFactory</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">4. æ³¨æ„äº‹é¡¹</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>HystrixGatewayFilterFactory çš„ä»£ç å®ç°</strong>ã€‚</p><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-factory/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.2) ä¹‹ GatewayFilterFactory è¿‡æ»¤å™¨å·¥å‚ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° Spring Cloud Gateway æä¾›äº†å¤šç§ GatewayFilterFactory çš„å®ç°ï¼Œè€Œ HystrixGatewayFilterFactory ä¹Ÿæ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚</p><p>é€šè¿‡ HystrixGatewayFilterFactory ï¼Œå¯ä»¥åˆ›å»º HystrixGatewayFilter ( å®é™…æ˜¯å†…éƒ¨åŒ¿åç±»ï¼Œä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼Œä¸‹é¢ç»§ç»­è¿™ä¹ˆç§°å‘¼ ) ã€‚</p><p>HystrixGatewayFilter ä½¿ç”¨ <a href="https://github.com/Netflix/Hystrix" rel="external nofollow noopener noreferrer" target="_blank">Hystrix</a> ï¼Œå®ç°åŸºäº <strong>Route</strong> çº§åˆ«çš„ç†”æ–­åŠŸèƒ½ã€‚</p><p>è¿™é‡Œï¼Œç¬”è€…ä¸€æœ¬æ­£ç»çš„æ¨èä¸‹è‡ªå·±åˆ†äº«çš„ <a href="http://www.iocoder.cn/categories/Hystrix/?self">ã€ŠHystrix æºç è§£æç³»åˆ—ã€‹</a> ï¼Œç®€ç›´ä¸šç•Œè‰¯å¿ƒã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ç¯å¢ƒæ­å»º</h1><p>ç¬¬ä¸€æ­¥ï¼Œä»¥ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ä¸ºåŸºç¡€ï¼Œåœ¨ <code>pom.xml</code> æ–‡ä»¶æ·»åŠ ä¾èµ–åº“ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ <code>application.yml</code> é…ç½®<strong>ä¸€ä¸ª</strong> RouteDefinition ã€‚</p><p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">default_path_to_httpbin</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">http://127.0.0.1:8081</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/**</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Hystrix=myCommandName</span></div></pre></td></tr></table></figure></p><ul><li><code>- Hystrix=myCommandName</code> ï¼Œé…ç½® HystrixGatewayFilterFactory ï¼Œå¹¶ä»¥ <code>myCommandName</code> ä¸º <strong>Hystrix Command åå­—</strong>ã€‚</li></ul><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®Œæˆï¼Œå¯åŠ¨ <code>spring-cloud-gateway-sample</code> é¡¹ç›®ã€‚</p><h1>3. HystrixGatewayFilterFactory</h1><p><code>org.springframework.cloud.gateway.filter.factory.HystrixGatewayFilterFactory</code> ï¼Œç†”æ–­ç½‘å…³è¿‡æ»¤å™¨<strong>å·¥å‚</strong>ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixGatewayFilterFactory</span> <span class="keyword">implements</span> <span class="title">GatewayFilterFactory</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">argNames</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> Arrays.asList(NAME_KEY);</div><div class="line"> <span class="number">6</span>: &#125;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Tuple args)</span> </span>&#123;</div><div class="line"><span class="number">10</span>: <span class="comment">//<span class="doctag">TODO:</span> if no name is supplied, generate one from command id (useful for default filter)</span></div><div class="line"><span class="number">11</span>: <span class="keyword">final</span> String commandName = args.getString(NAME_KEY);</div><div class="line"><span class="number">12</span>: <span class="keyword">final</span> HystrixCommandGroupKey groupKey = HystrixCommandGroupKey.Factory.asKey(getClass().getSimpleName());</div><div class="line"><span class="number">13</span>: <span class="keyword">final</span> HystrixCommandKey commandKey = HystrixCommandKey.Factory.asKey(commandName);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="keyword">final</span> HystrixObservableCommand.Setter setter = HystrixObservableCommand.Setter</div><div class="line"><span class="number">16</span>: .withGroupKey(groupKey)</div><div class="line"><span class="number">17</span>: .andCommandKey(commandKey);</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>: <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line"><span class="number">20</span>: RouteHystrixCommand command = <span class="keyword">new</span> RouteHystrixCommand(setter, exchange, chain);</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>: <span class="keyword">return</span> Mono.create(s -&gt; &#123;</div><div class="line"><span class="number">23</span>:     <span class="comment">// ä½¿ç”¨ Hystrix Command Observable è®¢é˜…</span></div><div class="line"><span class="number">24</span>: Subscription sub = command.toObservable().subscribe(s::success, s::error, s::success);</div><div class="line"><span class="number">25</span>: <span class="comment">// Mono å–æ¶ˆæ—¶ï¼Œå–æ¶ˆ Hystrix Command Observable çš„è®¢é˜…ï¼Œç»“æŸ Hystrix Command çš„æ‰§è¡Œ</span></div><div class="line"><span class="number">26</span>: s.onCancel(sub::unsubscribe);</div><div class="line"><span class="number">27</span>: &#125;).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; &#123;</div><div class="line"><span class="number">28</span>: <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> HystrixRuntimeException) &#123;</div><div class="line"><span class="number">29</span>: HystrixRuntimeException e = (HystrixRuntimeException) throwable;</div><div class="line"><span class="number">30</span>: <span class="keyword">if</span> (e.getFailureType() == TIMEOUT) &#123; <span class="comment">//<span class="doctag">TODO:</span> optionally set status</span></div><div class="line"><span class="number">31</span>: setResponseStatus(exchange, HttpStatus.GATEWAY_TIMEOUT);</div><div class="line"><span class="number">32</span>: <span class="keyword">return</span> exchange.getResponse().setComplete();</div><div class="line"><span class="number">33</span>: &#125;</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">36</span>: &#125;).then();</div><div class="line"><span class="number">37</span>: &#125;;</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p><code>#argNames()</code> æ–¹æ³•ï¼Œå®šä¹‰äº† Tuple å‚æ•°çš„ Key ä¸º <code>name</code> ã€‚</p></li><li><p><code>#apply()</code> æ–¹æ³•ï¼Œåˆ›å»º HystrixGatewayFilter å¯¹è±¡ã€‚</p></li><li><p>ç¬¬ 11 è¡Œ ï¼šä» Tuple å‚æ•°è·å¾— Hystrix Command åå­—ï¼Œä¾‹å¦‚ä¸Šé¢ä¸¾ä¾‹çš„ RouteDefinition æ—¶ï¼Œ<code>commandName = myCommandName</code> ã€‚</p></li><li><p>ç¬¬ 12 è¡Œ ï¼šåˆ›å»º Hystrix Command åˆ†ç»„ Key ä¸º <code>HystrixGatewayFilterFactory</code> ã€‚</p></li><li><p>ç¬¬ 13 è¡Œ ï¼šåˆ›å»º Hystrix Command Key ä¸º <code>commandName</code> ã€‚</p></li><li><p>ç¬¬ 15 è‡³ 17 è¡Œ ï¼šåˆ›å»º HystrixObservableCommand.Setter å¯¹è±¡ã€‚</p></li><li><p>--------- ç¬¬ 19 è‡³ 37 è¡Œ ï¼š<strong>åˆ›å»º HystrixGatewayFilter å¯¹è±¡å¹¶è¿”å›</strong>ã€‚</p></li><li><p>ç¬¬ 20 è¡Œ ï¼šåˆ›å»º RouteHystrixCommand å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteHystrixCommand</span> <span class="keyword">extends</span> <span class="title">HystrixObservableCommand</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ServerWebExchange exchange;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> GatewayFilterChain chain;</div><div class="line"></div><div class="line">RouteHystrixCommand(Setter setter, ServerWebExchange exchange, GatewayFilterChain chain) &#123;</div><div class="line"><span class="keyword">super</span>(setter);</div><div class="line"><span class="keyword">this</span>.exchange = exchange;</div><div class="line"><span class="keyword">this</span>.chain = chain;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Observable&lt;Void&gt; <span class="title">construct</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> RxReactiveStreams.toObservable(<span class="keyword">this</span>.chain.filter(<span class="keyword">this</span>.exchange));</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 22 è‡³ 26 è¡Œ ï¼šè°ƒç”¨ <code>Mono#create(Consumer&lt;MonoSink&lt;T&gt;&gt;)</code> æ–¹æ³•ï¼Œåˆ›å»º Mono å¯¹è±¡ã€‚ç‚¹å‡» <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#create-java.util.function.Consumer-" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> æŸ¥çœ‹è¯¥æ–¹æ³•è¯¦ç»†è¯´æ˜ã€‚å› ä¸º Hystrix åŸºäº RxJava ï¼Œè€Œ GatewayFilter åŸºäº Reactor ( Mono æ˜¯å…¶å†…éƒ¨çš„ä¸€ä¸ªç±» )ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œå®ç°è®¢é˜…çš„é€‚é…ã€‚<strong>æœªæ¥ï¼Œä¼šå®ç° <a href="https://github.com/Netflix/Hystrix/issues/1089#issuecomment-180512000" rel="external nofollow noopener noreferrer" target="_blank">HystrixMonoCommand</a> æ›¿æ¢ HystrixObservableCommand ï¼Œä»è€Œç»Ÿä¸€è®¢é˜…ï¼Œå»é™¤é€‚é…ä»£ç </strong>ã€‚</p><ul><li>ç¬¬ 24 è¡Œ ï¼š1ï¼‰è°ƒç”¨ <code>RouteHystrixCommand#toObservable()</code> æ–¹æ³•ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ <code>RouteHystrixCommand#construct()</code> æ–¹æ³•ï¼Œè·å¾—æ‰§è¡Œ <code>this.chain.filter(this.exchange)</code> çš„ Observable ã€‚2ï¼‰è®¢é˜… Observable ï¼šæˆåŠŸæˆ–å®Œæˆæ—¶ï¼Œè°ƒç”¨ <code>Mono#success(Object)</code> æ–¹æ³•ï¼Œç›®å‰åˆ›å»ºçš„ Mono ä¸Šæ²¡æœ‰ç›¸å…³çš„è®¢é˜…ï¼›<strong>å¼‚å¸¸æ—¶</strong>ï¼Œè°ƒç”¨ <code>Mono#error(Object)</code> æ–¹æ³•ï¼Œç›®å‰åˆ›å»ºçš„ Mono ä¸Šè°ƒç”¨ <code>Mongo#onErrorResume(Function&lt;Throwable, Mono&lt;Void&gt;&gt;))</code> æ–¹æ³•ï¼Œè¿›è¡Œè®¢é˜…ã€‚</li><li>ç¬¬ 26 è¡Œ ï¼šMono å–æ¶ˆæ—¶ï¼Œå–æ¶ˆ Hystrix Command Observable çš„è®¢é˜…ï¼Œç»“æŸ Hystrix Command çš„æ‰§è¡Œã€‚</li></ul></li><li><p>ç¬¬ 27 è‡³ 34 è¡Œ ï¼šå½“ Hystrix Command <strong>æ‰§è¡Œè¶…æ—¶</strong>æ—¶ï¼Œè®¾ç½®å“åº” 504 çŠ¶æ€ç ï¼Œå¹¶å›å†™å®¢æˆ·ç«¯<strong>å“åº”</strong>( <code>exchange.getResponse().setComplete()</code> ) ã€‚</p></li><li><p>ç¬¬ 35 è¡Œ ï¼š<strong>å½“ Hystrix Command å‘ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶ï¼Œä¾‹å¦‚æ–­è·¯å™¨æ‰“å¼€ï¼Œè¿”å› <code>Mono.empty()</code> ï¼Œæœ€ç»ˆè¿”å›å®¢æˆ·ç«¯ 200 çŠ¶æ€ç ï¼Œå†…å®¹ä¸ºç©º</strong>ã€‚</p></li><li><p>ç¬¬ 36 è¡Œ ï¼šè°ƒç”¨ <code>Mono#then()</code> æ–¹æ³•ï¼Œ<strong>å‚æ•°ä¸ºç©º</strong>ï¼Œè¿”å›ç©º Mono ï¼Œä¸å†å‘åå‘å°„æ•°æ®ã€‚</p></li></ul><h1>4. æ³¨æ„äº‹é¡¹</h1><ol><li><p>ç›®å‰ Hystrix Command æ‰§è¡Œè¶…æ—¶æ—¶ï¼Œè¿”å›å®¢æˆ·ç«¯ 504 çŠ¶æ€ç ï¼Œå¦‚æœä½¿ç”¨ JSON æ ¼å¼ä½œä¸ºæ•°æ®è¿”å›ï¼Œåˆ™éœ€è¦ä¿®æ”¹ä¸‹è¯¥ HystrixGatewayFilter çš„ä»£ç å®ç°ã€‚</p></li><li><p>Hystrix é…ç½®å‚æ•°ï¼Œç›®å‰åªèƒ½<strong>å…¨å±€</strong>é…ç½®ï¼Œä¾‹å¦‚è¯´ Hystrix æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œé…ç½®å¦‚ä¸‹ ï¼š</p><p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">hystrix:</span></div><div class="line"><span class="attr">  command:</span></div><div class="line"><span class="attr">    default:</span></div><div class="line"><span class="attr">      execution:</span></div><div class="line"><span class="attr">        isolation:</span></div><div class="line"><span class="attr">          thread:</span></div><div class="line"><span class="attr">            timeoutInMilliseconds:</span> <span class="number">10000</span></div></pre></td></tr></table></figure></p><ul><li>å¦‚æœæƒ³å®ç° Route / URL çº§åˆ«çš„ Hystrix é…ç½®å‚æ•°ï¼Œåˆ™éœ€è¦ä¿®æ”¹ä¸‹è¯¥ HystrixGatewayFilter çš„ä»£ç å®ç°ã€‚</li><li><a href="https://github.com/Netflix/Hystrix/wiki/Configuration#contents" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHystrix â€”â€” Configurationã€‹</a> ï¼ŒHystrix é…ç½®é¡¹ï¼Œéœ€è¦è‡ªå–ã€‚</li></ul></li><li><p>å½“ Hystrix ç†”æ–­æ—¶ï¼Œæœ€ç»ˆè¿”å›å®¢æˆ·ç«¯ 200 çŠ¶æ€ç ï¼Œå†…å®¹ä¸ºç©ºï¼Œæ­¤å¤„å»ºè®®è¯¥ HystrixGatewayFilter çš„ä»£ç å®ç°ã€‚</p></li></ol><h1>666. å½©è›‹</h1><p>å˜¿å˜¿å˜¿ï¼Œå†™å®Œç†”æ–­ï¼Œå‡†å¤‡é™æµè¿‡æ»¤å™¨èµ°èµ·ã€‚é¸¡å†»ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_05/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-hystrix/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X 
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/</id>
    <published>2020-03-31T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">2. ç¯å¢ƒé…ç½®</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">3. WebClientHttpRoutingFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">4. WebClientWriteResponseFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">5. å’Œ NettyRoutingFilter å¯¹æ¯”</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>WebClientHttpRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>WebClientHttpRoutingFilter ï¼ŒHttp <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>http://</code> æˆ– <code>https://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œä½¿ç”¨åŸºäº <code>org.springframework.cloud.gateway.filter.WebClient</code> å®ç°çš„ HttpClient è¯·æ±‚åç«¯ Http æœåŠ¡ã€‚</p><p>WebClientWriteResponseFilter ï¼Œä¸ WebClientHttpRoutingFilter <strong>æˆå¯¹ä½¿ç”¨</strong>çš„ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶å°† WebClientWriteResponseFilter è¯·æ±‚åç«¯ Http æœåŠ¡çš„<strong>å“åº”</strong>å†™å›å®¢æˆ·ç«¯ã€‚</p><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_01/01.png" alt=""></p><h1>2. ç¯å¢ƒé…ç½®</h1><p>ç›®å‰ WebClientHttpRoutingFilter / WebClientWriteResponseFilter å¤„äº<strong>å®éªŒ</strong>é˜¶æ®µï¼Œå»ºè®®ç­‰æ­£å¼å‘å¸ƒåœ¨ä½¿ç”¨ã€‚</p><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ç¯å¢ƒã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåœ¨ NettyConfiguration æ³¨é‡Šæ‰ <code>#routingFilter(...)</code> å’Œ <code>#nettyWriteResponseFilter()</code> ä¸¤ä¸ª Bean æ–¹æ³•ã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œåœ¨ GatewayAutoConfiguration æ‰“å¼€ <code>#webClientHttpRoutingFilter()</code> å’Œ <code>#webClientWriteResponseFilter()</code> ä¸¤ä¸ª Bean æ–¹æ³•ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®Œæˆï¼Œå¯åŠ¨ Spring Cloud Gateway ã€‚</p><h1>3. WebClientHttpRoutingFilter</h1><p><code>org.springframework.cloud.gateway.filter.WebClientHttpRoutingFilter</code> ï¼ŒHttp <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebClientHttpRoutingFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebClientHttpRoutingFilter</span><span class="params">(WebClient webClient)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.webClient = webClient;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>webClient</code> å±æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>org.springframework.web.reactive.function.client.DefaultWebClient</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¯·æ±‚åç«¯çš„ Http æœåŠ¡</strong>ã€‚</li></ul><hr><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// è·å¾— requestUrl</span></div><div class="line"> <span class="number">4</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"> <span class="number">7</span>: String scheme = requestUrl.getScheme();</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || (!scheme.equals(<span class="string">"http"</span>) &amp;&amp; !scheme.equals(<span class="string">"https"</span>))) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">13</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: ServerHttpRequest request = exchange.getRequest();</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">//<span class="doctag">TODO:</span> support forms</span></div><div class="line"><span class="number">18</span>: <span class="comment">// Request Method</span></div><div class="line"><span class="number">19</span>: HttpMethod method = request.getMethod();</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">// Request</span></div><div class="line"><span class="number">22</span>: RequestBodySpec bodySpec = <span class="keyword">this</span>.webClient.method(method)</div><div class="line"><span class="number">23</span>: .uri(requestUrl)</div><div class="line"><span class="number">24</span>: .headers(httpHeaders -&gt; &#123;</div><div class="line"><span class="number">25</span>: httpHeaders.addAll(request.getHeaders());</div><div class="line"><span class="number">26</span>: httpHeaders.remove(HttpHeaders.HOST);</div><div class="line"><span class="number">27</span>: &#125;);</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>: <span class="comment">// Request Body</span></div><div class="line"><span class="number">30</span>: RequestHeadersSpec&lt;?&gt; headersSpec;</div><div class="line"><span class="number">31</span>: <span class="keyword">if</span> (requiresBody(method)) &#123;</div><div class="line"><span class="number">32</span>: headersSpec = bodySpec.body(BodyInserters.fromDataBuffers(request.getBody()));</div><div class="line"><span class="number">33</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">34</span>: headersSpec = bodySpec;</div><div class="line"><span class="number">35</span>: &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>: <span class="keyword">return</span> headersSpec.exchange()</div><div class="line"><span class="number">38</span>: <span class="comment">// .log("webClient route")</span></div><div class="line"><span class="number">39</span>: .flatMap(res -&gt; &#123;</div><div class="line"><span class="number">40</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: <span class="comment">// Response Header</span></div><div class="line"><span class="number">43</span>: response.getHeaders().putAll(res.headers().asHttpHeaders());</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>: <span class="comment">// Response Status</span></div><div class="line"><span class="number">46</span>: response.setStatusCode(res.statusCode());</div><div class="line"><span class="number">47</span>: </div><div class="line"><span class="number">48</span>: <span class="comment">// è®¾ç½® Response åˆ° CLIENT_RESPONSE_ATTR</span></div><div class="line"><span class="number">49</span>: <span class="comment">// Defer committing the response until all route filters have run</span></div><div class="line"><span class="number">50</span>: <span class="comment">// Put client response as ServerWebExchange attribute and write response later NettyWriteResponseFilter</span></div><div class="line"><span class="number">51</span>: exchange.getAttributes().put(CLIENT_RESPONSE_ATTR, res);</div><div class="line"><span class="number">52</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">53</span>: &#125;);</div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</p></li><li><p>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><p><code>http://</code> æˆ–è€… <code>https://</code> å‰ç¼€( Scheme ) ã€‚</p></li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 17 è¡Œ ï¼šTODO ã€3025ã€‘ ç›®å‰æš‚ä¸æ”¯æŒ forms å‚æ•°</p></li><li><p>ç¬¬ 22 è‡³ 35 è¡Œ ï¼š<strong>åˆ›å»º</strong>å‘åç«¯æœåŠ¡çš„è¯·æ±‚ã€‚</p><ul><li>ç¬¬ 22 è¡Œ ï¼šè®¾ç½® Method å±æ€§ã€‚</li><li>ç¬¬ 24 è‡³ 27 è¡Œ ï¼šè®¾ç½® Header å±æ€§ã€‚</li><li>ç¬¬ 30 è‡³ 35 è¡Œ ï¼šè®¾ç½® Body å±æ€§ã€‚</li></ul></li><li><p>ç¬¬ 37 è¡Œ ï¼š<strong>å‘èµ·</strong>å‘åç«¯æœåŠ¡çš„è¯·æ±‚ã€‚</p></li><li><p>ç¬¬ 40 è‡³ 53 è¡Œ ï¼š<strong>å¤„ç†</strong>è¿”å›è‡ªåç«¯æœåŠ¡çš„ç›¸åº”ã€‚</p><ul><li>ç¬¬ 43 è¡Œ ï¼šè®¾ç½® <code>response</code> çš„ Header å±æ€§ã€‚</li><li>ç¬¬ 46 è¡Œ ï¼šè®¾ç½® <code>response</code> çš„ Status å±æ€§ã€‚</li><li>ç¬¬ 51 è¡Œ ï¼šè®¾ç½® <code>res</code> åˆ° <code>CLIENT_RESPONSE_ATTR</code> ã€‚åç»­ WebClientWriteResponseFilter å°†å“åº”<strong>å†™å›</strong>ç»™å®¢æˆ·ç«¯ã€‚</li><li>ç¬¬ 52 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</li></ul></li></ul><h1>4. WebClientWriteResponseFilter</h1><p><code>org.springframework.cloud.gateway.filter.WebClientWriteResponseFilter</code> ï¼ŒHttp å›å†™<strong>å“åº”</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_RESPONSE_FILTER_ORDER = -<span class="number">1</span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> WRITE_RESPONSE_FILTER_ORDER;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¿”å›é¡ºåºä¸º <code>-1</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// NOTICE: nothing in "pre" filter stage as CLIENT_RESPONSE_ATTR is not added</span></div><div class="line"> <span class="number">4</span>: <span class="comment">// until the WebHandler is run</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> chain.filter(exchange).then(Mono.defer(() -&gt; &#123;</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— Response</span></div><div class="line"> <span class="number">7</span>: ClientResponse clientResponse = exchange.getAttribute(CLIENT_RESPONSE_ATTR);</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (clientResponse == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: log.trace(<span class="string">"WebClientWriteResponseFilter start"</span>);</div><div class="line"><span class="number">12</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers())).log(<span class="string">"webClient response"</span>);</div><div class="line"><span class="number">15</span>: &#125;));</div><div class="line"><span class="number">16</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>#then(Mono)</code> æ–¹æ³•ï¼Œå®ç° <strong>After Filter</strong> é€»è¾‘ã€‚</li><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šä» <code>CLIENT_RESPONSE_ATTR</code> ä¸­ï¼Œè·å¾— ClientResponse ã€‚</li><li>ç¬¬ 14 è¡Œ ï¼šå°† ClientResponse å†™å›ç»™å®¢æˆ·ç«¯ã€‚</li></ul><h1>5. å’Œ NettyRoutingFilter å¯¹æ¯”</h1><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.7) ä¹‹ NettyRoutingFilterã€‹</a> ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ NettyRoutingFilter / NettyWriteResponseFilter å’Œ WebClientHttpRoutingFilter / WebClientHttpRoutingFilter å®ç°<strong>ä¸€æ ·</strong>çš„åŠŸèƒ½ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å†å®ç°ä¸€æ¬¡å‘¢ï¼Ÿ</p><p>TODO ã€3001ã€‘</p><h1>666. å½©è›‹</h1><p>å‘¼å‘¼ï¼Œä¸»è¦çš„è¿‡æ»¤å™¨å·²ç»å†™å®Œï¼Œåé¢ç†”æ–­ã€é™æµè¿‡æ»¤å™¨çš„å®ç°ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_04_01/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Clou
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.7) ä¹‹ NettyRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/</id>
    <published>2020-03-27T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">2. NettyRoutingFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">3. NettyWriteResponseFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>NettyRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>NettyRoutingFilter ï¼ŒNetty <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>http://</code> æˆ– <code>https://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œä½¿ç”¨åŸºäº Netty å®ç°çš„ HttpClient è¯·æ±‚åç«¯ Http æœåŠ¡ã€‚</p><p>NettyWriteResponseFilter ï¼Œä¸ NettyRoutingFilter <strong>æˆå¯¹ä½¿ç”¨</strong>çš„ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶å°† NettyRoutingFilter è¯·æ±‚åç«¯ Http æœåŠ¡çš„<strong>å“åº”</strong>å†™å›å®¢æˆ·ç«¯ã€‚</p><p>å¤§ä½“æµç¨‹å¦‚ä¸‹ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_28/01.png" alt=""></p><p>å¦å¤–ï¼ŒSpring Cloud Gateway å®ç°äº† WebClientHttpRoutingFilter / WebClientWriteResponseFilter ï¼ŒåŠŸèƒ½ä¸Šå’Œ NettyRoutingFilter / NettyWriteResponseFilter <strong>ç›¸åŒ</strong>ï¼Œå·®åˆ«åœ¨äºåŸºäº <code>org.springframework.cloud.gateway.filter.WebClient</code> å®ç°çš„ HttpClient è¯·æ±‚åç«¯ Http æœåŠ¡ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilterã€‹</a> ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è§£æã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. NettyRoutingFilter</h1><p><code>org.springframework.cloud.gateway.filter.NettyRoutingFilter</code> ï¼ŒNetty <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public class NettyRoutingFilter implements GlobalFilter, Ordered &#123;</div><div class="line"></div><div class="line">private final HttpClient httpClient;</div><div class="line"></div><div class="line">public NettyRoutingFilter(HttpClient httpClient) &#123;</div><div class="line">this.httpClient = httpClient;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>httpClient</code> å±æ€§ï¼ŒåŸºäº <strong>Netty</strong> å®ç°çš„ HttpClient ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¯·æ±‚åç«¯çš„ Http æœåŠ¡</strong>ã€‚</li></ul><hr><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// è·å¾— requestUrl</span></div><div class="line"> <span class="number">4</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"> <span class="number">7</span>: String scheme = requestUrl.getScheme();</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || (!scheme.equals(<span class="string">"http"</span>) &amp;&amp; !scheme.equals(<span class="string">"https"</span>))) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">13</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: ServerHttpRequest request = exchange.getRequest();</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// Request Method</span></div><div class="line"><span class="number">18</span>: <span class="keyword">final</span> HttpMethod method = HttpMethod.valueOf(request.getMethod().toString());</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>: <span class="comment">// è·å¾— url</span></div><div class="line"><span class="number">21</span>: <span class="keyword">final</span> String url = requestUrl.toString();</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="comment">// Request Header</span></div><div class="line"><span class="number">24</span>: <span class="keyword">final</span> DefaultHttpHeaders httpHeaders = <span class="keyword">new</span> DefaultHttpHeaders();</div><div class="line"><span class="number">25</span>: request.getHeaders().forEach(httpHeaders::set);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">// è¯·æ±‚</span></div><div class="line"><span class="number">28</span>: <span class="keyword">return</span> <span class="keyword">this</span>.httpClient.request(method, url, req -&gt; &#123;</div><div class="line"><span class="number">29</span>: <span class="keyword">final</span> HttpClientRequest proxyRequest = req.options(NettyPipeline.SendOptions::flushOnEach)</div><div class="line"><span class="number">30</span>: .failOnClientError(<span class="keyword">false</span>) <span class="comment">// // æ˜¯å¦è¯·æ±‚å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></div><div class="line"><span class="number">31</span>: .headers(httpHeaders);</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>: <span class="comment">// Request Form</span></div><div class="line"><span class="number">34</span>: <span class="keyword">if</span> (MediaType.APPLICATION_FORM_URLENCODED.includes(request.getHeaders().getContentType())) &#123;</div><div class="line"><span class="number">35</span>: <span class="keyword">return</span> exchange.getFormData()</div><div class="line"><span class="number">36</span>: .flatMap(map -&gt; proxyRequest.sendForm(form -&gt; &#123;</div><div class="line"><span class="number">37</span>: <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; entry: map.entrySet()) &#123;</div><div class="line"><span class="number">38</span>: <span class="keyword">for</span> (String value : entry.getValue()) &#123;</div><div class="line"><span class="number">39</span>: form.attr(entry.getKey(), value);</div><div class="line"><span class="number">40</span>: &#125;</div><div class="line"><span class="number">41</span>: &#125;</div><div class="line"><span class="number">42</span>: &#125;).then())</div><div class="line"><span class="number">43</span>: .then(chain.filter(exchange));</div><div class="line"><span class="number">44</span>: &#125;</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>: <span class="comment">// Request Body</span></div><div class="line"><span class="number">47</span>: <span class="keyword">return</span> proxyRequest.sendHeaders() <span class="comment">//I shouldn't need this</span></div><div class="line"><span class="number">48</span>: .send(request.getBody()</div><div class="line"><span class="number">49</span>: .map(DataBuffer::asByteBuffer) <span class="comment">// Flux&lt;DataBuffer&gt; =&gt; ByteBuffer</span></div><div class="line"><span class="number">50</span>: .map(Unpooled::wrappedBuffer)); <span class="comment">// ByteBuffer =&gt; Flux&lt;DataBuffer&gt;</span></div><div class="line"><span class="number">51</span>: &#125;).doOnNext(res -&gt; &#123;</div><div class="line"><span class="number">52</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">53</span>: <span class="comment">// Response Header</span></div><div class="line"><span class="number">54</span>: <span class="comment">// put headers and status so filters can modify the response</span></div><div class="line"><span class="number">55</span>: HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</div><div class="line"><span class="number">56</span>: res.responseHeaders().forEach(entry -&gt; headers.add(entry.getKey(), entry.getValue()));</div><div class="line"><span class="number">57</span>: response.getHeaders().putAll(headers);</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>: <span class="comment">// Response Status</span></div><div class="line"><span class="number">60</span>: response.setStatusCode(HttpStatus.valueOf(res.status().code()));</div><div class="line"><span class="number">61</span>: </div><div class="line"><span class="number">62</span>: <span class="comment">// è®¾ç½® Response åˆ° CLIENT_RESPONSE_ATTR</span></div><div class="line"><span class="number">63</span>: <span class="comment">// Defer committing the response until all route filters have run</span></div><div class="line"><span class="number">64</span>: <span class="comment">// Put client response as ServerWebExchange attribute and write response later NettyWriteResponseFilter</span></div><div class="line"><span class="number">65</span>: exchange.getAttributes().put(CLIENT_RESPONSE_ATTR, res);</div><div class="line"><span class="number">66</span>: &#125;).then(chain.filter(exchange));</div><div class="line"><span class="number">67</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</p></li><li><p>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><p><code>http://</code> æˆ–è€… <code>https://</code> å‰ç¼€( Scheme ) ã€‚</p></li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 18 è¡Œ ï¼šåˆ›å»º <strong>Netty Request Method</strong> å¯¹è±¡ã€‚<code>request#getMethod()</code> è¿”å›çš„ä¸æ˜¯ <code>io.netty.handler.codec.http.HttpMethod</code> ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè½¬æ¢ã€‚</p></li><li><p>ç¬¬ 21 è¡Œ ï¼šè·å¾— <code>url</code> ã€‚</p></li><li><p>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º  <strong>Netty Request Header</strong> å¯¹è±¡( <code>io.netty.handler.codec.http.DefaultHttpHeaders</code> )ï¼Œå°†è¯·æ±‚çš„ Header è®¾ç½®ç»™å®ƒã€‚</p></li><li><p>--------- ç¬¬ 28 è‡³ 50 è¡Œ ï¼šè°ƒç”¨ <code>HttpClient#request(HttpMethod, String, Function)</code> æ–¹æ³•ï¼Œè¯·æ±‚åç«¯ Http æœåŠ¡ã€‚</p></li><li><p>ç¬¬ 29 è‡³ 31 è¡Œ ï¼šåˆ›å»º <strong>Netty Request</strong> å¯¹è±¡( <code>reactor.ipc.netty.http.client.HttpClientRequest</code> )ã€‚</p><ul><li><p>ç¬¬ 29 è¡Œ ï¼šTODO ã€3024ã€‘ NettyPipeline.SendOptions::flushOnEach</p></li><li><p>ç¬¬ 30 è¡Œ ï¼šè®¾ç½®è¯·æ±‚å¤±è´¥( åç«¯æœåŠ¡è¿”å›å“åº”çŠ¶ä½“ç  <code>&gt;= 400</code> )æ—¶ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HttpClientOperations#checkResponseCode(HttpResponse response)</span></div><div class="line"><span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (code &gt;= <span class="number">400</span>) &#123;</div><div class="line"><span class="keyword">if</span> (clientError) &#123;</div><div class="line"><span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">log.debug(<span class="string">"&#123;&#125; Received Request Error, stop reading: &#123;&#125;"</span>,</div><div class="line">channel(),</div><div class="line">response.toString());</div><div class="line">&#125;</div><div class="line">Exception ex = <span class="keyword">new</span> HttpClientException(uri(), response);</div><div class="line">parentContext().fireContextError(ex);</div><div class="line">receive().subscribe();</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>é€šè¿‡è®¾ç½® <code>clientError = false</code> ï¼Œç¬¬ 51 è¡Œå¯ä»¥è°ƒç”¨ <code>Mono#doNext(Consumer)</code> æ–¹æ³•ï¼Œ<strong>ç»Ÿä¸€è®¢é˜…å¤„ç†</strong>è¿”å›çš„ <code>reactor.ipc.netty.http.client.HttpClientResponse</code> å¯¹è±¡ã€‚</li></ul></li><li><p>ç¬¬ 31 è¡Œ ï¼šè®¾ç½® <strong>Netty Request</strong> å¯¹è±¡çš„ Header ã€‚</p></li></ul></li><li><p>ç¬¬ 34 è‡³ 44 è¡Œ ï¼šã€TODO 3025ã€‘ç›®å‰æ˜¯ä¸€ä¸ª BUG ï¼Œåœ¨ 2.0.X ç‰ˆæœ¬ä¿®å¤ã€‚è§ <a href="FormIntegrationTests">FormIntegrationTests#formUrlencodedWorks()</a> å•å…ƒæµ‹è¯•çš„æ³¨é‡Šè¯´æ˜ã€‚</p></li><li><p>ç¬¬ 47 è‡³ 50 è¡Œ ï¼šè¯·æ±‚åç«¯çš„ Http æœåŠ¡ã€‚</p><ul><li>ç¬¬ 47 è¡Œ ï¼šå‘é€è¯·æ±‚ Header ã€‚</li><li>ç¬¬ 48 è‡³ 50 è¡Œ ï¼šå‘é€è¯·æ±‚ Body ã€‚å…¶ä¸­ä¸­é—´çš„ <code>#map(...)</code> çš„è¿‡ç¨‹ä¸º <code>Flux&lt;DataBuffer&gt; =&gt; ByteBuffer =&gt; Flux&lt;DataBuffer&gt;</code> ã€‚</li></ul></li><li><p>--------- ç¬¬ 51 è‡³ 65 è¡Œ ï¼šè¯·æ±‚åç«¯ Http æœåŠ¡<strong>å®Œæˆ</strong>ï¼Œå°† <strong>Netty Response</strong> èµ‹å€¼ç»™å“åº” <code>response</code> ã€‚</p></li><li><p>ç¬¬ 53 è‡³ 57 è¡Œ ï¼šåˆ›å»º <code>org.springframework.http.HttpHeaders</code> å¯¹è±¡ï¼Œå°† <strong>Netty Response Header</strong> è®¾ç½®ç»™å®ƒï¼Œè€Œåè®¾ç½®å›ç»™å“åº” <code>response</code> ã€‚</p></li><li><p>ç¬¬ 60 è¡Œ ï¼šè®¾ç½®å“åº” <code>response</code> çš„çŠ¶æ€ç ã€‚</p></li><li><p>ç¬¬ 65 è¡Œ ï¼šè®¾ç½® <strong>Netty Response</strong> åˆ° <code>CLIENT_RESPONSE_ATTR</code> ã€‚åç»­ NettyWriteResponseFilter å°† <strong>Netty Response</strong> å†™å›ç»™å®¢æˆ·ç«¯ã€‚</p></li><li><p>--------- ç¬¬ 66 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚</p></li></ul><h1>3. NettyWriteResponseFilter</h1><p><code>org.springframework.cloud.gateway.filter.NettyWriteResponseFilter</code> ï¼ŒNetty å›å†™<strong>å“åº”</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_RESPONSE_FILTER_ORDER = -<span class="number">1</span>;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> WRITE_RESPONSE_FILTER_ORDER;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¿”å›é¡ºåºä¸º <code>-1</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// NOTICE: nothing in "pre" filter stage as CLIENT_RESPONSE_ATTR is not added</span></div><div class="line"> <span class="number">4</span>: <span class="comment">// until the WebHandler is run</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">return</span> chain.filter(exchange).then(Mono.defer(() -&gt; &#123;</div><div class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— Response</span></div><div class="line"> <span class="number">7</span>: HttpClientResponse clientResponse = exchange.getAttribute(CLIENT_RESPONSE_ATTR);</div><div class="line"> <span class="number">8</span>: <span class="comment">// HttpClientResponse clientResponse = getAttribute(exchange, CLIENT_RESPONSE_ATTR, HttpClientResponse.class);</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">if</span> (clientResponse == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>: <span class="keyword">return</span> Mono.empty();</div><div class="line"><span class="number">11</span>: &#125;</div><div class="line"><span class="number">12</span>: log.trace(<span class="string">"NettyWriteResponseFilter start"</span>);</div><div class="line"><span class="number">13</span>: ServerHttpResponse response = exchange.getResponse();</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="comment">// å°† Netty Response å†™å›ç»™å®¢æˆ·ç«¯ã€‚</span></div><div class="line"><span class="number">16</span>: NettyDataBufferFactory factory = (NettyDataBufferFactory) response.bufferFactory();</div><div class="line"><span class="number">17</span>: <span class="comment">//<span class="doctag">TODO:</span> what if it's not netty</span></div><div class="line"><span class="number">18</span>: <span class="keyword">final</span> Flux&lt;NettyDataBuffer&gt; body = clientResponse.receive()</div><div class="line"><span class="number">19</span>: .retain() <span class="comment">// ByteBufFlux =&gt; ByteBufFlux</span></div><div class="line"><span class="number">20</span>: .map(factory::wrap); <span class="comment">// ByteBufFlux  =&gt; Flux&lt;NettyDataBuffer&gt;</span></div><div class="line"><span class="number">21</span>: <span class="keyword">return</span> response.writeWith(body);</div><div class="line"><span class="number">22</span>: &#125;));</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 5 è¡Œ ï¼šè°ƒç”¨ <code>#then(Mono)</code> æ–¹æ³•ï¼Œå®ç° <strong>After Filter</strong> é€»è¾‘ã€‚</li><li>ç¬¬ 7 è‡³ 11 è¡Œ ï¼šä» <code>CLIENT_RESPONSE_ATTR</code> ä¸­ï¼Œè·å¾— <strong>Netty Response</strong> ã€‚</li><li>ç¬¬ 15 è‡³ 21 è¡Œ ï¼šå°† <strong>Netty Response</strong> å†™å›ç»™å®¢æˆ·ç«¯ã€‚å› ä¸º <code>org.springframework.http.server.reactive#writeWith(Publisher&lt;? extends DataBuffer&gt;)</code> éœ€è¦çš„å‚æ•°ç±»å‹æ˜¯ <code>Publisher&lt;? extends DataBuffer&gt;</code> ï¼Œæ‰€ä»¥ã€ç¬¬ 18 è‡³ 20 è¡Œã€‘çš„è½¬æ¢è¿‡ç¨‹æ˜¯ <code>ByteBufFlux =&gt; Flux&lt;NettyDataBuffer&gt;</code> ã€‚<ul><li>ç¬¬ 19 è¡Œ ï¼šTODO ã€3024ã€‘ByteBufFlux#retain()</li></ul></li></ul><h1>666. å½©è›‹</h1><p>ä¸‹ä¸€ç¯‡ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-web-client-http-routing">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.8) ä¹‹ WebClientHttpRoutingFilterã€‹</a> èµ°èµ·ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_28/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-netty-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.6) ä¹‹ WebSocketRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/</id>
    <published>2020-03-24T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">3. WebsocketRoutingFilter</a><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">3.1 ProxyWebSocketHandler</a></li></ul></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>WebsocketRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>WebsocketRoutingFilter ï¼ŒWebsocket <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>ws://</code> / <code>wss://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œ<strong>ä»£ç†åç«¯ Websocket æœåŠ¡</strong>ï¼Œæä¾›ç»™å®¢æˆ·ç«¯è¿æ¥ã€‚å¦‚ä¸‹å›¾ ï¼š</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_25/01.png" alt=""></p><ul><li>ç›®å‰<strong>ä¸€ä¸ª</strong> RouteDefinition åªèƒ½æŒ‡å®š<strong>ä¸€ä¸ª</strong>åç«¯ WebSocket æœåŠ¡ã€‚å®˜æ–¹æ­£åœ¨è®¡åˆ’åœ¨ LoadBalancerClientFilter ä¸Šå®ç° Websocket çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ä¹Ÿå°±è¯´ï¼Œæœªæ¥<strong>ä¸€ä¸ª</strong> RouteDefinition èƒ½å¤ŸæŒ‡å®š<strong>å¤šä¸ª</strong>åç«¯ WebSocket æœåŠ¡ã€‚</li></ul><p>Websocket çš„ RouteDefinition é…ç½®å¦‚ä¸‹ ï¼š</p><p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">websocket_test</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">ws://localhost:9000</span></div><div class="line"><span class="attr">        order:</span> <span class="number">8000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/echo</span></div></pre></td></tr></table></figure></p><ul><li><code>uri</code> ä½¿ç”¨ <code>ws://</code> æˆ–è€… <code>wss://</code> ä¸ºå‰ç¼€ã€‚</li></ul><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ç¯å¢ƒæ­å»º</h1><p>åœ¨è§£ææºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»¥ <a href="https://github.com/websockets/wscat" rel="external nofollow noopener noreferrer" target="_blank">wscat</a>  æ­å»ºä¸€ä¸ª WebSocket æœåŠ¡ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œå®‰è£… wscat ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">npm install -g wscat</div></pre></td></tr></table></figure></p><p>ç¬¬äºŒæ­¥ï¼Œå¯åŠ¨ wscat ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wscat --listen 9000</div></pre></td></tr></table></figure></p><p>ç¬¬ä¸‰æ­¥ï¼Œè¿æ¥ wscat ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wscat --listen 9000</div></pre></td></tr></table></figure></p><p>ç¬¬å››æ­¥ï¼Œé…ç½® RouteDefinition ï¼Œå¹¶å¯åŠ¨ Spring Cloud Gateway ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cloud:</div><div class="line">    gateway:</div><div class="line">      routes:</div><div class="line">      - id: websocket_test</div><div class="line">        uri: ws://localhost:9000</div><div class="line">        order: 8000</div><div class="line">        predicates:</div><div class="line">        - Path=/echo</div></pre></td></tr></table></figure></p><p>ç¬¬äº”æ­¥ï¼Œé€šè¿‡ Gateway è¿æ¥ wscat ã€‚</p><p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">wscat --connect ws://localhost:8080/echo</div></pre></td></tr></table></figure></p><p>å¤§åŠŸå‘Šæˆã€‚</p><p>æ³¨æ„ï¼Œwscat åŒä¸€æ—¶é—´ä»…å…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚</p><h1>3. WebsocketRoutingFilter</h1><p><code>org.springframework.cloud.gateway.filter.WebsocketRoutingFilter</code> ï¼ŒWebsocket <strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketRoutingFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEC_WEBSOCKET_PROTOCOL = <span class="string">"Sec-WebSocket-Protocol"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebSocketClient webSocketClient;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebSocketService webSocketService;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebsocketRoutingFilter</span><span class="params">(WebSocketClient webSocketClient)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>(webSocketClient, <span class="keyword">new</span> HandshakeWebSocketService());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebsocketRoutingFilter</span><span class="params">(WebSocketClient webSocketClient,</span></span></div><div class="line"><span class="function"><span class="params">WebSocketService webSocketService)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.webSocketClient = webSocketClient;</div><div class="line"><span class="keyword">this</span>.webSocketService = webSocketService;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li><code>webSocketClient</code> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/init/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³åˆå§‹åŒ–ã€‹ã€Œ5.2 åˆå§‹åŒ– NettyConfigurationã€</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>org.springframework.web.reactive.socket.client.ReactorNettyWebSocketClient</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¿æ¥åç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡</strong>ã€‚</li><li><code>webSocketService</code> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/init/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³åˆå§‹åŒ–ã€‹ã€Œ5.3 åˆå§‹åŒ– GlobalFilterã€</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>org.springframework.web.reactive.socket.server.support.HandshakeWebSocketService</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚( Handshake Request ) ã€‚</li></ul><hr><p><code>#getOrder()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>è¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</li></ul><hr><p><code>#filter(ServerWebExchange, GatewayFilterChain)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// è·å¾— requestUrl</span></div><div class="line"> <span class="number">4</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"> <span class="number">7</span>: String scheme = requestUrl.getScheme();</div><div class="line"> <span class="number">8</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || (!scheme.equals(<span class="string">"ws"</span>) &amp;&amp; !scheme.equals(<span class="string">"wss"</span>))) &#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">13</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>: <span class="comment">// å¤„ç†è¿æ¥è¯·æ±‚</span></div><div class="line"><span class="number">16</span>: <span class="keyword">return</span> <span class="keyword">this</span>.webSocketService.handleRequest(exchange,</div><div class="line"><span class="number">17</span>: <span class="keyword">new</span> ProxyWebSocketHandler(requestUrl, <span class="keyword">this</span>.webSocketClient, exchange.getRequest().getHeaders()));</div><div class="line"><span class="number">18</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</p></li><li><p>ç¬¬ 7 è‡³ 10 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><p><code>ws://</code> æˆ–è€… <code>wss://</code> å‰ç¼€( Scheme ) ã€‚</p></li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 13 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 15 è‡³ 16 è¡Œ ï¼šè°ƒç”¨ <code>WebSocketService#hanldeRequest(ServerWebExchange, WebSocketHandler)</code> æ–¹æ³•ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚( Handshake Request ) ã€‚è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸åœ¨æœ¬æ–‡èŒƒå›´å†…ï¼Œä½†æ˜¯è‰¯å¿ƒå¦‚ç¬”è€…ï¼Œå¤§æ¦‚è®²ä¸‹æ¶‰åŠåˆ°çš„ç±» ï¼š</p><ul><li>ä¸»è¦é€»è¾‘åœ¨ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-webflux/src/main/java/org/springframework/web/reactive/socket/server/upgrade/ReactorNettyRequestUpgradeStrategy.java#L50" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.web.reactive.socket.server.upgrade.ReactorNettyRequestUpgradeStrategy</code></a> ç±»é‡Œã€‚</li><li>ã€ç¬¬ä¸€æ­¥ã€‘ ReactorNettyRequestUpgradeStrategy è°ƒç”¨ <a href="https://github.com/reactor/reactor-netty/blob/master/src/main/java/reactor/ipc/netty/http/server/HttpServerWSOperations.java" rel="external nofollow noopener noreferrer" target="_blank"><code>reactor.ipc.netty.http.server.HttpServerWSOperations</code></a> ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚ã€‚å¤„ç†æˆåŠŸï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯è¿æ¥æˆåŠŸã€‚</li><li>ã€ç¬¬äºŒæ­¥ã€‘ReactorNettyRequestUpgradeStrategy è°ƒç”¨ <a href="https://github.com/spring-projects/spring-framework/blob/8f69b5ff23d6835eee89a26c0e1e3e63a64a21a0/spring-webflux/src/main/java/org/springframework/web/reactive/socket/WebSocketHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.web.reactive.socket.server.upgrade.ReactorNettyRequestUpgradeStrategy</code></a> <strong>æ¥å£</strong>çš„ <code>#handle(WebSocketSession)</code> æ–¹æ³•ï¼Œå¤„ç†å®¢æˆ·ç«¯ WebSocket Session ã€‚ProxyWebSocketHandler æ˜¯ WebSocketHandler çš„<strong>å®ç°ç±»</strong>ï¼Œåœ¨ <a href="#">ã€Œ3.1 ProxyWebSocketHandlerã€</a> æ¥è¯¦ç»†è§£æ <code>#handle(WebSocketSession)</code> å®ç°äº†ä»€ä¹ˆé€»è¾‘ã€‚</li></ul></li></ul><h2>3.1 ProxyWebSocketHandler</h2><p><code>org.springframework.cloud.gateway.filter.WebsocketRoutingFilter.ProxyWebSocketHandler</code> ï¼Œ<strong>ä»£ç†</strong>åç«¯ WebSocket æœåŠ¡å¤„ç†å™¨ã€‚</p><p><strong>æ„é€ æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyWebSocketHandler</span> <span class="keyword">implements</span> <span class="title">WebSocketHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">final</span> WebSocketClient client;</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> URI url;</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> HttpHeaders headers;</div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; subProtocols;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">ProxyWebSocketHandler</span><span class="params">(URI url, WebSocketClient client, HttpHeaders headers)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">this</span>.client = client;</div><div class="line"><span class="number">10</span>: <span class="keyword">this</span>.url = url;</div><div class="line"><span class="number">11</span>: <span class="keyword">this</span>.headers = <span class="keyword">new</span> HttpHeaders();<span class="comment">//headers;</span></div><div class="line"><span class="number">12</span>: <span class="comment">//<span class="doctag">TODO:</span> better strategy to filter these headers?</span></div><div class="line"><span class="number">13</span>: headers.entrySet().forEach(header -&gt; &#123;</div><div class="line"><span class="number">14</span>: <span class="keyword">if</span> (!header.getKey().toLowerCase().startsWith(<span class="string">"sec-websocket"</span>)</div><div class="line"><span class="number">15</span>: &amp;&amp; !header.getKey().equalsIgnoreCase(<span class="string">"upgrade"</span>)</div><div class="line"><span class="number">16</span>: &amp;&amp; !header.getKey().equalsIgnoreCase(<span class="string">"connection"</span>)) &#123;</div><div class="line"><span class="number">17</span>: <span class="keyword">this</span>.headers.addAll(header.getKey(), header.getValue());</div><div class="line"><span class="number">18</span>: &#125;</div><div class="line"><span class="number">19</span>: &#125;);</div><div class="line"><span class="number">20</span>: List&lt;String&gt; protocols = headers.get(SEC_WEBSOCKET_PROTOCOL);</div><div class="line"><span class="number">21</span>: <span class="keyword">if</span> (protocols != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>: <span class="keyword">this</span>.subProtocols = protocols;</div><div class="line"><span class="number">23</span>: &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">24</span>: <span class="keyword">this</span>.subProtocols = Collections.emptyList();</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><code>client</code> å±æ€§ï¼Œåœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/init/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” ç½‘å…³åˆå§‹åŒ–ã€‹ã€Œ5.2 åˆå§‹åŒ– NettyConfigurationã€</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>org.springframework.web.reactive.socket.client.ReactorNettyWebSocketClient</code> å®ç°ç±»ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œ<strong>è¿æ¥åç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡</strong>ã€‚</li><li><code>url</code> å±æ€§ï¼Œåç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡çš„åœ°å€ã€‚</li><li><code>header</code> å±æ€§ï¼Œè¯·æ±‚å¤´ï¼Œåœ¨ <a href="http://blog.csdn.net/baiye_xing/article/details/73938360" rel="external nofollow noopener noreferrer" target="_blank">ã€Š ã€è®¡ç½‘ã€‘HTTPä¸WebSocketçš„åŒºåˆ«ã€‹</a> æœ‰è¯¦ç»†è§£æï¼ŒåŒ…æ‹¬ä¸ºä»€ä¹ˆã€ç¬¬ 14 è‡³ 18 è¡Œã€‘çš„ä»£ç è¿™æ ·å¤„ç†ã€‚</li><li><code>subProtocols</code> å±æ€§ï¼Œæœ€ç»ˆé€šä¿¡ä½¿ç”¨çš„åè®®ã€‚</li></ul><hr><p><code>#handle(WebSocketSession)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(WebSocketSession session)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>: <span class="comment">// pass headers along so custom headers can be sent through</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">return</span> client.execute(url, <span class="keyword">this</span>.headers, <span class="keyword">new</span> WebSocketHandler() &#123;</div><div class="line"> <span class="number">5</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(WebSocketSession proxySession)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>: <span class="comment">// Use retain() for Reactor Netty</span></div><div class="line"> <span class="number">8</span>: <span class="comment">// è½¬å‘æ¶ˆæ¯ å®¢æˆ·ç«¯ =ã€‹åç«¯æœåŠ¡</span></div><div class="line"> <span class="number">9</span>: Mono&lt;Void&gt; proxySessionSend = proxySession</div><div class="line"><span class="number">10</span>: .send(session.receive().doOnNext(WebSocketMessage::retain));</div><div class="line"><span class="number">11</span>: <span class="comment">// è½¬å‘æ¶ˆæ¯ åç«¯æœåŠ¡=ã€‹å®¢æˆ·ç«¯</span></div><div class="line"><span class="number">12</span>: <span class="comment">// .log("proxySessionSend", Level.FINE);</span></div><div class="line"><span class="number">13</span>: Mono&lt;Void&gt; serverSessionSend = session</div><div class="line"><span class="number">14</span>: .send(proxySession.receive().doOnNext(WebSocketMessage::retain));</div><div class="line"><span class="number">15</span>: <span class="comment">// .log("sessionSend", Level.FINE);</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="comment">// </span></div><div class="line"><span class="number">18</span>: <span class="keyword">return</span> Mono.when(proxySessionSend, serverSessionSend).then();</div><div class="line"><span class="number">19</span>: &#125;</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">22:  * Copy subProtocols so they are available downstream.</span></div><div class="line"><span class="comment">23:  * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">24:  */</span></div><div class="line"><span class="number">25</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">26</span>: <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getSubProtocols</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">27</span>: <span class="keyword">return</span> ProxyWebSocketHandler.<span class="keyword">this</span>.subProtocols;</div><div class="line"><span class="number">28</span>: &#125;</div><div class="line"><span class="number">29</span>: &#125;);</div><div class="line"><span class="number">30</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>WebSocketClient#execute(URI, HttpHeaders, WebSocketHandler)</code> æ–¹æ³•ï¼Œ<strong>è¿æ¥åç«¯ã€è¢«ä»£ç†ã€‘çš„ WebSocket æœåŠ¡</strong>ã€‚è¿æ¥æˆåŠŸåï¼Œå›è°ƒ WebSocketHandler å®ç°çš„å†…éƒ¨ç±»çš„ <code>#handle(WebSocketSession)</code> æ–¹æ³•ã€‚</li><li>WebSocketHandler å®ç°çš„å†…éƒ¨ç±»<ul><li>ç¬¬ 9 è‡³ 10 è¡Œ ï¼šè½¬å‘æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯ <code>=&gt;</code> åç«¯æœåŠ¡ã€‚</li><li>ç¬¬ 13 è‡³ 14 è¡Œ ï¼šè½¬å‘æ¶ˆæ¯ï¼Œåç«¯æœåŠ¡ <code>=&gt;</code> å®¢æˆ·ç«¯ã€‚</li><li>ç¬¬ 18 è¡Œ ï¼šè°ƒç”¨ <code>Mono#when()</code> æ–¹æ³•ï¼Œåˆå¹¶ <code>proxySessionSend</code> / <code>serverSessionSend</code> ä¸¤ä¸ª Mono ã€‚è°ƒç”¨ <code>Mono#then()</code> æ–¹æ³•ï¼Œ<strong>å‚æ•°ä¸ºç©º</strong>ï¼Œåˆå¹¶çš„ Mono ä¸å‘å°„æ•°æ®å‡ºæ¥ã€‚RxJava å’Œ Reactor ç±»ä¼¼ï¼Œå¯ä»¥å‚è€ƒ <a href="https://mcxiaoke.gitbooks.io/rxdocs/content/operators/And.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ â€”â€” And/Then/Whenã€‹</a> å­¦ä¹ ä¸‹ <code>when / and / then</code> æ“ä½œç¬¦ã€‚</li><li>ä¸‹å›¾å¯ä»¥å¸®åŠ©ç†è§£ä¸‹è¿™ä¸ªç±»çš„ç”¨é€” ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_25/01.png" alt=""></li></ul></li></ul><h1>666. å½©è›‹</h1><p>ğŸ˜ˆ é™äºå¯¹ Reactor å’Œ Netty äº†è§£ä¸å¤Ÿæ·±å…¥ï¼Œå†™çš„ä¸å¤Ÿé€å½»ã€‚å›å¤´æ·±å…¥ç†è§£ä¸‹å®ƒä»¬ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_25/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-websocket-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gate
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.5) ä¹‹ ForwardRoutingFilter</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/</id>
    <published>2020-03-19T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">2. RouteToRequestUrlFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>ForwardRoutingFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>RouteToRequestUrlFilter ï¼Œè½¬å‘<strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ã€‚å…¶æ ¹æ® <code>forward://</code> å‰ç¼€( Scheme )è¿‡æ»¤å¤„ç†ï¼Œ<strong>å°†è¯·æ±‚è½¬å‘åˆ°å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œé…ç½® RouteDefinition è·¯ç”±å®šä¹‰å¦‚ä¸‹ ï¼š</p><p><figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">juejin-gateway</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line">      <span class="comment"># =====================================</span></div><div class="line"><span class="attr">      - id:</span> <span class="string">forward_sample</span></div><div class="line"><span class="attr">        uri:</span> <span class="attr">forward:///globalfilters</span></div><div class="line"><span class="attr">        order:</span> <span class="number">10000</span></div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">Path=/globalfilters</span></div><div class="line"><span class="attr">        filters:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">PrefixPath=/application/gateway</span></div></pre></td></tr></table></figure></p><ul><li>æˆ‘ä»¬å‡å®šç½‘å…³ç«¯å£ä¸º <code>8080</code> ã€‚</li><li>å½“è¯·æ±‚ <code>http://127.0.0.1:8080/globalfilters</code> æ¥å£ï¼ŒSpring Cloud Gateway å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ ï¼š<ul><li>åŒ¹é…åˆ°è·¯ç”± Route (<code>id = forward_sample</code>) ã€‚</li><li><strong>é…ç½®</strong>çš„ PrefixPathGatewayFilterFactory å°†è¯·æ±‚<strong>æ”¹å†™</strong>æˆ <code>http://127.0.0.1:8080/application/gateway/globalfilters</code> ã€‚</li><li>ForwardRoutingFilter åˆ¤æ–­æœ‰ <code>forward://</code> å‰ç¼€( Scheme )ï¼Œè¿‡æ»¤å¤„ç†ï¼Œå°†è¯·æ±‚<strong>è½¬å‘</strong>ç»™ DispatcherHandler ã€‚</li><li>DispatcherHandler åŒ¹é…å¹¶è½¬å‘åˆ°<strong>å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</strong> <a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/83496b78944269050373bb92bb2181e1b7c070e8/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/actuate/GatewayWebfluxEndpoint.java#L96" rel="external nofollow noopener noreferrer" target="_blank"><code>application/gateway/globalfilters</code></a> ã€‚</li></ul></li><li>ä¸ºä»€ä¹ˆéœ€è¦é…ç½® PrefixPathGatewayFilterFactory ï¼Ÿéœ€è¦é€šè¿‡ PrefixPathGatewayFilterFactory å°†è¯·æ±‚é‡å†™è·¯å¾„ï¼Œä»¥åŒ¹é…æœ¬åœ° API ï¼Œå¦åˆ™ DispatcherHandler è½¬å‘ä¼šå¤±è´¥ã€‚</li></ul><p>å¦å¤–ï¼ŒRouteToRequestUrlFilter æ˜¯ Spring Cloud Gateway å®ç°çš„ä¸€ç§<strong>è·¯ç”±</strong>ç½‘å…³è¿‡æ»¤å™¨ï¼Œç›®å‰è¿˜æä¾› WebsocketRoutingFilter / NettyRoutingFilter / WebClientHttpRoutingFilter ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. RouteToRequestUrlFilter</h1><p><code>org.springframework.cloud.gateway.filter.ForwardRoutingFilter</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardRoutingFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(ForwardRoutingFilter.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> DispatcherHandler dispatcherHandler;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="title">ForwardRoutingFilter</span><span class="params">(DispatcherHandler dispatcherHandler)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>: <span class="keyword">this</span>.dispatcherHandler = dispatcherHandler;</div><div class="line"> <span class="number">9</span>: &#125;</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">13</span>: <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line"><span class="number">14</span>: &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"><span class="number">18</span>:     <span class="comment">// è·å¾— requestUrl</span></div><div class="line"><span class="number">19</span>: URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"><span class="number">20</span>: </div><div class="line"><span class="number">21</span>: <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤„ç†</span></div><div class="line"><span class="number">22</span>: String scheme = requestUrl.getScheme();</div><div class="line"><span class="number">23</span>: <span class="keyword">if</span> (isAlreadyRouted(exchange) || !scheme.equals(<span class="string">"forward"</span>)) &#123;</div><div class="line"><span class="number">24</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">25</span>: &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">// è®¾ç½®å·²ç»è·¯ç”±</span></div><div class="line"><span class="number">28</span>: setAlreadyRouted(exchange);</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">//<span class="doctag">TODO:</span> translate url?</span></div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>: <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line"><span class="number">33</span>: log.trace(<span class="string">"Forwarding to URI: "</span>+requestUrl);</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">// DispatcherHandler åŒ¹é…å¹¶è½¬å‘åˆ°å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</span></div><div class="line"><span class="number">37</span>: <span class="keyword">return</span> <span class="keyword">this</span>.dispatcherHandler.handle(exchange);</div><div class="line"><span class="number">38</span>: &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>å®ç° <strong>GlobalFilter</strong> æ¥å£ã€‚</p></li><li><p><code>#getOrder()</code> æ–¹æ³•ï¼Œè¿”å›é¡ºåºä¸º <code>Integer.MAX_VALUE</code> ã€‚åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-intro/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.1) ä¹‹ GatewayFilter ä¸€è§ˆã€‹ã€Œ3. GlobalFilterã€</a> ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†æ‰€æœ‰ GlobalFilter çš„é¡ºåºã€‚</p></li><li><p>ç¬¬ 19 è¡Œ ï¼šè·å¾— <code>requestUrl</code> ã€‚</p></li><li><p>ç¬¬ 22 è‡³ 25 è¡Œ ï¼šåˆ¤æ–­ ForwardRoutingFilter æ˜¯å¦èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ ï¼š</p><ul><li><p><code>forward://</code> å‰ç¼€( Scheme ) ã€‚</p></li><li><p>è°ƒç”¨ <code>ServerWebExchangeUtils#isAlreadyRouted(ServerWebExchange)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æš‚æœªè¢«å…¶ä»– Routing ç½‘å…³å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> exchange.getAttributeOrDefault(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>x</li></ul></li></ul></li><li><p>ç¬¬ 28 è¡Œ ï¼šè®¾ç½®è¯¥è¯·æ±‚å·²ç»è¢«å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlreadyRouted</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    exchange.getAttributes().put(GATEWAY_ALREADY_ROUTED_ATTR, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p></li><li><p>ç¬¬ 37 è¡Œ ï¼šå°†è¯·æ±‚<strong>è½¬å‘</strong>ç»™ DispatcherHandler ã€‚DispatcherHandler åŒ¹é…å¹¶è½¬å‘åˆ°<strong>å½“å‰ç½‘å…³å®ä¾‹æœ¬åœ°æ¥å£</strong>ã€‚</p></li></ul><h1>666. å½©è›‹</h1><p>ä¸€å¼€å§‹æƒ³é”™äº† ForwardRoutingFilter äº†çš„ç”¨é€”ï¼Œè°ƒè¯•è®¸ä¹…ï¼Œåé¢çœ‹äº†å®˜æ–¹æä¾›çš„ç¤ºä¾‹ <code>org.springframework.cloud.gateway.test.ForwardTests</code> ï¼Œè±ç„¶å¼€æœ—ã€‚</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_20/01.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-forward-routing/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gatewa
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.4) ä¹‹ LoadBalancerClientFilter è´Ÿè½½å‡è¡¡</title>
    <link href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/"/>
    <id>http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/</id>
    <published>2020-03-14T16:00:00.000Z</published>
    <updated>2017-12-01T16:41:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-Gateway 2.0.X M4</strong></p><ul><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">2. ç¯å¢ƒæ­å»º</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">3. LoadBalancerClientFilter</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">4. é«˜èƒ½</a></li><li><a href="http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>LoadBalancerClientFilter çš„ä»£ç å®ç°</strong>ã€‚</p><p>LoadBalancerClientFilter æ ¹æ® <code>lb://</code> å‰ç¼€è¿‡æ»¤å¤„ç†ï¼Œä½¿ç”¨ <code>serviceId</code> é€‰æ‹©<strong>ä¸€ä¸ª</strong>æœåŠ¡å®ä¾‹ï¼Œä»è€Œå®ç°<strong>è´Ÿè½½å‡è¡¡</strong>ã€‚</p><hr><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. ç¯å¢ƒæ­å»º</h1><p>åœ¨ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.4ï¼‰ä¹‹ DiscoveryClientRouteDefinitionLocator æ³¨å†Œä¸­å¿ƒã€‹ã€Œ2. ç¯å¢ƒæ­å»ºã€</a> æœ‰è¯¦ç»†æ•™ç¨‹ã€‚</p><h1>3. LoadBalancerClientFilter</h1><p><code>org.springframework.cloud.gateway.filter.LoadBalancerClientFilter</code> ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerClientFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(LoadBalancerClientFilter.class);</div><div class="line"> <span class="number">4</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_BALANCER_CLIENT_FILTER_ORDER = <span class="number">10100</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancerClient loadBalancer;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="title">LoadBalancerClientFilter</span><span class="params">(LoadBalancerClient loadBalancer)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>: <span class="keyword">this</span>.loadBalancer = loadBalancer;</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">14</span>: <span class="keyword">return</span> LOAD_BALANCER_CLIENT_FILTER_ORDER;</div><div class="line"><span class="number">15</span>: &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">18</span>: <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line"><span class="number">19</span>: <span class="comment">// è·å¾— URL</span></div><div class="line"><span class="number">20</span>: URI url = exchange.getAttribute(GATEWAY_REQUEST_URL_ATTR);</div><div class="line"><span class="number">21</span>: <span class="keyword">if</span> (url == <span class="keyword">null</span> || !url.getScheme().equals(<span class="string">"lb"</span>)) &#123;</div><div class="line"><span class="number">22</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: <span class="comment">// æ·»åŠ  åŸå§‹è¯·æ±‚URI åˆ° GATEWAY_ORIGINAL_REQUEST_URL_ATTR</span></div><div class="line"><span class="number">25</span>: <span class="comment">//preserve the original url</span></div><div class="line"><span class="number">26</span>: addOriginalRequestUrl(exchange, url);</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>: log.trace(<span class="string">"LoadBalancerClientFilter url before: "</span> + url);</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">// è·å– æœåŠ¡å®ä¾‹</span></div><div class="line"><span class="number">31</span>: <span class="keyword">final</span> ServiceInstance instance = loadBalancer.choose(url.getHost());</div><div class="line"><span class="number">32</span>: <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">33</span>: <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundException(<span class="string">"Unable to find instance for "</span> + url.getHost());</div><div class="line"><span class="number">34</span>: &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">/*URI uri = exchange.getRequest().getURI();</span></div><div class="line"><span class="comment">37: URI requestUrl = loadBalancer.reconstructURI(instance, uri);*/</span></div><div class="line"><span class="number">38</span>: <span class="comment">//</span></div><div class="line"><span class="number">39</span>: URI requestUrl = UriComponentsBuilder.fromUri(url)</div><div class="line"><span class="number">40</span>: .scheme(instance.isSecure()? <span class="string">"https"</span> : <span class="string">"http"</span>) <span class="comment">//<span class="doctag">TODO:</span> support websockets</span></div><div class="line"><span class="number">41</span>: .host(instance.getHost())</div><div class="line"><span class="number">42</span>: .port(instance.getPort())</div><div class="line"><span class="number">43</span>: .build(<span class="keyword">true</span>)</div><div class="line"><span class="number">44</span>: .toUri();</div><div class="line"><span class="number">45</span>: log.trace(<span class="string">"LoadBalancerClientFilter url chosen: "</span> + requestUrl);</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>: <span class="comment">// æ·»åŠ  è¯·æ±‚URI åˆ° GATEWAY_REQUEST_URL_ATTR</span></div><div class="line"><span class="number">48</span>: exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, requestUrl);</div><div class="line"><span class="number">49</span>: </div><div class="line"><span class="number">50</span>: <span class="comment">// æäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤</span></div><div class="line"><span class="number">51</span>: <span class="keyword">return</span> chain.filter(exchange);</div><div class="line"><span class="number">52</span>: &#125;</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>: &#125;</div></pre></td></tr></table></figure></p><ul><li><p>ç¬¬ 19 è‡³ 23 è¡Œ ï¼šè·å¾— URL ã€‚<strong>åªå¤„ç† <code>lb://</code> ä¸ºå‰ç¼€( Scheme )çš„åœ°å€</strong>ã€‚</p></li><li><p>ç¬¬ ç¬¬ 26 è¡Œ ï¼šè°ƒç”¨ <code>ServerWebExchangeUtils#addOriginalRequestUrl(...)</code> æ·»åŠ åŸå§‹è¯·æ±‚ URI åˆ° <code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> ã€‚ä»£ç å¦‚ä¸‹ ï¼š</p><p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addOriginalRequestUrl</span><span class="params">(ServerWebExchange exchange, URI url)</span> </span>&#123;</div><div class="line">exchange.getAttributes().computeIfAbsent(GATEWAY_ORIGINAL_REQUEST_URL_ATTR, s -&gt; <span class="keyword">new</span> LinkedHashSet&lt;&gt;()); <span class="comment">// æ•°ç»„ï¼Œè€ƒè™‘å¤šæ¬¡é‡å†™</span></div><div class="line">    LinkedHashSet&lt;URI&gt; uris = exchange.getRequiredAttribute(GATEWAY_ORIGINAL_REQUEST_URL_ATTR);</div><div class="line">    uris.add(url);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>ä¸ºä»€ä¹ˆä½¿ç”¨ LinkedHashSet ï¼Ÿå› ä¸ºå¯ä»¥ä½¿ç”¨ RewritePathGatewayFilterFactory / PrefixPathGatewayFilterFactory å¤šæ¬¡é‡å†™ã€‚</li></ul></li><li><p>ç¬¬ 30 è‡³ 34 è¡Œ ï¼šè°ƒç”¨ <code>LoadBalancerClient#choose(String)</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¸€ä¸ª</strong>æœåŠ¡å®ä¾‹( ServiceInstance ) ï¼Œä»è€Œå®ç°<strong>è´Ÿè½½å‡è¡¡</strong>ã€‚</p><ul><li>ç†Ÿæ‚‰ Spring Cloud çš„åŒå­¦éƒ½çŸ¥é“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ LoadBalancerClient å®ç°ç±»ä¸º <code>org.springframework.cloud.netflix.ribbon.RibbonLoadBalancerClient</code> ã€‚</li><li>ä¸¾ä¸ª <code>instance</code> çš„<strong>å€¼</strong>ä¾‹å­ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_15/01.png" alt=""></li></ul></li><li><p>ç¬¬ 39 è‡³ 45 è¡Œ ï¼šåˆ›å»º <code>requestUrl</code> ã€‚ä¸¾ä¸ªä¾‹å­ ï¼š<img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_15/02.png" alt=""></p></li><li><p>ç¬¬ 48 è¡Œ ï¼šè®¾ç½® <code>requestUrl</code> åˆ° <code>GATEWAY_REQUEST_URL_ATTR</code> ã€‚åé¢ Routing ç›¸å…³çš„ GatewayFilter ä¼šé€šè¿‡è¯¥å±æ€§ï¼Œå‘èµ·è¯·æ±‚ã€‚</p></li><li><p>ç¬¬ 51 è¡Œ ï¼šæäº¤è¿‡æ»¤å™¨é“¾ç»§ç»­è¿‡æ»¤ã€‚<strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œä¸éœ€è¦åˆ›å»º<strong>æ–°</strong>çš„ ServerWebExchange</p></li></ul><h1>4. é«˜èƒ½</h1><p>æˆ‘ä»¬å›è¿‡å¤´çœ‹ <a href="http://www.iocoder.cn/Spring-Cloud-Gateway/route-definition-locator-discover-client/?self">ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è·¯ç”±ï¼ˆ1.4ï¼‰ä¹‹ DiscoveryClientRouteDefinitionLocator æ³¨å†Œä¸­å¿ƒã€‹ã€Œ4. é«˜èƒ½ã€</a></p><p>ç›¸åŒæœåŠ¡( <code>serviceId</code> ç›¸åŒ) ï¼ŒæœåŠ¡å®ä¾‹çš„æ³¨å†Œæˆ–ä¸‹çº¿ï¼ŒRibbon å·²ç»å¤„ç†ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚</p><h1>666. å½©è›‹</h1><p>æ²¡æœ‰å½©è›‹ï¼Œç»§ç»­å¾€ä¸‹å†™ï¼å½“ç„¶ï¼Œã€Šå¤©æ‰éº»å°†å°‘å¥³ã€‹çš„ç¦åˆ©è¿˜æ˜¯æœ‰çš„ï¼</p><p><img src="http://www.iocoder.cn/images/Spring-Cloud-Gateway/2020_03_15/03.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Cloud-Gateway/filter-load-balancer-client/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº Spring-Cloud-G
      
    
    </summary>
    
      <category term="Spring-Cloud-Gateway" scheme="http://www.iocoder.cn/categories/Spring-Cloud-Gateway/"/>
    
    
  </entry>
  
</feed>
