<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èŠ‹é“æºç  â€”â€” çº¯æºç è§£æBLOG</title>
  
  <subtitle>æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.iocoder.cn/"/>
  <updated>2017-10-01T13:48:17.000Z</updated>
  <id>http://www.iocoder.cn/</id>
  
  <author>
    <name>ç‹æ–‡æ–Œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ EurekaClient</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-third/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-third/</id>
    <published>2018-04-28T16:00:00.000Z</published>
    <updated>2017-10-01T13:48:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">http://www.iocoder.cn/Eureka/eureka-client-init-third/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong> </p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-eurekaclient">2. EurekaClient</a><ul><li><a href="#21-lookupservice">2.1 LookupService</a></li></ul></li><li><a href="#3-discoveryclient">3. DiscoveryClient</a><ul><li><a href="#31-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0">3.1 æ„é€ æ–¹æ³•å‚æ•°</a></li><li><a href="#32-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">3.2 æ„é€ æ–¹æ³•</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>çš„ç¬¬ä¸‰éƒ¨åˆ† â€”â€” <strong>EurekaClient</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li>ï¼ˆä¸€ï¼‰<a href="(http://www.iocoder.cn/Eureka/eureka-client-init-first/">EurekaInstanceConfig</a>)</li><li>ï¼ˆäºŒï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">EurekaClientConfig</a></li><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆä¸‰ï¼‰EurekaClient</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><h1 id="2-EurekaClient"><a href="#2-EurekaClient" class="headerlink" title="2. EurekaClient"></a>2. EurekaClient</h1><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/EurekaClient.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.EurekaClient</code></a>ï¼ŒEureka-Client <strong>æ¥å£</strong>ï¼Œå£°æ˜å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>æä¾›<strong>å¤šç§</strong>æ–¹æ³•è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å¯¹è±¡ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚</li><li>æä¾›æ–¹æ³•è·å–<strong>æœ¬åœ°</strong>å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨ç®¡ç†å™¨( <code>com.netflix.appinfo.ApplicationInfoManager</code> )å’Œ Eureka-Client é…ç½®( <code>com.netflix.discovery.EurekaClientConfig</code> )ã€‚</li><li>æä¾›æ–¹æ³•<strong>æ³¨å†Œ</strong>æœ¬åœ°å®¢æˆ·ç«¯çš„å¥åº·æ£€æŸ¥å’Œ Eureka äº‹ä»¶ç›‘å¬å™¨ã€‚</li></ul><p>å¦å¤–ï¼ŒEureka 2.X ç‰ˆæœ¬æ­£åœ¨å¼€å‘ï¼Œè¯¥æ¥å£ä¸º Eureka 1.X å’Œ 2.X æä¾›å¹³æ»‘è¿‡æ¸¡æ¥å£ã€‚</p><blockquote><p>This interface does NOT try to clean up the current client interface for eureka 1.x. Rather it tries to provide an easier transition path from eureka 1.x to eureka 2.x.</p></blockquote><h2 id="2-1-LookupService"><a href="#2-1-LookupService" class="headerlink" title="2.1 LookupService"></a>2.1 LookupService</h2><p><a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/shared/LookupService.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.shared.LookupService</code></a>ï¼ŒæŸ¥æ‰¾æœåŠ¡<strong>æ¥å£</strong>ï¼Œæä¾›<strong>ç®€å•å•ä¸€</strong>çš„æ–¹å¼è·å–åº”ç”¨é›†åˆ(<code>com.netflix.discovery.shared.Applications</code>) å’Œ åº”ç”¨å¯¹è±¡ä¿¡æ¯é›†åˆ( <code>com.netflix.appinfo.InstanceInfo</code> )ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_29/01.png" alt=""></p><ul><li>åœ¨ Eureka-Client é‡Œï¼ŒEurekaClient ç»§æ‰¿è¯¥æ¥å£ã€‚</li><li>åœ¨ Eureka-Server é‡Œï¼Œ<code>com.netflix.eureka.registry.InstanceRegistry</code> ç»§æ‰¿è¯¥æ¥å£ã€‚</li></ul><h1 id="3-DiscoveryClient"><a href="#3-DiscoveryClient" class="headerlink" title="3. DiscoveryClient"></a>3. DiscoveryClient</h1><p><code>com.netflix.discovery.DiscoveryClient</code>ï¼Œå®ç° EurekaClient <strong>æ¥å£</strong>ï¼Œç”¨äºä¸ Eureka-Server äº¤äº’ã€‚å®ç°å¦‚ä¸‹æ–¹æ³•ï¼š</p><ul><li>å‘ Eureka-Server <strong>æ³¨å†Œ</strong>è‡ªèº«æœåŠ¡</li><li>å‘ Eureka-Server <strong>ç»­çº¦</strong>è‡ªèº«æœåŠ¡</li><li>å‘ Eureka-Server <strong>å–æ¶ˆ</strong>è‡ªèº«æœåŠ¡ï¼Œå½“å…³é—­æ—¶</li><li>ä» Eureka-Server <strong>æŸ¥è¯¢</strong>åº”ç”¨é›†åˆå’Œåº”ç”¨å¯¹è±¡ä¿¡æ¯</li><li><em>ç®€å•æ¥ç†è§£ï¼Œå¯¹ Eureka-Server æœåŠ¡çš„å¢åˆ æ”¹æŸ¥</em></li></ul><h2 id="3-1-æ„é€ æ–¹æ³•å‚æ•°"><a href="#3-1-æ„é€ æ–¹æ³•å‚æ•°" class="headerlink" title="3.1 æ„é€ æ–¹æ³•å‚æ•°"></a>3.1 æ„é€ æ–¹æ³•å‚æ•°</h2><p>DiscoveryClient <strong>å®Œæ•´</strong>æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,</div><div class="line">                    Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</div><div class="line">     <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ApplicationInfoManagerï¼Œåœ¨<a href="ttp://www.iocoder.cn/Eureka/eureka-client-init-first/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>EurekaClientConfigï¼Œåœ¨<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfigã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><p><code>com.netflix.discovery.BackupRegistry</code>ï¼Œå¤‡ä»½æ³¨å†Œä¸­å¿ƒ<strong>æ¥å£</strong>ã€‚å½“ Eureka-Client å¯åŠ¨æ—¶ï¼Œæ— æ³•ä» Eureka-Server è¯»å–æ³¨å†Œä¿¡æ¯ï¼ˆå¯èƒ½æŒ‚äº†ï¼‰ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè¯»å–æ³¨å†Œä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BackupRegistry.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BackupRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">Applications <span class="title">fetchRegistry</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Applications <span class="title">fetchRegistry</span><span class="params">(String[] includeRemoteRegions)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// NotImplementedRegistryImpl.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotImplementedRegistryImpl</span> <span class="keyword">implements</span> <span class="title">BackupRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">(String[] includeRemoteRegions)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä» <code>com.netflix.discovery.NotImplementedRegistryImpl</code> å¯ä»¥çœ‹å‡ºï¼Œç›®å‰ Eureka-Client æœªæä¾›åˆé€‚çš„é»˜è®¤å®ç°ã€‚</li></ul></li><li><p><code>com.netflix.discovery.AbstractDiscoveryClientOptionalArgs</code>ï¼ŒDiscoveryClient å¯é€‰å‚æ•°æŠ½è±¡åŸºç±»ã€‚ä¸åŒäºä¸Šé¢ä¸‰ä¸ª<strong>å¿…å¡«</strong>å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯<strong>é€‰å¡«</strong>å‚æ•°ï¼Œå®é™…ç”Ÿäº§ä¸‹ä½¿ç”¨è¾ƒå°‘ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆå¥åº·æ£€æŸ¥å›è°ƒçš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Provider&lt;HealthCheckCallback&gt; healthCheckCallbackProvider;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆå¥åº·æ£€æŸ¥å¤„ç†å™¨çš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Provider&lt;HealthCheckHandler&gt; healthCheckHandlerProvider;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    PreRegistrationHandler preRegistrationHandler;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey è¿‡æ»¤å™¨é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Collection&lt;T&gt; additionalFilters;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jersey å®¢æˆ·ç«¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    EurekaJerseyClient eurekaJerseyClient;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”Ÿæˆ Jersey å®¢æˆ·ç«¯çš„å·¥å‚çš„å·¥å‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TransportClientFactories transportClientFactories;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka äº‹ä»¶ç›‘å¬å™¨é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Set&lt;EurekaEventListener&gt; eventListeners;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>com.netflix.appinfo.HealthCheckCallback</code>ï¼Œå¥åº·æ£€æŸ¥å›è°ƒ<strong>æ¥å£</strong>ï¼Œç›®å‰å·²ç»åºŸå¼ƒï¼Œä½¿ç”¨ HealthCheckHandler æ›¿ä»£ï¼Œ<strong>ä½ å¯ä»¥ä¸å…³æ³¨è¯¥å‚æ•°</strong>ã€‚</li><li><p><code>com.netflix.appinfo.HealthCheckHandler</code>ï¼Œå¥åº·æ£€æŸ¥å¤„ç†å™¨<strong>æ¥å£</strong>ï¼Œç›®å‰æš‚æœªæä¾›åˆé€‚çš„<strong>é»˜è®¤</strong>å®ç°ï¼Œå”¯ä¸€æä¾›çš„ <code>com.netflix.appinfo.HealthCheckCallbackToHandlerBridge</code>ï¼Œç”¨äºå°† HealthCheckCallback <strong>æ¡¥æ¥</strong>æˆ HealthCheckHandlerï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HealthCheckHandler.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HealthCheckHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HealthCheckCallbackToHandlerBridge.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthCheckCallbackToHandlerBridge</span> <span class="keyword">implements</span> <span class="title">HealthCheckHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthCheckCallback callback;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HealthCheckCallbackToHandlerBridge</span><span class="params">()</span> </span>&#123;</div><div class="line">        callback = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HealthCheckCallbackToHandlerBridge</span><span class="params">(HealthCheckCallback callback)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.callback = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">getStatus</span><span class="params">(InstanceInfo.InstanceStatus currentStatus)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == callback || InstanceInfo.InstanceStatus.STARTING == currentStatus</div><div class="line">                || InstanceInfo.InstanceStatus.OUT_OF_SERVICE == currentStatus) &#123; <span class="comment">// Do not go to healthcheck handler if the status is starting or OOS.</span></div><div class="line">            <span class="keyword">return</span> currentStatus;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> callback.isHealthy() ? InstanceInfo.InstanceStatus.UP : InstanceInfo.InstanceStatus.DOWN;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åœ¨ Spring-Cloud-Eureka-Clientï¼Œæä¾›äº†é»˜è®¤å®ç° <a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/82991a7fc2859b6345b7f67e2461dbf5d7663836/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaHealthCheckHandler.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.cloud.netflix.eureka.EurekaHealthCheckHandler</code></a>ï¼Œéœ€è¦ç»“åˆ <a href="https://github.com/spring-projects/spring-boot/tree/c79568886406662736dcdce78f65e7f46dd62696/spring-boot-actuator/" rel="external nofollow noopener noreferrer" target="_blank"><code>spirng-boot-actuate</code></a> ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ã€‚æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO åæ–‡è¶…é“¾ï¼‰</li></ul></li><li><p><code>com.netflix.discovery.PreRegistrationHandler</code>ï¼Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨<strong>æ¥å£</strong>ï¼Œç›®å‰æš‚æœªæä¾›é»˜è®¤å®ç°ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œå¯ä»¥åœ¨æ³¨å†Œå‰åšä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PreRegistrationHandler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeRegistration</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul><ul><li><p><code>additionalFilters</code>ï¼ŒJersey è¿‡æ»¤å™¨é›†åˆã€‚è¿™é‡Œå£°æ˜æ³›å‹ <code>&lt;T&gt;</code> çš„åŸå› ï¼ŒJersey 1.X å’Œ Jersey 2.X çš„è¿‡æ»¤å™¨æ¥å£<strong>ä¸åŒ</strong>ï¼Œé€šè¿‡æ³›å‹æ¥æ”¯æŒã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Jersey1DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">ClientFilter</span>&gt; </span>&#123;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// Jersey2DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jersey2DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">AbstractDiscoveryClientOptionalArgs</span>&lt;<span class="title">ClientRequestFilter</span>&gt; </span>&#123;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">// DiscoveryClientOptionalArgs.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClientOptionalArgs</span> <span class="keyword">extends</span> <span class="title">Jersey1DiscoveryClientOptionalArgs</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>Jersey 1.X ä½¿ç”¨ ClientFilter ã€‚ClientFilter ç›®å‰æœ‰ä¸¤ä¸ªè¿‡æ»¤å™¨å®ç°ï¼šEurekaIdentityHeaderFilter ã€DynamicGZIPContentEncodingFilterï¼Œæœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO åæ–‡è¶…é“¾ï¼‰</li><li>Jersey 2.X ä½¿ç”¨ ClientRequestFilter ã€‚</li><li>DiscoveryClient ä½¿ç”¨ DiscoveryClientOptionalArgsï¼Œå³ Jersey 1.X ã€‚</li></ul></li></ul></li></ul><ul><li><code>eurekaJerseyClient</code>ï¼ŒJersey å®¢æˆ·ç«¯ã€‚è¯¥<strong>å‚æ•°</strong>ç›®å‰åºŸå¼ƒï¼Œä½¿ç”¨ä¸‹é¢ TransportClientFactories å‚æ•°æ¥è¿›è¡Œç”Ÿæˆã€‚</li><li><p><code>com.netflix.discovery.shared.transport.jersey.TransportClientFactories</code>ï¼Œç”Ÿæˆ Jersey å®¢æˆ·ç«¯<strong>å·¥å‚çš„å·¥å‚</strong>æ¥å£ã€‚ç›®å‰æœ‰ Jersey1TransportClientFactories ã€Jersey2TransportClientFactories ä¸¤ä¸ªå®ç°ã€‚TransportClientFactories å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransportClientFactories.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactories</span>&lt;<span class="title">F</span>&gt; </span>&#123;</div><div class="line">  </div><div class="line">      <span class="meta">@Deprecated</span></div><div class="line">      <span class="function">TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> Collection&lt;F&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> EurekaJerseyClient providedJerseyClient)</span></span>;</div><div class="line">  </div><div class="line">      <span class="function">TransportClientFactory <span class="title">newTransportClientFactory</span><span class="params">(<span class="keyword">final</span> EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> Collection&lt;F&gt; additionalFilters,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> InstanceInfo myInstanceInfo)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransportClientFactory.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransportClientFactory</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="function">EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint serviceUrl)</span></span>;</div><div class="line">    </div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªæ–¹æ³•å·²ç»åºŸå¼ƒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ä¸Šé¢çš„ <code>eurekaJerseyClient</code> <strong>å‚æ•°</strong>( ä¸æ˜¯ EurekaJerseyClient ç±»)å·²ç»åºŸå¼ƒï¼Œè¢«ç¬¬äºŒä¸ªæ–¹æ³•å–ä»£ã€‚ç›¸æ¯”æ¥è¯´ï¼Œç¬¬äºŒä¸ªæ–¹æ³•å¯¹ EurekaJerseyClient åˆ›å»ºå°è£…ä¼šæ›´å¥½ã€‚</li></ul></li><li><p><code>com.netflix.discovery.EurekaEventListener</code>ï¼ŒEureka äº‹ä»¶ç›‘å¬å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaEventListener.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEventListener</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// EurekaEvent.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaEvent</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryEvent.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryEvent</span> <span class="keyword">implements</span> <span class="title">EurekaEvent</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timestamp;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>StatusChangeEvent ï¼ˆTODO åæ–‡è¶…é“¾ï¼‰</li><li>CacheRefreshedEvent ï¼ˆTODO åæ–‡è¶…é“¾ï¼‰</li></ul></li></ul></li></ul><h2 id="3-2-æ„é€ æ–¹æ³•"><a href="#3-2-æ„é€ æ–¹æ³•" class="headerlink" title="3.2 æ„é€ æ–¹æ³•"></a>3.2 æ„é€ æ–¹æ³•</h2><p>DiscoveryClient çš„æ„é€ æ–¹æ³•å®ç°ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œå·²ç»å°†ä»£ç <strong>åˆ‡å—</strong> + <strong>ä¸­æ–‡æ³¨å†Œ</strong>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/DiscoveryClient.java#L298" rel="external nofollow noopener noreferrer" target="_blank">DiscoveryClient</a> é“¾æ¥ï¼Œå¯¹ç…§ä¸‹é¢æ¯ä¸ªå°ç»“é˜…è¯»ç†è§£ã€‚</p><h3 id="3-2-1-èµ‹å€¼-AbstractDiscoveryClientOptionalArgs"><a href="#3-2-1-èµ‹å€¼-AbstractDiscoveryClientOptionalArgs" class="headerlink" title="3.2.1 èµ‹å€¼ AbstractDiscoveryClientOptionalArgs"></a>3.2.1 èµ‹å€¼ AbstractDiscoveryClientOptionalArgs</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.healthCheckHandlerProvider = args.healthCheckHandlerProvider;</div><div class="line">  <span class="keyword">this</span>.healthCheckCallbackProvider = args.healthCheckCallbackProvider;</div><div class="line">  <span class="keyword">this</span>.eventListeners.addAll(args.getEventListeners());</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler = args.preRegistrationHandler;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.healthCheckCallbackProvider = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.healthCheckHandlerProvider = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-2-èµ‹å€¼-ApplicationInfoManagerã€EurekaClientConfig"><a href="#3-2-2-èµ‹å€¼-ApplicationInfoManagerã€EurekaClientConfig" class="headerlink" title="3.2.2 èµ‹å€¼ ApplicationInfoManagerã€EurekaClientConfig"></a>3.2.2 èµ‹å€¼ ApplicationInfoManagerã€EurekaClientConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</div><div class="line">InstanceInfo myInfo = applicationInfoManager.getInfo();</div><div class="line"></div><div class="line">clientConfig = config;</div><div class="line">staticClientConfig = clientConfig;</div><div class="line">transportConfig = config.getTransportConfig();</div><div class="line">instanceInfo = myInfo;</div><div class="line"><span class="keyword">if</span> (myInfo != <span class="keyword">null</span>) &#123;</div><div class="line">  appPathIdentifier = instanceInfo.getAppName() + <span class="string">"/"</span> + instanceInfo.getId(); <span class="comment">// æ— å®é™…ä¸šåŠ¡ç”¨é€”ï¼Œç”¨äºæ‰“ logger</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  logger.warn(<span class="string">"Setting instanceInfo to a passed in null value"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-3-èµ‹å€¼-BackupRegistry"><a href="#3-2-3-èµ‹å€¼-BackupRegistry" class="headerlink" title="3.2.3 èµ‹å€¼ BackupRegistry"></a>3.2.3 èµ‹å€¼ BackupRegistry</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.backupRegistryProvider = backupRegistryProvider;</div></pre></td></tr></table></figure><h3 id="3-2-4-åˆå§‹åŒ–-InstanceInfoBasedUrlRandomizer"><a href="#3-2-4-åˆå§‹åŒ–-InstanceInfoBasedUrlRandomizer" class="headerlink" title="3.2.4 åˆå§‹åŒ– InstanceInfoBasedUrlRandomizer"></a>3.2.4 åˆå§‹åŒ– InstanceInfoBasedUrlRandomizer</h3><p>TODO æ²¡å¼„æ‡‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">this</span>.urlRandomizer = <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(instanceInfo);</div></pre></td></tr></table></figure><h3 id="3-2-5-åˆå§‹åŒ–-Applications-åœ¨æœ¬åœ°çš„ç¼“å­˜"><a href="#3-2-5-åˆå§‹åŒ–-Applications-åœ¨æœ¬åœ°çš„ç¼“å­˜" class="headerlink" title="3.2.5 åˆå§‹åŒ– Applications åœ¨æœ¬åœ°çš„ç¼“å­˜"></a>3.2.5 åˆå§‹åŒ– Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Applications åœ¨æœ¬åœ°çš„ç¼“å­˜</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Applications&gt; localRegionApps = <span class="keyword">new</span> AtomicReference&lt;Applications&gt;();</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‹‰å–æ³¨å†Œä¿¡æ¯æ¬¡æ•°</span></div><div class="line"><span class="comment">* monotonically increasing generation counter to ensure stale threads do not reset registry to an older version</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong fetchRegistryGeneration;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">localRegionApps.set(<span class="keyword">new</span> Applications());</div><div class="line"></div><div class="line">fetchRegistryGeneration = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure><ul><li>åœ¨åˆ›å»º DiscoveryClient æ—¶ï¼Œ<code>localRegionApps</code> ä¸ºç©ºã€‚</li><li>å®šæ—¶ä»»åŠ¡<strong>é—´éš”</strong>ä» Eureka-Server æ‹‰å–æ³¨å†Œåº”ç”¨ä¿¡æ¯åˆ°æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ (TODO åæ–‡é“¾æ¥)è¯¦ç»†è§£æã€‚</li></ul><h3 id="3-2-6-è·å–å“ªäº›-Region-é›†åˆçš„æ³¨å†Œä¿¡æ¯"><a href="#3-2-6-è·å–å“ªäº›-Region-é›†åˆçš„æ³¨å†Œä¿¡æ¯" class="headerlink" title="3.2.6 è·å–å“ªäº› Region é›†åˆçš„æ³¨å†Œä¿¡æ¯"></a>3.2.6 è·å–å“ªäº› Region é›†åˆçš„æ³¨å†Œä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–å“ªäº›åŒºåŸŸ( Region )é›†åˆçš„æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String&gt; remoteRegionsToFetch;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–å“ªäº›åŒºåŸŸ( Region )é›†åˆçš„æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;String[]&gt; remoteRegionsRef;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">remoteRegionsToFetch = <span class="keyword">new</span> AtomicReference&lt;&gt;(clientConfig.fetchRegistryForRemoteRegions());</div><div class="line">remoteRegionsRef = <span class="keyword">new</span> AtomicReference&lt;&gt;(remoteRegionsToFetch.get() == <span class="keyword">null</span> ? <span class="keyword">null</span> : remoteRegionsToFetch.get().split(<span class="string">","</span>));</div></pre></td></tr></table></figure><h3 id="3-2-7-åˆå§‹åŒ–æ‹‰å–ã€å¿ƒè·³çš„ç›‘æ§"><a href="#3-2-7-åˆå§‹åŒ–æ‹‰å–ã€å¿ƒè·³çš„ç›‘æ§" class="headerlink" title="3.2.7 åˆå§‹åŒ–æ‹‰å–ã€å¿ƒè·³çš„ç›‘æ§"></a>3.2.7 åˆå§‹åŒ–æ‹‰å–ã€å¿ƒè·³çš„ç›‘æ§</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulRegistryFetchTimestamp = -<span class="number">1</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åæˆåŠŸå‘ Eureka-Server å¿ƒè·³æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="number">1</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¿ƒè·³ç›‘æ§</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric heartbeatStalenessMonitor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‹‰å–ç›‘æ§</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThresholdLevelsMetric registryStalenessMonitor;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (config.shouldFetchRegistry()) &#123;</div><div class="line">  <span class="keyword">this</span>.registryStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRY_PREFIX + <span class="string">"lastUpdateSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.registryStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (config.shouldRegisterWithEureka()) &#123;</div><div class="line">  <span class="keyword">this</span>.heartbeatStalenessMonitor = <span class="keyword">new</span> ThresholdLevelsMetric(<span class="keyword">this</span>, METRIC_REGISTRATION_PREFIX + <span class="string">"lastHeartbeatSec_"</span>, <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;<span class="number">15L</span>, <span class="number">30L</span>, <span class="number">60L</span>, <span class="number">120L</span>, <span class="number">240L</span>, <span class="number">480L</span>&#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">this</span>.heartbeatStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ¯æ¬¡æˆåŠŸå‘ Eureka-Serve å¿ƒè·³æˆ–è€…ä»ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯åï¼Œéƒ½ä¼šæ›´æ–°ç›¸åº”æ—¶é—´æˆ³ã€‚</li><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li><li>å¯¹ <a href="https://github.com/YunaiV/eureka/blob/3ef162f20a28c75de84321b69412c4ef138ad55a/eureka-client/src/main/java/com/netflix/discovery/util/ThresholdLevelsMetric.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.discovery.util.ThresholdLevelsMetric</code></a> æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO åæ–‡è¶…é“¾ï¼‰</li></ul><h3 id="3-2-8-ç»“æŸåˆå§‹åŒ–ï¼Œå½“æ— éœ€å’Œ-Eureka-Server-äº¤äº’"><a href="#3-2-8-ç»“æŸåˆå§‹åŒ–ï¼Œå½“æ— éœ€å’Œ-Eureka-Server-äº¤äº’" class="headerlink" title="3.2.8 ç»“æŸåˆå§‹åŒ–ï¼Œå½“æ— éœ€å’Œ Eureka-Server äº¤äº’"></a>3.2.8 ç»“æŸåˆå§‹åŒ–ï¼Œå½“æ— éœ€å’Œ Eureka-Server äº¤äº’</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (!config.shouldRegisterWithEureka() &amp;&amp; !config.shouldFetchRegistry()) &#123;</div><div class="line">  logger.info(<span class="string">"Client configured to neither register nor query for data."</span>);</div><div class="line">  scheduler = <span class="keyword">null</span>;</div><div class="line">  heartbeatExecutor = <span class="keyword">null</span>;</div><div class="line">  cacheRefreshExecutor = <span class="keyword">null</span>;</div><div class="line">  eurekaTransport = <span class="keyword">null</span>;</div><div class="line">  instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(<span class="keyword">new</span> PropertyBasedAzToRegionMapper(config), clientConfig.getRegion());</div><div class="line"></div><div class="line">  <span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></div><div class="line">  <span class="comment">// to work with DI'd DiscoveryClient</span></div><div class="line">  DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</div><div class="line">  DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line"></div><div class="line">  initTimestampMs = System.currentTimeMillis();</div><div class="line">  logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</div><div class="line">          initTimestampMs, <span class="keyword">this</span>.getApplications().size());</div><div class="line"></div><div class="line">  <span class="keyword">return</span>;  <span class="comment">// no need to setup up an network tasks and we are done</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-9-åˆå§‹åŒ–çº¿ç¨‹æ± "><a href="#3-2-9-åˆå§‹åŒ–çº¿ç¨‹æ± " class="headerlink" title="3.2.9 åˆå§‹åŒ–çº¿ç¨‹æ± "></a>3.2.9 åˆå§‹åŒ–çº¿ç¨‹æ± </h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* çº¿ç¨‹æ± </span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* A scheduler to be used for the following 3 tasks: ã€ç›®å‰åªæœ‰ä¸¤ä¸ªã€‘</span></div><div class="line"><span class="comment">* - updating service urls</span></div><div class="line"><span class="comment">* - scheduling a TimedSuperVisorTask</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</div><div class="line"><span class="comment">// additional executors for supervised subtasks</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¿ƒè·³æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor heartbeatExecutor;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* &#123;<span class="doctag">@link</span> #localRegionApps&#125; åˆ·æ–°æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cacheRefreshExecutor;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></div><div class="line">scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build());</div><div class="line"></div><div class="line">heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">     <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build()</div><div class="line">);  <span class="comment">// use direct handoff</span></div><div class="line"></div><div class="line">cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">     <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">     <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">             .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</div><div class="line">             .setDaemon(<span class="keyword">true</span>)</div><div class="line">             .build()</div><div class="line">);  <span class="comment">// use direct handoff</span></div></pre></td></tr></table></figure><ul><li><code>scheduler</code>ï¼Œ<strong>å®šæ—¶ä»»åŠ¡</strong>çº¿ç¨‹æ± ï¼Œåˆå§‹åŒ–å¤§å°ä¸º 2ï¼Œä¸€ä¸ªç»™ <code>heartbeatExecutor</code>ï¼Œä¸€ä¸ªç»™ <code>cacheRefreshExecutor</code>ã€‚</li><li><code>heartbeatExecutor</code>ã€<code>cacheRefreshExecutor</code> åœ¨æäº¤ç»™ <code>scheduler</code> æ‰å£°æ˜å…·ä½“çš„<strong>ä»»åŠ¡</strong>ã€‚</li></ul><h3 id="3-2-10-åˆå§‹åŒ–-Eureka-ç½‘ç»œé€šä¿¡ç›¸å…³"><a href="#3-2-10-åˆå§‹åŒ–-Eureka-ç½‘ç»œé€šä¿¡ç›¸å…³" class="headerlink" title="3.2.10 åˆå§‹åŒ– Eureka ç½‘ç»œé€šä¿¡ç›¸å…³"></a>3.2.10 åˆå§‹åŒ– Eureka ç½‘ç»œé€šä¿¡ç›¸å…³</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">eurekaTransport = <span class="keyword">new</span> EurekaTransport();</div><div class="line">scheduleServerEndpointTask(eurekaTransport, args);</div></pre></td></tr></table></figure><ul><li>æœ¬æ–‡æš‚ä¸æ‹“å±•å¼€ï¼Œåé¢å¦å¼€æ–‡ç« åˆ†äº«ã€‚ï¼ˆTODO åæ–‡è¶…é“¾ï¼‰</li></ul><h3 id="3-2-11-åˆå§‹åŒ–-InstanceRegionChecker"><a href="#3-2-11-åˆå§‹åŒ–-InstanceRegionChecker" class="headerlink" title="3.2.11 åˆå§‹åŒ– InstanceRegionChecker"></a>3.2.11 åˆå§‹åŒ– InstanceRegionChecker</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">AzToRegionMapper azToRegionMapper;</div><div class="line"><span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</div><div class="line">    azToRegionMapper = <span class="keyword">new</span> DNSBasedAzToRegionMapper(clientConfig);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    azToRegionMapper = <span class="keyword">new</span> PropertyBasedAzToRegionMapper(clientConfig);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsToFetch.get()) &#123;</div><div class="line">    azToRegionMapper.setRegionsToFetch(remoteRegionsToFetch.get().split(<span class="string">","</span>));</div><div class="line">&#125;</div><div class="line">instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(azToRegionMapper, clientConfig.getRegion());</div></pre></td></tr></table></figure><ul><li><code>com.netflix.discovery.AzToRegionMapper</code>ï¼Œä¸»è¦ç”¨äºäºšé©¬é€Š AWSï¼Œè·³è¿‡ã€‚</li><li><p><code>com.netflix.discovery.InstanceRegionChecker</code>ï¼Œåº”ç”¨å¯¹è±¡ä¿¡æ¯åŒºåŸŸ( <code>region</code> )æ ¡éªŒï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceRegionChecker</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥å’Œäºšé©¬é€Š AWS ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ¬åœ°åŒºåŸŸ( Region )</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String localRegion;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocalRegion</span><span class="params">(@Nullable String instanceRegion)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == instanceRegion || instanceRegion.equals(localRegion); <span class="comment">// no region == local</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLocalRegion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> localRegion;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="3-2-12-ä»-Eureka-Server-æ‹‰å–æ³¨å†Œä¿¡æ¯"><a href="#3-2-12-ä»-Eureka-Server-æ‹‰å–æ³¨å†Œä¿¡æ¯" class="headerlink" title="3.2.12 ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯"></a>3.2.12 ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</div><div class="line">  fetchRegistryFromBackup();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#fetchRegistry(false)</code> æ–¹æ³•ï¼Œä» Eureka-Server <strong>åˆå§‹</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯ã€‚åœ¨ï¼ˆTOåæ–‡é“¾æ¥ï¼‰è¯¦ç»†è§£æã€‚</li><li><p>è°ƒç”¨ <code>#fetchRegistryFromBackup()</code> æ–¹æ³•ï¼Œè‹¥<strong>åˆå§‹</strong>æ‹‰å–æ³¨å†Œä¿¡æ¯å¤±è´¥ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè·å–ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fetchRegistryFromBackup</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">        BackupRegistry backupRegistryInstance = newBackupRegistryInstance();</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == backupRegistryInstance) &#123; <span class="comment">// backward compatibility with the old protected method, in case it is being used.</span></div><div class="line">            backupRegistryInstance = backupRegistryProvider.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != backupRegistryInstance) &#123;</div><div class="line">            Applications apps = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (isFetchingRemoteRegionRegistries()) &#123;</div><div class="line">                String remoteRegionsStr = remoteRegionsToFetch.get();</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsStr) &#123;</div><div class="line">                    apps = backupRegistryInstance.fetchRegistry(remoteRegionsStr.split(<span class="string">","</span>));</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                apps = backupRegistryInstance.fetchRegistry();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (apps != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> Applications applications = <span class="keyword">this</span>.filterAndShuffle(apps);</div><div class="line">                applications.setAppsHashCode(applications.getReconcileHashCode());</div><div class="line">                localRegionApps.set(applications);</div><div class="line">                logTotalInstances();</div><div class="line">                logger.info(<span class="string">"Fetched registry successfully from the backup"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.warn(<span class="string">"No backup registry instance defined &amp; unable to find any discovery servers."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        logger.warn(<span class="string">"Cannot fetch applications from apps although backup registry was specified"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>BackupRegistry ç›®å‰æš‚æœªæä¾›é»˜è®¤å®ç°ï¼Œéœ€è¦è‡ªè¡Œç›¸å…³é€»è¾‘ã€‚</li></ul></li></ul><h3 id="3-2-13-æ‰§è¡Œå‘-Eureka-Server-æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨"><a href="#3-2-13-æ‰§è¡Œå‘-Eureka-Server-æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨" class="headerlink" title="3.2.13 æ‰§è¡Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨"></a>3.2.13 æ‰§è¡Œå‘ Eureka-Server æ³¨å†Œä¹‹å‰çš„å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// call and execute the pre registration handler before all background tasks (inc registration) is started</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.preRegistrationHandler != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.preRegistrationHandler.beforeRegistration();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-14-åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡"><a href="#3-2-14-åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡" class="headerlink" title="3.2.14 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡"></a>3.2.14 åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line">initScheduledTasks();</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</div><div class="line">       <span class="comment">// registry cache refresh timer</span></div><div class="line">       <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"cacheRefresh"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       cacheRefreshExecutor,</div><div class="line">                       registryFetchIntervalSeconds,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> CacheRefreshThread()</div><div class="line">               ),</div><div class="line">               registryFetchIntervalSeconds, TimeUnit.SECONDS);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</div><div class="line">       <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</div><div class="line">       <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</div><div class="line">       logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</div><div class="line"></div><div class="line">       <span class="comment">// Heartbeat timer</span></div><div class="line">       scheduler.schedule(</div><div class="line">               <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">                       <span class="string">"heartbeat"</span>,</div><div class="line">                       scheduler,</div><div class="line">                       heartbeatExecutor,</div><div class="line">                       renewalIntervalInSecs,</div><div class="line">                       TimeUnit.SECONDS,</div><div class="line">                       expBackOffBound,</div><div class="line">                       <span class="keyword">new</span> HeartbeatThread()</div><div class="line">               ),</div><div class="line">               renewalIntervalInSecs, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">       <span class="comment">// InstanceInfo replicator</span></div><div class="line">       instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</div><div class="line">               <span class="keyword">this</span>,</div><div class="line">               instanceInfo,</div><div class="line">               clientConfig.getInstanceInfoReplicationIntervalSeconds(),</div><div class="line">               <span class="number">2</span>); <span class="comment">// burstSize</span></div><div class="line"></div><div class="line">       statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</div><div class="line">                       InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</div><div class="line">                   <span class="comment">// log at warn level if DOWN was involved</span></div><div class="line">                   logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</div><div class="line">               &#125;</div><div class="line">               instanceInfoReplicator.onDemandUpdate();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</div><div class="line">           applicationInfoManager.registerStatusChangeListener(statusChangeListener);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>åˆå§‹åŒ–</strong>ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯æ‰§è¡Œå™¨ï¼Œåœ¨ï¼ˆTODOTODOï¼‰è¯¦ç»†è§£æã€‚</li><li><strong>åˆå§‹åŒ–</strong>å‘ Eureka-Server å¿ƒè·³ï¼ˆç»­ç§Ÿï¼‰æ‰§è¡Œå™¨ï¼Œåœ¨ï¼ˆTODOTODOï¼‰è¯¦ç»†è§£æã€‚</li></ul><h3 id="3-2-15-å‘-Servo-æ³¨å†Œç›‘æ§"><a href="#3-2-15-å‘-Servo-æ³¨å†Œç›‘æ§" class="headerlink" title="3.2.15 å‘ Servo æ³¨å†Œç›‘æ§"></a>3.2.15 å‘ Servo æ³¨å†Œç›‘æ§</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  Monitors.registerObject(<span class="keyword">this</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">  logger.warn(<span class="string">"Cannot register timers"</span>, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é…åˆ <a href="https://github.com/Netflix/servo" rel="external nofollow noopener noreferrer" target="_blank">Netflix Servo</a> å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚</li></ul><h3 id="3-2-16-åˆå§‹åŒ–å®Œæˆ"><a href="#3-2-16-åˆå§‹åŒ–å®Œæˆ" class="headerlink" title="3.2.16 åˆå§‹åŒ–å®Œæˆ"></a>3.2.16 åˆå§‹åŒ–å®Œæˆ</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DiscoveryClient.java å˜é‡</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆå§‹åŒ–å®Œæˆæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> initTimestampMs;</div><div class="line"></div><div class="line"><span class="comment">// DiscoveryClient.java æ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">// ã€3.2.16ã€‘åˆå§‹åŒ–å®Œæˆ</span></div><div class="line"><span class="comment">// This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span></div><div class="line"><span class="comment">// to work with DI'd DiscoveryClient</span></div><div class="line">DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</div><div class="line">DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line"></div><div class="line">initTimestampMs = System.currentTimeMillis();</div><div class="line">logger.info(<span class="string">"Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;"</span>,</div><div class="line">      initTimestampMs, <span class="keyword">this</span>.getApplications().size());</div></pre></td></tr></table></figure><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç”±äºç¬”è€…æ˜¯è¾¹ç†è§£æºç è¾¹è¾“å‡ºåšå®¢å†…å®¹ï¼Œå¦‚æœæœ‰é”™è¯¯æˆ–è€…ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œ<strong>æ¬¢è¿</strong>å¾®ç¬‘ç»™æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç•™è¨€ï¼Œæˆ‘ä¼š<strong>ä»”ç»†</strong>å›å¤ã€‚æ„Ÿè°¢ + 1024ã€‚</p><p>åé¢æ–‡ç« ä¸æ–­æ›´æ–°ï¼Œä¼šæ…¢æ…¢å®Œå–„æœ¬æ–‡ä¸­çš„ TODOã€‚</p><p>æ¨èå‚è€ƒé˜…è¯»ï¼š</p><ul><li><a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ç¨‹åºçŒ¿DD â€”â€” ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a> Spring Cloud Eureka â€”â€” æºç åˆ†æ</li><li><strong>ä¹°ç›—ç‰ˆä¹¦ï¼Œç­‰äºç¼–å†™ä¸€ä¸ªåˆçº§ BUG</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Eureka/eureka-client-init-third/&quot;&gt;http://www.iocoder.cn/Eureka/eureka-client-init-third/&lt;/a&gt; ã€ŒèŠ‹é“æº
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆäºŒï¼‰ä¹‹ EurekaClientConfig</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-second/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-second/</id>
    <published>2018-04-22T16:00:00.000Z</published>
    <updated>2017-10-01T13:20:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">http://www.iocoder.cn/Eureka/eureka-client-init-second/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong> </p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. EurekaClientConfig</a><ul><li><a href="#">2.1 ç±»å…³ç³»å›¾</a></li><li><a href="#">2.2 é…ç½®å±æ€§</a></li><li><a href="#">2.3 DefaultEurekaClientConfig</a></li><li><a href="#">2.4 DefaultEurekaClientConfigProvider</a></li><li><a href="#">2.5 å°ç»“</a></li></ul></li><li><a href="#">3. EurekaTransportConfig</a><ul><li><a href="#">3.1 ç±»å…³ç³»å›¾</a></li><li><a href="#">3.2 é…ç½®å±æ€§</a></li><li><a href="#">3.3 DefaultEurekaTransportConfig</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg"></a></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹</a>ï¼Œä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>çš„ç¬¬äºŒéƒ¨åˆ† â€”â€” <strong>EurekaClientConfig</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li>ï¼ˆä¸€ï¼‰<a href="(http://www.iocoder.cn/Eureka/eureka-client-init-first/">EurekaInstanceConfig</a>)</li><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆäºŒï¼‰EurekaClientConfig</li><li>ï¼ˆä¸‰ï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">EurekaClient</a></li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><h1 id="2-EurekaClientConfig"><a href="#2-EurekaClientConfig" class="headerlink" title="2. EurekaClientConfig"></a>2. EurekaClientConfig</h1><p><code>com.netflix.discovery.EurekaClientConfig</code>ï¼Œ<strong>Eureka-Client</strong> é…ç½®<strong>æ¥å£</strong>ã€‚</p><h2 id="2-1-ç±»å…³ç³»å›¾"><a href="#2-1-ç±»å…³ç³»å›¾" class="headerlink" title="2.1 ç±»å…³ç³»å›¾"></a>2.1 ç±»å…³ç³»å›¾</h2><p>EurekaClientConfig æ•´ä½“ç±»å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_22/04.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ<strong>çº¢åœˆ</strong>éƒ¨åˆ†ç±»ã€‚</li><li>EurekaArchaius2ClientConfig åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 2.x</a> å®ç°ï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li></ul><h2 id="2-2-é…ç½®å±æ€§"><a href="#2-2-é…ç½®å±æ€§" class="headerlink" title="2.2 é…ç½®å±æ€§"></a>2.2 é…ç½®å±æ€§</h2><p>ç‚¹å‡» <a href="TODOTODO">EurekaClientConfig</a> æŸ¥çœ‹é…ç½®å±æ€§ç®€ä»‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç€è‹±æ–‡æ³¨é‡Šä¸€èµ·ç†è§£ã€‚è¿™é‡Œç¬”è€…æ‘˜å‡ºéƒ¨åˆ†è¾ƒä¸ºé‡è¦çš„å±æ€§ï¼š</p><ul><li><strong>Regionã€Zone ç›¸å…³</strong><ul><li><code>#getRegion()</code> ï¼šEureka-Client æ‰€åœ¨åŒºåŸŸ( <code>region</code> )ã€‚</li><li><code>#getAvailabilityZones()</code> ï¼šEureka-Client æ‰€åœ¨åœ°åŒº( <code>region</code> ) å¯ç”¨åŒº( <code>zone</code> )é›†åˆã€‚</li><li>è¿›æ­¥ä¸€æ­¥ç†è§£ Regionã€Zone æŸ¥çœ‹<a href="http://www.itmuch.com/spring-cloud-1/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå‘¨ç«‹ â€”â€” Regionã€Zoneè§£æã€‹</a>ã€‚</li></ul></li><li><strong>ä½¿ç”¨ DNS è·å– Eureka-Server URL ç›¸å…³</strong><ul><li><code>#shouldUseDnsForFetchingServiceUrls()</code> ï¼šæ˜¯å¦ä½¿ç”¨ DNS æ–¹å¼è·å– Eureka-Server URL åœ°å€ã€‚</li><li><code>#getEurekaServerDNSName()</code> ï¼šEureka-Server çš„ DNS åã€‚</li><li><code>#getEurekaServerPort()</code> ï¼šEureka-Server çš„ç«¯å£ã€‚</li><li><code>#getEurekaServerURLContext()</code> ï¼šEureka-Server çš„ URL Context ã€‚</li><li><code>#getEurekaServiceUrlPollIntervalSeconds()</code> ï¼šè½®è¯¢è·å– Eureka-Server åœ°å€å˜æ›´é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚é»˜è®¤ï¼š300 ç§’ã€‚</li><li><code>#shouldPreferSameZoneEureka()</code> ï¼šä¼˜å…ˆä½¿ç”¨ç›¸åŒåŒº( <code>zone</code> )çš„ Eureka-Serverã€‚</li></ul></li><li><strong>ç›´æ¥é…åˆ Eureka-Server URL ç›¸å…³</strong><ul><li><code>#getEurekaServerServiceUrls()</code> ï¼š Eureka-Server çš„ URL é›†åˆã€‚</li></ul></li><li><strong>å‘ç°ï¼šä» Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ç›¸å…³</strong><ul><li><code>#shouldFetchRegistry()</code> ï¼šæ˜¯å¦ä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯ã€‚</li><li><code>#getRegistryFetchIntervalSeconds()</code> ï¼šä» Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚é»˜è®¤ï¼š30 ç§’ã€‚</li><li><code>#shouldFilterOnlyUpInstances()</code> ï¼šæ˜¯å¦è¿‡æ»¤ï¼Œåªè·å–çŠ¶æ€ä¸ºå¼€å¯( Up )çš„åº”ç”¨å¯¹è±¡é›†åˆã€‚</li><li><code>#fetchRegistryForRemoteRegions()</code> ï¼šè·å–å“ªäº›åŒºåŸŸ( <code>region</code> )é›†åˆçš„æ³¨å†Œä¿¡æ¯ã€‚</li><li><code>#getCacheRefreshExecutorThreadPoolSize()</code> ï¼šæ³¨å†Œä¿¡æ¯ç¼“å­˜åˆ·æ–°çº¿ç¨‹æ± å¤§å°ã€‚</li><li><code>#getCacheRefreshExecutorExponentialBackOffBound()</code> ï¼šæ³¨å†Œä¿¡æ¯ç¼“å­˜åˆ·æ–°æ‰§è¡Œè¶…æ—¶åçš„å»¶è¿Ÿé‡è¯•çš„æ—¶é—´ã€‚</li><li><code>#getRegistryRefreshSingleVipAddress()</code> ï¼šTODOã€1ã€‘vip</li></ul></li><li><strong>æ³¨å†Œï¼šå‘ Eureka-Server æ³¨å†Œè‡ªèº«æœåŠ¡</strong><ul><li><code>#shouldRegisterWithEureka()</code> ï¼šæ˜¯å¦å‘ Eureka-Server æ³¨å†Œè‡ªèº«æœåŠ¡ã€‚</li><li><code>#shouldUnregisterOnShutdown()</code> ï¼šæ˜¯å¦å‘ Eureka-Server å–æ¶ˆæ³¨å†Œè‡ªèº«æœåŠ¡ï¼Œå½“è¿›ç¨‹å…³é—­æ—¶ã€‚</li><li><code>#getInstanceInfoReplicationIntervalSeconds()</code> ï¼šå‘ Eureka-Server åŒæ­¥åº”ç”¨å¯¹è±¡ä¿¡æ¯å˜åŒ–é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getInitialInstanceInfoReplicationIntervalSeconds()</code> ï¼šå‘ Eureka-Server åŒæ­¥åº”ç”¨ä¿¡æ¯å˜åŒ–åˆå§‹åŒ–å»¶è¿Ÿï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getBackupRegistryImpl()</code> ï¼šè·å–å¤‡ä»½æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚å½“ Eureka-Client å¯åŠ¨æ—¶ï¼Œæ— æ³•ä» Eureka-Server è¯»å–æ³¨å†Œä¿¡æ¯ï¼ˆå¯èƒ½æŒ‚äº†ï¼‰ï¼Œä»å¤‡ä»½æ³¨å†Œä¸­å¿ƒè¯»å–æ³¨å†Œä¿¡æ¯ã€‚ç›®å‰ Eureka-Client æœªæä¾›åˆé€‚çš„å®ç°ã€‚</li><li><code>#getHeartbeatExecutorThreadPoolSize()</code> ï¼šå¿ƒè·³æ‰§è¡Œçº¿ç¨‹æ± å¤§å°ã€‚</li><li><code>#getHeartbeatExecutorExponentialBackOffBound()</code> ï¼šå¿ƒè·³æ‰§è¡Œè¶…æ—¶åçš„å»¶è¿Ÿé‡è¯•çš„æ—¶é—´ã€‚</li></ul></li></ul><h2 id="2-3-DefaultEurekaClientConfig"><a href="#2-3-DefaultEurekaClientConfig" class="headerlink" title="2.3 DefaultEurekaClientConfig"></a>2.3 DefaultEurekaClientConfig</h2><p><code>com.netflix.discovery.DefaultEurekaClientConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„ <strong>Eureka-Client</strong> é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaClientConfig</span> <span class="keyword">implements</span> <span class="title">EurekaClientConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ZONE = <span class="string">"defaultZone"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namespace;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * HTTP ä¼ è¾“é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaTransportConfig transportConfig;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaClientConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="comment">// è®¾ç½® namespaceï¼Œä¸º "." ç»“å°¾</span></div><div class="line">        <span class="keyword">this</span>.namespace = namespace.endsWith(<span class="string">"."</span>)</div><div class="line">                ? namespace</div><div class="line">                : namespace + <span class="string">"."</span>;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.configInstance = Archaius1Utils.initConfig(CommonConstants.CONFIG_FILE_NAME);</div><div class="line">        <span class="comment">// åˆ›å»º HTTP ä¼ è¾“é…ç½®</span></div><div class="line">        <span class="keyword">this</span>.transportConfig = <span class="keyword">new</span> DefaultEurekaTransportConfig(namespace, configInstance);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç±»ä¼¼ PropertiesInstanceConfigï¼Œç‚¹å‡»<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æŸ¥çœ‹è¯¦ç»†è§£æã€‚</li><li>åœ¨ <code>com.netflix.discovery.PropertyBasedClientConfigConstants</code> å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY ã€‚</li><li><code>transportConfig</code> å±æ€§ï¼Œåœ¨ <a href="#">ã€Œ3. EurekaTransportConfigã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2 id="2-4-DefaultEurekaClientConfigProvider"><a href="#2-4-DefaultEurekaClientConfigProvider" class="headerlink" title="2.4 DefaultEurekaClientConfigProvider"></a>2.4 DefaultEurekaClientConfigProvider</h2><p><code>com.netflix.discovery.providers.DefaultEurekaClientConfigProvider</code>ï¼Œåˆ›å»º DefaultEurekaClientConfig çš„å·¥å‚ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaClientConfigProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">EurekaClientConfig</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span>(optional = <span class="keyword">true</span>)</div><div class="line">    <span class="meta">@EurekaNamespace</span></div><div class="line">    <span class="keyword">private</span> String namespace;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DefaultEurekaClientConfig config;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> EurekaClientConfig <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</div><div class="line">            config = (namespace == <span class="keyword">null</span>)</div><div class="line">                    ? <span class="keyword">new</span> DefaultEurekaClientConfig()</div><div class="line">                    : <span class="keyword">new</span> DefaultEurekaClientConfig(namespace);</div><div class="line">                    </div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> Remove this when DiscoveryManager is finally no longer used</span></div><div class="line">            DiscoveryManager.getInstance().setEurekaClientConfig(config);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> config;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="2-5-å°ç»“"><a href="#2-5-å°ç»“" class="headerlink" title="2.5 å°ç»“"></a>2.5 å°ç»“</h2><p>æ¨èå‚è€ƒé˜…è¯»ï¼š</p><ul><li><a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ç¨‹åºçŒ¿DD â€”â€” ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a> Spring Cloud Eureka â€”â€” é…ç½®è¯¦è§£</li><li><a href="http://www.cnblogs.com/fangfuhai/p/7070325.html" rel="external nofollow noopener noreferrer" target="_blank">é£ä¸­ç¨‹åºçŒ¿ â€”â€” ã€Šå¾®æœåŠ¡æ¶æ„ï¼šEurekaå‚æ•°é…ç½®é¡¹è¯¦è§£ã€‹</a></li></ul><h1 id="3-EurekaTransportConfig"><a href="#3-EurekaTransportConfig" class="headerlink" title="3. EurekaTransportConfig"></a>3. EurekaTransportConfig</h1><h2 id="3-1-ç±»å…³ç³»å›¾"><a href="#3-1-ç±»å…³ç³»å›¾" class="headerlink" title="3.1 ç±»å…³ç³»å›¾"></a>3.1 ç±»å…³ç³»å›¾</h2><p>EurekaTransportConfig æ•´ä½“ç±»å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_22/05.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ<strong>çº¢åœˆ</strong>éƒ¨åˆ†ç±»ã€‚</li><li>EurekaArchaius2TransportConfig åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 2.x</a> å®ç°ï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li></ul><h2 id="3-2-é…ç½®å±æ€§"><a href="#3-2-é…ç½®å±æ€§" class="headerlink" title="3.2 é…ç½®å±æ€§"></a>3.2 é…ç½®å±æ€§</h2><p>TODO åé¢çœ‹åˆ°é‚£éƒ¨åˆ†æºç åœ¨è¡¥å……ï¼Œæ²¡ç†é¡ºã€‚</p><h2 id="3-3-DefaultEurekaTransportConfig"><a href="#3-3-DefaultEurekaTransportConfig" class="headerlink" title="3.3 DefaultEurekaTransportConfig"></a>3.3 DefaultEurekaTransportConfig</h2><p><code>com.netflix.discovery.shared.transport.DefaultEurekaTransportConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„<strong>ç½‘ç»œä¼ è¾“</strong>é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaTransportConfig</span> <span class="keyword">implements</span> <span class="title">EurekaTransportConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUB_NAMESPACE = TRANSPORT_CONFIG_SUB_NAMESPACE + <span class="string">"."</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namespace;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaTransportConfig</span><span class="params">(String parentNamespace, DynamicPropertyFactory configInstance)</span> </span>&#123;</div><div class="line">        <span class="comment">// å‘½åç©ºé—´</span></div><div class="line">        <span class="keyword">this</span>.namespace = parentNamespace == <span class="keyword">null</span></div><div class="line">                ? SUB_NAMESPACE</div><div class="line">                : (parentNamespace.endsWith(<span class="string">"."</span>)</div><div class="line">                    ? parentNamespace + SUB_NAMESPACE</div><div class="line">                    : parentNamespace + <span class="string">"."</span> + SUB_NAMESPACE);</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.configInstance = configInstance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç±»ä¼¼ PropertiesInstanceConfigï¼Œç‚¹å‡»<a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfigã€‹ã€Œ2.4 PropertiesInstanceConfigã€</a>æŸ¥çœ‹è¯¦ç»†è§£æã€‚</li><li>åœ¨ <code>com.netflix.discovery.shared.transport.PropertyBasedTransportConfigConstants</code> å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¶‰åŠåˆ°é…ç½®ï¼Œå†…å®¹åˆçœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¤šï¼Œæ…¢æ…¢ç†è§£åï¼Œå°±ä¼šå˜å¾—å¾ˆâ€œå•°å—¦â€ï¼Œè¯·ä¿æŒè€å¿ƒã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Eureka/eureka-client-init-second/&quot;&gt;http://www.iocoder.cn/Eureka/eureka-client-init-second/&lt;/a&gt; ã€ŒèŠ‹
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” Eureka-Client åˆå§‹åŒ–ï¼ˆä¸€ï¼‰ä¹‹ EurekaInstanceConfig</title>
    <link href="http://www.iocoder.cn/Eureka/eureka-client-init-first/"/>
    <id>http://www.iocoder.cn/Eureka/eureka-client-init-first/</id>
    <published>2018-04-14T16:00:00.000Z</published>
    <updated>2017-09-29T17:28:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/eureka-client-init-first/">http://www.iocoder.cn/Eureka/eureka-client-init-first/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong> </p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-eurekainstanceconfig">2. EurekaInstanceConfig</a><ul><li><a href="#21-%E7%B1%BB%E5%85%B3%E7%B3%BB%E5%9B%BE">2.1 ç±»å…³ç³»å›¾</a></li><li><a href="#22-%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7">2.2 é…ç½®å±æ€§</a></li><li><a href="#23-abstractinstanceconfig">2.3 AbstractInstanceConfig</a></li><li><a href="#24-propertiesinstanceconfig">2.4 PropertiesInstanceConfig</a></li><li><a href="#25-mydatacenterinstanceconfig">2.5 MyDataCenterInstanceConfig</a></li><li><a href="#26-%E5%B0%8F%E7%BB%93">2.6 å°ç»“</a></li></ul></li><li><a href="#3-instanceinfo">3. InstanceInfo</a></li><li><a href="#4-applicationinfomanager">4. ApplicationInfoManager</a></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Client è‡ªèº«åˆå§‹åŒ–çš„è¿‡ç¨‹</strong>ï¼Œä¸åŒ…å« Eureka-Client å‘ Eureka-Server çš„æ³¨å†Œè¿‡ç¨‹( ğŸ™‚åé¢ä¼šå¦å¤–æ–‡ç« åˆ†äº« )ã€‚</p><p>Eureka-Client è‡ªèº«åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ä¸»è¦å¯¹è±¡å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/01.png" alt=""></p><ol><li><strong>åˆ›å»º</strong> EurekaInstanceConfigå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ <strong>åˆ›å»º</strong> InstanceInfoå¯¹è±¡</li><li>ä½¿ç”¨ EurekaInstanceConfigå¯¹è±¡ + InstanceInfoå¯¹è±¡ <strong>åˆ›å»º</strong> ApplicationInfoManagerå¯¹è±¡</li><li><strong>åˆ›å»º</strong> EurekaClientConfigå¯¹è±¡</li><li>ä½¿ç”¨ ApplicationInfoManagerå¯¹è±¡ + EurekaClientConfigå¯¹è±¡ <strong>åˆ›å»º</strong> EurekaClientå¯¹è±¡</li></ol><p>è€ƒè™‘åˆ°æ•´ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­æ¶‰åŠçš„é…ç½®ç‰¹åˆ«å¤šï¼Œæ‹†åˆ†æˆä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li><strong>ã€æœ¬æ–‡ã€‘</strong>ï¼ˆä¸€ï¼‰EurekaInstanceConfig</li><li>ï¼ˆäºŒï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-second/">EurekaClientConfig</a></li><li>ï¼ˆä¸‰ï¼‰<a href="http://www.iocoder.cn/Eureka/eureka-client-init-third/">EurekaClient</a></li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ª<strong>ç±»</strong>çš„å®ç°ã€‚</p><h1 id="2-EurekaInstanceConfig"><a href="#2-EurekaInstanceConfig" class="headerlink" title="2. EurekaInstanceConfig"></a>2. EurekaInstanceConfig</h1><p><code>com.netflix.appinfo.EurekaInstanceConfig</code>ï¼ŒEureka <strong>åº”ç”¨å¯¹è±¡</strong>é…ç½®<strong>æ¥å£</strong>ã€‚åœ¨ä¸‹æ–‡ä½ ä¼šçœ‹åˆ° EurekaClientConfig <strong>æ¥å£</strong>ï¼Œä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>EurekaInstanceConfigï¼Œé‡åœ¨<strong>åº”ç”¨å¯¹è±¡</strong>ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨åã€åº”ç”¨çš„ç«¯å£ç­‰ç­‰ã€‚æ­¤å¤„åº”ç”¨æŒ‡çš„æ˜¯ï¼ŒApplication Consumer å’Œ Application Providerã€‚</li><li>EurekaClientConfigï¼Œé‡åœ¨ <strong>Eureka-Client</strong>ï¼Œä¾‹å¦‚ï¼Œ è¿æ¥çš„ Eureka-Server çš„åœ°å€ã€è·å–æœåŠ¡æä¾›è€…åˆ—è¡¨çš„é¢‘ç‡ã€æ³¨å†Œè‡ªèº«ä¸ºæœåŠ¡æä¾›è€…çš„é¢‘ç‡ç­‰ç­‰ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/02.jpeg" alt=""></p><h2 id="2-1-ç±»å…³ç³»å›¾"><a href="#2-1-ç±»å…³ç³»å›¾" class="headerlink" title="2.1 ç±»å…³ç³»å›¾"></a>2.1 ç±»å…³ç³»å›¾</h2><p>EurekaInstanceConfig æ•´ä½“ç±»å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_15/03.png" alt=""></p><ul><li>æœ¬æ–‡åªè§£æ<strong>çº¢åœˆ</strong>éƒ¨åˆ†ç±»ã€‚</li><li>EurekaArchaius2ClientConfig åŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 2.x</a> å®ç°ï¼Œç›®å‰è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li><li>CloudInstanceConfigã€Ec2EurekaArchaius2InstanceConfig åŸºäºäºšé©¬é€Š AWSï¼Œå¤§å¤šæ•°è¯»è€…å’Œæˆ‘å¯¹ AWS éƒ½ä¸äº†è§£ï¼Œå› æ­¤æš‚ä¸è§£æã€‚</li></ul><h2 id="2-2-é…ç½®å±æ€§"><a href="#2-2-é…ç½®å±æ€§" class="headerlink" title="2.2 é…ç½®å±æ€§"></a>2.2 é…ç½®å±æ€§</h2><p>ç‚¹å‡» <a href="TODOTODO">EurekaInstanceConfig</a> æŸ¥çœ‹é…ç½®å±æ€§ç®€ä»‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œå¯ä»¥å¯¹ç…§ç€è‹±æ–‡æ³¨é‡Šä¸€èµ·ç†è§£ã€‚è¿™é‡Œç¬”è€…æ‘˜å‡ºéƒ¨åˆ†è¾ƒä¸ºé‡è¦çš„å±æ€§ï¼š</p><ul><li><code>#getLeaseRenewalIntervalInSeconds()</code> ï¼šç§Ÿçº¦ç»­çº¦é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚åº”ç”¨ä¸æ–­é€šè¿‡æŒ‰ç…§è¯¥é¢‘ç‡å‘é€å¿ƒè·³ç»™ Eureka-Server ä»¥è¾¾åˆ°ç»­çº¦çš„ä½œç”¨ã€‚å½“ Eureka-Server è¶…è¿‡æœ€å¤§é¢‘ç‡æœªæ”¶åˆ°ç»­çº¦ï¼ˆå¿ƒè·³ï¼‰ï¼Œå¥‘çº¦å¤±æ•ˆï¼Œè¿›è¡Œåº”ç”¨ç§»é™¤ã€‚åº”ç”¨ç§»é™¤åï¼Œå…¶ä»–åº”ç”¨æ— æ³•ä» Eureka-Server è·å–è¯¥åº”ç”¨ã€‚</li><li><code>#getLeaseExpirationDurationInSeconds()</code> ï¼šå¥‘çº¦è¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li><li><p><code>#getDataCenterInfo()</code> ï¼šæ•°æ®ä¸­å¿ƒä¿¡æ¯ã€‚<code>com.netflix.appinfo.DataCenterInfo</code>ï¼Œæ•°æ®ä¸­å¿ƒä¿¡æ¯<strong>æ¥å£</strong>ï¼Œç›®å‰è¾ƒä¸ºç®€å•ï¼Œæ ‡è®°æ‰€å±æ•°æ®ä¸­å¿ƒåã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Name.MyOwn</code>ã€‚æ¥å£å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataCenterInfo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒåæšä¸¾</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">enum</span> Name &#123;</div><div class="line">        Netflix,</div><div class="line">        Amazon,</div><div class="line">        MyOwn</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å½’å±çš„æ•°æ®ä¸­å¿ƒå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Name <span class="title">getName</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p><code>#getNamespace()</code> ï¼šé…ç½®å‘½åç©ºé—´ï¼Œé»˜è®¤ä½¿ç”¨ <code>eureka</code>ã€‚ä»¥ <code>eureka-client.properties</code> ä¸¾ä¸ªä¾‹å­ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">eureka.name=eureka</div><div class="line">eureka.port=<span class="number">8080</span></div><div class="line">eureka.vipAddress=eureka.mydomain.net</div></pre></td></tr></table></figure><ul><li>æ¯ä¸ªå±æ€§<strong>æœ€å‰é¢</strong>çš„ <code>eureka</code> å³æ˜¯é…ç½®å‘½åç©ºé—´ï¼Œä¸€èˆ¬æƒ…å†µæ— éœ€ä¿®æ”¹ã€‚</li></ul></li><li><p>TODO å¥åº·æ£€æŸ¥</p></li><li>TODO getDefaultAddressResolutionOrder</li><li>TODO isInstanceEnabledOnit</li></ul><h2 id="2-3-AbstractInstanceConfig"><a href="#2-3-AbstractInstanceConfig" class="headerlink" title="2.3 AbstractInstanceConfig"></a>2.3 AbstractInstanceConfig</h2><p><code>com.netflix.appinfo.AbstractInstanceConfig</code>ï¼ŒEureka <strong>åº”ç”¨å¯¹è±¡</strong>é…ç½®<strong>æŠ½è±¡åŸºç±»</strong>ï¼Œä¸»è¦å®ç°ä¸€äº›ç›¸å¯¹<strong>é€šç”¨</strong>çš„é…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¥‘çº¦è¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LEASE_EXPIRATION_DURATION_SECONDS = <span class="number">90</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç§Ÿçº¦ç»­çº¦é¢‘ç‡ï¼Œå•ä½ï¼šç§’ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LEASE_RENEWAL_INTERVAL_SECONDS = <span class="number">30</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ https ç«¯å£å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SECURE_PORT_ENABLED = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ http ç«¯å£å¼€å¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> NON_SECURE_PORT_ENABLED = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ http ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NON_SECURE_PORT = <span class="number">80</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨ https ç«¯å£</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SECURE_PORT = <span class="number">443</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨åˆå§‹åŒ–åå¼€å¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> INSTANCE_ENABLED_ON_INIT = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœºä¿¡æ¯</span></div><div class="line"><span class="comment">     * keyï¼šä¸»æœº IP åœ°å€</span></div><div class="line"><span class="comment">     * valueï¼šä¸»æœºå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pair&lt;String, String&gt; hostInfo = getHostInfo();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®ä¸­å¿ƒä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> DataCenterInfo info = <span class="keyword">new</span> DataCenterInfo() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Name <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Name.MyOwn;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Pair&lt;String, String&gt; <span class="title">getHostInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        Pair&lt;String, String&gt; pair;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            InetAddress localHost = InetAddress.getLocalHost();</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(localHost.getHostAddress(), localHost.getHostName());</div><div class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</div><div class="line">            logger.error(<span class="string">"Cannot get host info"</span>, e);</div><div class="line">            pair = <span class="keyword">new</span> Pair&lt;String, String&gt;(<span class="string">""</span>, <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> pair;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// .... çœç•¥ setting / getting æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#getHostInfo()</code> æ–¹æ³•ï¼Œè·å–æœ¬åœ°æœåŠ¡å™¨çš„ä¸»æœºåå’Œä¸»æœº IP åœ°å€ã€‚<strong>å¦‚æœä¸»æœºæœ‰å¤šç½‘å¡æˆ–è€…è™šæ‹Ÿæœºç½‘å¡</strong>ï¼Œè¿™å—è¦å°å¿ƒï¼Œè§£å†³æ–¹å¼å¦‚ä¸‹ï¼š<ul><li>æ‰‹åŠ¨é…ç½®æœ¬æœºçš„ <code>hostname</code> + <code>etc/hosts</code> æ–‡ä»¶ï¼Œä»è€Œæ˜ å°„ä¸»æœºåå’Œ IP åœ°å€ã€‚</li><li>ä½¿ç”¨ Spring-Cloud-Eureka-Client çš„è¯ï¼Œå‚è€ƒ<a href="http://www.itmuch.com/spring-cloud-code-read/spring-cloud-code-read-eureka-registry-ip/?from=www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">å‘¨ç«‹ â€”â€” ã€ŠEurekaæœåŠ¡æ³¨å†Œè¿‡ç¨‹è¯¦è§£ä¹‹IpAddressã€‹</a>è§£å†³ã€‚</li></ul></li></ul><h2 id="2-4-PropertiesInstanceConfig"><a href="#2-4-PropertiesInstanceConfig" class="headerlink" title="2.4 PropertiesInstanceConfig"></a>2.4 PropertiesInstanceConfig</h2><p><code>com.netflix.appinfo.PropertiesInstanceConfig</code>ï¼ŒåŸºäº<strong>é…ç½®æ–‡ä»¶</strong>çš„ Eureka <strong>åº”ç”¨å¯¹è±¡</strong>é…ç½®<strong>æŠ½è±¡åŸºç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesInstanceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‘½åç©ºé—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String namespace;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨åˆ†ç»„</span></div><div class="line"><span class="comment">     * ä» ç¯å¢ƒå˜é‡ è·å–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String appGrpNameFromEnv;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertiesInstanceConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(CommonConstants.DEFAULT_CONFIG_NAMESPACE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertiesInstanceConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(namespace, <span class="keyword">new</span> DataCenterInfo() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Name <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> Name.MyOwn;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertiesInstanceConfig</span><span class="params">(String namespace, DataCenterInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(info);</div><div class="line">        <span class="comment">// è®¾ç½® namespaceï¼Œä¸º "." ç»“å°¾</span></div><div class="line">        <span class="keyword">this</span>.namespace = namespace.endsWith(<span class="string">"."</span>)</div><div class="line">                ? namespace</div><div class="line">                : namespace + <span class="string">"."</span>;</div><div class="line">        <span class="comment">// ä» ç¯å¢ƒå˜é‡ è·å– åº”ç”¨åˆ†ç»„</span></div><div class="line">        appGrpNameFromEnv = ConfigurationManager.getConfigInstance()</div><div class="line">                .getString(FALLBACK_APP_GROUP_KEY, Values.UNKNOWN_APPLICATION);</div><div class="line">        <span class="comment">// åˆå§‹åŒ– é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.configInstance = Archaius1Utils.initConfig(CommonConstants.CONFIG_FILE_NAME);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> configInstance.getStringProperty(namespace + APP_GROUP_KEY, appGrpNameFromEnv).get().trim();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>configInstance</code> å±æ€§ï¼Œé…ç½®æ–‡ä»¶å¯¹è±¡ï¼ŒåŸºäº <a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Netflix Archaius 1.x</a> å®ç°é…ç½®æ–‡ä»¶çš„è¯»å–ã€‚åœ¨ <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/PropertyBasedInstanceConfigConstants.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.PropertyBasedInstanceConfigConstants</code></a> å¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶çš„æ¯ä¸ªå±æ€§ KEY ã€‚</li><li><p><code>appGrpNameFromEnv</code> å±æ€§ï¼Œåº”ç”¨åˆ†ç»„ï¼Œä»<strong>ç¯å¢ƒå˜é‡</strong>ä¸­è·å–ã€‚ä» <code>#getAppGroupName()</code> æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¼˜å…ˆè¿˜æ˜¯ä»é…ç½®æ–‡ä»¶è¯»å–ã€‚è®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">System.setProperty(FALLBACK_APP_GROUP_KEY, <span class="string">"app_gropu_name"</span>);</div></pre></td></tr></table></figure><ul><li><code>FALLBACK_APP_GROUP_KEY</code>ï¼Œç§æœ‰é™æ€å˜é‡ï¼Œå®é™…å¾—ä½¿ç”¨ <code>NETFLIX_APP_GROUP</code>ã€‚</li><li><code>com.netflix.config.ConfigurationManager</code> å¯ä»¥ä»<strong>ç¯å¢ƒå˜é‡</strong>è·å–åˆ°å€¼ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>Archaius1Utils#initConfig(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–è¯»å–çš„é…ç½®æ–‡ä»¶å¯¹è±¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Archaius1Utils</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(Archaius1Utils.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARCHAIUS_DEPLOYMENT_ENVIRONMENT = <span class="string">"archaius.deployment.environment"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EUREKA_ENVIRONMENT = <span class="string">"eureka.environment"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DynamicPropertyFactory <span class="title">initConfig</span><span class="params">(String configName)</span> </span>&#123;</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶å¯¹è±¡</span></div><div class="line">        DynamicPropertyFactory configInstance = DynamicPropertyFactory.getInstance();</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶å</span></div><div class="line">        DynamicStringProperty EUREKA_PROPS_FILE = configInstance.getStringProperty(<span class="string">"eureka.client.props"</span>, configName);</div><div class="line">        <span class="comment">// é…ç½®æ–‡ä»¶ç¯å¢ƒ</span></div><div class="line">        String env = ConfigurationManager.getConfigInstance().getString(EUREKA_ENVIRONMENT, <span class="string">"test"</span>);</div><div class="line">        ConfigurationManager.getConfigInstance().setProperty(ARCHAIUS_DEPLOYMENT_ENVIRONMENT, env);</div><div class="line">        <span class="comment">// å°†é…ç½®æ–‡ä»¶åŠ è½½åˆ°ç¯å¢ƒå˜é‡</span></div><div class="line">        String eurekaPropsFile = EUREKA_PROPS_FILE.get();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ConfigurationManager.loadCascadedPropertiesFromResources(eurekaPropsFile);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.warn(</div><div class="line">                    <span class="string">"Cannot find the properties specified : &#123;&#125;. This may be okay if there are other environment "</span></div><div class="line">                            + <span class="string">"specific properties or the configuration is installed with a different mechanism."</span>,</div><div class="line">                    eurekaPropsFile);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> configInstance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»ç¯å¢ƒå˜é‡ <code>eureka.client.props</code>ï¼Œè·å–é…ç½®æ–‡ä»¶åã€‚å¦‚æœæœªé…ç½®ï¼Œä½¿ç”¨å‚æ•° <code>configName</code>ï¼Œå³ <code>CommonConstants.CONFIG_FILE_NAME</code> ( <code>&quot;eureka-client&quot;</code> )ã€‚</li><li>ä»ç¯å¢ƒå˜é‡ <code>eureka.environment</code> ( EUREKA_ENVIRONMENT )ï¼Œè·å–é…ç½®æ–‡ä»¶ç¯å¢ƒã€‚</li><li>è°ƒç”¨ <code>ConfigurationManager#loadCascadedPropertiesFromResources(...)</code> æ–¹æ³•ï¼Œè¯»å–é…ç½®æ–‡ä»¶åˆ°ç¯å¢ƒå˜é‡ï¼Œé¦–å…ˆè¯»å– <code>${eureka.client.props}</code> å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼›ç„¶åè¯»å– <code>${eureka.client.props}-${eureka.environment}</code> å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚è‹¥æœ‰ç›¸åŒå±æ€§ï¼Œè¿›è¡Œè¦†ç›–ã€‚</li></ul></li></ul><h2 id="2-5-MyDataCenterInstanceConfig"><a href="#2-5-MyDataCenterInstanceConfig" class="headerlink" title="2.5 MyDataCenterInstanceConfig"></a>2.5 MyDataCenterInstanceConfig</h2><p><code>com.netflix.appinfo.MyDataCenterInstanceConfig</code>ï¼Œé AWS æ•°æ®ä¸­å¿ƒçš„ Eureka <strong>åº”ç”¨å¯¹è±¡</strong>é…ç½®<strong>å®ç°ç±»</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDataCenterInstanceConfig</span> <span class="keyword">extends</span> <span class="title">PropertiesInstanceConfig</span> <span class="keyword">implements</span> <span class="title">EurekaInstanceConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataCenterInstanceConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataCenterInstanceConfig</span><span class="params">(String namespace)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(namespace);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataCenterInstanceConfig</span><span class="params">(String namespace, DataCenterInfo dataCenterInfo)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(namespace, dataCenterInfo);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="2-6-å°ç»“"><a href="#2-6-å°ç»“" class="headerlink" title="2.6 å°ç»“"></a>2.6 å°ç»“</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨ MyDataCenterInstanceConfig é…ç½® Eureka åº”ç”¨å¯¹è±¡ã€‚</p><p>åœ¨ Spring-Cloud-Eureka é‡Œï¼Œ<strong>ç›´æ¥</strong>åŸºäº EurekaInstanceConfig æ¥å£é‡æ–°å®ç°äº†é…ç½®ç±»ï¼Œå®é™…é€»è¾‘å·®åˆ«ä¸å¤§ï¼Œåœ¨<a href="#">ã€ŠTODO æ ‡é¢˜å¾…å®šã€‹</a>è¯¦ç»†è§£æã€‚</p><h1 id="3-InstanceInfo"><a href="#3-InstanceInfo" class="headerlink" title="3. InstanceInfo"></a>3. InstanceInfo</h1><p><code>com.netflix.appinfo.InstanceInfo</code>ï¼Œ<strong>åº”ç”¨å¯¹è±¡</strong>ä¿¡æ¯ã€‚Eureka-Client å‘ Eureka-Server <strong>æ³¨å†Œ</strong>è¯¥å¯¹è±¡ä¿¡æ¯ã€‚æ³¨å†ŒæˆåŠŸåï¼Œå¯ä»¥è¢«å…¶ä»– Eureka-Client <strong>å‘ç°</strong>ã€‚</p><p><strong>æœ¬æ–‡ä»…åˆ†äº« InstanceInfo çš„åˆå§‹åŒ–</strong>ã€‚InstanceInfo é‡Œå’Œæ³¨å†Œå‘ç°ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•ï¼Œæš‚æ—¶è·³è¿‡ã€‚</p><p><code>com.netflix.appinfo.providers.EurekaConfigBasedInstanceInfoProvider</code>ï¼ŒåŸºäº EurekaInstanceConfig åˆ›å»º InstanceInfo çš„å·¥å‚ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="meta">@Singleton</span></div><div class="line">  <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConfigBasedInstanceInfoProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">InstanceInfo</span>&gt; </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(EurekaConfigBasedInstanceInfoProvider.class);</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">final</span> EurekaInstanceConfig config;</div><div class="line">  <span class="number">6</span>: </div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> InstanceInfo instanceInfo;</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="meta">@Inject</span>(optional = <span class="keyword">true</span>)</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> VipAddressResolver vipAddressResolver = <span class="keyword">null</span>;</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:     <span class="meta">@Inject</span></div><div class="line"> <span class="number">13</span>:     <span class="function"><span class="keyword">public</span> <span class="title">EurekaConfigBasedInstanceInfoProvider</span><span class="params">(EurekaInstanceConfig config)</span> </span>&#123;</div><div class="line"> <span class="number">14</span>:         <span class="keyword">this</span>.config = config;</div><div class="line"> <span class="number">15</span>:     &#125;</div><div class="line"> <span class="number">16</span>: </div><div class="line"> <span class="number">17</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">18</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> InstanceInfo <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">if</span> (instanceInfo == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">20</span>:             <span class="comment">// Build the lease information to be passed to the server based on config</span></div><div class="line"> <span class="number">21</span>:             <span class="comment">// åˆ›å»º ç§Ÿçº¦ä¿¡æ¯æ„å»ºå™¨ï¼Œå¹¶è®¾ç½®å±æ€§</span></div><div class="line"> <span class="number">22</span>:             LeaseInfo.Builder leaseInfoBuilder = LeaseInfo.Builder.newBuilder()</div><div class="line"> <span class="number">23</span>:                     .setRenewalIntervalInSecs(config.getLeaseRenewalIntervalInSeconds())</div><div class="line"> <span class="number">24</span>:                     .setDurationInSecs(config.getLeaseExpirationDurationInSeconds());</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:             <span class="comment">// åˆ›å»º VIPåœ°å€è§£æå™¨</span></div><div class="line"> <span class="number">27</span>:             <span class="keyword">if</span> (vipAddressResolver == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">28</span>:                 vipAddressResolver = <span class="keyword">new</span> Archaius1VipAddressResolver();</div><div class="line"> <span class="number">29</span>:             &#125;</div><div class="line"> <span class="number">30</span>: </div><div class="line"> <span class="number">31</span>:             <span class="comment">// Builder the instance information to be registered with eureka server</span></div><div class="line"> <span class="number">32</span>:             <span class="comment">// åˆ›å»º åº”ç”¨å¯¹è±¡ä¿¡æ¯æ„å»ºå™¨</span></div><div class="line"> <span class="number">33</span>:             InstanceInfo.Builder builder = InstanceInfo.Builder.newBuilder(vipAddressResolver);</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:             <span class="comment">// åº”ç”¨å¯¹è±¡ç¼–å·</span></div><div class="line"> <span class="number">36</span>:             <span class="comment">// set the appropriate id for the InstanceInfo, falling back to datacenter Id if applicable, else hostname</span></div><div class="line"> <span class="number">37</span>:             String instanceId = config.getInstanceId();</div><div class="line"> <span class="number">38</span>:             DataCenterInfo dataCenterInfo = config.getDataCenterInfo();</div><div class="line"> <span class="number">39</span>:             <span class="keyword">if</span> (instanceId == <span class="keyword">null</span> || instanceId.isEmpty()) &#123;</div><div class="line"> <span class="number">40</span>:                 <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</div><div class="line"> <span class="number">41</span>:                     instanceId = ((UniqueIdentifier) dataCenterInfo).getId();</div><div class="line"> <span class="number">42</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">43</span>:                     instanceId = config.getHostName(<span class="keyword">false</span>);</div><div class="line"> <span class="number">44</span>:                 &#125;</div><div class="line"> <span class="number">45</span>:             &#125;</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:             <span class="comment">// è·å¾— ä¸»æœºå</span></div><div class="line"> <span class="number">48</span>:             String defaultAddress;</div><div class="line"> <span class="number">49</span>:             <span class="keyword">if</span> (config <span class="keyword">instanceof</span> RefreshableInstanceConfig) &#123;</div><div class="line"> <span class="number">50</span>:                 <span class="comment">// Refresh AWS data center info, and return up to date address</span></div><div class="line"> <span class="number">51</span>:                 defaultAddress = ((RefreshableInstanceConfig) config).resolveDefaultAddress(<span class="keyword">false</span>);</div><div class="line"> <span class="number">52</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">53</span>:                 defaultAddress = config.getHostName(<span class="keyword">false</span>);</div><div class="line"> <span class="number">54</span>:             &#125;</div><div class="line"> <span class="number">55</span>:             <span class="comment">// fail safe</span></div><div class="line"> <span class="number">56</span>:             <span class="keyword">if</span> (defaultAddress == <span class="keyword">null</span> || defaultAddress.isEmpty()) &#123;</div><div class="line"> <span class="number">57</span>:                 defaultAddress = config.getIpAddress();</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å¯¹è±¡ä¿¡æ¯æ„å»ºå™¨ çš„ å±æ€§</span></div><div class="line"> <span class="number">61</span>:             builder.setNamespace(config.getNamespace())</div><div class="line"> <span class="number">62</span>:                     .setInstanceId(instanceId)</div><div class="line"> <span class="number">63</span>:                     .setAppName(config.getAppname())</div><div class="line"> <span class="number">64</span>:                     .setAppGroupName(config.getAppGroupName())</div><div class="line"> <span class="number">65</span>:                     .setDataCenterInfo(config.getDataCenterInfo())</div><div class="line"> <span class="number">66</span>:                     .setIPAddr(config.getIpAddress())</div><div class="line"> <span class="number">67</span>:                     .setHostName(defaultAddress) <span class="comment">// ä¸»æœºå</span></div><div class="line"> <span class="number">68</span>:                     .setPort(config.getNonSecurePort())</div><div class="line"> <span class="number">69</span>:                     .enablePort(PortType.UNSECURE, config.isNonSecurePortEnabled())</div><div class="line"> <span class="number">70</span>:                     .setSecurePort(config.getSecurePort())</div><div class="line"> <span class="number">71</span>:                     .enablePort(PortType.SECURE, config.getSecurePortEnabled())</div><div class="line"> <span class="number">72</span>:                     .setVIPAddress(config.getVirtualHostName()) <span class="comment">// VIP åœ°å€</span></div><div class="line"> <span class="number">73</span>:                     .setSecureVIPAddress(config.getSecureVirtualHostName())</div><div class="line"> <span class="number">74</span>:                     .setHomePageUrl(config.getHomePageUrlPath(), config.getHomePageUrl())</div><div class="line"> <span class="number">75</span>:                     .setStatusPageUrl(config.getStatusPageUrlPath(), config.getStatusPageUrl())</div><div class="line"> <span class="number">76</span>:                     .setASGName(config.getASGName())</div><div class="line"> <span class="number">77</span>:                     .setHealthCheckUrls(config.getHealthCheckUrlPath(),</div><div class="line"> <span class="number">78</span>:                             config.getHealthCheckUrl(), config.getSecureHealthCheckUrl());</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:             <span class="comment">// TODO</span></div><div class="line"> <span class="number">81</span>:             <span class="comment">// Start off with the STARTING state to avoid traffic</span></div><div class="line"> <span class="number">82</span>:             <span class="keyword">if</span> (!config.isInstanceEnabledOnit()) &#123;</div><div class="line"> <span class="number">83</span>:                 InstanceStatus initialStatus = InstanceStatus.STARTING;</div><div class="line"> <span class="number">84</span>:                 LOG.info(<span class="string">"Setting initial instance status as: "</span> + initialStatus);</div><div class="line"> <span class="number">85</span>:                 builder.setStatus(initialStatus);</div><div class="line"> <span class="number">86</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">87</span>:                 LOG.info(<span class="string">"Setting initial instance status as: &#123;&#125;. This may be too early for the instance to advertise "</span></div><div class="line"> <span class="number">88</span>:                          + <span class="string">"itself as available. You would instead want to control this via a healthcheck handler."</span>,</div><div class="line"> <span class="number">89</span>:                          InstanceStatus.UP);</div><div class="line"> <span class="number">90</span>:             &#125;</div><div class="line"> <span class="number">91</span>: </div><div class="line"> <span class="number">92</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å¯¹è±¡ä¿¡æ¯æ„å»ºå™¨ çš„ å…ƒæ•°æ®( Metadata )é›†åˆ</span></div><div class="line"> <span class="number">93</span>:             <span class="comment">// Add any user-specific metadata information</span></div><div class="line"> <span class="number">94</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; mapEntry : config.getMetadataMap().entrySet()) &#123;</div><div class="line"> <span class="number">95</span>:                 String key = mapEntry.getKey();</div><div class="line"> <span class="number">96</span>:                 String value = mapEntry.getValue();</div><div class="line"> <span class="number">97</span>:                 builder.add(key, value);</div><div class="line"> <span class="number">98</span>:             &#125;</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:             <span class="comment">// åˆ›å»º åº”ç”¨å¯¹è±¡ä¿¡æ¯</span></div><div class="line"><span class="number">101</span>:             instanceInfo = builder.build();</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:             <span class="comment">// è®¾ç½® åº”ç”¨å¯¹è±¡ä¿¡æ¯ çš„ ç§Ÿçº¦ä¿¡æ¯</span></div><div class="line"><span class="number">104</span>:             instanceInfo.setLeaseInfo(leaseInfoBuilder.build());</div><div class="line"><span class="number">105</span>:         &#125;</div><div class="line"><span class="number">106</span>:         <span class="keyword">return</span> instanceInfo;</div><div class="line"><span class="number">107</span>:     &#125;</div><div class="line"><span class="number">108</span>: </div><div class="line"><span class="number">109</span>: &#125;</div></pre></td></tr></table></figure><ul><li>è¯¥ç±»å®ç° <code>javax.inject.Provider</code> æ¥å£ï¼Œè®¾ç½® InstanceInfo çš„ç”Ÿæˆå·¥å‚ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="http://blog.csdn.net/derekjiang/article/details/7231490" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle-Guiceå…¥é—¨ä»‹ç»ã€‹</a>æœç´¢ <strong>Provider</strong> å…³é”®å­—ã€‚ç›®å‰å¤„äº<strong>è¯•éªŒ</strong>é˜¶æ®µï¼Œæœªå®Œæˆã€‚</li><li><code>EurekaConfigBasedInstanceInfoProvider(config)</code> æ„é€ æ–¹æ³•ï¼Œè®¾ç½®ç”Ÿæˆ InstanceInfo çš„ EurekaInstanceConfig é…ç½®ã€‚</li><li><p>è°ƒç”¨ <code>#get()</code> æ–¹æ³•ï¼Œæ ¹æ® EurekaInstanceConfig åˆ›å»º InstanceInfoã€‚InstanceInfo çš„ç»å¤§æ•°å±æ€§å’Œ EurekaInstanceConfig æ˜¯ä¸€è‡´çš„ ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 21 è‡³ 24 è¡Œ ï¼šåˆ›å»ºç§Ÿçº¦ä¿¡æ¯æ„å»ºå™¨( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/LeaseInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.LeaseInfo.Builder</code></a> )ï¼Œå¹¶è®¾ç½® <code>renewalIntervalInSecs</code> / <code>durationInSecs</code> å±æ€§ã€‚</li><li><p>ç¬¬ 26 è‡³ 29 è¡Œ ï¼šåˆ›å»º VIPåœ°å€è§£æå™¨( <code>com.netflix.appinfo.providers.VipAddressResolver</code> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// VipAddressResolver.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">VipAddressResolver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">resolveDeploymentContextBasedVipAddresses</span><span class="params">(String vipAddressMacro)</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Archaius1VipAddressResolver</span> <span class="keyword">implements</span> <span class="title">VipAddressResolver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern VIP_ATTRIBUTES_PATTERN = Pattern.compile(<span class="string">"\\$\\&#123;(.*?)\\&#125;"</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">resolveDeploymentContextBasedVipAddresses</span><span class="params">(String vipAddressMacro)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (vipAddressMacro == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        String result = vipAddressMacro;</div><div class="line">        <span class="comment">// æ›¿æ¢è¡¨è¾¾å¼</span></div><div class="line">        Matcher matcher = VIP_ATTRIBUTES_PATTERN.matcher(result);</div><div class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">            String key = matcher.group(<span class="number">1</span>);</div><div class="line">            String value = DynamicPropertyFactory.getInstance().getStringProperty(key, <span class="string">""</span>).get();</div><div class="line"></div><div class="line">            logger.debug(<span class="string">"att:"</span> + matcher.group());</div><div class="line">            logger.debug(<span class="string">", att key:"</span> + key);</div><div class="line">            logger.debug(<span class="string">", att value:"</span> + value);</div><div class="line">            logger.debug(<span class="string">""</span>);</div><div class="line"></div><div class="line">            result = result.replaceAll(<span class="string">"\\$\\&#123;"</span> + key + <span class="string">"\\&#125;"</span>, value);</div><div class="line">            matcher = VIP_ATTRIBUTES_PATTERN.matcher(result);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>#resolveDeploymentContextBasedVipAddresses()</code> æ–¹æ³•ï¼Œå°† <strong>VIPåœ°å€</strong> é‡Œçš„ <code>${(.*?)}</code> æŸ¥æ‰¾é…ç½®æ–‡ä»¶é‡Œçš„é”®å€¼è¿›è¡Œæ›¿æ¢ã€‚ä¾‹å¦‚ï¼Œ<code>${eureka.env}.domain.com</code>ï¼ŒæŸ¥æ‰¾é…ç½®æ–‡ä»¶é‡Œçš„é”® <code>${eureka.env}</code> å¯¹åº”å€¼è¿›è¡Œæ›¿æ¢ã€‚TODOã€1ã€‘ï¼šè°ƒè¯•ä¸‹æ¥ï¼Œå‘ç° Archaius å·²ç»æ›¿æ¢ï¼Œç­‰åˆ°æ‰¾åˆ°ç­”æ¡ˆä¿®æ”¹æ­¤å¤„ã€‚</li></ul></li><li><p>ç¬¬ 32 è‡³ 33 è¡Œ ï¼šåˆ›å»ºåº”ç”¨å¯¹è±¡ä¿¡æ¯æ„å»ºå™¨( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.InstanceInfo.Builder</code></a> )ã€‚</p></li><li>ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè·å¾—åº”ç”¨å¯¹è±¡ç¼–å·( <code>instanceId</code> )ã€‚</li><li>ç¬¬ 47 è‡³ 58 è¡Œ ï¼šè·å¾—ä¸»æœºåã€‚</li><li>ç¬¬ 60 è‡³ 78 è¡Œ ï¼šè®¾ç½®åº”ç”¨å¯¹è±¡ä¿¡æ¯æ„å»ºå™¨çš„å±æ€§ã€‚</li><li>ç¬¬ 80 è‡³ 90 è¡Œ ï¼šTODOã€2ã€‘isInstanceEnabledOnit</li><li>ç¬¬ 92 è‡³ 98 è¡Œ ï¼šè®¾ç½®åº”ç”¨å¯¹è±¡ä¿¡æ¯æ„å»ºå™¨çš„å…ƒæ•°æ®( Metadata )é›†åˆã€‚</li><li>ç¬¬ 100 è‡³ 101 è¡Œ ï¼šåˆ›å»ºåº”ç”¨å¯¹è±¡ä¿¡æ¯( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.InstanceInfo</code></a> )ã€‚</li><li>ç¬¬ 103 è‡³ 104 è¡Œ ï¼šè®¾ç½®åº”ç”¨å¯¹è±¡ä¿¡æ¯çš„ç§Ÿçº¦ä¿¡æ¯( <a href="https://github.com/YunaiV/eureka/blob/671d7fc20bd6353040431d6e298eac5f82293497/eureka-client/src/main/java/com/netflix/appinfo/InstanceInfo.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.netflix.appinfo.InstanceInfo</code></a> )ã€‚</li></ul></li></ul><h1 id="4-ApplicationInfoManager"><a href="#4-ApplicationInfoManager" class="headerlink" title="4. ApplicationInfoManager"></a>4. ApplicationInfoManager</h1><p><code>com.netflix.appinfo.ApplicationInfoManager</code>ï¼Œåº”ç”¨ä¿¡æ¯ç®¡ç†å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationInfoManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationInfoManager instance = <span class="keyword">new</span> ApplicationInfoManager(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çŠ¶æ€å˜æ›´ç›‘å¬å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, StatusChangeListener&gt; listeners;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å¯¹è±¡çŠ¶æ€åŒ¹é…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstanceStatusMapper instanceStatusMapper;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å¯¹è±¡ä¿¡æ¯</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InstanceInfo instanceInfo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å¯¹è±¡é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> EurekaInstanceConfig config;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ„é€ æ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationInfoManager</span><span class="params">(EurekaInstanceConfig config, InstanceInfo instanceInfo, OptionalArgs optionalArgs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.config = config;</div><div class="line">        <span class="keyword">this</span>.instanceInfo = instanceInfo;</div><div class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> ConcurrentHashMap&lt;String, StatusChangeListener&gt;();</div><div class="line">        <span class="keyword">if</span> (optionalArgs != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.instanceStatusMapper = optionalArgs.getInstanceStatusMapper();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.instanceStatusMapper = NO_OP_MAPPER;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Hack to allow for getInstance() to use the DI'd ApplicationInfoManager</span></div><div class="line">        instance = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>listeners</code> å±æ€§ï¼ŒçŠ¶æ€å˜æ›´ç›‘å¬å™¨é›†åˆã€‚åœ¨<a href="#">ã€ŠTODO é¢˜ç›®å¾…å®šã€‹</a>è¯¦ç»†è§£æã€‚</li><li><code>instanceStatusMapper</code> å±æ€§ï¼Œåº”ç”¨å¯¹è±¡çŠ¶æ€åŒ¹é…ã€‚åœ¨<a href="#">ã€ŠTODO é¢˜ç›®å¾…å®šã€‹</a>è¯¦ç»†è§£æã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¶‰åŠåˆ°é…ç½®ï¼Œå†…å®¹åˆçœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¤šï¼Œæ…¢æ…¢ç†è§£åï¼Œå°±ä¼šå˜å¾—å¾ˆâ€œå•°å—¦â€ï¼Œè¯·ä¿æŒè€å¿ƒã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Eureka/eureka-client-init-first/&quot;&gt;http://www.iocoder.cn/Eureka/eureka-client-init-first/&lt;/a&gt; ã€ŒèŠ‹é“æº
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/Eureka/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/Eureka/build-debugging-environment/</id>
    <published>2018-04-07T16:00:00.000Z</published>
    <updated>2017-09-26T18:05:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/build-debugging-environment/">http://www.iocoder.cn/Eureka/build-debugging-environment/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong> </p><ul><li><a href="#">1. ä¾èµ–å·¥å…·</a></li><li><a href="#">2. æºç æ‹‰å–</a></li><li><a href="#">3. Eureka-Server å¯åŠ¨</a><ul><li><a href="#">3.1 MockRemoteEurekaServer</a></li><li><a href="#">3.2 Eureka-Server war åŒ…</a></li><li><a href="#">3.3 Eureka-Server ç›´æ¥å¯åŠ¨</a></li></ul></li><li><a href="#">4. Eureka-Client å¯åŠ¨</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-ä¾èµ–å·¥å…·"><a href="#1-ä¾èµ–å·¥å…·" class="headerlink" title="1. ä¾èµ–å·¥å…·"></a>1. ä¾èµ–å·¥å…·</h1><ul><li>Gradle</li><li>JDK</li><li>IntelliJ IDEA</li></ul><h1 id="2-æºç æ‹‰å–"><a href="#2-æºç æ‹‰å–" class="headerlink" title="2. æºç æ‹‰å–"></a>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/Netflix/eureka.git" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/eureka.git</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Gradle</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p><p>æœ¬æ–‡åŸºäº <code>master</code> åˆ†æ”¯ã€‚</p><h1 id="3-Eureka-Server-å¯åŠ¨"><a href="#3-Eureka-Server-å¯åŠ¨" class="headerlink" title="3. Eureka-Server å¯åŠ¨"></a>3. Eureka-Server å¯åŠ¨</h1><p>Eureka-Server å¯åŠ¨è°ƒè¯•æ–¹å¼ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼Œæˆ‘ä»¬æ¥å°è¯•æ¯ä¸€ç§ã€‚</p><h2 id="3-1-MockRemoteEurekaServer"><a href="#3-1-MockRemoteEurekaServer" class="headerlink" title="3.1 MockRemoteEurekaServer"></a>3.1 MockRemoteEurekaServer</h2><p><code>com.netflix.eureka.AbstractTester</code>ï¼Œæµ‹è¯•æŠ½è±¡ç±»ï¼Œæœ‰å¦‚ä¸‹å®ç°å­ç±»ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_08/01.png" alt=""></p><p>ä½¿ç”¨ä»»æ„ä¸€ä¸ªå­ç±»çš„å•å…ƒæµ‹è¯•æ‰§è¡Œå³å¯æ‰§è¡Œ Eureka-Server é€»è¾‘çš„è°ƒè¯•ï¼Œè¿™é‡Œä»¥ <code>com.netflix.eureka.resources.ApplicationsResourceTest</code> ä½œä¸ºä¾‹å­ã€‚</p><p>Debug è¿è¡Œ <code>ApplicationsResourceTest#testFullAppsGetJson()</code> å•å…ƒæµ‹è¯•ã€‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ï¼Œ<code>ApplicationsResourceTest#setUp()</code> ä¼šè¿è¡Œï¼Œåˆå§‹åŒ– Eureka-Server <strong>æ¨¡æ‹Ÿç¯å¢ƒ</strong>ï¼Œä¾‹å¦‚ï¼š<br><code>com.netflix.eureka.mock.MockRemoteEurekaServer</code> ( æ¨¡æ‹Ÿ Eureka-Server )ã€‚</p><p>å› ä¸ºæ˜¯<strong>æ¨¡æ‹Ÿç¯å¢ƒ</strong>ï¼Œå¯¹ Eureka-Server çš„æ“ä½œä¸æ˜¯ Eureka-Client è¯·æ±‚ Eureka-Server çš„æ–¹å¼ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨å•å…ƒæµ‹è¯•å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ApplicationsResourceTest.java</span></div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFullAppsGetJson</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   Response response = applicationsResource.getContainers(</div><div class="line">           Version.V2.name(),</div><div class="line">           MediaType.APPLICATION_JSON,</div><div class="line">           <span class="keyword">null</span>, <span class="comment">// encoding</span></div><div class="line">           EurekaAccept.full.name(),</div><div class="line">           <span class="keyword">null</span>,  <span class="comment">// uriInfo</span></div><div class="line">           <span class="keyword">null</span>  <span class="comment">// remote regions</span></div><div class="line">   );</div><div class="line"></div><div class="line">   String json = String.valueOf(response.getEntity());</div><div class="line">   DecoderWrapper decoder = CodecWrappers.getDecoder(CodecWrappers.LegacyJacksonJson.class);</div><div class="line"></div><div class="line">   Applications decoded = decoder.decode(json, Applications.class);</div><div class="line">   <span class="comment">// test per app as the full apps list include the mock server that is not part of the test apps</span></div><div class="line">   <span class="keyword">for</span> (Application application : testApplications.getRegisteredApplications()) &#123;</div><div class="line">       Application decodedApp = decoded.getRegisteredApplications(application.getName());</div><div class="line">       assertThat(EurekaEntityComparators.equal(application, decodedApp), is(<span class="keyword">true</span>));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç›´æ¥è°ƒç”¨ <code>ApplicationsResource#getContainers(...)</code> æ–¹æ³•ã€‚</li></ul><p><strong>æ€»ç»“</strong>ï¼šè¿™ç§æ–¹å¼ï¼Œç®€å•ç²—æš´ï¼Œå®¹æ˜“ä¸Šæ‰‹ã€‚å½“ç„¶ï¼Œå®ƒçš„ç¼ºç‚¹æ˜¯<strong>æ¨¡æ‹Ÿ</strong>ã€‚åˆšå¼€å§‹è°ƒè¯• Eureka-Server å¯ä»¥å°è¯•è¿™ç§æ–¹å¼ã€‚</p><h2 id="3-2-Eureka-Server-war-åŒ…"><a href="#3-2-Eureka-Server-war-åŒ…" class="headerlink" title="3.2 Eureka-Server war åŒ…"></a>3.2 Eureka-Server war åŒ…</h2><p>ç¬¬ä¸€æ­¥ï¼Œç¼–è¯‘ Eureka-Server war åŒ…ã€‚è¯¥æ­¥éª¤å¯èƒ½æ¶ˆè€—æ¼«é•¿çš„æ—¶é—´ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œè¯·ä¸æ–­é‡è¯•ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> eureka</div><div class="line">./gradlew clean build</div></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼ŒDebug è¿è¡Œ<code>com.netflix.eureka.resources.EurekaClientServerRestIntegrationTest</code> ä»»æ„å•å…ƒæµ‹è¯•æ–¹æ³•ã€‚</p><p><strong>æ€»ç»“</strong>ï¼šè¿™ç§æ–¹å¼ï¼Œç¼–è¯‘çš„è¿‡ç¨‹æ¯”è¾ƒç—›è‹¦ï¼Œä¸æ’é™¤å¤±è´¥çš„å¯èƒ½æ€§ã€‚æ¯æ¬¡å¢åŠ å¯¹ä»£ç çš„æ³¨å†Œåï¼Œéƒ½éœ€è¦é‡æ–°ç¼–è¯‘æ‰“åŒ…ã€‚å› æ­¤ä¸å»ºè®®é‡‡ç”¨ã€‚é‚£å’‹åŠå‘¢ï¼Ÿè§ç¬¬ä¸‰ç§ã€‚è‰¯å¿ƒå¦‚åšä¸»ï¼Œèµ¶ç´§å…³æ³¨åšä¸»çš„å¾®ä¿¡å…¬ä¼—å·ï¼šã€<strong>èŠ‹é“æºç </strong>ã€‘ã€‚</p><h2 id="3-3-Eureka-Server-ç›´æ¥å¯åŠ¨"><a href="#3-3-Eureka-Server-ç›´æ¥å¯åŠ¨" class="headerlink" title="3.3 Eureka-Server ç›´æ¥å¯åŠ¨"></a>3.3 Eureka-Server ç›´æ¥å¯åŠ¨</h2><p>ç¬¬ä¸€æ­¥ï¼Œä¿®æ”¹ <code>EurekaClientServerRestIntegrationTest#startServer()</code> æ–¹æ³•ï¼Œè§£å†³ç¬¬äºŒç§æ–¹å¼ä½¿ç”¨ war åŒ…è¿è¡Œæ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½éœ€è¦é‡æ–°ç¼–è¯‘çš„é—®é¢˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// EurekaClientServerRestIntegrationTest.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line"></div><div class="line">   <span class="comment">// TODO Thread.currentThread().getContextClassLoader() è·å–ä¸åˆ°è·¯å¾„ï¼Œå…ˆæš‚æ—¶è¿™æ ·ï¼›</span></div><div class="line">   WebAppContext webAppCtx = <span class="keyword">new</span> WebAppContext(<span class="keyword">new</span> File(<span class="string">"./eureka-server/src/main/webapp"</span>).getAbsolutePath(), <span class="string">"/"</span>);</div><div class="line">   webAppCtx.setDescriptor(<span class="keyword">new</span> File(<span class="string">"./eureka-server/src/main/webapp/WEB-INF/web.xml"</span>).getAbsolutePath());</div><div class="line">   webAppCtx.setResourceBase(<span class="keyword">new</span> File(<span class="string">"./eureka-server/src/main/resources"</span>).getAbsolutePath());</div><div class="line">   webAppCtx.setClassLoader(Thread.currentThread().getContextClassLoader());</div><div class="line">   server.setHandler(webAppCtx);</div><div class="line">   server.start();</div><div class="line"></div><div class="line">   eurekaServiceUrl = <span class="string">"http://localhost:8080/v2"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬”è€…ä¸å¤ªç†Ÿæ‚‰ Gradle çš„æ‰“åŒ…æ–¹å¼ï¼Œä½¿ç”¨ <code>Thread.currentThread().getContextClassLoader().getResource()</code> æ–¹æ³•ï¼Œä¸€ç›´æ— æ³•æ‹¿åˆ°è·¯å¾„ï¼Œæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚</li></ul><p>ç¬¬äºŒæ­¥ï¼ŒDebug è¿è¡Œ<code>com.netflix.eureka.resources.EurekaClientServerRestIntegrationTest</code> ä»»æ„å•å…ƒæµ‹è¯•æ–¹æ³•ã€‚</p><p><strong>æ€»ç»“</strong>ï¼šè¿™ç§æ–¹å¼ï¼Œå®Œç¾ã€‚å»ºè®®ä½¿ç”¨è¯¥æ–¹å¼è°ƒè¯•ã€‚</p><h1 id="4-Eureka-Client-å¯åŠ¨"><a href="#4-Eureka-Client-å¯åŠ¨" class="headerlink" title="4. Eureka-Client å¯åŠ¨"></a>4. Eureka-Client å¯åŠ¨</h1><p>æˆ‘ä»¬ä»¥ <code>com.netflix.eureka.ExampleEurekaClient</code> ä¸ºä¾‹å­ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œåœ¨ <code>EurekaClientServerRestIntegrationTest#setUp()</code> æ–¹æ³•æœ«å°¾æ·»åŠ  <code>Thread.sleep(Long.MAX_VALUE)</code> ä»£ç ã€‚</p><p>ç¬¬äºŒæ­¥ï¼ŒæŒ‰ç…§<a href="#">ã€Œ 3.3 Eureka-Server ç›´æ¥å¯åŠ¨ã€</a>æ–¹æ³•å¯åŠ¨ Eureka-Serverã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œå°† <code>EurekaClientServerRestIntegrationTest#injectEurekaConfiguration</code> å¤åˆ¶åˆ° ExampleEurekaClient ç±»é‡Œã€‚</p><p>ç¬¬å››æ­¥ï¼Œåœ¨ <code>ExampleEurekaClient#main()</code> æ–¹æ³•çš„ç¬¬ä¸€è¡Œï¼Œæ·»åŠ  <code>injectEurekaConfiguration()</code> ä»£ç ã€‚</p><p>ç¬¬äº”æ­¥ï¼ŒDebug è¿è¡Œ <code>ExampleEurekaClient#main()</code> æ–¹æ³•ã€‚</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_08/02.png" alt=""></p><p><code>eureka-examples</code> æ¨¡å—è¿˜æä¾›åˆ«çš„ä¾‹å­ï¼Œå¯ä»¥é€ä¸ªè°ƒè¯•ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æœ¬æ–‡å†™çš„ï¼Œç›¸å¯¹æ¯”è¾ƒç®€æ´ï¼Œå¦‚æœæœ‰ä»»ä½•ç–‘é—®ï¼Œå¯ä»¥ç»™æˆ‘å…¬ä¼—å·ç•™è¨€ã€‚</p><p>ä¸‹ä¸€ç¯‡æ›´æ–°ï¼Ÿæ©ï¼Œæˆ‘è¿˜æ²¡æƒ³å¥½ï¼Œæ•´ç†<a href="#">ã€ŠEureka æºç è§£æã€‹</a>æ•´ä¸ªç³»åˆ—çš„ç›®å½•ingã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Eureka/build-debugging-environment/&quot;&gt;http://www.iocoder.cn/Eureka/build-debugging-environment/&lt;/a
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>Eureka æºç è§£æ â€”â€” é¡¹ç›®ç»“æ„ç®€ä»‹</title>
    <link href="http://www.iocoder.cn/Eureka/project-structure/"/>
    <id>http://www.iocoder.cn/Eureka/project-structure/</id>
    <published>2018-03-31T16:00:00.000Z</published>
    <updated>2017-09-29T15:45:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/project-structure/">http://www.iocoder.cn/Eureka/project-structure/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong>  </p><ul><li><a href="#">1. æ¦‚è¿°</a><ul><li><a href="#">1.1 ç®€ä»‹</a></li><li><a href="#">1.2 é¡¹ç›®ç»“æ„</a></li></ul></li><li><a href="#">2. eureka-client</a><ul><li><a href="#">2.1 eureka-client-archaius2</a></li><li><a href="#">2.2 eureka-client-jersey2</a></li></ul></li><li><a href="#">3. eureka-core</a><ul><li><a href="#">3.1 eureka-core-jersey2</a></li></ul></li><li><a href="#">4. eureka-resources</a></li><li><a href="#">5. eureka-server</a><ul><li><a href="#">5.1 eureka-server-governator</a></li></ul></li><li><a href="#">6. eureka-examples</a></li><li><a href="#">7. eureka-test-utils</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka çš„é¡¹ç›®ç»“æ„</strong>ï¼Œé™„å¸¦éƒ¨åˆ†ç®€ä»‹å’ŒåŸç†ã€‚</p><p>Eureka é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Netflix/eureka" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Netflix/eureka</a></p><ul><li>è¯·æ³¨æ„ä¸‹ï¼Œä¸æ˜¯ <code>spring-cloud-netflix-eureka-client</code> / <code>spring-cloud-netflix-eureka-server</code> ã€‚</li><li>æœ¬äºº Fork çš„ä»£ç ä»“åº“ <a href="https://github.com/YunaiV/eureka" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/eureka</a>ï¼Œä¼šéšç€è¿™ä¸ªç³»åˆ—çš„æ–‡ç« é€æ¸å¢åŠ <strong>ä¸­æ–‡æ³¨é‡Š</strong>ï¼Œå¯ä»¥å…ˆ Star ä¸€ä¸‹ã€‚</li></ul><h2 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h2><p>Eureka æ˜¯ <a href="https://zh.wikipedia.org/wiki/Netflix" rel="external nofollow noopener noreferrer" target="_blank">Netflix</a> å¼€æºçš„æœåŠ¡æ³¨å†Œå‘ç°ç»„ä»¶ï¼Œåˆ†æˆ Client å’Œ Server ä¸¤éƒ¨åˆ†ã€‚ç®€åŒ–æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/01.png" alt=""></p><ul><li>Eureka-Server ï¼šé€šè¿‡ REST åè®®æš´éœ²æœåŠ¡ï¼Œæä¾›åº”ç”¨æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°çš„åŠŸèƒ½ã€‚</li><li>Application Provider ï¼šåº”ç”¨æœåŠ¡æä¾›è€…ï¼Œå†…åµŒ Eureka-Client ï¼Œé€šè¿‡å®ƒå‘ Eureka-Server æ³¨å†Œè‡ªèº«æœåŠ¡ã€‚</li><li>Application Consumer ï¼šåº”ç”¨æœåŠ¡æ¶ˆè´¹è€…ï¼Œå†…åµŒ Eureka-Client ï¼Œé€šè¿‡å®ƒä» Eureka-Server è·å–æœåŠ¡åˆ—è¡¨ã€‚</li><li>è¯·æ³¨æ„ä¸‹ï¼ŒApplication Provider å’Œ Application Consumer å¼ºè°ƒæ‰®æ¼”çš„è§’è‰²ï¼Œå®é™…å¯ä»¥åœ¨åŒä¸€ JVM è¿›ç¨‹ï¼Œå³æ˜¯æœåŠ¡çš„æä¾›è€…ï¼Œåˆæ˜¯æœåŠ¡çš„æ¶ˆè´¹è€…ã€‚</li></ul><h2 id="1-2-é¡¹ç›®ç»“æ„"><a href="#1-2-é¡¹ç›®ç»“æ„" class="headerlink" title="1.2 é¡¹ç›®ç»“æ„"></a>1.2 é¡¹ç›®ç»“æ„</h2><p>Eureka é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/02.png" alt=""></p><p>â“â“â“ä¸åª Eureka-Client ã€ Eureka-Server â“â“â“</p><p>æ·¡å®šã€‚æˆ‘ä»¬ä¸€èµ·æ¥äº†è§£æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½å’Œç»“æ„ã€‚</p><h1 id="2-eureka-client"><a href="#2-eureka-client" class="headerlink" title="2. eureka-client"></a>2. <code>eureka-client</code></h1><p><code>eureka-client</code> æ¨¡å—ä¸º Eureka-Client çš„åŠŸèƒ½å®ç°ï¼š</p><ul><li><code>com.netflix.appinfo</code> åŒ…ï¼šEureka-Client çš„åº”ç”¨é…ç½®ã€‚æ­¤å¤„çš„åº”ç”¨æŒ‡çš„å°±æ˜¯ä¸Šæ–‡æåˆ°çš„ Application Providerï¼ŒApplication Consumerã€‚</li><li><p><code>com.netflix.discovery</code> åŒ…ï¼šEureka-Client çš„æ³¨å†Œä¸å‘ç°ç›¸å…³åŠŸèƒ½ã€‚</p><ul><li><code>com.netflix.discovery.DiscoveryClient</code> ç±»ï¼šæ³¨å†Œå‘ç°å®¢æˆ·ç«¯å®ç°ç±»ã€‚</li><li><p><code>com.netflix.discovery.guice</code> åŒ…ï¼šEureka <strong>è®¡åˆ’</strong>ä½¿ç”¨ <a href="https://github.com/google/guice" rel="external nofollow noopener noreferrer" target="_blank">Google Guice</a> å®ç°ä¾èµ–æ³¨å…¥ï¼Œå‚è§æœ¬æ–‡ã€Œ5.1 <code>eureka-server-governator</code>ã€ã€‚ä¸€æ–¹é¢ Guice æ˜¯è½»é‡çº§çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œå¦ä¸€æ–¹é¢é¿å…å’Œä¸šåŠ¡ä»£ç çš„ Spring ç‰ˆæœ¬å†²çªã€‚</p><blockquote><p>Guice (pronounced â€˜juiceâ€™) is a lightweight dependency injection framework for Java 6 and above, brought to you by Google. </p></blockquote></li><li><p><code>com.netflix.discovery.converters</code> åŒ…ï¼šEureka å†…éƒ¨ä¼ è¾“æ•°æ®ç¼–è§£ç è½¬æ¢å™¨ï¼Œæ”¯æŒ XML / JSON æ ¼å¼ã€‚</p></li><li><code>com.netflix.discovery.endpoint</code> åŒ…ï¼šç›®å‰è¯¥åŒ…æ­£åœ¨é‡æ„ï¼Œå’Œä¸‹æ–‡çš„ <code>com.netflix.discovery.shared.dns</code> å’Œ <code>com.netflix.discovery.shared.resolver</code> ç”¨é€”ç›¸è¿‘ã€‚</li><li><code>com.netflix.disvoery.provider</code> åŒ…ï¼šç›®å‰ä»…æœ‰ DiscoveryJerseyProvider ç±»ã€‚è¯¥ç±»å£°æ˜è‡ªå®šä¹‰çš„ Jersey è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®ç°ã€‚</li><li><code>com.netflix.disvoery.providers</code> åŒ…ï¼šç›®å‰ä»…æœ‰ DefaultEurekaClientConfigProvider ç±»ã€‚è¯¥ç±»å®ç° <code>javax.inject.Provider</code> æ¥å£ï¼Œè®¾ç½® EurekaClientConfig ( Eureka å®¢æˆ·ç«¯é…ç½® ) çš„ç”Ÿæˆå·¥å‚ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="http://blog.csdn.net/derekjiang/article/details/7231490" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoogle-Guiceå…¥é—¨ä»‹ç»ã€‹</a>æœç´¢ <strong>Provider</strong> å…³é”®å­—ã€‚</li><li><p><code>com.netflix.discovery.shared</code> åŒ…ï¼šEureka-Client å’Œ Eureka-Server æ³¨å†Œå‘ç°ç›¸å…³çš„å…±äº«é‡ç”¨çš„ä»£ç ã€‚ä¸‹æ–‡ä½ ä¼šçœ‹åˆ°ï¼ŒEureka-Server é€šè¿‡ <code>eureka-core</code> æ¨¡å—å®ç°ï¼Œ<code>eureka-core</code> ä¾èµ– <code>eureka-client</code>ã€‚<strong>ç²—ä¸€çœ‹ï¼Œæˆ‘ä»¬ä¼šæ„Ÿè§‰ What ï¼ŸEureka-Server ä»£ç ä¾èµ– Eureka-Client ä»£ç ï¼ï¼Ÿ</strong>è¿™ä¸ªå’Œ Eureka-Server å¤šèŠ‚ç‚¹æ³¨å†Œä¿¡æ¯ P2P åŒæ­¥çš„å®ç°æœ‰å…³ã€‚ä¸€ä¸ª Eureka-Server æ”¶åˆ° Eureka-Client æ³¨å†Œè¯·æ±‚åï¼ŒEureka-Server ä¼šè‡ªå·±æ¨¡æ‹Ÿ Eureka-Client å‘é€æ³¨å†Œè¯·æ±‚åˆ°å…¶å®ƒçš„ Eureka-Serverï¼Œå› æ­¤éƒ¨åˆ†å®ç°ä»£ç å°±ä½¿ç”¨åˆ°äº†è¿™ä¸ªåŒ…ã€‚ğŸ™‚åé¢ä¼šå•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« è¯¦ç»†è§£æ P2P åŒæ­¥ã€‚</p><ul><li><code>com.netflix.discovery.shared.transport</code> åŒ…ï¼šEureka-Client å¯¹ Eureka-Server RESTful çš„ HTTP å®¢æˆ·ç«¯ï¼ŒåŸºäº Jersey Client å®ç°ã€‚Jersey åœ¨ä¸‹æ–‡ã€Œ2.1 <code>eureka-client-jersey2</code>ã€è¯¦ç»†è§£æã€‚</li><li><code>com.netflix.discovery.shared.dns</code> åŒ… ï¼šDNS è§£æå™¨ã€‚</li><li><code>com.netflix.discovery.shared.resolver</code> åŒ…ï¼šEurekaEndpoint è§£æå™¨ã€‚TODO è§£é‡Šçš„ä¸æ˜¯å¾ˆå¥½ã€‚</li></ul></li><li><p><code>com.netflix.discovery.util</code> åŒ… ï¼šå·¥å…·ç±»ã€‚</p></li></ul></li></ul><h2 id="2-1-eureka-client-archaius2"><a href="#2-1-eureka-client-archaius2" class="headerlink" title="2.1 eureka-client-archaius2"></a>2.1 <code>eureka-client-archaius2</code></h2><p><a href="https://github.com/Netflix/archaius" rel="external nofollow noopener noreferrer" target="_blank">Archaius</a> æ˜¯ Netflix å¼€æºçš„é…ç½®ç®¡ç†ç»„ä»¶ã€‚</p><p>Archaius ç›®å‰æœ‰ 1.x å’Œ 2.x ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒEureka ä½¿ç”¨ 1.x ç‰ˆæœ¬ã€‚ä»å®˜æ–¹æ–‡æ¡£ä¸Šæ¥çœ‹ï¼Œ2.x ç‰ˆæœ¬ä»ç„¶åœ¨å¼€å‘ä¸­ã€‚</p><blockquote><p>FROM <a href="https://github.com/YunaiV/eureka/blob/103e0875b08c9ff4abb85eaab672df2041b63558/eureka-client-archaius2/README.md" rel="external nofollow noopener noreferrer" target="_blank">eureka-client-archaius2 README</a><br>This is a version of eureka-client that has been ported to use Archaius 2.x as the backing configuration system. Please note that this client is still work in progress. This client is also only java8 compatible (as Archaius 2.x is only java8 compatible).</p></blockquote><h2 id="2-2-eureka-client-jersey2"><a href="#2-2-eureka-client-jersey2" class="headerlink" title="2.2 eureka-client-jersey2"></a>2.2 <code>eureka-client-jersey2</code></h2><p><a href="https://github.com/jersey/jersey" rel="external nofollow noopener noreferrer" target="_blank">Jersey</a> æ˜¯ JAX-RSï¼ˆJSR311ï¼‰å¼€æºå‚è€ƒå®ç°ï¼Œç”¨äºæ„å»º RESTful Web Serviceã€‚</p><ul><li>Eureka-Server ä½¿ç”¨ <a href="https://github.com/jersey/jersey/tree/9fdb7e386dc56b33f569ab198caf818d7a18525d/core-server/" rel="external nofollow noopener noreferrer" target="_blank">Jersey Server</a> åˆ›å»º RESTful Server ã€‚</li><li>Eureka-Client ä½¿ç”¨ <a href="https://github.com/jersey/jersey/tree/9fdb7e386dc56b33f569ab198caf818d7a18525d/core-client/" rel="external nofollow noopener noreferrer" target="_blank">Jersey Client</a> è¯·æ±‚ Eureka-Server ã€‚</li></ul><p>Jersey ç›®å‰æœ‰ 1.x å’Œ 2.x ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒEureka ä½¿ç”¨ 1.x ç‰ˆæœ¬ã€‚ä»å®˜æ–¹æ–‡æ¡£ä¸Šæ¥çœ‹ï¼Œ2.x ç‰ˆæœ¬ç”±ç¤¾åŒºå®ç°ï¼ŒNetflix è‡ªå·±æš‚æœªä½¿ç”¨ã€‚</p><blockquote><p>FROM <a href="https://github.com/Netflix/eureka/tree/30a85dc31be1c9d399e4e6ec5150759fb8777edf/eureka-client-jersey2/" rel="external nofollow noopener noreferrer" target="_blank">eureka-client-jersey2 README</a><br>Please note that this jersey2 compatible Eureka client (eureka-client-jersey2) is created and maintained by the community. Netflix does not currently use this library internally.</p></blockquote><h1 id="3-eureka-core"><a href="#3-eureka-core" class="headerlink" title="3. eureka-core"></a>3. <code>eureka-core</code></h1><p><code>eureka-core</code> æ¨¡å—ä¸º Eureka-Server çš„åŠŸèƒ½å®ç°ï¼š</p><ul><li><code>com.netflix.eureka.EurekaBootStrap</code> ç±»ï¼šEureka-Server å¯åŠ¨ç±»ã€‚</li><li><code>com.netflix.eureka.aws</code> åŒ…ï¼šä¸äºšé©¬é€Š AWS æœåŠ¡ç›¸å…³çš„ç±»ã€‚ç”±äºç¬”è€…å’Œå¤§å¤šæ•°è¯»è€…éƒ½å¯¹ AWS æš‚ä¸äº†è§£ï¼Œæœ¬ç³»åˆ—<a href="#">ã€ŠEureka æºç è§£æã€‹</a>ä¼šè·³è¿‡å’Œ AWS ç›¸å…³çš„ä»£ç ã€‚</li><li><code>com.netflix.eureka.cluster</code> åŒ…ï¼šEureka-Server é›†ç¾¤æ•°æ®å¤åˆ¶ç›¸å…³çš„ä»£ç ã€‚</li><li><code>com.netflix.eureka.lease</code> åŒ…ï¼šåº”ç”¨æ³¨å†Œåçš„<strong>ç§Ÿçº¦</strong>ç®¡ç†( æ³¨å†Œ / å–æ¶ˆ / ç»­æœŸ / è¿‡æœŸ )ã€‚</li><li><code>com.netflix.eureka.resousrces</code> åŒ…ï¼šèµ„æºï¼ŒåŸºäº Jersey Server å®ç°ï¼Œç›¸å½“äº Spring MVC çš„æ§åˆ¶å±‚ä»£ç ã€‚</li><li><code>com.netflix.eureka.transport</code> åŒ…ï¼šEureka-Server å¯¹ Eureka-Server çš„ RESTful HTTP å®¢æˆ·ç«¯ï¼ŒåŸºäº <code>com.netflix.discovery.shared.transport</code> å°è£…å®ç°ã€‚</li><li><code>com.netflix.eureka.util</code> åŒ…ï¼šå·¥å…·ç±»ã€‚</li></ul><h2 id="3-1-eureka-core-jersey2"><a href="#3-1-eureka-core-jersey2" class="headerlink" title="3.1 eureka-core-jersey2"></a>3.1 <code>eureka-core-jersey2</code></h2><p>å‚è§æœ¬æ–‡ã€Œ2.1 <code>eureka-client-jersey2</code>ã€ã€‚</p><h1 id="4-eureka-resources"><a href="#4-eureka-resources" class="headerlink" title="4. eureka-resources"></a>4. <code>eureka-resources</code></h1><p><code>eureka-resources</code> æ¨¡å—ï¼Œä½¿ç”¨ JSP å®ç° Eureka-Server çš„è¿ç»´åå°ç•Œé¢ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/03.png" alt=""></p><h1 id="5-eureka-server"><a href="#5-eureka-server" class="headerlink" title="5. eureka-server"></a>5. <code>eureka-server</code></h1><p><code>eureka-server</code> æ¨¡å—ï¼Œå°† <code>eureka-client</code> + <code>eureka-core</code> + <code>eureka-resources</code> ä¸‰è€…æ‰“åŒ…æˆ Eureka-Server çš„ <code>war</code> åŒ…ã€‚é¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_04_01/04.png" alt=""></p><h2 id="5-1-eureka-server-governator"><a href="#5-1-eureka-server-governator" class="headerlink" title="5.1 eureka-server-governator"></a>5.1 <code>eureka-server-governator</code></h2><p><code>eureka-server-governator</code> æ¨¡å—ï¼Œä½¿ç”¨ <a href="https://github.com/Netflix/governator" rel="external nofollow noopener noreferrer" target="_blank">Netflix Governator</a> ç®¡ç† Eureka-Server çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><blockquote><p>FROM <a href="http://www.infoq.com/cn/news/2013/02/netflix-opensource" rel="external nofollow noopener noreferrer" target="_blank">http://www.infoq.com/cn/news/2013/02/netflix-opensource</a><br><strong>Governator</strong>ï¼Œä¸€æ¬¾å¯¹ Google Guice è¿›è¡Œæ‰©å±•çš„ç±»åº“ï¼Œæä¾›äº†Classpathæ‰«æåŠè‡ªåŠ¨ç»‘å®šã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æˆå‘˜å±æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚</p></blockquote><p>ç›®å‰è¯¥æ¨¡å—æ­£åœ¨å®ç°é˜¶æ®µã€‚</p><blockquote><p>FROM <a href="https://github.com/Netflix/eureka/tree/30a85dc31be1c9d399e4e6ec5150759fb8777edf/eureka-server-governator/" rel="external nofollow noopener noreferrer" target="_blank">eureka-server-governator README</a><br>This server build is still experimental.</p></blockquote><h1 id="6-eureka-examples"><a href="#6-eureka-examples" class="headerlink" title="6. eureka-examples"></a>6. <code>eureka-examples</code></h1><p><code>eureka-examples</code> æ¨¡å—ï¼Œæä¾› Eureka-Client ä½¿ç”¨ä¾‹å­ã€‚</p><h1 id="7-eureka-test-utils"><a href="#7-eureka-test-utils" class="headerlink" title="7. eureka-test-utils"></a>7. <code>eureka-test-utils</code></h1><p><code>eureka-test-utils</code> æ¨¡å—ï¼Œæä¾› Eureka å•å…ƒæµ‹è¯•å·¥å…·ç±»ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç¬¬ä¸€ç¯‡ Eureka çš„æ–‡ç« ï¼Œå¦‚æœæœ‰åœ°æ–¹å†™çš„ä¸æ­£ç¡®ï¼Œè¿˜æœ›æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</p><p>ä¸‹ä¸€ç¯‡ Eureka è°ƒè¯•ç¯å¢ƒæ­å»ºã€‚</p><p>æ›´å¤š Eureka å†…å®¹ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li>æºç¨‹ â€”â€” <a href="http://techshow.ctrip.com/archives/1699.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a></li><li>ç¨‹åºå‘˜DD â€”â€” <a href="http://blog.didispace.com/springcloud-sourcecode-eureka/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudæºç åˆ†æï¼ˆä¸€ï¼‰Eurekaã€‹</a></li><li>ç‹é¸¿é£ â€”â€” <a href="http://blog.spring-cloud.io/blog/sc-eureka.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Netflix Eurekaæºç å¯¼è¯»ä¸åŸç†åˆ†æã€‹</a></li><li>è®¸è¿› â€”â€” <a href="http://xujin.org/sc/sc-netflix-eureka/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloud Netflixä¹‹Eurekaä¸Šç¯‡ã€‹</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‘˜è¦: åŸåˆ›å‡ºå¤„ &lt;a href=&quot;http://www.iocoder.cn/Eureka/project-structure/&quot;&gt;http://www.iocoder.cn/Eureka/project-structure/&lt;/a&gt; ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢
      
    
    </summary>
    
      <category term="Eureka" scheme="http://www.iocoder.cn/categories/Eureka/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” é¡¹ç›®å®æˆ˜</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/http-sample/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/http-sample/</id>
    <published>2018-03-14T16:00:00.000Z</published>
    <updated>2017-09-18T08:14:58.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-%E5%AE%9E%E4%BD%93%E7%BB%93%E6%9E%84">2. å®ä½“ç»“æ„</a><ul><li><a href="#21-%E5%95%86%E5%9F%8E%E6%9C%8D%E5%8A%A1">2.1 å•†åŸæœåŠ¡</a></li><li><a href="#22-%E8%B5%84%E9%87%91%E6%9C%8D%E5%8A%A1">2.2 èµ„é‡‘æœåŠ¡</a></li><li><a href="#23-%E7%BA%A2%E5%8C%85%E6%9C%8D%E5%8A%A1">2.3 çº¢åŒ…æœåŠ¡</a></li></ul></li><li><a href="#3-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8">3. æœåŠ¡è°ƒç”¨</a></li><li><a href="#4-%E4%B8%8B%E5%8D%95%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B">4. ä¸‹å•æ”¯ä»˜æµç¨‹</a><ul><li><a href="#41-try-%E9%98%B6%E6%AE%B5">4.1 Try é˜¶æ®µ</a></li><li><a href="#42-confirm--cancel-%E9%98%B6%E6%AE%B5">4.2 Confirm / Cancel é˜¶æ®µ</a></li></ul></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC é¡¹ç›®å®æˆ˜</strong>ã€‚ä»¥å®˜æ–¹ Mavené¡¹ç›® <code>tcc-transaction-http-sample</code> ä¸ºä¾‹å­( <code>tcc-transaction-dubbo-sample</code> ç±»ä¼¼ )ã€‚</p><p>å»ºè®®ä½ å·²ç»æˆåŠŸå¯åŠ¨äº†è¯¥é¡¹ç›®ã€‚å¦‚æœä¸çŸ¥é“å¦‚ä½•å¯åŠ¨ï¼Œå¯ä»¥å…ˆæŸ¥çœ‹<a href="http://www.iocoder.cn/TCC-Transaction/build-debugging-environment/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»ºã€‹</a>ã€‚å¦‚æœå†ç¢°åˆ°é—®é¢˜ï¼Œæ¬¢è¿åŠ å¾®ä¿¡å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> )ï¼Œæˆ‘ä¼šä¸€ä¸€ä»”ç»†å›å¤ã€‚</p><p>OKï¼Œé¦–å…ˆæˆ‘ä»¬ç®€å•äº†è§£ä¸‹è¿™ä¸ªé¡¹ç›®ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/01.png" alt=""></p><ul><li>é¦–é¡µ =&gt; å•†å“åˆ—è¡¨ =&gt; ç¡®è®¤æ”¯ä»˜é¡µ =&gt; æ”¯ä»˜ç»“æœé¡µ</li><li>ä½¿ç”¨è´¦æˆ·ä½™é¢ + çº¢åŒ…ä½™é¢<strong>è”åˆ</strong>æ”¯ä»˜è´­ä¹°å•†å“ï¼Œå¹¶è´¦æˆ·ä¹‹é—´<strong>è½¬è´¦</strong>ã€‚</li></ul><p>é¡¹ç›®æ‹†åˆ†ä¸‰ä¸ªå­ Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-http-order</code> ï¼šå•†åŸæœåŠ¡ï¼Œæä¾›å•†å“å’Œå•†å“è®¢å•é€»è¾‘ã€‚</li><li><code>tcc-transaction-http-capital</code> ï¼šèµ„é‡‘æœåŠ¡ï¼Œæä¾›è´¦æˆ·ä½™é¢é€»è¾‘ã€‚</li><li><code>tcc-transaction-http-redpacket</code> ï¼šçº¢åŒ…æœåŠ¡ï¼Œæä¾›çº¢åŒ…ä½™é¢é€»è¾‘ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/03.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1 id="2-å®ä½“ç»“æ„"><a href="#2-å®ä½“ç»“æ„" class="headerlink" title="2. å®ä½“ç»“æ„"></a>2. å®ä½“ç»“æ„</h1><h2 id="2-1-å•†åŸæœåŠ¡"><a href="#2-1-å•†åŸæœåŠ¡" class="headerlink" title="2.1 å•†åŸæœåŠ¡"></a>2.1 å•†åŸæœåŠ¡</h2><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/02.png" alt=""></p><ul><li><p>Shopï¼Œå•†åº—è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†åº—ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰€æœ‰è€…ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> ownerUserId;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>Productï¼Œå•†å“è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†å“ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> productId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†åº—ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> shopId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†å“å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String productName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä»·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal price;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>Orderï¼Œè®¢å•è¡¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5908730245224893590L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯ä»˜( ä¸‹å• )ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> payerUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¶æ¬¾( å•†åº—æ‹¥æœ‰è€… )ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> payeeUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * çº¢åŒ…æ”¯ä»˜é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal redPacketPayAmount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è´¦æˆ·ä½™é¢æ”¯ä»˜é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal capitalPayAmount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•çŠ¶æ€</span></div><div class="line"><span class="comment">     * - DRAFT ï¼šè‰ç¨¿</span></div><div class="line"><span class="comment">     * - PAYING ï¼šæ”¯ä»˜ä¸­</span></div><div class="line"><span class="comment">     * - CONFIRMED ï¼šæ”¯ä»˜æˆåŠŸ</span></div><div class="line"><span class="comment">     * - PAY_FAILED ï¼šæ”¯ä»˜å¤±è´¥</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String status = <span class="string">"DRAFT"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†æˆ·è®¢å•å·ï¼Œä½¿ç”¨ UUID ç”Ÿæˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String merchantOrderNo;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•æ˜ç»†æ•°ç»„</span></div><div class="line"><span class="comment">     * éå­˜å‚¨å­—æ®µ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;OrderLine&gt; orderLines = <span class="keyword">new</span> ArrayList&lt;OrderLine&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>OrderLineï¼Œè®¢å•æ˜ç»†ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderLine</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2300754647209250837L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†å“ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> productId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> quantity;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä»·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal unitPrice;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p><strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼š</p><p>ä¸‹å•æ—¶ï¼Œæ’å…¥è®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„è®¢å•( Order )è®°å½•ï¼Œå¹¶æ’å…¥è´­ä¹°çš„å•†å“è®¢å•æ˜ç»†( OrderLine )è®°å½•ã€‚æ”¯ä»˜æ—¶ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸º <code>&quot;PAYING&quot;</code>ã€‚</p><ul><li>è®¢å•æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸º <code>&quot;CONFIRMED&quot;</code>ã€‚</li><li>è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°è®¢å•çŠ¶ä½“ä¸º <code>&quot;PAY_FAILED&quot;</code>ã€‚</li></ul><h2 id="2-2-èµ„é‡‘æœåŠ¡"><a href="#2-2-èµ„é‡‘æœåŠ¡" class="headerlink" title="2.2 èµ„é‡‘æœåŠ¡"></a>2.2 èµ„é‡‘æœåŠ¡</h2><p>å…³ç³»è¾ƒä¸ºç®€å•ï¼Œæœ‰ä¸¤ä¸ªå®ä½“ï¼š</p><ul><li><p>CapitalAccountï¼Œèµ„é‡‘è´¦æˆ·ä½™é¢ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CapitalAccount</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è´¦æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½™é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal balanceAmount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>TradeOrderï¼Œäº¤æ˜“è®¢å•è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradeOrder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å‡ºç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> selfUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å…¥ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> oppositeUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†æˆ·è®¢å•å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String merchantOrderNo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal amount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•çŠ¶æ€</span></div><div class="line"><span class="comment">     * - DRAFT ï¼šè‰ç¨¿</span></div><div class="line"><span class="comment">     * - CONFIRM ï¼šäº¤æ˜“æˆåŠŸ</span></div><div class="line"><span class="comment">     * - CANCEL ï¼šäº¤æ˜“å–æ¶ˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String status = <span class="string">"DRAFT"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p><strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼š</p><p>è®¢å•æ”¯ä»˜æ”¯ä»˜ä¸­ï¼Œæ’å…¥äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„è®¢å•( TradeOrder )è®°å½•ï¼Œå¹¶æ›´æ–°<strong>å‡å°‘</strong>ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚</p><ul><li>è®¢å•æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CONFIRM&quot;</code>ï¼Œå¹¶æ›´æ–°<strong>å¢åŠ </strong>å•†åº—æ‹¥æœ‰ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚</li><li>è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CANCEL&quot;</code>ï¼Œå¹¶æ›´æ–°<strong>å¢åŠ ( æ¢å¤ )</strong>ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚</li></ul><h2 id="2-3-çº¢åŒ…æœåŠ¡"><a href="#2-3-çº¢åŒ…æœåŠ¡" class="headerlink" title="2.3 çº¢åŒ…æœåŠ¡"></a>2.3 çº¢åŒ…æœåŠ¡</h2><p>å…³ç³»è¾ƒä¸ºç®€å•ï¼Œ<strong>å’Œèµ„é‡‘æœåŠ¡ 99.99% ç›¸åŒ</strong>ï¼Œæœ‰ä¸¤ä¸ªå®ä½“ï¼š</p><ul><li><p>RedPacketAccountï¼Œçº¢åŒ…è´¦æˆ·ä½™é¢ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPacketAccount</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è´¦æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½™é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal balanceAmount;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>TradeOrderï¼Œäº¤æ˜“è®¢å•è¡¨ã€‚å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradeOrder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å‡ºç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> selfUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è½¬å…¥ç”¨æˆ·ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> oppositeUserId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•†æˆ·è®¢å•å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String merchantOrderNo;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡‘é¢</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> BigDecimal amount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº¤æ˜“è®¢å•çŠ¶æ€</span></div><div class="line"><span class="comment">     * - DRAFT ï¼šè‰ç¨¿</span></div><div class="line"><span class="comment">     * - CONFIRM ï¼šäº¤æ˜“æˆåŠŸ</span></div><div class="line"><span class="comment">     * - CANCEL ï¼šäº¤æ˜“å–æ¶ˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String status = <span class="string">"DRAFT"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p><strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼š</p><p>è®¢å•æ”¯ä»˜æ”¯ä»˜ä¸­ï¼Œæ’å…¥äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„è®¢å•( TradeOrder )è®°å½•ï¼Œå¹¶æ›´æ–°<strong>å‡å°‘</strong>ä¸‹å•ç”¨æˆ·çš„çº¢åŒ…è´¦æˆ·ä½™é¢ã€‚</p><ul><li>è®¢å•æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CONFIRM&quot;</code>ï¼Œå¹¶æ›´æ–°<strong>å¢åŠ </strong>å•†åº—æ‹¥æœ‰ç”¨æˆ·çš„çº¢åŒ…è´¦æˆ·ä½™é¢ã€‚</li><li>è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸º <code>&quot;CANCEL&quot;</code>ï¼Œå¹¶æ›´æ–°<strong>å¢åŠ ( æ¢å¤ )</strong>ä¸‹å•ç”¨æˆ·çš„çº¢åŒ…è´¦æˆ·ä½™é¢ã€‚</li></ul><h1 id="3-æœåŠ¡è°ƒç”¨"><a href="#3-æœåŠ¡è°ƒç”¨" class="headerlink" title="3. æœåŠ¡è°ƒç”¨"></a>3. æœåŠ¡è°ƒç”¨</h1><p>æœåŠ¡ä¹‹é—´ï¼Œé€šè¿‡ <strong>HTTP</strong> è¿›è¡Œè°ƒç”¨ã€‚</p><p><strong>çº¢åŒ…æœåŠ¡å’Œèµ„é‡‘æœåŠ¡ä¸ºå•†åŸæœåŠ¡æä¾›è°ƒç”¨( ä»¥èµ„é‡‘æœåŠ¡ä¸ºä¾‹å­ )</strong>ï¼š</p><ul><li><p>XML é…ç½®å¦‚ä¸‹ ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-service-provider.xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalAccountRepository"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.domain.repository.CapitalAccountRepository"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"tradeOrderRepository"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.domain.repository.TradeOrderRepository"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalTradeOrderService"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.service.CapitalTradeOrderServiceImpl"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalAccountService"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.service.CapitalAccountServiceImpl"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalTradeOrderServiceExporter"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.SimpleHttpInvokerServiceExporter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span> <span class="attr">ref</span>=<span class="string">"capitalTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalTradeOrderService"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"capitalAccountServiceExporter"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.SimpleHttpInvokerServiceExporter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span> <span class="attr">ref</span>=<span class="string">"capitalAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalAccountService"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"httpServer"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.support.SimpleHttpServerFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"contexts"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">util:map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalTradeOrderService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalTradeOrderServiceExporter"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalAccountService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalAccountServiceExporter"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"8081"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></li><li><p>Java ä»£ç å®ç°å¦‚ä¸‹ ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CapitalAccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">CapitalAccountService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    CapitalAccountRepository capitalAccountRepository;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getCapitalAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> capitalAccountRepository.findByUserId(userId).getBalanceAmount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CapitalAccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">CapitalAccountService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    CapitalAccountRepository capitalAccountRepository;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getCapitalAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> capitalAccountRepository.findByUserId(userId).getBalanceAmount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><p><strong>å•†åŸæœåŠ¡è°ƒç”¨</strong></p><ul><li><p>XML é…ç½®å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-service-consumer.xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"httpInvokerRequestExecutor"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.CommonsHttpInvokerRequestExecutor"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpClient"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.httpclient.HttpClient"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpConnectionManager"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"multiThreadHttpConnectionManager"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"multiThreadHttpConnectionManager"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.apache.commons.httpclient.MultiThreadedHttpConnectionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"params"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.httpclient.params.HttpConnectionManagerParams"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionTimeout"</span> <span class="attr">value</span>=<span class="string">"200000"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotalConnections"</span> <span class="attr">value</span>=<span class="string">"600"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultMaxConnectionsPerHost"</span> <span class="attr">value</span>=<span class="string">"512"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"soTimeout"</span> <span class="attr">value</span>=<span class="string">"5000"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"captialTradeOrderService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8081/remoting/CapitalTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"capitalAccountService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8081/remoting/CapitalAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.capital.api.CapitalAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redPacketAccountService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8082/remoting/RedPacketAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.redpacket.api.RedPacketAccountService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redPacketTradeOrderService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8082/remoting/RedPacketTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceInterface"</span></span></div><div class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.mengyun.tcctransaction.sample.http.redpacket.api.RedPacketTradeOrderService"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"httpInvokerRequestExecutor"</span> <span class="attr">ref</span>=<span class="string">"httpInvokerRequestExecutor"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></li><li><p>Java æ¥å£æ¥å£å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalAccountService</span> </span>&#123;</div><div class="line">    <span class="function">BigDecimal <span class="title">getCapitalAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketAccountService</span> </span>&#123;</div><div class="line">    <span class="function">BigDecimal <span class="title">getRedPacketAccountByUserId</span><span class="params">(<span class="keyword">long</span> userId)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, RedPacketTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h1 id="4-ä¸‹å•æ”¯ä»˜æµç¨‹"><a href="#4-ä¸‹å•æ”¯ä»˜æµç¨‹" class="headerlink" title="4. ä¸‹å•æ”¯ä»˜æµç¨‹"></a>4. ä¸‹å•æ”¯ä»˜æµç¨‹</h1><p><strong>ps</strong>ï¼šæ•°æ®è®¿é—®çš„æ–¹æ³•ï¼Œè¯·è‡ªå·±æ‹‰å–ä»£ç ï¼Œä½¿ç”¨ IDE æŸ¥çœ‹ã€‚è°¢è°¢ã€‚ğŸ™‚</p><p>ä¸‹å•æ”¯ä»˜æµç¨‹ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾( <a href="./../../images/TCC-Transaction/2018_03_15/04.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/04.png" alt=""></p><p>ç‚¹å‡»<strong>ã€æ”¯ä»˜ã€‘</strong>æŒ‰é’®ï¼Œä¸‹å•æ”¯ä»˜æµç¨‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">""</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="meta">@RequestMapping</span>(value = <span class="string">"/placeorder"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">placeOrder</span><span class="params">(@RequestParam String redPacketPayAmount,</span></span></div><div class="line"><span class="function"><span class="params">                                   @RequestParam <span class="keyword">long</span> shopId,</span></span></div><div class="line"><span class="function"><span class="params">                                   @RequestParam <span class="keyword">long</span> payerUserId,</span></span></div><div class="line"><span class="function"><span class="params">                                   @RequestParam <span class="keyword">long</span> productId)</span> </span>&#123;</div><div class="line">        PlaceOrderRequest request = buildRequest(redPacketPayAmount, shopId, payerUserId, productId);</div><div class="line">        <span class="comment">// ä¸‹å•å¹¶æ”¯ä»˜è®¢å•</span></div><div class="line">        String merchantOrderNo = placeOrderService.placeOrder(request.getPayerUserId(), request.getShopId(),</div><div class="line">                request.getProductQuantities(), request.getRedPacketPayAmount());</div><div class="line">        <span class="comment">// è¿”å›</span></div><div class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView(<span class="string">"pay_success"</span>);</div><div class="line">        <span class="comment">// æŸ¥è¯¢è®¢å•çŠ¶æ€</span></div><div class="line">        String status = orderService.getOrderStatusByMerchantOrderNo(merchantOrderNo);</div><div class="line">        <span class="comment">// æ”¯ä»˜ç»“æœæç¤º</span></div><div class="line">        String payResultTip = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"CONFIRMED"</span>.equals(status)) &#123;</div><div class="line">            payResultTip = <span class="string">"æ”¯ä»˜æˆåŠŸ"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"PAY_FAILED"</span>.equals(status)) &#123;</div><div class="line">            payResultTip = <span class="string">"æ”¯ä»˜å¤±è´¥"</span>;</div><div class="line">        &#125;</div><div class="line">        mv.addObject(<span class="string">"payResult"</span>, payResultTip);</div><div class="line">        <span class="comment">// å•†å“ä¿¡æ¯</span></div><div class="line">        mv.addObject(<span class="string">"product"</span>, productRepository.findById(productId));</div><div class="line">        <span class="comment">// èµ„é‡‘è´¦æˆ·é‡‘é¢ å’Œ çº¢åŒ…è´¦æˆ·é‡‘é¢</span></div><div class="line">        mv.addObject(<span class="string">"capitalAmount"</span>, accountService.getCapitalAccountByUserId(payerUserId));</div><div class="line">        mv.addObject(<span class="string">"redPacketAmount"</span>, accountService.getRedPacketAccountByUserId(payerUserId));</div><div class="line">        <span class="keyword">return</span> mv;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>PlaceOrderService#placeOrder(...)</code> æ–¹æ³•ï¼Œä¸‹å•å¹¶æ”¯ä»˜è®¢å•ã€‚</li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-order/src/main/java/org/mengyun/tcctransaction/sample/http/order/domain/service/OrderServiceImpl.java" rel="external nofollow noopener noreferrer" target="_blank"><code>OrderService#getOrderStatusByMerchantOrderNo(...)</code></a> æ–¹æ³•ï¼ŒæŸ¥è¯¢è®¢å•çŠ¶æ€ã€‚</li></ul><hr><p>è°ƒç”¨ <code>PlaceOrderService#placeOrder(...)</code> æ–¹æ³•ï¼Œä¸‹å•å¹¶æ”¯ä»˜è®¢å•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlaceOrderServiceImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">placeOrder</span><span class="params">(<span class="keyword">long</span> payerUserId, <span class="keyword">long</span> shopId, List&lt;Pair&lt;Long, Integer&gt;&gt; productQuantities, BigDecimal redPacketPayAmount)</span> </span>&#123;</div><div class="line">        <span class="comment">// è·å–å•†åº—</span></div><div class="line">        Shop shop = shopRepository.findById(shopId);</div><div class="line">        <span class="comment">// åˆ›å»ºè®¢å•</span></div><div class="line">        Order order = orderService.createOrder(payerUserId, shop.getOwnerUserId(), productQuantities);</div><div class="line">        <span class="comment">// å‘èµ·æ”¯ä»˜</span></div><div class="line">        Boolean result = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            paymentService.makePayment(order, redPacketPayAmount, order.getTotalAmount().subtract(redPacketPayAmount));</div><div class="line">        &#125; <span class="keyword">catch</span> (ConfirmingException confirmingException) &#123;</div><div class="line">            <span class="comment">// exception throws with the tcc transaction status is CONFIRMING,</span></div><div class="line">            <span class="comment">// when tcc transaction is confirming status,</span></div><div class="line">            <span class="comment">// the tcc transaction recovery will try to confirm the whole transaction to ensure eventually consistent.</span></div><div class="line">            result = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (CancellingException cancellingException) &#123;</div><div class="line">            <span class="comment">// exception throws with the tcc transaction status is CANCELLING,</span></div><div class="line">            <span class="comment">// when tcc transaction is under CANCELLING status,</span></div><div class="line">            <span class="comment">// the tcc transaction recovery will try to cancel the whole transaction to ensure eventually consistent.</span></div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="comment">// other exceptions throws at TRYING stage.</span></div><div class="line">            <span class="comment">// you can retry or cancel the operation.</span></div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> order.getMerchantOrderNo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>ShopRepository#findById(...)</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢å•†åº—ã€‚</li><li><p>è°ƒç”¨ <code>OrderService#createOrder(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºè®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„<strong>å•†åŸ</strong>è®¢å•ã€‚å®é™…ä¸šåŠ¡ä¸ä¼šè¿™ä¹ˆåšï¼Œæ­¤å¤„ä»…ä»…æ˜¯ä¾‹å­ï¼Œç®€åŒ–æµç¨‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Transactional</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">createOrder</span><span class="params">(<span class="keyword">long</span> payerUserId, <span class="keyword">long</span> payeeUserId, List&lt;Pair&lt;Long, Integer&gt;&gt; productQuantities)</span> </span>&#123;</div><div class="line">        Order order = orderFactory.buildOrder(payerUserId, payeeUserId, productQuantities);</div><div class="line">        orderRepository.createOrder(order);</div><div class="line">        <span class="keyword">return</span> order;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li>è°ƒç”¨ <code>PaymentService#makePayment(...)</code> æ–¹æ³•ï¼Œå‘èµ·æ”¯ä»˜ï¼Œ<strong>TCC æµç¨‹</strong>ã€‚</li><li><strong>ç”Ÿäº§ä»£ç å¯¹äºå¼‚å¸¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</li><li><strong>ç”Ÿäº§ä»£ç å¯¹äºå¼‚å¸¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</li><li><strong>ç”Ÿäº§ä»£ç å¯¹äºå¼‚å¸¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</li></ul><h2 id="4-1-Try-é˜¶æ®µ"><a href="#4-1-Try-é˜¶æ®µ" class="headerlink" title="4.1 Try é˜¶æ®µ"></a>4.1 Try é˜¶æ®µ</h2><p><strong>å•†åŸæœåŠ¡</strong></p><p>è°ƒç”¨ <code>PaymentService#makePayment(...)</code> æ–¹æ³•ï¼Œå‘èµ· Try æµç¨‹ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmMakePayment"</span>, cancelMethod = <span class="string">"cancelMakePayment"</span>)</div><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order, BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   System.out.println(<span class="string">"order try make payment called.time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜ä¸­</span></div><div class="line">   order.pay(redPacketPayAmount, capitalPayAmount);</div><div class="line">   orderRepository.updateOrder(order);</div><div class="line">   <span class="comment">// èµ„é‡‘è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•</span></div><div class="line">   String result = tradeOrderServiceProxy.record(<span class="keyword">null</span>, buildCapitalTradeOrderDto(order));</div><div class="line">   <span class="comment">// çº¢åŒ…è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•</span></div><div class="line">   String result2 = tradeOrderServiceProxy.record(<span class="keyword">null</span>, buildRedPacketTradeOrderDto(order));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Compensable</p><ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ« Propagation.REQUIRED ( <strong>é»˜è®¤å€¼</strong> )</li><li>è®¾ç½® <code>confirmMethod</code> /  <code>cancelMethod</code> æ–¹æ³•å</li><li>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ç±» DefaultTransactionContextEditor ( <strong>é»˜è®¤å€¼</strong> )</li></ul></li><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</p></li><li><p>è°ƒç”¨ <code>OrderRepository#updateOrder(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸º<strong>æ”¯ä»˜ä¸­</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Order.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.redPacketPayAmount = redPacketPayAmount;</div><div class="line">   <span class="keyword">this</span>.capitalPayAmount = capitalPayAmount;</div><div class="line">   <span class="keyword">this</span>.status = <span class="string">"PAYING"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>TradeOrderServiceProxy#record(...)</code> æ–¹æ³•ï¼Œ<strong>èµ„é‡‘</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TradeOrderServiceProxy.java</span></div><div class="line"><span class="meta">@Compensable</span>(propagation = Propagation.SUPPORTS, confirmMethod = <span class="string">"record"</span>, cancelMethod = <span class="string">"record"</span>, transactionContextEditor = Compensable.DefaultTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> capitalTradeOrderService.record(transactionContext, tradeOrderDto);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CapitalTradeOrderService.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Compensable</p><ul><li><code>propagation=Propagation.SUPPORTS</code> ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚<strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ REQUIRED</strong> ï¼Ÿå¦‚æœä½¿ç”¨ REQUIRED äº‹åŠ¡ä¼ æ’­çº§åˆ«ï¼Œäº‹åŠ¡æ¢å¤é‡è¯•æ—¶ï¼Œä¼šå‘èµ·æ–°çš„äº‹åŠ¡ã€‚</li><li><code>confirmMethod</code>ã€<code>cancelMethod</code> ä½¿ç”¨å’Œ try æ–¹æ³•<strong>ç›¸åŒæ–¹æ³•å</strong>ï¼š<strong>æœ¬åœ°å‘èµ·</strong>è¿œç¨‹æœåŠ¡ TCC confirm / cancel é˜¶æ®µï¼Œè°ƒç”¨ç›¸åŒæ–¹æ³•è¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚è¿œç¨‹æœåŠ¡çš„ CompensableTransactionInterceptor ä¼šæ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æ˜¯ CONFIRMING / CANCELLING æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CapitalTradeOrderService#record(...)</code> æ–¹æ³•ï¼Œè¿œç¨‹è°ƒç”¨ï¼Œå‘èµ·<strong>èµ„é‡‘</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚</p><ul><li>æœ¬åœ°æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå‚æ•° <code>transactionContext</code> ä¼ é€’ <code>null</code> å³å¯ï¼ŒTransactionContextEditor ä¼šè®¾ç½®ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/tcc-core/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°ã€‹ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>è¿œç¨‹æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå‚æ•° <code>transactionContext</code> éœ€è¦ä¼ é€’ã€‚Dubbo è¿œç¨‹æ–¹æ³•è°ƒç”¨å®é™…ä¹Ÿè¿›è¡Œäº†ä¼ é€’ï¼Œä¼ é€’æ–¹å¼è¾ƒä¸ºç‰¹æ®Šï¼Œé€šè¿‡éšå¼èˆ¹èˆ±ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒã€‹ã€Œ3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul></li><li><p>è°ƒç”¨ <code>TradeOrderServiceProxy#record(...)</code> æ–¹æ³•ï¼Œ<strong>çº¢åŒ…</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚å’Œ<strong>èµ„é‡‘</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å• 99.99% ç±»ä¼¼ï¼Œä¸é‡å¤â€œå¤åˆ¶ç²˜è´´â€ã€‚</p></li></ul><hr><p><strong>èµ„é‡‘æœåŠ¡</strong></p><p>è°ƒç”¨ <code>CapitalTradeOrderServiceImpl#record(...)</code> æ–¹æ³•ï¼Œ<strong>çº¢åŒ…</strong>è´¦æˆ·ä½™é¢æ”¯ä»˜è®¢å•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmRecord"</span>, cancelMethod = <span class="string">"cancelRecord"</span>, transactionContextEditor = Compensable.DefaultTransactionContextEditor.class)</div><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line"><span class="comment">//            Thread.sleep(10000000L);</span></div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"capital try record called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// ç”Ÿæˆäº¤æ˜“è®¢å•</span></div><div class="line">   TradeOrder tradeOrder = <span class="keyword">new</span> TradeOrder(</div><div class="line">           tradeOrderDto.getSelfUserId(),</div><div class="line">           tradeOrderDto.getOppositeUserId(),</div><div class="line">           tradeOrderDto.getMerchantOrderNo(),</div><div class="line">           tradeOrderDto.getAmount()</div><div class="line">   );</div><div class="line">   tradeOrderRepository.insert(tradeOrder);</div><div class="line">   <span class="comment">// æ›´æ–°å‡å°‘ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢</span></div><div class="line">   CapitalAccount transferFromAccount = capitalAccountRepository.findByUserId(tradeOrderDto.getSelfUserId());</div><div class="line">   transferFromAccount.transferFrom(tradeOrderDto.getAmount());</div><div class="line">   capitalAccountRepository.save(transferFromAccount);</div><div class="line">   <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Compensable</p><ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ« Propagation.REQUIRED ( <strong>é»˜è®¤å€¼</strong> )</li><li>è®¾ç½® <code>confirmMethod</code> /  <code>cancelMethod</code> æ–¹æ³•å</li><li>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ç±» DefaultTransactionContextEditor ( <strong>é»˜è®¤å€¼</strong> )</li></ul></li><li><p>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</p></li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/TradeOrderRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>TradeOrderRepository#insert(...)</code></a> æ–¹æ³•ï¼Œç”Ÿæˆè®¢å•çŠ¶æ€ä¸º <code>&quot;DRAFT&quot;</code> çš„äº¤æ˜“è®¢å•ã€‚</li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/CapitalAccountRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CapitalAccountRepository#save(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°å‡å°‘ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚<strong>Try é˜¶æ®µé”å®šèµ„æºæ—¶ï¼Œä¸€å®šè¦å…ˆæ‰£ã€‚TCC æ˜¯æœ€ç»ˆäº‹åŠ¡ä¸€è‡´æ€§ï¼Œå¦‚æœå…ˆæ·»åŠ ï¼Œå¯èƒ½è¢«ä½¿ç”¨</strong>ã€‚</li></ul><h2 id="4-2-Confirm-Cancel-é˜¶æ®µ"><a href="#4-2-Confirm-Cancel-é˜¶æ®µ" class="headerlink" title="4.2 Confirm / Cancel é˜¶æ®µ"></a>4.2 Confirm / Cancel é˜¶æ®µ</h2><p>å½“ Try æ“ä½œ<strong>å…¨éƒ¨</strong>æˆåŠŸæ—¶ï¼Œå‘èµ· Confirm æ“ä½œã€‚<br>å½“ Try æ“ä½œå­˜åœ¨<strong>ä»»åŠ¡</strong>å¤±è´¥æ—¶ï¼Œå‘èµ· Cancel æ“ä½œã€‚</p><h3 id="4-2-1-Confirm"><a href="#4-2-1-Confirm" class="headerlink" title="4.2.1 Confirm"></a>4.2.1 Confirm</h3><p><strong>å•†åŸæœåŠ¡</strong></p><p>è°ƒç”¨ <code>PaymentServiceImpl#confirmMakePayment(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜<strong>æˆåŠŸ</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmMakePayment</span><span class="params">(Order order, BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"order confirm make payment called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜æˆåŠŸ</span></div><div class="line">   order.confirm();</div><div class="line">   orderRepository.updateOrder(order);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ç”Ÿäº§ä»£ç è¯¥æ–¹æ³•éœ€è¦åŠ ä¸‹ @Transactional æ³¨è§£ï¼Œä¿è¯åŸå­æ€§</strong>ã€‚</li><li><p>è°ƒç”¨ <code>OrderRepository#updateOrder(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜æˆåŠŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Order.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.status = <span class="string">"CONFIRMED"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><p><strong>èµ„é‡‘æœåŠ¡</strong></p><p>è°ƒç”¨ <code>CapitalTradeOrderServiceImpl#confirmRecord(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>æˆåŠŸ</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"capital confirm record called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æŸ¥è¯¢äº¤æ˜“è®°å½•</span></div><div class="line">   TradeOrder tradeOrder = tradeOrderRepository.findByMerchantOrderNo(tradeOrderDto.getMerchantOrderNo());</div><div class="line">   <span class="comment">// åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€ã€‚å› ä¸º `#record()` æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != tradeOrder &amp;&amp; <span class="string">"DRAFT"</span>.equals(tradeOrder.getStatus())) &#123;</div><div class="line">       <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“æˆåŠŸ</span></div><div class="line">       tradeOrder.confirm();</div><div class="line">       tradeOrderRepository.update(tradeOrder);</div><div class="line">       <span class="comment">// æ›´æ–°å¢åŠ å•†åº—æ‹¥æœ‰è€…ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢</span></div><div class="line">       CapitalAccount transferToAccount = capitalAccountRepository.findByUserId(tradeOrderDto.getOppositeUserId());</div><div class="line">       transferToAccount.transferTo(tradeOrderDto.getAmount());</div><div class="line">       capitalAccountRepository.save(transferToAccount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</li><li><strong>åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€</strong>ã€‚å› ä¸º <code>#record()</code> æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹ã€‚</li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/TradeOrderRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>TradeOrderRepository#update(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>æˆåŠŸ</strong>ã€‚</li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/CapitalAccountRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CapitalAccountRepository#save(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°å¢åŠ å•†åº—æ‹¥æœ‰è€…ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CapitalAccount.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transferTo</span><span class="params">(BigDecimal amount)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.balanceAmount = <span class="keyword">this</span>.balanceAmount.add(amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><p><strong>çº¢åŒ…æœåŠ¡</strong></p><p>å’Œ<strong>èµ„æºæœåŠ¡</strong> 99.99% ç›¸åŒï¼Œä¸é‡å¤â€œå¤åˆ¶ç²˜è´´â€ã€‚</p><h3 id="4-2-2-Cancel"><a href="#4-2-2-Cancel" class="headerlink" title="4.2.2 Cancel"></a>4.2.2 Cancel</h3><p><strong>å•†åŸæœåŠ¡</strong></p><p>è°ƒç”¨ <code>PaymentServiceImpl#cancelMakePayment(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜<strong>å¤±è´¥</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelMakePayment</span><span class="params">(Order order, BigDecimal redPacketPayAmount, BigDecimal capitalPayAmount)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"order cancel make payment called.time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜å¤±è´¥</span></div><div class="line">   order.cancelPayment();</div><div class="line">   orderRepository.updateOrder(order);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ç”Ÿäº§ä»£ç è¯¥æ–¹æ³•éœ€è¦åŠ ä¸‹ @Transactional æ³¨è§£ï¼Œä¿è¯åŸå­æ€§</strong>ã€‚</li><li><p>è°ƒç”¨ <code>OrderRepository#updateOrder(...)</code> æ–¹æ³•ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜å¤±è´¥ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Order.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelPayment</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.status = <span class="string">"PAY_FAILED"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><p><strong>èµ„é‡‘æœåŠ¡</strong></p><p>è°ƒç”¨ <code>CapitalTradeOrderServiceImpl#cancelRecord(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>å¤±è´¥</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;</div><div class="line">   <span class="comment">// è°ƒè¯•ç”¨</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Thread.sleep(<span class="number">1000l</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">   &#125;</div><div class="line">   System.out.println(<span class="string">"capital cancel record called. time seq:"</span> + DateFormatUtils.format(Calendar.getInstance(), <span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</div><div class="line">   <span class="comment">// æŸ¥è¯¢äº¤æ˜“è®°å½•</span></div><div class="line">   TradeOrder tradeOrder = tradeOrderRepository.findByMerchantOrderNo(tradeOrderDto.getMerchantOrderNo());</div><div class="line">   <span class="comment">// åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€ã€‚å› ä¸º `#record()` æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != tradeOrder &amp;&amp; <span class="string">"DRAFT"</span>.equals(tradeOrder.getStatus())) &#123;</div><div class="line">       <span class="comment">// / æ›´æ–°è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“å¤±è´¥</span></div><div class="line">       tradeOrder.cancel();</div><div class="line">       tradeOrderRepository.update(tradeOrder);</div><div class="line">       <span class="comment">// æ›´æ–°å¢åŠ ( æ¢å¤ )ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢</span></div><div class="line">       CapitalAccount capitalAccount = capitalAccountRepository.findByUserId(tradeOrderDto.getSelfUserId());</div><div class="line">       capitalAccount.cancelTransfer(tradeOrderDto.getAmount());</div><div class="line">       capitalAccountRepository.save(capitalAccount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è®¾ç½®æ–¹æ³•æ³¨è§£ @Transactionalï¼Œä¿è¯æ–¹æ³•æ“ä½œåŸå­æ€§ã€‚</li><li><strong>åˆ¤æ–­äº¤æ˜“è®°å½•çŠ¶æ€</strong>ã€‚å› ä¸º <code>#record()</code> æ–¹æ³•ï¼Œå¯èƒ½äº‹åŠ¡å›æ»šï¼Œè®°å½•ä¸å­˜åœ¨ / çŠ¶æ€ä¸å¯¹ã€‚</li><li>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/TradeOrderRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>TradeOrderRepository#update(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°äº¤æ˜“è®¢å•çŠ¶æ€ä¸ºäº¤æ˜“<strong>å¤±è´¥</strong>ã€‚</li><li><p>è°ƒç”¨ <a href="https://github.com/YunaiV/tcc-transaction/blob/ff443d9e6d39bd798ed042034bad123b83675922/tcc-transaction-tutorial-sample/tcc-transaction-http-sample/tcc-transaction-http-capital/src/main/java/org/mengyun/tcctransaction/sample/http/capital/domain/repository/CapitalAccountRepository.java" rel="external nofollow noopener noreferrer" target="_blank"><code>CapitalAccountRepository#save(...)</code></a> æ–¹æ³•ï¼Œæ›´æ–°å¢åŠ ( æ¢å¤ )ä¸‹å•ç”¨æˆ·çš„èµ„é‡‘è´¦æˆ·ä½™é¢ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CapitalAccount.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelTransfer</span><span class="params">(BigDecimal amount)</span> </span>&#123;</div><div class="line">    transferTo(amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><hr><p><strong>çº¢åŒ…æœåŠ¡</strong></p><p>å’Œ<strong>èµ„æºæœåŠ¡</strong> 99.99% ç›¸åŒï¼Œä¸é‡å¤â€œå¤åˆ¶ç²˜è´´â€ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å˜¿å˜¿ï¼Œä»£ç åªæ˜¯çœ‹èµ·æ¥æ¯”è¾ƒå¤šï¼Œå®é™…ä¸å¤šã€‚</p><p>èš‚èšé‡‘èäº‘æä¾›äº†é“¶è¡Œé—´è½¬è´¦çš„ TCC è¿‡ç¨‹ä¾‹å­ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ï¼š<a href="https://www.cloud.alipay.com/docs/2/46886" rel="external nofollow noopener noreferrer" target="_blank">ã€Šèš‚èšé‡‘èäº‘ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼ˆDTSï¼‰ â€”â€” åœºæ™¯ä»‹ç»ã€‹</a>ã€‚</p><p>æœ¬ç³»åˆ— EOF ~æ’’èŠ±</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_15/05.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸ªæœ‹å‹åœˆï¼Œå¯å¥½ï¼Ÿï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-%E5%AE%
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” è¿ç»´å¹³å°</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/console/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/console/</id>
    <published>2018-02-27T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. æ•°æ®è®¿é—®å±‚</a><ul><li><a href="#">2.1 JDBC äº‹åŠ¡ DAO</a></li><li><a href="#">2.2 Redis äº‹åŠ¡ DAO</a></li></ul></li><li><a href="#">3. æ§åˆ¶å±‚</a><ul><li><a href="#">3.1 æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨</a></li><li><a href="#">3.2 é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>è¿ç»´å¹³å°</strong>ã€‚TCC-Transaction æä¾›äº†ç›¸å¯¹ç²¾ç®€çš„è¿ç»´å¹³å°ï¼Œç”¨äºæŸ¥çœ‹åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>æåˆ°çš„<strong>äº‹åŠ¡å­˜å‚¨</strong>ã€‚ç›®å‰æš‚æ—¶åªæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul><li>æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨</li><li>é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°</li></ul><p>è¿ç»´å¹³å°( Maven é¡¹ç›® <code>tcc-transaction-server</code> ) æ•´ä½“ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/01.png" alt=""></p><p>æœ¬æ–‡è‡ªä¸‹è€Œä¸Šï¼ŒDao =&gt; Controller =&gt; UI çš„é¡ºåºè¿›è¡Œè§£æå®ç°ã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1 id="2-æ•°æ®è®¿é—®å±‚"><a href="#2-æ•°æ®è®¿é—®å±‚" class="headerlink" title="2. æ•°æ®è®¿é—®å±‚"></a>2. æ•°æ®è®¿é—®å±‚</h1><p><code>org.mengyun.tcctransaction.server.dao.TransactionDao</code>ï¼Œäº‹åŠ¡Dao <strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDao</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡ VO æ•°ç»„</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> domain é¢†åŸŸ</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum ç¬¬å‡ é¡µ</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize åˆ†é¡µå¤§å°</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡ VO æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;TransactionVo&gt; <span class="title">findTransactions</span><span class="params">(String domain, Integer pageNum, <span class="keyword">int</span> pageSize)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡æ€»æ•°é‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> domain é¢†åŸŸ</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Integer <span class="title">countOfFindTransactions</span><span class="params">(String domain)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡ç½®äº‹åŠ¡é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> domain é¢†åŸŸ</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> globalTxId å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> branchQualifier åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦é‡ç½®æˆåŠŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resetRetryCount</span><span class="params">(String domain, <span class="keyword">byte</span>[] globalTxId, <span class="keyword">byte</span>[] branchQualifier)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>TCC-Transaction æä¾›äº†å››ç§äº‹åŠ¡å­˜å‚¨å™¨ï¼Œä½†æ˜¯ç›®å‰åªæ”¯æŒä¸¤ç§æ•°æ®è®¿é—®å±‚çš„å®ç°ï¼š</p><ul><li>JDBC äº‹åŠ¡ DAO</li><li>Redis äº‹åŠ¡ DAO</li></ul><h2 id="2-1-JDBC-äº‹åŠ¡-DAO"><a href="#2-1-JDBC-äº‹åŠ¡-DAO" class="headerlink" title="2.1 JDBC äº‹åŠ¡ DAO"></a>2.1 JDBC äº‹åŠ¡ DAO</h2><p><code>org.mengyun.tcctransaction.server.dao.JdbcTransactionDao</code>ï¼ŒJDBC äº‹åŠ¡ DAO å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Repository</span>(<span class="string">"jdbcTransactionDao"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionDao</span> <span class="keyword">implements</span> <span class="title">TransactionDao</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_NAME_PREFIX = <span class="string">"TCC_TRANSACTION"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯»å– jdbc-domain-suffix.properties</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;jdbcDomainSuffix&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> Properties domainSuffix;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>dataSource</code>ï¼Œæ•°æ®æºã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-server-dao.xml </div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span></span></div><div class="line"><span class="tag">     <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></div><div class="line"><span class="tag">     <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"50"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"30"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandonedTimeout"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"1000"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeBetweenEvictionRunsMillis"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"numTestsPerEvictionRun"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validationQuery"</span> <span class="attr">value</span>=<span class="string">"SELECT NOW() FROM DUAL"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">// tcc-transaction-server.properties</div><div class="line">jdbc.url=jdbc:mysql://127.0.0.1:33061/TCC?useUnicode=true&amp;characterEncoding=UTF-8</div><div class="line">jdbc.username=root</div><div class="line">jdbc.password=123456</div></pre></td></tr></table></figure><ul><li>åœ¨ <code>appcontext-server-dao.xml</code>ï¼Œé…ç½®æ•°æ®æº Bean å¯¹è±¡ã€‚</li><li>åœ¨ <code>tcc-transaction-server.properties</code>ï¼Œé…ç½®æ•°æ®æºå±æ€§ã€‚</li></ul></li><li><p><code>domainSuffix</code>ï¼Œ<code>domian</code> å’Œ è¡¨åç¼€( <code>suffix</code> ) çš„æ˜ å°„å…³ç³»ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// jdbc-domain-suffix.properties</div><div class="line">CAPITAL=_CAP</div><div class="line">ORDER=_ORD</div><div class="line">REDPACKET=_RED</div></pre></td></tr></table></figure><ul><li>é”® ï¼šdomainã€‚</li><li>å€¼ ï¼šsuffixã€‚</li></ul></li></ul><p>JdbcTransactionDao ä»£ç å®ç°ä¸Šæ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/e54c3e43a2e47a7765bdb18a485860cb31acbb72/tcc-transaction-server/src/main/java/org/mengyun/tcctransaction/server/dao/JdbcTransactionDao.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šã€‚</p><h2 id="2-2-Redis-äº‹åŠ¡-DAO"><a href="#2-2-Redis-äº‹åŠ¡-DAO" class="headerlink" title="2.2 Redis äº‹åŠ¡ DAO"></a>2.2 Redis äº‹åŠ¡ DAO</h2><p><code>org.mengyun.tcctransaction.server.dao.RedisTransactionDao</code>ï¼ŒRedis äº‹åŠ¡ DAOã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Repository</span>(<span class="string">"redisTransactionDao"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTransactionDao</span> <span class="keyword">implements</span> <span class="title">TransactionDao</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * redis pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> JedisPool jedisPool;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯»å– redis-domain-key-prefix.properties</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;redisDomainKeyPrefix&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> Properties domainKeyPrefix;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>jedisPool</code>ï¼ŒRedis è¿æ¥æ± ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-server-dao.xml</div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"300"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"3000"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPool"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPool"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"jedisPoolConfig"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.host&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.port&#125;"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"3"</span> <span class="attr">value</span>=<span class="string">"6000"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"4"</span> <span class="attr">type</span>=<span class="string">"java.lang.String"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">null</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"5"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.db&#125;"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">// tcc-transaction-server.properties</div><div class="line">redis.host=127.0.0.1</div><div class="line">redis.port=6379</div><div class="line">redis.password=</div><div class="line">redis.db=0</div></pre></td></tr></table></figure><ul><li>åœ¨ <code>appcontext-server-dao.xml</code>ï¼Œé…ç½® Redis è¿æ¥æ±  Bean å¯¹è±¡ã€‚</li><li>åœ¨ <code>tcc-transaction-server.properties</code>ï¼Œé…ç½® Redis è¿æ¥æ± å±æ€§ã€‚</li></ul></li><li><p><code>domainKeyPrefix</code>ï¼Œdomain å’Œ Redis Key å‰ç¼€( <code>prefix</code> )çš„æ˜ å°„ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">CAPITAL=TCC:CAP:</div><div class="line">ORDER=TCC:ORD:</div><div class="line">REDPACKET=TCC:RED:</div></pre></td></tr></table></figure><ul><li>é”® ï¼šdomainã€‚</li><li>å€¼ ï¼šsuffixã€‚</li></ul></li></ul><p>RedisTransactionDao ä»£ç å®ç°ä¸Šæ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»[é“¾æ¥]<a href="https://github.com/YunaiV/tcc-transaction/blob/e54c3e43a2e47a7765bdb18a485860cb31acbb72/tcc-transaction-server/src/main/java/org/mengyun/tcctransaction/server/dao/RedisTransactionDao.java)æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šã€‚" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/tcc-transaction/blob/e54c3e43a2e47a7765bdb18a485860cb31acbb72/tcc-transaction-server/src/main/java/org/mengyun/tcctransaction/server/dao/RedisTransactionDao.java)æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šã€‚</a></p><h1 id="3-æ§åˆ¶å±‚"><a href="#3-æ§åˆ¶å±‚" class="headerlink" title="3. æ§åˆ¶å±‚"></a>3. æ§åˆ¶å±‚</h1><p><code>org.mengyun.tcctransaction.server.controller.TransactionController</code>ï¼Œäº‹åŠ¡ Controllerã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEFAULT_PAGE_NUM = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PAGE_SIZE = <span class="number">10</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®è®¿é—®å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="meta">@Qualifier</span>(<span class="string">"jdbcTransactionDao"</span>)</div><div class="line">    <span class="keyword">private</span> TransactionDao transactionDao;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¡¹ç›®è®¿é—®æ ¹ç›®å½•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;tcc_domain&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String tccDomain;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>transactionDao</code>ï¼Œæ•°æ®è®¿é—®å¯¹è±¡ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-server-dao.xml</div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionDao"</span> <span class="attr">class</span>=<span class="string">"org.mengyun.tcctransaction.server.dao.JdbcTransactionDao"</span>/&gt;</span></div></pre></td></tr></table></figure><ul><li>ç›®å‰è¿ç»´å¹³å°åªèƒ½è¯»å–ä¸€ä¸ªæ•°æ®æºï¼Œå¦‚æœä½ çš„æ•°æ®æºæ˜¯å¤šä¸ªï¼Œéœ€è¦å¯¹è¿ç»´å¹³å°åšä¸€å®šçš„æ”¹é€ ï¼Œæˆ–å¯åŠ¨å¤šä¸ªé¡¹ç›®ã€‚</li></ul></li><li><p><code>tccDomain</code>ï¼Œé¡¹ç›®è®¿é—®æ ¹ç›®å½•ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>  <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// tcc-transaction-server.properties</div><div class="line">tcc_domain=</div></pre></td></tr></table></figure><ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ä¸ç”¨é…ç½®ï¼Œå¦‚æœä½ æ”¾åœ¨ Tomcat æ ¹ç›®å½•ã€‚</li></ul></li></ul><h2 id="3-1-æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨"><a href="#3-1-æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨" class="headerlink" title="3.1 æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨"></a>3.1 æŸ¥çœ‹æœªå®Œæˆçš„äº‹åŠ¡åˆ—è¡¨</h2><p>è°ƒç”¨ <code>TransactionController#manager(...)</code> æ–¹æ³•ï¼ŒæŸ¥çœ‹äº‹åŠ¡åˆ—è¡¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/management"</span>, method = RequestMethod.GET)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">manager</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"manager"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/management/domain/&#123;domain&#125;"</span>, method = RequestMethod.GET)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">manager</span><span class="params">(@PathVariable String domain)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> manager(domain, DEFAULT_PAGE_NUM);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/management/domain/&#123;domain&#125;/pagenum/&#123;pageNum&#125;"</span>, method = RequestMethod.GET)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">manager</span><span class="params">(@PathVariable String domain, @PathVariable Integer pageNum)</span> </span>&#123;</div><div class="line">   ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView(<span class="string">"manager"</span>);</div><div class="line">   <span class="comment">// è·å¾—äº‹åŠ¡ VO æ•°ç»„</span></div><div class="line">   List&lt;TransactionVo&gt; transactionVos = transactionDao.findTransactions(domain, pageNum, DEFAULT_PAGE_SIZE);</div><div class="line">   <span class="comment">// è·å¾—äº‹åŠ¡æ€»æ•°é‡</span></div><div class="line">   Integer totalCount = transactionDao.countOfFindTransactions(domain);</div><div class="line">   <span class="comment">// è®¡ç®—æ€»é¡µæ•°</span></div><div class="line">   Integer pages = totalCount / DEFAULT_PAGE_SIZE;</div><div class="line">   <span class="keyword">if</span> (totalCount % DEFAULT_PAGE_SIZE &gt; <span class="number">0</span>) &#123;</div><div class="line">       pages++;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›</span></div><div class="line">   modelAndView.addObject(<span class="string">"transactionVos"</span>, transactionVos);</div><div class="line">   modelAndView.addObject(<span class="string">"pageNum"</span>, pageNum);</div><div class="line">   modelAndView.addObject(<span class="string">"pageSize"</span>, DEFAULT_PAGE_SIZE);</div><div class="line">   modelAndView.addObject(<span class="string">"pages"</span>, pages);</div><div class="line">   modelAndView.addObject(<span class="string">"domain"</span>, domain);</div><div class="line">   modelAndView.addObject(<span class="string">"urlWithoutPaging"</span>, tccDomain + <span class="string">"/management/domain/"</span> + domain);</div><div class="line">   <span class="keyword">return</span> modelAndView;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>UI ç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/02.png" alt=""></p><h2 id="3-2-é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°"><a href="#3-2-é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°" class="headerlink" title="3.2 é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°"></a>3.2 é‡ç½®äº‹åŠ¡æ¢å¤é‡è¯•æ¬¡æ•°</h2><p>è°ƒç”¨ <code>TransactionController#reset(...)</code> æ–¹æ³•ï¼Œäº‹åŠ¡é‡ç½®é‡è¯•æ¬¡æ•°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/domain/&#123;domain&#125;/retry/reset"</span>, method = RequestMethod.PUT)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> CommonResponse&lt;Void&gt; <span class="title">reset</span><span class="params">(@PathVariable String domain, String globalTxId, String branchQualifier)</span> </span>&#123;</div><div class="line">   transactionDao.resetRetryCount(domain,</div><div class="line">           DatatypeConverter.parseHexBinary(globalTxId),</div><div class="line">           DatatypeConverter.parseHexBinary(branchQualifier));</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CommonResponse&lt;Void&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>UI ç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/03.png" alt=""></p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å¯èƒ½æœ‰äººä¼šåæ§½è¿ç»´å¹³å°æ€ä¹ˆåšçš„è¿™ä¹ˆç®€é™‹ã€‚è¿™ä¸ªä¸æ˜¯ TCC-Transaction ä¸€ä¸ªå¼€æºé¡¹ç›®å­˜åœ¨çš„é—®é¢˜ï¼Œå…¶ä»–ä¾‹å¦‚ Dubboã€Disconf ç­‰ç­‰éƒ½ä¼šå­˜åœ¨è¿™ä¸ªæƒ…å†µã€‚</p><p>å¼€æºä½œè€…å› ä¸ºæ—¶é—´å…³ç³»ï¼Œæ›´å¤šçš„ç²¾åŠ›å…³æ³¨åœ¨æ ¸å¿ƒä»£ç ï¼Œæ‰€ä»¥å¯¹è¿ç»´å‹å¥½æ€§å¯èƒ½èŠ±è´¹çš„ç²¾åŠ›è¾ƒå°‘ã€‚</p><p>å½“ç„¶ï¼Œå› ä¸ºæ˜¯å¼€æºçš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±åšè¿ç»´å¹³å°åå‘çš„è´¡çŒ®åˆ°è¿™äº›é¡¹ç›®ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_28/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. æ•°æ®è®¿é—®å±‚&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a hre
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒ</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/dubbo-support/</id>
    <published>2018-02-27T16:00:00.000Z</published>
    <updated>2017-09-26T18:05:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. æ¦‚è¿°</a></li><li><a href="#2-dubbo-%E4%BB%A3%E7%90%86">2. Dubbo ä»£ç†</a><ul><li><a href="#21-javassistproxyfactory">2.1 JavassistProxyFactory</a><ul><li><a href="#211-javassist">2.1.1 Javassist</a></li><li><a href="#212-tccjavassistproxyfactory">2.1.2 TccJavassistProxyFactory</a></li><li><a href="#213-tccproxy--tccclassgenerator">2.1.3 TccProxy &amp; TccClassGenerator</a></li><li><a href="#214-%E9%85%8D%E7%BD%AE-dubbo-proxy">2.1.4 é…ç½® Dubbo Proxy</a></li></ul></li><li><a href="#22-jdkproxyfactory">2.2 JdkProxyFactory</a><ul><li><a href="#221-jdk-proxy">2.2.1 JDK Proxy</a></li><li><a href="#222-tccjdkproxyfactory">2.2.2 TccJdkProxyFactory</a></li><li><a href="#223-tccinvokerinvocationhandler">2.2.3 TccInvokerInvocationHandler</a></li><li><a href="#224-%E9%85%8D%E7%BD%AE-dubbo-proxy">2.2.4 é…ç½® Dubbo Proxy</a></li></ul></li></ul></li><li><a href="#3-dubbo-%E4%BA%8B%E5%8A%A1%E4%B8%8A%E4%B8%8B%E6%96%87%E7%BC%96%E8%BE%91%E5%99%A8">3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</a></li><li><a href="#666-%E5%BD%A9%E8%9B%8B">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>Dubbo æ”¯æŒ</strong>ã€‚</p><p>TCC-Transaction é€šè¿‡ Dubbo <strong>éšå¼ä¼ å‚</strong>çš„åŠŸèƒ½ï¼Œé¿å…è‡ªå·±å¯¹ä¸šåŠ¡ä»£ç çš„å…¥ä¾µã€‚å¯èƒ½æœ‰åŒå­¦ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆè¯´ TCC-Transaction å¯¹ä¸šåŠ¡ä»£ç æœ‰ä¸€å®šçš„å…¥ä¾µæ€§ï¼Œä¸€èµ·æ¥çœ‹ä¸ªä»£ç ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»£ç æ¥è‡ª <code>tcc-transaction-http-sample</code> ã€‚å£°æ˜è¿œç¨‹è°ƒç”¨æ—¶ï¼Œå¢åŠ äº†å‚æ•° TransactionContextã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå·±ä½¿ç”¨çš„è¿œç¨‹è°ƒç”¨æ¡†æ¶åšä¸€å®šå°è£…ï¼Œé¿å…å…¥ä¾µã€‚</li></ul><p>å¦‚ä¸‹æ˜¯å¯¹ Dubbo å°è£…äº†åï¼ŒDubbo Service æ–¹æ³•çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä»£ç æ¥è‡ª <code>http-transaction-dubbo-sample</code> ã€‚æ˜¯ä¸æ˜¯ä¸éœ€è¦ä¼ å…¥å‚æ•° TransactionContextã€‚å½“ç„¶ï¼Œæ³¨è§£æ˜¯è‚¯å®šéœ€è¦çš„ï¼Œå¦åˆ™ TCC-Transaction æ€ä¹ˆçŸ¥é“å“ªäº›æ–¹æ³•æ˜¯ TCC æ–¹æ³•ã€‚</li></ul><p>TCC-Transaction é€šè¿‡ Dubbo Proxy çš„æœºåˆ¶ï¼Œå®ç° <code>@Compensable</code> å±æ€§è‡ªåŠ¨ç”Ÿæˆï¼Œå¢åŠ å¼€å‘ä½“éªŒï¼Œä¹Ÿé¿å…å‡ºé”™ã€‚</p><hr><p>Dubbo æ”¯æŒ( Maven é¡¹ç›® <code>tcc-transaction-dubbo</code> ) æ•´ä½“ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/01.png" alt=""></p><ul><li><code>proxy</code></li><li><code>context</code></li></ul><p>æˆ‘ä»¬åˆ†æˆä¸¤ä¸ªå°èŠ‚åˆ†äº«è¿™ä¸¤ä¸ªåŒ…å®ç°çš„åŠŸèƒ½ã€‚</p><p><strong>ç¬”è€…æš‚æ—¶å¯¹ Dubbo äº†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¦‚æœæœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜çƒ¦è¯·æŒ‡å‡ºï¼Œè°¢è°¢ã€‚</strong></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1 id="2-Dubbo-ä»£ç†"><a href="#2-Dubbo-ä»£ç†" class="headerlink" title="2. Dubbo ä»£ç†"></a>2. Dubbo ä»£ç†</h1><p>å°† Dubbo Service æ–¹æ³•ä¸Šçš„<strong>æ³¨è§£</strong> <code>@Compensable</code> ï¼Œè‡ªåŠ¨ç”Ÿæˆæ³¨è§£çš„ <code>confirmMethod</code>ã€<code>cancelMethod</code>ã€<code>transactionContextEditor</code> å±æ€§ï¼Œä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Compensable</span>(propagation=Propagation.SUPPORTS, confirmMethod=<span class="string">"record"</span>, cancelMethod=<span class="string">"record"</span>, transactionContextEditor=DubboTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¯¥ä»£ç é€šè¿‡ Javassist ç”Ÿæˆçš„ Proxy ä»£ç çš„ç¤ºä¾‹ã€‚</li><li><code>propagation=Propagation.SUPPORTS</code> ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚<strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ REQUIRED</strong> ï¼Ÿå¦‚æœä½¿ç”¨ REQUIRED äº‹åŠ¡ä¼ æ’­çº§åˆ«ï¼Œäº‹åŠ¡æ¢å¤é‡è¯•æ—¶ï¼Œä¼šå‘èµ·æ–°çš„äº‹åŠ¡ã€‚</li><li><code>confirmMethod</code>ã€<code>cancelMethod</code> ä½¿ç”¨å’Œ try æ–¹æ³•<strong>ç›¸åŒæ–¹æ³•å</strong>ï¼š<strong>æœ¬åœ°å‘èµ·</strong>è¿œç¨‹æœåŠ¡ TCC confirm / cancel é˜¶æ®µï¼Œè°ƒç”¨ç›¸åŒæ–¹æ³•è¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚è¿œç¨‹æœåŠ¡çš„ CompensableTransactionInterceptor ä¼šæ ¹æ®äº‹åŠ¡çš„çŠ¶æ€æ˜¯ CONFIRMING / CANCELLING æ¥è°ƒç”¨å¯¹åº”æ–¹æ³•ã€‚<ul><li><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/02.png" alt=""> </li></ul></li><li><code>transactionContextEditor=DubboTransactionContextEditor.class</code>ï¼Œä½¿ç”¨ Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ï¼Œåœ¨<a href="#">ã€Œ3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ã€</a>è¯¦ç»†åˆ†äº«ã€‚</li></ul><p>Dubbo Service Proxy æä¾›äº†ä¸¤ç§ç”Ÿæˆæ–¹å¼ï¼š</p><ul><li>JavassistProxyFactoryï¼ŒåŸºäº Javassist æ–¹å¼</li><li>JdkProxyFactoryï¼ŒåŸºäº JDK åŠ¨æ€ä»£ç†æœºåˆ¶</li></ul><p>è¿™å—å†…å®¹æˆ‘ä»¬ä¸æ‹“å±•å¼€ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»å¦‚ä¸‹æ–‡ç« ï¼š</p><ul><li><a href="http://daveztong.github.io/2016/11/23/Dubbo%E5%AD%A6%E4%B9%A0-%E7%90%86%E8%A7%A3%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboå­¦ä¹ -ç†è§£åŠ¨æ€ä»£ç†ã€‹</a></li><li><a href="http://javatar.iteye.com/blog/814426" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubbo ä½œè€…åšå®¢ â€”â€” åŠ¨æ€ä»£ç†æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”ã€‹</a></li><li><a href="http://blog.csdn.net/quhongwei_zhanqiu/article/details/41597261" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboåŸç†è§£æ-ä»£ç†ä¹‹Javassistç”Ÿæˆçš„ä¼ªä»£ç ã€‹</a></li><li><strong><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboçš„æœåŠ¡æš´éœ²ç»†èŠ‚ã€‹</a></strong></li></ul><p>Dubbo çš„ Invoker æ¨¡å‹æ˜¯éå¸¸å…³é”®çš„æ¦‚å¿µï¼Œçœ‹ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/03.jpeg" alt=""></p><h2 id="2-1-JavassistProxyFactory"><a href="#2-1-JavassistProxyFactory" class="headerlink" title="2.1 JavassistProxyFactory"></a>2.1 JavassistProxyFactory</h2><h3 id="2-1-1-Javassist"><a href="#2-1-1-Javassist" class="headerlink" title="2.1.1 Javassist"></a>2.1.1 Javassist</h3><blockquote><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»º Java å­—èŠ‚ç çš„ç±»åº“ã€‚é€šè¿‡ä½¿ç”¨Javassist å¯¹å­—èŠ‚ç æ“ä½œå¯ä»¥å®ç°åŠ¨æ€ â€AOPâ€ æ¡†æ¶ã€‚  </p><p>å…³äº Java å­—èŠ‚ç çš„å¤„ç†ï¼Œç›®å‰æœ‰å¾ˆå¤šå·¥å…·ï¼Œå¦‚ bcelï¼Œasm( cglibåªæ˜¯å¯¹asmåˆå°è£…äº†ä¸€å±‚ )ã€‚ä¸è¿‡è¿™äº›éƒ½éœ€è¦ç›´æ¥è·Ÿè™šæ‹ŸæœºæŒ‡ä»¤æ‰“äº¤é“ã€‚  </p><p>Javassist çš„ä¸»è¦çš„ä¼˜ç‚¹ï¼Œåœ¨äºç®€å•ï¼Œè€Œä¸”å¿«é€Ÿï¼Œç›´æ¥ä½¿ç”¨ Java ç¼–ç çš„å½¢å¼ï¼Œè€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„ï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚  </p></blockquote><ul><li>ç²—ç•¥ä¸€çœ‹ï¼Œå¯èƒ½ä¸å¤Ÿå½¢è±¡ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡çœ‹ TCC-Transaction å¦‚ä½•ä½¿ç”¨æ¥ç†è§£ç†è§£ã€‚</li><li><a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­¦ä¹ ä¹‹javassist<br>ã€‹</a></li><li><a href="http://blog.csdn.net/qbg19881206/article/details/8993562" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavassist å­—èŠ‚ç æ“ä½œã€‹</a></li></ul><h3 id="2-1-2-TccJavassistProxyFactory"><a href="#2-1-2-TccJavassistProxyFactory" class="headerlink" title="2.1.2 TccJavassistProxyFactory"></a>2.1.2 TccJavassistProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</code>ï¼ŒTCC Javassist ä»£ç†å·¥å‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJavassistProxyFactory</span> <span class="keyword">extends</span> <span class="title">JavassistProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) TccProxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>é¡¹ç›®å¯åŠ¨æ—¶</strong>ï¼Œè°ƒç”¨ <code>TccJavassistProxyFactory#getProxy(...)</code> æ–¹æ³•ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxyã€‚</li><li><code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>ï¼ŒDubbo è°ƒç”¨å¤„ç†å™¨ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li></ul><h3 id="2-1-3-TccProxy-amp-TccClassGenerator"><a href="#2-1-3-TccProxy-amp-TccClassGenerator" class="headerlink" title="2.1.3 TccProxy &amp; TccClassGenerator"></a>2.1.3 TccProxy &amp; TccClassGenerator</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy</code>ï¼ŒTCC Proxy å·¥å‚ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy ã€‚ç¬”è€…è®¤ä¸ºï¼ŒTccProxy æ”¹æˆ TccProxyFactory æ›´åˆé€‚ï¼ŒåŸå› åœ¨ä¸‹æ–‡ã€‚</p><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator</code>ï¼ŒTCC ç±»ä»£ç ç”Ÿæˆå™¨ï¼ŒåŸºäº Javassist å®ç°ã€‚ </p><p><strong>ğŸ¦…æ¡ˆä¾‹</strong></p><p>ä¸€ä¸ª Dubbo Serviceï¼ŒTccProxy ä¼šåŠ¨æ€ç”Ÿæˆä¸¤ä¸ªç±»ï¼š</p><ul><li>Dubbo Service è°ƒç”¨ Proxy</li><li>Dubbo Service è°ƒç”¨ ProxyFactoryï¼Œç”Ÿæˆå¯¹åº”çš„ Dubbo Service Proxy</li></ul><p>ä¾‹å¦‚ Dubbo Service æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>ProxyFactory</strong> å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccProxy3</span> <span class="keyword">extends</span> <span class="title">TccProxy</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>TccProxy æä¾› <code>#newInstance(handler)</code> æ–¹æ³•ï¼Œåˆ›å»º Proxyï¼Œæ‰€ä»¥ç¬”è€…è®¤ä¸ºï¼ŒTccProxy æ”¹æˆ TccProxyFactory æ›´åˆé€‚ã€‚</li><li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li></ul><p>ç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy3</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span>, <span class="title">RedPacketTradeOrderService</span>, <span class="title">EchoService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method[] methods;</div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.handler = paramInvocationHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span>(propagation = Propagation.SUPPORTS, confirmMethod = <span class="string">"record"</span>, cancelMethod = <span class="string">"record"</span>, transactionContextEditor = DubboTransactionContextEditor.class)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (String) localObject;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Object $echo(Object paramObject) &#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramObject;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">1</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (Object) localObject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>com.alibaba.dubbo.rpc.service.EchoService</code>ï¼ŒDubbo Service å›å£°æœåŠ¡æ¥å£ï¼Œç”¨äºæœåŠ¡å¥åº·æ£€æŸ¥ï¼ŒDubbo Service é»˜è®¤è‡ªåŠ¨å®ç°è¯¥æ¥å£ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/EchoService.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li><li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li></ul><p><strong>ğŸ¦…å®ç°</strong></p><p>è°ƒç”¨ <code>TccProxy#getProxy(...)</code> æ–¹æ³•ï¼Œè·å¾— <strong>TCC Proxy å·¥å‚</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// ã€TccProxy.javaã€‘</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccProxy <span class="title">getProxy</span><span class="params">(ClassLoader cl, Class&lt;?&gt;... ics)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="comment">// æ ¡éªŒæ¥å£è¶…è¿‡ä¸Šé™</span></div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (ics.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">  <span class="number">5</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// use interface class name list as key.</span></div><div class="line">  <span class="number">9</span>:     StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">10</span>:     <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">11</span>:         String itf = ic.getName();</div><div class="line"> <span class="number">12</span>:         <span class="comment">// æ ¡éªŒæ˜¯å¦ä¸ºæ¥å£</span></div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (!ic.isInterface()) &#123;</div><div class="line"> <span class="number">14</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(itf + <span class="string">" is not a interface."</span>);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:         <span class="comment">// åŠ è½½æ¥å£ç±»</span></div><div class="line"> <span class="number">17</span>:         Class&lt;?&gt; tmp = <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:             tmp = Class.forName(itf, <span class="keyword">false</span>, cl);</div><div class="line"> <span class="number">20</span>:         &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line"> <span class="number">21</span>:         &#125;</div><div class="line"> <span class="number">22</span>:         <span class="keyword">if</span> (tmp != ic) &#123; <span class="comment">// åŠ è½½æ¥å£ç±»å¤±è´¥</span></div><div class="line"> <span class="number">23</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ic + <span class="string">" is not visible from class loader"</span>);</div><div class="line"> <span class="number">24</span>:         &#125;</div><div class="line"> <span class="number">25</span>:         sb.append(itf).append(<span class="string">';'</span>);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>:     String key = sb.toString();</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:     <span class="comment">// get cache by class loader.</span></div><div class="line"> <span class="number">30</span>:     Map&lt;String, Object&gt; cache;</div><div class="line"> <span class="number">31</span>:     <span class="keyword">synchronized</span> (ProxyCacheMap) &#123;</div><div class="line"> <span class="number">32</span>:         cache = ProxyCacheMap.get(cl);</div><div class="line"> <span class="number">33</span>:         <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">34</span>:             cache = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line"> <span class="number">35</span>:             ProxyCacheMap.put(cl, cache);</div><div class="line"> <span class="number">36</span>:         &#125;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// è·å¾— TccProxy å·¥å‚</span></div><div class="line"> <span class="number">40</span>:     TccProxy proxy = <span class="keyword">null</span>;</div><div class="line"> <span class="number">41</span>:     <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"> <span class="number">42</span>:         <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">43</span>:             <span class="comment">// ä»ç¼“å­˜ä¸­è·å– TccProxy å·¥å‚</span></div><div class="line"> <span class="number">44</span>:             Object value = cache.get(key);</div><div class="line"> <span class="number">45</span>:             <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Reference&lt;?&gt;) &#123;</div><div class="line"> <span class="number">46</span>:                 proxy = (TccProxy) ((Reference&lt;?&gt;) value).get();</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">if</span> (proxy != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">48</span>:                     <span class="keyword">return</span> proxy;</div><div class="line"> <span class="number">49</span>:                 &#125;</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:             <span class="comment">// ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè®¾ç½®ç”Ÿæˆ TccProxy ä»£ç æ ‡è®°ã€‚åˆ›å»ºä¸­æ—¶ï¼Œå…¶ä»–åˆ›å»ºè¯·æ±‚ç­‰å¾…ï¼Œé¿å…å¹¶å‘ã€‚</span></div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (value == PendingGenerationMarker) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">54</span>:                     cache.wait();</div><div class="line"> <span class="number">55</span>:                 &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">58</span>:                 cache.put(key, PendingGenerationMarker);</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">60</span>:             &#125;</div><div class="line"> <span class="number">61</span>:         &#125;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">while</span> (<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="keyword">long</span> id = PROXY_CLASS_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">66</span>:     String pkg = <span class="keyword">null</span>;</div><div class="line"> <span class="number">67</span>:     TccClassGenerator ccp = <span class="keyword">null</span>; <span class="comment">// proxy class generator</span></div><div class="line"> <span class="number">68</span>:     TccClassGenerator ccm = <span class="keyword">null</span>; <span class="comment">// proxy factory class generator</span></div><div class="line"> <span class="number">69</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">70</span>:         <span class="comment">// åˆ›å»º Tcc class ä»£ç ç”Ÿæˆå™¨</span></div><div class="line"> <span class="number">71</span>:         ccp = TccClassGenerator.newInstance(cl);</div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:         Set&lt;String&gt; worked = <span class="keyword">new</span> HashSet&lt;String&gt;(); <span class="comment">// å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆã€‚keyï¼šæ–¹æ³•ç­¾å</span></div><div class="line"> <span class="number">74</span>:         List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;(); <span class="comment">// å·²å¤„ç†æ–¹æ³•é›†åˆã€‚</span></div><div class="line"> <span class="number">75</span>: </div><div class="line"> <span class="number">76</span>:         <span class="comment">// å¤„ç†æ¥å£</span></div><div class="line"> <span class="number">77</span>:         <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">78</span>:             <span class="comment">// é public æ¥å£ï¼Œä½¿ç”¨æ¥å£åŒ…å</span></div><div class="line"> <span class="number">79</span>:             <span class="keyword">if</span> (!Modifier.isPublic(ic.getModifiers())) &#123;</div><div class="line"> <span class="number">80</span>:                 String npkg = ic.getPackage().getName();</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">82</span>:                     pkg = npkg;</div><div class="line"> <span class="number">83</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">84</span>:                     <span class="keyword">if</span> (!pkg.equals(npkg)) &#123; <span class="comment">// å®ç°äº†ä¸¤ä¸ªé public çš„æ¥å£ï¼Œ</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"non-public interfaces from different packages"</span>);</div><div class="line"> <span class="number">86</span>:                     &#125;</div><div class="line"> <span class="number">87</span>:                 &#125;</div><div class="line"> <span class="number">88</span>:             &#125;</div><div class="line"> <span class="number">89</span>:             <span class="comment">// æ·»åŠ æ¥å£</span></div><div class="line"> <span class="number">90</span>:             ccp.addInterface(ic);</div><div class="line"> <span class="number">91</span>:             <span class="comment">// å¤„ç†æ¥å£æ–¹æ³•</span></div><div class="line"> <span class="number">92</span>:             <span class="keyword">for</span> (Method method : ic.getMethods()) &#123;</div><div class="line"> <span class="number">93</span>:                 <span class="comment">// æ·»åŠ æ–¹æ³•ç­¾ååˆ°å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆ</span></div><div class="line"> <span class="number">94</span>:                 String desc = ReflectUtils.getDesc(method);</div><div class="line"> <span class="number">95</span>:                 <span class="keyword">if</span> (worked.contains(desc)) &#123;</div><div class="line"> <span class="number">96</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">97</span>:                 &#125;</div><div class="line"> <span class="number">98</span>:                 worked.add(desc);</div><div class="line"> <span class="number">99</span>:                 <span class="comment">// ç”Ÿæˆæ¥å£æ–¹æ³•å®ç°ä»£ç </span></div><div class="line"><span class="number">100</span>:                 <span class="keyword">int</span> ix = methods.size();</div><div class="line"><span class="number">101</span>:                 Class&lt;?&gt; rt = method.getReturnType();</div><div class="line"><span class="number">102</span>:                 Class&lt;?&gt;[] pts = method.getParameterTypes();</div><div class="line"><span class="number">103</span>:                 StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="string">"Object[] args = new Object["</span>).append(pts.length).append(<span class="string">"];"</span>);</div><div class="line"><span class="number">104</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; pts.length; j++) &#123;</div><div class="line"><span class="number">105</span>:                     code.append(<span class="string">" args["</span>).append(j).append(<span class="string">"] = ($w)$"</span>).append(j + <span class="number">1</span>).append(<span class="string">";"</span>);</div><div class="line"><span class="number">106</span>:                 &#125;</div><div class="line"><span class="number">107</span>:                 code.append(<span class="string">" Object ret = handler.invoke(this, methods["</span>).append(ix).append(<span class="string">"], args);"</span>);</div><div class="line"><span class="number">108</span>:                 <span class="keyword">if</span> (!Void.TYPE.equals(rt)) &#123;</div><div class="line"><span class="number">109</span>:                     code.append(<span class="string">" return "</span>).append(asArgument(rt, <span class="string">"ret"</span>)).append(<span class="string">";"</span>);</div><div class="line"><span class="number">110</span>:                 &#125;</div><div class="line"><span class="number">111</span>:                 methods.add(method);</div><div class="line"><span class="number">112</span>:                 <span class="comment">// æ·»åŠ æ–¹æ³•</span></div><div class="line"><span class="number">113</span>:                 Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">114</span>:                 <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">115</span>:                     ccp.addMethod(<span class="keyword">true</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">116</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">117</span>:                     ccp.addMethod(<span class="keyword">false</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">118</span>:                 &#125;</div><div class="line"><span class="number">119</span>:             &#125;</div><div class="line"><span class="number">120</span>:         &#125;</div><div class="line"><span class="number">121</span>: </div><div class="line"><span class="number">122</span>:         <span class="comment">// è®¾ç½®åŒ…è·¯å¾„</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">124</span>:             pkg = PACKAGE_NAME;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>: </div><div class="line"><span class="number">127</span>:         <span class="comment">// create ProxyInstance class.</span></div><div class="line"><span class="number">128</span>:         <span class="comment">// è®¾ç½®ç±»å</span></div><div class="line"><span class="number">129</span>:         String pcn = pkg + <span class="string">".proxy"</span> + id;</div><div class="line"><span class="number">130</span>:         ccp.setClassName(pcn);</div><div class="line"><span class="number">131</span>:         <span class="comment">// æ·»åŠ é™æ€å±æ€§ methods</span></div><div class="line"><span class="number">132</span>:         ccp.addField(<span class="string">"public static java.lang.reflect.Method[] methods;"</span>);</div><div class="line"><span class="number">133</span>:         <span class="comment">// æ·»åŠ å±æ€§ handler</span></div><div class="line"><span class="number">134</span>:         ccp.addField(<span class="string">"private "</span> + InvocationHandler.class.getName() + <span class="string">" handler;"</span>);</div><div class="line"><span class="number">135</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° handler</span></div><div class="line"><span class="number">136</span>:         ccp.addConstructor(Modifier.PUBLIC, <span class="keyword">new</span> Class&lt;?&gt;[]&#123;InvocationHandler.class&#125;, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="string">"handler=$1;"</span>);</div><div class="line"><span class="number">137</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></div><div class="line"><span class="number">138</span>:         ccp.addDefaultConstructor();</div><div class="line"><span class="number">139</span>:         <span class="comment">// ç”Ÿæˆç±»</span></div><div class="line"><span class="number">140</span>:         Class&lt;?&gt; clazz = ccp.toClass();</div><div class="line"><span class="number">141</span>:         <span class="comment">// è®¾ç½®é™æ€å±æ€§ methods</span></div><div class="line"><span class="number">142</span>:         clazz.getField(<span class="string">"methods"</span>).set(<span class="keyword">null</span>, methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]));</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:         <span class="comment">// create TccProxy class.</span></div><div class="line"><span class="number">145</span>:         <span class="comment">// åˆ›å»º Tcc class ä»£ç ç”Ÿæˆå™¨</span></div><div class="line"><span class="number">146</span>:         ccm = TccClassGenerator.newInstance(cl);</div><div class="line"><span class="number">147</span>:         <span class="comment">// è®¾ç½®ç±»å</span></div><div class="line"><span class="number">148</span>:         String fcn = TccProxy.class.getName() + id;</div><div class="line"><span class="number">149</span>:         ccm.setClassName(fcn);</div><div class="line"><span class="number">150</span>:         <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></div><div class="line"><span class="number">151</span>:         ccm.addDefaultConstructor();</div><div class="line"><span class="number">152</span>:         <span class="comment">// è®¾ç½®çˆ¶ç±»ä¸º TccProxy.class</span></div><div class="line"><span class="number">153</span>:         ccm.setSuperClass(TccProxy.class);</div><div class="line"><span class="number">154</span>:         <span class="comment">// æ·»åŠ æ–¹æ³• #newInstance(handler)</span></div><div class="line"><span class="number">155</span>:         ccm.addMethod(<span class="string">"public Object newInstance("</span> + InvocationHandler.class.getName() + <span class="string">" h)&#123; return new "</span> + pcn + <span class="string">"($1); &#125;"</span>);</div><div class="line"><span class="number">156</span>:         <span class="comment">// ç”Ÿæˆç±»</span></div><div class="line"><span class="number">157</span>:         Class&lt;?&gt; pc = ccm.toClass();</div><div class="line"><span class="number">158</span>:         <span class="comment">// åˆ›å»º TccProxy å¯¹è±¡</span></div><div class="line"><span class="number">159</span>:         proxy = (TccProxy) pc.newInstance();</div><div class="line"><span class="number">160</span>:     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">161</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">162</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">163</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">164</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">165</span>:         <span class="comment">// release TccClassGenerator</span></div><div class="line"><span class="number">166</span>:         <span class="keyword">if</span> (ccp != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">167</span>:             ccp.release();</div><div class="line"><span class="number">168</span>:         &#125;</div><div class="line"><span class="number">169</span>:         <span class="keyword">if</span> (ccm != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">170</span>:             ccm.release();</div><div class="line"><span class="number">171</span>:         &#125;</div><div class="line"><span class="number">172</span>:         <span class="comment">// å”¤é†’ç¼“å­˜ wait</span></div><div class="line"><span class="number">173</span>:         <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"><span class="number">174</span>:             <span class="keyword">if</span> (proxy == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">175</span>:                 cache.remove(key);</div><div class="line"><span class="number">176</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">177</span>:                 cache.put(key, <span class="keyword">new</span> WeakReference&lt;TccProxy&gt;(proxy));</div><div class="line"><span class="number">178</span>:             &#125;</div><div class="line"><span class="number">179</span>:             cache.notifyAll();</div><div class="line"><span class="number">180</span>:         &#125;</div><div class="line"><span class="number">181</span>:     &#125;</div><div class="line"><span class="number">182</span>:     <span class="keyword">return</span> proxy;</div><div class="line"><span class="number">183</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 3 è‡³ 7 è¡Œ ï¼šæ ¡éªŒæ¥å£è¶…è¿‡ä¸Šé™ã€‚</li><li>ç¬¬ 8 è‡³ 27 è¡Œ ï¼šä½¿ç”¨æ¥å£é›†åˆç±»åä»¥ <code>;</code> åˆ†éš”æ‹¼æ¥ï¼Œä½œä¸º Proxy çš„å”¯ä¸€æ ‡è¯†ã€‚ä¾‹å¦‚ ï¼š<code>key=org.mengyun.tcctransaction.sample.dubbo.redpacket.api.RedPacketAccountService;com.alibaba.dubbo.rpc.service.EchoService;</code> ã€‚</li><li><p>ç¬¬ 29 è‡³ 37 è¡Œ ï¼šè·å¾— Proxy å¯¹åº”çš„ ClassLoaderã€‚è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹é™æ€å±æ€§ <code>ProxyCacheMap</code> çš„å®šä¹‰ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Proxy å¯¹è±¡ç¼“å­˜</span></div><div class="line"><span class="comment">* key ï¼šClassLoader</span></div><div class="line"><span class="comment">* value.key ï¼šTcc Proxy æ ‡è¯†ã€‚ä½¿ç”¨ Tcc Proxy å®ç°æ¥å£åæ‹¼æ¥</span></div><div class="line"><span class="comment">* value.value ï¼šTcc Proxy å·¥å‚å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, Map&lt;String, Object&gt;&gt; ProxyCacheMap = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, Map&lt;String, Object&gt;&gt;();</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ WeakHashMapï¼Œå½“ ClassLoader è¢«å›æ”¶æ—¶ï¼Œå…¶å¯¹åº”çš„å€¼ä¸€èµ·è¢«ç§»é™¤ã€‚</li><li><a href="http://blog.csdn.net/yangzl2008/article/details/6980709" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠWeakHashMapå’ŒHashMapçš„åŒºåˆ«ã€‹</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3311092.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava é›†åˆç³»åˆ—13ä¹‹ WeakHashMapè¯¦ç»†ä»‹ç»(æºç è§£æ)å’Œä½¿ç”¨ç¤ºä¾‹ã€‹</a></li></ul></li><li>ç¬¬ 39 è‡³ 63 è¡Œ ï¼šä¸€ç›´è·å¾— <strong>TCC Proxy å·¥å‚</strong>ç›´åˆ°æˆåŠŸã€‚<ul><li>ç¬¬ 43 è‡³ 50 è¡Œ ï¼šä»<strong>ç¼“å­˜</strong>ä¸­è·å– TCC Proxy å·¥å‚ã€‚</li><li>ç¬¬ 51 è‡³ 60 è¡Œ ï¼šè‹¥ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè®¾ç½®<strong>æ­£åœ¨ç”Ÿæˆ TccProxy ä»£ç æ ‡è®°</strong>ã€‚åˆ›å»ºä¸­æ—¶ï¼Œå…¶ä»–åˆ›å»ºè¯·æ±‚ç­‰å¾…ï¼Œé¿å…å¹¶å‘ã€‚</li></ul></li><li><p>ç¬¬ 65 è¡Œ ï¼š<code>PROXY_CLASS_COUNTER</code>ï¼ŒProxy Class è®¡æ•°ï¼Œç”¨äºç”Ÿæˆ Proxy ç±»åè‡ªå¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong PROXY_CLASS_COUNTER = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 66 è‡³ 67 è¡Œ</p><ul><li><code>ccm</code>ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>ProxyFactory</strong> çš„ä»£ç ç”Ÿæˆå™¨</li><li><code>ccp</code>ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> çš„ä»£ç ç”Ÿæˆå™¨</li></ul></li><li><p><strong>ç¬¬ 70 è‡³ 142 è¡Œ ï¼šç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy çš„ä»£ç </strong>ã€‚</p><ul><li><p>ç¬¬ 70 è‡³ 71 è¡Œ ï¼šè°ƒç”¨ <code>TccClassGenerator#newInstance(loader)</code> æ–¹æ³•ï¼Œ åˆ›å»ºç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy</strong> çš„ä»£ç ç”Ÿæˆå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TccClassGenerator.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TccClassGenerator</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * CtClass hash é›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šç±»å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ClassPool mPool;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccClassGenerator <span class="title">newInstance</span><span class="params">(ClassLoader loader)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TccClassGenerator(getClassPool(loader));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">TccClassGenerator</span><span class="params">(ClassPool pool)</span> </span>&#123;</div><div class="line">        mPool = pool;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ClassPool</strong> æ˜¯ä¸€ä¸ª CtClass å¯¹è±¡çš„ hash è¡¨ï¼Œç±»ååšä¸º key ã€‚ClassPool çš„ <code>#get(key)</code> æœç´¢ hash è¡¨æ‰¾åˆ°ä¸æŒ‡å®š key å…³è”çš„ CtClass å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° CtClass å¯¹è±¡ï¼Œ<code>#get(key)</code> è¯»ä¸€ä¸ªç±»æ–‡ä»¶æ„å»ºæ–°çš„ CtClass å¯¹è±¡ï¼Œå®ƒæ˜¯è¢«è®°å½•åœ¨ hash è¡¨ä¸­ç„¶åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</li></ul></li><li><p>ç¬¬ 76 è‡³ 120 è¡Œï¼Œå¤„ç†æ¥å£ã€‚</p><ul><li>ç¬¬ 79 è‡³ 88 è¡Œï¼Œç”Ÿæˆç±»çš„åŒ…åã€‚</li><li><p>ç¬¬ 89 è‡³ 90 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addInterface(cl)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆç±»çš„æ¥å£( <strong>Dubbo Service æ¥å£</strong> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„æ¥å£é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; mInterfaces;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> addInterface(cl.getName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(String cn)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mInterfaces == <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mInterfaces.add(cn);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 93 è‡³ 98 è¡Œï¼Œæ·»åŠ æ–¹æ³•ç­¾ååˆ°å·²å¤„ç†æ–¹æ³•ç­¾åé›†åˆã€‚å¤šä¸ªæ¥å£å¯èƒ½å­˜åœ¨ç›¸åŒçš„æ¥å£æ–¹æ³•ï¼Œè·³è¿‡ç›¸åŒçš„æ–¹æ³•ï¼Œé¿å…å†²çªã€‚</p></li><li><p>ç¬¬ 99 è‡³ 110 è¡Œï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨å®ç°ä»£ç ã€‚æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">  Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">  arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">  Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">  <span class="keyword">return</span> (String)localObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/04.png" alt=""></li></ul></li><li><p>ç¬¬ 112 è‡³ 118 è¡Œ ï¼šè°ƒç”¨ <code>TccClassGenerator#addMethod(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆçš„æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mMethods;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¸¦ <span class="doctag">@Compensable</span> æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; compensableMethods = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(<span class="keyword">boolean</span> isCompensableMethod, String name, <span class="keyword">int</span> mod, Class&lt;?&gt; rt, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‹¼æ¥æ–¹æ³•</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(ReflectUtils.getName(rt)).append(<span class="string">' '</span>).append(name);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">// æ˜¯å¦æœ‰ @Compensable æ³¨è§£</span></div><div class="line">   <span class="keyword">if</span> (isCompensableMethod) &#123;</div><div class="line">       compensableMethods.add(sb.toString());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> addMethod(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mMethods == <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mMethods.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li><li><p>ç¬¬ 122 è‡³ 130 è¡Œï¼Œç”Ÿæˆç±»å( ä¾‹å¦‚ï¼Œ<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.proxy3</code> )ï¼Œå¹¶è°ƒç”¨ <code>TccClassGenerator#setClassName(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç±»åã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„ç±»å</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mClassName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setClassName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">   mClassName = name;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 131 è‡³ 134 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addField(...)</code> æ–¹æ³•ï¼Œæ·»åŠ <strong>é™æ€</strong>å±æ€§ <code>methods</code> ( Dubbo Service æ–¹æ³•é›†åˆ )å’Œå±æ€§ <code>handler</code> ( Dubbo InvocationHandler )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„å±æ€§é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mFields;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addField</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mFields == <span class="keyword">null</span>) &#123;</div><div class="line">       mFields = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mFields.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 135 è‡³ 136 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addConstructor(...)</code> æ–¹æ³•ï¼Œæ·»åŠ å‚æ•°ä¸º <code>handler</code> çš„æ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„éç©ºæ„é€ æ–¹æ³•ä»£ç é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mConstructors;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(<span class="keyword">int</span> mod, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ„é€ æ–¹æ³•ä»£ç </span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(SIMPLE_NAME_TAG);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> addConstructor(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 137 è‡³ 138 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addDefaultConstructor()</code> æ–¹æ³•ï¼Œæ·»åŠ é»˜è®¤ç©ºæ„é€ æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* é»˜è®¤ç©ºæ„é€ æ–¹æ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDefaultConstructor = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addDefaultConstructor</span><span class="params">()</span> </span>&#123;</div><div class="line">   mDefaultConstructor = <span class="keyword">true</span>;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 139 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#toClass()</code> æ–¹æ³•ï¼Œ<strong>ç”Ÿæˆç±»</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> Class&lt;?&gt; toClass() &#123;</div><div class="line"> <span class="number">2</span>:    <span class="comment">// mCtc éç©ºæ—¶ï¼Œè¿›è¡Œé‡Šæ”¾ï¼›ä¸‹é¢ä¼šè¿›è¡Œåˆ›å»º mCtc</span></div><div class="line"> <span class="number">3</span>:    <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:        mCtc.detach();</div><div class="line"> <span class="number">5</span>:    &#125;</div><div class="line"> <span class="number">6</span>:    <span class="keyword">long</span> id = CLASS_NAME_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">7</span>:    <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:        CtClass ctcs = mSuperClass == <span class="keyword">null</span> ? <span class="keyword">null</span> : mPool.get(mSuperClass);</div><div class="line"> <span class="number">9</span>:        <span class="keyword">if</span> (mClassName == <span class="keyword">null</span>) &#123; <span class="comment">// ç±»å</span></div><div class="line"><span class="number">10</span>:            mClassName = (mSuperClass == <span class="keyword">null</span> || javassist.Modifier.isPublic(ctcs.getModifiers())</div><div class="line"><span class="number">11</span>:                    ? TccClassGenerator.class.getName() : mSuperClass + <span class="string">"$sc"</span>) + id;</div><div class="line"><span class="number">12</span>:        &#125;</div><div class="line"><span class="number">13</span>:        <span class="comment">// åˆ›å»º mCtc</span></div><div class="line"><span class="number">14</span>:        mCtc = mPool.makeClass(mClassName);</div><div class="line"><span class="number">15</span>:        <span class="keyword">if</span> (mSuperClass != <span class="keyword">null</span>) &#123; <span class="comment">// ç»§æ‰¿ç±»</span></div><div class="line"><span class="number">16</span>:            mCtc.setSuperclass(ctcs);</div><div class="line"><span class="number">17</span>:        &#125;</div><div class="line"><span class="number">18</span>:        mCtc.addInterface(mPool.get(DC.class.getName())); <span class="comment">// add dynamic class tag.</span></div><div class="line"><span class="number">19</span>:        <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123; <span class="comment">// å®ç°æ¥å£é›†åˆ</span></div><div class="line"><span class="number">20</span>:            <span class="keyword">for</span> (String cl : mInterfaces) &#123;</div><div class="line"><span class="number">21</span>:                mCtc.addInterface(mPool.get(cl));</div><div class="line"><span class="number">22</span>:            &#125;</div><div class="line"><span class="number">23</span>:        &#125;</div><div class="line"><span class="number">24</span>:        <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123; <span class="comment">// å±æ€§é›†åˆ</span></div><div class="line"><span class="number">25</span>:            <span class="keyword">for</span> (String code : mFields) &#123;</div><div class="line"><span class="number">26</span>:                mCtc.addField(CtField.make(code, mCtc));</div><div class="line"><span class="number">27</span>:            &#125;</div><div class="line"><span class="number">28</span>:        &#125;</div><div class="line"><span class="number">29</span>:        <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123; <span class="comment">// æ–¹æ³•é›†åˆ</span></div><div class="line"><span class="number">30</span>:            <span class="keyword">for</span> (String code : mMethods) &#123;</div><div class="line"><span class="number">31</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">32</span>:                    mCtc.addMethod(CtNewMethod.copy(getCtMethod(mCopyMethods.get(code.substring(<span class="number">1</span>))), code.substring(<span class="number">1</span>, code.indexOf(<span class="string">'('</span>)), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">33</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">34</span>:                    CtMethod ctMethod = CtNewMethod.make(code, mCtc);</div><div class="line"><span class="number">35</span>:                    <span class="keyword">if</span> (compensableMethods.contains(code)) &#123;</div><div class="line"><span class="number">36</span>:                        <span class="comment">// è®¾ç½® @Compensable å±æ€§</span></div><div class="line"><span class="number">37</span>:                        ConstPool constpool = mCtc.getClassFile().getConstPool();</div><div class="line"><span class="number">38</span>:                        AnnotationsAttribute attr = <span class="keyword">new</span> AnnotationsAttribute(constpool, AnnotationsAttribute.visibleTag);</div><div class="line"><span class="number">39</span>:                        Annotation annot = <span class="keyword">new</span> Annotation(<span class="string">"org.mengyun.tcctransaction.api.Compensable"</span>, constpool);</div><div class="line"><span class="number">40</span>:                        EnumMemberValue enumMemberValue = <span class="keyword">new</span> EnumMemberValue(constpool);</div><div class="line"><span class="number">41</span>:                        enumMemberValue.setType(<span class="string">"org.mengyun.tcctransaction.api.Propagation"</span>);</div><div class="line"><span class="number">42</span>:                        enumMemberValue.setValue(<span class="string">"SUPPORTS"</span>);</div><div class="line"><span class="number">43</span>:                        annot.addMemberValue(<span class="string">"propagation"</span>, enumMemberValue);</div><div class="line"><span class="number">44</span>:                        annot.addMemberValue(<span class="string">"confirmMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">45</span>:                        annot.addMemberValue(<span class="string">"cancelMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">46</span>:                        ClassMemberValue classMemberValue = <span class="keyword">new</span> ClassMemberValue(<span class="string">"org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor"</span>, constpool);</div><div class="line"><span class="number">47</span>:                        annot.addMemberValue(<span class="string">"transactionContextEditor"</span>, classMemberValue);</div><div class="line"><span class="number">48</span>:                        attr.addAnnotation(annot);</div><div class="line"><span class="number">49</span>:                        ctMethod.getMethodInfo().addAttribute(attr);</div><div class="line"><span class="number">50</span>:                    &#125;</div><div class="line"><span class="number">51</span>:                    mCtc.addMethod(ctMethod);</div><div class="line"><span class="number">52</span>:                &#125;</div><div class="line"><span class="number">53</span>:            &#125;</div><div class="line"><span class="number">54</span>:        &#125;</div><div class="line"><span class="number">55</span>:        <span class="keyword">if</span> (mDefaultConstructor) &#123; <span class="comment">// ç©ºå‚æ•°æ„é€ æ–¹æ³•</span></div><div class="line"><span class="number">56</span>:            mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));</div><div class="line"><span class="number">57</span>:        &#125;</div><div class="line"><span class="number">58</span>:        <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123; <span class="comment">// å¸¦å‚æ•°æ„é€ æ–¹æ³•</span></div><div class="line"><span class="number">59</span>:            <span class="keyword">for</span> (String code : mConstructors) &#123;</div><div class="line"><span class="number">60</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">61</span>:                    mCtc.addConstructor(CtNewConstructor.copy(getCtConstructor(mCopyConstructors.get(code.substring(<span class="number">1</span>))), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">62</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">63</span>:                    String[] sn = mCtc.getSimpleName().split(<span class="string">"\\$+"</span>); <span class="comment">// inner class name include $.</span></div><div class="line"><span class="number">64</span>:                    mCtc.addConstructor(CtNewConstructor.make(code.replaceFirst(SIMPLE_NAME_TAG, sn[sn.length - <span class="number">1</span>]), mCtc));</div><div class="line"><span class="number">65</span>:                &#125;</div><div class="line"><span class="number">66</span>:            &#125;</div><div class="line"><span class="number">67</span>:        &#125;</div><div class="line"><span class="number">68</span>: <span class="comment">//            mCtc.debugWriteFile("/Users/yunai/test/" + mCtc.getSimpleName().replaceAll(".", "/") + ".class");</span></div><div class="line"><span class="number">69</span>:        <span class="comment">// ç”Ÿæˆ</span></div><div class="line"><span class="number">70</span>:        <span class="keyword">return</span> mCtc.toClass();</div><div class="line"><span class="number">71</span>:    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">72</span>:        <span class="keyword">throw</span> e;</div><div class="line"><span class="number">73</span>:    &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line"><span class="number">74</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">75</span>:    &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</div><div class="line"><span class="number">76</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">77</span>:    &#125;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure><ul><li>åŸºäº Javassist ç”Ÿæˆç±»ã€‚è¿™é‡Œä¸åšæ‹“å±•è§£é‡Šï¼Œé…åˆ<a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå­¦ä¹ ä¹‹javassistã€‹</a>ä¸€èµ·ç†è§£ã€‚</li><li>ç¬¬ 18 è¡Œï¼Œæ·»åŠ  <code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> åŠ¨æ€ç”Ÿæˆç±»æ ‡è®°ï¼Œæ ‡è®°è¯¥ç±»ç”± TccClassGenerator ç”Ÿæˆçš„ã€‚</li><li>ç¬¬ 34 è‡³ 50 è¡Œï¼Œè®¾ç½® @Compensable é»˜è®¤å±æ€§ã€‚</li></ul></li><li><p>ç¬¬ 141 è‡³ 142 è¡Œï¼Œè®¾ç½® Dubbo Service æ–¹æ³•é›†åˆè®¾ç½®åˆ°é™æ€å±æ€§ <code>methods</code> ä¸Šã€‚</p></li></ul></li><li><p><strong>ç¬¬ 144 è‡³ 157 è¡Œï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxy å·¥å‚çš„ä»£ç </strong>ã€‚</p><ul><li>ç¬¬ 146 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#newInstance(loader)</code> æ–¹æ³•ï¼Œ åˆ›å»ºç”Ÿæˆ Dubbo Service è°ƒç”¨ <strong>Proxy å·¥å‚</strong> çš„ä»£ç ç”Ÿæˆå™¨ã€‚</li><li>ç¬¬ 147 è‡³ 149 è¡Œï¼Œç”Ÿæˆç±»å( ä¾‹å¦‚ï¼Œ<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy3</code> )ï¼Œå¹¶è°ƒç”¨ <code>TccClassGenerator#setClassName(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç±»åã€‚</li><li>ç¬¬ 150 è‡³ 151 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addDefaultConstructor()</code> æ–¹æ³•ï¼Œæ·»åŠ é»˜è®¤ç©ºæ„é€ æ–¹æ³•ã€‚</li><li><p>ç¬¬ 152 è‡³ 153 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#mSuperClass()</code> æ–¹æ³•ï¼Œè®¾ç½®ç»§æ‰¿çˆ¶ç±» <strong><code>TccProxy</code></strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç”Ÿæˆç±»çš„çˆ¶ç±»åå­—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mSuperClass;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setSuperClass</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   mSuperClass = cl.getName();</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 154 è‡³ 155 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#addInterface(cl)</code> æ–¹æ³•ï¼Œæ·»åŠ ç”Ÿæˆ Proxy å®ç°ä»£ç çš„æ–¹æ³•ã€‚ä»£ç æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>ç¬¬ 156 è‡³ 157 è¡Œï¼Œè°ƒç”¨ <code>TccClassGenerator#toClass()</code> æ–¹æ³•ï¼Œ<strong>ç”Ÿæˆç±»</strong>ã€‚</p></li></ul></li><li><p>ç¬¬ 159 è¡Œï¼Œè°ƒç”¨ <code>TccProxy#newInstance()</code> æ–¹æ³•ï¼Œåˆ›å»º Proxy ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with default handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> newInstance(THROW_UNSUPPORTED_INVOKER);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with special handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler handler)</span></span>;</div></pre></td></tr></table></figure><ul><li><code>#newInstance(handler)</code>ï¼ŒæŠ½è±¡æ–¹æ³•ï¼Œä¸Šé¢ç¬¬ 154 è‡³ 155 è¡Œç”Ÿæˆã€‚TccJavassistProxyFactory è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾— Proxy ã€‚</li></ul></li><li><p>ç¬¬ 165 è‡³ 171 è¡Œï¼Œé‡Šæ”¾ TccClassGenerator ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line">       mCtc.detach();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123;</div><div class="line">       mFields.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyConstructors.clear();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ç¬¬ 172 è‡³ 180 è¡Œï¼Œè®¾ç½® Proxy å·¥å‚ç¼“å­˜ï¼Œå¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚</p></li></ul><p><strong>psï¼š</strong>ä»£ç æ¯”è¾ƒå¤šï¼Œæ”¶è·ä¼šæ¯”è¾ƒå¤šï¼Œç®—æ˜¯ Javassist å®æˆ˜æ¡ˆä¾‹äº†ã€‚TCC-Transaction ä½œè€…åœ¨å®ç°ä¸Šè¿°ç±»ï¼Œå¯èƒ½å‚è€ƒäº† Dubbo è‡ªå¸¦çš„å®ç°ï¼š</p><ul><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Proxy.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Proxy</code></a></li><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.ClassGenerator</code></a></li><li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Wrapper.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Wrapper</code></a></li></ul><h3 id="2-1-4-é…ç½®-Dubbo-Proxy"><a href="#2-1-4-é…ç½®-Dubbo-Proxy" class="headerlink" title="2.1.4 é…ç½® Dubbo Proxy"></a>2.1.4 é…ç½® Dubbo Proxy</h3><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJavassist=org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</div><div class="line"></div><div class="line">// tcc-transaction-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJavassist"</span>/&gt;</span></div></pre></td></tr></table></figure><p>ç›®å‰ Maven é¡¹ç›® <code>tcc-transaction-dubbo</code> å·²ç»<strong>é»˜è®¤</strong>é…ç½®ï¼Œå¼•å…¥å³å¯ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/05.png" alt=""></p><h2 id="2-2-JdkProxyFactory"><a href="#2-2-JdkProxyFactory" class="headerlink" title="2.2 JdkProxyFactory"></a>2.2 JdkProxyFactory</h2><h3 id="2-2-1-JDK-Proxy"><a href="#2-2-1-JDK-Proxy" class="headerlink" title="2.2.1 JDK Proxy"></a>2.2.1 JDK Proxy</h3><p><a href="http://blog.csdn.net/jiankunking/article/details/52143504#" rel="external nofollow noopener noreferrer" target="_blank">ã€Š Java JDK åŠ¨æ€ä»£ç†ï¼ˆAOPï¼‰ä½¿ç”¨åŠå®ç°åŸç†åˆ†æã€‹</a></p><h3 id="2-2-2-TccJdkProxyFactory"><a href="#2-2-2-TccJdkProxyFactory" class="headerlink" title="2.2.2 TccJdkProxyFactory"></a>2.2.2 TccJdkProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jd.TccJdkProxyFactory</code>ï¼ŒTCC JDK ä»£ç†å·¥å‚ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJdkProxyFactory</span> <span class="keyword">extends</span> <span class="title">JdkProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        T proxy = (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> TccInvokerInvocationHandler(proxy, invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>é¡¹ç›®å¯åŠ¨æ—¶</strong>ï¼Œè°ƒç”¨ <code>TccJavassistProxyFactory#getProxy(...)</code> æ–¹æ³•ï¼Œç”Ÿæˆ Dubbo Service è°ƒç”¨ Proxyã€‚</li><li><strong>ç¬¬ä¸€æ¬¡</strong>è°ƒç”¨ <code>Proxy#newProxyInstance(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºè°ƒç”¨ Dubbo Service æœåŠ¡çš„ Proxyã€‚<code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>ï¼ŒDubbo è°ƒç”¨å¤„ç†å™¨ï¼Œç‚¹å‡»<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">è¿æ¥</a>æŸ¥çœ‹ä»£ç ã€‚</li><li><strong>ç¬¬äºŒæ¬¡</strong>è°ƒç”¨ <code>Proxy#newProxyInstance(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå¯¹è°ƒç”¨ Dubbo Service çš„ Proxy çš„ Proxyã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤å±‚ Proxyï¼Ÿç­”æ¡ˆåœ¨ä¸‹èŠ‚ TccInvokerInvocationHandler ã€‚</li></ul><h3 id="2-2-3-TccInvokerInvocationHandler"><a href="#2-2-3-TccInvokerInvocationHandler" class="headerlink" title="2.2.3 TccInvokerInvocationHandler"></a>2.2.3 TccInvokerInvocationHandler</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jdk.TccInvokerInvocationHandler</code>ï¼ŒTCC è°ƒç”¨å¤„ç†å™¨ï¼Œåœ¨è°ƒç”¨ Dubbo Service æœåŠ¡æ—¶ï¼Œä½¿ç”¨ ResourceCoordinatorInterceptor æ‹¦æˆªå¤„ç†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccInvokerInvocationHandler</span> <span class="keyword">extends</span> <span class="title">InvokerInvocationHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * proxy</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> Object target;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="title">TccInvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">super</span>(handler);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="keyword">public</span> &lt;T&gt; TccInvokerInvocationHandler(T target, Invoker&lt;T&gt; invoker) &#123;</div><div class="line"><span class="number">13</span>:         <span class="keyword">super</span>(invoker);</div><div class="line"><span class="number">14</span>:         <span class="keyword">this</span>.target = target;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"><span class="number">18</span>:         Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:             <span class="comment">// è®¾ç½® @Compensable å±æ€§</span></div><div class="line"><span class="number">21</span>:             <span class="keyword">if</span> (StringUtils.isEmpty(compensable.confirmMethod())) &#123;</div><div class="line"><span class="number">22</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"confirmMethod"</span>, method.getName());</div><div class="line"><span class="number">23</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"cancelMethod"</span>, method.getName());</div><div class="line"><span class="number">24</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"transactionContextEditor"</span>, DubboTransactionContextEditor.class);</div><div class="line"><span class="number">25</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"propagation"</span>, Propagation.SUPPORTS);</div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:             <span class="comment">// ç”Ÿæˆåˆ‡é¢</span></div><div class="line"><span class="number">28</span>:             ProceedingJoinPoint pjp = <span class="keyword">new</span> MethodProceedingJoinPoint(proxy, target, method, args);</div><div class="line"><span class="number">29</span>:             <span class="comment">// æ‰§è¡Œ</span></div><div class="line"><span class="number">30</span>:             <span class="keyword">return</span> FactoryBuilder.factoryOf(ResourceCoordinatorAspect.class).getInstance().interceptTransactionContextMethod(pjp);</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">return</span> <span class="keyword">super</span>.invoke(target, method, args);</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 18 è‡³ 26 è¡Œï¼Œè®¾ç½®å¸¦æœ‰ @Compensable å±æ€§çš„é»˜è®¤å±æ€§ã€‚</li><li><p>ç¬¬ 28 è¡Œï¼Œç”Ÿæˆæ–¹æ³•åˆ‡é¢ <code>org.mengyun.tcctransaction.dubbo.proxy.jdk.MethodProceedingJoinPoint</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodProceedingJoinPoint</span> <span class="keyword">implements</span> <span class="title">ProceedingJoinPoint</span>, <span class="title">JoinPoint</span>.<span class="title">StaticPart</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»£ç†å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object proxy;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç›®æ ‡å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object target;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Method method;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// Use reflection to invoke the method.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ReflectionUtils.makeAccessible(method);</div><div class="line">            <span class="keyword">return</span> method.invoke(target, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">            <span class="comment">// Invoked method threw a checked exception.</span></div><div class="line">            <span class="comment">// We must rethrow it. The client won't see the interceptor.</span></div><div class="line">            <span class="keyword">throw</span> ex.getTargetException();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Tried calling method ["</span> +</div><div class="line">                    method + <span class="string">"] on target ["</span> + target + <span class="string">"] failed"</span>, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Could not access method ["</span> + method + <span class="string">"]"</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//        throw new UnsupportedOperationException(); // TODO èŠ‹è‰¿ï¼šç–‘é—®</span></div><div class="line">        <span class="keyword">return</span> proceed();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥ä¸é‡è¦çš„æ–¹æ³•å’Œå¯¹è±¡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è¯¥ç±»å‚è€ƒ <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-aop/src/main/java/org/springframework/aop/aspectj/MethodInvocationProceedingJoinPoint.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint</code></a> å®ç°ã€‚</li><li>TODOã€1ã€‘ proxy å’Œ target æ˜¯å¦ä¿ç•™ä¸€ä¸ªå³å¯ï¼Ÿ</li><li>åœ¨åˆ‡é¢å¤„ç†å®Œæˆåï¼Œè°ƒç”¨ <code>#proceed(...)</code> æ–¹æ³•ï¼Œè¿›è¡Œè¿œç¨‹ Dubbo Service æœåŠ¡è°ƒç”¨ã€‚</li><li>TODOã€2ã€‘<code>#proceed(objects)</code> æŠ›å‡º throw new UnsupportedOperationException();ã€‚éœ€è¦è·Ÿä½œè€…ç¡®è®¤ä¸‹ã€‚</li></ul></li><li>è°ƒç”¨ <code>ResourceCoordinatorAspect#interceptTransactionContextMethod(...)</code> æ–¹æ³•ï¼Œå¯¹æ–¹æ³•åˆ‡é¢æ‹¦æˆªå¤„ç†ã€‚<strong>ä¸ºä»€ä¹ˆæ— éœ€è°ƒç”¨ CompensableTransactionAspect åˆ‡é¢</strong>ï¼Ÿå› ä¸ºä¼ æ’­çº§åˆ«ä¸º Propagation.SUPPORTSï¼Œä¸ä¼šå‘èµ·äº‹åŠ¡ã€‚</li></ul><h3 id="2-2-4-é…ç½®-Dubbo-Proxy"><a href="#2-2-4-é…ç½®-Dubbo-Proxy" class="headerlink" title="2.2.4 é…ç½® Dubbo Proxy"></a>2.2.4 é…ç½® Dubbo Proxy</h3><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJdk=org.mengyun.tcctransaction.dubbo.proxy.jdk.TccJdkProxyFactory</div><div class="line"></div><div class="line">// appcontext-service-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span> <span class="attr">id</span>=<span class="string">"captialTradeOrderService"</span></span></div><div class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">"org.mengyun.tcctransaction.sample.dubbo.capital.api.CapitalTradeOrderService"</span> <span class="attr">timeout</span>=<span class="string">"5000"</span>/&gt;</span></div></pre></td></tr></table></figure><ul><li>ProxyFactory çš„ <code>tccJdk</code> åœ¨ Maven é¡¹ <code>tcc-transaction-dubbo</code> å·²ç»å£°æ˜ã€‚</li><li>å£°æ˜ <code>dubbo:provider</code> çš„ <code>proxy=&quot;tccJdk&quot;</code>ã€‚</li><li>å£°æ˜ <code>dubbo:reference</code> çš„ <code>proxy=&quot;tccJdk&quot;</code>ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚</li></ul><h1 id="3-Dubbo-äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨"><a href="#3-Dubbo-äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨" class="headerlink" title="3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨"></a>3. Dubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨</h1><p><code>org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor</code>ï¼ŒDubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        String context = RpcContext.getContext().getAttachment(TransactionContextConstants.TRANSACTION_CONTEXT);</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(context)) &#123;</div><div class="line">            <span class="keyword">return</span> JSON.parseObject(context, TransactionContext.class);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        RpcContext.getContext().setAttachment(TransactionContextConstants.TRANSACTION_CONTEXT, JSON.toJSONString(transactionContext));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€šè¿‡ Dubbo çš„éšå¼ä¼ å‚çš„æ–¹å¼ï¼Œé¿å…åœ¨ Dubbo Service æ¥å£ä¸Šå£°æ˜ TransactionContext å‚æ•°ï¼Œå¯¹æ¥å£äº§ç”Ÿä¸€å®šçš„å…¥ä¾µã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>HOHOï¼Œå¯¹åŠ¨æ€ä»£ç†åˆå­¦ä¹ äº†ä¸€éï¼Œè›® High çš„ã€‚</p><p>è¿™é‡Œæ¨èåŠ¨æ€ä»£ç†æ— å…³ï¼Œå’Œ Dubbo ç›¸å…³çš„æ–‡ç« ï¼š</p><ul><li><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubboçš„æœåŠ¡æš´éœ²ç»†èŠ‚ã€‹</a>ã€‚</li><li><a href="http://weifuwu.io/2016/01/03/dubbo-provider-start/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDubbo Providerå¯åŠ¨ä¸»æµç¨‹ã€‹</a></li></ul><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/06.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-%E6%A6%82%E8%BF%B0&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-dubbo-%
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/transaction-recovery/</id>
    <published>2018-02-21T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:38.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‹åŠ¡é‡è¯•é…ç½®</a></li><li><a href="#">3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡</a></li><li><a href="#">4. å¼‚å¸¸äº‹åŠ¡æ¢å¤</a><ul><li><a href="#">4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</a></li><li><a href="#">4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC æ¢å¤</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹äºŒä¸ª package è·¯å¾„ä¸‹çš„ç±»ï¼š</p><ul><li><code>org.mengyun.tcctransaction.recover</code><ul><li>RecoverConfigï¼Œäº‹åŠ¡æ¢å¤é…ç½®<strong>æ¥å£</strong>  </li><li>TransactionRecoveryï¼Œäº‹åŠ¡æ¢å¤é€»è¾‘</li></ul></li><li><code>org.mengyun.tcctransaction.spring.recover</code> ï¼š<ul><li>DefaultRecoverConfigï¼Œé»˜è®¤äº‹åŠ¡æ¢å¤é…ç½®<strong>å®ç°</strong></li><li>RecoverScheduledJobï¼Œäº‹åŠ¡æ¢å¤å®šæ—¶ä»»åŠ¡</li></ul></li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/01.png" alt=""></p><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>ä¸­ï¼Œäº‹åŠ¡ä¿¡æ¯è¢«æŒä¹…åŒ–åˆ°å¤–éƒ¨çš„å­˜å‚¨å™¨ä¸­ã€‚<strong>äº‹åŠ¡å­˜å‚¨æ˜¯äº‹åŠ¡æ¢å¤çš„åŸºç¡€</strong>ã€‚é€šè¿‡è¯»å–å¤–éƒ¨å­˜å‚¨å™¨ä¸­çš„å¼‚å¸¸äº‹åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ä¼šæŒ‰ç…§ä¸€å®šé¢‘ç‡å¯¹äº‹åŠ¡è¿›è¡Œé‡è¯•ï¼Œç›´åˆ°äº‹åŠ¡å®Œæˆæˆ–è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1 id="2-äº‹åŠ¡é‡è¯•é…ç½®"><a href="#2-äº‹åŠ¡é‡è¯•é…ç½®" class="headerlink" title="2. äº‹åŠ¡é‡è¯•é…ç½®"></a>2. äº‹åŠ¡é‡è¯•é…ç½®</h1><p><code>org.mengyun.tcctransaction.recover.RecoverConfig</code>ï¼Œäº‹åŠ¡æ¢å¤é…ç½®<strong>æ¥å£</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RecoverConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMaxRetryCount</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ¢å¤é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getRecoverDuration</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> cron è¡¨è¾¾å¼</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">getCronExpression</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Set&lt;Class&lt;? extends Exception&gt;&gt; getDelayCancelExceptions();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¾ç½®å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> delayRecoverExceptions å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDelayCancelExceptions</span><span class="params">(Set&lt;Class&lt;? extends Exception&gt;&gt; delayRecoverExceptions)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>#getMaxRetryCount()</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œç›®å‰ä»…æ‰“å‡ºé”™è¯¯æ—¥å¿—ï¼Œä¸‹æ–‡ä¼šçœ‹åˆ°å®ç°ã€‚</li><li><code>#getRecoverDuration()</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤é‡è¯•çš„é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’ã€‚</li><li><code>#getCronExpression()</code>ï¼Œå®šæ—¶ä»»åŠ¡ cron è¡¨è¾¾å¼ã€‚</li><li><code>#getDelayCancelExceptions()</code>ï¼Œå»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆã€‚</li></ul><hr><p><code>org.mengyun.tcctransaction.spring.recover.DefaultRecoverConfig</code>ï¼Œ<strong>é»˜è®¤</strong>äº‹åŠ¡æ¢å¤é…ç½®å®ç°ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRecoverConfig</span> <span class="keyword">implements</span> <span class="title">RecoverConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RecoverConfig INSTANCE = <span class="keyword">new</span> DefaultRecoverConfig();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxRetryCount = <span class="number">30</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ¢å¤é—´éš”æ—¶é—´ï¼Œå•ä½ï¼šç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> recoverDuration = <span class="number">120</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron è¡¨è¾¾å¼</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String cronExpression = <span class="string">"0 */1 * * * ?"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends Exception&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultRecoverConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        delayCancelExceptions.add(OptimisticLockException.class);</div><div class="line">        delayCancelExceptions.add(SocketTimeoutException.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDelayCancelExceptions</span><span class="params">(Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.delayCancelExceptions.addAll(delayCancelExceptions);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>maxRetryCount</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤æœ€å¤§é‡è¯•æ¬¡æ•° ä¸º 30ã€‚</li><li><code>recoverDuration</code>ï¼Œå•ä¸ªäº‹åŠ¡æ¢å¤é‡è¯•çš„é—´éš”æ—¶é—´ä¸º 120 ç§’ã€‚</li><li><code>cronExpression</code>ï¼Œå®šæ—¶ä»»åŠ¡ cron è¡¨è¾¾å¼ä¸º <code>&quot;0 */1 * * * ?&quot;</code>ï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœä½ å¸Œæœ›å®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„æ›´é¢‘ç¹ï¼Œå¯ä»¥ä¿®æ”¹ cron è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ <code>0/30 * * * * ?</code>ï¼Œæ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡ã€‚</li><li><code>delayCancelExceptions</code>ï¼Œå»¶è¿Ÿå–æ¶ˆå¼‚å¸¸é›†åˆã€‚åœ¨ DefaultRecoverConfig æ„é€ æ–¹æ³•é‡Œï¼Œé¢„å…ˆæ·»åŠ äº† OptimisticLockException / SocketTimeoutException ã€‚<ul><li>é’ˆå¯¹ <strong>SocketTimeoutException</strong> ï¼štry é˜¶æ®µï¼Œæœ¬åœ°å‚ä¸è€…è°ƒç”¨è¿œç¨‹å‚ä¸è€…( è¿œç¨‹æœåŠ¡ï¼Œä¾‹å¦‚ Dubboï¼ŒHttp æœåŠ¡)ï¼Œè¿œç¨‹å‚ä¸è€… try é˜¶æ®µçš„æ–¹æ³•é€»è¾‘æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¶…è¿‡ Socket ç­‰å¾…æ—¶é•¿ï¼Œå‘ç”Ÿ SocketTimeoutExceptionï¼Œå¦‚æœç«‹åˆ»æ‰§è¡Œäº‹åŠ¡å›æ»šï¼Œè¿œç¨‹å‚ä¸è€… try çš„æ–¹æ³•æœªæ‰§è¡Œå®Œæˆï¼Œå¯èƒ½å¯¼è‡´ cancel çš„æ–¹æ³•å®é™…æœªæ‰§è¡Œ( try çš„æ–¹æ³•æœªæ‰§è¡Œå®Œæˆï¼Œæ•°æ®åº“äº‹åŠ¡ã€é TCC äº‹åŠ¡ã€‘æœªæäº¤ï¼Œcancel çš„æ–¹æ³•è¯»å–æ•°æ®æ—¶å‘ç°æœªå˜æ›´ï¼Œå¯¼è‡´æ–¹æ³•å®é™…æœªæ‰§è¡Œï¼Œæœ€ç»ˆ try çš„æ–¹æ³•æ‰§è¡Œå®Œåï¼Œæäº¤æ•°æ®åº“äº‹åŠ¡ã€é TCC äº‹åŠ¡ã€‘ï¼Œè¾ƒä¸ºæç«¯ )ï¼Œæœ€ç»ˆå¼•èµ·æ•°æ®ä¸ä¸€è‡´ã€‚åœ¨<strong>äº‹åŠ¡æ¢å¤</strong>æ—¶ï¼Œä¼šå¯¹è¿™ç§æƒ…å†µçš„äº‹åŠ¡è¿›è¡Œå–æ¶ˆå›æ»šï¼Œå¦‚æœæ­¤æ—¶è¿œç¨‹å‚ä¸è€…çš„ try çš„æ–¹æ³•è¿˜æœªç»“æŸï¼Œè¿˜æ˜¯å¯èƒ½å‘ç”Ÿæ•°æ®ä¸ä¸€è‡´ã€‚<ul><li>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/87" rel="external nofollow noopener noreferrer" target="_blank">ä¸ºä»€ä¹ˆ tcc äº‹åŠ¡åˆ‡é¢ä¸­å¯¹ä¹è§‚é”ä¸socketè¶…æ—¶å¼‚å¸¸ä¸åšå›æ»šå¤„ç†ï¼ŒåªæŠ›å¼‚å¸¸ï¼Ÿ</a></li></ul></li><li>é’ˆå¯¹ OptimisticLockException ï¼šè¿˜æ˜¯ SocketTimeoutException çš„æƒ…å†µï¼Œäº‹åŠ¡æ¢å¤é—´éš”æ—¶é—´å°äº Socket è¶…æ—¶æ—¶é—´ï¼Œæ­¤æ—¶äº‹åŠ¡æ¢å¤è°ƒç”¨è¿œç¨‹å‚ä¸è€…å–æ¶ˆå›æ»šäº‹åŠ¡ï¼Œè¿œç¨‹å‚ä¸è€…ä¸‹æ¬¡æ›´æ–°äº‹åŠ¡æ—¶ï¼Œä¼šå› ä¸ºä¹è§‚é”æ›´æ–°å¤±è´¥ï¼ŒæŠ›å‡º OptimisticLockExceptionã€‚å¦‚æœ CompensableTransactionInterceptor æ­¤æ—¶ç«‹åˆ»å–æ¶ˆå›æ»šï¼Œå¯èƒ½ä¼šå’Œå®šæ—¶ä»»åŠ¡çš„å–æ¶ˆå›æ»šå†²çªï¼Œå› æ­¤ç»Ÿä¸€äº¤ç»™å®šæ—¶ä»»åŠ¡å¤„ç†ã€‚<ul><li>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/53" rel="external nofollow noopener noreferrer" target="_blank">äº‹åŠ¡æ¢å¤çš„ç–‘é—®</a></li><li>è¿™å—ç¬”è€…è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œå¦‚æœæœ‰åˆ«çš„å¯èƒ½æ€§å¯¼è‡´è¿™ä¸ªæƒ…å†µï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ç¬”è€…ã€‚è°¢è°¢ã€‚</li></ul></li></ul></li></ul><h1 id="3-äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡"><a href="#3-äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡" class="headerlink" title="3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡"></a>3. äº‹åŠ¡é‡è¯•å®šæ—¶ä»»åŠ¡</h1><p><code>org.mengyun.tcctransaction.spring.recover.RecoverScheduledJob</code>ï¼Œäº‹åŠ¡æ¢å¤å®šæ—¶ä»»åŠ¡ï¼ŒåŸºäº Quartz å®ç°è°ƒåº¦ï¼Œä¸æ–­ä¸æ–­ä¸æ–­æ‰§è¡Œäº‹åŠ¡æ¢å¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecoverScheduledJob</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionRecovery transactionRecovery;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionConfigurator transactionConfigurator;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Scheduler scheduler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Quartz JobDetail</span></div><div class="line">            MethodInvokingJobDetailFactoryBean jobDetail = <span class="keyword">new</span> MethodInvokingJobDetailFactoryBean();</div><div class="line">            jobDetail.setTargetObject(transactionRecovery);</div><div class="line">            jobDetail.setTargetMethod(<span class="string">"startRecover"</span>);</div><div class="line">            jobDetail.setName(<span class="string">"transactionRecoveryJob"</span>);</div><div class="line">            jobDetail.setConcurrent(<span class="keyword">false</span>); <span class="comment">// ç¦æ­¢å¹¶å‘</span></div><div class="line">            jobDetail.afterPropertiesSet();</div><div class="line">            <span class="comment">// Quartz CronTriggerFactoryBean</span></div><div class="line">            CronTriggerFactoryBean cronTrigger = <span class="keyword">new</span> CronTriggerFactoryBean();</div><div class="line">            cronTrigger.setBeanName(<span class="string">"transactionRecoveryCronTrigger"</span>);</div><div class="line">            cronTrigger.setCronExpression(transactionConfigurator.getRecoverConfig().getCronExpression());</div><div class="line">            cronTrigger.setJobDetail(jobDetail.getObject());</div><div class="line">            cronTrigger.afterPropertiesSet();</div><div class="line">            <span class="comment">// å¯åŠ¨ä»»åŠ¡è°ƒåº¦</span></div><div class="line">            scheduler.scheduleJob(jobDetail.getObject(), cronTrigger.getObject());</div><div class="line">            <span class="comment">// å¯åŠ¨ Quartz Scheduler</span></div><div class="line">            scheduler.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>MethodInvokingJobDetailFactoryBean#setConcurrent(false)</code> æ–¹æ³•ï¼Œç¦ç”¨ä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</li><li>è°ƒç”¨ <code>MethodInvokingJobDetailFactoryBean#setTargetObject(...)</code> + <code>MethodInvokingJobDetailFactoryBean#setTargetMethod(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ä»»åŠ¡è°ƒç”¨ <code>TransactionRecovery#startRecover(...)</code> æ–¹æ³•æ‰§è¡Œã€‚</li></ul><p><strong>å¦‚æœåº”ç”¨é›†ç¾¤éƒ¨ç½²ï¼Œä¼šä¸ä¼šç›¸åŒäº‹åŠ¡è¢«å¤šä¸ªå®šæ—¶ä»»åŠ¡åŒæ—¶é‡è¯•</strong>ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œäº‹åŠ¡åœ¨é‡è¯•æ—¶ä¼šä¹è§‚é”æ›´æ–°ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªåº”ç”¨èŠ‚ç‚¹èƒ½æ›´æ–°æˆåŠŸã€‚</p><p>å®˜æ–¹è§£é‡Šï¼š<a href="https://github.com/changmingxie/tcc-transaction/issues/98" rel="external nofollow noopener noreferrer" target="_blank">å¤šæœºéƒ¨ç½²ä¸‹ï¼Œæ‰€æœ‰æœºå™¨éƒ½å®•æœºï¼Œä»å¼‚å¸¸ä¸­æ¢å¤æ—¶ï¼Œæ‰€æœ‰çš„æœºå™¨å²‚ä¸æ˜¯éƒ½å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰çš„éœ€è¦æ¢å¤çš„æœåŠ¡ï¼Ÿ</a></p><p>å½“ç„¶æç«¯æƒ…å†µä¸‹ï¼ŒSocket è°ƒç”¨è¶…æ—¶æ—¶é—´å¤§äºäº‹åŠ¡é‡è¯•é—´éš”ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹åœ¨é‡è¯•æŸä¸ªäº‹åŠ¡ï¼Œä¸€ç›´æœªæ‰§è¡Œå®Œæˆï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹å·²ç»å¯ä»¥é‡è¯•ã€‚</p><p>psï¼šå»ºè®®ï¼ŒSocket è°ƒç”¨è¶…æ—¶æ—¶é—´å°äºäº‹åŠ¡é‡è¯•é—´éš”ã€‚</p><p><strong>æ˜¯å¦å®šæ—¶ä»»åŠ¡å’Œåº”ç”¨æœåŠ¡å™¨è§£è€¦</strong>ï¼Ÿ</p><p>èš‚èšé‡‘æœçš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ DTS é‡‡ç”¨ client-server æ¨¡å¼ï¼š</p><ul><li>xts-client ï¼šè´Ÿè´£äº‹åŠ¡çš„åˆ›å»ºã€æäº¤ã€å›æ»šã€è®°å½•ã€‚</li><li>xts-server ï¼šè´Ÿè´£å¼‚å¸¸äº‹åŠ¡çš„æ¢å¤ã€‚</li></ul><blockquote><p>FROM <a href="https://www.cloud.alipay.com/docs/2/46887" rel="external nofollow noopener noreferrer" target="_blank">ã€Šèš‚èšé‡‘èäº‘ DTS æ–‡æ¡£ã€‹</a><br>åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ (Distributed Transaction Service, DTS) æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œç”¨æ¥ä¿éšœåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚DTS ä»æ¶æ„ä¸Šåˆ†ä¸º xts-client å’Œ xts-server ä¸¤éƒ¨åˆ†ï¼Œå‰è€…æ˜¯ä¸€ä¸ªåµŒå…¥å®¢æˆ·ç«¯åº”ç”¨çš„ JAR åŒ…ï¼Œä¸»è¦è´Ÿè´£äº‹åŠ¡æ•°æ®çš„å†™å…¥å’Œå¤„ç†ï¼›åè€…æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿï¼Œä¸»è¦è´Ÿè´£å¼‚å¸¸äº‹åŠ¡çš„æ¢å¤ã€‚</p></blockquote><h1 id="4-å¼‚å¸¸äº‹åŠ¡æ¢å¤"><a href="#4-å¼‚å¸¸äº‹åŠ¡æ¢å¤" class="headerlink" title="4. å¼‚å¸¸äº‹åŠ¡æ¢å¤"></a>4. å¼‚å¸¸äº‹åŠ¡æ¢å¤</h1><p> <code>org.mengyun.tcctransaction.recover.TransactionRecovery</code>ï¼Œå¼‚å¸¸äº‹åŠ¡æ¢å¤ï¼Œå®ç°ä¸»ä½“ä»£ç å¦‚ä¸‹ï¼š</p> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionRecovery</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¯åŠ¨æ¢å¤äº‹åŠ¡é€»è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRecover</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</span></div><div class="line">        List&lt;Transaction&gt; transactions = loadErrorTransactions();</div><div class="line">        <span class="comment">// æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</span></div><div class="line">        recoverErrorTransactions(transactions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-1-åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ"><a href="#4-1-åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ" class="headerlink" title="4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ"></a>4.1 åŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆ</h2><p>è°ƒç”¨ <code>#loadErrorTransactions()</code> æ–¹æ³•ï¼ŒåŠ è½½å¼‚å¸¸äº‹åŠ¡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Transaction&gt; <span class="title">loadErrorTransactions</span><span class="params">()</span> </span>&#123;</div><div class="line">   TransactionRepository transactionRepository = transactionConfigurator.getTransactionRepository();</div><div class="line">   <span class="keyword">long</span> currentTimeInMillis = Calendar.getInstance().getTimeInMillis();</div><div class="line">   RecoverConfig recoverConfig = transactionConfigurator.getRecoverConfig();</div><div class="line">   <span class="keyword">return</span> transactionRepository.findAllUnmodifiedSince(<span class="keyword">new</span> Date(currentTimeInMillis - recoverConfig.getRecoverDuration() * <span class="number">1000</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>å¼‚å¸¸äº‹åŠ¡çš„å®šä¹‰</strong>ï¼šå½“å‰æ—¶é—´è¶…è¿‡ - äº‹åŠ¡å˜æ›´æ—¶é—´( æœ€åæ‰§è¡Œæ—¶é—´ ) &gt;= äº‹åŠ¡æ¢å¤é—´éš”( <code>RecoverConfig#getRecoverDuration()</code> )ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå·²å®Œæˆçš„äº‹åŠ¡ä¼šä»äº‹åŠ¡å­˜å‚¨å™¨åˆ é™¤ã€‚</li></ul><h2 id="4-2-æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ"><a href="#4-2-æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ" class="headerlink" title="4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ"></a>4.2 æ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆ</h2><p>è°ƒç”¨ <code>#recoverErrorTransactions(...)</code> æ–¹æ³•ï¼Œæ¢å¤å¼‚å¸¸äº‹åŠ¡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recoverErrorTransactions</span><span class="params">(List&lt;Transaction&gt; transactions)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       <span class="comment">// è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°</span></div><div class="line">       <span class="keyword">if</span> (transaction.getRetriedCount() &gt; transactionConfigurator.getRecoverConfig().getMaxRetryCount()) &#123;</div><div class="line">           logger.error(String.format(<span class="string">"recover failed with max retry count,will not try again. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ†æ”¯äº‹åŠ¡è¶…è¿‡æœ€å¤§å¯é‡è¯•æ—¶é—´</span></div><div class="line">       <span class="keyword">if</span> (transaction.getTransactionType().equals(TransactionType.BRANCH)</div><div class="line">               &amp;&amp; (transaction.getCreateTime().getTime() +</div><div class="line">               transactionConfigurator.getRecoverConfig().getMaxRetryCount() *</div><div class="line">                       transactionConfigurator.getRecoverConfig().getRecoverDuration() * <span class="number">1000</span></div><div class="line">               &gt; System.currentTimeMillis())) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// Confirm / Cancel</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// å¢åŠ é‡è¯•æ¬¡æ•°</span></div><div class="line">           transaction.addRetriedCount();</div><div class="line">           <span class="comment">// Confirm</span></div><div class="line">           <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CONFIRMING)) &#123;</div><div class="line">               transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div class="line">               transactionConfigurator.getTransactionRepository().update(transaction);</div><div class="line">               transaction.commit();</div><div class="line">               transactionConfigurator.getTransactionRepository().delete(transaction);</div><div class="line">           <span class="comment">// Cancel</span></div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (transaction.getStatus().equals(TransactionStatus.CANCELLING)</div><div class="line">                   || transaction.getTransactionType().equals(TransactionType.ROOT)) &#123; <span class="comment">// å¤„ç†å»¶è¿Ÿå–æ¶ˆçš„æƒ…å†µ</span></div><div class="line">               transaction.changeStatus(TransactionStatus.CANCELLING);</div><div class="line">               transactionConfigurator.getTransactionRepository().update(transaction);</div><div class="line">               transaction.rollback();</div><div class="line">               transactionConfigurator.getTransactionRepository().delete(transaction);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">           <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> OptimisticLockException</div><div class="line">                   || ExceptionUtils.getRootCause(throwable) <span class="keyword">instanceof</span> OptimisticLockException) &#123;</div><div class="line">               logger.warn(String.format(<span class="string">"optimisticLockException happened while recover. txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               logger.error(String.format(<span class="string">"recover failed, txid:%s, status:%s,retried count:%d,transaction content:%s"</span>, transaction.getXid(), transaction.getStatus().getId(), transaction.getRetriedCount(), JSON.toJSONString(transaction)), throwable);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“å•ä¸ªäº‹åŠ¡è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°æ—¶ï¼Œä¸å†é‡è¯•ï¼Œåªæ‰“å°å¼‚å¸¸ï¼Œæ­¤æ—¶éœ€è¦<strong>äººå·¥ä»‹å…¥</strong>è§£å†³ã€‚å¯ä»¥æ¥å…¥ ELK æ”¶é›†æ—¥å¿—ç›‘æ§æŠ¥è­¦ã€‚</li><li>å½“<strong>åˆ†æ”¯äº‹åŠ¡</strong>è¶…è¿‡æœ€å¤§å¯é‡è¯•æ—¶é—´æ—¶ï¼Œä¸å†é‡è¯•ã€‚å¯èƒ½æœ‰åŒå­¦å’Œæˆ‘ä¸€å¼€å§‹ç†è§£çš„æ˜¯ç›¸åŒçš„ï¼Œå®é™…<strong>åˆ†æ”¯äº‹åŠ¡</strong>å¯¹åº”çš„åº”ç”¨æœåŠ¡å™¨ä¹Ÿå¯ä»¥é‡è¯•<strong>åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œä¸æ˜¯å¿…é¡»<strong>æ ¹äº‹åŠ¡</strong>å‘èµ·é‡è¯•ï¼Œä»è€Œä¸€èµ·é‡è¯•<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚è¿™ç‚¹è¦æ³¨æ„ä¸‹ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING çŠ¶æ€æ—¶ï¼Œæäº¤äº‹åŠ¡ï¼Œé€»è¾‘å’Œ <code>TransactionManager#commit()</code> ç±»ä¼¼ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING çŠ¶æ€ï¼Œæˆ–è€…<strong>äº‹åŠ¡ç±»å‹ä¸ºæ ¹äº‹åŠ¡</strong>ï¼Œå›æ»šäº‹åŠ¡ï¼Œé€»è¾‘å’Œ <code>TransactionManager#rollback()</code> ç±»ä¼¼ã€‚è¿™é‡ŒåŠ åˆ¤æ–­çš„<strong>äº‹åŠ¡ç±»å‹ä¸ºæ ¹äº‹åŠ¡</strong>ï¼Œç”¨äºå¤„ç†å»¶è¿Ÿå›æ»šå¼‚å¸¸çš„äº‹åŠ¡çš„å›æ»šã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>åœ¨å†™æœ¬æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œæ— æ„ä¸­ç¿»åˆ°èš‚èšäº‘çš„æ–‡æ¡£ï¼Œåˆ†äº«ç»™çœ‹åˆ°æ­¤å¤„çš„çœŸçˆ±ä»¬ã€‚</p><p>çœŸçˆ±ä»¬ï¼Œè¯·çŒ›å‡»<a href="https://git.cloud.alipay.com/dx/AntCloudPayPublic" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠAntCloudPayPublicã€‹</a>è·³è½¬ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_22/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‹åŠ¡é‡è¯•é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/transaction-repository/</id>
    <published>2018-02-14T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:30.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. åºåˆ—åŒ–</a><ul><li><a href="#">2.1 JDK åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.2 Kyro åºåˆ—åŒ–å®ç°</a></li><li><a href="#">2.3 JSON åºåˆ—åŒ–å®ç°</a></li></ul></li><li><a href="#">3. å­˜å‚¨å™¨</a><ul><li><a href="#">3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</a></li><li><a href="#">3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</a></li><li><a href="#">3.5 File äº‹åŠ¡å­˜å‚¨å™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>äº‹åŠ¡å­˜å‚¨å™¨</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li></ul><p>åœ¨ TCC çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®åº”ç”¨å†…å­˜ä¸­çš„äº‹åŠ¡ä¿¡æ¯å®Œæˆæ•´ä¸ªäº‹åŠ¡æµç¨‹ã€‚But å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå°†äº‹åŠ¡ä¿¡æ¯åªæ”¾åœ¨åº”ç”¨å†…å­˜ä¸­æ˜¯è¿œè¿œä¸å¤Ÿå¯é çš„ã€‚ä¾‹å¦‚ï¼š</p><ol><li>åº”ç”¨è¿›ç¨‹å¼‚å¸¸å´©æºƒï¼Œæœªå®Œæˆçš„äº‹åŠ¡ä¿¡æ¯å°†ä¸¢å¤±ã€‚</li><li>åº”ç”¨è¿›ç¨‹é›†ç¾¤ï¼Œå½“æä¾›è¿œç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡ä¿¡æ¯éœ€è¦é›†ç¾¤å†…å…±äº«ã€‚</li><li>å‘èµ·äº‹åŠ¡çš„åº”ç”¨éœ€è¦é‡å¯éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼Œå› ä¸ºå„ç§åŸå› ï¼Œæœ‰æœªå®Œæˆçš„äº‹åŠ¡ã€‚</li></ol><p>å› æ­¤ï¼ŒTCC-Transaction å°†äº‹åŠ¡ä¿¡æ¯æ·»åŠ åˆ°å†…å­˜ä¸­çš„åŒæ—¶ï¼Œä¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨è¿›è¡ŒæŒä¹…åŒ–ã€‚ç›®å‰æä¾›å››ç§å¤–éƒ¨å­˜å‚¨ï¼š</p><ul><li>JdbcTransactionRepositoryï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨</li><li>RedisTransactionRepositoryï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨</li><li>ZooKeeperTransactionRepositoryï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨</li><li>FileSystemTransactionRepositoryï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨</li></ul><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„ç±»å…³ç³»å¦‚ä¸‹å›¾( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><h1 id="2-åºåˆ—åŒ–"><a href="#2-åºåˆ—åŒ–" class="headerlink" title="2. åºåˆ—åŒ–"></a>2. åºåˆ—åŒ–</h1><p>åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/tcc-core/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°ã€‹ã€Œ4. äº‹åŠ¡ä¸å‚ä¸è€…ã€</a>ï¼Œå¯ä»¥çœ‹åˆ° Transaction æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒ Participant æ•°ç»„ï¼Œè€Œ Participant æœ¬èº«ä¹Ÿæ˜¯å¤æ‚çš„å¯¹è±¡ï¼Œå†…åµŒäº†æ›´å¤šçš„å…¶ä»–å¯¹è±¡ï¼Œå› æ­¤ï¼Œå­˜å‚¨å™¨åœ¨æŒä¹…åŒ– Transaction æ—¶ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰èƒ½å­˜å‚¨ã€‚</p><p><code>org.mengyun.tcctransaction.serializer.ObjectSerializer</code>ï¼Œå¯¹è±¡åºåˆ—åŒ–<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">byte</span>[] serialize(T t);</div><div class="line">    </div><div class="line">    <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ç›®å‰æä¾› <strong>JDKè‡ªå¸¦åºåˆ—åŒ–</strong> å’Œ <strong>Kyroåºåˆ—åŒ–</strong> ä¸¤ç§å®ç°ã€‚</p><h2 id="2-1-JDK-åºåˆ—åŒ–å®ç°"><a href="#2-1-JDK-åºåˆ—åŒ–å®ç°" class="headerlink" title="2.1 JDK åºåˆ—åŒ–å®ç°"></a>2.1 JDK åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.JdkSerializationSerializer</code>ï¼ŒJDK åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/JdkSerializationSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><p><strong>TCC-Transaction ä½¿ç”¨çš„é»˜è®¤çš„åºåˆ—åŒ–</strong>ã€‚</p><h2 id="2-2-Kyro-åºåˆ—åŒ–å®ç°"><a href="#2-2-Kyro-åºåˆ—åŒ–å®ç°" class="headerlink" title="2.2 Kyro åºåˆ—åŒ–å®ç°"></a>2.2 Kyro åºåˆ—åŒ–å®ç°</h2><p><code>org.mengyun.tcctransaction.serializer.KryoTransactionSerializer</code>ï¼ŒKyro åºåˆ—åŒ–å®ç°ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»<a href="https://github.com/changmingxie/tcc-transaction/blob/70130d12004456fd4b97510c210c24502a1b3acb/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/serializer/KryoTransactionSerializer.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>ç›´æ¥æŸ¥çœ‹ã€‚</p><h2 id="2-3-JSON-åºåˆ—åŒ–å®ç°"><a href="#2-3-JSON-åºåˆ—åŒ–å®ç°" class="headerlink" title="2.3 JSON åºåˆ—åŒ–å®ç°"></a>2.3 JSON åºåˆ—åŒ–å®ç°</h2><p>JDK å’Œ Kyro çš„åºåˆ—åŒ–å®ç°ï¼Œè‚‰çœ¼æ— æ³•ç›´è§‚å…·ä½“å­˜å‚¨äº‹åŠ¡çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥é€šè¿‡å®ç° ObjectSerializer æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰çš„ JSON åºåˆ—åŒ–ã€‚</p><h1 id="3-å­˜å‚¨å™¨"><a href="#3-å­˜å‚¨å™¨" class="headerlink" title="3. å­˜å‚¨å™¨"></a>3. å­˜å‚¨å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionRepository</code>ï¼Œäº‹åŠ¡å­˜å‚¨å™¨<strong>æ¥å£</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–äº‹åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Transaction <span class="title">findByXid</span><span class="params">(TransactionXid xid)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸åŒçš„å­˜å‚¨å™¨é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæä¾›äº‹åŠ¡çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</p><h2 id="3-1-å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»"><a href="#3-1-å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»" class="headerlink" title="3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»"></a>3.1 å¯ç¼“å­˜çš„äº‹åŠ¡å­˜å‚¨å™¨æŠ½è±¡ç±»</h2><p><code>org.mengyun.tcctransaction.repository.CachableTransactionRepository</code>ï¼Œ<strong>å¯ç¼“å­˜</strong>çš„äº‹åŠ¡å­˜å‚¨å™¨<strong>æŠ½è±¡ç±»</strong>ï¼Œå®ç°å¢åˆ æ”¹æŸ¥äº‹åŠ¡æ—¶ï¼ŒåŒæ—¶ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ã€‚åœ¨ä¸Šé¢ç±»å›¾ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ° TCC-Transaction è‡ªå¸¦çš„å¤šç§å­˜å‚¨å™¨éƒ½ç»§æ‰¿è¯¥æŠ½è±¡ç±»ã€‚</p><p><strong>CachableTransactionRepository æ„é€ æ–¹æ³•</strong>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CachableTransactionRepository</span> <span class="keyword">implements</span> <span class="title">TransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜è¿‡æœŸæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireDuration = <span class="number">120</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¼“å­˜</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Cache&lt;Xid, Transaction&gt; transactionXidCompensableTransactionCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachableTransactionRepository</span><span class="params">()</span> </span>&#123;</div><div class="line">        transactionXidCompensableTransactionCache = CacheBuilder.newBuilder().expireAfterAccess(expireDuration, TimeUnit.SECONDS).maximumSize(<span class="number">1000</span>).build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <a href="https://github.com/google/guava/wiki/CachesExplained" rel="external nofollow noopener noreferrer" target="_blank">Guava Cache</a> å†…å­˜ç¼“å­˜äº‹åŠ¡ä¿¡æ¯ï¼Œè®¾ç½®æœ€å¤§ç¼“å­˜ä¸ªæ•°ä¸º 1000 ä¸ªï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ä¸ºæœ€åè®¿é—®æ—¶é—´ 120 ç§’ã€‚</li></ul><hr><p><strong><code>#create(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = doCreate(transaction);</div><div class="line">   <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">putToCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.put(transaction.getXid(), transaction);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–°å¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–°å¢æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doCreate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#doCreate(...)</code> æ–¹æ³•ï¼Œæ–°å¢äº‹åŠ¡ã€‚æ–°å¢æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li><code>#doCreate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ–°å¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#update(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doUpdate(transaction);</div><div class="line">       <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> OptimisticLockException();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123; <span class="comment">// æ›´æ–°å¤±è´¥ï¼Œç§»é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡è®¿é—®ï¼Œä»å­˜å‚¨å™¨è¯»å–</span></div><div class="line">           removeFromCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç§»é™¤äº‹åŠ¡ä»ç¼“å­˜</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">removeFromCache</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   transactionXidCompensableTransactionCache.invalidate(transaction.getXid());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ›´æ–°æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#doUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‹åŠ¡ã€‚<ul><li>è‹¥æ›´æ–°æˆåŠŸåï¼Œè°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ã€‚</li><li>è‹¥æ›´æ–°å¤±è´¥åï¼ŒæŠ›å‡º OptimisticLockException å¼‚å¸¸ã€‚æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´æ›´æ–°å¤±è´¥ï¼š(1) è¯¥äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¢«åˆ é™¤ï¼›(2) ä¹è§‚é”æ›´æ–°æ—¶ï¼Œç¼“å­˜çš„äº‹åŠ¡çš„ç‰ˆæœ¬å·( <code>Transaction.version</code> )å’Œå­˜å‚¨å™¨é‡Œçš„äº‹åŠ¡çš„ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°å¤±è´¥ã€‚<strong>ä¸ºä»€ä¹ˆ</strong>ï¼Ÿåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚æ›´æ–°å¤±è´¥ï¼Œæ„å‘³ç€ç¼“å­˜å·²ç»ä¸ä¸ä¸€è‡´ï¼Œè°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li></ul></li><li><code>#doUpdate(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æ›´æ–°äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#delete(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       result = doDelete(transaction);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       removeFromCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ é™¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ é™¤æ•°é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doDelete</span><span class="params">(Transaction transaction)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#doDelete(...)</code> æ–¹æ³•ï¼Œåˆ é™¤äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#removeFromCache(...)</code> æ–¹æ³•ï¼Œç§»é™¤äº‹åŠ¡ä»ç¼“å­˜ä¸­ã€‚</li><li><code>#doDelete(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›åˆ é™¤äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findByXid(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">findByXid</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   Transaction transaction = findFromCache(transactionXid);</div><div class="line">   <span class="keyword">if</span> (transaction == <span class="keyword">null</span>) &#123;</div><div class="line">       transaction = doFindOne(transactionXid);</div><div class="line">       <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">           putToCache(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—äº‹åŠ¡ä»ç¼“å­˜ä¸­</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionXid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Transaction <span class="title">findFromCache</span><span class="params">(TransactionXid transactionXid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> transactionXidCompensableTransactionCache.getIfPresent(transactionXid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æŸ¥è¯¢äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Transaction <span class="title">doFindOne</span><span class="params">(Xid xid)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#findFromCache()</code> æ–¹æ³•ï¼Œä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>#doFindOne()</code> æ–¹æ³•ï¼Œç¼“å­˜ä¸­äº‹åŠ¡ä¸å­˜åœ¨ï¼Œä»å­˜å‚¨å™¨ä¸­è·å–ã€‚è·å–åˆ°åï¼Œè°ƒç”¨ <code>#putToCache()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡åˆ°ç¼“å­˜ä¸­ã€‚</li><li><code>#doFindOne(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›æŸ¥è¯¢äº‹åŠ¡åŠŸèƒ½ã€‚</li></ul><hr><p><strong><code>#findAllUnmodifiedSince(...)</code></strong> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Transaction&gt; <span class="title">findAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   List&lt;Transaction&gt; transactions = doFindAllUnmodifiedSince(date);</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜</span></div><div class="line">   <span class="keyword">for</span> (Transaction transaction : transactions) &#123;</div><div class="line">       putToCache(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> transactions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> date æŒ‡å®šæ—¶é—´</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span></span>;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#findAllUnmodifiedSince(...)</code> æ–¹æ³•ï¼Œä»å­˜å‚¨å™¨è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆã€‚è°ƒç”¨ <code>#putToCache(...)</code> æ–¹æ³•ï¼Œå¾ªç¯äº‹åŠ¡é›†åˆæ·»åŠ åˆ°ç¼“å­˜ã€‚</li><li><code>#doFindAllUnmodifiedSince(...)</code> ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæä¾›è·å–è¶…è¿‡æŒ‡å®šæ—¶é—´çš„äº‹åŠ¡é›†åˆåŠŸèƒ½ã€‚</li></ul><h2 id="3-2-JDBC-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-2-JDBC-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨"></a>3.2 JDBC äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.JdbcTransactionRepository</code>ï¼ŒJDBC äº‹åŠ¡å­˜å‚¨å™¨ï¼Œé€šè¿‡ JDBC é©±åŠ¨ï¼Œå°† Transaction å­˜å‚¨åˆ° MySQL / Oracle / PostgreSQL / SQLServer ç­‰å…³ç³»æ•°æ®åº“ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é¢†åŸŸ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String domain;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¡¨åç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String tbSuffix;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ•°æ®æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>domain</code>ï¼Œé¢†åŸŸï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç§°ä¸ºæ¨¡å—åï¼Œåº”ç”¨åï¼Œ<strong>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªèµ„æº</strong>ã€‚ä¾‹å¦‚ï¼ŒMaven æ¨¡å— <code>xxx-order</code>ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®è¯¥å±æ€§ä¸º <code>ORDER</code>ã€‚</li><li><code>tbSuffix</code>ï¼Œè¡¨åç¼€ã€‚é»˜è®¤å­˜å‚¨è¡¨åä¸º <code>TCC_TRANSACTION</code>ï¼Œé…ç½®è¡¨ååï¼Œä¸º <code>TCC_TRANSACTION${tbSuffix}</code>ã€‚</li><li><code>dataSource</code>ï¼Œå­˜å‚¨æ•°æ®çš„æ•°æ®æºã€‚</li><li><code>serializer</code>ï¼Œåºåˆ—åŒ–ã€‚<strong>å½“æ•°æ®åº“é‡Œå·²ç»æœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¸è¦æ›´æ¢åˆ«çš„åºåˆ—åŒ–ï¼Œå¦åˆ™ä¼šå¯¼è‡´ååºåˆ—åŒ–æŠ¥é”™ã€‚</strong>å»ºè®®ï¼šTCC-Transaction å­˜å‚¨æ—¶ï¼Œæ–°å¢å­—æ®µï¼Œè®°å½•åºåˆ—åŒ–çš„æ–¹å¼ã€‚</li></ul><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">CREATE TABLE `TCC_TRANSACTION` (</div><div class="line">  `TRANSACTION_ID` <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</div><div class="line">  `DOMAIN` varchar(<span class="number">100</span>) DEFAULT NULL,</div><div class="line">  `GLOBAL_TX_ID` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `BRANCH_QUALIFIER` varbinary(<span class="number">32</span>) NOT NULL,</div><div class="line">  `CONTENT` varbinary(<span class="number">8000</span>) DEFAULT NULL,</div><div class="line">  `STATUS` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `TRANSACTION_TYPE` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `RETRIED_COUNT` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  `CREATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `LAST_UPDATE_TIME` datetime DEFAULT NULL,</div><div class="line">  `VERSION` <span class="keyword">int</span>(<span class="number">11</span>) DEFAULT NULL,</div><div class="line">  <span class="function">PRIMARY <span class="title">KEY</span> <span class="params">(`TRANSACTION_ID`)</span>,</span></div><div class="line"><span class="function">  UNIQUE KEY `UX_TX_BQ` <span class="params">(`GLOBAL_TX_ID`,`BRANCH_QUALIFIER`)</span></span></div><div class="line"><span class="function">) ENGINE</span>=InnoDB DEFAULT CHARSET=utf8</div></pre></td></tr></table></figure><ul><li><code>TRANSACTION_ID</code>ï¼Œä»…ä»…æ•°æ®åº“è‡ªå¢ï¼Œæ— å®é™…ç”¨é€”ã€‚</li><li><code>CONTENT</code>ï¼ŒTransaction åºåˆ—åŒ–ã€‚</li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/JdbcTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ JdbcTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><h2 id="3-3-Redis-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-3-Redis-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨"></a>3.3 Redis äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.RedisTransactionRepository</code>ï¼ŒRedis äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Redisã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Jedis Pool</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> JedisPool jedisPool;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * key å‰ç¼€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String keyPrefix = <span class="string">"TCC:"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>keyPrefix</code>ï¼Œkey å‰ç¼€ã€‚ç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Reidsï¼Œä½¿ç”¨ Redis çš„æ•°æ®ç»“æ„ä¸º <a href="https://redis.io/commands#hash" rel="external nofollow noopener noreferrer" target="_blank">HASHES</a>ã€‚</p><ul><li><p>key : ä½¿ç”¨ <code>keyPrefix</code> + <code>xid</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºäº‹åŠ¡çš„ Redis Key</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> keyPrefix key å‰ç¼€</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> xid äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> Redis Key</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getRedisKey(String keyPrefix, Xid xid) &#123;</div><div class="line">   <span class="keyword">byte</span>[] prefix = keyPrefix.getBytes();</div><div class="line">   <span class="keyword">byte</span>[] globalTransactionId = xid.getGlobalTransactionId();</div><div class="line">   <span class="keyword">byte</span>[] branchQualifier = xid.getBranchQualifier();</div><div class="line">   <span class="comment">// æ‹¼æ¥ key</span></div><div class="line">   <span class="keyword">byte</span>[] key = <span class="keyword">new</span> <span class="keyword">byte</span>[prefix.length + globalTransactionId.length + branchQualifier.length];</div><div class="line">   System.arraycopy(prefix, <span class="number">0</span>, key, <span class="number">0</span>, prefix.length);</div><div class="line">   System.arraycopy(globalTransactionId, <span class="number">0</span>, key, prefix.length, globalTransactionId.length);</div><div class="line">   System.arraycopy(branchQualifier, <span class="number">0</span>, key, prefix.length + globalTransactionId.length, branchQualifier.length);</div><div class="line">   <span class="keyword">return</span> key;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>HASHES çš„ key ï¼šä½¿ç”¨ <code>version</code>ã€‚</p><ul><li>æ·»åŠ å’Œæ›´æ–° Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hsetnx" rel="external nofollow noopener noreferrer" target="_blank">HSETNX</a>ï¼Œä¸å­˜åœ¨å½“å‰ç‰ˆæœ¬çš„å€¼æ—¶ï¼Œè¿›è¡Œè®¾ç½®ï¼Œé‡è€Œå®ç°ç±»ä¼¼ä¹è§‚é”çš„æ›´æ–°ã€‚</li><li>è¯»å– Transaction æ—¶ï¼Œä½¿ç”¨ Redis <a href="https://redis.io/commands/hgetall" rel="external nofollow noopener noreferrer" target="_blank">HGETALL</a>ï¼Œå°† Transaction æ‰€æœ‰ <code>version</code> å¯¹åº”çš„å€¼è¯»å–åˆ°å†…å­˜åï¼Œå– <code>version</code> å€¼æœ€å¤§çš„å¯¹åº”çš„å€¼ã€‚</li></ul></li><li><p>HASHES çš„ value ï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(ObjectSerializer serializer, Transaction transaction) &#123;</div><div class="line">   Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">   map.put(<span class="string">"GLOBAL_TX_ID"</span>, transaction.getXid().getGlobalTransactionId());</div><div class="line">   map.put(<span class="string">"BRANCH_QUALIFIER"</span>, transaction.getXid().getBranchQualifier());</div><div class="line">   map.put(<span class="string">"STATUS"</span>, transaction.getStatus().getId());</div><div class="line">   map.put(<span class="string">"TRANSACTION_TYPE"</span>, transaction.getTransactionType().getId());</div><div class="line">   map.put(<span class="string">"RETRIED_COUNT"</span>, transaction.getRetriedCount());</div><div class="line">   map.put(<span class="string">"CREATE_TIME"</span>, transaction.getCreateTime());</div><div class="line">   map.put(<span class="string">"LAST_UPDATE_TIME"</span>, transaction.getLastUpdateTime());</div><div class="line">   map.put(<span class="string">"VERSION"</span>, transaction.getVersion());</div><div class="line">   <span class="comment">// åºåˆ—åŒ–</span></div><div class="line">   map.put(<span class="string">"CONTENT"</span>, serializer.serialize(transaction));</div><div class="line">   <span class="keyword">return</span> serializer.serialize(map);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>TODO ä¸ºä»€ä¹ˆåºåˆ—åŒ–ä¸¤æ¬¡</li></ul></li></ul><p>åœ¨å®ç° <code>#doFindAllUnmodifiedSince(date)</code> æ–¹æ³•ï¼Œæ— æ³•åƒæ•°æ®åº“ä½¿ç”¨æ—¶é—´æ¡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œå› æ­¤ï¼ŒåŠ è½½æ‰€æœ‰äº‹åŠ¡ååœ¨å†…å­˜ä¸­è¿‡æ»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Transaction&gt; <span class="title">doFindAllUnmodifiedSince</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å¾—æ‰€æœ‰äº‹åŠ¡</span></div><div class="line">   List&lt;Transaction&gt; allTransactions = doFindAll();</div><div class="line">   <span class="comment">// è¿‡æ»¤æ—¶é—´</span></div><div class="line">   List&lt;Transaction&gt; allUnmodifiedSince = <span class="keyword">new</span> ArrayList&lt;Transaction&gt;();</div><div class="line">   <span class="keyword">for</span> (Transaction transaction : allTransactions) &#123;</div><div class="line">       <span class="keyword">if</span> (transaction.getLastUpdateTime().compareTo(date) &lt; <span class="number">0</span>) &#123;</div><div class="line">           allUnmodifiedSince.add(transaction);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> allUnmodifiedSince;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/RedisTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ RedisTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><blockquote><p>FROM <a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x#%E9%85%8D%E7%BD%AEtcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCC-Transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a><br>ä½¿ç”¨ RedisTransactionRepository éœ€è¦é…ç½® Redis æœåŠ¡å™¨å¦‚ä¸‹ï¼š<br>appendonly yes<br>appendfsync always</p></blockquote><h2 id="3-4-Zookeeper-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-4-Zookeeper-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨"></a>3.4 Zookeeper äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.ZooKeeperTransactionRepository</code>ï¼ŒZookeeper äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ° Zookeeperã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperTransactionRepository</span> <span class="keyword">extends</span> <span class="title">CachableTransactionRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper æœåŠ¡å™¨åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkServers;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¶…æ—¶æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> zkTimeout;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * TCC å­˜å‚¨ Zookeeper æ ¹ç›®å½•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String zkRootPath = <span class="string">"/tcc"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Zookeeper è¿æ¥</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ZooKeeper zk;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åºåˆ—åŒ–</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ObjectSerializer serializer = <span class="keyword">new</span> JdkSerializationSerializer();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>zkRootPath</code>ï¼Œå­˜å‚¨ Zookeeper æ ¹ç›®å½•ï¼Œç±»ä¼¼ JdbcTransactionRepository çš„ <code>domain</code> å±æ€§ã€‚</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å­˜å‚¨åˆ° Zookeeperï¼Œä½¿ç”¨ Zookeeper çš„<strong>æŒä¹…æ•°æ®èŠ‚ç‚¹</strong>ã€‚</p><ul><li><p>pathï¼š<code>${zkRootPath}</code> + <code>/</code> + <code>${xid}</code>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZooKeeperTransactionRepository.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getTxidPath</span><span class="params">(Xid xid)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> String.format(<span class="string">"%s/%s"</span>, zkRootPath, xid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TransactionXid.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">   StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">   stringBuilder.append(<span class="string">"globalTransactionId:"</span>).append(UUID.nameUUIDFromBytes(globalTransactionId).toString());</div><div class="line">   stringBuilder.append(<span class="string">","</span>).append(<span class="string">"branchQualifier:"</span>).append(UUID.nameUUIDFromBytes(branchQualifier).toString());</div><div class="line">   <span class="keyword">return</span> stringBuilder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>dataï¼šè°ƒç”¨ <code>TransactionSerializer#serialize(...)</code> æ–¹æ³•ï¼Œåºåˆ—åŒ– Transactionã€‚</p></li><li>versionï¼šä½¿ç”¨ Zookeeper æ•°æ®èŠ‚ç‚¹è‡ªå¸¦ç‰ˆæœ¬åŠŸèƒ½ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼ŒTransaction çš„ç‰ˆæœ¬ä» 1 å¼€å§‹ï¼Œè€Œ Zookeeper æ•°æ®èŠ‚ç‚¹ç‰ˆæœ¬ä» 0 å¼€å§‹ã€‚</li></ul><p>psï¼šç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/ZooKeeperTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ ZooKeeperTransactionRepository ä»£ç å®ç°ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡æ³¨é‡Šã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šæš‚æ—¶ä¸å»ºè®®ä½¿ç”¨ ZooKeeperTransactionRepositoryï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒ Zookeeper å®‰å…¨è®¤è¯ã€‚</li><li>ä½¿ç”¨ Zookeeper æ—¶ï¼Œæœªè€ƒè™‘æ–­ç½‘é‡è¿ç­‰æƒ…å†µã€‚</li></ul><p>å¦‚æœä½ è¦ä½¿ç”¨ Zookeeper è¿›è¡Œäº‹åŠ¡çš„å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> æ“ä½œ Zookeeperï¼Œé‡å†™ ZooKeeperTransactionRepository éƒ¨åˆ†ä»£ç ã€‚</p><h2 id="3-5-File-äº‹åŠ¡å­˜å‚¨å™¨"><a href="#3-5-File-äº‹åŠ¡å­˜å‚¨å™¨" class="headerlink" title="3.5 File äº‹åŠ¡å­˜å‚¨å™¨"></a>3.5 File äº‹åŠ¡å­˜å‚¨å™¨</h2><p><code>org.mengyun.tcctransaction.repository.FileSystemTransactionRepository</code>ï¼ŒFile äº‹åŠ¡å­˜å‚¨å™¨ï¼Œå°† Transaction å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å®ç°ä¸Šå’Œ ZooKeeperTransactionRepositoryï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºä¸æ”¯æŒä¹è§‚é”æ›´æ–°ã€‚æœ‰å…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/c164ff5ab29d31e08bc7061de5bc7403f3e40f1d/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/repository/FileSystemTransactionRepository.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸æ‹“å±•å¼€æ¥ã€‚</p><p>å¦å¤–ï¼Œåœ¨ç”Ÿäº§ä¸Šä¸å»ºè®®ä½¿ç”¨ FileSystemTransactionRepositoryï¼Œå› ä¸ºä¸æ”¯æŒå¤šèŠ‚ç‚¹å…±äº«ã€‚ç”¨åˆ†å¸ƒå¼å­˜å‚¨æŒ‚è½½æ–‡ä»¶å¦è¯´ï¼Œå½“ç„¶è¿˜æ˜¯ä¸å»ºè®®ï¼Œå› ä¸ºä¸æ”¯æŒä¹è§‚é”å¹¶å‘æ›´æ–°ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>è¿™ç¯‡ç•¥( è¶… )å¾®( çº§ )æ°´æ›´ï¼Œå“ˆå“ˆå“ˆï¼Œä¸º<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recover/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>åšé“ºå«å•¦ã€‚</p><p>ä½¿ç”¨ RedisTransactionRepository å’Œ ZooKeeperTransactionRepository å­˜å‚¨äº‹åŠ¡è¿˜æ˜¯ Get è›®å¤šç‚¹çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_15/02.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. åºåˆ—åŒ–&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” TCC å®ç°</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/tcc-core/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/tcc-core/</id>
    <published>2018-02-07T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. TCC åŸç†</a></li><li><a href="#">3. TCC-Transaction åŸç†</a></li><li><a href="#">4. äº‹åŠ¡ä¸å‚ä¸è€…</a><ul><li><a href="#">4.1 äº‹åŠ¡</a></li><li><a href="#">4.2 å‚ä¸è€…</a></li></ul></li><li><a href="#">5. äº‹åŠ¡ç®¡ç†å™¨</a><ul><li><a href="#">5.1 å‘èµ·æ ¹äº‹åŠ¡</a></li><li><a href="#">5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</a></li><li><a href="#">5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</a></li><li><a href="#">5.4 æäº¤äº‹åŠ¡</a></li><li><a href="#">5.5 å›æ»šäº‹åŠ¡</a></li><li><a href="#">5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</a></li></ul></li><li><a href="#">6. äº‹åŠ¡æ‹¦æˆªå™¨</a><ul><li><a href="#">6.1 Compensable</a></li><li><a href="#">6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</a></li><li><a href="#">6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« <strong>TCC å®ç°</strong>ã€‚ä¸»è¦æ¶‰åŠå¦‚ä¸‹ä¸‰ä¸ª Maven é¡¹ç›®ï¼š</p><ul><li><code>tcc-transaction-core</code> ï¼štcc-transaction åº•å±‚å®ç°ã€‚</li><li><code>tcc-transaction-api</code> ï¼štcc-transaction ä½¿ç”¨ APIã€‚</li><li><code>tcc-transaction-spring</code> ï¼štcc-transaction Spring æ”¯æŒã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º TCC-Transaction ç‚¹èµï¼<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ç¬¬ä¸€æ®µ TCC æ—…ç¨‹å§ã€‚</p><p>psï¼šç¬”è€…å‡è®¾ä½ å·²ç»é˜…è¯»è¿‡<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction å®˜æ–¹æ–‡æ¡£ â€”â€” ä½¿ç”¨æŒ‡å—1.2.xã€‹</a>ã€‚</p><p>ps2ï¼š<strong>æœªç‰¹æ®Šè¯´æ˜çš„æƒ…å†µä¸‹ï¼Œæœ¬æ–‡äº‹åŠ¡æŒ‡çš„æ˜¯ TCCäº‹åŠ¡</strong>ã€‚</p><h1 id="2-TCC-åŸç†"><a href="#2-TCC-åŸç†" class="headerlink" title="2. TCC åŸç†"></a>2. TCC åŸç†</h1><blockquote><p>FROM <a href="https://support.hwclouds.com/devg-servicestage/zh-cn_topic_0056814426.html" rel="external nofollow noopener noreferrer" target="_blank">https://support.hwclouds.com/devg-servicestage/zh-cn_topic_0056814426.html</a><br><strong>TCCäº‹åŠ¡</strong><br>ä¸ºäº†è§£å†³åœ¨äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­å¤§é¢—ç²’åº¦èµ„æºé”å®šçš„é—®é¢˜ï¼Œä¸šç•Œæå‡ºä¸€ç§æ–°çš„äº‹åŠ¡æ¨¡å‹ï¼Œå®ƒæ˜¯åŸºäº<strong>ä¸šåŠ¡å±‚é¢</strong>çš„äº‹åŠ¡å®šä¹‰ã€‚é”ç²’åº¦å®Œå…¨ç”±ä¸šåŠ¡è‡ªå·±æ§åˆ¶ã€‚å®ƒæœ¬è´¨æ˜¯ä¸€ç§è¡¥å¿çš„æ€è·¯ã€‚å®ƒæŠŠäº‹åŠ¡è¿è¡Œè¿‡ç¨‹åˆ†æˆ Tryã€Confirm / Cancel ä¸¤ä¸ªé˜¶æ®µã€‚åœ¨æ¯ä¸ªé˜¶æ®µçš„é€»è¾‘ç”±<strong>ä¸šåŠ¡ä»£ç æ§åˆ¶</strong>ã€‚è¿™æ ·å°±äº‹åŠ¡çš„é”ç²’åº¦å¯ä»¥å®Œå…¨è‡ªç”±æ§åˆ¶ã€‚ä¸šåŠ¡å¯ä»¥åœ¨ç‰ºç‰²éš”ç¦»æ€§çš„æƒ…å†µä¸‹ï¼Œè·å–æ›´é«˜çš„æ€§èƒ½ã€‚</p></blockquote><ul><li>Try é˜¶æ®µ<ul><li>Try ï¼šå°è¯•æ‰§è¡Œä¸šåŠ¡ <ul><li>å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥( ä¸€è‡´æ€§ ) </li><li>é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æº( å‡†éš”ç¦»æ€§ )</li></ul></li></ul></li><li>Confirm / Cancel é˜¶æ®µï¼š<ul><li>Confirm ï¼šç¡®è®¤æ‰§è¡Œä¸šåŠ¡<ul><li>çœŸæ­£æ‰§è¡Œä¸šåŠ¡</li><li>ä¸åšä»»åŠ¡ä¸šåŠ¡æ£€æŸ¥</li><li>Confirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§</li></ul></li><li>Cancel ï¼šå–æ¶ˆæ‰§è¡Œä¸šåŠ¡<ul><li>é‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº</li><li>Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ </li></ul></li><li>Confirm ä¸ Cancel äº’æ–¥</li></ul></li></ul><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/01.jpeg" alt=""></p><ul><li><p><strong>çº¢æ¡†éƒ¨åˆ†</strong>åŠŸèƒ½ç”± <code>tcc-transaction-core</code> å®ç°ï¼š</p><ul><li>å¯åŠ¨ä¸šåŠ¡æ´»åŠ¨</li><li>ç™»è®°ä¸šåŠ¡æ“ä½œ</li><li>æäº¤ / å›æ»šä¸šåŠ¡æ´»åŠ¨</li></ul></li><li><p><strong>é»„æ¡†éƒ¨åˆ†</strong>åŠŸèƒ½ç”± <code>tcc-transaction-http-sample</code> å®ç°( å®˜æ–¹æä¾›çš„ç¤ºä¾‹é¡¹ç›® )ï¼š</p><ul><li>Try æ“ä½œ</li><li>Confirm æ“ä½œ</li><li>Cancel æ“ä½œ </li></ul></li></ul><p><strong>ä¸ 2PCåè®® æ¯”è¾ƒ</strong>ï¼š</p><ul><li>ä½äºä¸šåŠ¡æœåŠ¡å±‚è€Œéè‡ªæ„¿å±‚</li><li>æ²¡æœ‰å•ç‹¬çš„å‡†å¤‡( Prepare )é˜¶æ®µï¼ŒTry æ“ä½œå…¼å¤‡è‡ªæ„¿æ“ä½œä¸å‡†å¤‡èƒ½åŠ›</li><li>Try æ“ä½œå¯ä»¥çµæ´»é€‰æ‹©ä¸šåŠ¡èµ„æºçš„é”å®šç²’åº¦</li><li>è¾ƒé«˜å¼€å‘æˆæœ¬</li></ul><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://www.zhihu.com/question/31813039" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ”¯ä»˜å®è¿è¥æ¶æ„ä¸­æŸ”æ€§äº‹åŠ¡æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿã€‹</a></li><li><a href="http://kaimingwan.com/post/fen-bu-shi/fen-bu-shi-shi-wu-de-dian-xing-chu-li-fang-shi-2pc-tcc-yi-bu-que-bao-he-zui-da-nu-li-xing" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåˆ†å¸ƒå¼äº‹åŠ¡çš„å…¸å‹å¤„ç†æ–¹å¼:2PCã€TCCã€å¼‚æ­¥ç¡®ä¿å’Œæœ€å¤§åŠªåŠ›å‹ã€‹</a></li></ul><h1 id="3-TCC-Transaction-åŸç†"><a href="#3-TCC-Transaction-åŸç†" class="headerlink" title="3. TCC-Transaction åŸç†"></a>3. TCC-Transaction åŸç†</h1><p>åœ¨ TCC é‡Œï¼Œä¸€ä¸ªä¸šåŠ¡æ´»åŠ¨å¯ä»¥æœ‰å¤šä¸ªäº‹åŠ¡ï¼Œæ¯ä¸ªä¸šåŠ¡æ“ä½œå½’å±äºä¸åŒçš„äº‹åŠ¡ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ªä¸šåŠ¡æ“ä½œã€‚TCC-Transaction å°†æ¯ä¸ªä¸šåŠ¡æ“ä½œæŠ½è±¡æˆ<strong>äº‹åŠ¡å‚ä¸è€…</strong>ï¼Œæ¯ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«å¤šä¸ª<strong>å‚ä¸è€…</strong>ã€‚</p><p>å‚ä¸è€…éœ€è¦å£°æ˜ try / confirm / cancel ä¸‰ä¸ªç±»å‹çš„æ–¹æ³•ï¼Œå’Œ TCC çš„æ“ä½œä¸€ä¸€å¯¹åº”ã€‚åœ¨ç¨‹åºé‡Œï¼Œé€šè¿‡ @Compensable æ³¨è§£æ ‡è®°åœ¨ try æ–¹æ³•ä¸Šï¼Œå¹¶å¡«å†™å¯¹åº”çš„ confirm / cancel æ–¹æ³•ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// try</span></div><div class="line"><span class="meta">@Compensable</span>(confirmMethod = <span class="string">"confirmRecord"</span>, cancelMethod = <span class="string">"cancelRecord"</span>, transactionContextEditor = MethodTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// confirm</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// cancel</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRecord</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> </span>&#123;&#125;</div></pre></td></tr></table></figure><ul><li>åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° TransactionContextï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿè¿™é‡Œå…ˆå–ä¸€ä¸ªå…³å­ã€‚</li></ul><p>TCC-Transaction æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œé€šè¿‡å¯¹ @Compensable AOP åˆ‡é¢( å‚ä¸è€… try æ–¹æ³• )è¿›è¡Œæ‹¦æˆªï¼Œé€æ˜åŒ–å¯¹å‚ä¸è€… confirm / cancel æ–¹æ³•è°ƒç”¨ï¼Œä»è€Œå®ç° TCC ã€‚<strong>ç®€åŒ–</strong>æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/03.png" alt=""></p><p>ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨ Try é˜¶æ®µï¼Œå¯¹äº‹åŠ¡çš„å‘èµ·ã€ä¼ æ’­ã€‚</li><li>åœ¨ Confirm / Cancel é˜¶æ®µï¼Œå¯¹äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚</li><li><strong>ä¸ºä»€ä¹ˆä¼šæœ‰å¯¹äº‹åŠ¡çš„ä¼ æ’­å‘¢</strong>ï¼Ÿåœ¨è¿œç¨‹è°ƒç”¨æœåŠ¡çš„å‚ä¸è€…æ—¶ï¼Œä¼šé€šè¿‡<strong>â€œå‚æ•°â€</strong>( éœ€è¦åºåˆ—åŒ– )çš„å½¢å¼ä¼ é€’äº‹åŠ¡ç»™è¿œç¨‹å‚ä¸è€…ã€‚</li></ul><p>ç¬¬äºŒä¸ªæ‹¦æˆªå™¨ï¼Œèµ„æºåè°ƒè€…æ‹¦æˆªå™¨ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨ Try é˜¶æ®µï¼Œæ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ä¸­ã€‚å½“äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸å­˜åœ¨æ—¶ï¼Œè¿›è¡Œåˆ›å»ºã€‚</li></ul><p>å®é™…æ‹¦æˆªå™¨å¯¹äº‹åŠ¡çš„å¤„ç†ä¼šæ¯”ä¸Šå›¾å¤æ‚ä¸€äº›ï¼Œåœ¨æœ¬æ–‡<a href="#">ã€Œ6. äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>åœ¨ TCC-Transaction ä»£ç å®ç°ä¸Šï¼Œç»„ä»¶åˆ†å±‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/04.png" alt=""></p><p>æœ¬æ–‡æŒ‰ç…§å¦‚ä¸‹é¡ºåºåˆ†äº«ï¼š</p><ul><li><a href="#">ã€Œ4. äº‹åŠ¡æ‹¦æˆªå™¨ã€</a></li><li><a href="#">ã€Œ5. äº‹åŠ¡ç®¡ç†å™¨ã€</a></li><li><a href="#">ã€Œ6. äº‹åŠ¡ç®¡ç†å™¨ã€</a></li></ul><p>å†…å®¹æ˜¯<strong>è‡ªä¸‹è€Œä¸Š</strong>çš„æ–¹å¼åˆ†äº«ï¼Œæ¯ä¸ªç»„ä»¶å¯ä»¥æ›´åŠ æ•´ä½“çš„è¢«è®¤è¯†ã€‚å½“ç„¶è¿™å¯èƒ½å¯¹ä½ ç†è§£æ—¶äº§ç”Ÿä¸€è„¸é—·é€¼ï¼Œæ‰€ä»¥æ¨èä¸¤ç§é˜…è¯»æ–¹å¼ï¼š</p><ul><li>ç®€è¯» x 1 + æ·±è¯» x 1</li><li>å€’ç€è¯»ï¼Œå‘ç°æœªåˆ†äº«çš„æ–¹æ³•ï¼Œå…¨æ–‡æ£€ç´¢è¯¥æ–¹æ³•ã€‚</li></ul><p>äº‹åŠ¡å­˜å‚¨å™¨åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡å­˜å‚¨äºæ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p><p>äº‹åŠ¡æ¢å¤åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p><h1 id="4-äº‹åŠ¡ä¸å‚ä¸è€…"><a href="#4-äº‹åŠ¡ä¸å‚ä¸è€…" class="headerlink" title="4. äº‹åŠ¡ä¸å‚ä¸è€…"></a>4. äº‹åŠ¡ä¸å‚ä¸è€…</h1><p>åœ¨ TCC é‡Œï¼Œ<strong>ä¸€ä¸ª</strong>äº‹åŠ¡( <code>org.mengyun.tcctransaction.Transaction</code> ) å¯ä»¥æœ‰<strong>å¤šä¸ª</strong>å‚ä¸è€…( <code>org.mengyun.tcctransaction.Participant</code> )å‚ä¸ä¸šåŠ¡æ´»åŠ¨ã€‚ç±»å›¾å…³ç³»å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/02.png" alt=""></p><h2 id="4-1-äº‹åŠ¡"><a href="#4-1-äº‹åŠ¡" class="headerlink" title="4.1 äº‹åŠ¡"></a>4.1 äº‹åŠ¡</h2><p><strong>Transaction å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7291423944314337931L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionStatus status;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionType transactionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é‡è¯•æ¬¡æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> retriedCount = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date createTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åæ›´æ–°æ—¶é—´</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Date lastUpdateTime = <span class="keyword">new</span> Date();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç‰ˆæœ¬å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> version = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚ä¸è€…é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> List&lt;Participant&gt; participants = <span class="keyword">new</span> ArrayList&lt;Participant&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é™„å¸¦å±æ€§æ˜ å°„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attachments = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ·»åŠ å‚ä¸è€…</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> participant å‚ä¸è€…</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</div><div class="line">        participants.add(participant);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æäº¤ TCC äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</div><div class="line">            participant.commit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å›æ»š TCC äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Participant participant : participants) &#123;</div><div class="line">            participant.rollback();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>xidï¼Œäº‹åŠ¡ç¼–å·( TransactionXid )ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªäº‹åŠ¡ã€‚ä½¿ç”¨ UUID ç®—æ³•ç”Ÿæˆï¼Œ<strong>ä¿è¯å”¯ä¸€æ€§</strong>ã€‚<code>org.mengyun.tcctransaction.api.TransactionXid</code> å®ç° <a href="https://docs.oracle.com/javase/8/docs/api/javax/transaction/xa/Xid.html" rel="external nofollow noopener noreferrer" target="_blank"><code>javax.transaction.xa.Xid</code></a> æ¥å£ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionXid</span> <span class="keyword">implements</span> <span class="title">Xid</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6817267250789142043L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * xid æ ¼å¼æ ‡è¯†ç¬¦</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> formatId = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] globalTransactionId;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] branchQualifier;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>TODO ä¸ºä»€ä¹ˆè¦ç»§æ‰¿ Xid æ¥å£ï¼Ÿ</li></ul></li><li><p>statusï¼Œäº‹åŠ¡çŠ¶æ€( TransactionStatus )ã€‚<code>org.mengyun.tcctransaction.api.TransactionStatus</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TransactionStatus &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å°è¯•ä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TRYING(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤ä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    CONFIRMING(<span class="number">2</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆä¸­çŠ¶æ€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    CANCELLING(<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>transactionTypeï¼Œäº‹åŠ¡ç±»å‹( TransactionType )ã€‚<code>org.mengyun.tcctransaction.common.TransactionType</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TransactionType &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ ¹äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ROOT(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    BRANCH(<span class="number">2</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> id;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æï¼Œå¯ä»¥çœ‹åˆ°çœ‹åˆ°è¿™ä¸¤ç§äº‹åŠ¡æ˜¯å¦‚ä½•å‘èµ·ã€‚</li></ul></li><li><p>retriedCountï¼Œé‡è¯•æ¬¡æ•°ã€‚åœ¨ TCC è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‚ä¸è€…å¼‚å¸¸å´©æºƒï¼Œè¿™ä¸ªæ—¶å€™ä¼šè¿›è¡Œé‡è¯•ç›´åˆ°æˆåŠŸæˆ–è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</p></li><li>versionï¼Œç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚é”æ›´æ–°äº‹åŠ¡ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-repository/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” äº‹åŠ¡å­˜å‚¨å™¨ã€‹</a>è¯¦ç»†è§£æã€‚</li><li>attachmentsï¼Œé™„å¸¦å±æ€§æ˜ å°„ã€‚åœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” Dubbo æ”¯æŒã€‹</a>è¯¦ç»†è§£æã€‚</li><li>æä¾› <code>#enlistParticipant()</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…ã€‚</li><li>æä¾› <code>#commit()</code> æ–¹æ³•ï¼Œè°ƒç”¨å‚ä¸è€…ä»¬æäº¤äº‹åŠ¡ã€‚</li><li>æä¾› <code>#rollback()</code> æ–¹æ³•ï¼Œè°ƒç”¨å‚ä¸è€…å›æ»šäº‹åŠ¡ã€‚</li></ul><h2 id="4-2-å‚ä¸è€…"><a href="#4-2-å‚ä¸è€…" class="headerlink" title="4.2 å‚ä¸è€…"></a>4.2 å‚ä¸è€…</h2><p><strong>Participant å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4127729421281425247L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext confirmInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext cancelInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Terminator terminator = <span class="keyword">new</span> Terminator();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æäº¤äº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">        terminator.invoke(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.CONFIRMING.getId()), confirmInvocationContext, transactionContextEditorClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å›æ»šäº‹åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">        terminator.invoke(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.CANCELLING.getId()), cancelInvocationContext, transactionContextEditorClass);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>xidï¼Œå‚ä¸è€…äº‹åŠ¡ç¼–å·ã€‚é€šè¿‡ <code>TransactionXid.globalTransactionId</code> å±æ€§ï¼Œå…³è”ä¸Šå…¶æ‰€å±çš„äº‹åŠ¡ã€‚å½“å‚ä¸è€…è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ï¼Œè¿œç¨‹çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡çš„äº‹åŠ¡ç¼–å·ç­‰äºè¯¥å‚ä¸è€…çš„äº‹åŠ¡ç¼–å·ã€‚é€šè¿‡äº‹åŠ¡ç¼–å·çš„å…³è”ï¼ŒTCC Confirm / Cancel é˜¶æ®µï¼Œä½¿ç”¨å‚ä¸è€…çš„äº‹åŠ¡ç¼–å·å’Œè¿œç¨‹çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡è¿›è¡Œå…³è”ï¼Œä»è€Œå®ç°äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œåœ¨<a href="#">ã€Œ5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡ã€ + ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>å¯ä»¥çœ‹åˆ°å…·ä½“å®ç°ã€‚</li><li><p>confirmInvocationContextï¼Œç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡( InvocationContext )ã€‚<code>org.mengyun.tcctransaction.InvocationContext</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvocationContext</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7969140711432461165L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç±»</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Class targetClass;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–¹æ³•å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String methodName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°ç±»å‹æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Class[] parameterTypes;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å‚æ•°æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>InvocationContextï¼Œæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ï¼Œè®°å½•ç±»ã€æ–¹æ³•åã€å‚æ•°ç±»å‹æ•°ç»„ã€å‚æ•°æ•°ç»„ã€‚é€šè¿‡è¿™äº›å±æ€§ï¼Œå¯ä»¥æ‰§è¡Œæäº¤ / å›æ»šäº‹åŠ¡ã€‚åœ¨ <code>org.mengyun.tcctransaction.Terminator</code> ä¼šçœ‹åˆ°å…·ä½“çš„ä»£ç å®ç°ã€‚<strong>æœ¬è´¨ä¸Šï¼ŒTCC é€šè¿‡å¤šä¸ªå‚ä¸è€…çš„ try / confirm / cancel æ–¹æ³•ï¼Œå®ç°äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</li></ul></li><li><p>cancelInvocationContextï¼Œå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡( InvocationContext )ã€‚</p></li><li><p>terminatorï¼Œæ‰§è¡Œå™¨( Terminator )ã€‚<code>org.mengyun.tcctransaction.Terminator</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Terminator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">164958655471605778L</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(TransactionContext transactionContext, InvocationContext invocationContext, Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(invocationContext.getMethodName())) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// è·å¾— å‚ä¸è€…å¯¹è±¡</span></div><div class="line">                Object target = FactoryBuilder.factoryOf(invocationContext.getTargetClass()).getInstance();</div><div class="line">                <span class="comment">// è·å¾— æ–¹æ³•</span></div><div class="line">                Method method = target.getClass().getMethod(invocationContext.getMethodName(), invocationContext.getParameterTypes());</div><div class="line">                <span class="comment">// è®¾ç½® äº‹åŠ¡ä¸Šä¸‹æ–‡ åˆ°æ–¹æ³•å‚æ•°</span></div><div class="line">                FactoryBuilder.factoryOf(transactionContextEditorClass).getInstance().set(transactionContext, target, method, invocationContext.getArgs());</div><div class="line">                <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></div><div class="line">                <span class="keyword">return</span> method.invoke(target, invocationContext.getArgs());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>FactoryBuilderï¼Œå·¥å‚ Builderï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ç‚¹å‡»<a href="https://github.com/YunaiV/tcc-transaction/blob/8553baad29597603d9007d61aec3ea5201632d1b/tcc-transaction-core/src/main/java/org/mengyun/tcctransaction/support/FactoryBuilder.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹ï¼Œå·²ç»æ·»åŠ å®Œæ•´ä¸­æ–‡ä»£ç æ³¨é‡Šã€‚</li><li>TransactionContextEditorï¼Œåœ¨æœ¬æ–‡<a href="#">ã€Œ6.1 Compensableã€</a>è¯¦ç»†è§£æã€‚</li></ul></li><li>transactionContextEditorClassï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘ï¼Œåœ¨<a href="#">ã€Œ6.1 Compensableã€</a>è¯¦ç»†è§£æã€‚</li><li>æäº¤ <code>#commit()</code> æ–¹æ³•ï¼Œæäº¤å‚ä¸è€…è‡ªå·±çš„äº‹åŠ¡ã€‚</li><li>æäº¤ <code>#rollback()</code> æ–¹æ³•ï¼Œå›æ»šå‚ä¸è€…è‡ªå·±çš„äº‹åŠ¡ã€‚ </li></ul><h1 id="5-äº‹åŠ¡ç®¡ç†å™¨"><a href="#5-äº‹åŠ¡ç®¡ç†å™¨" class="headerlink" title="5. äº‹åŠ¡ç®¡ç†å™¨"></a>5. äº‹åŠ¡ç®¡ç†å™¨</h1><p><code>org.mengyun.tcctransaction.TransactionManager</code>ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼Œæä¾›äº‹åŠ¡çš„è·å–ã€å‘èµ·ã€æäº¤ã€å›æ»šï¼Œå‚ä¸è€…çš„æ–°å¢ç­‰ç­‰æ–¹æ³•ã€‚</p><h2 id="5-1-å‘èµ·æ ¹äº‹åŠ¡"><a href="#5-1-å‘èµ·æ ¹äº‹åŠ¡" class="headerlink" title="5.1 å‘èµ·æ ¹äº‹åŠ¡"></a>5.1 å‘èµ·æ ¹äº‹åŠ¡</h2><p>æä¾› <code>begin()</code> æ–¹æ³•ï¼Œå‘èµ·æ ¹äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT å¹¶ä¸” äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‘èµ·æ ¹äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">begin</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º æ ¹äº‹åŠ¡</span></div><div class="line">   Transaction transaction = <span class="keyword">new</span> Transaction(TransactionType.ROOT);</div><div class="line">   <span class="comment">// å­˜å‚¨ äº‹åŠ¡</span></div><div class="line">   transactionRepository.create(transaction);</div><div class="line">   <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">   registerTransaction(transaction);</div><div class="line">   <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ Transaction æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>æ ¹äº‹åŠ¡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Transaction.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºæŒ‡å®šç±»å‹çš„äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionType äº‹åŠ¡ç±»å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionType transactionType)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.xid = <span class="keyword">new</span> TransactionXid();</div><div class="line">   <span class="keyword">this</span>.status = TransactionStatus.TRYING; <span class="comment">// å°è¯•ä¸­çŠ¶æ€</span></div><div class="line">   <span class="keyword">this</span>.transactionType = transactionType;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç›®å‰è¯¥æ„é€ æ–¹æ³•åªæœ‰ <code>TransactionManager#begin()</code> åœ¨è°ƒç”¨ï¼Œå³åªåˆ›å»º<strong>æ ¹äº‹åŠ¡</strong>ã€‚</li></ul></li><li>è°ƒç”¨ <code>TransactionRepository#crete()</code> æ–¹æ³•ï¼Œå­˜å‚¨äº‹åŠ¡ã€‚</li><li><p>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transaction äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (CURRENT.get() == <span class="keyword">null</span>) &#123;</div><div class="line">       CURRENT.set(<span class="keyword">new</span> LinkedList&lt;Transaction&gt;());</div><div class="line">   &#125;</div><div class="line">   CURRENT.get().push(transaction); <span class="comment">// æ·»åŠ åˆ°å¤´éƒ¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>å¯èƒ½æœ‰åŒå­¦ä¼šæ¯”è¾ƒå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨é˜Ÿåˆ—å­˜å‚¨å½“å‰çº¿ç¨‹äº‹åŠ¡</strong>ï¼ŸTCC-Transaction æ”¯æŒ<strong>å¤šä¸ª</strong>çš„äº‹åŠ¡<strong>ç‹¬ç«‹å­˜åœ¨</strong>ï¼Œååˆ›å»ºçš„äº‹åŠ¡å…ˆæäº¤ï¼Œç±»ä¼¼ Spring çš„<code>org.springframework.transaction.annotation.Propagation.REQUIRES_NEW</code> ã€‚åœ¨ä¸‹æ–‡ï¼Œå¾ˆå¿«æˆ‘ä»¬å°±ä¼šçœ‹åˆ° TCC-Transaction è‡ªå·±çš„ <code>org.mengyun.tcctransaction.api.Propagation</code> ã€‚</li></ul></li></ul><h2 id="5-2-ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡"><a href="#5-2-ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡" class="headerlink" title="5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡"></a>5.2 ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#propagationNewBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.PROVIDER å¹¶ä¸” äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationNewBegin</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">  <span class="comment">// åˆ›å»º åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">  Transaction transaction = <span class="keyword">new</span> Transaction(transactionContext);</div><div class="line">  <span class="comment">// å­˜å‚¨ äº‹åŠ¡</span></div><div class="line">  transactionRepository.create(transaction);</div><div class="line">  <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">  registerTransaction(transaction);</div><div class="line">  <span class="keyword">return</span> transaction;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ Transaction æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>åˆ†æ”¯äº‹åŠ¡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºåˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.xid = transactionContext.getXid(); <span class="comment">// äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ xid</span></div><div class="line">   <span class="keyword">this</span>.status = TransactionStatus.TRYING; <span class="comment">// å°è¯•ä¸­çŠ¶æ€</span></div><div class="line">   <span class="keyword">this</span>.transactionType = TransactionType.BRANCH; <span class="comment">// åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>åˆ†æ”¯</strong>äº‹åŠ¡ä½¿ç”¨ä¼ æ’­çš„äº‹åŠ¡ä¸Šä¸‹æ–‡çš„äº‹åŠ¡ç¼–å·ã€‚</li></ul></li><li>è°ƒç”¨ <code>TransactionRepository#crete()</code> æ–¹æ³•ï¼Œå­˜å‚¨äº‹åŠ¡ã€‚ä¸ºä»€ä¹ˆè¦å­˜å‚¨<strong>åˆ†æ”¯</strong>äº‹åŠ¡ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</li><li>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚</li></ul><h2 id="5-3-ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡"><a href="#5-3-ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡" class="headerlink" title="5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡"></a>5.3 ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#propagationExistBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>è°ƒç”¨æ–¹æ³•ç±»å‹ä¸º MethodType.PROVIDER å¹¶ä¸” äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚MethodType åœ¨<a href="#">ã€Œ6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€</a>è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> åˆ†æ”¯äº‹åŠ¡</span></div><div class="line"><span class="comment">* <span class="doctag">@throws</span> NoExistedTransactionException å½“äº‹åŠ¡ä¸å­˜åœ¨æ—¶</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationExistBegin</span><span class="params">(TransactionContext transactionContext)</span> <span class="keyword">throws</span> NoExistedTransactionException </span>&#123;</div><div class="line">   <span class="comment">// æŸ¥è¯¢ äº‹åŠ¡</span></div><div class="line">   Transaction transaction = transactionRepository.findByXid(transactionContext.getXid());</div><div class="line">   <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">// è®¾ç½® äº‹åŠ¡ çŠ¶æ€</span></div><div class="line">       transaction.changeStatus(TransactionStatus.valueOf(transactionContext.getStatus()));</div><div class="line">       <span class="comment">// æ³¨å†Œ äº‹åŠ¡</span></div><div class="line">       registerTransaction(transaction);</div><div class="line">       <span class="keyword">return</span> transaction;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> NoExistedTransactionException();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>TransactionRepository#findByXid()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ<strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CONFIRMING æˆ– CANCELLINGã€‚</li><li>è°ƒç”¨ <code>#registerTransaction(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œäº‹åŠ¡åˆ°å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ã€‚</li><li>ä¸ºä»€ä¹ˆæ­¤å¤„æ˜¯<strong>åˆ†æ”¯</strong>äº‹åŠ¡å‘¢ï¼Ÿç»“åˆ <code>#propagationNewBegin(...)</code> æ€è€ƒä¸‹ã€‚ </li></ul><h2 id="5-4-æäº¤äº‹åŠ¡"><a href="#5-4-æäº¤äº‹åŠ¡" class="headerlink" title="5.4 æäº¤äº‹åŠ¡"></a>5.4 æäº¤äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#commit(...)</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æäº¤äº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = getCurrentTransaction();</div><div class="line">   <span class="comment">// è®¾ç½® äº‹åŠ¡çŠ¶æ€ ä¸º CONFIRMING</span></div><div class="line">   transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ äº‹åŠ¡</span></div><div class="line">       transaction.commit();</div><div class="line">       <span class="comment">// åˆ é™¤ äº‹åŠ¡</span></div><div class="line">       transactionRepository.delete(transaction);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</div><div class="line">       logger.error(<span class="string">"compensable transaction confirm failed."</span>, commitException);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œ è·å–äº‹åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">getCurrentTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isTransactionActive()) &#123;</div><div class="line">       <span class="keyword">return</span> CURRENT.get().peek(); <span class="comment">// è·å¾—å¤´éƒ¨å…ƒç´ </span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</div><div class="line">   Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div class="line">   <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä¸ºä»€ä¹ˆè·å¾—é˜Ÿåˆ—<strong>å¤´éƒ¨</strong>å…ƒç´ å‘¢ï¼Ÿè¯¥å…ƒç´ å³æ˜¯ä¸Šæ–‡è°ƒç”¨ <code>#registerTransaction(...)</code> æ³¨å†Œåˆ°é˜Ÿåˆ—å¤´éƒ¨ã€‚</li></ul></li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ <strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CONFIRMINGã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#commit(...)</code> æ–¹æ³•ï¼Œ <strong>æäº¤</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#delete(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ é™¤</strong>äº‹åŠ¡ã€‚</li></ul><h2 id="5-5-å›æ»šäº‹åŠ¡"><a href="#5-5-å›æ»šäº‹åŠ¡" class="headerlink" title="5.5 å›æ»šäº‹åŠ¡"></a>5.5 å›æ»šäº‹åŠ¡</h2><p>è°ƒç”¨ <code>#rollback(...)</code> æ–¹æ³•ï¼Œå–æ¶ˆäº‹åŠ¡ï¼Œå’Œ <code>#commit()</code> æ–¹æ³•åŸºæœ¬ç±»ä¼¼ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Confirm / Cancel é˜¶æ®µ</strong>è¢«è°ƒç”¨ã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å›æ»šäº‹åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = getCurrentTransaction();</div><div class="line">   <span class="comment">// è®¾ç½® äº‹åŠ¡çŠ¶æ€ ä¸º CANCELLING</span></div><div class="line">   transaction.changeStatus(TransactionStatus.CANCELLING);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æäº¤ äº‹åŠ¡</span></div><div class="line">       transaction.rollback();</div><div class="line">       <span class="comment">// åˆ é™¤ äº‹åŠ¡</span></div><div class="line">       transactionRepository.delete(transaction);</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable rollbackException) &#123;</div><div class="line">       logger.error(<span class="string">"compensable transaction rollback failed."</span>, rollbackException);</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> CancellingException(rollbackException);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œè·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#changeStatus(...)</code> æ–¹æ³•ï¼Œ <strong>è®¾ç½®</strong>äº‹åŠ¡çŠ¶æ€ä¸º CANCELLINGã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#rollback(...)</code> æ–¹æ³•ï¼Œ <strong>å›æ»š</strong>äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#delete(...)</code> æ–¹æ³•ï¼Œ<strong>åˆ é™¤</strong>äº‹åŠ¡ã€‚</li></ul><h2 id="5-6-æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡"><a href="#5-6-æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡" class="headerlink" title="5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡"></a>5.6 æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</h2><p>è°ƒç”¨ <code>#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚è¯¥æ–¹æ³•åœ¨<strong>äº‹åŠ¡å¤„äº Try é˜¶æ®µ</strong>è¢«è°ƒç”¨ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> participant å‚ä¸è€…</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(Participant participant)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– äº‹åŠ¡</span></div><div class="line">   Transaction transaction = <span class="keyword">this</span>.getCurrentTransaction();</div><div class="line">   <span class="comment">// æ·»åŠ å‚ä¸è€…</span></div><div class="line">   transaction.enlistParticipant(participant);</div><div class="line">   <span class="comment">// æ›´æ–° äº‹åŠ¡</span></div><div class="line">   transactionRepository.update(transaction);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œè·å–äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>Transaction#enlistParticipant(...)</code> æ–¹æ³•ï¼Œ æ·»åŠ å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionRepository#update(...)</code> æ–¹æ³•ï¼Œ <strong>æ›´æ–°</strong>äº‹åŠ¡ã€‚</li></ul><h1 id="6-äº‹åŠ¡æ‹¦æˆªå™¨"><a href="#6-äº‹åŠ¡æ‹¦æˆªå™¨" class="headerlink" title="6. äº‹åŠ¡æ‹¦æˆªå™¨"></a>6. äº‹åŠ¡æ‹¦æˆªå™¨</h1><p>TCC-Transaction åŸºäº <code>org.mengyun.tcctransaction.api.@Compensable</code> + <code>org.aspectj.lang.annotation.@Aspect</code> <strong>æ³¨è§£</strong> <strong>AOP åˆ‡é¢</strong>å®ç°ä¸šåŠ¡æ–¹æ³•çš„ TCC äº‹åŠ¡å£°æ˜<strong>æ‹¦æˆª</strong>ï¼ŒåŒ Spring çš„ <code>org.springframework.transaction.annotation.@Transactional</code> çš„å®ç°ã€‚</p><p>TCC-Transaction æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼š</p><ul><li><code>org.mengyun.tcctransaction.interceptor.CompensableTransactionInterceptor</code>ï¼Œå¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨ã€‚</li><li><code>org.mengyun.tcctransaction.interceptor.ResourceCoordinatorInterceptor</code>ï¼Œèµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€‚</li></ul><p>åœ¨åˆ†äº«æ‹¦æˆªå™¨çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·çœ‹çœ‹ @Compensable æ³¨è§£ã€‚</p><h2 id="6-1-Compensable"><a href="#6-1-Compensable" class="headerlink" title="6.1 Compensable"></a>6.1 Compensable</h2><p>@Compensableï¼Œæ ‡è®°å¯è¡¥å¿çš„æ–¹æ³•æ³¨è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Compensable &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">confirmMethod</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">String <span class="title">cancelMethod</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditor() <span class="keyword">default</span> DefaultTransactionContextEditor.class;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>propagationï¼Œä¼ æ’­çº§åˆ«( Propagation )ï¼Œé»˜è®¤ Propagation.REQUIREDã€‚å’Œ Spring çš„ Propagation é™¤äº†ç¼ºå°‘å‡ ä¸ªå±æ€§ï¼ŒåŸºæœ¬ä¸€è‡´ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Propagation &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    REQUIRED(<span class="number">0</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    SUPPORTS(<span class="number">1</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    MANDATORY(<span class="number">2</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    REQUIRES_NEW(<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>confirmMethodï¼Œç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•åã€‚</p></li><li>cancelMethodï¼Œå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•åã€‚</li><li><p>TransactionContextEditorï¼Œäº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨( TransactionContextEditor )ï¼Œç”¨äºè®¾ç½®å’Œè·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡( TransactionContext )ï¼Œåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>å¯ä»¥çœ‹åˆ°è¢«è°ƒç”¨ï¼Œæ­¤å¤„åªçœ‹å®ƒçš„ä»£ç å®ç°ã€‚<code>org.mengyun.tcctransaction.api.TransactionContextEditor</code> æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»å‚æ•°ä¸­è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¾ç½®äº‹åŠ¡ä¸Šä¸‹æ–‡åˆ°å‚æ•°ä¸­</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target å¯¹è±¡</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> method æ–¹æ³•</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args å‚æ•°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>DefaultTransactionContextEditorï¼Œ<strong>é»˜è®¤</strong>äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div class="line">        <span class="keyword">if</span> (position &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> (TransactionContext) args[position];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div class="line">        <span class="keyword">if</span> (position &gt;= <span class="number">0</span>) &#123;</div><div class="line">            args[position] = transactionContext; <span class="comment">// è®¾ç½®æ–¹æ³•å‚æ•°</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡åœ¨æ–¹æ³•å‚æ•°é‡Œçš„ä½ç½®</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> parameterTypes å‚æ•°ç±»å‹é›†åˆ</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTransactionContextParamPosition</span><span class="params">(Class&lt;?&gt;[] parameterTypes)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> position = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (parameterTypes[i].equals(org.mengyun.tcctransaction.api.TransactionContext.class)) &#123;</div><div class="line">                position = i;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> position;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul><ul><li><p>NullableTransactionContextEditorï¼Œæ— äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>   <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NullableTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line">    </div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line">    </div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></li><li><p>DubboTransactionContextEditorï¼ŒDubbo äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å®ç°ï¼Œé€šè¿‡ Dubbo éšå¼ä¼ å‚æ–¹å¼è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self">ã€ŠTCC-Transaction æºç è§£æ â€”â€” Dubbo æ”¯æŒã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h2 id="6-2-å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨"><a href="#6-2-å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨" class="headerlink" title="6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨"></a>6.2 å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨</h2><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹å¯è¡¥å¿äº‹åŠ¡æ‹¦æˆªå™¨å¯¹åº”çš„åˆ‡é¢ <code>org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CompensableTransactionInterceptor compensableTransactionInterceptor;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompensableTransactionInterceptor</span><span class="params">(CompensableTransactionInterceptor compensableTransactionInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.compensableTransactionInterceptor = compensableTransactionInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compensableService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"compensableService()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> compensableTransactionInterceptor.interceptCompensableMethod(pjp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€šè¿‡ <code>org.aspectj.lang.annotation.@Pointcut</code> + <code>org.aspectj.lang.annotation.@Around</code> æ³¨è§£ï¼Œé…ç½®å¯¹ <strong>@Compensable æ³¨è§£çš„æ–¹æ³•</strong>è¿›è¡Œæ‹¦æˆªï¼Œè°ƒç”¨ <code>CompensableTransactionInterceptor#interceptCompensableMethod(...)</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><p><strong>CompensableTransactionInterceptor å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionInterceptor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// è·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•</span></div><div class="line">        Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div class="line">        <span class="comment">//</span></div><div class="line">        Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line">        Propagation propagation = compensable.propagation();</div><div class="line">        <span class="comment">// è·å¾— äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line">        TransactionContext transactionContext = FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs());</div><div class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨äº‹åŠ¡ä¸­</span></div><div class="line">        <span class="keyword">boolean</span> isTransactionActive = transactionManager.isTransactionActive();</div><div class="line">        <span class="comment">// åˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•</span></div><div class="line">        <span class="keyword">if</span> (!TransactionUtils.isLegalTransactionContext(isTransactionActive, propagation, transactionContext)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"no active compensable transaction while propagation is mandatory for method "</span> + method.getName());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è®¡ç®—æ–¹æ³•ç±»å‹</span></div><div class="line">        MethodType methodType = CompensableMethodUtils.calculateMethodType(propagation, isTransactionActive, transactionContext);</div><div class="line">        <span class="comment">// å¤„ç†</span></div><div class="line">        <span class="keyword">switch</span> (methodType) &#123;</div><div class="line">            <span class="keyword">case</span> ROOT:</div><div class="line">                <span class="keyword">return</span> rootMethodProceed(pjp);</div><div class="line">            <span class="keyword">case</span> PROVIDER:</div><div class="line">                <span class="keyword">return</span> providerMethodProceed(pjp, transactionContext);</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">return</span> pjp.proceed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>CompensableMethodUtils#getCompensableMethod(...)</code> æ–¹æ³•ï¼Œè·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CompensableMethodUtils.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—å¸¦ <span class="doctag">@Compensable</span> æ³¨è§£çš„æ–¹æ³•</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> pjp åˆ‡é¢ç‚¹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–¹æ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title">getCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</div><div class="line">   Method method = ((MethodSignature) (pjp.getSignature())).getMethod(); <span class="comment">// ä»£ç†æ–¹æ³•å¯¹è±¡</span></div><div class="line">   <span class="keyword">if</span> (method.getAnnotation(Compensable.class) == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           method = pjp.getTarget().getClass().getMethod(method.getName(), method.getParameterTypes()); <span class="comment">// å®é™…æ–¹æ³•å¯¹è±¡</span></div><div class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> method;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>TransactionContextEditor#get(...)</code> æ–¹æ³•ï¼Œä»å‚æ•°ä¸­è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚<strong>ä¸ºä»€ä¹ˆä»å‚æ•°ä¸­å¯ä»¥è·å¾—äº‹åŠ¡ä¸Šä¸‹æ–‡å‘¢</strong>ï¼Ÿåœ¨<a href="#">ã€Œ6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨ã€</a>æ­æ™“ç­”æ¡ˆã€‚</p></li><li><p>è°ƒç”¨ <code>TransactionManager#isTransactionActive()</code> æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ˜¯å¦åœ¨äº‹åŠ¡ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTransactionActive</span><span class="params">()</span> </span>&#123;</div><div class="line">   Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div class="line">   <span class="keyword">return</span> transactions != <span class="keyword">null</span> &amp;&amp; !transactions.isEmpty();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>TransactionUtils#isLegalTransactionContext(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionUtils.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ¤æ–­äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="comment">* åœ¨ Propagation.MANDATORY å¿…é¡»æœ‰åœ¨äº‹åŠ¡å†…</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isTransactionActive æ˜¯å¦</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> propagation ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ˜¯å¦åˆæ³•</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLegalTransactionContext</span><span class="params">(<span class="keyword">boolean</span> isTransactionActive, Propagation propagation, TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (propagation.equals(Propagation.MANDATORY) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ä¼ æ’­çº§åˆ«ä¸º Propagation.MANDATORY æ—¶ï¼Œè¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CompensableMethodUtils#calculateMethodType(...)</code> æ–¹æ³•ï¼Œè®¡ç®—æ–¹æ³•ç±»å‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è®¡ç®—æ–¹æ³•ç±»å‹</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> propagation ä¼ æ’­çº§åˆ«</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isTransactionActive æ˜¯å¦äº‹åŠ¡å¼€å¯</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> transactionContext äº‹åŠ¡ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ–¹æ³•ç±»å‹</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodType <span class="title">calculateMethodType</span><span class="params">(Propagation propagation, <span class="keyword">boolean</span> isTransactionActive, TransactionContext transactionContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> ((propagation.equals(Propagation.REQUIRED) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span class="keyword">null</span>) <span class="comment">// Propagation.REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚</span></div><div class="line">           || propagation.equals(Propagation.REQUIRES_NEW)) &#123; <span class="comment">// Propagation.REQUIRES_NEWï¼šæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></div><div class="line">       <span class="keyword">return</span> MethodType.ROOT;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((propagation.equals(Propagation.REQUIRED) <span class="comment">// Propagation.REQUIREDï¼šæ”¯æŒå½“å‰äº‹åŠ¡</span></div><div class="line">               || propagation.equals(Propagation.MANDATORY)) <span class="comment">// Propagation.MANDATORYï¼šæ”¯æŒå½“å‰äº‹åŠ¡</span></div><div class="line">           &amp;&amp; !isTransactionActive &amp;&amp; transactionContext != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">return</span> MethodType.PROVIDER;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> MethodType.NORMAL;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è®¡ç®—æ–¹æ³•ç±»å‹( MethodType )çš„ç›®çš„ï¼Œå¯ä»¥æ ¹æ®ä¸åŒæ–¹æ³•ç±»å‹ï¼Œåšä¸åŒçš„äº‹åŠ¡å¤„ç†ã€‚</li><li>æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œå‘èµ·<strong>æ ¹äº‹åŠ¡</strong>ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹äºŒé€‰ä¸€ï¼š<ul><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIREDï¼Œå¹¶ä¸”å½“å‰æ²¡æœ‰äº‹åŠ¡ã€‚</li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIRES_NEWï¼Œæ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼ŒæŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚<strong>æ­¤æ—¶ï¼Œäº‹åŠ¡ç®¡ç†å™¨çš„å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªäº‹åŠ¡</strong>ã€‚<ul><li>æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œå‘èµ·<strong>åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œåˆ¤æ–­æ¡ä»¶å¦‚ä¸‹äºŒé€‰ä¸€ï¼š</li></ul></li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.REQUIREDï¼Œå¹¶ä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œ<strong>å¹¶ä¸”æ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡</strong>ã€‚</li><li>äº‹åŠ¡ä¼ æ’­çº§åˆ«ä¸º Propagation.PROVIDERï¼Œå¹¶ä¸”å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œ<strong>å¹¶ä¸”æ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡</strong>ã€‚</li><li><strong>å½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œæ–¹æ³•å‚æ•°ä¼ é€’äº†äº‹åŠ¡ä¸Šä¸‹æ–‡æ˜¯ä»€ä¹ˆæ„æ€</strong>ï¼Ÿå½“è·¨æœåŠ¡<strong>è¿œç¨‹</strong>è°ƒç”¨æ—¶ï¼Œè¢«è°ƒç”¨æœåŠ¡æœ¬èº«( <strong>æœåŠ¡æä¾›è€…</strong> )ä¸åœ¨äº‹åŠ¡ä¸­ï¼Œé€šè¿‡ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡å‚æ•°ï¼Œèå…¥å½“å‰äº‹åŠ¡ã€‚<ul><li>æ–¹æ³•ç±»å‹ä¸º MethodType.Normal æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å¤„ç†ã€‚</li><li>MethodType.CONSUMER é¡¹ç›®å·²ç»ä¸å†ä½¿ç”¨ï¼ŒçŒœæµ‹å·²åºŸå¼ƒã€‚</li></ul></li></ul></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º MethodType.ROOT æ—¶ï¼Œè°ƒç”¨ <code>#rootMethodProceed(...)</code> æ–¹æ³•ï¼Œå‘èµ· <strong>TCC æ•´ä½“æµç¨‹</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">rootMethodProceed</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   Object returnValue;</div><div class="line">   Transaction transaction = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// å‘èµ·æ ¹äº‹åŠ¡</span></div><div class="line">       transaction = transactionManager.begin();</div><div class="line">       <span class="comment">// æ‰§è¡Œæ–¹æ³•åŸé€»è¾‘</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           returnValue = pjp.proceed();</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable tryingException) &#123;</div><div class="line">           <span class="keyword">if</span> (isDelayCancelException(tryingException)) &#123; <span class="comment">// æ˜¯å¦å»¶è¿Ÿå›æ»š</span></div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               logger.warn(String.format(<span class="string">"compensable transaction trying failed. transaction content:%s"</span>, JSON.toJSONString(transaction)), tryingException);</div><div class="line">               <span class="comment">// å›æ»šäº‹åŠ¡</span></div><div class="line">               transactionManager.rollback();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">throw</span> tryingException;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æäº¤äº‹åŠ¡</span></div><div class="line">       transactionManager.commit();</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// å°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤</span></div><div class="line">       transactionManager.cleanAfterCompletion(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#transactionManager()</code> æ–¹æ³•ï¼Œå‘èµ·<strong>æ ¹äº‹åŠ¡</strong>ï¼Œ<strong>TCC Try é˜¶æ®µå¼€å§‹</strong>ã€‚</li><li>è°ƒç”¨ <code>ProceedingJoinPoint#proceed()</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•<strong>åŸé€»è¾‘( å³ Try é€»è¾‘ )</strong>ã€‚</li><li>å½“åŸé€»è¾‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œ<strong>TCC Try é˜¶æ®µå¤±è´¥</strong>ï¼Œè°ƒç”¨ <code>TransactionManager#rollback(...)</code> æ–¹æ³•ï¼Œ<strong>TCC Cancel é˜¶æ®µ</strong>ï¼Œå›æ»šäº‹åŠ¡ã€‚æ­¤å¤„ <code>#isDelayCancelException(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­å¼‚å¸¸æ˜¯å¦ä¸ºå»¶è¿Ÿå–æ¶ˆå›æ»šå¼‚å¸¸ï¼Œéƒ¨åˆ†å¼‚å¸¸ä¸é€‚åˆç«‹å³å›æ»šäº‹åŠ¡ï¼Œåœ¨<a href="http://www.iocoder.cn/TCC-Transaction/transaction-recovery/?self">ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” äº‹åŠ¡æ¢å¤ã€‹</a>è¯¦ç»†è§£æã€‚</li><li>å½“åŸé€»è¾‘æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œ<strong>TCC Try é˜¶æ®µæˆåŠŸ</strong>ï¼Œè°ƒç”¨ <code>TransactionManager#commit(...)</code> æ–¹æ³•ï¼Œ<strong>TCC Confirm é˜¶æ®µ</strong>ï¼Œæäº¤äº‹åŠ¡ã€‚</li><li><p>è°ƒç”¨ <code>TransactionManager#cleanAfterCompletion(...)</code> æ–¹æ³•ï¼Œå°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤ï¼Œé¿å…çº¿ç¨‹å†²çªã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransactionManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanAfterCompletion</span><span class="params">(Transaction transaction)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isTransactionActive() &amp;&amp; transaction != <span class="keyword">null</span>) &#123;</div><div class="line">        Transaction currentTransaction = getCurrentTransaction();</div><div class="line">        <span class="keyword">if</span> (currentTransaction == transaction) &#123;</div><div class="line">            CURRENT.get().pop();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Illegal transaction when clean after completion"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º Propagation.PROVIDER æ—¶ï¼ŒæœåŠ¡æä¾›è€…å‚ä¸ <strong>TCC æ•´ä½“æµç¨‹</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">providerMethodProceed</span><span class="params">(ProceedingJoinPoint pjp, TransactionContext transactionContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">   Transaction transaction = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">switch</span> (TransactionStatus.valueOf(transactionContext.getStatus())) &#123;</div><div class="line">           <span class="keyword">case</span> TRYING:</div><div class="line">               <span class="comment">// ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">               transaction = transactionManager.propagationNewBegin(transactionContext);</div><div class="line">               <span class="keyword">return</span> pjp.proceed();</div><div class="line">           <span class="keyword">case</span> CONFIRMING:</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">                   transaction = transactionManager.propagationExistBegin(transactionContext);</div><div class="line">                   <span class="comment">// æäº¤äº‹åŠ¡</span></div><div class="line">                   transactionManager.commit();</div><div class="line">               &#125; <span class="keyword">catch</span> (NoExistedTransactionException excepton) &#123;</div><div class="line">                   <span class="comment">//the transaction has been commit,ignore it.</span></div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> CANCELLING:</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// ä¼ æ’­è·å–åˆ†æ”¯äº‹åŠ¡</span></div><div class="line">                   transaction = transactionManager.propagationExistBegin(transactionContext);</div><div class="line">                   <span class="comment">// å›æ»šäº‹åŠ¡</span></div><div class="line">                   transactionManager.rollback();</div><div class="line">               &#125; <span class="keyword">catch</span> (NoExistedTransactionException exception) &#123;</div><div class="line">                   <span class="comment">//the transaction has been rollback,ignore it.</span></div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// å°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤</span></div><div class="line">       transactionManager.cleanAfterCompletion(transaction);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è¿”å›ç©ºå€¼</span></div><div class="line">   Method method = ((MethodSignature) (pjp.getSignature())).getMethod();</div><div class="line">   <span class="keyword">return</span> ReflectionUtils.getNullValue(method.getReturnType());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.TRYING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#propagationExistBegin(...)</code> æ–¹æ³•ï¼Œä¼ æ’­å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡ã€‚å‘èµ·<strong>åˆ†æ”¯</strong>äº‹åŠ¡å®Œæˆåï¼Œè°ƒç”¨ <code>ProceedingJoinPoint#proceed()</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•<strong>åŸé€»è¾‘( å³ Try é€»è¾‘ )</strong>ã€‚<ul><li><strong>ä¸ºä»€ä¹ˆè¦ä¼ æ’­å‘èµ·åˆ†æ”¯äº‹åŠ¡</strong>ï¼Ÿåœ¨<strong>æ ¹äº‹åŠ¡</strong>è¿›è¡Œ Confirm / Cancel æ—¶ï¼Œè°ƒç”¨<strong>æ ¹äº‹åŠ¡</strong>ä¸Šçš„å‚ä¸è€…ä»¬æäº¤æˆ–å›æ»šäº‹åŠ¡æ—¶ï¼Œè¿›è¡Œè¿œç¨‹æœåŠ¡æ–¹æ³•è°ƒç”¨çš„å‚ä¸è€…ï¼Œå¯ä»¥é€šè¿‡è‡ªå·±çš„äº‹åŠ¡ç¼–å·å…³è”ä¸Šä¼ æ’­çš„<strong>åˆ†æ”¯</strong>äº‹åŠ¡( ä¸¤è€…çš„äº‹åŠ¡ç¼–å·ç›¸ç­‰ )ï¼Œè¿›è¡Œäº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚</li></ul></li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#commit()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</li><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.CANCELLING æ—¶ï¼Œè°ƒç”¨ <code>TransactionManager#rollback()</code> æ–¹æ³•ï¼Œæäº¤äº‹åŠ¡ã€‚</li><li>è°ƒç”¨ <code>TransactionManager#cleanAfterCompletion(...)</code> æ–¹æ³•ï¼Œå°†äº‹åŠ¡ä»å½“å‰çº¿ç¨‹äº‹åŠ¡é˜Ÿåˆ—ç§»é™¤ï¼Œé¿å…çº¿ç¨‹å†²çªã€‚</li><li><p>å½“äº‹åŠ¡å¤„äº TransactionStatus.CONFIRMING / TransactionStatus.CANCELLING æ—¶ï¼Œè°ƒç”¨ <code>ReflectionUtils#getNullValue(...)</code> æ–¹æ³•ï¼Œè¿”å›ç©ºå€¼ã€‚<strong>ä¸ºä»€ä¹ˆè¿”å›ç©ºå€¼</strong>ï¼ŸConfirm / Cancel ç›¸å…³æ–¹æ³•ï¼Œæ˜¯é€šè¿‡ AOP åˆ‡é¢è°ƒç”¨ï¼Œåªè°ƒç”¨ï¼Œä¸å¤„ç†è¿”å›å€¼ï¼Œä½†æ˜¯åˆä¸èƒ½æ²¡æœ‰è¿”å›å€¼ï¼Œå› æ­¤ç›´æ¥è¿”å›ç©ºã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getNullValue</span><span class="params">(Class type)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¤„ç†åŸºæœ¬ç±»å‹</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">boolean</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">byte</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">short</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">int</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">long</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">float</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">double</span>.class.equals(type)) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å¤„ç†å¯¹è±¡</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li><li><p>å½“æ–¹æ³•ç±»å‹ä¸º Propagation.NORMAL æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•åŸé€»è¾‘ï¼Œ<strong>ä¸è¿›è¡Œäº‹åŠ¡å¤„ç†</strong>ã€‚</p></li></ul><h2 id="6-3-èµ„æºåè°ƒè€…æ‹¦æˆªå™¨"><a href="#6-3-èµ„æºåè°ƒè€…æ‹¦æˆªå™¨" class="headerlink" title="6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨"></a>6.3 èµ„æºåè°ƒè€…æ‹¦æˆªå™¨</h2><p>å…ˆä¸€èµ·æ¥çœ‹ä¸‹èµ„æºåè°ƒè€…æ‹¦æˆªå™¨  å¯¹åº”çš„åˆ‡é¢ <code>org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</code>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ResourceCoordinatorInterceptor resourceCoordinatorInterceptor;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionContextCall</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"transactionContextCall()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> resourceCoordinatorInterceptor.interceptTransactionContextMethod(pjp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceCoordinatorInterceptor</span><span class="params">(ResourceCoordinatorInterceptor resourceCoordinatorInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.resourceCoordinatorInterceptor = resourceCoordinatorInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€šè¿‡ <code>org.aspectj.lang.annotation.@Pointcut</code> + <code>org.aspectj.lang.annotation.@Around</code> æ³¨è§£ï¼Œé…ç½®å¯¹ <strong>@Compensable æ³¨è§£çš„æ–¹æ³•</strong>è¿›è¡Œæ‹¦æˆªï¼Œè°ƒç”¨ <code>ResourceCoordinatorInterceptor#interceptTransactionContextMethod(...)</code> æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li></ul><p><strong>ResourceCoordinatorInterceptor å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        Transaction transaction = transactionManager.getCurrentTransaction();</div><div class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">switch</span> (transaction.getStatus()) &#123;</div><div class="line">                <span class="keyword">case</span> TRYING:</div><div class="line">                    <span class="comment">// æ·»åŠ äº‹åŠ¡å‚ä¸è€…</span></div><div class="line">                    enlistParticipant(pjp);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> CONFIRMING:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> CANCELLING:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ‰§è¡Œæ–¹æ³•åŸé€»è¾‘</span></div><div class="line">        <span class="keyword">return</span> pjp.proceed(pjp.getArgs());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“äº‹åŠ¡å¤„äº TransactionStatus.TRYING æ—¶ï¼Œè°ƒç”¨ <code>#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…ã€‚</li><li>è°ƒç”¨ <code>ProceedingJoinPoint#proceed(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ–¹æ³•åŸé€»è¾‘ã€‚</li></ul><p><strong><code>ResourceCoordinatorInterceptor#enlistParticipant()</code> å®ç°ä»£ç å¦‚ä¸‹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</div><div class="line">   <span class="comment">// è·å¾— @Compensable æ³¨è§£</span></div><div class="line">   Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div class="line">   <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(<span class="string">"join point not found method, point is : %s"</span>, pjp.getSignature().getName()));</div><div class="line">   &#125;</div><div class="line">   Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line">   <span class="comment">// è·å¾— ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³• å’Œ å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line">   String confirmMethodName = compensable.confirmMethod();</div><div class="line">   String cancelMethodName = compensable.cancelMethod();</div><div class="line">   <span class="comment">// è·å– å½“å‰çº¿ç¨‹äº‹åŠ¡ç¬¬ä¸€ä¸ª(å¤´éƒ¨)å…ƒç´ </span></div><div class="line">   Transaction transaction = transactionManager.getCurrentTransaction();</div><div class="line">   <span class="comment">// åˆ›å»º äº‹åŠ¡ç¼–å·</span></div><div class="line">   TransactionXid xid = <span class="keyword">new</span> TransactionXid(transaction.getXid().getGlobalTransactionId());</div><div class="line">   <span class="comment">// TODO</span></div><div class="line">   <span class="keyword">if</span> (FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs()) == <span class="keyword">null</span>) &#123;</div><div class="line">       FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().set(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.TRYING.getId()), pjp.getTarget(), ((MethodSignature) pjp.getSignature()).getMethod(), pjp.getArgs());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å¾—ç±»</span></div><div class="line">   Class targetClass = ReflectionUtils.getDeclaringType(pjp.getTarget().getClass(), method.getName(), method.getParameterTypes());</div><div class="line">   <span class="comment">// åˆ›å»º ç¡®è®¤æ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ å’Œ å–æ¶ˆæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line">   InvocationContext confirmInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</div><div class="line">           confirmMethodName,</div><div class="line">           method.getParameterTypes(), pjp.getArgs());</div><div class="line">   InvocationContext cancelInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</div><div class="line">           cancelMethodName,</div><div class="line">           method.getParameterTypes(), pjp.getArgs());</div><div class="line">   <span class="comment">// åˆ›å»º äº‹åŠ¡å‚ä¸è€…</span></div><div class="line">   Participant participant =</div><div class="line">           <span class="keyword">new</span> Participant(</div><div class="line">                   xid,</div><div class="line">                   confirmInvocation,</div><div class="line">                   cancelInvocation,</div><div class="line">                   compensable.transactionContextEditor());</div><div class="line">   <span class="comment">// æ·»åŠ  äº‹åŠ¡å‚ä¸è€… åˆ° äº‹åŠ¡</span></div><div class="line">   transactionManager.enlistParticipant(participant);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>CompensableMethodUtils#getCompensableMethod(...)</code> æ–¹æ³•ï¼Œè·å¾—å¸¦ @Compensable æ³¨è§£çš„æ–¹æ³•ã€‚</li><li>è°ƒç”¨ <code>#getCurrentTransaction()</code> æ–¹æ³•ï¼Œ è·å–äº‹åŠ¡ã€‚</li><li><p>è°ƒç”¨ TransactionXid æ„é€ æ–¹æ³•ï¼Œåˆ›å»º<strong>åˆ†æ”¯</strong>äº‹åŠ¡ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * å…¨å±€äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] globalTransactionId;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] branchQualifier;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TransactionXid</span><span class="params">(<span class="keyword">byte</span>[] globalTransactionId)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.globalTransactionId = globalTransactionId;</div><div class="line">   branchQualifier = uuidToByteArray(UUID.randomUUID()); <span class="comment">// ç”Ÿæˆ åˆ†æ”¯äº‹åŠ¡ç¼–å·</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åˆ†æ”¯äº‹åŠ¡ç¼–å·( <code>branchQualifier</code> ) éœ€è¦ç”Ÿæˆã€‚</li></ul></li><li><p>TODO TransactionContext å’Œ Participant çš„å…³ç³»ã€‚</p></li><li><p>è°ƒç”¨ <code>ReflectionUtils#getDeclaringType(...)</code> æ–¹æ³•ï¼Œè·å¾—å£°æ˜ @Compensable æ–¹æ³•çš„å®é™…ç±»ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Class <span class="title">getDeclaringType</span><span class="params">(Class aClass, String methodName, Class&lt;?&gt;[] parameterTypes)</span> </span>&#123;</div><div class="line">   Method method;</div><div class="line">   Class findClass = aClass;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       Class[] clazzes = findClass.getInterfaces();</div><div class="line">       <span class="keyword">for</span> (Class clazz : clazzes) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               method = clazz.getDeclaredMethod(methodName, parameterTypes);</div><div class="line">           &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">               method = <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> clazz;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       findClass = findClass.getSuperclass();</div><div class="line">   &#125; <span class="keyword">while</span> (!findClass.equals(Object.class));</div><div class="line">   <span class="keyword">return</span> aClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ InvocationContext æ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«åˆ›å»ºç¡®è®¤æ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡å’Œå–æ¶ˆæ‰§è¡Œæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ç±»</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Class targetClass;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ–¹æ³•å</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String methodName;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‚æ•°ç±»å‹æ•°ç»„</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Class[] parameterTypes;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å‚æ•°æ•°ç»„</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvocationContext</span><span class="params">(Class targetClass, String methodName, Class[] parameterTypes, Object... args)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.methodName = methodName;</div><div class="line">  <span class="keyword">this</span>.parameterTypes = parameterTypes;</div><div class="line">  <span class="keyword">this</span>.targetClass = targetClass;</div><div class="line">  <span class="keyword">this</span>.args = args;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ Participant æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºäº‹åŠ¡å‚ä¸è€…ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Participant</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4127729421281425247L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> TransactionXid xid;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext confirmInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> InvocationContext cancelInvocationContext;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Terminator terminator = <span class="keyword">new</span> Terminator();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼–è¾‘</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Participant</span><span class="params">(TransactionXid xid, InvocationContext confirmInvocationContext, InvocationContext cancelInvocationContext, Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.xid = xid;</div><div class="line">        <span class="keyword">this</span>.confirmInvocationContext = confirmInvocationContext;</div><div class="line">        <span class="keyword">this</span>.cancelInvocationContext = cancelInvocationContext;</div><div class="line">        <span class="keyword">this</span>.transactionContextEditorClass = transactionContextEditorClass;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>TransactionManager#enlistParticipant(...)</code> æ–¹æ³•ï¼Œæ·»åŠ äº‹åŠ¡å‚ä¸è€…åˆ°äº‹åŠ¡ã€‚</p></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å—é™äºæœ¬äººçš„èƒ½åŠ›ï¼Œè›®å¤šå¤„è¡¨è¾¾ä¸å¤Ÿæ¸…æ™°æˆ–è€…æ˜“æ‡‚ï¼Œéå¸¸æŠ±æ­‰ã€‚å¦‚æœä½ å¯¹ä»»ä½•åœ°æ–¹æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿æ·»åŠ æœ¬äººå¾®ä¿¡å·( wangwenbin-server )ï¼ŒæœŸå¾…ä¸ä½ çš„äº¤æµã€‚ä¸é™äº TCCï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¾®æœåŠ¡ï¼Œä»¥åŠç­‰ç­‰ã€‚</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_08/05.png" alt=""></p><p>å¤–é€ä¸€æœ¬æ­¦æ—ç§˜ç±ï¼šå¸¦ä¸­æ–‡æ³¨é‡Šçš„ TCC-Transaction ä»“åº“åœ°å€ï¼Œç›®å‰æ­£åœ¨æ…¢æ…¢å®Œå–„ã€‚ä¼ é€é—¨ï¼š<a href="https://github.com/YunaiV/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/YunaiV/tcc-transaction</a>ã€‚</p><p>å†é€ä¸€æœ¬è‘µèŠ±å®å…¸ï¼š<a href="https://my.oschina.net/fileoptions/blog/899991" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCCå‹åˆ†å¸ƒå¼äº‹åŠ¡åŸç†å’Œå®ç°ã€‹ç³»åˆ—</a>ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«ä¸€ä¸ªæœ‹å‹åœˆå¯å¥½ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ&lt;/strong&gt;  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. TCC åŸç†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a h
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>TCC-Transaction æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://www.iocoder.cn/TCC-Transaction/build-debugging-environment/"/>
    <id>http://www.iocoder.cn/TCC-Transaction/build-debugging-environment/</id>
    <published>2018-01-31T16:00:00.000Z</published>
    <updated>2017-09-17T11:06:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº TCC-Transaction 1.2.3.3 æ­£å¼ç‰ˆ</strong>  </p><ul><li><a href="#">1. ä¾èµ–å·¥å…·</a></li><li><a href="#">2. æºç æ‹‰å–</a></li><li><a href="#">3. åˆå§‹åŒ–æ•°æ®åº“</a></li><li><a href="#">4. å¯åŠ¨ capital é¡¹ç›®</a></li><li><a href="#">5. å¯åŠ¨ redpacket é¡¹ç›®</a></li><li><a href="#">6. å¯åŠ¨ order é¡¹ç›®</a></li><li><a href="#">7. äº¤æµ</a></li></ul><h1 id="1-ä¾èµ–å·¥å…·"><a href="#1-ä¾èµ–å·¥å…·" class="headerlink" title="1. ä¾èµ–å·¥å…·"></a>1. ä¾èµ–å·¥å…·</h1><ul><li>Maven</li><li>Git</li><li>JDK</li><li>MySQL</li><li>IntelliJ IDEA</li></ul><h1 id="2-æºç æ‹‰å–"><a href="#2-æºç æ‹‰å–" class="headerlink" title="2. æºç æ‹‰å–"></a>2. æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/changmingxie/tcc-transaction.git" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/changmingxie/tcc-transaction.git</a> <code>Fork</code> å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦ <code>Fork</code> ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p><p>ä½¿ç”¨ <code>IntelliJ IDEA</code> ä» <code>Fork</code> å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼Œ<code>Maven</code> ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p><p>æœ¬æ–‡åŸºäº <code>master-1.2.x</code> åˆ†æ”¯ã€‚</p><h1 id="3-åˆå§‹åŒ–æ•°æ®åº“"><a href="#3-åˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="3. åˆå§‹åŒ–æ•°æ®åº“"></a>3. åˆå§‹åŒ–æ•°æ®åº“</h1><p>å®˜æ–¹æä¾›äº†ä¸¤ä¸ª Demo é¡¹ç›®ä¾‹å­ï¼š</p><ul><li>tcc-transaction-dubbo-sample</li><li>tcc-transaction-http-sample</li></ul><p>è€ƒè™‘åˆ°ä¸æ˜¯æ‰€æœ‰æ‰€æœ‰åŒå­¦éƒ½ä½¿ç”¨è¿‡ Dubbo æœåŠ¡åŒ–æ¡†æ¶ï¼Œæˆ‘ä»¬ä»¥ tcc-transaction-http-sample é¡¹ä¸ºä¾‹å­ã€‚</p><p>æ‰“å¼€ tcc-transaction-http-sample/src/main/dbscripts ç›®å½•ï¼Œæœ‰å››ä¸ª SQL è„šæœ¬æ–‡ä»¶ï¼š</p><ul><li><code>create_db_cap.sql</code> ï¼štcc-transaction-http-capital  é¡¹ç›®æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li><li><code>create_db_ord.sql</code> ï¼štcc-transaction-http-order é¡¹ç›®æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li><li><code>create_db_red.sql</code> ï¼štcc-transaction-http-redpacket é¡¹ç›®æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li><li><code>create_db_tcc.sql</code> ï¼štcc-transaction <strong>åº•å±‚</strong>æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</li></ul><p>ç¬”è€…ä½¿ç”¨ Navicat è¿›è¡Œæ•°æ®åº“è„šæœ¬æ‰§è¡Œã€‚ä½¿ç”¨æ–¹å¼ä¸ºï¼šNavicat èœå• Connection -&gt; Execute SQL Fileï¼Œé€‰æ‹©è„šæœ¬æ–‡ä»¶ï¼Œé€ä¸ªæ‰§è¡Œã€‚</p><p>ç›®å‰æ•°æ®åº“è„šæœ¬æœªä½¿ç”¨ <code>USE</code> è¯­å¥é€‰æ‹©å¯¹åº”æ•°æ®åº“ï¼Œæ¯ä¸ªè„šæœ¬éƒ½éœ€è¦è¿›è¡Œæ·»åŠ ã€‚ä»¥ <code>create_db_cap.sql</code> ä¸¾ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`tcc_cap`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span>;</div><div class="line"><span class="comment">-- æ–°å¢ USE</span></div><div class="line"><span class="keyword">USE</span> <span class="string">`tcc_cap`</span>;</div></pre></td></tr></table></figure><h1 id="4-å¯åŠ¨-capital-é¡¹ç›®"><a href="#4-å¯åŠ¨-capital-é¡¹ç›®" class="headerlink" title="4. å¯åŠ¨ capital é¡¹ç›®"></a>4. å¯åŠ¨ capital é¡¹ç›®</h1><ol><li>ä¿®æ”¹é¡¹ç›®ä¸‹ <code>jdbc.properties</code> æ–‡ä»¶ï¼Œ<strong>å¡«å†™æˆä½ çš„æ•°æ®åº“åœ°å€</strong>ã€‚</li><li><p>ä½¿ç”¨ IDEA é…ç½® Tomcat è¿›è¡Œå¯åŠ¨ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼š</p> <figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// appcontext-service-provider.xml</div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"httpServer"</span></span></div><div class="line"><span class="tag">     <span class="attr">class</span>=<span class="string">"org.springframework.remoting.support.SimpleHttpServerFactoryBean"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"contexts"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">util:map</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalTradeOrderService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalTradeOrderServiceExporter"</span>/&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"/remoting/CapitalAccountService"</span> <span class="attr">value-ref</span>=<span class="string">"capitalAccountServiceExporter"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"8081"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure><ul><li>é»˜è®¤å¼€å¯ 8081 ç«¯å£æä¾›æ¥å£æœåŠ¡ã€‚æ‰€ä»¥é…ç½® Tomcat çš„ç«¯å£ä¸èƒ½å†ä½¿ç”¨ 8081ï¼Œé¿å…å†²çªã€‚ä¾‹å¦‚ï¼Œç¬”è€…ä½¿ç”¨ 18081ã€‚</li></ul></li><li><p>è®¿é—® <code>http://127.0.0.1:18081/</code>ï¼Œçœ‹åˆ° â€œhello tcc transacton http sample capitalâ€ï¼Œä»£è¡¨é¡¹ç›®å¯åŠ¨å®Œæˆã€‚<strong><code>18081</code> ä¸ºä½ å¡«å†™çš„ Tomcat ç«¯å£</strong>ã€‚</p></li></ol><h1 id="5-å¯åŠ¨-redpacket-é¡¹ç›®"><a href="#5-å¯åŠ¨-redpacket-é¡¹ç›®" class="headerlink" title="5. å¯åŠ¨ redpacket é¡¹ç›®"></a>5. å¯åŠ¨ redpacket é¡¹ç›®</h1><p>åŒ tcc-transaction-http-capital é¡¹ç›®ã€‚</p><h1 id="6-å¯åŠ¨-order-é¡¹ç›®"><a href="#6-å¯åŠ¨-order-é¡¹ç›®" class="headerlink" title="6. å¯åŠ¨ order é¡¹ç›®"></a>6. å¯åŠ¨ order é¡¹ç›®</h1><ol><li>ä¿®æ”¹é¡¹ç›®ä¸‹ <code>jdbc.properties</code> æ–‡ä»¶ï¼Œ<strong>å¡«å†™æˆä½ çš„æ•°æ®åº“åœ°å€</strong>ã€‚</li><li>ä½¿ç”¨ IDEA é…ç½® Tomcat è¿›è¡Œå¯åŠ¨ã€‚</li><li>è®¿é—® <code>http://127.0.0.1:8080/</code>ï¼Œçœ‹åˆ° â€œsample è¯´æ˜â€¦â€ï¼Œä»£è¡¨é¡¹ç›®å¯åŠ¨å®Œæˆã€‚<strong><code>8080</code> ä¸ºä½ å¡«å†™çš„ Tomcat ç«¯å£</strong>ã€‚</li><li>ç‚¹å‡» [å•†å“åˆ—è¡¨é“¾æ¥] -&gt; [è´­ä¹°] -&gt; [æ”¯ä»˜]ï¼Œå¦‚æœçœ‹åˆ° â€œæ”¯ä»˜æˆåŠŸâ€ æˆ–è€… â€œæ”¯ä»˜å¤±è´¥â€ï¼Œæ­å–œä½ ğŸ‰ï¼Œä½ å·²ç»æˆåŠŸæ­å»ºå®Œä½ çš„è°ƒè¯•ç¯å¢ƒã€‚æ„‰å¿«çš„å¼€å§‹ç©è€æŠŠã€‚</li></ol><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>è°ƒè¯•ç¯å¢ƒæ­å»ºæ˜¯é˜…è¯»æºç çš„ç¬¬ä¸€æ­¥ï¼Œå¦‚æœä½ ç¢°åˆ°æ— æ³•æ­å»ºæˆåŠŸçš„æƒ…å†µï¼Œè¯·ç»™ç¬”è€…å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> )ç•™è¨€ã€‚ç¬”è€…ä¼šç»™ä½  1:1 çš„é«˜çº§( <strong>æåŸº</strong> )æ”¯æŒã€‚</p><p>å¦å¤–è¿™æ˜¯ä¸€ä¸ªç³»åˆ—æ–‡ï¼Œæœ¬ç³»åˆ—æ›´æ–° TCC-Transaction ï¼Œä¸‹ä¸€ä¸ªç³»åˆ—æ›´æ–° ByteTCC ã€‚å—¨çš®ä¸ï¼Ÿï¼</p><p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_02_01/01.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;
      
    
    </summary>
    
      <category term="TCC-Transaction" scheme="http://www.iocoder.cn/categories/TCC-Transaction/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” é«˜å¯ç”¨</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-high-availability/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-high-availability/</id>
    <published>2018-01-14T16:00:00.000Z</published>
    <updated>2017-09-16T04:31:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. Scheduler é›†ç¾¤</a></li><li><a href="#">3. Scheduler éƒ¨ç½²</a></li><li><a href="#">4. Scheduler æ•…éšœè½¬ç§»</a></li><li><a href="#">5. Scheduler æ•°æ®å­˜å‚¨</a><ul><li><a href="#">5.1 RunningService</a></li><li><a href="#">5.2 ProducerManager</a></li><li><a href="#">5.3 TaskScheduler</a></li></ul></li><li><a href="#">6. Mesos Master å´©æºƒ</a></li><li><a href="#">7. Mesos Slave å´©æºƒ</a></li><li><a href="#">8. Scheduler æ ¸å¯¹</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud é«˜å¯ç”¨</strong>ã€‚</p><p>ä¸€ä¸ªé«˜å¯ç”¨çš„ Elastic-Job-Cloud ç»„æˆå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/01.png" alt=""></p><ul><li>Mesos Master é›†ç¾¤</li><li>Mesos Slave é›†ç¾¤</li><li>Zookeeper é›†ç¾¤</li><li>Elastic-Job-Cloud-Scheduler é›†ç¾¤</li><li>Elastic-Job-Cloud-Executor é›†ç¾¤</li></ul><p><strong>æœ¬æ–‡é‡ç‚¹åˆ†äº« Elastic-Job-Cloud-Scheduler å¦‚ä½•å®ç°é«˜å¯ç”¨ã€‚</strong></p><p>Mesos Master / Mesos Slave / Zookeeper é«˜å¯ç”¨ï¼ŒåŒå­¦ä»¬å¯ä»¥è‡ªè¡Œ Google è§£å†³ã€‚Elastic-Job-Cloud-Executor è¿è¡Œåœ¨ Mesos Slave ä¸Šï¼Œé€šè¿‡ Mesos Slave é›†ç¾¤å¤šèŠ‚ç‚¹å®ç°é«˜å¯ç”¨ã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1 id="2-Scheduler-é›†ç¾¤"><a href="#2-Scheduler-é›†ç¾¤" class="headerlink" title="2. Scheduler é›†ç¾¤"></a>2. Scheduler é›†ç¾¤</h1><p>Elastic-Job-Cloud-Scheduler é€šè¿‡è‡³å°‘ä¸¤ä¸ªèŠ‚ç‚¹å®ç°é›†ç¾¤ã€‚<strong>é›†ç¾¤ä¸­é€šè¿‡ä¸»èŠ‚ç‚¹é€‰ä¸¾ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œåªæœ‰ä¸»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œä»å®ä¾‹å¤„äºâ€å¾…å‘½â€çŠ¶æ€ã€‚å½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä»èŠ‚ç‚¹ä¼šé€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ç»§ç»­æä¾›æœåŠ¡ã€‚</strong>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="comment">// åˆå§‹åŒ– æ³¨å†Œä¸­å¿ƒ</span></div><div class="line">        CoordinatorRegistryCenter regCenter = <span class="keyword">new</span> ZookeeperRegistryCenter(BootstrapEnvironment.getInstance().getZookeeperConfiguration());</div><div class="line">        regCenter.init();</div><div class="line">        <span class="comment">// åˆå§‹åŒ– Zookeeper é€‰ä¸¾æœåŠ¡</span></div><div class="line">        <span class="keyword">final</span> ZookeeperElectionService electionService = <span class="keyword">new</span> ZookeeperElectionService(</div><div class="line">                BootstrapEnvironment.getInstance().getFrameworkHostPort(), (CuratorFramework) regCenter.getRawClient(), HANode.ELECTION_NODE, <span class="keyword">new</span> SchedulerElectionCandidate(regCenter));</div><div class="line">        electionService.start();</div><div class="line">        <span class="comment">// æŒ‚èµ· ä¸»è¿›ç¨‹</span></div><div class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        latch.await();</div><div class="line">        <span class="comment">// Hook è²Œä¼¼ä½ç½®ä¸å¯¹ï¼Ÿ</span></div><div class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="string">"shutdown-hook"</span>) &#123;</div><div class="line">        </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                electionService.stop();</div><div class="line">                latch.countDown();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>Bootstrapï¼ŒElastic-Job-Cloud-Scheduler å¯åŠ¨å™¨ï¼ˆä»¿ä½›åœ¨è¯´åºŸè¯ï¼‰ã€‚</li><li>CoordinatorRegistryCenterï¼Œç”¨äºåè°ƒåˆ†å¸ƒå¼æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/reg-center-zookeeper/?">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>ZookeeperElectionServiceï¼ŒZookeeper é€‰ä¸¾æœåŠ¡ï¼Œæœ¬å°èŠ‚çš„ä¸»è§’ã€‚</li><li>ShutdownHook å…³é—­è¿›ç¨‹é’©å­ï¼Œä»£ç æ”¾ç½®çš„ä½ç½®ä¸å¯¹ï¼Œéœ€è¦æ”¾åœ¨ <code>CountDownLatch#await()</code> æ–¹æ³•ä¸Šé¢ã€‚ç›®å‰å®é™…ä¸å½±å“ä½¿ç”¨ã€‚</li></ul><p>è°ƒç”¨ <code>ZookeeperElectionService#start()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Zookeeper é€‰ä¸¾æœåŠ¡ä»¥å®ç° Elastic-Job-Cloud-Scheduler ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch leaderLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">    </div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LeaderSelector leaderSelector;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZookeeperElectionService</span><span class="params">(<span class="keyword">final</span> String identity, <span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> String electionPath, <span class="keyword">final</span> ElectionCandidate electionCandidate)</span> </span>&#123;</div><div class="line">   <span class="comment">// åˆ›å»º LeaderSelector</span></div><div class="line">   leaderSelector = <span class="keyword">new</span> LeaderSelector(client, electionPath, <span class="keyword">new</span> LeaderSelectorListenerAdapter() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(<span class="keyword">final</span> CuratorFramework client)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">           <span class="comment">// ... çœç•¥ã€æš‚æ—¶ã€‘æ— å…³ä»£ç </span></div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// è®¾ç½®é‡å¤å‚ä¸é€‰ä¸¾ä¸»èŠ‚ç‚¹</span></div><div class="line">   leaderSelector.autoRequeue();</div><div class="line">   <span class="comment">// è®¾ç½®å‚ä¸èŠ‚ç‚¹çš„ç¼–å·</span></div><div class="line">   leaderSelector.setId(identity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å¼€å§‹é€‰ä¸¾.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   log.debug(<span class="string">"Elastic job: &#123;&#125; start to elect leadership"</span>, leaderSelector.getId());</div><div class="line">   leaderSelector.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>é€šè¿‡ <a href="https://curator.apache.org/apidocs/org/apache/curator/framework/recipes/leader/LeaderSelector.html" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator LeaderSelector</a> å®ç°åˆ†å¸ƒå¼å¤šèŠ‚ç‚¹é€‰ä¸¾ã€‚</p><blockquote><p>FROM <a href="https://curator.apache.org/apidocs/org/apache/curator/framework/recipes/leader/LeaderSelector.html" rel="external nofollow noopener noreferrer" target="_blank">https://curator.apache.org/apidocs/org/apache/curator/framework/recipes/leader/LeaderSelector.html</a><br>Abstraction to select a â€œleaderâ€ amongst multiple contenders in a group of JMVs connected to a Zookeeper cluster. If a group of N thread/processes contends for leadership, one will be assigned leader until it releases leadership at which time another one from the group will be chosen.<br>Note that this class uses an underlying InterProcessMutex and as a result leader election is â€œfairâ€ - each user will become leader in the order originally requested (from ZKâ€™s point of view).</p></blockquote></li><li><p>è°ƒç”¨ <code>LeaderSelector#autoRequeue()</code> æ–¹æ³•ï¼Œè®¾ç½®é‡å¤å‚ä¸é€‰ä¸¾ä¸»èŠ‚ç‚¹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªå·±é€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹åï¼Œä¸å†å‚ä¸ä¸‹æ¬¡é€‰ä¸¾ã€‚è®¾ç½®é‡å¤å‚ä¸é€‰ä¸¾ä¸»èŠ‚ç‚¹åï¼Œæ¯æ¬¡é€‰ä¸¾éƒ½ä¼šå‚ä¸ã€‚åœ¨ Elastic-Job-Cloud-Scheduler é‡Œï¼Œæˆ‘ä»¬æ˜¾ç„¶è¦é‡å¤å‚ä¸é€‰ä¸¾ã€‚</p></li><li>è°ƒç”¨ <code>LeaderSelector#setId()</code> æ–¹æ³•ï¼Œè®¾ç½®å‚ä¸èŠ‚ç‚¹çš„ç¼–å·ã€‚åœ¨ Elastic-Job-Cloud-Scheduler é‡Œæš‚æ—¶æ²¡æœ‰å®é™…ç”¨é€”ã€‚ç¼–å·ç®—æ³•ä¸º <code>BootstrapEnvironment.getInstance().getFrameworkHostPort()</code>ï¼Œå³ï¼š<code>HOST:PORT</code>ã€‚</li><li>è°ƒç”¨ <code>#start()</code> æ–¹æ³•ï¼Œå¼€å§‹é€‰ä¸¾ã€‚<strong>å½“è‡ªå·±é€‰ä¸¾ä¸»èŠ‚ç‚¹æˆåŠŸ</strong>ï¼Œå›è°ƒ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ã€‚</li></ul><p>å›è°ƒ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ï¼ŒElastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹å¼€å§‹é¢†å¯¼çŠ¶æ€</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZookeeperElectionService.LeaderSelector å†…éƒ¨å®ç°ç±»</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(<span class="keyword">final</span> CuratorFramework client)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    log.info(<span class="string">"Elastic job: &#123;&#125; has leadership"</span>, identity);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// å¼€å§‹é¢†å¯¼çŠ¶æ€</span></div><div class="line">        electionCandidate.startLeadership();</div><div class="line">        <span class="comment">// æŒ‚èµ· è¿›ç¨‹</span></div><div class="line">        leaderLatch.await();</div><div class="line">        log.warn(<span class="string">"Elastic job: &#123;&#125; lost leadership."</span>, identity);</div><div class="line">        <span class="comment">// ç»ˆæ­¢é¢†å¯¼çŠ¶æ€</span></div><div class="line">        electionCandidate.stopLeadership();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JobSystemException exception) &#123;</div><div class="line">        <span class="comment">// å¼‚å¸¸é€€å‡º</span></div><div class="line">        log.error(<span class="string">"Elastic job: Starting error"</span>, exception);</div><div class="line">        System.exit(<span class="number">1</span>);  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>SchedulerElectionCandidate#startLeadership()</code> æ–¹æ³•ï¼Œå¼€å§‹é¢†å¯¼çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerElectionCandidate.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerElectionCandidate</span> <span class="keyword">implements</span> <span class="title">ElectionCandidate</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> SchedulerService schedulerService;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SchedulerElectionCandidate</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regCenter = regCenter;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startLeadership</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            schedulerService = <span class="keyword">new</span> SchedulerService(regCenter);</div><div class="line">            schedulerService.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable throwable) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(throwable);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼å¯åŠ¨.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   facadeService.start();</div><div class="line">   producerManager.startup();</div><div class="line">   statisticManager.startup();</div><div class="line">   cloudJobConfigurationListener.start();</div><div class="line">   taskLaunchScheduledService.startAsync();</div><div class="line">   restfulService.start();</div><div class="line">   schedulerDriver.start();</div><div class="line">   <span class="keyword">if</span> (env.getFrameworkConfiguration().isEnabledReconcile()) &#123;</div><div class="line">       reconcileService.startAsync();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>è°ƒç”¨ <code>SchedulerService#start()</code> æ–¹æ³•åï¼Œå„ç§æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼Œç‰¹åˆ«æ˜¯å’Œ Mesos Master çš„è¿æ¥ï¼Œå¯ä»¥æ„‰å¿«çš„è¿›è¡Œä½œä¸šè°ƒåº¦ç­‰ç­‰æœåŠ¡ã€‚</li><li>Elastic-Job-Cloud-Scheduler <strong>ä»èŠ‚ç‚¹</strong>ï¼Œå› ä¸ºæ— æ³•å›è°ƒ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ï¼Œå¤„äºâ€å¾…å‘½â€çŠ¶æ€ã€‚å½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä»èŠ‚ç‚¹ä¼šé€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè§¦å‘ <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•å›è°ƒï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>CountLatch#await()</code> æ–¹æ³•ï¼ŒæŒ‚èµ·<strong>ä¸»èŠ‚ç‚¹</strong> <code>LeaderSelector#takeLeadership()</code> æ–¹æ³•ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚ä¸ºä»€ä¹ˆè¦è¿›è¡ŒæŒ‚èµ·ï¼Ÿå¦‚æœè°ƒç”¨å®Œè¯¥æ–¹æ³•ï¼Œ<strong>ä¸»èŠ‚ç‚¹</strong>å°±ä¼šè®©å‡º<strong>ä¸»èŠ‚ç‚¹</strong>èº«ä»½ï¼Œè¿™æ ·ä¼šå¯¼è‡´ Elastic-Job-Cloud-Scheduler é›†ç¾¤ä¸æ–­ä¸æ–­ä¸æ–­æ›´æ–°ä¸»èŠ‚ç‚¹ï¼Œæ— æ³•æ­£å¸¸æä¾›æœåŠ¡ã€‚</p></li><li><p>å½“ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>å…³é—­æ—¶ï¼Œè§¦å‘ä¸Šæ–‡ä»£ç çœ‹åˆ°çš„ ShutdownHook ï¼Œå…³é—­æœåŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Bootstrap.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="string">"shutdown-hook"</span>) &#123;</div><div class="line">        </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">// åœæ­¢é€‰ä¸¾</span></div><div class="line">                electionService.stop();</div><div class="line">                latch.countDown();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>ElectionService#stop()</code> æ–¹æ³•ï¼Œåœæ­¢é€‰ä¸¾ï¼Œä»è€Œç»ˆæ­¢é¢†å¯¼çŠ¶æ€ï¼Œå…³é—­å„ç§æœåŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ZookeeperElectionService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">    log.info(<span class="string">"Elastic job: stop leadership election"</span>);</div><div class="line">    <span class="comment">// ç»“æŸ #takeLeadership() æ–¹æ³•çš„è¿›ç¨‹æŒ‚èµ·</span></div><div class="line">    leaderLatch.countDown();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// å…³é—­ LeaderSelector</span></div><div class="line">        leaderSelector.close();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ignored) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerElectionCandidate.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopLeadership</span><span class="params">()</span> </span>&#123;</div><div class="line">    schedulerService.stop();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * åœæ­¢è¿è¡Œ.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">    restfulService.stop();</div><div class="line">    taskLaunchScheduledService.stopAsync();</div><div class="line">    cloudJobConfigurationListener.stop();</div><div class="line">    statisticManager.shutdown();</div><div class="line">    producerManager.shutdown();</div><div class="line">    schedulerDriver.stop(<span class="keyword">true</span>);</div><div class="line">    facadeService.stop();</div><div class="line">    <span class="keyword">if</span> (env.getFrameworkConfiguration().isEnabledReconcile()) &#123;</div><div class="line">        reconcileService.stopAsync();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li><li><p>å½“å‘ç”Ÿ JobSystemException å¼‚å¸¸æ—¶ï¼Œå³è°ƒç”¨ <code>SchedulerElectionCandidate#startLeadership()</code> æ–¹æ³•å‘ç”Ÿå¼‚å¸¸( <code>SchedulerElectionCandidate#stopLeadership()</code> å®é™…ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ )ï¼Œè°ƒç”¨ <code>System.exit(1)</code> æ–¹æ³•ï¼ŒElastic-Job-Cloud-Scheduler ä¸»èŠ‚ç‚¹<strong>å¼‚å¸¸å´©æºƒ</strong>ã€‚</p><ul><li>ç›®å‰çŒœæµ‹<strong>å¯èƒ½</strong>æœ‰ç§æƒ…å†µä¼šå¯¼è‡´å¼‚å¸¸å´©æºƒã€‚ï¼ˆ1ï¼‰ä¸€ä¸ª Elastic-Job-Cloud-Scheduler é›†ç¾¤æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ A / Bï¼Œé€šè¿‡é€‰ä¸¾ A æˆä¸ºä¸»èŠ‚ç‚¹ï¼›ï¼ˆ2ï¼‰çªç„¶ Zookeeper é›†ç¾¤å´©æºƒï¼Œæ¢å¤åï¼ŒA èŠ‚ç‚¹é€‰ä¸¾<strong>æ°å¥½</strong>åˆæˆä¸ºä¸»èŠ‚ç‚¹ï¼Œå› ä¸ºæœªè°ƒç”¨ <code>SchedulerElectionCandidate#stopLeadership()</code> å…³é—­åŸæ¥çš„å„ç§æœåŠ¡ï¼Œå¯¼è‡´<strong>å†æ¬¡</strong>è°ƒç”¨ <code>SchedulerElectionCandidate#startLeadership()</code> ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œä¾‹å¦‚è¯´ RestfulService æœåŠ¡ï¼Œéœ€è¦å ç”¨ä¸€ä¸ªç«¯å£æä¾›æœåŠ¡ï¼Œé‡æ–°åˆå§‹åŒ–ï¼Œä¼šå‘ç”Ÿç«¯å£å†²çªæŠ›å‡ºå¼‚å¸¸ã€‚ç¬”è€…å°è¯•æ¨¡æ‹Ÿï¼Œé€šè¿‡ä¸€ä¸ª Elastic-Job-Cloud-Scheduler + Zookeeper çš„æƒ…å†µï¼Œèƒ½å¤Ÿè§¦å‘è¯¥æƒ…å†µï¼Œæ­¥éª¤å¦‚ä¸‹ï¼šï¼ˆ1ï¼‰Zookeeper å¯åŠ¨ï¼›ï¼ˆ2ï¼‰Elastic-Job-Cloud-Scheduler å¯åŠ¨ï¼Œé€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œæ­£å¸¸åˆå§‹åŒ–ï¼›ï¼ˆ3ï¼‰é‡å¯ Zookeeperï¼›ï¼ˆ4ï¼‰Elastic-Job-Cloud-Scheduler å†æ¬¡é€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œå› ä¸º RestfulService ç«¯å£å†²çªå¼‚å¸¸åˆå§‹åŒ–å´©æºƒã€‚<strong>å¦‚æœçœŸå‡ºç°è¿™ç§æƒ…å†µæ€ä¹ˆåŠå‘¢ï¼Ÿ</strong>åœ¨ã€Œ3. Scheduler éƒ¨ç½²ã€æ­æ™“ç­”æ¡ˆã€‚</li></ul></li></ul><p>Elastic-Job-Lite åœ¨ä¸»èŠ‚ç‚¹é€‰ä¸¾å®ç°æ–¹å¼ä¸Šç•¥æœ‰ä¸åŒï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹<a href="http://www.iocoder.cn/Elastic-Job/election/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€‹</a>çš„å®ç°ã€‚</p><h1 id="3-Scheduler-éƒ¨ç½²"><a href="#3-Scheduler-éƒ¨ç½²" class="headerlink" title="3. Scheduler éƒ¨ç½²"></a>3. Scheduler éƒ¨ç½²</h1><p>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ–¹å¼ï¼Œé€‰æ‹©å¤šå°ä¸»æœºéƒ¨ç½² Elastic-Job-Cloud-Executor å¤šä¸ªèŠ‚ç‚¹ã€‚</p><p>Butâ€¦â€¦ æˆ‘ä»¬è¦æƒ³ä¸‹ï¼ŒElastic-Job-Cloud-Executor è¿è¡Œåœ¨ Mesos ä¹‹ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ä¸Š Mesos çš„èµ„æºè°ƒåº¦å’Œéƒ¨ç½²æœåŠ¡ã€‚å¼•å…¥ Mesos ä¸Šè‘—åçš„æ¡†æ¶ <a href="https://mesosphere.github.io/marathon/" rel="external nofollow noopener noreferrer" target="_blank">Marathon</a>ã€‚å®ƒå¯ä»¥å¸¦æ¥<strong>æ‰€æœ‰åå°è¿›ç¨‹( ä¾‹å¦‚ï¼ŒElastic-Job-Cloud-Executor )èƒ½å¤Ÿè¿è¡Œåœ¨ä»»æ„æœºå™¨ä¸Šï¼ŒMarathon ä¼šåœ¨åå°å·²æœ‰å®ä¾‹å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å¯åŠ¨æ–°å®ä¾‹</strong>çš„å¥½å¤„ã€‚æ˜¯ä¸æ˜¯å¾ˆèµ +1024 ï¼Ÿï¼</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P47<br>Mesos é›†ç¾¤é‡Œçš„å¸¸è§æ–¹æ¡ˆæ˜¯åœ¨ Marathon ä¸Šè¿è¡Œé›†ç¾¤çš„ Mesos æ¡†æ¶ã€‚ä½†æ˜¯ Marathon æœ¬èº«å°±æ˜¯ä¸€ç§ Mesos çš„æ¡†æ¶ï¼é‚£ä¹ˆåœ¨ Marathon ä¸Šè¿è¡Œ Mesos æ¡†æ¶æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿä¸ç”¨è€ƒè™‘å¦‚ä½•å°†æ¯ç§æ¡†æ¶çš„è°ƒåº¦å™¨éƒ¨ç½²åˆ°ç‰¹å®šçš„ä¸»æœºä¸Šå¹¶ä¸”å¤„ç†è¿™äº›ä¸»æœºçš„æ•…éšœï¼ŒMarathon èƒ½å¤Ÿç¡®ä¿æ¡†æ¶çš„è°ƒåº¦å™¨æ€»æ˜¯åœ¨é›†ç¾¤é‡Œçš„æŸå¤„è¿è¡Œç€ã€‚è¿™æ ·å¤§å¹…ç®€åŒ–äº†åœ¨é«˜å¯ç”¨é…ç½®é‡Œéƒ¨ç½²æ–°æ¡†æ¶çš„å¤æ‚åº¦ã€‚</p></blockquote><p>å—¯â€¦â€¦ å½“ç„¶ï¼ŒMarathon æˆ‘ä»¬ä¹Ÿè¦åšé«˜å¯ç”¨ã€‚</p><p>ğŸ˜ˆ Marathon åŸæ¥ä¸­æ–‡æ˜¯é©¬æ‹‰æ¾ã€‚å“ˆå“ˆå“ˆï¼Œå¾ˆé€‚åˆçš„åå­—ã€‚</p><h1 id="4-Scheduler-æ•…éšœè½¬ç§»"><a href="#4-Scheduler-æ•…éšœè½¬ç§»" class="headerlink" title="4. Scheduler æ•…éšœè½¬ç§»"></a>4. Scheduler æ•…éšœè½¬ç§»</h1><p>å½“åŸæœ‰ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>å´©æºƒæ—¶ï¼Œ<strong>ä»èŠ‚ç‚¹</strong>é‡æ–°è¿›è¡Œä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼Œå®Œæˆæ•…éšœè½¬ç§»ã€‚é‚£ä¹ˆæ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ–°<strong>ä¸»èŠ‚ç‚¹</strong>å¦‚ä½•æ¥ç®¡å·²ç»åœ¨æ‰§è¡Œä¸­çš„ Elastic-Job-Cloud-Executer ä»¬å‘¢ï¼Ÿ</p><p>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå…³é—­åŸæœ‰çš„æ‰€æœ‰ Elastic-Job-Cloud-Executor ä»¬ï¼Œç„¶åé‡æ–°è°ƒåº¦å¯åŠ¨ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸ªæ–¹å¼å¤ªè¿‡æš´åŠ›ã€‚å¦‚æœæœ‰äº›ä½œä¸šä»»åŠ¡è¿è¡Œæ—¶é—´è¾ƒé•¿ï¼Œç›´æ¥ä¸­æ–­ä¸æ˜¯å¾ˆå‹å¥½ã€‚å†æ¯”å¦‚ï¼ŒElastic-Job-Cloud-Scheduler èŠ‚ç‚¹éœ€è¦è¿›è¡Œå‡çº§ï¼Œä¹Ÿå…³é—­ Elastic-Job-Cloud-Executorï¼Œä¹Ÿä¸åˆç†ï¼Œå’Œä½¿ç”¨é«˜å¯ç”¨æ€§é›†ç¾¤æ“ä½œç³»ç»Ÿçš„åˆè¡·æ˜¯èƒŒç¦»çš„ã€‚<strong>è¯¥æ–¹æ¡ˆï¼Œä¸æ¨è</strong>ã€‚</p><p>ç¬¬äºŒç§æ–¹æ¡ˆï¼Œé‡ç”¨<strong>åŸä¸»èŠ‚ç‚¹</strong>çš„ Mesos <strong>FrameworkID</strong>ã€‚åŸç†å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P72<br>åœ¨ Mesos é‡Œï¼Œè°ƒåº¦å™¨ç”±å…¶ FrameworkIDã€FrameworkInfo é‡Œçš„å¯é€‰å€¼å”¯ä¸€ç¡®å®šã€‚FrameworkID å¿…é¡»ç”± Mesos åˆ†é…ï¼Œä»è€Œç¡®ä¿å¯¹äºæ¯ä¸ªæ¡†æ¶æ¥è¯´è¯¥å€¼æ˜¯å”¯ä¸€ç¡®å®šçš„ã€‚ç°åœ¨ï¼Œéœ€è¦åœ¨åˆ†é… FrameworkID æ—¶å­˜å‚¨è¯¥å€¼ï¼Œè¿™æ ·æœªæ¥çš„ä¸»å®ä¾‹æ‰å¯ä»¥é‡ç”¨è¯¥å€¼ã€‚   </p></blockquote><p>åœ¨ Elastic-Job-Cloud-Scheduler ä½¿ç”¨æ³¨å†Œä¸­å¿ƒ( Zookeeper ) çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/ha/framework_id</code> å­˜å‚¨ FrameworkIDï¼Œå­˜å‚¨å€¼ä¸º <code>${FRAMEWORK_ID}</code>ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><blockquote><p>[zk: localhost:2181(CONNECTED) 1] get /elastic-job-cloud/ha/framework_id<br>d31e7faa-aa72-4d0a-8941-512984d5af49-0001</p></blockquote><p>è°ƒç”¨ <code>SchedulerService#getSchedulerDriver()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Mesos Scheduler Driver æ—¶ï¼Œä» Zookeeper è·å–æ˜¯å¦å·²ç»å­˜åœ¨ FrameworkIDã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">   <span class="comment">// è·å– FrameworkID</span></div><div class="line">   Optional&lt;String&gt; frameworkIDOptional = frameworkIDService.fetch();</div><div class="line">   Protos.FrameworkInfo.Builder builder = Protos.FrameworkInfo.newBuilder();</div><div class="line">   <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œè®¾ç½® FrameworkID</span></div><div class="line">   <span class="keyword">if</span> (frameworkIDOptional.isPresent()) &#123;</div><div class="line">       builder.setId(Protos.FrameworkID.newBuilder().setValue(frameworkIDOptional.get()).build());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">   Protos.FrameworkInfo frameworkInfo = builder.setUser(mesosConfig.getUser()).setName(frameworkName)</div><div class="line">                .setHostname(mesosConfig.getHostname())</div><div class="line">                .setFailoverTimeout(FRAMEWORK_FAILOVER_TIMEOUT_SECONDS)</div><div class="line">                .setWebuiUrl(WEB_UI_PROTOCOL + env.getFrameworkHostPort()).setCheckpoint(<span class="keyword">true</span>).build();</div><div class="line">   <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FrameworkIDService#fetch()</code> æ–¹æ³•ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å– FrameworkID ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Optional&lt;String&gt; <span class="title">fetch</span><span class="params">()</span> </span>&#123;</div><div class="line">   String frameworkId = regCenter.getDirectly(HANode.FRAMEWORK_ID_NODE);</div><div class="line">   <span class="keyword">return</span> Strings.isNullOrEmpty(frameworkId) ? Optional.&lt;String&gt;absent() : Optional.of(frameworkId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>Protos.FrameworkInfo.Builder#setId(...)</code> æ–¹æ³•ï¼Œå½“ FrameworkID å­˜åœ¨æ—¶ï¼Œè®¾ç½® FrameworkIDã€‚</p></li><li>è°ƒç”¨ <code>Protos.FrameworkInfo.Builder#setFailoverTimeout(...)</code> æ–¹æ³•ï¼Œè®¾ç½® Scheduler æœ€å¤§æ•…éšœè½¬ç§»æ—¶é—´ï¼Œå³ FrameworkID è¿‡æœŸæ—¶é—´ã€‚Elastic-Job-Cloud-Scheduler é»˜è®¤è®¾ç½®ä¸€å‘¨ã€‚</li></ul><p>å½“ Elastic-Job-Cloud-Scheduler é›†ç¾¤ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Œä¸Šé¢çš„é€»è¾‘æ˜¾ç„¶è·å–ä¸åˆ° FrameworkIDï¼Œåœ¨å‘ Mesos Master åˆå§‹åŒ–æˆåŠŸåï¼Œå›è°ƒ <code>SchedulerEngine#registered(...)</code> æ–¹æ³•è¿›è¡Œä¿å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerEngine.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.FrameworkID frameworkID, <span class="keyword">final</span> Protos.MasterInfo masterInfo)</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"call registered"</span>);</div><div class="line">        <span class="comment">// ä¿å­˜FrameworkID</span></div><div class="line">        frameworkIDService.save(frameworkID.getValue());</div><div class="line">        <span class="comment">// è¿‡æœŸ TaskScheduler Lease</span></div><div class="line">        taskScheduler.expireAllLeases();</div><div class="line">        <span class="comment">// æ³¨å†Œ Mesos Master ä¿¡æ¯</span></div><div class="line">        MesosStateService.register(masterInfo.getHostname(), masterInfo.getPort());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FrameworkIDService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(HANode.FRAMEWORK_ID_NODE)) &#123; <span class="comment">// ä¸å­˜åœ¨æ‰ä¿å­˜</span></div><div class="line">       regCenter.persist(HANode.FRAMEWORK_ID_NODE, id);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="5-Scheduler-æ•°æ®å­˜å‚¨"><a href="#5-Scheduler-æ•°æ®å­˜å‚¨" class="headerlink" title="5. Scheduler æ•°æ®å­˜å‚¨"></a>5. Scheduler æ•°æ®å­˜å‚¨</h1><p>æ–°çš„ Elastic-Job-Cloud-Scheduler <strong>ä¸»èŠ‚ç‚¹</strong>åœ¨æ•…éšœè½¬ç§»ï¼Œä¸ä»…ä»…æ¥ç®¡ Elastic-Job-Cloud-Executorï¼Œ<strong>è¿˜éœ€è¦æ¥ç®¡æ•°æ®å­˜å‚¨</strong>ã€‚</p><p>Elastic-Job-Cloud-Executor ä½¿ç”¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )å­˜å‚¨æ•°æ®ã€‚æ•°æ®å­˜å‚¨åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p><ul><li>configï¼Œäº‘ä½œä¸šåº”ç”¨é…ç½®ã€äº‘ä½œä¸šé…ç½®ã€‚</li><li>stateï¼Œä½œä¸šçŠ¶æ€ä¿¡æ¯ã€‚</li></ul><p>æ•´ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/02.png" alt=""></p><p>Elastic-Job-Cloud-Scheduler <strong>å„ä¸ªæœåŠ¡</strong>æ ¹æ®æ•°æ®å­˜å‚¨å¯åŠ¨åˆå§‹åŒ–ã€‚ä¸‹é¢æ¥çœ‹çœ‹ä¾èµ–æ•°æ®å­˜å‚¨è¿›è¡Œåˆå§‹åŒ–çš„æœåŠ¡ä»£ç å®ç°ã€‚</p><h2 id="5-1-RunningService"><a href="#5-1-RunningService" class="headerlink" title="5.1 RunningService"></a>5.1 RunningService</h2><p>RunningServiceï¼Œä»»åŠ¡è¿è¡Œæ—¶æœåŠ¡ã€‚è°ƒç”¨ <code>RunningService#start()</code> æ–¹æ³•ï¼Œå¯åŠ¨ä»»åŠ¡è¿è¡Œé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¿è¡Œä¸­ä½œä¸šæ˜ å°„</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šåç§°</span></div><div class="line"><span class="comment">     * valueï¼šä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Getter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Set&lt;TaskContext&gt;&gt; RUNNING_TASKS = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(TASK_INITIAL_SIZE);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        clear();</div><div class="line">        List&lt;String&gt; jobKeys = regCenter.getChildrenKeys(RunningNode.ROOT);</div><div class="line">        <span class="keyword">for</span> (String each : jobKeys) &#123;</div><div class="line">            <span class="comment">// ä»è¿è¡Œä¸­é˜Ÿåˆ—ç§»é™¤ä¸å­˜åœ¨é…ç½®çš„ä½œä¸šä»»åŠ¡</span></div><div class="line">            <span class="keyword">if</span> (!configurationService.load(each).isPresent()) &#123;</div><div class="line">                remove(each);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// æ·»åŠ  è¿è¡Œä¸­ä½œä¸šæ˜ å°„</span></div><div class="line">            RUNNING_TASKS.put(each, Sets.newCopyOnWriteArraySet(Lists.transform(regCenter.getChildrenKeys(RunningNode.getRunningJobNodePath(each)), <span class="keyword">new</span> Function&lt;String, TaskContext&gt;() &#123;</div><div class="line">                </div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> TaskContext <span class="title">apply</span><span class="params">(<span class="keyword">final</span> String input)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> TaskContext.from(regCenter.get(RunningNode.getRunningTaskNodePath(TaskContext.MetaInfo.from(input).toString())));</div><div class="line">                &#125;</div><div class="line">            &#125;)));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å› ä¸ºè¿è¡Œä¸­ä½œä¸šæ˜ å°„( <code>RUNNING_TASKS</code> )ä½¿ç”¨çš„é¢‘æ¬¡å¾ˆå¤šï¼ŒElastic-Job-Cloud-Scheduler ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚æ¯æ¬¡åˆå§‹åŒ–æ—¶ï¼Œä½¿ç”¨ä»æ•°æ®å­˜å‚¨<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>åŠ è½½åˆ°å†…å­˜ã€‚</li><li><p>è¿™é‡Œæˆ‘ä»¬åœ¨çœ‹ä¸‹<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>çš„æ·»åŠ ( <code>#add()</code> )æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!configurationService.load(taskContext.getMetaInfo().getJobName()).isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).add(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemon(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­é˜Ÿåˆ—</span></div><div class="line">   String runningTaskNodePath = RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(runningTaskNodePath)) &#123;</div><div class="line">       regCenter.persist(runningTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—åªå­˜å‚¨å¸¸é©»ä½œä¸šçš„ä»»åŠ¡</strong>ã€‚æ‰€ä»¥<strong>ç¬æ—¶</strong>ä½œä¸šï¼Œåœ¨æ•…éšœè½¬ç§»æ—¶ï¼Œå¯èƒ½å­˜åœ¨ç›¸åŒä½œä¸šç›¸åŒåˆ†ç‰‡ä»»åŠ¡<strong>åŒæ—¶</strong>è°ƒåº¦æ‰§è¡Œã€‚ä¸¾ä¸ªæ —å­ğŸŒ°ï¼ŒElastic-Job-Cloud-Scheduler é›†ç¾¤æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ A( ä¸»èŠ‚ç‚¹ ) / B( ä»èŠ‚ç‚¹ )ï¼Œï¼ˆ1ï¼‰A èŠ‚ç‚¹æ¯ 5 åˆ†é’Ÿè°ƒåº¦ä¸€æ¬¡ç¬æ—¶ä½œä¸šä»»åŠ¡ T ï¼ŒT æ¯æ¬¡æ‰§è¡Œæ¶ˆè€—æ—¶é—´å®é™…è¶…è¿‡ 5 åˆ†é’Ÿ( å…ˆä¸è¦è€ƒè™‘æ˜¯å¦åˆç† )ã€‚ï¼ˆ2ï¼‰A èŠ‚ç‚¹å´©æºƒï¼ŒB èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œ5 åˆ†é’Ÿåè°ƒåº¦ T ä½œä¸šï¼Œå› ä¸º<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—åªå­˜å‚¨å¸¸é©»ä½œä¸šçš„ä»»åŠ¡</strong>ï¼Œæ¢å¤åçš„ <code>RUNNING_TASKS</code> ä¸å­˜åœ¨è¯¥ä½œä¸šä»»åŠ¡ï¼Œå› æ­¤å¯ä»¥è°ƒåº¦ T ä½œä¸šï¼Œå®é™… T ä½œä¸šæ­£åœ¨ Elastic-Job-Cloud-Executor æ‰§è¡Œä¸­ã€‚</li></ul></li></ul><h2 id="5-2-ProducerManager"><a href="#5-2-ProducerManager" class="headerlink" title="5.2 ProducerManager"></a>5.2 ProducerManager</h2><p>ProducerManagerï¼Œå‘å¸ƒä»»åŠ¡ä½œä¸šè°ƒåº¦ç®¡ç†å™¨ã€‚è°ƒç”¨ <code>ProducerManager#startup()</code> æ–¹æ³•ï¼Œå¯åŠ¨ä½œä¸šè°ƒåº¦å™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"Start producer manager"</span>);</div><div class="line">        <span class="comment">// å‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨</span></div><div class="line">        transientProducerScheduler.start();</div><div class="line">        <span class="comment">// åˆå§‹åŒ–è°ƒåº¦ä½œä¸š</span></div><div class="line">        <span class="keyword">for</span> (CloudJobConfiguration each : configService.loadAll()) &#123;</div><div class="line">            schedule(each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>ConfigService#loadAll()</code> æ–¹æ³•ï¼Œä»<strong>æ•°æ®å­˜å‚¨</strong>è¯»å–æ‰€æœ‰ä½œä¸šé…ç½®ã€‚</li><li>è°ƒç”¨ <code>#schedule()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–è°ƒåº¦ä½œä¸šã€‚<ul><li><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œåœ¨ Elastic-Job-Cloud-Scheduler è®¡æ—¶è°ƒåº¦ï¼Œç±»ä¼¼æ¯ XX ç§’ / åˆ† / æ—¶ / å¤©ä¹‹ç±»çš„ä½œä¸šéœ€è¦é‡æ–°è®¡æ—¶ï¼Œè¿™ä¸ªè¯·æ³¨æ„ã€‚</li><li><strong>å¸¸é©»</strong>ä½œä¸šï¼Œåœ¨ Elastic-Job-Cloud-Executor è®¡æ—¶è°ƒåº¦ï¼Œæš‚æ— å½±å“ã€‚</li><li>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ3. Producer å‘å¸ƒä»»åŠ¡ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2 id="5-3-TaskScheduler"><a href="#5-3-TaskScheduler" class="headerlink" title="5.3 TaskScheduler"></a>5.3 TaskScheduler</h2><p>TaskSchedulerï¼ŒFenzo ä½œä¸šè°ƒåº¦å™¨ï¼Œæ ¹æ® Mesos Offer å’Œä½œä¸šä»»åŠ¡çš„ä¼˜åŒ–åˆ†é…ã€‚å› ä¸ºå…¶åˆ†é…æ˜¯ä¾èµ–å½“å‰å®é™… Mesos Offer å’Œ ä½œä¸šä»»åŠ¡è¿è¡Œçš„æƒ…å†µï¼ŒçŒœæµ‹<strong>å¯èƒ½</strong>å¯¹ä¼˜åŒ–åˆ†é…æœ‰å½±å“ï¼Œä½†ä¸å½±å“æ­£ç¡®æ€§ã€‚ç¬”è€…å¯¹ TaskScheduler äº†è§£ä¸æ˜¯å¾ˆæ·±å…¥ï¼Œä»…ä»…ä½œä¸ºçŒœæµ‹ã€‚</p><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.1ã€ã€Œ4.2ã€ã€Œ4.3ã€</a>æœ‰å’Œ TaskScheduler ç›¸å…³çš„å†…å®¹è§£æã€‚</p><h1 id="6-Mesos-Master-å´©æºƒ"><a href="#6-Mesos-Master-å´©æºƒ" class="headerlink" title="6. Mesos Master å´©æºƒ"></a>6. Mesos Master å´©æºƒ</h1><p>Mesos Master é›†ç¾¤ï¼ŒMesos Master ä¸»èŠ‚ç‚¹å´©æºƒåï¼ŒMesos Master é›†ç¾¤é‡æ–°é€‰ä¸¾åï¼ŒSchedulerã€Mesos Slave <strong>ä» Zookeeper è·å–åˆ°æœ€æ–°çš„ Mesos Master ä¸»èŠ‚ç‚¹é‡æ–°è¿›è¡Œæ³¨å†Œ</strong>ï¼Œä¸å½±å“ Scheduler ã€Mesos Slave ã€ä»»åŠ¡æ‰§è¡Œã€‚</p><p>è°ƒç”¨ <code>SchedulerService#getSchedulerDriver(...)</code> æ–¹æ³•ï¼Œè®¾ç½® SchedulerDriver ä» Mesos Zookeeper Address è¯»å–å½“å‰ Mesos Master åœ°å€ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">    MesosConfiguration mesosConfig = env.getMesosConfiguration();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MesosSchedulerDriver(<span class="keyword">new</span> SchedulerEngine(taskScheduler, facadeService, jobEventBus, frameworkIDService, statisticManager), frameworkInfo, mesosConfig.getUrl() <span class="comment">// Mesos Master URL</span></div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MesosSchedulerDriver.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MesosSchedulerDriver</span><span class="params">(Scheduler scheduler,</span></span></div><div class="line"><span class="function"><span class="params">                            FrameworkInfo framework,</span></span></div><div class="line"><span class="function"><span class="params">                            String master)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç      </span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>MesosSchedulerDriver æ„é€ æ–¹æ³•ç¬¬ä¸‰ä¸ªå‚æ•° <code>master</code>ï¼Œä»£è¡¨ Mesos ä½¿ç”¨çš„ Zookeeper åœ°å€ï¼Œä¾‹å¦‚ï¼š<code>zk://127.0.0.1:2181/mesos</code>ã€‚ç”Ÿäº§ç¯å¢ƒè¯·é…ç½®å¤š Zookeeper èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š<code>zk://host1:port1,host2:port2,.../path</code>ã€‚</li><li><p>ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 10] ls /mesos</div><div class="line">[log_replicas, json.info_0000000017]</div><div class="line">[zk: localhost:2181(CONNECTED) 11] get /mesos/json.info_0000000017</div><div class="line">&#123;"address":&#123;"hostname":"localhost","ip":"127.0.0.1","port":5050&#125;,"hostname":"localhost","id":"685fe32d-e30c-4df7-b891-3d96b06fee88","ip":16777343,"pid":"master@127.0.0.1:5050","port":5050,"version":"1.4.0"&#125;</div></pre></td></tr></table></figure></li></ul><p>Elastic-Job-Cloud-Scheduler æ³¨å†Œä¸Šã€é‡æ–°æ³¨å†Œä¸Šã€æ–­å¼€ Mesos Master å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registered</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.FrameworkID frameworkID, <span class="keyword">final</span> Protos.MasterInfo masterInfo)</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"call registered"</span>);</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        <span class="comment">// æ³¨å†Œ Mesos Master ä¿¡æ¯</span></div><div class="line">        MesosStateService.register(masterInfo.getHostname(), masterInfo.getPort());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reregistered</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.MasterInfo masterInfo)</span> </span>&#123;</div><div class="line">        <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        <span class="comment">// æ³¨å†Œ Mesos Master ä¿¡æ¯</span></div><div class="line">        MesosStateService.register(masterInfo.getHostname(), masterInfo.getPort());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver)</span> </span>&#123;</div><div class="line">        log.warn(<span class="string">"call disconnected"</span>);</div><div class="line">        MesosStateService.deregister();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>MesosStateServiceï¼ŒMesosçŠ¶æ€æœåŠ¡ï¼Œæä¾›è°ƒç”¨ Mesos Master API æœåŠ¡ï¼Œä¾‹å¦‚è·å–æ‰€æœ‰æ‰§è¡Œå™¨ã€‚</li><li><p>è°ƒç”¨ <code>MesosStateService#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œ Mesos Master ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MesosStateService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String stateUrl;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> String hostName, <span class="keyword">final</span> <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        stateUrl = String.format(<span class="string">"http://%s:%d/state"</span>, hostName, port);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>MesosStateService#deregister(...)</code> æ–¹æ³•ï¼Œæ³¨é”€ Mesos Master ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">()</span> </span>&#123;</div><div class="line">    stateUrl = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p><a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹P110 å¦‚ä½•å¤„ç† master çš„æ•…éšœ</a>ï¼Œæœ‰å…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥<strong>ä»”ç»†</strong>çœ‹çœ‹ã€‚</p><h1 id="7-Mesos-Slave-å´©æºƒ"><a href="#7-Mesos-Slave-å´©æºƒ" class="headerlink" title="7. Mesos Slave å´©æºƒ"></a>7. Mesos Slave å´©æºƒ</h1><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>ä¸­ï¼Œæœç´¢å…³é”®å­— <strong>â€œTASK_LOSTâ€</strong>ï¼Œæœ‰ Mesos Slave å´©æºƒåï¼Œå¯¹ Elastic-Job-Cloud-Scheduler å’Œ Elastic-Job-Cloud-Executor çš„å½±å“ã€‚</p><p><a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹P109 å¦‚ä½•å¤„ç† slave çš„æ•…éšœ</a>ï¼Œæœ‰å…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥<strong>ä»”ç»†</strong>çœ‹çœ‹ã€‚</p><h1 id="8-Scheduler-æ ¸å¯¹"><a href="#8-Scheduler-æ ¸å¯¹" class="headerlink" title="8. Scheduler æ ¸å¯¹"></a>8. Scheduler æ ¸å¯¹</h1><blockquote><p>FROM <a href="http://mesos.apache.org/documentation/latest/reconciliation/" rel="external nofollow noopener noreferrer" target="_blank">http://mesos.apache.org/documentation/latest/reconciliation/</a><br>Messages between framework schedulers and the Mesos master may be dropped due to failures and network partitions. This may cause a framework scheduler and the master to have <strong>different views of the current state of the cluster</strong>. For example, consider a launch task request sent by a framework. There are many ways that failures can prevent the task launch operation from succeeding, such as:</p><ul><li>Framework fails after persisting its intent to launch the task, but before the launch task message was sent.  </li><li>Master fails before receiving the message.  </li><li>Master fails after receiving the message but before sending it to the agent.  </li></ul></blockquote><p>é€šè¿‡<strong>æ ¸å¯¹</strong>ç‰¹æ€§è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ ¸å¯¹æ˜¯åè°ƒå™¨å¦‚ä½•å’Œ Mesos Master ä¸€èµ·æ£€æŸ¥è°ƒåº¦å™¨æ‰€è®¤ä¸ºçš„é›†ç¾¤çŠ¶æ€æ˜¯å¦å’Œ Mesos Master æ‰€è®¤ä¸ºçš„é›†ç¾¤çŠ¶æ€å®ŒæˆåŒ¹é…ã€‚</p><p>è°ƒç”¨ <code>SchedulerDriver#reconcileTasks(...)</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€‚ä»£ç æ¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulerDriver</span> </span>&#123;</div><div class="line">    <span class="function">Status <span class="title">reconcileTasks</span><span class="params">(Collection&lt;TaskStatus&gt; statuses)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>åªèƒ½</strong>æŸ¥è¯¢<strong>éç»ˆæ­¢çŠ¶æ€( non-terminal )</strong>çš„ä»»åŠ¡ã€‚æ ¸å¯¹çš„ä¸»è¦åŸå› ï¼Œç¡®è®¤ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œæˆ–è€…å·²ç»è¿›å…¥äº†ä¸­æ–­çŠ¶æ€ã€‚<ul><li>terminalï¼šTASK_ERRORã€TASK_FAILEDã€TASK_FINISHEDã€TASK_KILLED</li><li>non-terminalï¼šTASK_DROPPEDã€TASK_GONEã€TASK_GONE_BY_OPERATORã€TASK_KILLINGã€TASK_LOSTã€TASK_RUNNINGã€TASK_STAGINGã€TASK_STARTINGã€TASK_UNREACHABLEã€TASK_UNKNOWN</li></ul></li><li>å½“ <code>statuses</code> éç©ºæ—¶ï¼Œ<strong>æ˜¾ç¤º</strong>æŸ¥è¯¢ï¼Œé€šè¿‡å›è°ƒ <code>Scheduler#statusUpdate(...)</code> æ–¹æ³•å¼‚æ­¥è¿”å›<strong>æŒ‡å®š</strong>çš„ä»»åŠ¡çš„çŠ¶æ€ã€‚</li><li>å½“ <code>statuses</code> ä¸ºç©ºæ—¶ï¼Œ<strong>éšå¼</strong>æŸ¥è¯¢ï¼Œé€šè¿‡å›è°ƒ <code>Scheduler#statusUpdate(...)</code> æ–¹æ³•å¼‚æ­¥è¿”å›<strong>å…¨éƒ¨</strong>çš„ä»»åŠ¡çš„çŠ¶æ€ã€‚</li></ul><p>ReconcileServiceï¼Œæ ¸å¯¹ Mesos ä¸ Scheduler ä¹‹é—´çš„ä»»åŠ¡çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReconcileService</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            explicitReconcile();</div><div class="line">            implicitReconcile();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">        FrameworkConfiguration configuration = BootstrapEnvironment.getInstance().getFrameworkConfiguration();</div><div class="line">        <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(configuration.getReconcileIntervalMinutes(), configuration.getReconcileIntervalMinutes(), TimeUnit.MINUTES);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é€šè¿‡é…ç½® <code>FrameworkConfiguration#reconcileIntervalMinutes</code> è®¾ç½®ï¼Œæ¯éš”å¤šå°‘åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ ¸å¯¹ã€‚è‹¥é…ç½®æ—¶é—´å¤§äº 0 æ‰å¼€å¯ä»»åŠ¡çŠ¶æ€æ ¸å¯¹åŠŸèƒ½ã€‚</li><li><p>è°ƒç”¨ <code>#explicitReconcile()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢è¿è¡Œä¸­çš„ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">explicitReconcile</span><span class="params">()</span> </span>&#123;</div><div class="line">   lock.lock();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// è·å–è¿è¡Œä¸­çš„ä½œä¸šä»»åŠ¡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">       Set&lt;TaskContext&gt; runningTask = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">       <span class="keyword">for</span> (Set&lt;TaskContext&gt; each : facadeService.getAllRunningTasks().values()) &#123;</div><div class="line">           runningTask.addAll(each);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (runningTask.isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       log.info(<span class="string">"Requesting &#123;&#125; tasks reconciliation with the Mesos master"</span>, runningTask.size());</div><div class="line">       <span class="comment">// æŸ¥è¯¢æŒ‡å®šä»»åŠ¡</span></div><div class="line">       schedulerDriver.reconcileTasks(Collections2.transform(runningTask, <span class="keyword">new</span> Function&lt;TaskContext, Protos.TaskStatus&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="keyword">public</span> Protos.<span class="function">TaskStatus <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TaskContext input)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> Protos.TaskStatus.newBuilder()</div><div class="line">                       .setTaskId(Protos.TaskID.newBuilder().setValue(input.getId()).build())</div><div class="line">                       .setSlaveId(Protos.SlaveID.newBuilder().setValue(input.getSlaveId()).build())</div><div class="line">                       .setState(Protos.TaskState.TASK_RUNNING)</div><div class="line">                       .build();</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       lock.unlock();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#implicitReconcile()</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢æ‰€æœ‰ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">implicitReconcile</span><span class="params">()</span> </span>&#123;</div><div class="line">   lock.lock();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// æŸ¥è¯¢å…¨éƒ¨ä»»åŠ¡</span></div><div class="line">       schedulerDriver.reconcileTasks(Collections.&lt;Protos.TaskStatus&gt;emptyList());</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       lock.unlock();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>ä¸ºä»€ä¹ˆè¿™é‡Œè¦ä½¿ç”¨ ReentrantLock é”å‘¢ï¼ŸElastic-Job-Cloud-Scheduler æä¾› CloudOperationRestfulApiï¼Œæ”¯æŒä½¿ç”¨ HTTP Restful API ä¸»åŠ¨è§¦å‘ <code>#explicitReconcile()</code> å’Œ <code>#implicitReconcile()</code> æ–¹æ³•ï¼Œ<strong>é€šè¿‡é”é¿å…å¹¶å‘æ ¸å¯¹</strong>ã€‚å¯¹ CloudOperationRestfulApi æœ‰å…´è¶£çš„åŒå­¦ï¼Œç›´æ¥ç‚¹å‡»<a href="https://github.com/dangdangdotcom/elastic-job/blob/a52d4062bf1f1d729fa4dbf2d1225e0d97778cb9/elastic-job-cloud/elastic-job-cloud-scheduler/src/main/java/com/dangdang/ddframe/job/cloud/scheduler/restful/CloudOperationRestfulApi.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ã€‚</p></li><li>è™½ç„¶ <code>#implicitReconcile()</code> æ–¹æ³•ï¼Œèƒ½æŸ¥è¯¢åˆ°æ‰€æœ‰ Mesos ä»»åŠ¡çŠ¶çš„æ€ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒå·®ï¼Œè€Œ <code>#explicitReconcile()</code> æ–¹æ³•æ˜¾å¼æŸ¥è¯¢è¿è¡Œä¸­çš„ Mesos ä»»åŠ¡çš„çŠ¶æ€ï¼Œæ€§èƒ½æ›´å¥½ï¼Œæ‰€ä»¥å…ˆè¿›è¡Œè°ƒç”¨ã€‚</li><li><p>ä¼˜åŒ–ç‚¹ï¼ˆç›®å‰æš‚æœªå®ç°ï¼‰ï¼šElastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos å’Œ é‡æ³¨å†Œåˆ° Mesosï¼Œéƒ½æ‰§è¡Œä¸€æ¬¡æ ¸å¯¹ã€‚</p><blockquote><p>FROM <a href="http://www.iocoder.cn/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a><br>This reconciliation algorithm must be run after each (re-)registration.</p></blockquote></li></ul><p>å…¶ä»– Scheduler æ ¸å¯¹èµ„æ–™ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ï¼š</p><ul><li><a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹P76 æ·»åŠ æ ¸å¯¹ ã€P111 æ•…éšœè½¬ç§»æœŸé—´çš„æ ¸å¯¹</a></li><li><a href="http://mesos.apache.org/documentation/latest/reconciliation/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” reconciliationã€‹</a></li></ul><p>Elastic-Job-Lite ä¹Ÿä¼šå­˜åœ¨ä½œä¸šèŠ‚ç‚¹ å’Œ Zookeeper æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹<a href="http://www.iocoder.cn/Elastic-Job/reconcile/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” è‡ªè¯Šæ–­ä¿®å¤ã€‹</a>çš„å®ç°ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç»™è‹±æ–‡å’Œæˆ‘ä¸€æ ·åŠæ–¤å…«ä¸¤çš„åŒå­¦ä¸€æœ¬è‘µèŠ±å®å…¸+è¾Ÿé‚ªå‰‘è°±ï¼š</p><ul><li><a href="https://mesos-cn.gitbooks.io/mesos-cn/content/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesosä¸­æ–‡æ‰‹å†Œã€‹</a>ã€‚</li><li><a href="http://www.jianshu.com/p/726e28ea488a" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®¹é”™ã€æ•…éšœã€‹</a></li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/03.png" alt=""></p><p>æ•´ä¸ª Elastic-Job-Cloud å®Œç»“ï¼Œæ’’èŠ±ï¼</p><p>æ”¶è·è›®å¤šçš„ï¼Œå­¦ä¹ çš„ç¬¬ä¸€å¥—åŸºäºäº‘åŸç”Ÿ( CloudNative )å®ç°çš„ä¸­é—´ä»¶ï¼ŒæœŸå¾…æœ‰åŸºäºäº‘åŸç”Ÿçš„æœåŠ¡åŒ–ä¸­é—´ä»¶ã€‚</p><p>ä¸€å¼€å§‹å› ä¸º Elastic-Job-Cloud åŸºäº Mesos å®ç°ï¼Œå†…å¿ƒè¿˜æ˜¯æœ‰ç‚¹ææƒ§æ„Ÿï¼Œåé¢ç¡¬å•ƒ + æ­é…<a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a>ï¼Œæ¯”é¢„æƒ³çš„æ—¶é—´å¿«äº†ä¸€åŠå®Œæˆè¿™ä¸ªç³»åˆ—ã€‚åœ¨è¿™é‡Œå¼ºçƒˆæ¨èè¿™æœ¬ä¹¦ã€‚å¦å¤–ï¼Œç­‰æ—¶é—´ç›¸å¯¹ç©ºï¼Œä¼šç ”ç©¶ä¸‹å¦å¤–ä¸€ä¸ªæ²ªæ±Ÿå¼€æºçš„åŸºäº Mesos å®ç°çš„åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿ <a href="https://github.com/HujiangTechnology/Juice" rel="external nofollow noopener noreferrer" target="_blank">Juice</a>ã€‚ä¸æ˜¯å¾ˆç¡®å®šä¼šä¸ä¼šå‡ºæºç è§£æçš„æ–‡ç« ï¼Œå°½é‡è¾“å‡ºå™¶ã€‚</p><p>åé¢ä¼šç»§ç»­æ›´æ–°æºç è§£æç³»åˆ—ï¼Œä¸‹ä¸€ä¸ªç³»åˆ—åº”è¯¥æ˜¯<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">ã€Štcc-transaction æºç è§£æã€‹</a>ã€‚åœ¨é€‰æ‹©è¦ç ”ç©¶çš„ tcc ä¸­é—´ä»¶è¿˜æ˜¯è›®çº ç»“çš„ï¼Œå“ˆå“ˆï¼Œè¿™é‡Œå¬ä» <a href="http://www.54tianzhisheng.cn/" rel="external nofollow noopener noreferrer" target="_blank">zhisheng</a> çš„å»ºè®®ã€‚å¦‚æœä¸å¥½ï¼Œæˆ‘ä¿è¯ä¼šæ‰“æ­»ä½ çš„ã€‚</p><p>å¸Œæœ›åšæŒä¸æ‡ˆçš„åˆ†äº«æºç è§£æä¼šæœ‰æ›´å¤šçš„åŒè¡Œè€…é˜…è¯»ã€‚ç¡®å®ï¼Œæºç è§£æçš„å—ä¼—ç•¥å°ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_15/04.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. Scheduler é›†ç¾¤&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a hre
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-failover/</id>
    <published>2018-01-09T16:00:00.000Z</published>
    <updated>2017-09-16T04:56:06.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</a></li><li><a href="#">3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud ä½œä¸šå¤±æ•ˆè½¬ç§»</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« ä¸º<a href="http://www.iocoder.cn/Elastic-Job/job-failover/?self">ã€ŠElastic-Job-Lite ä½œä¸šä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>ã€‚</p><p>ä½ éœ€è¦å¯¹<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>å½“ä½œä¸šä»»åŠ¡åœ¨ Elastic-Job-Cloud-Executor å¼‚å¸¸å´©æºƒæ—¶ï¼Œè¯¥ä»»åŠ¡åœ¨ä¸‹æ¬¡è°ƒåº¦ä¹‹å‰ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½åï¼Œè¯¥ä½œä¸šä»»åŠ¡ä¼šç«‹å³è¢« Elastic-Job-Cloud-Scheduler é‡æ–°è°ƒåº¦ï¼Œæäº¤ Elastic-Job-Cloud-Executor <strong>ç«‹å³</strong>æ‰§è¡Œã€‚</p><p>åœ¨ Elastic-Job-Cloud é‡Œï¼Œæˆ‘ä»¬äº†è§£åˆ°ä½œä¸šåˆ†æˆ<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šã€‚å®é™…ä¸Šé¢å¤±æ•ˆè½¬ç§»çš„å®šä¹‰æš‚æ—¶åªé€‚ç”¨äº<strong>ç¬æ—¶</strong>ä½œä¸šã€‚å¯¹äº<strong>å¸¸é©»</strong>ä½œä¸šï¼Œä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒåï¼Œæ— è®ºä½ æ˜¯å¦å¼€å¯å¤±æ•ˆè½¬ç§»åŠŸèƒ½ï¼ŒElastic-Job-Cloud-Scheduler ä¼šç«‹åˆ»æäº¤ Elastic-Job-Cloud-Executor <strong>é‡æ–°è°ƒåº¦</strong>æ‰§è¡Œã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ­¤å¤„ä½¿ç”¨çš„æ˜¯â€œé‡æ–°è°ƒåº¦â€ï¼Œè€Œä¸æ˜¯â€œç«‹å³æ‰§è¡Œâ€å‘¢</strong>ï¼Ÿç›®å‰ç‰ˆæœ¬ Elasitc-Job-Cloud æš‚æ—¶ä¸æ”¯æŒ<strong>å¸¸é©»</strong>ä½œä¸šçš„å¤±æ•ˆè½¬ç§»ï¼Œå½“ä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒï¼Œæœ¬æ¬¡æ‰§è¡Œ<strong>ä¸ä¼šé‡æ–°æ‰§è¡Œ</strong>ï¼Œä½†æ˜¯ä¸ºäº†ä½œä¸šä»»åŠ¡åç»­èƒ½å¤Ÿè°ƒåº¦æ‰§è¡Œï¼Œæ‰€ä»¥å†æ¬¡æäº¤ Elastic-Job-Cloud-Schedulerã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ä½œä¸šå¤±æ•ˆè½¬ç§»çš„å®ç°æ–¹å¼å’Œä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒçš„å¤šé‡åœºæ™¯ã€‚</p><h1 id="2-è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»"><a href="#2-è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»" class="headerlink" title="2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»"></a>2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»</h1><p>å½“ä½œä¸šä»»åŠ¡å¼‚å¸¸å´©æºƒæ—¶ï¼ŒElastic-Job-Cloud-Scheduler é€šè¿‡ Mesos ä»»åŠ¡çŠ¶æ€å˜æ›´æ¥å£( <code>#statusUpdate()</code> )å®ç°å¯¹ä»»åŠ¡çŠ¶æ€çš„ç›‘å¬å¤„ç†ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">        String taskId = taskStatus.getTaskId().getValue();</div><div class="line">        TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">        String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">        log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">        jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">                taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">        <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">            <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_KILLED:</div><div class="line">                <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_LOST:</div><div class="line">            <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">            <span class="keyword">case</span> TASK_GONE:</div><div class="line">            <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">            <span class="keyword">case</span> TASK_FAILED: <span class="comment">// æ‰§è¡Œä½œä¸šä»»åŠ¡è¢«é”™è¯¯ç»ˆæ­¢</span></div><div class="line">            <span class="keyword">case</span> TASK_ERROR: <span class="comment">// ä»»åŠ¡é”™è¯¯</span></div><div class="line">                log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">                <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">                facadeService.removeRunning(taskContext);</div><div class="line">                <span class="comment">// è®°å½•å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">                facadeService.recordFailoverTask(taskContext);</div><div class="line">                <span class="comment">// é€šçŸ¥ TaskScheduler ä»»åŠ¡ä¸åˆ†é…åœ¨å¯¹åº”ä¸»æœºä¸Š</span></div><div class="line">                unAssignTask(taskId);</div><div class="line">                <span class="comment">// ç»Ÿè®¡</span></div><div class="line">                statisticManager.taskRunFailed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">            <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">                log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">                statisticManager.taskRunFailed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>ä¸€å…±æœ‰ 6 ç§çŠ¶æ€åˆ¤å®šä¸ºä½œä¸šä»»åŠ¡å´©æºƒï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªä¸€ä¸ªçœ‹çœ‹ï¼š</p><ul><li><p>TASK_DROPPED / TASK_GONE / TASK_GONE_BY_OPERATOR</p><p>  è¿™ä¸‰ä¸ªçŠ¶æ€ï¼Œç¬”è€…æš‚æ—¶ä¸å¤ªäº†è§£ï¼Œè¿™é‡Œå…ˆå¼•ç”¨ä¸€äº›èµ„æ–™ï¼Œæ¬¢è¿æœ‰äº†è§£çš„åŒå­¦æŒ‡æ•™ä¸€ä¸‹ã€‚    </p><blockquote><p>FROM <a href="http://mesos.apache.org/api/latest/java/org/apache/mesos/Protos.TaskState.html" rel="external nofollow noopener noreferrer" target="_blank">http://mesos.apache.org/api/latest/java/org/apache/mesos/Protos.TaskState.html</a><br><strong>TASK_DROPPED</strong>ï¼šThe task failed to launch because of a transient error.<br><strong>TASK_GONE</strong>ï¼šThe task is no longer running.<br><strong>TASK_GONE_BY_OPERATOR</strong>ï¼šThe task was running on an agent that the master cannot contact; the operator has asserted that the agent has been shutdown, but this has not been directly confirmed by the master.  </p><p>FROM <a href="http://mesos.apache.org/blog/mesos-1-1-0-released/" rel="external nofollow noopener noreferrer" target="_blank">http://mesos.apache.org/blog/mesos-1-1-0-released/</a><br>[MESOS-5344] - Experimental support for partition-aware Mesos frameworks. In previous Mesos releases, when an agent is partitioned from the master and then reregisters with the cluster, all tasks running on the agent are terminated and the agent is shutdown. In Mesos 1.1, partitioned agents will no longer be shutdown when they reregister with the master. By default, tasks running on such agents will still be killed (for backward compatibility); however, frameworks can opt-in to the new PARTITION_AWARE capability. If they do this, their tasks will not be killed when a partition is healed. This allows frameworks to define their own policies for how to handle partitioned tasks. Enabling the PARTITION_AWARE capability also introduces a new set of task states: TASK_UNREACHABLE, TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, and TASK_UNKNOWN. <strong>These new states are intended to eventually replace the TASK_LOST state</strong>.</p></blockquote></li><li><p>TASK_FAILED</p><p>  æ‰§è¡Œä½œä¸šä»»åŠ¡è¢«<strong>é”™è¯¯</strong>ç»ˆæ­¢ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )å¼‚å¸¸å´©æºƒï¼Œæˆ–è€…è¢«æ€æ­»ã€‚</p></li><li><p>TASK_ERROR</p><p>  ä»»åŠ¡å¯åŠ¨å°è¯•å¤±è´¥é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor ) æ¥æ”¶åˆ°çš„ä»»åŠ¡çš„ä½œä¸šé…ç½®ä¸æ­£ç¡®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">    executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">    <span class="comment">//</span></div><div class="line">    Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">    ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">        ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">        <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">        <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">        <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">        <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">            <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">            JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">            <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">            executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">            <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">        <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">        log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">        <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œé”™è¯¯ã€‚</span></div><div class="line">        executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">        <span class="comment">// åœæ­¢è‡ªå·±</span></div><div class="line">        executorDriver.stop();</div><div class="line">        <span class="keyword">throw</span> ex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œå› ä¸ºä»»åŠ¡çš„ä½œä¸šé…ç½®ä¸æ­£ç¡®æŠ›å‡º<strong>å¼‚å¸¸</strong>ã€‚ä¾‹å¦‚ï¼Œä»»åŠ¡ç±»ä¸å­˜åœ¨ï¼›Spring çš„ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼›Spring å®¹å™¨åˆå§‹åŒ–å‡ºé”™ï¼›Spring Bean å¯¹è±¡åˆå§‹åŒ–æˆ–è·å–å‡ºé”™ï¼›ä»¥åŠç­‰ç­‰ã€‚</li><li><p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ–¹æ³•ï¼Œå‘ç”Ÿ<strong>å¼‚å¸¸</strong>ï¼Œå¹¶ä¸”<strong>å¼‚å¸¸è¢«æŠ›å‡º</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒAbstractElasticJobExecutor å†…éƒ¨ä½¿ç”¨ DefaultJobExceptionHandler å¤„ç†å‘ç”Ÿçš„å¼‚å¸¸ï¼Œ<strong>ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJobExceptionHandler</span> <span class="keyword">implements</span> <span class="title">JobExceptionHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> Throwable cause)</span> </span>&#123;</div><div class="line">        log.error(String.format(<span class="string">"Job '%s' exception occur in job processing"</span>, jobName), cause);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li></li></ul></li><li><p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#(...)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å‘ç”Ÿ<strong>å¼‚å¸¸</strong>ã€‚</p></li><li>å› ä¸ºä¸Šè¿°çš„ç§ç§å¼‚å¸¸ï¼Œè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code>ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º TASK_ERRORã€‚å¦å¤–ï¼Œè°ƒç”¨ <code>ExecutorDriver#stop()</code> æ–¹æ³•ï¼Œå…³é—­è‡ªå·±ã€‚<strong>è¿™æ„å‘³ç€ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨ä¸Šå¦‚æœå­˜åœ¨ä¸€ä¸ªä½œä¸šä»»åŠ¡å‘ç”Ÿ TASK_ERRORï¼Œå…¶ä»–ä½œä¸šä»»åŠ¡å³ä½¿æ˜¯æ­£å¸¸çš„ï¼Œä¹Ÿä¼šæ›´æ–°ä½œä¸šä»»åŠ¡çŠ¶æ€ä¸º TASK_FAILED</strong>ã€‚è¿™å—åƒä¸‡è¦æ³¨æ„ã€‚</li></ul></li><li><p>TASK_LOST</p><p>  æ‰§è¡Œä½œä¸šä»»åŠ¡çš„ Elastic-Job-Cloud-Executor æ‰€åœ¨çš„ Mesos Slave ä¸ Mesos Master å› ä¸º<strong>ç½‘ç»œé—®é¢˜æˆ– Mesos Slave å´©æºƒ</strong>å¼•èµ·ä¸¢å¤±è¿æ¥ï¼Œ<strong>å¯èƒ½</strong>å¯¼è‡´å…¶ä¸Šçš„æ‰€æœ‰ä½œä¸šä»»åŠ¡çŠ¶æ€å˜ä¸º TASK_LOSTã€‚</p><p>  <strong>å½“ Slave å®•æœºåé‡å¯ï¼Œå¯¼è‡´ TASK_LOST æ—¶ï¼ŒMesosåˆæ˜¯æ€ä¹ˆæ¥å¤„ç†çš„å‘¢ï¼Ÿ</strong></p><blockquote><p>FROM <a href="http://dockone.io/article/2513" rel="external nofollow noopener noreferrer" target="_blank">http://dockone.io/article/2513</a><br>åœ¨ Master å’Œ Slave ä¹‹é—´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”± Master ä¸»åŠ¨å‘æ¯ä¸€ä¸ª Slave å‘é€Pingæ¶ˆæ¯ï¼Œå¦‚æœåœ¨è®¾å®šæ—¶é—´å†…ï¼ˆflag.slave_ping_timeoutï¼Œé»˜è®¤15sï¼‰æ²¡æœ‰æ”¶åˆ°Slave çš„å›å¤ï¼Œå¹¶ä¸”è¾¾åˆ°ä¸€å®šæ¬¡æ•°ï¼ˆflag.max_slave_ping_timeoutsï¼Œé»˜è®¤æ¬¡æ•°ä¸º5ï¼‰ï¼Œé‚£ä¹ˆ Master ä¼šæ“ä½œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š  </p><ol><li>å°†è¯¥ Slave ä» Master ä¸­åˆ é™¤ï¼Œæ­¤æ—¶è¯¥ Slave çš„èµ„æºå°†ä¸ä¼šå†åˆ†é…ç»™Schedulerã€‚  </li><li>éå†è¯¥ Slave ä¸Šè¿è¡Œçš„æ‰€æœ‰ä»»åŠ¡ï¼Œå‘å¯¹åº”çš„ Framework å‘é€ä»»åŠ¡çš„ Task_Lost çŠ¶æ€æ›´æ–°ï¼ŒåŒæ—¶æŠŠè¿™äº›ä»»åŠ¡ä»Masterä¸­åˆ é™¤ã€‚  </li><li>éå†è¯¥ Slave ä¸Šçš„æ‰€æœ‰ Executorï¼Œå¹¶åˆ é™¤ã€‚  </li><li>è§¦å‘ Rescind Offerï¼ŒæŠŠè¿™ä¸ª Slave ä¸Šå·²ç»åˆ†é…ç»™ Scheduler çš„ Offer æ’¤é”€ã€‚  </li><li>æŠŠè¿™ä¸ª Slave ä» Master çš„ Replicated log ä¸­åˆ é™¤ï¼ˆMesos Master ä¾èµ– Replicated log ä¸­çš„éƒ¨åˆ†æŒä¹…åŒ–é›†ç¾¤é…ç½®ä¿¡æ¯è¿›è¡Œ failer over / recoveryï¼‰ã€‚ </li></ol></blockquote><ul><li><p>å¿…é¡» Slave è¿›è¡Œé‡å¯ï¼Œå› ä¸ºå¯¹æ‰§è¡Œå™¨çš„ç›¸å…³æ“ä½œåªèƒ½é€šè¿‡ Mesos Slaveï¼Œå³ <strong>Scheduler &lt;=&gt; Mesos Master &lt;=&gt; Mesos Slave &lt;=&gt; Executor</strong>ã€‚å¦‚æœ Slave ä¸€ç›´ä¸è¿›è¡Œé‡å¯ï¼Œæ‰§è¡Œå™¨ä¼šä¸€ç›´è¿è¡Œï¼Œé™¤éæœ‰å¦å¤–çš„æœºåˆ¶ï¼Œ<strong>é€šçŸ¥</strong>åˆ°æ‰§è¡Œå™¨ã€‚</p><p>Butâ€¦â€¦â€¦â€¦â€¦â€¦<br>ç¬”è€…å°è¯•å¦‚ä¸Šæµç¨‹ï¼Œä½¿ç”¨ <code>kill -9</code> æ¨¡æ‹Ÿ Mesos Slave å¼‚å¸¸å´©æºƒï¼Œç­‰å¾… Mesos Master å‘ç° Mesos Slave å·²ç»å…³é—­ï¼Œ<strong>é‡å¯ Mesos Slave</strong>ï¼Œç»“æœæ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )æœªå…³é—­ï¼Œè°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler )å¹¶æœªæ”¶åˆ°ä»»åŠ¡çš„ TASK_LOSTã€‚ï¼Ÿï¼Ÿï¼Ÿä»€ä¹ˆæƒ…å†µï¼Ÿï¼Ÿï¼Ÿç¿»æŸ¥å¦‚ä¸‹æ–‡æ¡£ï¼š</p></li><li><p><a href="http://mesos.apache.org/documentation/latest/high-availability-framework-guide/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” high-availability-framework-guideã€‹</a>æœç´¢æ ‡é¢˜ â€œDealing with Partitioned or Failed Agentsâ€ã€‚</p></li><li><p><a href="http://mesos.apache.org/documentation/latest/agent-recovery/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” agent-recoveryã€‹</a>æœç´¢å…³æ ‡é¢˜ â€œAgent Recoveryâ€ã€‚</p><p>å› ä¸º Elastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos Master æ—¶ï¼Œå¼€å¯äº† <code>checkpoint</code> å’Œ <code>PARTITION_AWARE</code>ã€‚å¼€å¯ <code>checkpoint</code> åï¼ŒMesos Slave ä¼šå°†è®°å½•<strong>æ£€æŸ¥ç‚¹</strong>ä¿¡æ¯ï¼Œ Mesos Slave é‡å¯åï¼Œä¼šè¯»å–æ£€æŸ¥ç‚¹æ£€æŸ¥ä¿¡æ¯ï¼Œ<strong>é‡æ–°è¿æ¥ä¸Š( ä¸ä¼šå…³é—­ )</strong>è¿è¡Œåœ¨å®ƒä¸Šé¢çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )ã€‚å¼€å¯ <code>PARTITION_AWARE</code> åï¼ŒTASK_LOST ä¼šè¢«åŒºåˆ†æˆ TASK_UNREACHABLE, TASK_DROPPED, TASK_GONE, TASK_GONE_BY_OPERATOR, and TASK_UNKNOWNã€‚è¡¨ç°å¦‚ä¸‹ï¼š</p><ul><li><code>kill -9</code> æ¨¡æ‹Ÿ Mesos Slave å¼‚å¸¸å´©æºƒï¼Œç­‰å¾… Mesos Master å‘ç° Mesos Slave å·²ç»å…³é—­</li><li>è°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler ) æ¥æ”¶ç›´æ¥ç”± Mesos Master å‘é€çš„è¯¥ Mesos Slave ä¸Šçš„æ¯ä¸ªä»»åŠ¡ TASK_UNREACHABLEã€‚</li><li>Mesos Slave é‡å¯å®Œæˆã€‚</li><li>æ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor ) é‡æ–°æ³¨å†Œåˆ°é‡å¯å¥½çš„ Mesos Slave ï¼Œå¹¶ç»§ç»­è¿è¡Œä»»åŠ¡ã€‚</li></ul></li></ul><p>å¦‚æœ Elastic-Job-Cloud-Scheduler æ³¨å†Œåˆ° Mesos Master æ—¶ï¼Œå…³é—­äº† <code>PARTITION_AWARE</code> å’Œ <code>checkpoint</code>ï¼Œè¡¨ç°åŒ <strong>TASK_LOST</strong> æè¿°çš„è¿‡ç¨‹ã€‚</p><p>å¼€å¯ <code>checkpoint</code> å’Œ <code>PARTITION_AWARE</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerService.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> SchedulerDriver <span class="title">getSchedulerDriver</span><span class="params">(<span class="keyword">final</span> TaskScheduler taskScheduler, <span class="keyword">final</span> JobEventBus jobEventBus, <span class="keyword">final</span> FrameworkIDService frameworkIDService)</span> </span>&#123;</div><div class="line">      Protos.FrameworkInfo.Builder builder = Protos.FrameworkInfo.newBuilder();</div><div class="line">      <span class="comment">// PARTITION_AWARE</span></div><div class="line">      builder.addCapabilitiesBuilder().setType(Protos.FrameworkInfo.Capability.Type.PARTITION_AWARE);</div><div class="line">      Protos.FrameworkInfo frameworkInfo = builder.setUser(mesosConfig.getUser()).setName(frameworkName)</div><div class="line">          .setHostname(mesosConfig.getHostname()).setFailoverTimeout(FRAMEWORK_FAILOVER_TIMEOUT_SECONDS)</div><div class="line">          .setWebuiUrl(WEB_UI_PROTOCOL + env.getFrameworkHostPort())</div><div class="line">          .setCheckpoint(<span class="keyword">true</span>) <span class="comment">// checkpoint</span></div><div class="line">          .build();</div><div class="line">      <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></code></pre><p><strong>æ˜¯ä¸æ˜¯å¼€å¯äº† <code>checkpoint</code>ï¼ŒMesos Slave é‡å¯ä¸ä¼šå…³é—­æ‰§è¡Œå™¨ï¼Ÿ</strong></p><p> ç­”æ¡ˆå½“ç„¶æ˜¯ä¸æ˜¯çš„ã€‚å½“ Mesos Slave é…ç½® <code>recover = cleanup</code> æˆ–è€… é‡å¯æ—¶é—´è¶…è¿‡ <code>recovery_timeout</code> ( é»˜è®¤ï¼Œ15 åˆ†é’Ÿ )æ—¶ï¼Œé‡å¯å®Œæˆåï¼ŒMesos Slave å…³é—­è¿è¡Œåœ¨å®ƒä¸Šé¢çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Executor )ï¼Œè°ƒåº¦å™¨( Elastic-Job-Cloud-Scheduler ) æ¥æ”¶åˆ°çš„è¯¥ Mesos Slave ä¸Šçš„æ¯ä¸ªä»»åŠ¡ TASK_FAILEDã€‚</p><ul><li>å‚è€ƒæ–‡æ¡£ï¼š<a href="http://mesos.apache.org/documentation/latest/agent-recovery/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos å®˜æ–¹æ–‡æ¡£ â€”â€” agent-recoveryã€‹</a>æœç´¢æ ‡é¢˜ â€œAgent Configurationâ€ã€‚</li></ul></li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/01.png" alt=""></p><hr><p>è°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œè®°å½•å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordFailoverTask</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = jobConfigService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (isDisable(jobConfigOptional.get())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="keyword">if</span> (jobConfig.getTypeConfig().getCoreConfig().isFailover() <span class="comment">// å¼€å¯å¤±æ•ˆè½¬ç§»</span></div><div class="line">           || CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       failoverService.add(taskContext);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å¯¹äº<strong>ç¬æ—¶</strong>ä½œä¸šï¼Œå¿…é¡»å¼€å¯ <code>JobCoreConfiguration.failover = true</code>ï¼Œæ‰èƒ½å¤±æ•ˆè½¬ç§»ï¼Œè¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚</li><li>å¯¹äº<strong>å¸¸é©»</strong>ä½œä¸šï¼Œæš‚æ—¶ä¸æ”¯æŒå¤±æ•ˆè½¬ç§»ã€‚å› ä¸ºå¸¸é©»ä½œä¸šæ˜¯åœ¨æ‰§è¡Œå™¨( Elastic-Job-Executor ) è¿›è¡Œè°ƒåº¦æ‰§è¡Œï¼Œå¦‚æœä¸æ·»åŠ åˆ°å¤±æ•ˆè½¬ç§»ä½œä¸šé˜Ÿåˆ—ï¼Œé‡æ–°æäº¤åˆ°æ‰§è¡Œå™¨( Elastic-Job-Executor )ï¼Œåç»­å°±ä¸èƒ½è°ƒåº¦æ‰§è¡Œè¯¥ä½œä¸šäº†ã€‚</li><li>è°ƒç”¨ <code>FailoverService#add(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡æ”¾å…¥å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(FailoverNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   String failoverTaskNodePath = FailoverNode.getFailoverTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(failoverTaskNodePath) <span class="comment">// åˆ¤æ–­ä¸åœ¨å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">           &amp;&amp; !runningService.isTaskRunning(taskContext.getMetaInfo())) &#123; <span class="comment">// åˆ¤æ–­ä¸åœ¨è¿è¡Œä¸­</span></div><div class="line">       regCenter.persist(failoverTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// FailoverNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/failover"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s=$&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FAILOVER_TASK = FAILOVER_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s=$&#123;TASK_META_INFO&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>FailoverServiceï¼Œå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—æœåŠ¡ã€‚</li><li><p><strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/failover/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 2] ls /elastic-job-cloud/state/failover/test_job_simple</div><div class="line">[test_job_simple@-@0]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-cloud/state/failover/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@4da72be3-43d5-4f02-9d7e-45feb30b8fcb-S2@-@8f2a5bb5-2941-4ece-b192-0f936e60faa7</div></pre></td></tr></table></figure></li><li><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ï¼š</p><p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/02.png" alt=""> </p></li></ul><h1 id="3-æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š"><a href="#3-æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š" class="headerlink" title="3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š"></a>3. æäº¤å¤±æ•ˆè½¬ç§»ä½œä¸š</h1><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚ã€</a>é‡Œï¼Œè°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šæ—¶ã€‚<code>FacadeService#getEligibleJobContext()</code> ä¸ä»…è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ï¼Œä¹Ÿè°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FailoverService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(FailoverNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// è·å– å¤±æ•ˆè½¬ç§»é˜Ÿåˆ— çš„ä½œä¸šä»¬</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(FailoverNode.ROOT);</div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   Set&lt;HashCode&gt; assignedTasks = <span class="keyword">new</span> HashSet&lt;&gt;(jobNames.size() * <span class="number">10</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="comment">// ä¸ºç©ºæ—¶ï¼Œç§»é™¤ å¤±æ•ˆè½¬ç§»é˜Ÿåˆ— çš„ä½œä¸š</span></div><div class="line">       List&lt;String&gt; taskIdList = regCenter.getChildrenKeys(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">       <span class="keyword">if</span> (taskIdList.isEmpty()) &#123;</div><div class="line">           regCenter.remove(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(FailoverNode.getFailoverJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// è·å¾—å¾…æ‰§è¡Œçš„åˆ†ç‰‡é›†åˆ</span></div><div class="line">       List&lt;Integer&gt; assignedShardingItems = getAssignedShardingItems(each, taskIdList, assignedTasks);</div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!assignedShardingItems.isEmpty() &amp;&amp; jobConfig.isPresent()) &#123;</div><div class="line">           result.add(<span class="keyword">new</span> JobContext(jobConfig.get(), assignedShardingItems, ExecutionType.FAILOVER));    </div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;Integer&gt; <span class="title">getAssignedShardingItems</span><span class="params">(<span class="keyword">final</span> String jobName, <span class="keyword">final</span> List&lt;String&gt; taskIdList, <span class="keyword">final</span> Set&lt;HashCode&gt; assignedTasks)</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(taskIdList.size());</div><div class="line">   <span class="keyword">for</span> (String each : taskIdList) &#123;</div><div class="line">       TaskContext.MetaInfo metaInfo = TaskContext.MetaInfo.from(each);</div><div class="line">       <span class="keyword">if</span> (assignedTasks.add(Hashing.md5().newHasher().putString(jobName, Charsets.UTF_8).putInt(metaInfo.getShardingItems().get(<span class="number">0</span>)).hash()) <span class="comment">// æ’é‡</span></div><div class="line">               &amp;&amp; !runningService.isTaskRunning(metaInfo)) &#123; <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­</span></div><div class="line">           result.add(metaInfo.getShardingItems().get(<span class="number">0</span>));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>é‡Œï¼Œè°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs()</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä¸€ä¸ªä½œä¸šå¯èƒ½å­˜åœ¨éƒ¨åˆ†åˆ†ç‰‡éœ€è¦å¤±æ•ˆè½¬ç§»ï¼Œä¸éœ€è¦è€ƒè™‘å®Œæ•´æ€§ã€‚</li></ul><hr><p>åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ4.7 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸šã€</a>é‡Œï¼Œè°ƒç”¨ <code>FailoverService#remove(...)</code> æ–¹æ³•ï¼Œä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> Collection&lt;TaskContext.MetaInfo&gt; metaInfoList)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (TaskContext.MetaInfo each : metaInfoList) &#123;</div><div class="line">       regCenter.remove(FailoverNode.getFailoverTaskNodePath(each.toString()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>åŸæœ¬ä»¥ä¸ºä¼šæ˜¯ä¸€ç¯‡æ°´æ›´ï¼Œåé¢ç ”ç©¶ TASK_LOSTï¼Œå‘ç°æ”¶è·å¤§å¤§çš„ï¼Œå¹²è´§å¦¥å¦¥çš„ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_10/03.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. è®°å½•ä½œä¸šå¤±æ•ˆè½¬ç§»&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-local-executor/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-local-executor/</id>
    <published>2018-01-02T16:00:00.000Z</published>
    <updated>2017-09-06T10:53:50.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. é…ç½®</a></li><li><a href="#">3. è¿è¡Œ</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud æœ¬åœ°è¿è¡Œæ¨¡å¼</strong>ï¼Œå¯¹åº”<a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/local-executor/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼ã€‹</a>ã€‚</p><p><strong>æœ‰ä»€ä¹ˆç”¨å‘¢</strong>ï¼Ÿå¼•ç”¨å®˜æ–¹è§£ç­”ï¼š</p><blockquote><p>åœ¨å¼€å‘ Elastic-Job-Cloud ä½œä¸šæ—¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è„±ç¦» Mesos ç¯å¢ƒï¼Œåœ¨æœ¬åœ°è¿è¡Œå’Œè°ƒè¯•ä½œä¸šã€‚å¯ä»¥åˆ©ç”¨æœ¬åœ°è¿è¡Œæ¨¡å¼å……åˆ†çš„è°ƒè¯•ä¸šåŠ¡åŠŸèƒ½ä»¥åŠå•å…ƒæµ‹è¯•ï¼Œå®Œæˆä¹‹åå†éƒ¨ç½²è‡³ Mesos é›†ç¾¤ã€‚<br>æœ¬åœ°è¿è¡Œä½œä¸šæ— éœ€å®‰è£… Mesos ç¯å¢ƒã€‚</p></blockquote><p>ğŸ˜ˆ æ˜¯ä¸æ˜¯å¾ˆèµ + 1024ï¼Ÿï¼</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2018_01_03/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_03/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1 id="2-é…ç½®"><a href="#2-é…ç½®" class="headerlink" title="2. é…ç½®"></a>2. é…ç½®</h1><p>LocalCloudJobConfigurationï¼Œæœ¬åœ°äº‘ä½œä¸šé…ç½®ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-local-executor/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>åˆ›å»ºæœ¬åœ°äº‘ä½œä¸šé…ç½®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜æ–¹ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">LocalCloudJobConfiguration config = <span class="keyword">new</span> LocalCloudJobConfiguration(</div><div class="line">    <span class="keyword">new</span> SimpleJobConfiguration(</div><div class="line">    <span class="comment">// é…ç½®ä½œä¸šç±»å‹å’Œä½œä¸šåŸºæœ¬ä¿¡æ¯</span></div><div class="line">    JobCoreConfiguration.newBuilder(<span class="string">"FooJob"</span>, <span class="string">"*/2 * * * * ?"</span>, <span class="number">3</span>) </div><div class="line">        .shardingItemParameters(<span class="string">"0=Beijing,1=Shanghai,2=Guangzhou"</span>)</div><div class="line">        .jobParameter(<span class="string">"dbName=dangdang"</span>).build(), <span class="string">"com.dangdang.foo.FooJob"</span>),</div><div class="line">        <span class="comment">// é…ç½®å½“å‰è¿è¡Œçš„ä½œä¸šæ˜¯ç¬¬å‡ ä¸ªåˆ†ç‰‡ </span></div><div class="line">        <span class="number">1</span>,  </div><div class="line">        <span class="comment">// é…ç½®Springç›¸å…³å‚æ•°ã€‚å¦‚æœä¸é…ç½®ï¼Œä»£è¡¨ä¸ä½¿ç”¨ Spring é…ç½®ã€‚</span></div><div class="line">        <span class="string">"testSimpleJob"</span> , <span class="string">"applicationContext.xml"</span>);</div></pre></td></tr></table></figure><h1 id="3-è¿è¡Œ"><a href="#3-è¿è¡Œ" class="headerlink" title="3. è¿è¡Œ"></a>3. è¿è¡Œ</h1><p>LocalTaskExecutorï¼Œæœ¬åœ°ä½œä¸šæ‰§è¡Œå™¨ã€‚</p><p>åˆ›å»ºæœ¬åœ°ä½œä¸šæ‰§è¡Œå™¨ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜æ–¹ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">new</span> LocalTaskExecutor(localJobConfig).execute();</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>LocalTaskExecutor#execute()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä½œä¸šé€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LocalTaskExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">   AbstractElasticJobExecutor jobExecutor;</div><div class="line">   CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(getShardingContexts(), getJobConfigurationContext(), <span class="keyword">new</span> JobEventBus());</div><div class="line">   <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">switch</span> (localCloudJobConfiguration.getTypeConfig().getJobType()) &#123;</div><div class="line">       <span class="keyword">case</span> SIMPLE:</div><div class="line">           jobExecutor = <span class="keyword">new</span> SimpleJobExecutor(getJobInstance(SimpleJob.class), jobFacade);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> DATAFLOW:</div><div class="line">           jobExecutor = <span class="keyword">new</span> DataflowJobExecutor(getJobInstance(DataflowJob.class), jobFacade);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> SCRIPT:</div><div class="line">           jobExecutor = <span class="keyword">new</span> ScriptJobExecutor(jobFacade);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>:</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(localCloudJobConfiguration.getTypeConfig().getJobType().name());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">   jobExecutor.execute();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#getShardingContexts()</code> æ–¹æ³•ï¼Œåˆ›å»ºåˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ( ShardingContexts )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   JobCoreConfiguration coreConfig = localCloudJobConfiguration.getTypeConfig().getCoreConfig();</div><div class="line">   Map&lt;Integer, String&gt; shardingItemMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   shardingItemMap.put(localCloudJobConfiguration.getShardingItem(),</div><div class="line">           <span class="keyword">new</span> ShardingItemParameters(coreConfig.getShardingItemParameters()).getMap().get(localCloudJobConfiguration.getShardingItem()));</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(</div><div class="line">           <span class="comment">// taskId ğŸ‘‡</span></div><div class="line">           Joiner.on(<span class="string">"@-@"</span>).join(localCloudJobConfiguration.getJobName(), localCloudJobConfiguration.getShardingItem(), <span class="string">"READY"</span>, <span class="string">"foo_slave_id"</span>, <span class="string">"foo_uuid"</span>),</div><div class="line">           localCloudJobConfiguration.getJobName(), coreConfig.getShardingTotalCount(), coreConfig.getJobParameter(), shardingItemMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#getJobConfigurationContext()</code> æ–¹æ³•ï¼Œåˆ›å»ºå†…éƒ¨çš„ä½œä¸šé…ç½®ä¸Šä¸‹æ–‡( JobConfigurationContext )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> JobConfigurationContext <span class="title">getJobConfigurationContext</span><span class="params">()</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; jobConfigurationMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   jobConfigurationMap.put(<span class="string">"jobClass"</span>, localCloudJobConfiguration.getTypeConfig().getJobClass());</div><div class="line">   jobConfigurationMap.put(<span class="string">"jobType"</span>, localCloudJobConfiguration.getTypeConfig().getJobType().name());</div><div class="line">   jobConfigurationMap.put(<span class="string">"jobName"</span>, localCloudJobConfiguration.getJobName());</div><div class="line">   jobConfigurationMap.put(<span class="string">"beanName"</span>, localCloudJobConfiguration.getBeanName());</div><div class="line">   jobConfigurationMap.put(<span class="string">"applicationContext"</span>, localCloudJobConfiguration.getApplicationContext());</div><div class="line">   <span class="keyword">if</span> (JobType.DATAFLOW == localCloudJobConfiguration.getTypeConfig().getJobType()) &#123; <span class="comment">// æ•°æ®æµä½œä¸š</span></div><div class="line">       jobConfigurationMap.put(<span class="string">"streamingProcess"</span>, Boolean.toString(((DataflowJobConfiguration) localCloudJobConfiguration.getTypeConfig()).isStreamingProcess()));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JobType.SCRIPT == localCloudJobConfiguration.getTypeConfig().getJobType()) &#123; <span class="comment">// è„šæœ¬ä½œä¸š</span></div><div class="line">       jobConfigurationMap.put(<span class="string">"scriptCommandLine"</span>, ((ScriptJobConfiguration) localCloudJobConfiguration.getTypeConfig()).getScriptCommandLine());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JobConfigurationContext(jobConfigurationMap);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#getJobInstance(...)</code> æ–¹æ³•ï¼Œ è·å¾—åˆ†å¸ƒå¼ä½œä¸š( ElasticJob )å®ç°å®ä¾‹ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T extends ElasticJob&gt; <span class="function">T <span class="title">getJobInstance</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; clazz)</span> </span>&#123;</div><div class="line">   Object result;</div><div class="line">   <span class="keyword">if</span> (Strings.isNullOrEmpty(localCloudJobConfiguration.getApplicationContext())) &#123; <span class="comment">// ç›´æ¥åˆ›å»º ElasticJob</span></div><div class="line">       String jobClass = localCloudJobConfiguration.getTypeConfig().getJobClass();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           result = Class.forName(jobClass).newInstance();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' initialize failure, the error message is '%s'."</span>, jobClass, ex.getMessage());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// Spring ç¯å¢ƒè·å¾— ElasticJob</span></div><div class="line">       result = <span class="keyword">new</span> ClassPathXmlApplicationContext(localCloudJobConfiguration.getApplicationContext()).getBean(localCloudJobConfiguration.getBeanName());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> clazz.cast(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>AbstractElasticJobExecutor#execute()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä½œä¸šé€»è¾‘ã€‚ Elastic-Job-Lite å’Œ Elastic-Job-Cloud ä½œä¸šæ‰§è¡ŒåŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šå¯èƒ½æœ‰ç‚¹æ°´æ›´ï¼Œå’Œå¤§å®¶å®é™…å¼€å‘å¤ªç›¸å…³ï¼Œæƒ³æƒ³è¿˜æ˜¯æ›´æ–°ä¸‹ã€‚<br>æ—ç™½å›ï¼šå“å“Ÿå“Ÿï¼Œå“å“Ÿå–‚ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2018_01_03/02.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3. è¿
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/</id>
    <published>2017-12-27T16:00:00.000Z</published>
    <updated>2017-09-16T04:53:59.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‘ä½œä¸šæ“ä½œ</a><ul><li><a href="#">2.1 æ³¨å†Œäº‘ä½œä¸šé…ç½®</a></li><li><a href="#">2.2 ç¦ç”¨äº‘ä½œä¸š</a></li><li><a href="#">2.3 å¯åŠ¨äº‘ä½œä¸š</a></li><li><a href="#">2.4 æ›´æ–°äº‘ä½œä¸šé…ç½®</a></li><li><a href="#">2.5 æ³¨é”€äº‘ä½œä¸š</a></li><li><a href="#">2.6 è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š</a></li></ul></li><li><a href="#">3. äº‘ä½œä¸šåº”ç”¨æ“ä½œ</a><ul><li><a href="#">3.1 æ³¨å†Œäº‘ä½œä¸šåº”ç”¨</a></li><li><a href="#">3.2 æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®</a></li><li><a href="#">3.3 ç¦ç”¨äº‘ä½œä¸šåº”ç”¨</a></li><li><a href="#">3.4 å¯ç”¨äº‘ä½œä¸šåº”ç”¨</a></li><li><a href="#">3.5 æ³¨é”€äº‘ä½œä¸šåº”ç”¨</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud äº‘ä½œä¸šåº”ç”¨é…ç½®å’Œäº‘ä½œä¸šé…ç½®å˜æ›´å¯¹ä½œä¸šè°ƒåº¦çš„å½±å“</strong>ï¼Œä½œä¸º<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>çš„è¡¥å……å†…å®¹ã€‚æ‰€ä»¥éœ€è¦ä½ å¯¹<strong>ä½œä¸šè°ƒåº¦</strong>å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŸºç¡€ä¸Šã€‚</p><p>ğŸ™‚ å¦‚æœä½ åšä½œä¸šè°ƒåº¦æœ‰ä»»ä½•æƒ³äº¤æµï¼Œæ¬¢è¿åŠ æˆ‘çš„å…¬ä¼—å·( èŠ‹é“æºç  ) æˆ– å¾®ä¿¡( wangwenbin-server ) äº¤æµã€‚</p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1 id="2-äº‘ä½œä¸šæ“ä½œ"><a href="#2-äº‘ä½œä¸šæ“ä½œ" class="headerlink" title="2. äº‘ä½œä¸šæ“ä½œ"></a>2. äº‘ä½œä¸šæ“ä½œ</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>æˆ– Restful API å¯¹äº‘ä½œä¸šè¿›è¡Œæ“ä½œã€‚å‰è€…æ˜¯å¯¹åè€…çš„ç•Œé¢åŒ…è£…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_28/01.png" alt=""></p><h2 id="2-1-æ³¨å†Œäº‘ä½œä¸šé…ç½®"><a href="#2-1-æ³¨å†Œäº‘ä½œä¸šé…ç½®" class="headerlink" title="2.1 æ³¨å†Œäº‘ä½œä¸šé…ç½®"></a>2.1 æ³¨å†Œäº‘ä½œä¸šé…ç½®</h2><p><a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><h2 id="2-2-ç¦ç”¨äº‘ä½œä¸š"><a href="#2-2-ç¦ç”¨äº‘ä½œä¸š" class="headerlink" title="2.2 ç¦ç”¨äº‘ä½œä¸š"></a>2.2 ç¦ç”¨äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#disable(...)</code> æ–¹æ³•ï¼Œç¦ç”¨äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;jobName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">(@PathParam(<span class="string">"jobName"</span>)</span> <span class="keyword">final</span> String jobName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (configService.load(jobName).isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†ä½œä¸šæ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       facadeService.disableJob(jobName);</div><div class="line">       <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">       producerManager.unschedule(jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FacadeService#disableJob(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šæ”¾å…¥<strong>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disableJob</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   disableJobService.add(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(DisableJobNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add disable job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä½œä¸šæ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">   String disableJobNodePath = DisableJobNode.getDisableJobNodePath(jobName);</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(disableJobNodePath)) &#123;</div><div class="line">       regCenter.persist(disableJobNodePath, jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableJobNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/disable/job"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISABLE_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>DisableJobServiceï¼Œç¦ç”¨ä½œä¸šé˜Ÿåˆ—æœåŠ¡ã€‚</li><li><p>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/disable/job/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä½œä¸šåç§°ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š </p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 6] ls /elastic-job-cloud/state/disable/job</div><div class="line">[test_job_simple]</div></pre></td></tr></table></figure></li></ul></li><li><p>è°ƒç”¨ <code>ProducerManager#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢è°ƒåº¦ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unschedule</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ€æ­»ä½œä¸šå¯¹åº”çš„ Mesos ä»»åŠ¡ä»¬</span></div><div class="line">   <span class="keyword">for</span> (TaskContext each : runningService.getRunningTasks(jobName)) &#123;</div><div class="line">       schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(each.getId()).build());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä½œä¸šä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   runningService.remove(jobName);</div><div class="line">   <span class="comment">// å°†ä½œä¸šä»å¾…è¿è¡Œé˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   readyService.remove(Lists.newArrayList(jobName));</div><div class="line">   <span class="comment">// åœæ­¢ä½œä¸šè°ƒåº¦</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       transientProducerScheduler.deregister(jobConfig.get());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>SchedulerDriver#killTask(...)</code> æ–¹æ³•ï¼Œæ€æ­»ä½œä¸šå¯¹åº”çš„ Mesos ä»»åŠ¡ä»¬ï¼Œé€‚ç”¨<strong>å¸¸é©»ä½œä¸š</strong>ã€‚Elastic-Job-Cloud-Scheduler ä¼šæ¥æ”¶åˆ° Mesos æ€æ­»ä»»åŠ¡çš„è¯·æ±‚ï¼Œè°ƒç”¨ <code>TaskExecutor#killTask(...)</code> æ–¹æ³•ï¼Œåœæ­¢ä»»åŠ¡è°ƒåº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskExecutor.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">killTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskID taskID)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²æ€æ­»ã€‚</span></div><div class="line">        executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskID).setState(Protos.TaskState.TASK_KILLED).build());</div><div class="line">        <span class="comment">// å…³é—­è¯¥ Mesos ä»»åŠ¡çš„è°ƒåº¦</span></div><div class="line">        DaemonTaskScheduler.shutdown(taskID);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åœæ­¢ä»»åŠ¡è°ƒåº¦.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskID ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">final</span> Protos.TaskID taskID)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤ä»»åŠ¡çš„ Quartz Scheduler</span></div><div class="line">   Scheduler scheduler = RUNNING_SCHEDULERS.remove(taskID.getValue());</div><div class="line">   <span class="comment">// å…³é—­ä»»åŠ¡çš„ Quartz Scheduler</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != scheduler) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           scheduler.shutdown();</div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li></li></ul></li><li><p>è°ƒç”¨ <code>RunningService#remove(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šä»<strong>è¿è¡Œæ—¶é˜Ÿåˆ—</strong>åˆ é™¤ã€‚</p></li><li>è°ƒç”¨ <code>ReadyService#remove(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šä»<strong>å¾…è¿è¡Œé˜Ÿåˆ—</strong>åˆ é™¤ã€‚</li><li><p>è°ƒç”¨ <code>TransientProducerScheduler#deregister(...)</code> æ–¹æ³•ï¼Œåœæ­¢ä½œä¸šè°ƒåº¦ï¼Œé€‚ç”¨<strong>ç¬æ—¶ä½œä¸š</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç§»é™¤ä½œä¸š</span></div><div class="line">    repository.remove(jobConfig.getJobName());</div><div class="line">    <span class="comment">// è‹¥ cron ä¸å†å¯¹åº”æœ‰ä½œä¸šè°ƒåº¦ï¼Œç§»é™¤ Quartz Scheduler å¯¹ cron å¯¹åº”çš„ Quartz Job</span></div><div class="line">    String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">    <span class="keyword">if</span> (!repository.containsKey(buildJobKey(cron))) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            scheduler.unscheduleJob(TriggerKey.triggerKey(cron));</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><h2 id="2-3-å¯åŠ¨äº‘ä½œä¸š"><a href="#2-3-å¯åŠ¨äº‘ä½œä¸š" class="headerlink" title="2.3 å¯åŠ¨äº‘ä½œä¸š"></a>2.3 å¯åŠ¨äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#enable(...)</code> æ–¹æ³•ï¼Œå¯ç”¨äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;jobName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">(@PathParam(<span class="string">"jobName"</span>)</span> <span class="keyword">final</span> String jobName) <span class="keyword">throws</span> JSONException </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; configOptional = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (configOptional.isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†ä½œä¸šç§»å‡ºç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       facadeService.enableJob(jobName);</div><div class="line">       <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">       producerManager.reschedule(jobName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FacadeService#enableJob(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šç§»å‡º<strong>ç¦ç”¨ä½œä¸šé˜Ÿåˆ—</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enableJob</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   disableJobService.remove(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableJobService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   regCenter.remove(DisableJobNode.getDisableJobNodePath(jobName));</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>ProducerManager#reschedule(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šé‡æ–°è°ƒåº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">   unschedule(jobName);</div><div class="line">   <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       schedule(jobConfig.get());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢è°ƒåº¦ä½œä¸šã€‚</li><li>è°ƒç”¨ <code>#schedule(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä½œä¸šï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2 id="2-4-æ›´æ–°äº‘ä½œä¸šé…ç½®"><a href="#2-4-æ›´æ–°äº‘ä½œä¸šé…ç½®" class="headerlink" title="2.4 æ›´æ–°äº‘ä½œä¸šé…ç½®"></a>2.4 æ›´æ–°äº‘ä½œä¸šé…ç½®</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#update(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‘ä½œä¸šé…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="meta">@PUT</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/update"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   producerManager.update(jobConfig);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigFromZk = configService.load(jobConfig.getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigFromZk.isPresent()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Cannot found job '%s', please register first."</span>, jobConfig.getJobName());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä¿®æ”¹äº‘ä½œä¸šé…ç½®</span></div><div class="line">   configService.update(jobConfig);</div><div class="line">   <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">   reschedule(jobConfig.getJobName());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>ConfigService#update(jobConfig)</code> æ–¹æ³•ï¼Œä¿®æ”¹äº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   regCenter.update(CloudJobConfigurationNode.getRootNodePath(jobConfig.getJobName()), CloudJobConfigurationGsonFactory.toJson(jobConfig));</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚æ­¤å¤„çš„è°ƒç”¨æ˜¯é‡å¤çš„ï¼Œå®é™…åªéœ€ CloudJobConfigurationListener ç›‘å¬åˆ°é…ç½®å˜åŒ–ï¼Œè°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•å³å¯ã€‚</p></li></ul><p>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„ äº‘ä½œä¸šé…ç½®è¢«æ›´æ–°æ—¶ï¼Œäº‘ä½œä¸šé…ç½®å˜æ›´ç›‘å¬( CloudJobConfigurationListener )ä¼šç›‘å¬åˆ°ï¼Œå¹¶æ‰§è¡Œæ›´æ–°ç›¸åº”é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationListener</span> <span class="keyword">implements</span> <span class="title">TreeCacheListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String path = <span class="keyword">null</span> == event.getData() ? <span class="string">""</span> : event.getData().getPath();</div><div class="line">        <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_ADDED)) &#123;</div><div class="line">            <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_UPDATED)) &#123;</div><div class="line">            CloudJobConfiguration jobConfig = getJobConfig(event);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == jobConfig) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä½œä¸š</span></div><div class="line">            <span class="keyword">if</span> (CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123;</div><div class="line">                readyService.remove(Collections.singletonList(jobConfig.getJobName()));</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// è®¾ç½®ç¦ç”¨é”™è¿‡é‡æ‰§è¡Œ</span></div><div class="line">            <span class="keyword">if</span> (!jobConfig.getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">                readyService.setMisfireDisabled(jobConfig.getJobName());</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// é‡æ–°è°ƒåº¦ä½œä¸š</span></div><div class="line">            producerManager.reschedule(jobConfig.getJobName());</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_REMOVED)) &#123;</div><div class="line">            <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>CloudJobConfigurationListener å®ç° TreeCacheListener å®ç°å¯¹ Zookeeper æ•°æ®å˜æ›´çš„ç›‘å¬ã€‚å¯¹ TreeCacheListener æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="https://curator.apache.org/" rel="external nofollow noopener noreferrer" target="_blank">Apache Curator</a> ç›¸å…³çŸ¥è¯†ã€‚</li><li>è°ƒç”¨ <code>ReadyService#remove(...)</code> æ–¹æ³•ï¼Œå°†ä½œä¸šä»<strong>å¾…è¿è¡Œé˜Ÿåˆ—</strong>åˆ é™¤ã€‚TODOï¼Œä¸ºå•¥è¦åˆ é™¤ï¼Ÿ</li><li><p>è°ƒç”¨ <code>ReadyService#setMisfireDisabled(...)</code> æ–¹æ³•ï¼Œè®¾ç½®ç¦ç”¨é”™è¿‡é‡æ‰§è¡Œã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMisfireDisabled</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (cloudJobConfig.isPresent() &amp;&amp; <span class="keyword">null</span> != regCenter.getDirectly(ReadyNode.getReadyJobNodePath(jobName))) &#123;</div><div class="line">       regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ç¬æ—¶ä½œä¸š</strong>å¼€å¯ <code>misfire</code> åŠŸèƒ½æ—¶ï¼Œå½“ä»»åŠ¡æ‰§è¡Œè¿‡ä¹…è§¦å‘ <code>misifre</code> ä¼šä¸æ–­ç´¯ç§¯å¾…æ‰§è¡Œæ¬¡æ•°ã€‚å¦‚æœå…³é—­ <code>misfire</code> åŠŸèƒ½ï¼Œéœ€è¦å°†å¤šæ¬¡æ‰§è¡Œæ¬¡æ•°å½’ <code>&quot;1&quot;</code>ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>ProducerManager#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚</p></li></ul><h2 id="2-5-æ³¨é”€äº‘ä½œä¸š"><a href="#2-5-æ³¨é”€äº‘ä½œä¸š" class="headerlink" title="2.5 æ³¨é”€äº‘ä½œä¸š"></a>2.5 æ³¨é”€äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#deregister(...)</code> æ–¹æ³•ï¼Œæ³¨é”€äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/deregister"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   producerManager.deregister(jobName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (jobConfig.isPresent()) &#123;</div><div class="line">       <span class="comment">//  ä»ä½œä¸šç¦ç”¨é˜Ÿåˆ—ä¸­åˆ é™¤ä½œä¸š</span></div><div class="line">       disableJobService.remove(jobName);</div><div class="line">       <span class="comment">// åˆ é™¤äº‘ä½œä¸š</span></div><div class="line">       configService.remove(jobName);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åœæ­¢è°ƒåº¦ä½œä¸š</span></div><div class="line">   unschedule(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>DisableJobService#remove(...)</code> æ–¹æ³•ï¼Œä»<strong>ä½œä¸šç¦ç”¨é˜Ÿåˆ—</strong>ä¸­åˆ é™¤ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   regCenter.remove(DisableJobNode.getDisableJobNodePath(jobName));</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>CloudJobConfigurationService#remove(...)</code> æ–¹æ³•ï¼Œåˆ é™¤äº‘ä½œä¸šé…ç½®ã€‚ </p></li><li><p>è°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚</p></li></ul><p>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„ äº‘ä½œä¸šé…ç½®è¢«åˆ é™¤æ—¶ï¼Œ<strong>äº‘ä½œä¸šé…ç½®å˜æ›´ç›‘å¬å™¨</strong>( CloudJobConfigurationListener )ä¼šç›‘å¬åˆ°ï¼Œå¹¶æ‰§è¡Œåˆ é™¤ç›¸åº”é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationListener</span> <span class="keyword">implements</span> <span class="title">TreeCacheListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorRegistryCenter regCenter;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProducerManager producerManager;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadyService readyService;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CloudJobConfigurationListener</span><span class="params">(<span class="keyword">final</span> CoordinatorRegistryCenter regCenter, <span class="keyword">final</span> ProducerManager producerManager)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.regCenter = regCenter;</div><div class="line">        readyService = <span class="keyword">new</span> ReadyService(regCenter);</div><div class="line">        <span class="keyword">this</span>.producerManager = producerManager;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(<span class="keyword">final</span> CuratorFramework client, <span class="keyword">final</span> TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String path = <span class="keyword">null</span> == event.getData() ? <span class="string">""</span> : event.getData().getPath();</div><div class="line">        <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_ADDED)) &#123;</div><div class="line">            <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_UPDATED)) &#123;</div><div class="line">            <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isJobConfigNode(event, path, Type.NODE_REMOVED)) &#123;</div><div class="line">            String jobName = path.substring(CloudJobConfigurationNode.ROOT.length() + <span class="number">1</span>, path.length());</div><div class="line">            producerManager.unschedule(jobName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#reschedule(...)</code> æ–¹æ³•ï¼Œé‡æ–°è°ƒåº¦ä½œä¸šã€‚</li></ul><h2 id="2-6-è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š"><a href="#2-6-è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š" class="headerlink" title="2.6 è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š"></a>2.6 è§¦å‘ä¸€æ¬¡äº‘ä½œä¸š</h2><p>è°ƒç”¨ <code>CloudJobRestfulApi#trigger(...)</code> æ–¹æ³•ï¼Œè§¦å‘ä¸€æ¬¡äº‘ä½œä¸šï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/trigger"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trigger</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">// å¸¸é©»ä½œä¸šä¸å…è®¸è§¦å‘ä¸€æ¬¡ä½œä¸š</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; config = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (config.isPresent() &amp;&amp; CloudJobExecutionType.DAEMON == config.get().getJobExecutionType()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Daemon job '%s' cannot support trigger."</span>, jobName);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ç¬æ—¶ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   facadeService.addTransient(jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç›®å‰<strong>å¸¸é©»</strong>ä½œä¸š<strong>ä¸æ”¯æŒ</strong>è§¦å‘ä¸€æ¬¡äº‘ä½œä¸šã€‚å¦‚æœæƒ³å®ç°è¯¥åŠŸèƒ½ï¼Œéœ€è¦ Elastic-Job-Cloud-Scheduler é€šè¿‡ Mesos å‘é€è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œé€šçŸ¥ Elastic-Job-Cloud-Executor è§¦å‘è¯¥ä½œä¸šå¯¹åº”çš„ä»»åŠ¡ä»¬ã€‚</li><li>è°ƒç”¨ <code>FacadeService#addTransient(...)</code> æ–¹æ³•ï¼Œå°†ç¬æ—¶ä½œä¸šæ”¾å…¥<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ã€‚å½“ä¸”ä»…å½“äº‘ä½œä¸šé…ç½® <code>JobCoreConfiguration.misfire = true</code> æ—¶ï¼Œè¯¥ä½œä¸šåœ¨<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>çš„æ‰§è¡Œæ¬¡æ•°ä¸æ–­ç´¯ç§¯åŠ ä¸€ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹ã€Œ3.2.3 ProducerJobã€</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul><h1 id="3-äº‘ä½œä¸šåº”ç”¨æ“ä½œ"><a href="#3-äº‘ä½œä¸šåº”ç”¨æ“ä½œ" class="headerlink" title="3. äº‘ä½œä¸šåº”ç”¨æ“ä½œ"></a>3. äº‘ä½œä¸šåº”ç”¨æ“ä½œ</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>è¿ç»´å¹³å°</strong>æˆ– Restful API å¯¹äº‘ä½œä¸šåº”ç”¨è¿›è¡Œæ“ä½œã€‚å‰è€…æ˜¯å¯¹åè€…çš„ç•Œé¢åŒ…è£…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_28/02.png" alt=""></p><h2 id="3-1-æ³¨å†Œäº‘ä½œä¸šåº”ç”¨"><a href="#3-1-æ³¨å†Œäº‘ä½œä¸šåº”ç”¨" class="headerlink" title="3.1 æ³¨å†Œäº‘ä½œä¸šåº”ç”¨"></a>3.1 æ³¨å†Œäº‘ä½œä¸šåº”ç”¨</h2><p><a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹ã€Œ2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</p><h2 id="3-2-æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®"><a href="#3-2-æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®" class="headerlink" title="3.2 æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®"></a>3.2 æ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#update(...)</code> æ–¹æ³•ï¼Œæ›´æ–°äº‘ä½œä¸šåº”ç”¨é…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi.java</span></div><div class="line"><span class="meta">@PUT</span></div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   appConfigService.update(appConfig);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   regCenter.update(CloudAppConfigurationNode.getRootNodePath(appConfig.getAppName()), CloudAppConfigurationGsonFactory.toJson(appConfig));</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-3-ç¦ç”¨äº‘ä½œä¸šåº”ç”¨"><a href="#3-3-ç¦ç”¨äº‘ä½œä¸šåº”ç”¨" class="headerlink" title="3.3 ç¦ç”¨äº‘ä½œä¸šåº”ç”¨"></a>3.3 ç¦ç”¨äº‘ä½œä¸šåº”ç”¨</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#disable(...)</code> æ–¹æ³•ï¼Œç¦ç”¨äº‘ä½œä¸šåº”ç”¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;appName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">(@PathParam(<span class="string">"appName"</span>)</span> <span class="keyword">final</span> String appName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (appConfigService.load(appName).isPresent()) &#123;</div><div class="line">       <span class="comment">// å°†åº”ç”¨æ”¾å…¥ç¦ç”¨é˜Ÿåˆ—</span></div><div class="line">       disableAppService.add(appName);</div><div class="line">       <span class="comment">// åœæ­¢åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„è°ƒåº¦</span></div><div class="line">       <span class="keyword">for</span> (CloudJobConfiguration each : jobConfigService.loadAll()) &#123;</div><div class="line">           <span class="keyword">if</span> (appName.equals(each.getAppName())) &#123;</div><div class="line">               producerManager.unschedule(each.getJobName());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>DisableAppService#add(...)</code> æ–¹æ³•ï¼Œå°†åº”ç”¨æ”¾å…¥<strong>ç¦ç”¨åº”ç”¨é˜Ÿåˆ—</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DisableAppService.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableAppService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (regCenter.getNumChildren(DisableAppNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">            log.warn(<span class="string">"Cannot add disable app, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        String disableAppNodePath = DisableAppNode.getDisableAppNodePath(appName);</div><div class="line">        <span class="keyword">if</span> (!regCenter.isExisted(disableAppNodePath)) &#123;</div><div class="line">            regCenter.persist(disableAppNodePath, appName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableAppNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableAppNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/disable/app"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISABLE_APP = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;APP_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>DisableAppServiceï¼Œç¦ç”¨åº”ç”¨é˜Ÿåˆ—æœåŠ¡ã€‚</li><li><p>ç¦ç”¨åº”ç”¨é˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/disable/app/${APP_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºåº”ç”¨åã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š </p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 6] ls /elastic-job-cloud/state/disable/app</div><div class="line">[example_app]</div></pre></td></tr></table></figure></li></ul></li><li><p>éå†åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šï¼Œè°ƒç”¨ <code>ProducerManager#unschedule(...)</code> æ–¹æ³•ï¼Œåœæ­¢ä½œä¸šè°ƒåº¦ã€‚</p></li></ul><h2 id="3-4-å¯ç”¨äº‘ä½œä¸šåº”ç”¨"><a href="#3-4-å¯ç”¨äº‘ä½œä¸šåº”ç”¨" class="headerlink" title="3.4 å¯ç”¨äº‘ä½œä¸šåº”ç”¨"></a>3.4 å¯ç”¨äº‘ä½œä¸šåº”ç”¨</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#enable(...)</code> æ–¹æ³•ï¼Œå¯ç”¨äº‘ä½œä¸šåº”ç”¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi.java</span></div><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;appName&#125;/disable"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">(@PathParam(<span class="string">"appName"</span>)</span> <span class="keyword">final</span> String appName) <span class="keyword">throws</span> JSONException </span>&#123;</div><div class="line">   <span class="keyword">if</span> (appConfigService.load(appName).isPresent()) &#123;</div><div class="line">       <span class="comment">// ä»ç¦ç”¨åº”ç”¨é˜Ÿåˆ—ä¸­åˆ é™¤åº”ç”¨</span></div><div class="line">       disableAppService.remove(appName);</div><div class="line">       <span class="comment">// é‡æ–°å¼€å¯åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„è°ƒåº¦</span></div><div class="line">       <span class="keyword">for</span> (CloudJobConfiguration each : jobConfigService.loadAll()) &#123;</div><div class="line">           <span class="keyword">if</span> (appName.equals(each.getAppName())) &#123;</div><div class="line">               producerManager.reschedule(each.getJobName());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DisableAppService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">   regCenter.remove(DisableAppNode.getDisableAppNodePath(appName));</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-5-æ³¨é”€äº‘ä½œä¸šåº”ç”¨"><a href="#3-5-æ³¨é”€äº‘ä½œä¸šåº”ç”¨" class="headerlink" title="3.5 æ³¨é”€äº‘ä½œä¸šåº”ç”¨"></a>3.5 æ³¨é”€äº‘ä½œä¸šåº”ç”¨</h2><p>è°ƒç”¨ <code>CloudAppRestfulApi#deregister(...)</code> æ–¹æ³•ï¼Œæ³¨é”€äº‘ä½œä¸šåº”ç”¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@DELETE</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/&#123;appName&#125;"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(@PathParam(<span class="string">"appName"</span>)</span> <span class="keyword">final</span> String appName) </span>&#123;</div><div class="line">   <span class="keyword">if</span> (appConfigService.load(appName).isPresent()) &#123;</div><div class="line">       <span class="comment">// ç§»é™¤åº”ç”¨å’Œåº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„é…ç½®</span></div><div class="line">       removeAppAndJobConfigurations(appName);</div><div class="line">       <span class="comment">// åœæ­¢åº”ç”¨å¯¹åº”çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )</span></div><div class="line">       stopExecutors(appName);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#removeAppAndJobConfigurations(...)</code> æ–¹æ³•ï¼Œç§»é™¤åº”ç”¨å’Œåº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„é…ç½®ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeAppAndJobConfigurations</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ³¨é”€(ç§»é™¤)åº”ç”¨å¯¹åº”æ‰€æœ‰ä½œä¸šçš„é…ç½®</span></div><div class="line">   <span class="keyword">for</span> (CloudJobConfiguration each : jobConfigService.loadAll()) &#123;</div><div class="line">       <span class="keyword">if</span> (appName.equals(each.getAppName())) &#123;</div><div class="line">           producerManager.deregister(each.getJobName());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»ç¦ç”¨åº”ç”¨é˜Ÿåˆ—ä¸­åˆ é™¤åº”ç”¨</span></div><div class="line">   disableAppService.remove(appName);</div><div class="line">   <span class="comment">// åˆ é™¤äº‘ä½œä¸šAppé…ç½®</span></div><div class="line">   appConfigService.remove(appName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#stopExecutors(...)</code> æ–¹æ³•ï¼Œåœæ­¢åº”ç”¨å¯¹åº”çš„æ‰§è¡Œå™¨( Elastic-Job-Cloud-Scheduler )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopExecutors</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       Collection&lt;ExecutorStateInfo&gt; executorBriefInfo = mesosStateService.executors(appName);</div><div class="line">       <span class="keyword">for</span> (ExecutorStateInfo each : executorBriefInfo) &#123;</div><div class="line">           producerManager.sendFrameworkMessage(ExecutorID.newBuilder().setValue(each.getId()).build(),</div><div class="line">                   SlaveID.newBuilder().setValue(each.getSlaveId()).build(), <span class="string">"STOP"</span>.getBytes());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSONException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java </span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFrameworkMessage</span><span class="params">(<span class="keyword">final</span> ExecutorID executorId, <span class="keyword">final</span> SlaveID slaveId, <span class="keyword">final</span> <span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">    schedulerDriver.sendFrameworkMessage(executorId, slaveId, data);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>SchedulerDriver#sendFrameworkMessage(...)</code> æ–¹æ³•ï¼Œé€šè¿‡ Mesos å‘äº‘ä½œä¸šåº”ç”¨å¯¹åº”çš„æ‰§è¡Œå™¨ä»¬( Elastic-Job-Cloud-Executor ) å‘é€æ¶ˆæ¯ä¸º <code>&quot;STOP&quot;</code> ä»è€Œå…³é—­æ‰§è¡Œå™¨ã€‚Elastic-Job-Cloud-Executor ä¼šæ¥æ”¶åˆ° Mesos æ¶ˆæ¯ï¼Œè°ƒç”¨ <code>TaskExecutor#frameworkMessage(...)</code> æ–¹æ³•ï¼Œå…³é—­è‡ªå·±ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">frameworkMessage</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != bytes &amp;&amp; <span class="string">"STOP"</span>.equals(<span class="keyword">new</span> String(bytes))) &#123;</div><div class="line">        log.error(<span class="string">"call frameworkMessage executor stopped."</span>);</div><div class="line">        executorDriver.stop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>Elastic-Job-Cloud ä½œä¸šè°ƒåº¦ä¸¤ç¯‡å†…å®¹åˆ°æ­¤å°±ç»“æŸå•¦ã€‚åç»­æˆ‘ä»¬ä¼šæ›´æ–°å¤§å®¶å…³å¿ƒçš„<a href="http://www.iocoder.cn/Elastic-Job/cloud-high-availability/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” é«˜å¯ç”¨ã€‹</a>æ˜¯å¦‚ä½•å®ç°çš„å™¢ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_28/03.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‘ä½œä¸šæ“ä½œ&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2.
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/</id>
    <published>2017-12-20T16:00:00.000Z</published>
    <updated>2017-09-07T15:54:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. ä½œä¸šæ‰§è¡Œç±»å‹</a></li><li><a href="#">3. Producer å‘å¸ƒä»»åŠ¡</a><ul><li><a href="#">3.1 å¸¸é©»ä½œä¸š</a></li><li><a href="#">3.2 ç¬æ—¶ä½œä¸š</a><ul><li><a href="#">3.2.1 TransientProducerScheduler</a></li><li><a href="#">3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</a></li><li><a href="#">3.2.3 ProducerJob</a></li></ul></li><li><a href="#">3.3 å°ç»“</a></li></ul></li><li><a href="#">4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</a><ul><li><a href="#">4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</a></li><li><a href="#">4.2 AppConstraintEvaluator</a></li><li><a href="#">4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</a></li><li><a href="#">4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</a><ul><li><a href="#">4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</a></li></ul></li><li><a href="#">4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</a></li><li><a href="#">4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</a></li><li><a href="#">4.7 æäº¤ä»»åŠ¡ç»™ Mesos</a></li></ul></li><li><a href="#">5. TaskExecutor æ‰§è¡Œä»»åŠ¡</a><ul><li><a href="#">5.1 TaskThread</a></li><li><a href="#">5.2 DaemonTaskScheduler</a></li></ul></li><li><a href="#">6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</a></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud è°ƒåº¦ä¸»æµç¨‹</strong>ã€‚å¯¹åº”åˆ° Elastic-Job-Lite æºç è§£ææ–‡ç« å¦‚ä¸‹ï¼š</p><ul><li><a href="http://www.iocoder.cn/Elastic-Job/job-init/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆå§‹åŒ–ã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šåˆ†ç‰‡ã€‹</a></li></ul><p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p><ul><li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li><li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li></ul><p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.iocoder.cn/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/01.png" alt=""></p><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><p>Elastic-Job-Cloud åŸºäº Mesos å®ç°åˆ†å¸ƒå¼ä½œä¸šè°ƒåº¦ï¼Œæˆ–è€…è¯´ Elastic-Job-Cloud æ˜¯ Mesos ä¸Šçš„ æ¡†æ¶( Framework )ã€‚</p><p>ä¸€ä¸ª Mesos æ¡†æ¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æ§åˆ¶å™¨éƒ¨åˆ†ï¼Œç§°ä¸ºè°ƒåº¦å™¨( Scheduler )ã€‚</li><li>å·¥ä½œå•å…ƒéƒ¨åˆ†ï¼Œç§°ä¸ºæ‰§è¡Œå™¨( Executor )ã€‚</li></ul><p>Elastic-Job-Cloud ç”±ä¸¤ä¸ªé¡¹ç›®ç»„æˆï¼š</p><ul><li>Elastic-Job-Cloud-Schedulerï¼Œå®ç°è°ƒåº¦å™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚</li><li>Elastic-Job-Cloud-Executorï¼Œå®ç°æ‰§è¡Œå™¨ï¼Œå®ç°ç±»ä¸º <code>com.dangdang.ddframe.job.cloud.executor.TaskExecutor</code>ã€‚</li></ul><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/11.png" alt=""></p><p>æœ¬æ–‡ç•¥å¾®<strong>â€œå•°å—¦â€</strong>ï¼Œè¯·ä¿æŒ<strong>è€å¿ƒ</strong>ã€‚æ­é…<a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a>ä¸€èµ·é˜…è¯»ï¼Œç†è§£éš¾åº¦é™ä½ 99%ã€‚OKï¼Œå¼€å§‹æˆ‘ä»¬çš„ Cloud ä¹‹æ—…ã€‚</p><h1 id="2-ä½œä¸šæ‰§è¡Œç±»å‹"><a href="#2-ä½œä¸šæ‰§è¡Œç±»å‹" class="headerlink" title="2. ä½œä¸šæ‰§è¡Œç±»å‹"></a>2. ä½œä¸šæ‰§è¡Œç±»å‹</h1><p>åœ¨ Elastic-Job-Cloudï¼Œä½œä¸šæ‰§è¡Œåˆ†æˆä¸¤ç§ç±»å‹ï¼š</p><ul><li>å¸¸é©»ä½œä¸š</li></ul><blockquote><p>å¸¸é©»ä½œä¸šæ˜¯ä½œä¸šä¸€æ—¦å¯åŠ¨ï¼Œæ— è®ºè¿è¡Œä¸å¦å‡å ç”¨ç³»ç»Ÿèµ„æºï¼›<br>å¸¸é©»ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´é•¿ã€è§¦å‘é—´éš”çŸ­ã€å®æ—¶æ€§è¦æ±‚é«˜çš„ä½œä¸šï¼Œè¦æ±‚èµ„æºé…å¤‡å……è¶³ã€‚</p></blockquote><ul><li>ç¬æ—¶ä½œä¸š</li></ul><blockquote><p>ç¬æ—¶ä½œä¸šæ˜¯åœ¨ä½œä¸šå¯åŠ¨æ—¶å ç”¨èµ„æºï¼Œè¿è¡Œå®Œæˆåé‡Šæ”¾èµ„æºã€‚<br>ç¬æ—¶ä½œä¸šé€‚åˆåˆå§‹åŒ–æ—¶é—´çŸ­ã€è§¦å‘é—´éš”é•¿ã€å…è®¸å»¶è¿Ÿçš„ä½œä¸šï¼Œä¸€èˆ¬ç”¨äºèµ„æºä¸å¤ªå……åˆ†ï¼Œæˆ–ä½œä¸šè¦æ±‚çš„èµ„æºå¤šï¼Œé€‚åˆèµ„æºé”™å³°ä½¿ç”¨çš„åœºæ™¯ã€‚</p></blockquote><p>Elastic-Job-Cloud ä¸åŒäº Elastic-Job-Lite å»ä¸­å¿ƒåŒ–æ‰§è¡Œè°ƒåº¦ï¼Œè½¬å˜ä¸º <strong>Mesos Framework çš„ä¸­å¿ƒèŠ‚ç‚¹è°ƒåº¦</strong>ã€‚è¿™é‡Œä¸å¤ªç†è§£ï¼Œæ²¡å…³ç³»ï¼Œä¸‹æ–‡çœ‹åˆ°å…·ä½“ä»£ç å°±èƒ½æ˜ç™½äº†ã€‚</p><p>å¸¸é©»ä½œä¸šã€ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦ä¸­ä¼šç•¥æœ‰ä¸åŒï¼Œå¤§ä½“<strong>ç²—ç•¥</strong>æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/02.png" alt=""></p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é’ˆå¯¹æ¯ä¸ªè¿‡ç¨‹ä¸€èŠ‚ä¸€èŠ‚è§£æã€‚</p><h1 id="3-Producer-å‘å¸ƒä»»åŠ¡"><a href="#3-Producer-å‘å¸ƒä»»åŠ¡" class="headerlink" title="3. Producer å‘å¸ƒä»»åŠ¡"></a>3. Producer å‘å¸ƒä»»åŠ¡</h1><p>åœ¨ä¸Šæ–‡<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®ã€</a>å¯ä»¥çœ‹åˆ°æ·»åŠ äº‘ä½œä¸šé…ç½®åï¼ŒElastic-Job-Cloud-Scheduler ä¼šæ‰§è¡Œ<strong>ä½œä¸šè°ƒåº¦</strong>ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è°ƒåº¦ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   <span class="comment">// åº”ç”¨ æˆ– ä½œä¸š è¢«ç¦ç”¨ï¼Œä¸è°ƒåº¦</span></div><div class="line">   <span class="keyword">if</span> (disableAppService.isDisabled(jobConfig.getAppName()) || disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType()) &#123; <span class="comment">// ç¬æ—¶ä½œä¸š</span></div><div class="line">       transientProducerScheduler.register(jobConfig);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (CloudJobExecutionType.DAEMON == jobConfig.getJobExecutionType()) &#123; <span class="comment">// å¸¸é©»ä½œä¸š</span></div><div class="line">       readyService.addDaemon(jobConfig.getJobName());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ç¬æ—¶ä½œä¸šå’Œå¸¸é©»ä½œä¸šåœ¨è°ƒåº¦ä¸Šä¼šæœ‰ä¸€å®šçš„ä¸åŒã€‚</li></ul><h2 id="3-1-å¸¸é©»ä½œä¸š"><a href="#3-1-å¸¸é©»ä½œä¸š" class="headerlink" title="3.1 å¸¸é©»ä½œä¸š"></a>3.1 å¸¸é©»ä½œä¸š</h2><p>å¸¸é©»ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œç›´æ¥æ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚Whatï¼Ÿå²‚ä¸æ˜¯é©¬ä¸Šå°±è¿è¡Œäº†ï¼No No Noï¼Œç­”æ¡ˆåœ¨ã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ï¼Œè¿™é‡Œå…ˆæ‰“ä½ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDaemon</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add daemon job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.DAEMON != cloudJobConfig.get().getJobExecutionType() || runningService.isJobRunning(jobName)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadyNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadyNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/ready"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String READY_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ReadyServiceï¼Œå¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—æœåŠ¡ï¼Œæä¾›å¯¹å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</li><li><p><strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/ready/${JOB_NAME}</code>ï¼Œå­˜å‚¨å€¼ä¸ºå¾…æ‰§è¡Œæ¬¡æ•°ã€‚ä¾‹å¦‚æ­¤å¤„ï¼Œå¾…æ‰§è¡Œæ¬¡æ•°ä¸º <code>1</code>ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 4] ls /elastic-job-cloud/state/ready</div><div class="line">[test_job_simple]</div><div class="line">[zk: localhost:2181(CONNECTED) 5] get /elastic-job-cloud/state/ready/test_job_simple</div><div class="line">1</div></pre></td></tr></table></figure></li><li><p>åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ï¼š</p><p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/10.png" alt="">    </p></li><li><p>ä»å®˜æ–¹çš„ RoadMap æ¥çœ‹ï¼Œ<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>æœªæ¥ä¼šä½¿ç”¨ Redis å­˜å‚¨ä»¥æé«˜æ€§èƒ½ã€‚</p><blockquote><p>FROM <a href="http://elasticjob.io/docs/elastic-job-cloud/03-design/roadmap/" rel="external nofollow noopener noreferrer" target="_blank">http://elasticjob.io/docs/elastic-job-cloud/03-design/roadmap/</a><br>Redis Based Queue Improvement</p></blockquote></li></ul><h2 id="3-2-ç¬æ—¶ä½œä¸š"><a href="#3-2-ç¬æ—¶ä½œä¸š" class="headerlink" title="3.2 ç¬æ—¶ä½œä¸š"></a>3.2 ç¬æ—¶ä½œä¸š</h2><p>ç¬æ—¶ä½œä¸šåœ¨è°ƒåº¦æ—¶ï¼Œä½¿ç”¨<strong>å‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨</strong>( TransientProducerScheduler )è°ƒåº¦ä½œä¸šã€‚å½“ç¬æ—¶ä½œä¸šåˆ°è¾¾ä½œä¸šæ‰§è¡Œæ—¶é—´ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚</p><h3 id="3-2-1-TransientProducerScheduler"><a href="#3-2-1-TransientProducerScheduler" class="headerlink" title="3.2.1 TransientProducerScheduler"></a>3.2.1 TransientProducerScheduler</h3><p>TransientProducerSchedulerï¼Œå‘å¸ƒç¬æ—¶ä½œä¸šä»»åŠ¡çš„è°ƒåº¦å™¨ï¼ŒåŸºäº Quartz å®ç°å¯¹ç¬æ—¶ä½œä¸šçš„è°ƒåº¦ã€‚åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   scheduler = getScheduler();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduler.start();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">getScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       factory.initialize(getQuartzProperties());</div><div class="line">       <span class="keyword">return</span> factory.getScheduler();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, Integer.toString(Runtime.getRuntime().availableProcessors() * <span class="number">2</span>)); <span class="comment">// çº¿ç¨‹æ± æ•°é‡</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, <span class="string">"ELASTIC_JOB_CLOUD_TRANSIENT_PRODUCER"</span>);</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3-2-2-æ³¨å†Œç¬æ—¶ä½œä¸š"><a href="#3-2-2-æ³¨å†Œç¬æ—¶ä½œä¸š" class="headerlink" title="3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š"></a>3.2.2 æ³¨å†Œç¬æ—¶ä½œä¸š</h3><p>è°ƒç”¨ <code>TransientProducerScheduler#register(...)</code> æ–¹æ³•ï¼Œæ³¨å†Œç¬æ—¶ä½œä¸šã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TransientProducerScheduler.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransientProducerRepository repository;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   String cron = jobConfig.getTypeConfig().getCoreConfig().getCron();</div><div class="line">   <span class="comment">// æ·»åŠ  cron ä½œä¸šé›†åˆ</span></div><div class="line">   JobKey jobKey = buildJobKey(cron);</div><div class="line">   repository.put(jobKey, jobConfig.getJobName());</div><div class="line">   <span class="comment">// è°ƒåº¦ ä½œä¸š</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobKey)) &#123;</div><div class="line">           scheduler.scheduleJob(buildJobDetail(jobKey), buildTrigger(jobKey.getName()));</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#buildJobKey(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Quartz JobKeyã€‚ä½ ä¼šå‘ç°å¾ˆæœ‰æ„æ€çš„ä½¿ç”¨çš„æ˜¯ <code>cron</code> å‚æ•°ä½œä¸ºä¸»é”®ã€‚Whyï¼Ÿåœ¨çœ‹ä¸‹ <code>!scheduler.checkExists(jobKey)</code> å¤„ï¼Œç›¸åŒ JobKey( <code>cron</code> ) çš„ä½œä¸šä¸é‡å¤æ³¨å†Œåˆ° Quartz Schedulerã€‚Whyï¼Ÿæ­¤å¤„æ˜¯ä¸€ä¸ªä¼˜åŒ–ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobï¼ŒElastic-Job-Cloud-Scheduler å¯èƒ½ä¼šæ³¨å†Œå¤§é‡çš„ç¬æ—¶ä½œä¸šï¼Œå¦‚æœä¸€ä¸ªç¬æ—¶ä½œä¸šåˆ›å»ºä¸€ä¸ª Quartz Job å¤ªè¿‡æµªè´¹ï¼Œç‰¹åˆ«æ˜¯ <code>cron</code> æ¯åˆ†é’Ÿã€æ¯5åˆ†é’Ÿã€æ¯å°æ—¶ã€æ¯å¤©å·²ç»è¦†ç›–äº†å¤§é‡çš„ç¬æ—¶ä½œä¸šçš„æƒ…å†µã€‚å› æ­¤ï¼Œç›¸åŒ <code>cron</code> ä½¿ç”¨åŒä¸€ä¸ª Quartz Jobã€‚</li><li><p>è°ƒç”¨ <code>TransientProducerRepository#put(...)</code> ä»¥ Quartz JobKey ä¸ºä¸»é”®èšåˆä½œä¸šã€‚</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> JobKey jobKey, <span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">        remove(jobName);</div><div class="line">        List&lt;String&gt; taskList = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == taskList) &#123;</div><div class="line">            taskList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            taskList.add(jobName);</div><div class="line">            cronTasks.put(jobKey, taskList);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!taskList.contains(jobName)) &#123;</div><div class="line">            taskList.add(jobName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#buildJobDetail(...)</code> åˆ›å»º Quartz Job ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> JobDetail <span class="title">buildJobDetail</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">    JobDetail result = JobBuilder.newJob(ProducerJob.class) <span class="comment">// ProducerJob.java</span></div><div class="line">            .withIdentity(jobKey).build();</div><div class="line">    result.getJobDataMap().put(<span class="string">"repository"</span>, repository);</div><div class="line">    result.getJobDataMap().put(<span class="string">"readyService"</span>, readyService);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>JobBuilder#newJob(...)</code> çš„å‚æ•°æ˜¯ ProducerJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚</li></ul></li><li><p>è°ƒç”¨ <code>#buildTrigger(...)</code> åˆ›å»º Quartz Triggerã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Trigger <span class="title">buildTrigger</span><span class="params">(<span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(cron)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron) <span class="comment">// cron</span></div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="3-2-3-ProducerJob"><a href="#3-2-3-ProducerJob" class="headerlink" title="3.2.3 ProducerJob"></a>3.2.3 ProducerJob</h3><p>ProducerJobï¼Œå½“ Quartz Job åˆ°è¾¾ <code>cron</code> æ‰§è¡Œæ—¶é—´( å³ä½œä¸šæ‰§è¡Œæ—¶é—´)ï¼Œå°†ç›¸åº”çš„ç¬æ—¶ä½œä¸šæ·»åŠ åˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">        </div><div class="line">   <span class="keyword">private</span> TransientProducerRepository repository;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> ReadyService readyService;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       List&lt;String&gt; jobNames = repository.get(context.getJobDetail().getKey());</div><div class="line">       <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">           readyService.addTransient(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>TransientProducerRepository#get(...)</code> æ–¹æ³•ï¼Œè·å¾—è¯¥ Job å¯¹åº”çš„ä½œä¸šé›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransientProducerRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cron ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šKey</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;JobKey, List&lt;String&gt;&gt; cronTasks = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>, <span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="function">List&lt;String&gt; <span class="title">get</span><span class="params">(<span class="keyword">final</span> JobKey jobKey)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; result = cronTasks.get(jobKey);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == result ? Collections.&lt;String&gt;emptyList() : result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>ReadyService#addTransient(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ç¬æ—¶ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobName ä½œä¸šåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTransient</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (regCenter.getNumChildren(ReadyNode.ROOT) &gt; env.getFrameworkConfiguration().getJobStateQueueSize()) &#123;</div><div class="line">       log.warn(<span class="string">"Cannot add transient job, caused by read state queue size is larger than &#123;&#125;."</span>, env.getFrameworkConfiguration().getJobStateQueueSize());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//</span></div><div class="line">   Optional&lt;CloudJobConfiguration&gt; cloudJobConfig = configService.load(jobName);</div><div class="line">   <span class="keyword">if</span> (!cloudJobConfig.isPresent() || CloudJobExecutionType.TRANSIENT != cloudJobConfig.get().getJobExecutionType()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// </span></div><div class="line">   String readyJobNode = ReadyNode.getReadyJobNodePath(jobName);</div><div class="line">   String times = regCenter.getDirectly(readyJobNode);</div><div class="line">   <span class="keyword">if</span> (cloudJobConfig.get().getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       regCenter.persist(readyJobNode, Integer.toString(<span class="keyword">null</span> == times ? <span class="number">1</span> : Integer.parseInt(times) + <span class="number">1</span>));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       regCenter.persist(ReadyNode.getReadyJobNodePath(jobName), <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>æ·»åŠ ç¬æ—¶ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong> å’Œ <strong>æ·»åŠ å¸¸é©»ä½œä¸šåˆ°å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚</li><li>å½“ä½œä¸šé…ç½®å…è®¸ <code>misfire</code>ï¼Œåˆ™ä¸æ–­ç´¯ç§¯ä½œä¸šå¯æ‰§è¡Œæ¬¡æ•°ã€‚</li></ul></li></ul><h2 id="3-3-å°ç»“"><a href="#3-3-å°ç»“" class="headerlink" title="3.3 å°ç»“"></a>3.3 å°ç»“</h2><p>æ— è®ºæ˜¯å¸¸é©»ä½œä¸šè¿˜æ˜¯ç¬æ—¶ä½œä¸šï¼Œéƒ½ä¼šåŠ å…¥åˆ°<strong>å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—</strong>ã€‚ç›®å‰æˆ‘ä»¬çœ‹åˆ°ç¬æ—¶ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦æ˜¯ TransientProducerScheduler è´Ÿè´£ã€‚é‚£ä¹ˆå¸¸é©»ä½œä¸šçš„æ¯æ¬¡è°ƒåº¦å‘¢ï¼Ÿã€Œ5. TaskExecutor æ‰§è¡Œä»»åŠ¡ã€ä¼šçœ‹åˆ°å®ƒçš„è°ƒåº¦ï¼Œè¿™æ˜¯ Elastic-Job-Cloud è®¾è®¡å·§å¦™æœ‰è¶£çš„åœ°æ–¹ã€‚</p><h1 id="4-TaskLaunchScheduledService-æäº¤ä»»åŠ¡"><a href="#4-TaskLaunchScheduledService-æäº¤ä»»åŠ¡" class="headerlink" title="4. TaskLaunchScheduledService æäº¤ä»»åŠ¡"></a>4. TaskLaunchScheduledService æäº¤ä»»åŠ¡</h1><p>TaskLaunchScheduledServiceï¼Œä»»åŠ¡æäº¤è°ƒåº¦æœåŠ¡ã€‚å®ƒç»§æ‰¿ Guava AbstractScheduledService å®ç°å®šæ—¶å°†å¾…æ‰§è¡Œä½œä¸šé˜Ÿåˆ—çš„ä½œä¸šæäº¤åˆ° Mesos è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚å®ç°<strong>å®šæ—¶</strong>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskLaunchScheduledService</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">serviceName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"task-launch-processor"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Scheduler.newFixedDelaySchedule(<span class="number">2</span>, <span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// .... çœç•¥ä»£ç </span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æ¯ 10 ç§’æ‰§è¡Œæäº¤ä»»åŠ¡( <code>#runOneIteration()</code> )ã€‚å¯¹ Guava AbstractScheduledService ä¸äº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯»å®Œæœ¬æ–‡å Google ä¸‹ã€‚å› ä¸ºæ˜¯é€šè¿‡æ¯ 10 ç§’è½®è¯¢çš„æ–¹å¼æäº¤ä»»åŠ¡ï¼Œæ‰€ä»¥<strong>ç¬æ—¶ä½œä¸š</strong>çš„æ‰§è¡Œæ—¶é—´ä¸æ˜¯éå¸¸ä¸¥æ ¼ï¼Œå­˜åœ¨ç•¥æœ‰å»¶è¿Ÿï¼Œè¿™ä¸ªå®é™…åœ¨ä½¿ç”¨éœ€è¦æ³¨æ„çš„ã€‚é‚£<strong>å¸¸é©»ä½œä¸š</strong>å‘¢ï¼Œçœ‹å®Œæœ¬æ–‡ï¼Œä½ å°±ä¼šçŸ¥é“ç­”æ¡ˆã€‚</li></ul><p><code>#runOneIteration()</code> æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¸€å—ä¸€å—æ‹†è§£ï¼Œ<strong>è€å¿ƒ</strong>ç†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runOneIteration</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       System.out.println(<span class="string">"runOneIteration:"</span> + <span class="keyword">new</span> Date());</div><div class="line">       <span class="comment">// åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">       List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div><div class="line">       <span class="comment">// è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp https://github.com/Netflix/Fenzo/wiki/Constraints</span></div><div class="line">       <span class="keyword">if</span> (!taskRequests.isEmpty()) &#123;</div><div class="line">           AppConstraintEvaluator.getInstance().loadAppRunningState();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</span></div><div class="line">       Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line">       <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡è¯·æ±‚</span></div><div class="line">       List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">       Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line">       <span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">           List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">           List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">           taskInfoList.addAll(getTaskInfoList(</div><div class="line">                   launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">                   each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">           <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">               taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">           &#125;</div><div class="line">           offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">                   taskInfoList);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// éå†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line">       <span class="keyword">for</span> (TaskContext each : taskContextsList) &#123;</div><div class="line">           <span class="comment">// å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</span></div><div class="line">           facadeService.addRunning(each);</div><div class="line">           <span class="comment">// å‘å¸ƒä½œä¸šçŠ¶æ€è¿½è¸ªäº‹ä»¶(State.TASK_STAGING)</span></div><div class="line">           jobEventBus.post(createJobStatusTraceEvent(each));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</span></div><div class="line">       facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line">       <span class="comment">// æäº¤ä»»åŠ¡ç»™ Mesos</span></div><div class="line">       <span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">           schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">       log.error(<span class="string">"Launch task error"</span>, throwable);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// æ¸…ç† AppConstraintEvaluator æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‘ä½œä¸šApp</span></div><div class="line">       AppConstraintEvaluator.getInstance().clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-1-åˆ›å»º-Fenzo-ä»»åŠ¡è¯·æ±‚"><a href="#4-1-åˆ›å»º-Fenzo-ä»»åŠ¡è¯·æ±‚" class="headerlink" title="4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚"></a>4.1 åˆ›å»º Fenzo ä»»åŠ¡è¯·æ±‚</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">LaunchingTasks launchingTasks = <span class="keyword">new</span> LaunchingTasks(facadeService.getEligibleJobContext());</div><div class="line">List&lt;TaskRequest&gt; taskRequests = launchingTasks.getPendingTasks();</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FacadeService#getEligibleJobContext()</code> æ–¹æ³•ï¼Œè·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸šã€‚</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å–æœ‰èµ„æ ¼è¿è¡Œçš„ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getEligibleJobContext</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; failoverJobContexts = failoverService.getAllEligibleJobContexts();</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   Collection&lt;JobContext&gt; readyJobContexts = readyService.getAllEligibleJobContexts(failoverJobContexts);</div><div class="line">   <span class="comment">// åˆå¹¶</span></div><div class="line">   Collection&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(failoverJobContexts.size() + readyJobContexts.size());</div><div class="line">   result.addAll(failoverJobContexts);</div><div class="line">   result.addAll(readyJobContexts);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>FailoverService#getAllEligibleJobContexts()</code> æ–¹æ³•ï¼Œä»<strong>å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚<strong>TaskLaunchScheduledService æäº¤çš„ä»»åŠ¡è¿˜å¯èƒ½æ¥è‡ªå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—</strong>ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æå¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ç›¸å…³å®ç°ï¼Œé¿å…å¢åŠ å¤æ‚åº¦å½±å“å¤§å®¶çš„ç†è§£ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</li><li><p>è°ƒç”¨ <code>ReadyService#getAllEligibleJobContexts(...)</code> æ–¹æ³•ï¼Œä»<strong>å¾…æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ã€‚</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ReadyService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> ineligibleJobContexts æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;JobContext&gt; <span class="title">getAllEligibleJobContexts</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; ineligibleJobContexts)</span> </span>&#123;</div><div class="line">   <span class="comment">// ä¸å­˜åœ¨ å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(ReadyNode.ROOT)) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡ è½¬æ¢æˆ æ— èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šé›†åˆ</span></div><div class="line">   Collection&lt;String&gt; ineligibleJobNames = Collections2.transform(ineligibleJobContexts, <span class="keyword">new</span> Function&lt;JobContext, String&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="keyword">final</span> JobContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getJobConfig().getJobName();</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   <span class="comment">// è·å– å¾…æ‰§è¡Œé˜Ÿåˆ— æœ‰èµ„æ ¼æ‰§è¡Œçš„ä½œä¸šä¸Šä¸‹æ–‡</span></div><div class="line">   List&lt;String&gt; jobNames = regCenter.getChildrenKeys(ReadyNode.ROOT);</div><div class="line">   List&lt;JobContext&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobNames.size());</div><div class="line">   <span class="keyword">for</span> (String each : jobNames) &#123;</div><div class="line">       <span class="keyword">if</span> (ineligibleJobNames.contains(each)) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// æ’é™¤ ä½œä¸šé…ç½® ä¸å­˜åœ¨çš„ä½œä¸š</span></div><div class="line">       Optional&lt;CloudJobConfiguration&gt; jobConfig = configService.load(each);</div><div class="line">       <span class="keyword">if</span> (!jobConfig.isPresent()) &#123;</div><div class="line">           regCenter.remove(ReadyNode.getReadyJobNodePath(each));</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!runningService.isJobRunning(each)) &#123; <span class="comment">// æ’é™¤ è¿è¡Œä¸­ çš„ä½œä¸š</span></div><div class="line">           result.add(JobContext.from(jobConfig.get(), ExecutionType.READY));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li></li></ul></li><li><p>JobContextï¼Œä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; assignedShardingItems;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * é€šè¿‡ä½œä¸šé…ç½®åˆ›å»ºä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> type æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobContext <span class="title">from</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ExecutionType type)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> shardingTotalCount = jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">        <span class="comment">// åˆ†ç‰‡é¡¹</span></div><div class="line">        List&lt;Integer&gt; shardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingTotalCount);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">            shardingItems.add(i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JobContext(jobConfig, shardingItems, type);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><ul><li><p>LaunchingTasksï¼Œåˆ†é…ä»»åŠ¡è¡Œä¸ºåŒ…ã€‚åˆ›å»º LaunchingTasks ä»£ç å¦‚ä¸‹ï¼š</p> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchingTasks</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">     * keyï¼šä½œä¸šå</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JobContext&gt; eligibleJobContextsMap;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LaunchingTasks</span><span class="params">(<span class="keyword">final</span> Collection&lt;JobContext&gt; eligibleJobContexts)</span> </span>&#123;</div><div class="line">        eligibleJobContextsMap = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContexts.size(), <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (JobContext each : eligibleJobContexts) &#123;</div><div class="line">            eligibleJobContextsMap.put(each.getJobConfig().getJobName(), each);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•ï¼Œè·å¾—å¾…æ‰§è¡Œä»»åŠ¡é›†åˆã€‚<strong>è¿™é‡Œè¦æ³¨æ„ï¼Œæ¯ä¸ªä½œä¸šå¦‚æœæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œåˆ™ä¼šç”Ÿæˆå¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡ï¼Œå³æ­¤å¤„å®Œæˆäº†ä½œä¸šåˆ†ç‰‡</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—å¾…æ‰§è¡Œä»»åŠ¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">List&lt;TaskRequest&gt; <span class="title">getPendingTasks</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(eligibleJobContextsMap.size() * <span class="number">10</span>);</div><div class="line">   <span class="keyword">for</span> (JobContext each : eligibleJobContextsMap.values()) &#123;</div><div class="line">       result.addAll(createTaskRequests(each));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobContext ä½œä¸šè¿è¡Œä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> Collection&lt;TaskRequest&gt; <span class="title">createTaskRequests</span><span class="params">(<span class="keyword">final</span> JobContext jobContext)</span> </span>&#123;</div><div class="line">   Collection&lt;TaskRequest&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(jobContext.getAssignedShardingItems().size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : jobContext.getAssignedShardingItems()) &#123;</div><div class="line">       result.add(<span class="keyword">new</span> JobTaskRequest(<span class="keyword">new</span> TaskContext(jobContext.getJobConfig().getJobName(), Collections.singletonList(each), jobContext.getType()), jobContext.getJobConfig()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// TaskContext.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskContext</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> String id;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡å…ƒä¿¡æ¯</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MetaInfo metaInfo;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutionType type;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Mesos Slave ç¼–å·</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> String slaveId;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ˜¯å¦é—²ç½®</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> idle;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaInfo</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * ä½œä¸šå</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * ä½œä¸šåˆ†ç‰‡é¡¹</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Integer&gt; shardingItems;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobTaskRequest.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line">    </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskContext taskContext;</div><div class="line">       </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CloudJobConfiguration jobConfig;</div><div class="line">       </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> taskContext.getId();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getCPUs</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> jobConfig.getCpuCount();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> jobConfig.getMemoryMB();</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">// ... çœç•¥éƒ¨åˆ†æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#createTaskRequests(...)</code> æ–¹æ³•ï¼Œ<strong>å°†å•ä¸ªä½œä¸šæŒ‰ç…§å…¶ä½œä¸šåˆ†ç‰‡æ€»æ•°æ‹†åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªå¾…æ‰§è¡Œä»»åŠ¡é›†åˆ</strong>ã€‚</li><li>TaskContextï¼Œä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ã€‚</li><li>JobTaskRequestï¼Œä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹è±¡ã€‚       </li></ul></li><li>å› ä¸ºå¯¹è±¡æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬æ¥è´´ä¸€ä¸ª <code>LaunchingTasks#getPendingTasks()</code> æ–¹æ³•çš„è¿”å›ç»“æœã€‚<br>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/03.png" alt=""></li></ul><p><strong>å‹æƒ…æç¤ºï¼Œä»£ç å¯èƒ½æ¯”è¾ƒå¤šï¼Œè¯·è€å¿ƒè§‚çœ‹ã€‚</strong></p><h2 id="4-2-AppConstraintEvaluator"><a href="#4-2-AppConstraintEvaluator" class="headerlink" title="4.2 AppConstraintEvaluator"></a>4.2 AppConstraintEvaluator</h2><p>åœ¨è¯´ AppConstraintEvaluator ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·äº†<strong>ç®€å•</strong>è§£ä¸‹ <a href="https://github.com/Netflix/Fenzo/wiki" rel="external nofollow noopener noreferrer" target="_blank">Netflix Fenzo</a>ã€‚</p><blockquote><p>FROM <a href="http://dockone.io/article/636" rel="external nofollow noopener noreferrer" target="_blank">http://dockone.io/article/636</a><br>Fenzoæ˜¯ä¸€ä¸ªåœ¨Mesosæ¡†æ¶ä¸Šåº”ç”¨çš„é€šç”¨ä»»åŠ¡è°ƒåº¦å™¨ã€‚å®ƒå¯ä»¥è®©ä½ é€šè¿‡å®ç°å„ç§ä¼˜åŒ–ç­–ç•¥çš„æ’ä»¶ï¼Œæ¥ä¼˜åŒ–ä»»åŠ¡è°ƒåº¦ï¼ŒåŒæ—¶è¿™ä¹Ÿæœ‰åˆ©äºé›†ç¾¤çš„è‡ªåŠ¨ç¼©æ”¾ã€‚</p></blockquote><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/05.png" alt=""></p><p>Elastic-Job-Cloud-Scheduler åŸºäº Fenzo å®ç°å¯¹ Mesos çš„å¼¹æ€§èµ„æºåˆ†é…ã€‚</p><p>ä¾‹å¦‚ï¼ŒAppConstraintEvaluatorï¼ŒApp ç›®æ ‡ Mesos Slave é€‚é…åº¦é™åˆ¶å™¨ï¼Œé€‰æ‹© Slave æ—¶éœ€è¦è€ƒè™‘å…¶ä¸Šæ˜¯å¦è¿è¡Œæœ‰ App çš„ Executorï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œ Executor éœ€è¦å°†å…¶èµ„æºæ¶ˆè€—è€ƒè™‘è¿›é€‚é…è®¡ç®—ç®—æ³•ä¸­ã€‚å®ƒæ˜¯ <a href="https://github.com/Netflix/Fenzo/blob/5de0e0861def4a655be35a9624e67318a6c0afac/fenzo-core/src/main/java/com/netflix/fenzo/ConstraintEvaluator.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo ConstraintEvaluator æ¥å£</a> åœ¨ Elastic-Job-Cloud-Scheduler çš„è‡ªå®šä¹‰ä»»åŠ¡çº¦æŸå®ç°ã€‚é€šè¿‡è¿™ä¸ªä»»åŠ¡çº¦æŸï¼Œåœ¨ä¸‹æ–‡è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šå°† AppConstraintEvaluator è€ƒè™‘è¿›å»ã€‚</p><p>é‚£ä¹ˆä½œä¸šä»»åŠ¡è¯·æ±‚( JobTaskRequest ) æ˜¯æ€ä¹ˆå…³è”ä¸Š AppConstraintEvaluator çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// JobTaskRequest.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTaskRequest</span> <span class="keyword">implements</span> <span class="title">TaskRequest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> List&lt;? extends ConstraintEvaluator&gt; getHardConstraints() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.singletonList(AppConstraintEvaluator.getInstance());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><a href="https://github.com/Netflix/Fenzo/blob/20d71b5c3213063fc938cd2841dc7569601d1d99/fenzo-core/src/main/java/com/netflix/fenzo/TaskRequest.java" rel="external nofollow noopener noreferrer" target="_blank">Fenzo TaskRequest æ¥å£</a> æ˜¯ Fenzo çš„ä»»åŠ¡è¯·æ±‚æ¥å£ï¼Œé€šè¿‡å®ç° <code>#getHardConstraints()</code> æ–¹æ³•ï¼Œå…³è”ä¸Š TaskRequest å’Œ ConstraintEvaluatorã€‚</li></ul><p>å…³è”ä¸Šä¹‹åï¼Œä»»åŠ¡åŒ¹é… Mesos Slave èµ„æºæ—¶ï¼Œè°ƒç”¨ <code>ConstraintEvaluator#evaluate(...)</code> å®ç°æ–¹æ³•åˆ¤æ–­æ˜¯å¦ç¬¦åˆçº¦æŸï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintEvaluator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isSuccessful;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String failureReason;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Inspects a target to decide whether or not it meets the constraints appropriate to a particular task.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> taskRequest a description of the task to be assigned</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> targetVM a description of the host that is a potential match for the task</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> taskTrackerState the current status of tasks and task assignments in the system at large</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> a successful Result if the target meets the constraints enforced by this constraint evaluator, or</span></div><div class="line"><span class="comment">     *         an unsuccessful Result otherwise</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(TaskRequest taskRequest, VirtualMachineCurrentState targetVM,</span></span></div><div class="line"><span class="function"><span class="params">                           TaskTrackerState taskTrackerState)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>OKï¼Œç®€å•äº†è§£ç»“æŸï¼Œæœ‰å…´è¶£äº†è§£æ›´å¤šçš„åŒå­¦ï¼Œè¯·ç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/wiki/Constraints" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a>ã€‚ä¸‹é¢æ¥çœ‹çœ‹ Elastic-Job-Cloud-Scheduler è‡ªå®šä¹‰å®ç°çš„ä»»åŠ¡çº¦æŸ AppConstraintEvaluatorã€‚</p><hr><p>è°ƒç”¨ <code>AppConstraintEvaluator#loadAppRunningState()</code> æ–¹æ³•ï¼ŒåŠ è½½å½“å‰è¿è¡Œä¸­çš„<strong>äº‘ä½œä¸šApp</strong>ï¼Œä¸º <code>AppConstraintEvaluator#evaluate(...)</code> æ–¹æ³•æä¾›è¯¥æ•°æ®ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; runningApps = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadAppRunningState</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">for</span> (MesosStateService.ExecutorStateInfo each : facadeService.loadExecutorInfo()) &#123;</div><div class="line">           runningApps.add(each.getId());</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSONException | UniformInterfaceException | ClientHandlerException e) &#123;</div><div class="line">       clearAppRunningState();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•ï¼Œä» Mesos è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Mesos æ‰§è¡Œå™¨( Executor )çš„ä¿¡æ¯ã€‚æ‰§è¡Œå™¨å’Œäº‘ä½œä¸šAppæœ‰å•¥å…³ç³»ï¼Ÿ<strong>æ¯ä¸ªäº‘ä½œä¸šApp å³æ˜¯ä¸€ä¸ª Elastic-Job-Cloud-Executor å®ä¾‹ã€‚</strong>ã€‚<code>FacadeService#loadExecutorInfo()</code> æ–¹æ³•è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦è‡ªå·±çœ‹ä¸‹ï¼Œä¸»è¦æ˜¯å¯¹ Mesos çš„ APIæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>runningApps</code> çš„ç»“æœï¼š</p><p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/04.png" alt=""></p></li></ul><hr><p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•è°ƒåº¦æäº¤ä»»åŠ¡æ‰€éœ€èµ„æºæ—¶ï¼Œä¼šè°ƒç”¨ <code>ConstraintEvaluator#loadAppRunningState()</code> æ£€æŸ¥åˆ†é…çš„èµ„æºæ˜¯å¦ç¬¦åˆä»»åŠ¡çš„çº¦æŸæ¡ä»¶ã€‚<code>AppConstraintEvaluator#loadAppRunningState()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AppConstraintEvaluator.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">evaluate</span><span class="params">(<span class="keyword">final</span> TaskRequest taskRequest, <span class="keyword">final</span> VirtualMachineCurrentState targetVM, <span class="keyword">final</span> TaskTrackerState taskTrackerState)</span> </span>&#123;</div><div class="line">   <span class="keyword">double</span> assigningCpus = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">double</span> assigningMemoryMB = <span class="number">0.0</span>d;</div><div class="line">   <span class="keyword">final</span> String slaveId = targetVM.getAllCurrentOffers().iterator().next().getSlaveId().getValue();</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šApp</span></div><div class="line">       <span class="keyword">if</span> (isAppRunningOnSlave(taskRequest.getId(), slaveId)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave å¯åŠ¨äº‘ä½œä¸šApp æ˜¯å¦è¶…è¿‡èµ„æºé™åˆ¶</span></div><div class="line">       Set&lt;String&gt; calculatedApps = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// å·²è®¡ç®—ä½œä¸šAppé›†åˆ</span></div><div class="line">       List&lt;TaskRequest&gt; taskRequests = <span class="keyword">new</span> ArrayList&lt;&gt;(targetVM.getTasksCurrentlyAssigned().size() + <span class="number">1</span>);</div><div class="line">       taskRequests.add(taskRequest);</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult each : targetVM.getTasksCurrentlyAssigned()) &#123; <span class="comment">// å½“å‰å·²ç»åˆ†é…ä½œä¸šè¯·æ±‚</span></div><div class="line">           taskRequests.add(each.getRequest());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">for</span> (TaskRequest each : taskRequests) &#123;</div><div class="line">           assigningCpus += each.getCPUs();</div><div class="line">           assigningMemoryMB += each.getMemory();</div><div class="line">           <span class="keyword">if</span> (isAppRunningOnSlave(each.getId(), slaveId)) &#123; <span class="comment">// ä½œä¸šAppå·²ç»å¯åŠ¨</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           CloudAppConfiguration assigningAppConfig = getAppConfiguration(each.getId());</div><div class="line">           <span class="keyword">if</span> (!calculatedApps.add(assigningAppConfig.getAppName())) &#123; <span class="comment">// æ˜¯å¦å·²ç»è®¡ç®—è¯¥App</span></div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line">           assigningCpus += assigningAppConfig.getCpuCount();</div><div class="line">           assigningMemoryMB += assigningAppConfig.getMemoryMB();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LackConfigException ex) &#123;</div><div class="line">       log.warn(<span class="string">"Lack config, disable &#123;&#125;"</span>, getName(), ex);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningCpus &gt; targetVM.getCurrAvailableResources().cpuCores()) &#123; <span class="comment">// cpu</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources().cpuCores());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"cpu:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources().cpuCores()));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (assigningMemoryMB &gt; targetVM.getCurrAvailableResources().memoryMB()) &#123; <span class="comment">// memory</span></div><div class="line">       log.debug(<span class="string">"Failure &#123;&#125; &#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, String.format(<span class="string">"mem:%s/%s"</span>, assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">   &#125;</div><div class="line">   log.debug(<span class="string">"Success &#123;&#125; &#123;&#125; cpus:&#123;&#125;/&#123;&#125; mem:&#123;&#125;/&#123;&#125;"</span>, taskRequest.getId(), slaveId, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB());</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, String.format(<span class="string">"cpus:%s/%s mem:%s/%s"</span>, assigningCpus, targetVM.getCurrAvailableResources()</div><div class="line">           .cpuCores(), assigningMemoryMB, targetVM.getCurrAvailableResources().memoryMB()));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#isAppRunningOnSlave()</code> æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰åˆ†é…çš„ Mesos Slave æ˜¯å¦è¿è¡Œç€è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚å¯¹åº”çš„äº‘ä½œä¸šAppã€‚è‹¥äº‘ä½œä¸šAppæœªè¿è¡Œï¼Œåˆ™è¯¥ä½œä¸šä»»åŠ¡è¯·æ±‚æäº¤ç»™ Mesos åï¼Œè¯¥ Mesos Slave ä¼šå¯åŠ¨è¯¥äº‘ä½œä¸š Appï¼ŒApp æœ¬èº«ä¼šå ç”¨ä¸€å®šçš„ <code>CloudAppConfiguration#cpu</code> å’Œ <code>CloudAppConfiguration#memory</code>ï¼Œè®¡ç®—æ—¶éœ€è¦ç»Ÿè®¡ï¼Œé¿å…è¶…è¿‡å½“å‰ Mesos Slave å‰©ä½™ <code>cpu</code> å’Œ <code>memory</code>ã€‚</li><li>å½“è®¡ç®—ç¬¦åˆçº¦æŸæ—¶ï¼Œè¿”å› <code>Result(true, ...)</code>ï¼›å¦åˆ™ï¼Œè¿”å› <code>Result(false, ...)</code>ã€‚</li><li>TODO å¼‚å¸¸ä¸ºå•¥è¿”å›trueã€‚</li></ul><h2 id="4-3-å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ°-Mesos-Offer"><a href="#4-3-å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ°-Mesos-Offer" class="headerlink" title="4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer"></a>4.3 å°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offer</h2><p>æˆ‘ä»¬å…ˆ<strong>ç®€å•</strong>äº†è§£ä¸‹ Elastic-Job-Cloud-Scheduler å®ç°çš„ Mesos Scheduler ç±» <code>com.dangdang.ddframe.job.cloud.scheduler.mesos.SchedulerEngine</code>ã€‚è°ƒåº¦å™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>åœ¨æ¥å—åˆ°çš„ Offer ä¸Šå¯åŠ¨ä»»åŠ¡</strong>ã€‚SchedulerEngine æ¥æ”¶åˆ°èµ„æº Offerï¼Œå…ˆå­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—( LeasesQueue )ï¼Œç­‰åˆ°ä½œä¸šè¢«è°ƒåº¦éœ€è¦å¯åŠ¨ä»»åŠ¡æ—¶è¿›è¡Œä½¿ç”¨ã€‚å­˜å‚¨åˆ°èµ„æºé¢„å é˜Ÿåˆ—å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerEngine</span> <span class="keyword">implements</span> <span class="title">Scheduler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resourceOffers</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> List&lt;Protos.Offer&gt; offers)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Protos.Offer offer: offers) &#123;</div><div class="line">            log.trace(<span class="string">"Adding offer &#123;&#125; from host &#123;&#125;"</span>, offer.getId(), offer.getHostname());</div><div class="line">            LeasesQueue.getInstance().offer(offer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>org.apache.mesos.Scheduler</code>ï¼ŒMesos è°ƒåº¦å™¨<strong>æ¥å£</strong>ï¼Œå®ç°è¯¥æ¥å£æˆä¸ºè‡ªå®šä¹‰ Mesos è°ƒåº¦å™¨ã€‚</li><li><p>å®ç° <code>#resourceOffers(...)</code> æ–¹æ³•ï¼Œæœ‰æ–°çš„èµ„æº Offer æ—¶ï¼Œä¼šè¿›è¡Œè°ƒç”¨ã€‚åœ¨ SchedulerEngine ä¼šè°ƒç”¨ <code>#offer(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ Offer åˆ°èµ„æºé¢„å é˜Ÿåˆ—ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ä¾‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LeasesQueue INSTANCE = <span class="keyword">new</span> LeasesQueue();</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è·å–å®ä¾‹.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å•ä¾‹å¯¹è±¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeasesQueue <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ·»åŠ èµ„æºè‡³é˜Ÿåˆ—é¢„å .</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> offer èµ„æº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer)</span> </span>&#123;</div><div class="line">        queue.offer(<span class="keyword">new</span> VMLeaseObject(offer));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... çœç•¥ #drainTo() æ–¹æ³•ï¼Œä¸‹æ–‡è§£æã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>VMLeaseObjectï¼Œ<a href="#">Netflix Fenzo</a> å¯¹ Mesos Offer çš„æŠ½è±¡åŒ…è£…ï¼Œç‚¹å‡»<a href="https://github.com/Netflix/Fenzo/blob/faa8a4dd411fff1792c9d788d1288a11e3635ba7/fenzo-core/src/main/java/com/netflix/fenzo/plugins/VMLeaseObject.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>æŸ¥çœ‹å®ç°ä»£ç ï¼Œé©¬ä¸Šä¼šçœ‹åˆ°å®ƒçš„ç”¨é€”ã€‚</li></ul></li></ul><p>å¦å¤–ï¼Œå¯èƒ½æœ‰åŒå­¦å¯¹ Mesos Offer ç†è§£æ¯”è¾ƒç”Ÿæ¶©ï¼ŒOffer å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>FROM <a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">https://segmentfault.com/a/1190000007723430</a><br>Offeræ˜¯Mesosèµ„æºçš„æŠ½è±¡ï¼Œæ¯”å¦‚è¯´æœ‰å¤šå°‘CPUã€å¤šå°‘memoryï¼Œdiscæ˜¯å¤šå°‘ï¼Œéƒ½æ”¾åœ¨Offeré‡Œï¼Œæ‰“åŒ…ç»™ä¸€ä¸ªFrameworkï¼Œç„¶åFrameworkæ¥å†³å®šåˆ°åº•æ€ä¹ˆç”¨è¿™ä¸ªOfferã€‚</p></blockquote><hr><p>OKï¼ŒçŸ¥è¯†é“ºå«å®Œæˆï¼Œå›åˆ°æœ¬å°èŠ‚çš„é‡å¿ƒï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">Collection&lt;VMAssignmentResult&gt; vmAssignmentResults = taskScheduler.scheduleOnce(taskRequests, LeasesQueue.getInstance().drainTo()).getResultMap().values();</div><div class="line"></div><div class="line"><span class="comment">// LeasesQueue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeasesQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VirtualMachineLease&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;VirtualMachineLease&gt; <span class="title">drainTo</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;VirtualMachineLease&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(queue.size());</div><div class="line">        queue.drainTo(result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è°ƒç”¨ <code>TaskScheduler#scheduleOnce(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¯·æ±‚åˆ†é…åˆ° Mesos Offerã€‚é€šè¿‡ Fenzo TaskScheduler å®ç°å¯¹å¤šä¸ªä»»åŠ¡åˆ†é…åˆ°å¤šä¸ª Mesos Offer çš„<strong>åˆç†ä¼˜åŒ–åˆ†é…</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„é—®é¢˜ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P76<br>å°†ä»»åŠ¡åŒ¹é…åˆ° offer ä¸Šï¼Œé¦–æ¬¡é€‚é…é€šå¸¸æ˜¯æœ€å¥½çš„ç®—æ³•ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼Œå¦‚æœåœ¨æ›´å¤šçš„å·¥ä½œé‡Œå°è¯•è®¡ç®—å‡ºåŒ¹é…è¯¥ offer çš„ä¼˜åŒ–ç»„åˆï¼Œå¯èƒ½æ¯”é¦–æ¬¡é€‚é…æ›´èƒ½é«˜æ•ˆåœ°åˆ©ç”¨ offerã€‚è¿™ç»å¯¹æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è¦è€ƒè™‘å¦‚ä¸‹è¿™äº›æ–¹é¢ï¼šå¯¹äºå¯åŠ¨æ‰€æœ‰ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡æ¥è¯´ï¼Œé›†ç¾¤é‡Œè¦ä¹ˆæœ‰å……è¶³çš„èµ„æºè¦ä¹ˆæ²¡æœ‰ã€‚å¦‚æœèµ„æºå¾ˆå¤šï¼Œé‚£ä¹ˆé¦–æ¬¡é€‚é…è‚¯å®šä¸€ç›´éƒ½èƒ½ä¿è¯æ¯ä¸ªä»»åŠ¡çš„å¯åŠ¨ã€‚å¦‚æœèµ„æºä¸å¤Ÿï¼Œæ€ä¹ˆéƒ½æ— æ³•å¯åŠ¨æ‰€æœ‰ä»»åŠ¡ã€‚å› æ­¤ï¼Œç¼–å†™ä»£ç é€‰æ‹©æ¥ä¸‹æ¥ä¼šè¿è¡Œå“ªä¸ªä»»åŠ¡æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æœåŠ¡çš„è´¨é‡ã€‚åªæœ‰å½“èµ„æºåˆšå¤Ÿç”¨æ—¶ï¼Œæ‰éœ€è¦æ›´ä¸ºç²¾ç»†çš„æ‰“åŒ…ç®—æ³•ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™é‡Œçš„é—®é¢˜ â€”â€” é€šå¸¸ç§°ä¸ºèƒŒåŒ…é—®é¢˜( Knapsack problem ) â€”â€” æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„ NP å®Œå…¨é—®é¢˜ã€‚NP å®Œå…¨é—®é¢˜æŒ‡çš„æ˜¯éœ€è¦ç›¸å½“é•¿æ—¶é—´æ‰èƒ½æ‰¾åˆ°æœ€ä¼˜è§£å†³æ–¹æ¡ˆçš„é—®é¢˜ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å·²çŸ¥é“æŠ€å·§èƒ½å¤Ÿå¿«é€Ÿè§£å†³è¿™ç±»é—®é¢˜ã€‚</p></blockquote><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåªè€ƒè™‘ <code>memory</code> èµ„æºæƒ…å†µä¸‹ï¼Œæœ‰ä¸€å° Slave å†…å­˜ä¸º 8GB ï¼Œç°åœ¨è¦è¿è¡Œä¸‰ä¸ª 1GB çš„ä½œä¸šå’Œ 5GB çš„ä½œä¸šã€‚å…¶ä¸­ 5GB çš„ä½œä¸šåœ¨ 1GB è¿è¡Œå¤šæ¬¡ä¹‹åæ‰æ‰§è¡Œã€‚ </p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/06.png" alt=""></p><p>å®é™…æƒ…å†µä¼šæ¯”å›¾æ›´åŠ å¤æ‚çš„å¤šçš„å¤šã€‚é€šè¿‡ä½¿ç”¨ Fenzo ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ï¼Œå¹¶ä¸”ä»¤äººæ»¡æ„çš„åˆ†é…ã€‚ä¸ºäº†è®©ä½ å¯¹ Fenzo æœ‰æ›´åŠ é€å½»çš„ç†è§£ï¼Œè¿™é‡Œå†å¼•ç”¨ä¸€æ®µå¯¹å…¶çš„ä»‹ç»ï¼š</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P80<br><strong>è°ƒç”¨åº“å‡½æ•° Fenzo</strong><br>Fenzo æ˜¯ Nettflix åœ¨ 2015 å¹´å¤å¤©å‘å¸ƒçš„åº“å‡½æ•°ã€‚Fenzo ä¸ºåŸºäº java çš„è°ƒåº¦å™¨æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œå®Œæˆ offer ç¼“å†²ï¼Œå¤šä»»åŠ¡å¯åŠ¨ï¼Œä»¥åŠè½¯å’Œç¡¬çº¦æŸæ¡ä»¶çš„åŒ¹é…ã€‚å°±ç®—ä¸æ˜¯æ‰€æœ‰çš„ï¼Œä¹Ÿæ˜¯å¾ˆå¤šè°ƒåº¦å™¨éƒ½èƒ½å¤Ÿå—ç›Šäºä½¿ç”¨ Fenzo æ¥å®Œæˆè®¡ç®—ä»»åŠ¡åˆ†é…ï¼Œè€Œä¸ç”¨è‡ªå·±ç¼–å†™ offer ç¼“å†²ã€æ‰“åŒ…å’Œæ”¾ç½®è·¯ç”±ç­‰ã€‚</p></blockquote><p>ä¸‹é¢ï¼Œæ¥çœ‹ä¸¤æ¬¡ <code>TaskScheduler#scheduleOnce(...)</code> çš„è¿”å›ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡è°ƒåº¦ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/07.png" alt=""></li><li>ç¬¬äºŒæ¬¡è°ƒåº¦ï¼š<img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/08.png" alt=""></li><li><p><code>com.netflix.fenzo.VMAssignmentResult</code>ï¼Œæ¯å°ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VMAssignmentResult</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä¸»æœº</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String hostname;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½¿ç”¨çš„ Mesos Offer</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ†é…çš„ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;TaskAssignmentResult&gt; tasksAssigned;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p>å—é™äºç¬”è€…çš„èƒ½åŠ›ï¼Œå»ºè®®ä½ å¯ä»¥åœ¨é˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼Œæ›´é€å½»çš„ç†è§£ TaskScheduler ï¼š</p><ul><li><a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Constraintsã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Building-Your-Scheduler" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Building Your Schedulerã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Scheduling-Tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Scheduling Tasksã€‹</a></li><li><a href="https://github.com/Netflix/Fenzo/wiki/Insights#how-to-learn-which-tasks-are-assigned-to-which-hosts" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” How to Learn Which Tasks Are Assigned to Which Hostsã€‹</a></li></ul><h2 id="4-4-åˆ›å»º-Mesos-ä»»åŠ¡ä¿¡æ¯"><a href="#4-4-åˆ›å»º-Mesos-ä»»åŠ¡ä¿¡æ¯" class="headerlink" title="4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯"></a>4.4 åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">List&lt;TaskContext&gt; taskContextsList = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">Map&lt;List&lt;Protos.OfferID&gt;, List&lt;Protos.TaskInfo&gt;&gt; offerIdTaskInfoMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆ</span></div><div class="line"><span class="keyword">for</span> (VMAssignmentResult each: vmAssignmentResults) &#123;</div><div class="line">    List&lt;VirtualMachineLease&gt; leasesUsed = each.getLeasesUsed();</div><div class="line">    List&lt;Protos.TaskInfo&gt; taskInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;(each.getTasksAssigned().size() * <span class="number">10</span>);</div><div class="line">    taskInfoList.addAll(getTaskInfoList(</div><div class="line">            launchingTasks.getIntegrityViolationJobs(vmAssignmentResults), <span class="comment">// è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line">            each, leasesUsed.get(<span class="number">0</span>).hostname(), leasesUsed.get(<span class="number">0</span>).getOffer()));</div><div class="line">    <span class="keyword">for</span> (Protos.TaskInfo taskInfo : taskInfoList) &#123;</div><div class="line">        taskContextsList.add(TaskContext.from(taskInfo.getTaskId().getValue()));</div><div class="line">    &#125;</div><div class="line">    offerIdTaskInfoMap.put(getOfferIDs(leasesUsed), <span class="comment">// è·å¾— Offer ID é›†åˆ</span></div><div class="line">            taskInfoList);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>offerIdTaskInfoMap</code>ï¼ŒMesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚key å’Œ value éƒ½ä¸ºç›¸åŒ Mesos Slave Offer å’Œ ä»»åŠ¡ã€‚ä¸ºä»€ä¹ˆï¼Ÿè°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•æäº¤<strong>ä¸€æ¬¡</strong>ä»»åŠ¡æ—¶ï¼Œå¿…é¡»ä¿è¯æ‰€æœ‰ä»»åŠ¡å’Œ Offer åœ¨ç›¸åŒ Mesos Slave ä¸Šã€‚</p><blockquote><p>FROM FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P61<br><strong>ç»„åˆ offer</strong><br>latchTasks æ¥å— offer åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™å°±å…è®¸ç”¨æˆ·å°†ä¸€äº›ç›¸åŒ slave çš„ offer ç»„åˆèµ·æ¥ï¼Œä»è€Œå°†è¿™äº› offer çš„èµ„æºæ”¾åˆ°æ± é‡Œã€‚å®ƒè¿˜èƒ½æ¥å—ä»»åŠ¡åˆ—è¡¨ä¸ºè¾“å…¥ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¯åŠ¨é€‚åˆç»™å®š offer çš„è¶³å¤Ÿå¤šçš„ä»»åŠ¡ã€‚æ³¨æ„æ‰€æœ‰ä»»åŠ¡å’Œ offer éƒ½å¿…é¡»æ˜¯åŒä¸€å° slave â€”â€” å¦‚æœä¸åœ¨åŒä¸€å° slave ä¸Šï¼ŒlaunchTasks å°±ä¼šå¤±è´¥ã€‚å¦‚æœæƒ³åœ¨å¤šå° slave ä¸Šå¯åŠ¨ä»»åŠ¡ï¼Œå¤šæ¬¡è°ƒç”¨ latchTasks å³å¯ã€‚</p></blockquote></li><li><p>è°ƒç”¨ <code>LaunchingTasks#getIntegrityViolationJobs(...)</code> æ–¹æ³•ï¼Œè·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆã€‚<strong>ä¸€ä¸ªä½œä¸šæœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œå› ä¸º Mesos Offer ä¸è¶³ï¼Œå¯¼è‡´æœ‰éƒ¨åˆ†åˆ†ç‰‡ä¸èƒ½æ‰§è¡Œï¼Œåˆ™æ•´ä¸ªä½œä¸šéƒ½ä¸è¿›è¡Œæ‰§è¡Œ</strong>ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LaunchingTasks.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä½œä¸šé›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function">Collection&lt;String&gt; <span class="title">getIntegrityViolationJobs</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; assignedJobShardingTotalCountMap = getAssignedJobShardingTotalCountMap(vmAssignmentResults);</div><div class="line">   Collection&lt;String&gt; result = <span class="keyword">new</span> HashSet&lt;&gt;(assignedJobShardingTotalCountMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : assignedJobShardingTotalCountMap.entrySet()) &#123;</div><div class="line">       JobContext jobContext = eligibleJobContextsMap.get(entry.getKey());</div><div class="line">       <span class="keyword">if</span> (ExecutionType.FAILOVER != jobContext.getType() <span class="comment">// ä¸åŒ…æ‹¬ FAILOVER æ‰§è¡Œç±»å‹çš„ä½œä¸š</span></div><div class="line">               &amp;&amp; !entry.getValue().equals(jobContext.getJobConfig().getTypeConfig().getCoreConfig().getShardingTotalCount())) &#123;</div><div class="line">           log.warn(<span class="string">"Job &#123;&#125; is not assigned at this time, because resources not enough to run all sharding instances."</span>, entry.getKey());</div><div class="line">           result.add(entry.getKey());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* è·å¾—æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</span></div><div class="line"><span class="comment">* keyï¼šä½œä¸šå</span></div><div class="line"><span class="comment">* valueï¼šåˆ†ç‰‡æ€»æ•°</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> vmAssignmentResults ä¸»æœºåˆ†é…ä»»åŠ¡ç»“æœé›†åˆ</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ¯ä¸ªä½œä¸šåˆ†ç‰‡æ•°é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title">getAssignedJobShardingTotalCountMap</span><span class="params">(<span class="keyword">final</span> Collection&lt;VMAssignmentResult&gt; vmAssignmentResults)</span> </span>&#123;</div><div class="line">   Map&lt;String, Integer&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(eligibleJobContextsMap.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (VMAssignmentResult vmAssignmentResult: vmAssignmentResults) &#123;</div><div class="line">       <span class="keyword">for</span> (TaskAssignmentResult tasksAssigned: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">           String jobName = TaskContext.from(tasksAssigned.getTaskId()).getMetaInfo().getJobName();</div><div class="line">           <span class="keyword">if</span> (result.containsKey(jobName)) &#123;</div><div class="line">               result.put(jobName, result.get(jobName) + <span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               result.put(jobName, <span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>#getTaskInfoList(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä¸ªä¸»æœº</strong>çš„ Mesos ä»»åŠ¡ä¿¡æ¯é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.TaskInfo&gt; getTaskInfoList(<span class="keyword">final</span> Collection&lt;String&gt; integrityViolationJobs, <span class="keyword">final</span> VMAssignmentResult vmAssignmentResult, <span class="keyword">final</span> String hostname, <span class="keyword">final</span> Protos.Offer offer) &#123;</div><div class="line">   List&lt;Protos.TaskInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(vmAssignmentResult.getTasksAssigned().size());</div><div class="line">   <span class="keyword">for</span> (TaskAssignmentResult each: vmAssignmentResult.getTasksAssigned()) &#123;</div><div class="line">       TaskContext taskContext = TaskContext.from(each.getTaskId());</div><div class="line">       String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">       <span class="keyword">if</span> (!integrityViolationJobs.contains(jobName) <span class="comment">// æ’é™¤ä½œä¸šåˆ†ç‰‡ä¸å®Œæ•´çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isRunning(taskContext) <span class="comment">// æ’é™¤æ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡</span></div><div class="line">               &amp;&amp; !facadeService.isJobDisabled(jobName)) &#123; <span class="comment">// æ’é™¤è¢«ç¦ç”¨çš„ä»»åŠ¡</span></div><div class="line">           <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡</span></div><div class="line">           Protos.TaskInfo taskInfo = getTaskInfo(offer, each);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> != taskInfo) &#123;</div><div class="line">               result.add(taskInfo);</div><div class="line">               <span class="comment">// æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line">               facadeService.addMapping(taskInfo.getTaskId().getValue(), hostname);</div><div class="line">               <span class="comment">// é€šçŸ¥ TaskScheduler ä¸»æœºåˆ†é…äº†è¿™ä¸ªä»»åŠ¡</span></div><div class="line">               taskScheduler.getTaskAssigner().call(each.getRequest(), hostname);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>#getTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ï¼Œåœ¨<a href="#">ã€Œ4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€</a>è¯¦ç»†è§£æã€‚</li><li><p>è°ƒç”¨ <code>FacadeService#addMapping(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„ã€‚é€šè¿‡è¯¥æ˜ å°„ï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡ä¸»é”®æŸ¥è¯¢åˆ°å¯¹åº”çš„ä¸»æœºåã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskId ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> hostname ä¸»æœºåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   runningService.addMapping(taskId, hostname);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»»åŠ¡ä¸»é”®å’Œä¸»æœºåç§°çš„æ˜ å°„</span></div><div class="line"><span class="comment">* key: ä»»åŠ¡ä¸»é”®</span></div><div class="line"><span class="comment">* value: ä¸»æœºåç§°</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, String&gt; TASK_HOSTNAME_MAPPER = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(TASK_INITIAL_SIZE);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">final</span> String taskId, <span class="keyword">final</span> String hostname)</span> </span>&#123;</div><div class="line">   TASK_HOSTNAME_MAPPER.putIfAbsent(taskId, hostname);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>TaskScheduler#getTaskAssigner()#call(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>åˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚</p></li></ul></li><li><p>è°ƒç”¨ <code>#getOfferIDs(...)</code> æ–¹æ³•ï¼Œè·å¾— Offer ID é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Protos.OfferID&gt; getOfferIDs(<span class="keyword">final</span> List&lt;VirtualMachineLease&gt; leasesUsed) &#123;</div><div class="line">   List&lt;Protos.OfferID&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (VirtualMachineLease virtualMachineLease: leasesUsed) &#123;</div><div class="line">       result.add(virtualMachineLease.getOffer().getId());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="4-4-1-åˆ›å»ºå•ä¸ª-Mesos-ä»»åŠ¡ä¿¡æ¯"><a href="#4-4-1-åˆ›å»ºå•ä¸ª-Mesos-ä»»åŠ¡ä¿¡æ¯" class="headerlink" title="4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯"></a>4.4.1 åˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯</h3><p>è°ƒç”¨ <code>#getTaskInfo()</code> æ–¹æ³•ï¼Œåˆ›å»ºå•ä¸ª Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p><strong>å¦‚ä¸‹ä¼šæ¶‰åŠå¤§é‡çš„ Mesos API</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">getTaskInfo</span><span class="params">(<span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> TaskAssignmentResult taskAssignmentResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   TaskContext taskContext = TaskContext.from(taskAssignmentResult.getTaskId());</div><div class="line">   Optional&lt;CloudJobConfiguration&gt; jobConfigOptional = facadeService.load(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (!jobConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudJobConfiguration jobConfig = jobConfigOptional.get();</div><div class="line">   <span class="comment">// æ ¡éªŒ ä½œä¸šé…ç½® æ˜¯å¦å­˜åœ¨</span></div><div class="line">   Optional&lt;CloudAppConfiguration&gt; appConfigOptional = facadeService.loadAppConfig(jobConfig.getAppName());</div><div class="line">   <span class="keyword">if</span> (!appConfigOptional.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   CloudAppConfiguration appConfig = appConfigOptional.get();</div><div class="line">   <span class="comment">// è®¾ç½® Mesos Slave ID</span></div><div class="line">   taskContext.setSlaveId(offer.getSlaveId().getValue());</div><div class="line">   <span class="comment">// è·å¾— åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line">   ShardingContexts shardingContexts = getShardingContexts(taskContext, appConfig, jobConfig);</div><div class="line">   <span class="comment">// ç¬æ—¶çš„è„šæœ¬ä½œä¸šï¼Œä½¿ç”¨ Mesos å‘½ä»¤è¡Œæ‰§è¡Œï¼Œæ— éœ€ä½¿ç”¨æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">boolean</span> isCommandExecutor = CloudJobExecutionType.TRANSIENT == jobConfig.getJobExecutionType() &amp;&amp; JobType.SCRIPT == jobConfig.getTypeConfig().getJobType();</div><div class="line">   String script = appConfig.getBootstrapScript();</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       script = ((ScriptJobConfiguration) jobConfig.getTypeConfig()).getScriptCommandLine();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// åˆ›å»º å¯åŠ¨å‘½ä»¤</span></div><div class="line">   Protos.CommandInfo.URI uri = buildURI(appConfig, isCommandExecutor);</div><div class="line">   Protos.CommandInfo command = buildCommand(uri, script, shardingContexts, isCommandExecutor);</div><div class="line">   <span class="comment">// åˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       <span class="keyword">return</span> buildCommandExecutorTaskInfo(taskContext, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span> buildCustomizedExecutorTaskInfo(taskContext, appConfig, jobConfig, shardingContexts, offer, command);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#getShardingContexts(...)</code> æ–¹æ³•ï¼Œ è·å¾—åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameters = <span class="keyword">new</span> ShardingItemParameters(jobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   Map&lt;Integer, String&gt; assignedShardingItemParameters = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   <span class="keyword">int</span> shardingItem = taskContext.getMetaInfo().getShardingItems().get(<span class="number">0</span>); <span class="comment">// å•ä¸ªä½œä¸šåˆ†ç‰‡</span></div><div class="line">   assignedShardingItemParameters.put(shardingItem, shardingItemParameters.containsKey(shardingItem) ? shardingItemParameters.get(shardingItem) : <span class="string">""</span>);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(taskContext.getId(), jobConfig.getJobName(), jobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           jobConfig.getTypeConfig().getCoreConfig().getJobParameter(), assignedShardingItemParameters, appConfig.getEventTraceSamplingCount());</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>å½“ä»»åŠ¡ä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šæ—¶ï¼Œä½¿ç”¨ Mesos Slave å‘½ä»¤è¡Œè°ƒç”¨å³å¯ï¼Œæ— éœ€ä½¿ç”¨ Elastic-Job-Cloud-Executorã€‚</p></li><li><p>è°ƒç”¨ <code>#buildURI(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€ã€‚è¯•ä¸‹ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.CommandInfo.<span class="function">URI <span class="title">buildURI</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.URI.Builder result = Protos.CommandInfo.URI.newBuilder()</div><div class="line">           .setValue(appConfig.getAppURL())</div><div class="line">           .setCache(appConfig.isAppCacheEnable()); <span class="comment">// cache</span></div><div class="line">   <span class="keyword">if</span> (isCommandExecutor &amp;&amp; !SupportedExtractionType.isExtraction(appConfig.getAppURL())) &#123;</div><div class="line">       result.setExecutable(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦å¯æ‰§è¡Œ</span></div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setExtract(<span class="keyword">true</span>); <span class="comment">// æ˜¯å¦éœ€è¦è§£å‹</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appURL</code> ï¼Œé€šè¿‡ Mesos å®ç°æ–‡ä»¶çš„ä¸‹è½½ã€‚</li><li><p>äº‘ä½œä¸šåº”ç”¨é…ç½® <code>CloudAppConfiguration.appCacheEnable</code>ï¼Œåº”ç”¨æ–‡ä»¶ä¸‹è½½æ˜¯å¦ç¼“å­˜ã€‚</p><blockquote><p>FROM <a href="http://product.dangdang.com/24187450.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a> P99<br><strong>Fetcher ç¼“å­˜</strong><br>Mesos 0.23 é‡Œå‘å¸ƒç§°ä¸º fetcher ç¼“å­˜çš„æ–°åŠŸèƒ½ã€‚fetcher ç¼“å­˜ç¡®ä¿æ¯ä¸ª artifact åœ¨æ¯ä¸ª slave åªä¼šä¸‹è½½ä¸€æ¬¡ï¼Œå³ä½¿å¤šä¸ªæ‰§è¡Œå™¨è¯·æ±‚åŒä¸€ä¸ª artifactï¼Œä¹Ÿåªéœ€è¦ç­‰å¾…å•è¯ä¸‹è½½å®Œæˆå³å¯ã€‚</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>#buildCommand(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰§è¡Œå™¨å¯åŠ¨å‘½ä»¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">CommandInfo <span class="title">buildCommand</span><span class="params">(<span class="keyword">final</span> Protos.CommandInfo.URI uri, <span class="keyword">final</span> String script, <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> <span class="keyword">boolean</span> isCommandExecutor)</span> </span>&#123;</div><div class="line">   Protos.CommandInfo.Builder result = Protos.CommandInfo.newBuilder().addUris(uri).setShell(<span class="keyword">true</span>);</div><div class="line">   <span class="keyword">if</span> (isCommandExecutor) &#123;</div><div class="line">       CommandLine commandLine = CommandLine.parse(script);</div><div class="line">       commandLine.addArgument(GsonFactory.getGson().toJson(shardingContexts), <span class="keyword">false</span>);</div><div class="line">       result.setValue(Joiner.on(<span class="string">" "</span>).join(commandLine.getExecutable(), Joiner.on(<span class="string">" "</span>).join(commandLine.getArguments())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       result.setValue(script);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>#buildCommandExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œä¸º<strong>ç¬æ—¶</strong>çš„<strong>è„šæœ¬</strong>ä½œä¸šåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCommandExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudJobConfiguration jobConfig, <span class="keyword">final</span> ShardingContexts shardingContexts,</span></span></div><div class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command)</span> </span>&#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize())); <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> result.setCommand(command).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>è°ƒç”¨ <code>#buildCustomizedExecutorTaskInfo(...)</code> æ–¹æ³•ï¼Œåˆ›å»º Mesos ä»»åŠ¡ä¿¡æ¯ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Protos.<span class="function">TaskInfo <span class="title">buildCustomizedExecutorTaskInfo</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> CloudAppConfiguration appConfig, <span class="keyword">final</span> CloudJobConfiguration jobConfig, </span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> ShardingContexts shardingContexts, <span class="keyword">final</span> Protos.Offer offer, <span class="keyword">final</span> Protos.CommandInfo command)</span> </span>&#123;</div><div class="line">   Protos.TaskInfo.Builder result = Protos.TaskInfo.newBuilder().setTaskId(Protos.TaskID.newBuilder().setValue(taskContext.getId()).build())</div><div class="line">           .setName(taskContext.getTaskName()).setSlaveId(offer.getSlaveId())</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, jobConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, jobConfig.getMemoryMB(), offer.getResourcesList()))</div><div class="line">           .setData(ByteString.copyFrom(<span class="keyword">new</span> TaskInfoData(shardingContexts, jobConfig).serialize()));</div><div class="line">   <span class="comment">// ExecutorInfo</span></div><div class="line">   Protos.ExecutorInfo.Builder executorBuilder = Protos.ExecutorInfo.newBuilder().setExecutorId(Protos.ExecutorID.newBuilder()</div><div class="line">           .setValue(taskContext.getExecutorId(jobConfig.getAppName()))) <span class="comment">// æ‰§è¡Œå™¨ ID</span></div><div class="line">           .setCommand(command)</div><div class="line">           .addResources(buildResource(<span class="string">"cpus"</span>, appConfig.getCpuCount(), offer.getResourcesList()))</div><div class="line">           .addResources(buildResource(<span class="string">"mem"</span>, appConfig.getMemoryMB(), offer.getResourcesList()));</div><div class="line">   <span class="keyword">if</span> (env.getJobEventRdbConfiguration().isPresent()) &#123;</div><div class="line">       executorBuilder.setData(ByteString.copyFrom(SerializationUtils.serialize(env.getJobEventRdbConfigurationMap()))).build();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.setExecutor(executorBuilder.build()).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>Protos.ExecutorInfo.Builder#setValue(...)</code> æ–¹æ³•ï¼Œè®¾ç½®<strong>æ‰§è¡Œå™¨ç¼–å·</strong>ã€‚å¤§å¤šæ•°åœ¨ Mesos å®ç°çš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ‰§è¡Œå™¨ã€‚è€Œ Elastic-Job-Cloud-Executor ä¸åŒäºå¤§å¤šæ•°åœ¨ Mesos ä¸Šçš„æ‰§è¡Œå™¨ï¼Œä¸€ä¸ªæ‰§è¡Œå™¨å¯ä»¥å¯¹åº”å¤šä¸ªä½œä¸šã€‚ä»€ä¹ˆæ„æ€ï¼Ÿåœ¨ä¸€ä¸ª Mesos Slaveï¼Œ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåªä¼šå¯åŠ¨ä¸€ä¸ª Elastic-Job-Cloud-Schedulerã€‚å½“è¯¥æ‰§è¡Œå™¨ä¸å­˜åœ¨æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªã€‚å½“è¯¥æ‰§è¡Œå™¨å·²ç»å­˜åœ¨ï¼Œå¤ç”¨è¯¥æ‰§è¡Œå™¨ã€‚é‚£ä¹ˆæ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„å‘¢ï¼Ÿ<strong>ç›¸åŒ</strong>ä½œä¸šåº”ç”¨ï¼Œåœ¨åŒä¸€ä¸ª Mesos Slaveï¼Œä½¿ç”¨ç›¸åŒæ‰§è¡Œå™¨ç¼–å·ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * è·å–ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> appName åº”ç”¨åç§°</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> ä»»åŠ¡æ‰§è¡Œå™¨ä¸»é”®</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getExecutorId</span><span class="params">(<span class="keyword">final</span> String appName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Joiner.on(DELIMITER).join(appName, slaveId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li></ul><h2 id="4-5-å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—"><a href="#4-5-å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—" class="headerlink" title="4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—"></a>4.5 å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—</h2><p>è°ƒç”¨ <code>FacadeService#addRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.add(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ”¾å…¥è¿è¡Œæ—¶é˜Ÿåˆ—.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!configurationService.load(taskContext.getMetaInfo().getJobName()).isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).add(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemon(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ°è¿è¡Œä¸­é˜Ÿåˆ—</span></div><div class="line">   String runningTaskNodePath = RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString());</div><div class="line">   <span class="keyword">if</span> (!regCenter.isExisted(runningTaskNodePath)) &#123;</div><div class="line">       regCenter.persist(runningTaskNodePath, taskContext.getId());</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningNode.java</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunningNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = StateNode.ROOT + <span class="string">"/running"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_JOB = ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNNING_TASK = RUNNING_JOB + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;TASK_META_INFO&#125;ã€‚$&#123;TASK_META_INFO&#125;=$&#123;JOB_NAME&#125;@-@$&#123;ITEM_ID&#125;ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>RunningServiceï¼Œä»»åŠ¡è¿è¡Œæ—¶æœåŠ¡ï¼Œæä¾›å¯¹è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆã€è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—çš„å„ç§æ“ä½œæ–¹æ³•ã€‚</li><li><p>è°ƒç”¨ <code>#getRunningTasks()</code> æ–¹æ³•ï¼Œè·å¾—<strong>è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</strong>ï¼Œå¹¶å°†å½“å‰ä»»åŠ¡æ·»åŠ åˆ°å…¶ä¸­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;TaskContext&gt; <span class="title">getRunningTasks</span><span class="params">(<span class="keyword">final</span> String jobName)</span> </span>&#123;</div><div class="line">   Set&lt;TaskContext&gt; taskContexts = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</div><div class="line">   Collection&lt;TaskContext&gt; result = RUNNING_TASKS.putIfAbsent(jobName, taskContexts);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == result ? taskContexts : result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>  åœ¨è¿ç»´å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“å‰ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼š</p><p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/09.png" alt=""></p></li><li><p>å¸¸é©»ä½œä¸šä¼šå­˜å‚¨åœ¨<strong>è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—</strong>ã€‚è¿è¡Œä¸­ä½œä¸šé˜Ÿåˆ—å­˜å‚¨åœ¨æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>/${NAMESPACE}/state/running/${JOB_NAME}/${TASK_META_INFO}</code>ï¼Œå­˜å‚¨å€¼ä¸ºä»»åŠ¡ç¼–å·ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š </p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 14] ls /elastic-job-cloud/state/running/test_job_simple</div><div class="line">[test_job_simple@-@0, test_job_simple@-@1, test_job_simple@-@2]</div><div class="line">[zk: localhost:2181(CONNECTED) 15] get /elastic-job-cloud/state/running/test_job_simple/test_job_simple@-@0</div><div class="line">test_job_simple@-@0@-@READY@-@400197d9-76ca-464b-b2f0-e0fba5c2a598-S0@-@9780ed12-9612-45e3-ac14-feb2911896ff</div></pre></td></tr></table></figure></li></ul><h2 id="4-6-ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š"><a href="#4-6-ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š" class="headerlink" title="4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š"></a>4.6 ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line">facadeService.removeLaunchTasksFromQueue(taskContextsList);</div><div class="line"></div><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²è¿è¡Œçš„ä½œä¸š.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContexts ä»»åŠ¡ä¸Šä¸‹æ–‡é›†åˆ</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLaunchTasksFromQueue</span><span class="params">(<span class="keyword">final</span> List&lt;TaskContext&gt; taskContexts)</span> </span>&#123;</div><div class="line">   List&lt;TaskContext&gt; failoverTaskContexts = <span class="keyword">new</span> ArrayList&lt;&gt;(taskContexts.size());</div><div class="line">   Collection&lt;String&gt; readyJobNames = <span class="keyword">new</span> HashSet&lt;&gt;(taskContexts.size(), <span class="number">1</span>);</div><div class="line">   <span class="keyword">for</span> (TaskContext each : taskContexts) &#123;</div><div class="line">       <span class="keyword">switch</span> (each.getType()) &#123;</div><div class="line">           <span class="keyword">case</span> FAILOVER:</div><div class="line">               failoverTaskContexts.add(each);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> READY:</div><div class="line">               readyJobNames.add(each.getMetaInfo().getJobName());</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ä»å¤±æ•ˆè½¬ç§»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä»»åŠ¡</span></div><div class="line">   failoverService.remove(Lists.transform(failoverTaskContexts, <span class="keyword">new</span> Function&lt;TaskContext, TaskContext.MetaInfo&gt;() &#123;</div><div class="line">       </div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="keyword">public</span> TaskContext.<span class="function">MetaInfo <span class="title">apply</span><span class="params">(<span class="keyword">final</span> TaskContext input)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> input.getMetaInfo();</div><div class="line">       &#125;</div><div class="line">   &#125;));</div><div class="line">   <span class="comment">// ä»å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ é™¤ç›¸å…³ä½œä¸š</span></div><div class="line">   readyService.remove(readyJobNames);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-7-æäº¤ä»»åŠ¡ç»™-Mesos"><a href="#4-7-æäº¤ä»»åŠ¡ç»™-Mesos" class="headerlink" title="4.7 æäº¤ä»»åŠ¡ç»™ Mesos"></a>4.7 æäº¤ä»»åŠ¡ç»™ Mesos</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// #runOneIteration()</span></div><div class="line"><span class="keyword">for</span> (Entry&lt;List&lt;OfferID&gt;, List&lt;TaskInfo&gt;&gt; each : offerIdTaskInfoMap.entrySet()) &#123;</div><div class="line">   schedulerDriver.launchTasks(each.getKey(), each.getValue());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>SchedulerDriver#launchTasks(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç»™ Mesos Masterã€‚ç”± Mesos Master è°ƒåº¦ä»»åŠ¡ç»™ Mesos Slaveã€‚Mesos Slave æäº¤æ‰§è¡Œå™¨æ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h1 id="5-TaskExecutor-æ‰§è¡Œä»»åŠ¡"><a href="#5-TaskExecutor-æ‰§è¡Œä»»åŠ¡" class="headerlink" title="5. TaskExecutor æ‰§è¡Œä»»åŠ¡"></a>5. TaskExecutor æ‰§è¡Œä»»åŠ¡</h1><p>TaskExecutorï¼Œå®ç°äº† Mesos Executor æ¥å£ <code>org.apache.mesos.Executor</code>ã€‚æ‰§è¡Œå™¨çš„ä¸»è¦èŒè´£ä¹‹ä¸€ï¼š<strong>æ‰§è¡Œè°ƒåº¦å™¨æ‰€è¯·æ±‚çš„ä»»åŠ¡</strong>ã€‚TaskExecutor æ¥æ”¶åˆ° Mesos Slave æäº¤çš„ä»»åŠ¡ï¼Œè°ƒç”¨ <code>#launchTask(...)</code> æ–¹æ³•ï¼Œå¤„ç†ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// DaemonTaskScheduler.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">launchTask</span><span class="params">(<span class="keyword">final</span> ExecutorDriver executorDriver, <span class="keyword">final</span> Protos.TaskInfo taskInfo)</span> </span>&#123;</div><div class="line">   executorService.submit(<span class="keyword">new</span> TaskThread(executorDriver, taskInfo));</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>ExecutorService#submit(...)</code> æ–¹æ³•ï¼Œæäº¤ TaskThread åˆ°çº¿ç¨‹æ± ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h2 id="5-1-TaskThread"><a href="#5-1-TaskThread" class="headerlink" title="5.1 TaskThread"></a>5.1 TaskThread</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@RequiredArgsConstructor</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ExecutorDriver executorDriver;</div><div class="line">   </div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TaskInfo taskInfo;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œè¿è¡Œä¸­ã€‚</span></div><div class="line">       executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_RUNNING).build());</div><div class="line">       <span class="comment">//</span></div><div class="line">       Map&lt;String, Object&gt; data = SerializationUtils.deserialize(taskInfo.getData().toByteArray());</div><div class="line">       ShardingContexts shardingContexts = (ShardingContexts) data.get(<span class="string">"shardingContext"</span>);</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       JobConfigurationContext jobConfig = <span class="keyword">new</span> JobConfigurationContext((Map&lt;String, String&gt;) data.get(<span class="string">"jobConfigContext"</span>));</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å¾— åˆ†å¸ƒå¼ä½œä¸š</span></div><div class="line">           ElasticJob elasticJob = getElasticJobInstance(jobConfig);</div><div class="line">           <span class="comment">// è°ƒåº¦å™¨æä¾›å†…éƒ¨æœåŠ¡çš„é—¨é¢å¯¹è±¡</span></div><div class="line">           <span class="keyword">final</span> CloudJobFacade jobFacade = <span class="keyword">new</span> CloudJobFacade(shardingContexts, jobConfig, jobEventBus);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           <span class="keyword">if</span> (jobConfig.isTransient()) &#123;</div><div class="line">               <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">               JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">               <span class="comment">// æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ï¼Œå·²å®Œæˆã€‚</span></div><div class="line">               executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_FINISHED).build());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// åˆå§‹åŒ– å¸¸é©»ä½œä¸šè°ƒåº¦å™¨</span></div><div class="line">               <span class="keyword">new</span> DaemonTaskScheduler(elasticJob, jobConfig, jobFacade, executorDriver, taskInfo.getTaskId()).init();</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// CHECKSTYLE:OFF</span></div><div class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable ex) &#123;</div><div class="line">           <span class="comment">// CHECKSTYLE:ON</span></div><div class="line">           log.error(<span class="string">"Elastic-Job-Cloud-Executor error"</span>, ex);</div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskInfo.getTaskId()).setState(Protos.TaskState.TASK_ERROR).setMessage(ExceptionUtil.transform(ex)).build());</div><div class="line">           executorDriver.stop();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>ä» <code>TaskInfo.data</code> å±æ€§ä¸­ï¼Œå¯ä»¥è·å¾—æäº¤ä»»åŠ¡é™„å¸¦çš„æ•°æ®ï¼Œä¾‹å¦‚åˆ†ç‰‡ä¸Šä¸‹æ–‡é›†åˆ( ShardingContexts )ï¼Œå†…éƒ¨çš„ä½œä¸šé…ç½®ä¸Šä¸‹æ–‡( JobConfigurationContext )ã€‚</li><li><p>è°ƒç”¨ <code>#getElasticJobInstance()</code> æ–¹æ³•ï¼Œè·å¾—ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„åˆ†å¸ƒå¼ä½œä¸š( Elastic-Job )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobInstance</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!Strings.isNullOrEmpty(jobConfig.getBeanName()) &amp;&amp; !Strings.isNullOrEmpty(jobConfig.getApplicationContext())) &#123; <span class="comment">// spring ç¯å¢ƒ</span></div><div class="line">      <span class="keyword">return</span> getElasticJobBean(jobConfig);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> getElasticJobClass(jobConfig);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* ä» Spring å®¹å™¨ä¸­è·å¾—ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobBean</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String applicationContextFile = jobConfig.getApplicationContext();</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (applicationContexts) &#123;</div><div class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == applicationContexts.get(applicationContextFile)) &#123;</div><div class="line">              applicationContexts.put(applicationContextFile, <span class="keyword">new</span> ClassPathXmlApplicationContext(applicationContextFile));</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> (ElasticJob) applicationContexts.get(applicationContextFile).getBean(jobConfig.getBeanName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> ä½œä¸šå¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">private</span> ElasticJob <span class="title">getElasticJobClass</span><span class="params">(<span class="keyword">final</span> JobConfigurationContext jobConfig)</span> </span>&#123;</div><div class="line">  String jobClass = jobConfig.getTypeConfig().getJobClass();</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; elasticJobClass = Class.forName(jobClass);</div><div class="line">      <span class="keyword">if</span> (!ElasticJob.class.isAssignableFrom(elasticJobClass)) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' must implements ElasticJob interface."</span>, jobClass);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (elasticJobClass != ScriptJob.class) &#123;</div><div class="line">          <span class="keyword">return</span> (ElasticJob) elasticJobClass.newInstance();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ReflectiveOperationException ex) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(<span class="string">"Elastic-Job: Class '%s' initialize failure, the error message is '%s'."</span>, jobClass, ex.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>å½“ä½œä¸šæ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ï¼Œå¹¶è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> å‘é€çŠ¶æ€ï¼Œæ›´æ–° Mesos ä»»åŠ¡å·²å®Œæˆ( Protos.TaskState.TASK_FINISHED )ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li>å½“ä½œä¸šæ˜¯<strong>å¸¸é©»</strong>ä½œä¸šæ—¶ï¼Œè°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–ä½œä¸šè°ƒåº¦ï¼Œåœ¨ã€Œ5.2 DaemonTaskSchedulerã€è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2 id="5-2-DaemonTaskScheduler"><a href="#5-2-DaemonTaskScheduler" class="headerlink" title="5.2 DaemonTaskScheduler"></a>5.2 DaemonTaskScheduler</h2><p><strong>ç¬æ—¶</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Cloud-Scheduler è°ƒåº¦ä»»åŠ¡ï¼Œæäº¤ Elastic-Job-Cloud-Executor æ‰§è¡Œåï¼Œç­‰å¾… Elastic-Job-Scheduler è¿›è¡Œä¸‹æ¬¡è°ƒåº¦ã€‚</p><p><strong>å¸¸é©»</strong>ä½œä¸šï¼Œé€šè¿‡ Elastic-Job-Scheduler æäº¤ Elastic-Job-Cloud-Executor è¿›è¡Œè°ƒåº¦ã€‚Elastic-Job-Cloud-Executor ä½¿ç”¨ DaemonTaskScheduler ä¸æ–­å¯¹å¸¸é©»ä½œä¸šè¿›è¡Œè°ƒåº¦è€Œæ— éœ€ Elastic-Job-Cloud-Scheduler å‚ä¸å…¶ä¸­ã€‚</p><p>è¿™å°±æ˜¯<strong>ç¬æ—¶</strong>ä½œä¸šå’Œ<strong>å¸¸é©»</strong>ä½œä¸šä¸åŒä¹‹å¤„ã€‚</p><p>DaemonTaskSchedulerï¼Œå¸¸é©»ä½œä¸šè°ƒåº¦å™¨ã€‚è°ƒç”¨ <code>DaemonTaskScheduler#init()</code> æ–¹æ³•ï¼Œå¯¹<strong>ä¸€ä¸ª</strong>ä½œä¸šåˆå§‹åŒ–è°ƒåº¦ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆå§‹åŒ–ä½œä¸š.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// Quartz JobDetail</span></div><div class="line">   JobDetail jobDetail = JobBuilder.newJob(DaemonJob.class)</div><div class="line">           .withIdentity(jobRootConfig.getTypeConfig().getCoreConfig().getJobName()).build();</div><div class="line">   jobDetail.getJobDataMap().put(ELASTIC_JOB_DATA_MAP_KEY, elasticJob);</div><div class="line">   jobDetail.getJobDataMap().put(JOB_FACADE_DATA_MAP_KEY, jobFacade);</div><div class="line">   jobDetail.getJobDataMap().put(EXECUTOR_DRIVER_DATA_MAP_KEY, executorDriver);</div><div class="line">   jobDetail.getJobDataMap().put(TASK_ID_DATA_MAP_KEY, taskId);</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       scheduleJob(initializeScheduler(), jobDetail, taskId.getValue(), jobRootConfig.getTypeConfig().getCoreConfig().getCron());</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Scheduler <span class="title">initializeScheduler</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</div><div class="line">   StdSchedulerFactory factory = <span class="keyword">new</span> StdSchedulerFactory();</div><div class="line">   factory.initialize(getBaseQuartzProperties());</div><div class="line">   <span class="keyword">return</span> factory.getScheduler();</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">getBaseQuartzProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">   Properties result = <span class="keyword">new</span> Properties();</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.class"</span>, org.quartz.simpl.SimpleThreadPool.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.threadPool.threadCount"</span>, <span class="string">"1"</span>); <span class="comment">// çº¿ç¨‹æ•°ï¼š1</span></div><div class="line">   result.put(<span class="string">"org.quartz.scheduler.instanceName"</span>, taskId.getValue());</div><div class="line">   <span class="keyword">if</span> (!jobRootConfig.getTypeConfig().getCoreConfig().isMisfire()) &#123;</div><div class="line">       result.put(<span class="string">"org.quartz.jobStore.misfireThreshold"</span>, <span class="string">"1"</span>);</div><div class="line">   &#125;</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.class"</span>, ShutdownHookPlugin.class.getName());</div><div class="line">   result.put(<span class="string">"org.quartz.plugin.shutdownhook.cleanShutdown"</span>, Boolean.TRUE.toString());</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleJob</span><span class="params">(<span class="keyword">final</span> Scheduler scheduler, <span class="keyword">final</span> JobDetail jobDetail, <span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       <span class="keyword">if</span> (!scheduler.checkExists(jobDetail.getKey())) &#123;</div><div class="line">           scheduler.scheduleJob(jobDetail, createTrigger(triggerIdentity, cron));</div><div class="line">       &#125;</div><div class="line">       scheduler.start();</div><div class="line">       RUNNING_SCHEDULERS.putIfAbsent(scheduler.getSchedulerName(), scheduler);</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException ex) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> JobSystemException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> CronTrigger <span class="title">createTrigger</span><span class="params">(<span class="keyword">final</span> String triggerIdentity, <span class="keyword">final</span> String cron)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> TriggerBuilder.newTrigger()</div><div class="line">           .withIdentity(triggerIdentity)</div><div class="line">           .withSchedule(CronScheduleBuilder.cronSchedule(cron)</div><div class="line">           .withMisfireHandlingInstructionDoNothing())</div><div class="line">           .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>DaemonTaskScheduler åŸºäº Quartz å®ç°ä½œä¸šè°ƒåº¦ã€‚è¿™é‡Œå¤§å®¶çœ‹ä¸‹æºç ï¼Œå°±ä¸å•°å—¦è§£é‡Šå•¦ã€‚</li><li>JobBuilder#newJob(â€¦) çš„å‚æ•°æ˜¯ DaemonJobï¼Œä¸‹æ–‡ä¼šè®²è§£åˆ°ã€‚ </li></ul><p><strong>DaemonJob å®ç°ä»£ç </strong>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ElasticJob elasticJob;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> JobFacade jobFacade;</div><div class="line">   </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> ExecutorDriver executorDriver;</div><div class="line">    </div><div class="line">   <span class="meta">@Setter</span></div><div class="line">   <span class="keyword">private</span> Protos.TaskID taskId;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">       ShardingContexts shardingContexts = jobFacade.getShardingContexts();</div><div class="line">       <span class="keyword">int</span> jobEventSamplingCount = shardingContexts.getJobEventSamplingCount();</div><div class="line">       <span class="keyword">int</span> currentJobEventSamplingCount = shardingContexts.getCurrentJobEventSamplingCount();</div><div class="line">       <span class="keyword">if</span> (jobEventSamplingCount &gt; <span class="number">0</span> &amp;&amp; ++currentJobEventSamplingCount &lt; jobEventSamplingCount) &#123;</div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(currentJobEventSamplingCount);</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">false</span>);</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//</span></div><div class="line">           jobFacade.getShardingContexts().setAllowSendJobEvent(<span class="keyword">true</span>);</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"BEGIN"</span>).build());</div><div class="line">           <span class="comment">// æ‰§è¡Œä½œä¸š</span></div><div class="line">           JobExecutorFactory.getJobExecutor(elasticJob, jobFacade).execute();</div><div class="line">           <span class="comment">//</span></div><div class="line">           executorDriver.sendStatusUpdate(Protos.TaskStatus.newBuilder().setTaskId(taskId).setState(Protos.TaskState.TASK_RUNNING).setMessage(<span class="string">"COMPLETE"</span>).build());</div><div class="line">           <span class="comment">// </span></div><div class="line">           shardingContexts.setCurrentJobEventSamplingCount(<span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>è°ƒç”¨ <code>AbstractElasticJobExecutor#execute(...)</code> æ‰§è¡Œä½œä¸šé€»è¾‘ã€‚<code>AbstractElasticJobExecutor#execute(...)</code> å®ç°ä»£ç ï¼Œåœ¨ Elastic-Job-Lite å’Œ Elastic-Job-Cloud åŸºæœ¬ä¸€è‡´ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šæ‰§è¡Œã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><p><code>jobEventSamplingCount</code> æ¥è‡ªåº”ç”¨é…ç½® (<code>CloudAppConfiguration.eventTraceSamplingCount</code>) å±æ€§ï¼Œå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</p><p>å½“æ»¡è¶³é‡‡æ ·æ¡ä»¶æ—¶ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(true)</code>ï¼Œæ ‡è®°<strong>è¦</strong>è®°å½•ä½œä¸šäº‹ä»¶ã€‚å¦åˆ™ï¼Œè°ƒç”¨ <code>ShardingContexts#setAllowSendJobEvent(false)</code>ï¼Œæ ‡è®°<strong>ä¸</strong>è®°å½•ä½œä¸šæ—¶é—´ã€‚ä½œä¸šäº‹ä»¶è¿½è¸ªåœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-event-trace/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šäº‹ä»¶è¿½è¸ªã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p><p>å¦å¤–ï¼Œå½“æ»¡è¶³é‡‡æ ·è°ƒè¯•æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­ï¼Œå¹¶é™„å¸¦ <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code> æ¶ˆæ¯ã€‚</p></li></ul><h1 id="6-SchedulerEngine-å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´"><a href="#6-SchedulerEngine-å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´" class="headerlink" title="6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´"></a>6. SchedulerEngine å¤„ç†ä»»åŠ¡çš„çŠ¶æ€å˜æ›´</h1><p>Mesos è°ƒåº¦å™¨çš„èŒè´£ä¹‹ä¸€ï¼Œ<strong>å¤„ç†ä»»åŠ¡çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯å“åº”ä»»åŠ¡å’Œæ•…éšœ</strong>ã€‚å› æ­¤åœ¨ Elastic-Job-Cloud-Executor è°ƒç”¨ <code>ExecutorDriver#sendStatusUpdate(...)</code> æ–¹æ³•ï¼Œæ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€æ—¶ï¼Œè§¦å‘è°ƒç”¨ Elastic-Job-Cloud-Scheduler çš„ SchedulerEngine çš„ <code>#statusUpdate(...)</code> æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statusUpdate</span><span class="params">(<span class="keyword">final</span> SchedulerDriver schedulerDriver, <span class="keyword">final</span> Protos.TaskStatus taskStatus)</span> </span>&#123;</div><div class="line">   String taskId = taskStatus.getTaskId().getValue();</div><div class="line">   TaskContext taskContext = TaskContext.from(taskId);</div><div class="line">   String jobName = taskContext.getMetaInfo().getJobName();</div><div class="line">   log.trace(<span class="string">"call statusUpdate task state is: &#123;&#125;, task id is: &#123;&#125;"</span>, taskStatus.getState(), taskId);</div><div class="line">   jobEventBus.post(<span class="keyword">new</span> JobStatusTraceEvent(jobName, taskContext.getId(), taskContext.getSlaveId(), Source.CLOUD_SCHEDULER, </div><div class="line">           taskContext.getType(), String.valueOf(taskContext.getMetaInfo().getShardingItems()), State.valueOf(taskStatus.getState().name()), taskStatus.getMessage()));</div><div class="line">   <span class="keyword">switch</span> (taskStatus.getState()) &#123;</div><div class="line">       <span class="keyword">case</span> TASK_RUNNING:</div><div class="line">           <span class="keyword">if</span> (!facadeService.load(jobName).isPresent()) &#123;</div><div class="line">               schedulerDriver.killTask(Protos.TaskID.newBuilder().setValue(taskId).build());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (<span class="string">"BEGIN"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"COMPLETE"</span>.equals(taskStatus.getMessage())) &#123;</div><div class="line">               facadeService.updateDaemonStatus(taskContext, <span class="keyword">true</span>);</div><div class="line">               statisticManager.taskRunSuccessfully();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_FINISHED:</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunSuccessfully();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_KILLED:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.addDaemonJobToReadyQueue(jobName);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_LOST:</div><div class="line">       <span class="keyword">case</span> TASK_DROPPED:</div><div class="line">       <span class="keyword">case</span> TASK_GONE:</div><div class="line">       <span class="keyword">case</span> TASK_GONE_BY_OPERATOR:</div><div class="line">       <span class="keyword">case</span> TASK_FAILED:</div><div class="line">       <span class="keyword">case</span> TASK_ERROR:</div><div class="line">           log.warn(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           facadeService.removeRunning(taskContext);</div><div class="line">           facadeService.recordFailoverTask(taskContext);</div><div class="line">           unAssignTask(taskId);</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> TASK_UNKNOWN:</div><div class="line">       <span class="keyword">case</span> TASK_UNREACHABLE:</div><div class="line">           log.error(<span class="string">"task id is: &#123;&#125;, status is: &#123;&#125;, message is: &#123;&#125;, source is: &#123;&#125;"</span>, taskId, taskStatus.getState(), taskStatus.getMessage(), taskStatus.getSource());</div><div class="line">           statisticManager.taskRunFailed();</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">default</span>:</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_RUNNING</code> æ—¶ï¼Œæ ¹æ®é™„å¸¦æ¶ˆæ¯ä¸º <code>&quot;BEGIN&quot;</code> æˆ– <code>&quot;COMPLETE&quot;</code>ï¼Œåˆ†åˆ«è°ƒç”¨ <code>FacadeService#updateDaemonStatus(false / true)</code> æ–¹æ³•ï¼Œæ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°å¸¸é©»ä½œä¸šè¿è¡ŒçŠ¶æ€.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isIdle æ˜¯å¦ç©ºé—²</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDaemonStatus</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   runningService.updateIdle(taskContext, isIdle);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ›´æ–°ä½œä¸šé—²ç½®çŠ¶æ€.</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> isIdle æ˜¯å¦é—²ç½®</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIdle</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle)</span> </span>&#123;</div><div class="line">   <span class="keyword">synchronized</span> (RUNNING_TASKS) &#123;</div><div class="line">       Optional&lt;TaskContext&gt; taskContextOptional = findTask(taskContext);</div><div class="line">       <span class="keyword">if</span> (taskContextOptional.isPresent()) &#123;</div><div class="line">           taskContextOptional.get().setIdle(isIdle);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           add(taskContext);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>  è‹¥ä½œä¸šé…ç½®ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨ <code>SchedulerDriver#killTask(...)</code> æ–¹æ³•ï¼Œæ€æ­»è¯¥ Mesos ä»»åŠ¡ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-second/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆäºŒï¼‰ã€‹</a>è¿›ä¸€æ­¥è§£æã€‚</p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_FINISHED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> æ–¹æ³•ï¼Œå°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// FacadeService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeRunning</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   runningService.remove(taskContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RunningService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> taskContext ä»»åŠ¡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> TaskContext taskContext)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§»é™¤è¿è¡Œä¸­çš„ä»»åŠ¡é›†åˆ</span></div><div class="line">   getRunningTasks(taskContext.getMetaInfo().getJobName()).remove(taskContext);</div><div class="line">   <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸é©»ä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (!isDaemonOrAbsent(taskContext.getMetaInfo().getJobName())) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// å°†ä»»åŠ¡ä»è¿è¡Œæ—¶é˜Ÿåˆ—åˆ é™¤</span></div><div class="line">   regCenter.remove(RunningNode.getRunningTaskNodePath(taskContext.getMetaInfo().toString()));</div><div class="line">   String jobRootNode = RunningNode.getRunningJobNodePath(taskContext.getMetaInfo().getJobName());</div><div class="line">   <span class="keyword">if</span> (regCenter.isExisted(jobRootNode) &amp;&amp; regCenter.getChildrenKeys(jobRootNode).isEmpty()) &#123;</div><div class="line">       regCenter.remove(jobRootNode);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>å½“è¯¥ä½œä¸šå¯¹åº”çš„æ‰€æœ‰ Mesos ä»»åŠ¡çŠ¶æ€éƒ½æ›´æ–°ä¸º <code>TASK_FINISHED</code> åï¼Œä½œä¸šå¯ä»¥å†æ¬¡è¢« Elastic-Job-Cloud-Scheduler è°ƒåº¦ã€‚</p><p>è°ƒç”¨ <code>#unAssignTask(...)</code> æ–¹æ³•ï¼Œé€šçŸ¥ TaskScheduler ä»»åŠ¡è¢«<strong>ç¡®è®¤</strong>æœªåˆ†é…åˆ°è¿™ä¸ªä¸»æœºã€‚TaskScheduler åšä»»åŠ¡å’Œ Offer çš„åŒ¹é…ï¼Œå¯¹å“ªäº›ä»»åŠ¡è¿è¡Œåœ¨å“ªäº›ä¸»æœºæ˜¯æœ‰ä¾èµ–çš„ï¼Œä¸ç„¶æ€ä¹ˆåšåŒ¹é…ä¼˜åŒ–å‘¢ã€‚åœ¨<a href="https://github.com/Netflix/Fenzo/wiki/How-to-use-Fenzo#notify-the-scheduler-of-assigns-and-unassigns-of-tasks" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠFenzo Wiki â€”â€” Notify the Scheduler of Assigns and UnAssigns of Tasksã€‹</a>å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unAssignTask</span><span class="params">(<span class="keyword">final</span> String taskId)</span> </span>&#123;</div><div class="line">    String hostname = facadeService.popMapping(taskId);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != hostname) &#123;</div><div class="line">        taskScheduler.getTaskUnAssigner().call(TaskContext.getIdForUnassignedSlave(taskId), hostname);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_KILLED</code> æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#addDaemonJobToReadyQueue(...)</code> æ–¹æ³•ï¼Œå°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚<strong>ä¸ºä»€ä¹ˆè¦å°†å¸¸é©»ä½œä¸šæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—å‘¢ï¼Ÿ</strong>è¢« Kill æ‰çš„ä½œä¸šåç»­è¦ç»§ç»­è°ƒåº¦æ‰§è¡Œï¼Œå¦‚æœä¸åŠ å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ï¼ŒTaskLaunchScheduledService å°±æ— æ³•æäº¤ä½œä¸šç»™ Elastic-Job-Cloud-Executor ç»§ç»­è°ƒåº¦æ‰§è¡Œã€‚</p><p>  å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code>ã€<code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p></li><li><p>å½“æ›´æ–° Mesos ä»»åŠ¡çŠ¶æ€ä¸º <code>TASK_ERROR</code> ç­‰ç­‰æ—¶ï¼Œè°ƒç”¨ <code>FacadeService#recordFailoverTask(...)</code> æ–¹æ³•ï¼Œåœ¨ <a href="http://www.iocoder.cn/Elastic-Job/cloud-job-failover/?self">ã€ŠElastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šå¤±æ•ˆè½¬ç§»ã€‹</a>è¯¦ç»†è§£æã€‚</p><p>  å¦å¤–ä¼šè°ƒç”¨ <code>FacadeService#removeRunning(...)</code> å’Œ <code>#unAssignTask(...)</code> æ–¹æ³•ã€‚</p></li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ—ç™½å›ï¼šçœŸçš„çœŸçš„çœŸçš„ï¼Œå¥½é•¿å¥½é•¿å¥½é•¿å•Šã€‚ä½†æ˜¯çœŸçš„çœŸçš„çœŸçš„ï¼Œå¹²è´§ï¼<br>èŠ‹é“å›ï¼šé‚£å¿…é¡»çš„ï¼</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_21/12.png" alt=""></p><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. ä½œä¸šæ‰§è¡Œç±»å‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
  <entry>
    <title>é—²èŠå¦‚ä½•é˜…è¯»æ–‡ç« </title>
    <link href="http://www.iocoder.cn/Architecture/how-to-read-article/"/>
    <id>http://www.iocoder.cn/Architecture/how-to-read-article/</id>
    <published>2017-12-14T16:00:00.000Z</published>
    <updated>2017-09-15T16:49:59.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><a href="#">1. é˜…è¯»ä¸æ•´ç†</a></li><li><a href="#">2. å…¬ä¼—å·æ¨è</a></li><li><a href="#">3. åº”ç”¨æ¨è</a></li><li><a href="#">4. ä¹¦ç±æ¨è</a></li><li><a href="#">5. Warning</a></li></ul><hr><h1 id="1-æ•´ç†ä¸é˜…è¯»"><a href="#1-æ•´ç†ä¸é˜…è¯»" class="headerlink" title="1. æ•´ç†ä¸é˜…è¯»"></a>1. æ•´ç†ä¸é˜…è¯»</h1><p>æˆ‘æƒ³ï¼Œåº”è¯¥æœ‰å¾ˆå¤šèƒ–å‹ç¢°åˆ°å›°æƒ‘ï¼š</p><ul><li>å¾®ä¿¡å…¬ä¼—å·å‡ åä¸ª <strong>99+</strong> æœªé˜…è¯»ã€‚</li><li>æ˜é‡‘ / å¼€æºä¸­å›½ / å¼€å‘è€…å¤´æ¡ / æå®¢å¤´æ¡ ç­‰ç­‰æŠ€æœ¯ç¤¾åŒºæ¥ä¸åŠé˜…è¯»ã€‚</li><li>å¶å°”çœ‹åˆ°æœ‹å‹åœˆ / å¾®ä¿¡ç¾¤ä¸é”™çš„æ–‡ç« ï¼Œåªç‚¹äº†èµï¼Œå´å¿˜è®°é˜…è¯»ã€‚</li></ul><p>è¿™é‡Œæˆ‘åˆ†äº«ä¸‹æˆ‘çš„æ¢³ç†æ–¹å¼ï¼Œå¯èƒ½ä¸æ˜¯æœ€ä¼˜ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡ï¼Œåªè¦ä½ æ„¿æ„å°è¯•ï¼Œå¯¹ä½ çš„æ”¶è´§ä¸€å®šéå¸¸å¤§ã€‚</p><p><strong>å…¨éƒ¨æ–‡ç« åŸºäºå°è±¡ç¬”è®°æ•´ç†</strong><br><strong>å…¨éƒ¨æ–‡ç« åŸºäºå°è±¡ç¬”è®°æ•´ç†</strong><br><strong>å…¨éƒ¨æ–‡ç« åŸºäºå°è±¡ç¬”è®°æ•´ç†</strong>  </p><ul><li>å¾®ä¿¡å…¬ä¼—å· <strong>å¥½æ–‡ç« </strong>è½¬åˆ°ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ï¼Œåˆ é™¤è¯¥æ–‡ç« æ¶ˆæ¯ã€‚</li><li>æ˜é‡‘ / å¼€å‘è€…å¤´æ¡ / å¼€æºä¸­å›½ / æå®¢å¤´æ¡ <strong>å¥½æ–‡ç« </strong>è½¬åˆ°ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ã€‚</li><li>æœ‹å‹åœˆ / å¾®ä¿¡ç¾¤ <strong>å¥½æ–‡ç« </strong>è½¬åˆ°ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ã€‚</li></ul><p>æ¯å¤©ä¸Šä¸‹ç­åœ°é“è¯»ã€å°è±¡ç¬”è®°-å¾…è¯»åˆ—è¡¨ã€‘ã€‚</p><ul><li>å¦‚æœåˆé€‚çš„æ–‡ç« ï¼Œç•™ä¸‹ï¼Œæ ‡ç­¾å½’ç±»ã€‚  </li><li>ä¸åˆé€‚ï¼Œåˆ é™¤ã€‚</li><li>è¿‡äºå›°éš¾çš„æ–‡ç« ï¼Œæ”¾å…¥å¦å¤–ä¸€ä¸ªåˆ—è¡¨ï¼Œæ”¶æ‹¾å¥½å¿ƒæƒ…æ¥çœ‹ï¼Œä¸€èˆ¬å‘¨æœ«ã€‚</li></ul><p>å¦‚ä¸‹æ˜¯æˆ‘ 2017 å¹´åœ¨<strong>åœ°é“</strong>ä¸Šé˜…è¯»äº†å‡ åƒç¯‡æ–‡ç« æ¢³ç†ä¸‹çš„ 800 ç¯‡å·¦å³æ–‡ç« ï¼š</p><p><img src="https://user-gold-cdn.xitu.io/2017/7/13/9187cd431f3917d2afc5975e00fb4ee6?imageView2/2/w/1280/h/960/q/85/interlace/1" alt=""></p><p>å¤©ä¸‹æ–‡ç« ä¸€å¤§<strong>â€œæŠ„â€</strong>ï¼Œçœ‹çš„å¤šäº†ï¼Œè‡ªç„¶å°±å¿«ã€‚</p><p><strong>å¦‚æœä½ æƒ³è¦æˆ‘æ•´ç†çš„æ–‡ç« ï¼Œè¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€èŠ‹é“æºç ã€‘ï¼Œç•™è¨€å‘é€ä½ çš„å°è±¡ç¬”è®°é‚®ç®±ã€‚</strong><br><strong>å¦‚æœä½ æƒ³è¦æˆ‘æ•´ç†çš„æ–‡ç« ï¼Œè¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€èŠ‹é“æºç ã€‘ï¼Œç•™è¨€å‘é€ä½ çš„å°è±¡ç¬”è®°é‚®ç®±ã€‚</strong><br><strong>å¦‚æœä½ æƒ³è¦æˆ‘æ•´ç†çš„æ–‡ç« ï¼Œè¯·å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€èŠ‹é“æºç ã€‘ï¼Œç•™è¨€å‘é€ä½ çš„å°è±¡ç¬”è®°é‚®ç®±ã€‚</strong>  </p><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><h1 id="2-å…¬ä¼—å·æ¨è"><a href="#2-å…¬ä¼—å·æ¨è" class="headerlink" title="2. å…¬ä¼—å·æ¨è"></a>2. å…¬ä¼—å·æ¨è</h1><p>æŒ‰ç…§å­—æ¯æ’åºã€‚</p><p>å¯èƒ½æ¯”è¾ƒå¤šï¼Œå¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„å…ˆå…³æ³¨ä¸€æ³¢ã€‚</p><p>å¦å¤–ï¼Œå…¬ä¼—å·ä¹‹é—´æ–‡ç« æ˜¯ä¼šæœ‰é‡å¤çš„ã€‚</p><h2 id="2-1-æŠ€æœ¯ç±»"><a href="#2-1-æŠ€æœ¯ç±»" class="headerlink" title="2.1 æŠ€æœ¯ç±»"></a>2.1 æŠ€æœ¯ç±»</h2><ul><li>AIå‰çº¿</li><li>é˜¿é‡ŒæŠ€æœ¯</li><li>ArchSummit</li><li>å¹¶å‘ç¼–ç¨‹ç½‘</li><li>BySocketæ³¥ç“¦åŒ </li><li>ç¨‹åºè§†ç•Œ</li><li>ç¨‹åºå‘˜DD</li><li>ç¨‹åºå‘˜æ—¥å¿—</li><li>æ˜¥å¤©çš„æ—è¾¹</li><li>CRUD</li><li>å¤§ç çŒ´</li><li>DBAplusç¤¾ç¾¤</li><li>Docker</li><li>dumpcacheæå®¢æŠ€æœ¯</li><li>EGONetworks</li><li>é¥¿ç§‘æŠ€</li><li>å‡¤å‡°ç‰Œè€ç†Š</li><li>æœåŠ¡ç«¯æ€ç»´</li><li>é«˜å¯ç”¨æ¶æ„</li><li>é«˜æ•ˆå¼€å‘è¿ç»´</li><li>GDG</li><li>GitChat</li><li>Goä¸­å›½</li><li>æ²ªæ±Ÿç§‘æŠ€å­¦é™¢</li><li>InfoQ</li><li>IPDCHAT</li><li>æ¶æ„å¸ˆ</li><li>æ¶æ„å¸ˆä¹‹è·¯</li><li>æ¶æ„æ–‡æ‘˜</li><li>æ¶æ„ä¹‹å®¶</li><li>K8SæŠ€æœ¯ç¤¾åŒº</li><li>å¼€æ¶›çš„åšå®¢</li><li>è€å¶èŒ¶é¦†</li><li>èŠèŠæ¶æ„</li><li>ç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿ</li><li>MongoDBä¸­æ–‡ç¤¾åŒº</li><li>Nettyä¹‹å®¶</li><li>ä½ å‡ç¬¨</li><li>PingCAP</li><li>QCon</li><li>å®¹å™¨æ—¶ä»£</li><li>æ•°äººäº‘</li><li>SpringCloudç¤¾åŒº</li><li>StuQ</li><li>å”¯æŠ€æœ¯</li><li>å”¯å“ä¼šå®‰å…¨åº”æ€¥å“åº”ä¸­å¿ƒ</li><li>å”¯å“ä¼šè´¨é‡å·¥ç¨‹</li><li>æºç¨‹æŠ€æœ¯ä¸­å¿ƒ</li><li>äº‘æ –ç¤¾åŒº</li><li>ä¸­ç”Ÿä»£æŠ€æœ¯</li></ul><h2 id="2-2-éæŠ€æœ¯ç±»"><a href="#2-2-éæŠ€æœ¯ç±»" class="headerlink" title="2.2 éæŠ€æœ¯ç±»"></a>2.2 éæŠ€æœ¯ç±»</h2><ul><li>ç¬”è®°ä¾ </li><li>èœå•å°‘çˆ·</li><li>caozçš„æ¢¦å‘“</li><li>å·®è¯„</li><li>é¸Ÿå“¥ç¬”è®°</li><li>é¬¼è„šä¸ƒ</li><li>åæ—¶ä»£</li><li>äº’è”ç½‘æ€ç»´</li><li>æ··æ²Œå¤§å­¦</li><li>ç»çº¬åˆ›æŠ•</li><li>å¼€æŸ’</li><li>ç§‘æŠ€ç¾å­¦</li><li>ç½—è¾‘æ€ç»´</li><li>MacTalk</li><li>å…¨æ ˆPMç¬”è®°</li><li>äººäººéƒ½æ˜¯äº§å“ç»ç†</li><li>warfalcon</li><li>å°é“æ¶ˆæ¯</li><li>36æ°ª</li><li>3Wäº’è”ç½‘æ·±åº¦ç²¾é€‰</li></ul><h1 id="3-åº”ç”¨æ¨è"><a href="#3-åº”ç”¨æ¨è" class="headerlink" title="3. åº”ç”¨æ¨è"></a>3. åº”ç”¨æ¨è</h1><ul><li>æ˜é‡‘</li><li>å¼€æºä¸­å›½</li><li>å¼€å‘è€…å¤´æ¡</li></ul><h1 id="4-ä¹¦ç±æ¨è"><a href="#4-ä¹¦ç±æ¨è" class="headerlink" title="4. ä¹¦ç±æ¨è"></a>4. ä¹¦ç±æ¨è</h1><p><a href="https://item.jd.com/10877320.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ—¶é—´ç®¡ç†:å¦‚ä½•å……åˆ†åˆ©ç”¨ä½ çš„24å°æ—¶ï¼ˆæ¼«ç”»ç‰ˆï¼‰ã€‹</a></p><p>å¾ˆè–„çš„ä¸€æœ¬å°ä¹¦ï¼Œ2 å°æ—¶å†…é˜…è¯»å®Œæˆï¼Œåªè¦ä½ æ„¿æ„å®è·µï¼Œå°±èƒ½æ¯”ç¬”è€…æ›´åŠ å‰å®³ã€‚ğŸ˜³</p><h1 id="5-Warning"><a href="#5-Warning" class="headerlink" title="5. Warning"></a>5. Warning</h1><p>åªæœ‰è¾“å…¥æ²¡æœ‰è¾“å‡ºçš„å·¥ç¨‹å¸ˆä¸æ˜¯å¥½æ¶æ„å¸ˆã€‚</p><p>æ‰€ä»¥åœ¨ä¸æ–­é˜…è¯»è¾“å…¥çš„åŒäº‹ï¼Œè¯·å°è¯•è¾“å‡ºä½ çš„é“ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. é˜…è¯»ä¸æ•´ç†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. å…¬ä¼—å·æ¨è&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;3. åº”ç”¨æ¨è&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;4. ä¹¦ç±æ¨è&lt;/a&gt;&lt;/li&gt;
&lt;
      
    
    </summary>
    
      <category term="æŠ€æœ¯æ‚æ–‡" scheme="http://www.iocoder.cn/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E6%96%87/"/>
    
    
  </entry>
  
  <entry>
    <title>æºç åœˆ 300 èƒ–å‹çš„ä¹¦å•æ•´ç†ï¼ˆæœ€åæ›´æ–°æ—¶é—´ï¼š2017.09.22ï¼‰</title>
    <link href="http://www.iocoder.cn/Architecture/books-recommended/"/>
    <id>http://www.iocoder.cn/Architecture/books-recommended/</id>
    <published>2017-12-14T16:00:00.000Z</published>
    <updated>2017-09-26T14:23:32.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><ul><li><p><strong>æ‹’ç»ç›—ç‰ˆï¼Œä»ä½ æˆ‘åšèµ·</strong></p></li><li><p><strong>ã€æºç åœˆã€‘ä¼—èƒ–å‹åä½œå®Œæˆ</strong></p></li><li><p><strong>å¸Œæœ›ä¹¦å•èƒ½åœ¨ä½ æƒ³è¦è¿›ä¸€æ­¥æ‰“æ€ªå‡çº§çš„è·¯ä¸Šï¼Œç»™äºˆäº›è®¸å¸®åŠ©</strong></p></li><li><p><strong>å»ºè®®å…ˆæ”¶è—æœ¬ä¹¦å•ï¼Œè®¤çœŸå•ƒå®Œä¸€æœ¬å†ä¹°ä¸‹ä¸€æœ¬ï¼Œæ‰å®èµ°å®Œæ¯ä¸€æ­¥</strong></p></li><li><p><strong>éƒ¨åˆ†ä¹¦ç±å…³è”ç›¸å…³åšå®¢å’Œå¾®ä¿¡å…¬ä¼—å·ï¼Œè®©ä½ æ›´å—¨çš®</strong></p></li><li><p><strong>å¦‚æœå¯¹ä½ ç•¥æœ‰å¸®åŠ©ï¼Œçƒ¦è¯·åˆ†äº«ç»™ä½ çš„åŸºå‹</strong></p></li><li><p><strong>ä¸å›å…±å‹‰ï¼Œè‹¥æœ‰åˆé€‚çš„ä¹¦ç±ï¼Œè¯·ä¸€å®šå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢</strong></p></li><li><p><strong>åˆ†ç±»å›°éš¾å› è€Œæ²¡åˆ†ã€‚å¤§ä½“é¡ºåºï¼Œç¼–ç¨‹å¼€å‘ =&gt; æ•°æ®åº“ =&gt; æ¶æ„è¿ç»´ =&gt; ç®—æ³•</strong></p></li><li><p><strong>æ‹’ç»ç›—ç‰ˆï¼Œä»ä½ æˆ‘åšèµ·</strong></p></li></ul><h1 id="ä¹¦ç±åˆ—è¡¨"><a href="#ä¹¦ç±åˆ—è¡¨" class="headerlink" title="ä¹¦ç±åˆ—è¡¨"></a>ä¹¦ç±åˆ—è¡¨</h1><h3 id="ã€ŠEffective-Java-ä¸­æ–‡ç‰ˆã€‹"><a href="#ã€ŠEffective-Java-ä¸­æ–‡ç‰ˆã€‹" class="headerlink" title="ã€ŠEffective Java ä¸­æ–‡ç‰ˆã€‹"></a><a href="https://union-click.jd.com/jdc?d=S003h8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠEffective Java ä¸­æ–‡ç‰ˆã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.1ã€1235 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦ä»‹ç»äº†åœ¨Javaç¼–ç¨‹ä¸­78æ¡æå…·å®ç”¨ä»·å€¼çš„ç»éªŒè§„åˆ™ï¼Œè¿™äº›ç»éªŒè§„åˆ™æ¶µç›–äº†å¤§å¤šæ•°å¼€å‘äººå‘˜æ¯å¤©æ‰€é¢ä¸´çš„é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚</li><li>å‹æƒ…æç¤ºï¼šåŒæ¨èã€Šé‡æ„ : æ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹ã€ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹ã€ã€Šä»£ç å¤§å…¨ã€‹ï¼Œæœ‰ä¸€å®šçš„å†…å®¹é‡å ã€‚</li></ul><h3 id="ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹"><a href="#ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹" class="headerlink" title="ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=EK9G95" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.2ã€44 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šå¸‚é¢ä¸Šä»‹ç»Javaçš„ä¹¦æœ‰å¾ˆå¤šï¼Œä½†ä¸“æ³¨äºJavaæ€§èƒ½çš„å¹¶ä¸å¤šï¼Œèƒ½æ¸¸åˆƒæœ‰ä½™åœ°å±•ç¤ºJavaæ€§èƒ½ä¼˜åŒ–éš¾ç‚¹çš„æ›´æ˜¯å‡¤æ¯›éºŸè§’ï¼Œæœ¬ä¹¦å³æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚é€šè¿‡ä½¿ç”¨JVMå’ŒJavaå¹³å°ï¼Œä»¥åŠJavaè¯­è¨€å’Œåº”ç”¨ç¨‹åºæ¥å£ï¼Œæœ¬ä¹¦è¯¦å°½è®²è§£äº†Javaæ€§èƒ½è°ƒä¼˜çš„ç›¸å…³çŸ¥è¯†ï¼Œå¸®åŠ©è¯»è€…æ·±å…¥ç†è§£Javaå¹³å°æ€§èƒ½çš„å„ä¸ªæ–¹é¢ï¼Œæœ€ç»ˆä½¿ç¨‹åºå¦‚è™æ·»ç¿¼ã€‚</li></ul><h3 id="ã€ŠSpringæ­ç§˜ã€‹"><a href="#ã€ŠSpringæ­ç§˜ã€‹" class="headerlink" title="ã€ŠSpringæ­ç§˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=kYry5g" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpringæ­ç§˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.0 ã€162 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šSpring ä½¿ç”¨è€…ä¸å¾—ä¸è¯»ï¼</li><li>æ¨èåšå®¢ï¼š<a href="http://spring4all.com/" rel="external nofollow noopener noreferrer" target="_blank">Spring4Allç¤¾åŒº</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=spring4all" rel="external nofollow noopener noreferrer" target="_blank">Spring4Allç¤¾åŒº</a></li></ul><h3 id="ã€ŠSpringBootæ­ç§˜ã€‹"><a href="#ã€ŠSpringBootæ­ç§˜ã€‹" class="headerlink" title="ã€ŠSpringBootæ­ç§˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=Ym8Bu8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpringBootæ­ç§˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š6.8 ã€44 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šã€ŠSpringæ­ç§˜ã€‹ç›¸åŒä½œè€…ã€‚SpringBoot å…¥é—¨ä¹¦ç±ã€‚</li><li>ä½œè€…åšå®¢ï¼š<a href="https://afoo.me/" rel="external nofollow noopener noreferrer" target="_blank">æ‰¶å¢™è€å¸ˆè¯´ï¼šä¸€ä¸ªæ¶æ„å£«çš„æ€è€ƒä¸æ²‰æ·€</a></li><li>ä½œè€…å…¬ä¼—å·ï¼š<a href="https://afoo.me/images/qrcode_for_gh_4fe672b2e860_430.jpg" rel="external nofollow noopener noreferrer" target="_blank">æ‰¶å¢™è€å¸ˆè¯´</a></li><li>ä»˜è´¹æ•™ç¨‹ï¼š<a href="https://segmentfault.com/ls/1650000011063780" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava å¾®æœåŠ¡å®è·µ - Spring Boot ç³»åˆ—ã€‹</a></li></ul><h3 id="ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹"><a href="#ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹" class="headerlink" title="ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹"></a><a href="https://union-click.jd.com/jdc?d=7w4cYP" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼šæš‚æ— </li><li>æ¨èç†ç”±ï¼šä»¥MyBatis 3.4ä¸ºåŸºç¡€ï¼Œé’ˆå¯¹MyBatisçš„æ¶æ„è®¾è®¡å’Œå®ç°ç»†èŠ‚è¿›è¡Œäº†è¯¦ç»†åˆ†æï¼Œå…¶ä¸­ç©¿æ’ä»‹ç»äº†MyBatisæºç ä¸­æ¶‰åŠçš„åŸºç¡€çŸ¥è¯†ã€è®¾è®¡æ¨¡å¼ä»¥åŠç¬”è€…è‡ªå·±åœ¨å®è·µä¸­çš„æ€è€ƒã€‚</li><li>ä½œè€…åšå®¢ï¼š<a href="https://my.oschina.net/zudajun/blog" rel="external nofollow noopener noreferrer" target="_blank">ç¥–å¤§ä¿Šçš„åšå®¢</a></li></ul><h3 id="ã€Šæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‹"><a href="#ã€Šæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‹" class="headerlink" title="ã€Šæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‹"></a><a href="https://union-click.jd.com/jdc?d=3kDmSB" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.4 ã€18 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šJava å•å…ƒæµ‹è¯•å…¥é—¨ã€‚</li></ul><h3 id="ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹"><a href="#ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹" class="headerlink" title="ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=x2yrwq" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.0 ã€651 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦æ·±å…¥æµ…å‡ºåœ°ä»‹ç»äº†Javaçº¿ç¨‹å’Œå¹¶å‘ï¼Œæ˜¯ä¸€æœ¬å®Œç¾çš„Javaå¹¶å‘å‚è€ƒæ‰‹å†Œã€‚</li><li>æ¨èåšå®¢ï¼š<a href="http://ifeve.com/" rel="external nofollow noopener noreferrer" target="_blank">å¹¶å‘ç¼–ç¨‹ç½‘</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=ifeves" rel="external nofollow noopener noreferrer" target="_blank">å¹¶å‘ç¼–ç¨‹ç½‘</a></li></ul><h3 id="ã€ŠNettyå®æˆ˜ã€‹"><a href="#ã€ŠNettyå®æˆ˜ã€‹" class="headerlink" title="ã€ŠNettyå®æˆ˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=RakFcl" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNettyå®æˆ˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.5ã€24 äººè¯„ä»·ã€‘</li><li>è±†ç“£è¯„åˆ†ï¼š8.1ã€83 äººè¯„ä»·ã€‘ ã€ŠNetty in Actionã€‹è‹±æ–‡ç‰ˆ</li><li>æ¨èç†ç”±ï¼šNettyä¹‹çˆ¶â€Trustin Leeä½œåºæ¨èã€‚</li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=NettyZone" rel="external nofollow noopener noreferrer" target="_blank">Nettyä¹‹å®¶</a></li></ul><h3 id="ã€Šæ·±å…¥å‰–æTomcatã€‹"><a href="#ã€Šæ·±å…¥å‰–æTomcatã€‹" class="headerlink" title="ã€Šæ·±å…¥å‰–æTomcatã€‹"></a><a href="https://union-click.jd.com/jdc?d=Tdk85n" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥å‰–æTomcatã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.3ã€118 äººè¯„ä»·ã€‘</li><li>è±†ç“£è¯„åˆ†ï¼š8.9ã€73 äººè¯„ä»·ã€‘ ã€ŠHow Tomcat Worksã€‹è‹±æ–‡ç‰ˆ</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦æ·±å…¥å‰–æTomcat 4å’ŒTomcat 5ä¸­çš„æ¯ä¸ªç»„ä»¶ï¼Œå¹¶æ­ç¤ºå…¶å†…éƒ¨å·¥ä½œåŸç†ã€‚é€šè¿‡å­¦ä¹ æœ¬ä¹¦ï¼Œä½ å°†å¯ä»¥è‡ªè¡Œå¼€å‘Tomcatç»„ä»¶ï¼Œæˆ–è€…æ‰©å±•å·²æœ‰çš„ç»„ä»¶ã€‚</li></ul><h3 id="ã€ŠNginx-ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ã€‹"><a href="#ã€ŠNginx-ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ã€‹" class="headerlink" title="ã€ŠNginx ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ã€‹"></a><a href="https://wizardforcel.gitbooks.io/nginx-doc/content/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNginx ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼šæš‚æ— </li><li>æ¨èç†ç”±ï¼šæš‚æ—¶æœªæ‰¾åˆ°å¤§å®¶è¯„ä»·ä¸é”™çš„ Nginx å®æˆ˜ç›¸å…³ä¹¦ç±ï¼Œå…ˆæ¨èçœ‹ä¸­æ–‡ç¿»è¯‘çš„å®˜æ–¹æ–‡æ¡£ã€‚å¦‚æœä½ æœ‰åˆé€‚çš„æ¨èï¼Œçƒ¦è¯·å‘Šè¯‰æˆ‘ã€‚</li></ul><h3 id="ã€Šæ·±å…¥ç†è§£Nginxã€‹"><a href="#ã€Šæ·±å…¥ç†è§£Nginxã€‹" class="headerlink" title="ã€Šæ·±å…¥ç†è§£Nginxã€‹"></a><a href="https://union-click.jd.com/jdc?d=19KLxr" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç†è§£Nginxã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.5ã€138 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä¹¦ä¸­é¦–å…ˆé€šè¿‡ä»‹ç»å®˜æ–¹Nginxçš„åŸºæœ¬ç”¨æ³•å’Œé…ç½®è§„åˆ™ï¼Œå¸®åŠ©è¯»è€…äº†è§£ä¸€èˆ¬Nginxæ¨¡å—çš„ç”¨æ³•ï¼Œç„¶åé‡ç‚¹ä»‹ç»äº†å¦‚ä½•å¼€å‘HTTPæ¨¡å—(å«HTTPè¿‡æ»¤æ¨¡å—)æ¥å¾—åˆ°å®šåˆ¶åŒ–çš„Nginxï¼Œå…¶ä¸­åŒ…æ‹¬å¼€å‘â€”ä¸ªåŠŸèƒ½å¤æ‚çš„æ¨¡å—æ‰€éœ€è¦äº†è§£çš„å„ç§çŸ¥è¯†ï¼Œå¹¶å¯¹å†…å­˜æ± çš„å®ç°ç»†èŠ‚åŠTCPåè®®è¿›è¡Œäº†è¯¦ç»†ä»‹ç»ï¼›æ¥ç€ï¼Œç»¼åˆNginxæ¡†æ¶ä»£ç åˆ†æäº†Nginxæ¶æ„çš„è®¾è®¡ç†å¿µå’ŒæŠ€å·§ï¼Œæ­¤å¤–ï¼Œè¿˜æ–°å¢äº†å¦‚ä½•åœ¨æ¨¡å—ä¸­æ”¯æŒHTTPå˜é‡ï¼Œä»¥åŠä¸slabå…±äº«å†…å­˜ç­‰ç›¸å…³çš„å†…å®¹ï¼Œç›¸ä¿¡é€šè¿‡å®Œå–„ï¼Œå¯è¿›ä¸€æ­¥å¸®åŠ©è¯»è€…æ›´å¥½åœ°å¼€å‘å‡ºåŠŸèƒ½ä¸°å¯Œã€æ€§èƒ½â€”æµçš„Nginxæ¨¡å—ã€‚</li><li>å‹æƒ…æç¤ºï¼šç›¸å¯¹é€‚ç”¨äº Nginx å¼€å‘è€…ã€‚Nginx ä½¿ç”¨è€…å¯ä»¥äº†è§£ã€‚</li></ul><h3 id="ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹"><a href="#ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹" class="headerlink" title="ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹"></a><a href="https://union-click.jd.com/jdc?d=Wa6dWb" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.9 ã€657 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä¸å»äº†è§£ JVM çš„å·¥ç¨‹å¸ˆï¼Œå’Œå’¸é±¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=lovestblog" rel="external nofollow noopener noreferrer" target="_blank">ä½ å‡ç¬¨</a></li><li>æ¨èåšå®¢ï¼š<a href="http://lovestblog.cn/" rel="external nofollow noopener noreferrer" target="_blank">ä½ å‡ç¬¨@JVM</a></li><li>æ¨èå°ç¨‹åºï¼š<a href="#">JVMPocket</a></li></ul><h3 id="ã€ŠJavaæ ¸å¿ƒæŠ€æœ¯ç³»åˆ—ï¼šJavaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava-SE-8ç‰ˆï¼‰ã€‹"><a href="#ã€ŠJavaæ ¸å¿ƒæŠ€æœ¯ç³»åˆ—ï¼šJavaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava-SE-8ç‰ˆï¼‰ã€‹" class="headerlink" title="ã€ŠJavaæ ¸å¿ƒæŠ€æœ¯ç³»åˆ—ï¼šJavaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava SE 8ç‰ˆï¼‰ã€‹"></a><a href="https://union-click.jd.com/jdc?d=KNY6De" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaæ ¸å¿ƒæŠ€æœ¯ç³»åˆ—ï¼šJavaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava SE 8ç‰ˆï¼‰ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼šæš‚æ— è¯„ä»·</li><li>è±†ç“£è¯„åˆ†ï¼š8.3 ã€27 äººè¯„ä»·ã€‘ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒ(Java SE 7ç‰ˆ)ã€‹</li><li>æ¨èç†ç”±ï¼šåŸºäºJava SE 8,Oracleå®˜æ–¹å‘å¸ƒï¼ŒJavaè™šæ‹ŸæœºæŠ€æœ¯åˆ›å»ºäººæ’°å†™ï¼Œå›½å†…JavaæŠ€æœ¯ä¸“å®¶ç¿»è¯‘ï¼Œæ˜¯æ·±åº¦äº†è§£Javaè™šæ‹Ÿæœºå’ŒJavaè¯­è¨€å®ç°ç»†èŠ‚çš„å¿…è¯»ä¹‹ä½œ</li><li>æ¨èåšå®¢ï¼š<a href="http://www.jianshu.com/u/90ab66c248e6" rel="external nofollow noopener noreferrer" target="_blank">å å°ç‹¼çš„ç®€ä¹¦</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://upload-images.jianshu.io/upload_images/2184951-2079ac376dbc9c0c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" rel="external nofollow noopener noreferrer" target="_blank">å å°ç‹¼çš„åšå®¢</a></li></ul><h3 id="ã€ŠGoè¯­è¨€ç¼–ç¨‹ã€‹"><a href="#ã€ŠGoè¯­è¨€ç¼–ç¨‹ã€‹" class="headerlink" title="ã€ŠGoè¯­è¨€ç¼–ç¨‹ã€‹"></a><a href="https://union-click.jd.com/jdc?d=xPOncj" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠGoè¯­è¨€ç¼–ç¨‹ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.1 ã€444 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šè¿™æœ¬ä¹¦ä»æ•´ä½“çš„å†™ä½œé£æ ¼æ¥è¯´ï¼Œä¼šä»¥ä»‹ç» Go è¯­è¨€ç‰¹æ€§ä¸ºä¸»ï¼Œç¤ºä¾‹åˆ™å°½é‡é‡‡ç”¨ä½œè€…å¹³å¸¸çš„å®è·µï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ²¡æœ‰å¤ªå¤§å®é™…æ„ä¹‰çš„è¯­æ³•ç¤ºèŒƒæ ·ä¾‹ã€‚</li><li>å‹æƒ…æç¤ºï¼šæœ¬ä¹¦ä½œè€…èƒŒæ™¯æå¼ºï¼Œè®¸å¼ä¼Ÿä¸ºåŸé‡‘å±±WPSé¦–å¸­æ¶æ„å¸ˆã€æ›¾æ˜¯ç››å¤§åˆ›æ–°é™¢ç ”ç©¶å‘˜ï¼Œç›®å‰æ˜¯å›½å†…Goè¯­è¨€å®è·µåœˆå­å…¬è®¤çš„Goè¯­è¨€ä¸“å®¶ã€‚</li></ul><h3 id="ã€Š-Goè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹"><a href="#ã€Š-Goè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹" class="headerlink" title="ã€Š Goè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹"></a><a href="https://union-click.jd.com/jdc?d=gj1Lqm" rel="external nofollow noopener noreferrer" target="_blank">ã€Š Goè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.4 ã€57 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šåŸºäºGo1.6ï¼Œ è§£æè¯­è¨€è§„èŒƒï¼Œæ·±å…¥å‰–æGoè¿è¡Œæ—¶æºç </li><li>å‹æƒ…æç¤ºï¼šé›¨ç—•å¤§å¤§ï¼Œæ•™ç§‘ä¹¦çº§äººç‰©ã€‚</li></ul><h3 id="ã€ŠMySQLæŠ€æœ¯å†…å¹•â€”â€”InnoDBå­˜å‚¨å¼•æ“ã€‹"><a href="#ã€ŠMySQLæŠ€æœ¯å†…å¹•â€”â€”InnoDBå­˜å‚¨å¼•æ“ã€‹" class="headerlink" title="ã€ŠMySQLæŠ€æœ¯å†…å¹•â€”â€”InnoDBå­˜å‚¨å¼•æ“ã€‹"></a><a href="https://union-click.jd.com/jdc?d=937kJ8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMySQLæŠ€æœ¯å†…å¹•â€”â€”InnoDBå­˜å‚¨å¼•æ“ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.6 ã€104 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä»æºä»£ç çš„è§’åº¦æ·±åº¦è§£æäº†InnoDBçš„ä½“ç³»ç»“æ„ã€å®ç°åŸç†ã€å·¥ä½œæœºåˆ¶ï¼Œå¹¶ç»™å‡ºäº†å¤§é‡æœ€ä½³å®è·µï¼Œèƒ½å¸®åŠ©ä½ ç³»ç»Ÿè€Œæ·±å…¥åœ°æŒæ¡InnoDBï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒèƒ½ä¸ºä½ è®¾è®¡ç®¡ç†é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ•°æ®åº“ç³»ç»Ÿæä¾›ç»ä½³çš„æŒ‡å¯¼ã€‚</li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=dbaplus" rel="external nofollow noopener noreferrer" target="_blank">DBAplusç¤¾ç¾¤</a></li></ul><h3 id="ã€Šé«˜æ€§èƒ½MySQLã€‹"><a href="#ã€Šé«˜æ€§èƒ½MySQLã€‹" class="headerlink" title="ã€Šé«˜æ€§èƒ½MySQLã€‹"></a><a href="https://union-click.jd.com/jdc?d=6UXfwU" rel="external nofollow noopener noreferrer" target="_blank">ã€Šé«˜æ€§èƒ½MySQLã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.3 ã€245 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šå¯¹äºæƒ³è¦äº†è§£MySQLæ€§èƒ½æå‡çš„äººæ¥è¯´ï¼Œè¿™æ˜¯ä¸€æœ¬ä¸å¯å¤šå¾—çš„ä¹¦ã€‚ä¹¦ä¸­æ²¡æœ‰å„ç§æå‡æ€§èƒ½çš„ç§˜ç±ï¼Œè€Œæ˜¯æ·±å…¥é—®é¢˜çš„æ ¸å¿ƒï¼Œè¯¦ç»†çš„è§£é‡Šäº†æ¯ç§æå‡æ€§èƒ½çš„åŸç†ï¼Œä»è€Œå¯ä»¥ä½¿ä½ å››ä¸¤æ‹¨åƒæ–¤ã€‚æˆä¹‹äºé±¼ä¸å¦‚æˆä¹‹äºæ¸”ï¼Œè¿™æœ¬ä¹¦åšåˆ°äº†ã€‚</li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=iMYSQL_WX" rel="external nofollow noopener noreferrer" target="_blank">è€å¶èŒ¶é¦†</a></li></ul><h3 id="ã€Šé«˜å¯ç”¨MySQLã€‹"><a href="#ã€Šé«˜å¯ç”¨MySQLã€‹" class="headerlink" title="ã€Šé«˜å¯ç”¨MySQLã€‹"></a><a href="https://union-click.jd.com/jdc?d=0s7OAw" rel="external nofollow noopener noreferrer" target="_blank">ã€Šé«˜å¯ç”¨MySQLã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.0 ã€87 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šã€Šé«˜æ€§èƒ½MySQLã€‹çš„å§Šå¦¹ç¯‡ã€‚</li></ul><h3 id="ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹"><a href="#ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹" class="headerlink" title="ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=GhWvaV" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.0 ã€69 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šç®—æ˜¯æ™®é€šçš„å‚è€ƒä¹¦äº†ï¼Œæ²¡æœ‰ç‰¹åˆ«æœ‰æ·±åº¦çš„è®²è§£ã€‚å…¶å®å°±æ˜¯ä¸€æœ¬æ­£å¸¸çš„ä»‹ç»mongoDBæ˜¯æ€ä¹ˆç”¨çš„ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºnosqlå­¦ä¹ çš„å…¥é—¨ã€‚ä½œä¸ºæŒ‡å—ä¹¦ï¼Œè¿˜æ˜¯å¾ˆåˆæ ¼çš„ç¬¦åˆæœŸæœ›ã€‚</li><li>æ¨èåšå®¢ï¼š<a href="http://mongoing.com/" rel="external nofollow noopener noreferrer" target="_blank">MongoDB ä¸­æ–‡ç¤¾åŒº</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=mongoing-com" rel="external nofollow noopener noreferrer" target="_blank">MongoDB ä¸­æ–‡ç¤¾åŒº</a></li></ul><h3 id="ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹"><a href="#ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹" class="headerlink" title="ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹"></a><a href="https://union-click.jd.com/jdc?d=WxbcW3" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.8 ã€41 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä»å¼€å‘ã€è¿ç»´ä¸¤ä¸ªè§’åº¦æ€»ç»“äº†Rediså®æˆ˜ç»éªŒï¼Œæ·±å…¥æµ…å‡ºåœ°å‰–æåº•å±‚å®ç°ï¼ŒåŒ…å«å¤§è§„æ¨¡é›†ç¾¤å¼€å‘ä¸è¿ç»´çš„å®é™…æ¡ˆä¾‹ã€åº”ç”¨æŠ€å·§ã€‚å…¨é¢è¦†ç›–Redis åŸºæœ¬åŠŸèƒ½åŠåº”ç”¨ï¼Œå›¾ç¤ºä¸°å¯Œï¼Œè®²è§£ç»†è…»ã€‚</li><li>æ¨èåšå®¢ï¼š<a href="http://redis.cn/" rel="external nofollow noopener noreferrer" target="_blank">Redis ä¸­å›½ç”¨æˆ·ç»„</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=rediscn" rel="external nofollow noopener noreferrer" target="_blank">CRUG</a></li></ul><h3 id="ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹"><a href="#ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹" class="headerlink" title="ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹"></a><a href="https://union-click.jd.com/jdc?d=6L6sMX" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.5 ã€427 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šç³»ç»Ÿè€Œå…¨é¢åœ°æè¿°äº† Redis å†…éƒ¨è¿è¡Œæœºåˆ¶ã€‚å›¾ç¤ºä¸°å¯Œï¼Œæè¿°æ¸…æ™°ï¼Œå¹¶ç»™å‡ºå¤§é‡å‚è€ƒä¿¡æ¯ï¼Œæ˜¯NoSQLæ•°æ®åº“å¼€å‘äººå‘˜æ¡ˆå¤´å¿…å¤‡ã€‚</li></ul><h3 id="ã€ŠNoSQLç²¾ç²¹ã€‹"><a href="#ã€ŠNoSQLç²¾ç²¹ã€‹" class="headerlink" title="ã€ŠNoSQLç²¾ç²¹ã€‹"></a><a href="https://union-click.jd.com/jdc?d=WO5Qg1" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNoSQLç²¾ç²¹ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.2 ã€226 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä¹¦ä¸­å…¨æ–¹ä½æ¯”è¾ƒäº†å…³ç³»å‹æ•°æ®åº“ä¸NoSQLæ•°æ®åº“çš„å¼‚åŒï¼›åˆ†åˆ«ä»¥Riakã€MongoDBã€Cassandraå’ŒNeo4Jä¸ºä»£è¡¨ï¼Œè¯¦ç»†è®²è§£äº†é”®å€¼æ•°æ®åº“ã€æ–‡æ¡£æ•°æ®åº“ã€åˆ—æ—æ•°æ®åº“å’Œå›¾æ•°æ®åº“è¿™4å¤§ç±»NoSQLæ•°æ®åº“çš„ä¼˜åŠ£åŠ¿ã€ç”¨æ³•å’Œé€‚ç”¨åœºåˆï¼›æ·±å…¥æ¢è®¨äº†å®ç°NoSQLæ•°æ®åº“ç³»ç»Ÿçš„å„ç§ç»†èŠ‚ï¼Œä»¥åŠä¸å…³ç³»å‹æ•°æ®åº“çš„æ··ç”¨ã€‚</li></ul><h3 id="ã€ŠElasticSearch-å¯æ‰©å±•çš„å¼€æºå¼¹æ€§æœç´¢è§£å†³æ–¹æ¡ˆã€‹"><a href="#ã€ŠElasticSearch-å¯æ‰©å±•çš„å¼€æºå¼¹æ€§æœç´¢è§£å†³æ–¹æ¡ˆã€‹" class="headerlink" title="ã€ŠElasticSearch å¯æ‰©å±•çš„å¼€æºå¼¹æ€§æœç´¢è§£å†³æ–¹æ¡ˆã€‹"></a><del><a href="https://union-click.jd.com/jdc?d=4nHLvq" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠElasticSearch å¯æ‰©å±•çš„å¼€æºå¼¹æ€§æœç´¢è§£å†³æ–¹æ¡ˆã€‹</a></del></h3><ul><li><del>è±†ç“£è¯„åˆ†ï¼š7.3 ã€23 äººè¯„ä»·ã€‘</del></li><li><del>æ¨èç†ç”±ï¼šåŸºäºElasticSearch çš„0.2 ç‰ˆæœ¬ï¼Œè¦†ç›–äº†ElasticSearch å„ç§åŠŸèƒ½å’Œå‘½ä»¤çš„åº”ç”¨ï¼Œå…¨é¢ã€è¯¦ç»†åœ°ä»‹ç»äº†å¼€æºã€åˆ†å¸ƒå¼ã€RESTfulï¼Œå…·æœ‰å…¨æ–‡æ£€ç´¢åŠŸèƒ½çš„æœç´¢å¼•æ“ElasticSearchã€‚</del></li><li>å‹æƒ…æç¤ºï¼šæœ¬ä¹¦ ElasticSearch æ¯”è¾ƒæ—§ï¼Œä¸å¿æ¨èã€‚ä»…é€‚åˆå…¥é—¨ï¼Œæœ‰å…¶ä»–åˆé€‚çš„ ElasticSearch ä¹¦ç±ï¼Œçƒ¦è¯·å‘Šè¯‰æˆ‘ã€‚<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠElasticsearchæƒå¨æŒ‡å—ã€‹ä¸­æ–‡ç‰ˆ</a>ï¼Œç›®å‰æ­£åœ¨ç¿»è¯‘ä¸­ã€‚</li><li>æ¨èåšå®¢ï¼š<a href="https://elasticsearch.cn/" rel="external nofollow noopener noreferrer" target="_blank">Elastic ä¸­æ–‡ç¤¾åŒº</a></li></ul><h3 id="ã€ŠELK-Stackæƒå¨æŒ‡å—ã€‹"><a href="#ã€ŠELK-Stackæƒå¨æŒ‡å—ã€‹" class="headerlink" title="ã€ŠELK Stackæƒå¨æŒ‡å—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=yVxIYm" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠELK Stackæƒå¨æŒ‡å—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.0 ã€10 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šELK stackæ˜¯ä»¥Elasticsearchã€Logstashã€Kibanaä¸‰ä¸ªå¼€æºè½¯ä»¶ä¸ºä¸»çš„æ•°æ®å¤„ç†å·¥å…·é“¾ï¼Œæ˜¯ç›®å‰å¼€æºç•Œæœ€æµè¡Œçš„å®æ—¶æ•°æ®åˆ†æè§£å†³æ–¹æ¡ˆï¼Œæˆä¸ºå®æ—¶æ—¥å¿—å¤„ç†é¢†åŸŸå¼€æºç•Œçš„ç¬¬ä¸€é€‰æ‹©ã€‚</li></ul><h3 id="ã€ŠZooKeeperï¼šåˆ†å¸ƒå¼è¿‡ç¨‹ååŒæŠ€æœ¯è¯¦è§£ã€‹"><a href="#ã€ŠZooKeeperï¼šåˆ†å¸ƒå¼è¿‡ç¨‹ååŒæŠ€æœ¯è¯¦è§£ã€‹" class="headerlink" title="ã€ŠZooKeeperï¼šåˆ†å¸ƒå¼è¿‡ç¨‹ååŒæŠ€æœ¯è¯¦è§£ã€‹"></a><a href="https://union-click.jd.com/jdc?d=zdXtEg" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠZooKeeperï¼šåˆ†å¸ƒå¼è¿‡ç¨‹ååŒæŠ€æœ¯è¯¦è§£ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.6 ã€49 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šZookeeper å…¥é—¨</li><li>å‹æƒ…æç¤ºï¼šç¿»è¯‘å¯èƒ½ç•¥æ˜¾å°´å°¬ã€‚</li></ul><h3 id="ã€Šä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹"><a href="#ã€Šä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹" class="headerlink" title="ã€Šä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹"></a><a href="https://union-click.jd.com/jdc?d=YxOiGe" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.1 ã€187 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä»åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ç†è®ºå‡ºå‘ï¼Œå‘è¯»è€…ç®€è¦ä»‹ç»å‡ ç§å…¸å‹çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œä»¥åŠè§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜çš„æ€è·¯ï¼Œå…¶ä¸­é‡ç‚¹è®²è§£äº†Paxoså’ŒZABåè®®ã€‚åŒæ—¶ï¼Œæœ¬ä¹¦æ·±å…¥ä»‹ç»äº†åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜çš„å·¥ä¸šè§£å†³æ–¹æ¡ˆâ€”â€”ZooKeeperï¼Œå¹¶ç€é‡å‘è¯»è€…å±•ç¤ºè¿™ä¸€åˆ†å¸ƒå¼åè°ƒæ¡†æ¶çš„ä½¿ç”¨æ–¹æ³•ã€å†…éƒ¨å®ç°åŠè¿ç»´æŠ€å·§ï¼Œæ—¨åœ¨å¸®åŠ©è¯»è€…å…¨é¢äº†è§£ZooKeeperï¼Œå¹¶æ›´å¥½åœ°ä½¿ç”¨å’Œè¿ç»´ZooKeeperã€‚</li></ul><h3 id="ã€ŠRabbitMQå®æˆ˜ï¼šé«˜æ•ˆéƒ¨ç½²åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‹"><a href="#ã€ŠRabbitMQå®æˆ˜ï¼šé«˜æ•ˆéƒ¨ç½²åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‹" class="headerlink" title="ã€ŠRabbitMQå®æˆ˜ï¼šé«˜æ•ˆéƒ¨ç½²åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=WaEQue" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠRabbitMQå®æˆ˜ï¼šé«˜æ•ˆéƒ¨ç½²åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š6.9 ã€47 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦å¯¹RabbitMQåšäº†å…¨é¢ã€ç¿”å®çš„è®²è§£ï¼Œä½“ç°äº†ä¸¤ä½ä¸“å®¶çš„çœŸçŸ¥ç¼è§ã€‚æœ¬ä¹¦é¦–å…ˆä»‹ç»äº†æœ‰å…³MQçš„å†å²ï¼Œç„¶åä»åŸºæœ¬çš„æ¶ˆæ¯é€šä¿¡åŸç†è®²èµ·ï¼Œå¸¦é¢†è¯»è€…ä¸€è·¯æ¢ç´¢RabbitMQçš„æ¶ˆæ¯é€šä¿¡ä¸–ç•Œã€‚</li><li>å‹æƒ…æç¤ºï¼šæœ¬ä¹¦ RabbitMQ ç‰ˆæœ¬è¾ƒæ—§ã€‚æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RabbitMQã€ActiveMQã€RocketMQã€Kafka å¯ä»¥é€‰æ‹©äº†è§£ä¸€ä¸‹ã€‚</li></ul><h3 id="ã€ŠApache-Kafkaæºç å‰–æã€‹"><a href="#ã€ŠApache-Kafkaæºç å‰–æã€‹" class="headerlink" title="ã€ŠApache Kafkaæºç å‰–æã€‹"></a><a href="https://union-click.jd.com/jdc?d=xRfuZy" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠApache Kafkaæºç å‰–æã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.8 ã€30 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä»¥Kafka 0.10.0ç‰ˆæœ¬æºç ä¸ºåŸºç¡€ï¼Œé’ˆå¯¹Kafkaçš„æ¶æ„è®¾è®¡åˆ°å®ç°ç»†èŠ‚è¿›è¡Œè¯¦ç»†é˜è¿°ã€‚</li></ul><h3 id="ã€Šä½œä¸šè°ƒåº¦ç³»ç»Ÿ-Quartz-ä¸­æ–‡æ–‡æ¡£ã€‹"><a href="#ã€Šä½œä¸šè°ƒåº¦ç³»ç»Ÿ-Quartz-ä¸­æ–‡æ–‡æ¡£ã€‹" class="headerlink" title="ã€Šä½œä¸šè°ƒåº¦ç³»ç»Ÿ Quartz ä¸­æ–‡æ–‡æ¡£ã€‹"></a><a href="https://xuzongbao.gitbooks.io/quartz/content/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä½œä¸šè°ƒåº¦ç³»ç»Ÿ Quartz ä¸­æ–‡æ–‡æ¡£ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼šæš‚æ— </li><li>æ¨èç†ç”±ï¼šæš‚æ—¶æœªæ‰¾åˆ°å¤§å®¶è¯„ä»·ä¸é”™çš„ Quartz å®æˆ˜ç›¸å…³ä¹¦ç±ï¼Œå…ˆæ¨èçœ‹ä¸­æ–‡ç¿»è¯‘çš„å®˜æ–¹æ–‡æ¡£ã€‚å¦‚æœä½ æœ‰åˆé€‚çš„æ¨èï¼Œçƒ¦è¯·å‘Šè¯‰æˆ‘ã€‚</li><li>å‹æƒ…æç¤ºï¼šå›½å†…å¼€æºé¡¹ç›® Elastic-Jobï¼ŒXXL-Job éƒ½å¯ä»¥é€‰æ‹©äº†è§£ã€‚</li></ul><h3 id="ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹"><a href="#ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹" class="headerlink" title="ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹"></a><a href="https://union-click.jd.com/jdc?d=0oiQ5c" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.1 ã€273 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šé€šè¿‡Netflixç­‰å¤šä¸ªä¸šç•Œæ¡ˆä¾‹ï¼Œä»å¾®æœåŠ¡æ¶æ„æ¼”è¿›åˆ°åŸç†å‰–æï¼Œå…¨é¢è®²è§£å»ºæ¨¡é›†æˆéƒ¨ç½²ç­‰å¾®æœåŠ¡æ‰€æ¶‰åŠçš„å„ç§ä¸»é¢˜ï¼Œå¾®æœåŠ¡æ¶æ„ä¸å®è·µæŒ‡å—ã€‚</li></ul><h3 id="ã€ŠSpring-Cloudå¾®æœåŠ¡å®æˆ˜ã€‹"><a href="#ã€ŠSpring-Cloudå¾®æœåŠ¡å®æˆ˜ã€‹" class="headerlink" title="ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.9ã€20 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä»æ—¶ä¸‹æµè¡Œçš„å¾®æœåŠ¡æ¶æ„æ¦‚å¿µå‡ºå‘ï¼Œè¯¦ç»†ä»‹ç»äº†Spring Cloudé’ˆå¯¹å¾®æœåŠ¡æ¶æ„ä¸­å‡ å¤§æ ¸å¿ƒè¦ç´ çš„è§£å†³æ–¹æ¡ˆå’ŒåŸºç¡€ç»„ä»¶ã€‚å¯¹äºå„ä¸ªç»„ä»¶çš„ä»‹ç»ï¼Œä¸»è¦ä»¥ç¤ºä¾‹ä¸æºç ç»“åˆçš„æ–¹å¼æ¥å¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£è¿™äº›ç»„ä»¶çš„ä½¿ç”¨æ–¹æ³•ä»¥åŠè¿è¡ŒåŸç†ã€‚åŒæ—¶ï¼Œåœ¨ä»‹ç»çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜åŒ…å«äº†ä½œè€…åœ¨å®è·µä¸­æ‰€é‡åˆ°çš„ä¸€äº›é—®é¢˜å’Œè§£å†³æ€è·¯ï¼Œå¯ä¾›è¯»è€…åœ¨å®è·µä¸­ä½œä¸ºå‚è€ƒã€‚</li><li>ä½œè€…åšå®¢ï¼š<a href="http://blog.didispace.com/" rel="external nofollow noopener noreferrer" target="_blank">http://blog.didispace.com/</a></li><li>ä½œè€…å…¬ä¼—å·ï¼š<a href="http://blog.didispace.com/css/images/weixin.jpg" rel="external nofollow noopener noreferrer" target="_blank">didispace</a></li></ul><h3 id="ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹"><a href="#ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹" class="headerlink" title="ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹"></a><a href="https://union-click.jd.com/jdc?d=pT3LH8" rel="external nofollow noopener noreferrer" target="_blank">ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.6ã€57 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæ€»ç»“å¹¶æ¢³ç†äº†äº¿çº§æµé‡ç½‘ç«™é«˜å¯ç”¨å’Œé«˜å¹¶å‘åŸåˆ™ï¼Œé€šè¿‡å®ä¾‹è¯¦ç»†ä»‹ç»äº†å¦‚ä½•è½åœ°è¿™äº›åŸåˆ™ã€‚æœ¬ä¹¦åˆ†ä¸ºå››éƒ¨åˆ†ï¼šæ¦‚è¿°ã€é«˜å¯ç”¨åŸåˆ™ã€é«˜å¹¶å‘åŸåˆ™ã€æ¡ˆä¾‹å®æˆ˜ã€‚</li><li>ä½œè€…åšå®¢ï¼š<a href="http://jinnianshilongnian.iteye.com/" rel="external nofollow noopener noreferrer" target="_blank">å¼€æ¶›çš„åšå®¢</a></li><li>ä½œè€…å…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=kaitao-1234567" rel="external nofollow noopener noreferrer" target="_blank">å¼€æ¶›çš„åšå®¢</a></li></ul><h3 id="ã€Šæ¶æ„å³æœªæ¥ï¼šç°ä»£ä¼ä¸šå¯æ‰©å±•çš„Webæ¶æ„ã€æµç¨‹å’Œç»„ç»‡ã€‹"><a href="#ã€Šæ¶æ„å³æœªæ¥ï¼šç°ä»£ä¼ä¸šå¯æ‰©å±•çš„Webæ¶æ„ã€æµç¨‹å’Œç»„ç»‡ã€‹" class="headerlink" title="ã€Šæ¶æ„å³æœªæ¥ï¼šç°ä»£ä¼ä¸šå¯æ‰©å±•çš„Webæ¶æ„ã€æµç¨‹å’Œç»„ç»‡ã€‹"></a><a href="https://union-click.jd.com/jdc?d=9gjui2" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ¶æ„å³æœªæ¥ï¼šç°ä»£ä¼ä¸šå¯æ‰©å±•çš„Webæ¶æ„ã€æµç¨‹å’Œç»„ç»‡ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.7ã€77 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šä»»ä½•ä¸€ä¸ªæŒç»­æˆé•¿çš„å…¬å¸æœ€ç»ˆéƒ½éœ€è¦è§£å†³ç³»ç»Ÿã€ç»„ç»‡å’Œæµç¨‹çš„æ‰©å±•æ€§é—®é¢˜ã€‚æœ¬ä¹¦æ±‡èšäº†ä½œè€…ä»eBayã€VISAã€Salesforce.comåˆ°Appleè¶…è¿‡30å¹´çš„ä¸°å¯Œç»éªŒï¼Œ å…¨é¢é˜é‡Šäº†ç»è¿‡éªŒè¯çš„ä¿¡æ¯æŠ€æœ¯æ‰©å±•æ–¹æ³•ï¼Œå¯¹æ‰€éœ€è¦æŒæ¡çš„äº§å“å’ŒæœåŠ¡çš„å¹³æ»‘æ‰©å±•åšäº†è¯¦å°½çš„è®ºè¿°ï¼Œå¹¶åœ¨ç¬¬1ç‰ˆçš„åŸºç¡€ä¸Šæ›´æ–°äº†æ‰©å±•çš„ç­–ç•¥ã€æŠ€æœ¯å’Œæ¡ˆä¾‹ã€‚</li></ul><h3 id="ã€ŠMaven-å®æˆ˜ã€‹"><a href="#ã€ŠMaven-å®æˆ˜ã€‹" class="headerlink" title="ã€ŠMaven å®æˆ˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=hNj9Lu" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠMaven å®æˆ˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.1ã€563 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šå›½å†…æœ€æƒå¨çš„Mavenä¸“å®¶çš„åŠ›ä½œï¼Œå”¯ä¸€ä¸€æœ¬å“¦ï¼</li></ul><h3 id="ã€ŠJenkinsæƒå¨æŒ‡å—ã€‹"><a href="#ã€ŠJenkinsæƒå¨æŒ‡å—ã€‹" class="headerlink" title="ã€ŠJenkinsæƒå¨æŒ‡å—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=75C9Oh" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJenkinsæƒå¨æŒ‡å—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼šæš‚æ— è¯„åˆ†</li><li>æ¨èç†ç”±ï¼šJenkins å”¯ä¸€å®ä½“ä¹¦ã€‚</li><li>å‹æƒ…æç¤ºï¼šå†…å®¹ç›¸å¯¹æ¯”è¾ƒæ—§ï¼Œå¤§å¤šæ˜¯è¿‡æ—¶çš„æ¡ˆä¾‹ã€‚å»ºè®®ï¼Œå¿«é€Ÿè¿‡ä¸€éã€‚Jenkins æ–¹é¢æ— ç‰¹åˆ«å¥½çš„é€‰æ‹©æ¨èä¹¦ç±ã€‚å¯ä»¥é€‰æ‹© Google ä¸€äº›æ•™ç¨‹ã€‚</li></ul><h3 id="ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ-ï¼ˆåŸºç¡€å­¦ä¹ ç¯‡ï¼‰ã€‹"><a href="#ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ-ï¼ˆåŸºç¡€å­¦ä¹ ç¯‡ï¼‰ã€‹" class="headerlink" title="ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ ï¼ˆåŸºç¡€å­¦ä¹ ç¯‡ï¼‰ã€‹"></a><a href="https://union-click.jd.com/jdc?d=yB7dwu" rel="external nofollow noopener noreferrer" target="_blank">ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ ï¼ˆåŸºç¡€å­¦ä¹ ç¯‡ï¼‰ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.1ã€2269 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦æ˜¯æœ€å…·çŸ¥ååº¦çš„Linuxå…¥é—¨ä¹¦ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœåŸºç¡€å­¦ä¹ ç¯‡ã€‹çš„æœ€æ–°ç‰ˆï¼Œå…¨é¢è€Œè¯¦ç»†åœ°ä»‹ç»äº†Linuxæ“ä½œç³»ç»Ÿã€‚</li><li>å‹æƒ…æç¤ºï¼šå†…å®¹éå¸¸å…¨é¢ï¼Œå»ºè®®æŒ‘é€‰å’Œè‡ªå·±å®é™…å·¥ä½œç›¸å…³åº¦è¾ƒé«˜çš„ï¼Œå…¶ä»–éƒ¨åˆ†æœ‰éœ€è¦å†é˜…è¯»ã€‚</li></ul><h3 id="ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ-ï¼ˆæœåŠ¡å™¨æ¶è®¾ç¯‡ï¼‰ã€‹"><a href="#ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ-ï¼ˆæœåŠ¡å™¨æ¶è®¾ç¯‡ï¼‰ã€‹" class="headerlink" title="ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ ï¼ˆæœåŠ¡å™¨æ¶è®¾ç¯‡ï¼‰ã€‹"></a><a href="https://union-click.jd.com/jdc?d=TC0EE6" rel="external nofollow noopener noreferrer" target="_blank">ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ ï¼ˆæœåŠ¡å™¨æ¶è®¾ç¯‡ï¼‰ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.8 ã€198 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæ‚¨å·²æœ‰LinuxåŸºç¡€ï¼Œæƒ³è¦è¿›ä¸€æ­¥å­¦ä¹ æœåŠ¡å™¨æ¶è®¾ï¼Ÿè¿˜æƒ³äº†è§£å¦‚ä½•ç»´æŠ¤ä¸ç®¡ç†æ‚¨çš„æœåŠ¡å™¨ï¼Ÿæœ¬ä¹¦æ˜¯æ‚¨æœ€ä½³çš„é€‰æ‹©ã€‚</li></ul><h3 id="ã€ŠZabbixä¼ä¸šçº§åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿã€‹"><a href="#ã€ŠZabbixä¼ä¸šçº§åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿã€‹" class="headerlink" title="ã€ŠZabbixä¼ä¸šçº§åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿã€‹"></a><a href="https://union-click.jd.com/jdc?d=WZQenq" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠZabbixä¼ä¸šçº§åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.6 ã€39 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦ä»è¿ç»´ï¼ˆOPSï¼‰è§’åº¦å¯¹Zabbixçš„å„é¡¹åŠŸèƒ½è¿›è¡Œäº†è¯¦ç»†ä»‹ç»ï¼Œä»¥è‡ªåŠ¨åŒ–è¿ç»´è§†è§’ä¸ºå‡ºå‘ç‚¹ï¼Œå¯¹Zabbixçš„å®‰è£…å’Œé…ç½®ã€è‡ªåŠ¨åŒ–åŠŸèƒ½ã€ç›‘æ§å‘Šè­¦ã€æ€§èƒ½è°ƒä¼˜ã€Zabbix APIã€Zabbixåè®®ã€RPMå®‰è£…åŒ…å®šåˆ¶ï¼Œç»“åˆSaltStackå®ç°è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†ç­‰å†…å®¹è¿›è¡Œäº†å…¨æ–¹ä½çš„æ·±å…¥å‰–æã€‚</li></ul><h3 id="ã€Šç¬¬ä¸€æœ¬Dockerä¹¦ã€‹"><a href="#ã€Šç¬¬ä¸€æœ¬Dockerä¹¦ã€‹" class="headerlink" title="ã€Šç¬¬ä¸€æœ¬Dockerä¹¦ã€‹"></a><a href="https://union-click.jd.com/jdc?d=W4EYRx" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç¬¬ä¸€æœ¬Dockerä¹¦ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.8 ã€63 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦ç”±Dockerå…¬å¸å‰æœåŠ¡ä¸æ”¯æŒå‰¯æ€»è£James Turnbullç¼–å†™ï¼Œæ˜¯Dockerå¼€å‘æŒ‡å—ã€‚æœ¬ä¹¦ä¸“æ³¨äºDocker 1.9åŠä»¥ä¸Šç‰ˆæœ¬ï¼ŒæŒ‡å¯¼è¯»è€…å®ŒæˆDockerçš„å®‰è£…ã€éƒ¨ç½²ã€ç®¡ç†å’Œæ‰©å±•ï¼Œå¸¦é¢†è¯»è€…ç»å†ä»æµ‹è¯•åˆ°ç”Ÿäº§çš„æ•´ä¸ªå¼€å‘ç”Ÿå‘½å‘¨æœŸï¼Œè®©è¯»è€…äº†è§£Dockeré€‚ç”¨äºä»€ä¹ˆåœºæ™¯ã€‚</li><li>æ¨èåšå®¢ï¼š<a href="http://dockone.io/" rel="external nofollow noopener noreferrer" target="_blank">DockerOne</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=dockerone" rel="external nofollow noopener noreferrer" target="_blank">DockerOne</a></li></ul><h3 id="ã€ŠDockerâ€”â€”å®¹å™¨ä¸å®¹å™¨äº‘ã€‹"><a href="#ã€ŠDockerâ€”â€”å®¹å™¨ä¸å®¹å™¨äº‘ã€‹" class="headerlink" title="ã€ŠDockerâ€”â€”å®¹å™¨ä¸å®¹å™¨äº‘ã€‹"></a><a href="https://union-click.jd.com/jdc?d=BxWMVi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠDockerâ€”â€”å®¹å™¨ä¸å®¹å™¨äº‘ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.5 ã€99 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦æ ¹æ®Docker 1.10ç‰ˆå’ŒKubernetes 1.2ç‰ˆå¯¹ç¬¬1ç‰ˆè¿›è¡Œäº†å…¨é¢æ›´æ–°ï¼Œä»å®è·µè€…çš„è§’åº¦å‡ºå‘ï¼Œä»¥Dockerå’ŒKubernetesä¸ºé‡ç‚¹ï¼Œæ²¿ç€â€œåŸºæœ¬ç”¨æ³•ä»‹ç»â€åˆ°â€œæ ¸å¿ƒåŸç†è§£è¯»â€åˆ°â€œé«˜çº§å®è·µæŠ€å·§â€çš„æ€è·¯ï¼Œä¸€æœ¬ä¹¦è®²é€å½“å‰ä¸»æµçš„å®¹å™¨å’Œå®¹å™¨äº‘æŠ€æœ¯ï¼Œæœ‰åŠ©äºè¯»è€…åœ¨å®é™…åœºæ™¯ä¸­åˆ©ç”¨Dockerå®¹å™¨å’Œå®¹å™¨äº‘è§£å†³é—®é¢˜å¹¶å¯å‘æ–°çš„æ€è€ƒã€‚</li></ul><h3 id="ã€ŠKubernetesæƒå¨æŒ‡å—ã€‹"><a href="#ã€ŠKubernetesæƒå¨æŒ‡å—ã€‹" class="headerlink" title="ã€ŠKubernetesæƒå¨æŒ‡å—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=eGWYXy" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠKubernetesæƒå¨æŒ‡å—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.7ã€15 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šKubernetesé‡ç£…å¼€å±±ä¹‹ä½œï¼Œé’ˆå¯¹Kubernetes v1.6å’Œæœ¬ä¹¦ç¬¬2ç‰ˆè¿›è¡Œå¤§ç¯‡å¹…å†…å®¹æ›´æ–°ï¼Œå…¨æ–¹ä½å®Œç¾è¦†ç›–ï¼Œå¯å€Ÿé‰´æ€§æå¼ºã€‚ </li><li>æ¨èåšå®¢ï¼š<a href="https://www.kubernetes.org.cn/" rel="external nofollow noopener noreferrer" target="_blank">Kubernetes ä¸­æ–‡ç¤¾åŒº</a></li><li>æ¨èå…¬ä¼—å·ï¼š<a href="http://open.weixin.qq.com/qr/code/?username=kubernetescn" rel="external nofollow noopener noreferrer" target="_blank">K8S æŠ€æœ¯ç¤¾åŒº</a></li></ul><h3 id="ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹"><a href="#ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹" class="headerlink" title="ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹"></a><a href="https://union-click.jd.com/jdc?d=OnSepV" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼šæš‚æ— è¯„åˆ†</li><li>æ¨èç†ç”±ï¼šè¶…çº§è–„çš„ä¸€æœ¬ä¹¦ï¼Œçœ‹å®Œä¹‹åï¼Œä½ ä¼šå¯¹ Mesos ä¼šéå¸¸äº†è§£ï¼Œå¹¶ä¸”æå¤§å¯èƒ½æ€§å­¦ä¼šå¦‚ä½•åŸºäº Mesos æ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‚</li></ul><h3 id="ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æï¼šJavaè¯­è¨€æè¿°ã€‹"><a href="#ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æï¼šJavaè¯­è¨€æè¿°ã€‹" class="headerlink" title="ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æï¼šJavaè¯­è¨€æè¿°ã€‹"></a><a href="https://union-click.jd.com/jdc?d=IOGxFX" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æï¼šJavaè¯­è¨€æè¿°ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.3ã€183 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦æ˜¯å›½å¤–æ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†ææ–¹é¢çš„ç»å…¸æ•™æï¼Œä½¿ç”¨å“è¶Šçš„Javaç¼–ç¨‹è¯­è¨€ä½œä¸ºå®ç°å·¥å…·è®¨è®ºäº†æ•°æ®ç»“æ„ï¼ˆç»„ç»‡å¤§é‡æ•°æ®çš„æ–¹æ³•ï¼‰å’Œç®—æ³•åˆ†æï¼ˆå¯¹ç®—æ³•è¿è¡Œæ—¶é—´çš„ä¼°è®¡ï¼‰ã€‚</li><li>å‹æƒ…æç¤ºï¼šç®—æ³•æ–¹æ³•è¿˜æœ‰å…¶ä»–å¾ˆå¥½çš„ä¹¦ç±ï¼Œä¾‹å¦‚ã€Šç®—æ³•å¯¼è®ºã€‹ã€ã€Šç®—æ³•ï¼ˆç¬¬å››ç‰ˆï¼‰ã€‹ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©é˜…è¯»ã€‚é‡è¦çš„æ˜¯ï¼Œä¿æŒè€å¿ƒï¼Œäº«å—è¿™ä¸ªç—›å¹¶å¿«ä¹çš„è¿‡ç¨‹ã€‚</li></ul><h3 id="ã€ŠHead-First-è®¾è®¡æ¨¡å¼ã€‹"><a href="#ã€ŠHead-First-è®¾è®¡æ¨¡å¼ã€‹" class="headerlink" title="ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹"></a><a href="https://union-click.jd.com/jdc?d=HYyuyM" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.2ã€2394 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šã€ŠHead Firstè®¾è®¡æ¨¡å¼ã€‹(ä¸­æ–‡ç‰ˆ)å…±æœ‰14ç« ï¼Œæ¯ç« éƒ½ä»‹ç»äº†å‡ ä¸ªè®¾è®¡æ¨¡å¼ï¼Œå®Œæ•´åœ°æ¶µç›–äº†å››äººç»„ç‰ˆæœ¬å…¨éƒ¨23ä¸ªè®¾è®¡æ¨¡å¼ã€‚</li></ul><h3 id="ã€ŠHTTPæƒå¨æŒ‡å—ã€‹"><a href="#ã€ŠHTTPæƒå¨æŒ‡å—ã€‹" class="headerlink" title="ã€ŠHTTPæƒå¨æŒ‡å—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=TgCRBb" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHTTPæƒå¨æŒ‡å—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.7 ã€1126 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæœ¬ä¹¦å°è¯•ç€å°†HTTPä¸­ä¸€äº›äº’ç›¸å…³è”ä¸”å¸¸è¢«è¯¯è§£çš„è§„åˆ™æ¢³ç†æ¸…æ¥šï¼Œå¹¶ç¼–å†™äº†ä¸€ç³»åˆ—åŸºäºå„ç§ä¸»é¢˜çš„ç« èŠ‚ï¼Œå¯¹HTTPå„æ–¹é¢çš„ç‰¹æ€§è¿›è¡Œäº†ä»‹ç»ã€‚çºµè§‚å…¨ä¹¦ï¼Œå¯¹HTTPâ€œä¸ºä»€ä¹ˆâ€è¿™æ ·åšè¿›è¡Œäº†è¯¦ç»†çš„è§£é‡Šï¼Œè€Œä¸ä»…ä»…åœç•™åœ¨å®ƒæ˜¯â€œæ€ä¹ˆåšâ€çš„ã€‚</li></ul><h3 id="ã€ŠTCP-IPè¯¦è§£-ç³»åˆ—ã€‹"><a href="#ã€ŠTCP-IPè¯¦è§£-ç³»åˆ—ã€‹" class="headerlink" title="ã€ŠTCP/IPè¯¦è§£ ç³»åˆ—ã€‹"></a><a href="https://union-click.jd.com/jdc?d=5uHlXS" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTCP/IPè¯¦è§£ ç³»åˆ—ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.3 ã€1883 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šå®Œæ•´è€Œè¯¦ç»†çš„TCP/IPåè®®æŒ‡å—ã€‚é’ˆå¯¹ä»»ä½•å¸Œæœ›ç†è§£TCP/IPåè®®æ˜¯å¦‚ä½•å®ç°çš„è¯»è€…è®¾è®¡ã€‚</li></ul><h3 id="ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹"><a href="#ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹" class="headerlink" title="ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹"></a><a href="https://union-click.jd.com/jdc?d=3VaGzn" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.7ã€286 äººè¯„ä»·ã€‘</li><li>è¯¦ç»†æè¿°äº†Linuxå†…æ ¸çš„ä¸»è¦å­ç³»ç»Ÿå’Œç‰¹ç‚¹ï¼ŒåŒ…æ‹¬Linuxå†…æ ¸çš„è®¾è®¡ã€å®ç°å’Œæ¥å£ã€‚ä»ç†è®ºåˆ°å®è·µæ¶µç›–äº†Linuxå†…æ ¸çš„æ–¹æ–¹é¢é¢ï¼Œå¯ä»¥æ»¡è¶³è¯»è€…çš„å„ç§å…´è¶£å’Œéœ€æ±‚ã€‚</li><li>å‹æƒ…æç¤ºï¼šLinuxå†…æ ¸æ–¹é¢ä¸ä¹å¥½ä¹¦ã€‚æœ¬ä¹¦ç¯‡å¹…æ–¹é¢è¾ƒä¸ºåˆé€‚ã€‚</li></ul><h3 id="ã€Šå‰‘æŒ‡Offerï¼šåä¼é¢è¯•å®˜ç²¾è®²å…¸å‹ç¼–ç¨‹é¢˜ã€‹"><a href="#ã€Šå‰‘æŒ‡Offerï¼šåä¼é¢è¯•å®˜ç²¾è®²å…¸å‹ç¼–ç¨‹é¢˜ã€‹" class="headerlink" title="ã€Šå‰‘æŒ‡Offerï¼šåä¼é¢è¯•å®˜ç²¾è®²å…¸å‹ç¼–ç¨‹é¢˜ã€‹"></a><a href="https://union-click.jd.com/jdc?d=wnrKQh" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå‰‘æŒ‡Offerï¼šåä¼é¢è¯•å®˜ç²¾è®²å…¸å‹ç¼–ç¨‹é¢˜ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.5ã€508 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šå‰–æäº†80ä¸ªå…¸å‹çš„ç¼–ç¨‹é¢è¯•é¢˜ï¼Œç³»ç»Ÿæ•´ç†åŸºç¡€çŸ¥è¯†ã€ä»£ç è´¨é‡ã€è§£é¢˜æ€è·¯ã€ä¼˜åŒ–æ•ˆç‡å’Œç»¼åˆèƒ½åŠ›è¿™5ä¸ªé¢è¯•è¦ç‚¹ã€‚</li><li>æ¨èç½‘ç«™ï¼š<a href="https://www.nowcoder.com/" rel="external nofollow noopener noreferrer" target="_blank">ç‰›å®¢ç½‘-ä¸“ä¸šITç¬”è¯•é¢è¯•å¤‡è€ƒå¹³å°</a></li></ul><h3 id="ã€Šç¨‹åºå‘˜ä»£ç é¢è¯•æŒ‡å—ï¼šITåä¼ç®—æ³•ä¸æ•°æ®ç»“æ„é¢˜ç›®æœ€ä¼˜è§£ã€‹"><a href="#ã€Šç¨‹åºå‘˜ä»£ç é¢è¯•æŒ‡å—ï¼šITåä¼ç®—æ³•ä¸æ•°æ®ç»“æ„é¢˜ç›®æœ€ä¼˜è§£ã€‹" class="headerlink" title="ã€Šç¨‹åºå‘˜ä»£ç é¢è¯•æŒ‡å—ï¼šITåä¼ç®—æ³•ä¸æ•°æ®ç»“æ„é¢˜ç›®æœ€ä¼˜è§£ã€‹"></a><a href="https://union-click.jd.com/jdc?d=1ums6L" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç¨‹åºå‘˜ä»£ç é¢è¯•æŒ‡å—ï¼šITåä¼ç®—æ³•ä¸æ•°æ®ç»“æ„é¢˜ç›®æœ€ä¼˜è§£ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š8.4ã€32 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šç¨‹åºå‘˜åˆ·é¢˜å®å…¸ï¼ç¼–ç¨‹èƒ½åŠ›æå‡ç§˜ç¬ˆï¼ç²¾é€‰ITåä¼çœŸå®ä»£ç é¢è¯•é¢˜ï¼Œå…¨é¢è¦†ç›–ç®—æ³•ä¸æ•°æ®ç»“æ„é¢˜å‹ï¼</li></ul><h3 id="ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹"><a href="#ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹" class="headerlink" title="ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹"></a><a href="https://union-click.jd.com/jdc?d=O7IEOX" rel="external nofollow noopener noreferrer" target="_blank">ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š9.0ã€115 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šæ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡æ–¹é¢çš„ç»å…¸ä¹‹ä½œã€‚å…¨ä¹¦å›´ç»•ç€è®¾è®¡å’Œå¼€å‘å®è·µï¼Œç»“åˆè‹¥å¹²çœŸå®çš„é¡¹ç›®æ¡ˆä¾‹ï¼Œå‘è¯»è€…é˜è¿°å¦‚ä½•åœ¨çœŸå®çš„è½¯ä»¶å¼€å‘ä¸­åº”ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‚</li><li>å‹æƒ…æç¤ºï¼šç†è®ºçš„ä¹¦ç±å¾€å¾€è¾ƒä¸ºæ¯ç‡¥ï¼Œå‹¤ä¿®å†…åŠŸæ˜¯å¿…é¡»èµ°çš„è·¯ã€‚</li></ul><h3 id="ã€Šç«çƒ-UMLå¤§æˆ˜éœ€æ±‚åˆ†æã€‹"><a href="#ã€Šç«çƒ-UMLå¤§æˆ˜éœ€æ±‚åˆ†æã€‹" class="headerlink" title="ã€Šç«çƒ:UMLå¤§æˆ˜éœ€æ±‚åˆ†æã€‹"></a><a href="https://union-click.jd.com/jdc?d=5EDRst" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç«çƒ:UMLå¤§æˆ˜éœ€æ±‚åˆ†æã€‹</a></h3><ul><li>è±†ç“£è¯„åˆ†ï¼š7.9ã€115 äººè¯„ä»·ã€‘</li><li>æ¨èç†ç”±ï¼šèåˆUMLã€éUMLã€éœ€æ±‚åˆ†æåŠéœ€æ±‚ç®¡ç†ç­‰å„æ–¹é¢çš„çŸ¥è¯†ï¼Œå¸®åŠ©è¯»è€…è§£å†³UMLä¸šç•Œé—®é¢˜ã€éœ€æ±‚åˆ†æåŠéœ€æ±‚ç®¡ç†é—®é¢˜ã€‚</li><li>å‹æƒ…æç¤ºï¼šå¯èƒ½ä¸æ˜¯æœ€å¥½çš„ UML ä¹¦ç±ï¼Œä½†ä»æ˜¯å¦èƒ½å¤Ÿé˜…è¯»ç†è§£å®Œçš„è§’åº¦æ¥è¯´ï¼Œæœ¬ä¹¦å¯èƒ½æ˜¯ç›¸å¯¹åˆé€‚çš„ã€‚æœ‰å…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥çœ‹çœ‹ã€ŠUMLå’Œæ¨¡å¼åº”ç”¨ã€‹ã€ã€Šå¤§è±¡ï¼šThinking in UMLã€‹ã€‚</li></ul><hr><h1 id="ToDO-List"><a href="#ToDO-List" class="headerlink" title="ToDO List"></a>ToDO List</h1><p>å¾…æ¨èä¸»é¢˜ä¹¦ç±</p><p>TODO ã€Šå¤§æ•°æ®æ—¥çŸ¥å½• æ¶æ„ä¸ç®—æ³•ã€‹<br>TODO ã€Šå¤§å‹ç½‘ç«™ç³»ç»Ÿä¸Javaä¸­é—´ä»¶å®è·µã€‹<br>TODO ã€ŠHotSpotå®æˆ˜ã€‹<br>TODO ã€Šåƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°ã€‹<br>TODO ã€Šå½©è‰²UMLå»ºæ¨¡ã€‹<br>TODO ã€Šä¸ƒå‘¨ä¸ƒå¹¶å‘æ¨¡å‹ã€‹<br>TODO ã€Š<a href="https://book.douban.com/subject/27044219/ã€‹" rel="external nofollow noopener noreferrer" target="_blank">https://book.douban.com/subject/27044219/ã€‹</a></p><ul><li>[x] Go</li><li>[ ] Node</li><li>[x] Linux å†…æ ¸</li><li>[x] é¢†åŸŸ</li><li>[x] UML</li><li>[x] Tomcat</li><li>[x] SpringCloud</li><li>[x] Java åŸºç¡€</li><li>[x] Netty</li><li>[x] MyBatis</li><li>[x] æ•°æ®åº“</li><li>[x] MongoDB</li><li>[x] Maven</li><li>[x] DevOps</li><li>[x] Linux è¿ç»´</li><li>[x] é¢è¯•</li><li>[x] æ¶ˆæ¯é˜Ÿåˆ—</li><li>[x] è®¾è®¡æ¨¡å¼</li><li>[x] ç®—æ³•ä¸æ•°æ®ç»“æ„</li><li>[x] Zookeeper</li><li>[x] SpringBoot </li><li>[x] Nginx</li><li>[x] å®šæ—¶ä»»åŠ¡</li><li>[x] æœç´¢å¼•æ“</li><li>[x] åè®®</li><li>[x] å•å…ƒæµ‹è¯•</li><li>[x] é‡æ„</li><li>[x] æ—¥å¿—</li><li>[x] Docker</li><li>[x] ç›‘æ§</li></ul><hr><h1 id="æ›´æ–°æ—¥å¿—"><a href="#æ›´æ–°æ—¥å¿—" class="headerlink" title="æ›´æ–°æ—¥å¿—"></a>æ›´æ–°æ—¥å¿—</h1><h2 id="2017-09-19"><a href="#2017-09-19" class="headerlink" title="2017.09.19"></a>2017.09.19</h2><ul><li>æ–°å¢<ul><li>ã€ŠEffective Java ä¸­æ–‡ç‰ˆã€‹</li><li>ã€ŠSpringæ­ç§˜ã€‹ã€ã€ŠSpringBootæ­ç§˜ã€‹</li><li>ã€ŠMyBatisæŠ€æœ¯å†…å¹•ã€‹</li><li>ã€Šæœ‰æ•ˆçš„å•å…ƒæµ‹è¯•ã€‹</li><li>ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</li><li>ã€ŠNettyå®æˆ˜ã€‹</li><li>ã€Šæ·±å…¥å‰–æTomcatã€‹</li><li>ã€ŠNginx ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ã€‹ã€ã€Šæ·±å…¥ç†è§£Nginxã€‹</li><li>ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹ã€ã€ŠJavaæ ¸å¿ƒæŠ€æœ¯ç³»åˆ—ï¼šJavaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava SE 8ç‰ˆï¼‰ã€‹</li><li>ã€ŠMySQLæŠ€æœ¯å†…å¹•ã€‹ã€ã€Šé«˜æ€§èƒ½MySQLã€‹ã€ã€Šé«˜å¯ç”¨MySQLã€‹</li><li>ã€ŠMongoDBæƒå¨æŒ‡å—ã€‹</li><li>ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹ã€ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹</li><li>ã€ŠElasticSearch å¯æ‰©å±•çš„å¼€æºå¼¹æ€§æœç´¢è§£å†³æ–¹æ¡ˆã€‹</li><li>ã€ŠELK Stackæƒå¨æŒ‡å—ã€‹</li><li>ã€ŠZooKeeperï¼šåˆ†å¸ƒå¼è¿‡ç¨‹ååŒæŠ€æœ¯è¯¦è§£ã€‹ã€ã€Šä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</li><li>ã€ŠRabbitMQå®æˆ˜ï¼šé«˜æ•ˆéƒ¨ç½²åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€‹ã€ã€ŠApache Kafkaæºç å‰–æã€‹</li><li>ã€Šä½œä¸šè°ƒåº¦ç³»ç»Ÿ Quartz ä¸­æ–‡æ–‡æ¡£ã€‹</li><li>ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹ã€ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</li><li>ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹ã€ã€Šæ¶æ„å³æœªæ¥ï¼šç°ä»£ä¼ä¸šå¯æ‰©å±•çš„Webæ¶æ„ã€æµç¨‹å’Œç»„ç»‡ã€‹</li><li>ã€ŠMaven å®æˆ˜ã€‹ã€ã€ŠJenkinsæƒå¨æŒ‡å—ã€‹</li><li>ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ ï¼ˆåŸºç¡€å­¦ä¹ ç¯‡ï¼‰ã€‹ã€ã€Šé¸Ÿå“¥çš„Linuxç§æˆ¿èœ ï¼ˆæœåŠ¡å™¨æ¶è®¾ç¯‡ï¼‰ã€‹</li><li>ã€ŠZabbixä¼ä¸šçº§åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿã€‹</li><li>ã€Šç¬¬ä¸€æœ¬Dockerä¹¦ã€‹ã€ã€ŠKubernetesæƒå¨æŒ‡å—ã€‹ã€ã€Šç”¨Mesosæ¡†æ¶æ„å»ºåˆ†å¸ƒå¼åº”ç”¨ã€‹</li><li>ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æï¼šJavaè¯­è¨€æè¿°ã€‹</li><li>ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ã€ã€ŠHTTPæƒå¨æŒ‡å—ã€‹ã€ã€ŠTCP/IPè¯¦è§£ ç³»åˆ—ã€‹</li><li>ã€Šå‰‘æŒ‡Offerï¼šåä¼é¢è¯•å®˜ç²¾è®²å…¸å‹ç¼–ç¨‹é¢˜ã€‹ã€‚</li></ul></li></ul><h2 id="2017-09-20"><a href="#2017-09-20" class="headerlink" title="2017.09.20"></a>2017.09.20</h2><ul><li>æ–°å¢ä¹¦ç±<ul><li>ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹</li><li>ã€Šç«çƒ:UMLå¤§æˆ˜éœ€æ±‚åˆ†æã€‹</li><li>ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹</li><li>ã€Šç¨‹åºå‘˜ä»£ç é¢è¯•æŒ‡å—ï¼šITåä¼ç®—æ³•ä¸æ•°æ®ç»“æ„é¢˜ç›®æœ€ä¼˜è§£ã€‹</li></ul></li><li>æ–°å¢ä¹¦ç±åšå®¢å’Œå…¬ä¼—å·</li></ul><h2 id="2017-09-21"><a href="#2017-09-21" class="headerlink" title="2017.09.21"></a>2017.09.21</h2><ul><li>ä¿®æ”¹ä¹¦ç±<ul><li>ã€ŠSpringBootæ­ç§˜ã€‹ï¼šå¢åŠ <a href="https://segmentfault.com/ls/1650000011063780" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava å¾®æœåŠ¡å®è·µ - Spring Boot ç³»åˆ—ã€‹</a>ã€‚</li></ul></li></ul><h2 id="2017-09-22"><a href="#2017-09-22" class="headerlink" title="2017.09.22"></a>2017.09.22</h2><ul><li>æ–°å¢ä¹¦ç±<ul><li>ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹</li><li>ã€ŠDockerâ€”â€”å®¹å™¨ä¸å®¹å™¨äº‘ã€‹</li><li>ã€ŠNoSQLç²¾ç²¹ã€‹</li></ul></li></ul><h2 id="2017-09-23"><a href="#2017-09-23" class="headerlink" title="2017.09.23"></a>2017.09.23</h2><ul><li>æ–°å¢ä¹¦ç±<ul><li>ã€ŠGoè¯­è¨€ç¼–ç¨‹ã€‹</li><li>ã€ŠGoè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨&lt;strong&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘&lt;/strong&gt;
      
    
    </summary>
    
      <category term="æŠ€æœ¯æ‚æ–‡" scheme="http://www.iocoder.cn/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E6%96%87/"/>
    
    
  </entry>
  
  <entry>
    <title>Elastic-Job-Cloud æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®</title>
    <link href="http://www.iocoder.cn/Elastic-Job/cloud-job-config/"/>
    <id>http://www.iocoder.cn/Elastic-Job/cloud-job-config/</id>
    <published>2017-12-13T16:00:00.000Z</published>
    <updated>2017-09-22T09:54:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«</strong></p><ul><li><a href="#">1. æ¦‚è¿°</a></li><li><a href="#">2. äº‘ä½œä¸šApp</a><ul><li><a href="#">2.1 äº‘ä½œä¸šAppé…ç½®ç±»</a></li><li><a href="#">2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®</a></li></ul></li><li><a href="#3">3. äº‘ä½œä¸š</a><ul><li><a href="#">3.1 äº‘ä½œä¸šé…ç½®</a><ul><li><a href="#">3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®</a></li></ul></li><li><a href="#">3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®</a></li><li><a href="#">3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“</a></li></ul></li><li><a href="#">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š  </p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨  </li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong>  </li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚  </li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚  </li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Elastic-Job-Cloud ä½œä¸šé…ç½®</strong>ã€‚</p><p>å¦‚æœä½ é˜…è¯»è¿‡ä»¥ä¸‹æ–‡ç« ï¼Œæœ‰åŠ©äºå¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p><ul><li><a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/cloud-restful-api/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” RESTFUL APIã€‹</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹</a></li><li><a href="https://segmentfault.com/a/1190000007723430" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç”±æµ…å…¥æ·± | å¦‚ä½•ä¼˜é›…åœ°å†™ä¸€ä¸ªMesos Frameworkã€‹</a></li></ul><p>ğŸ˜ˆ å¦å¤–ï¼Œç¬”è€…å‡è®¾ä½ å·²ç»å¯¹ <strong><a href="http://www.iocoder.cn/categories/Elastic-Job/?self">ã€ŠElastic-Job-Lite æºç åˆ†æç³»åˆ—ã€‹</a></strong> æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æœ¬æ–‡æ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/01.png" alt=""></p><ul><li><strong>é»„è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚</li><li><strong>ç´«è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-cloud</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Cloud ä½œä¸šé…ç½®ç±»ã€‚</li><li><strong>çº¢è‰²</strong>çš„ç±»åœ¨ <code>elastic-job-lite</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Lite ä½œä¸šé…ç½®ç±»ã€‚</li></ul><blockquote><p>ä½ è¡Œå¥½äº‹ä¼šå› ä¸ºå¾—åˆ°èµèµè€Œæ„‰æ‚¦<br>åŒç†ï¼Œå¼€æºé¡¹ç›®è´¡çŒ®è€…ä¼šå› ä¸º Star è€Œæ›´åŠ æœ‰åŠ¨åŠ›<br>ä¸º Elastic-Job ç‚¹èµï¼<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a></p></blockquote><h1 id="2-äº‘ä½œä¸šApp"><a href="#2-äº‘ä½œä¸šApp" class="headerlink" title="2. äº‘ä½œä¸šApp"></a>2. äº‘ä½œä¸šApp</h1><p>é¦–å…ˆï¼Œç†è§£ä¸‹ <strong>äº‘ä½œä¸šApp</strong> çš„å®šä¹‰ï¼š</p><blockquote><p>FROM <a href="http://dangdangdotcom.github.io/elastic-job/elastic-job-cloud/02-guide/cloud-concepts/" rel="external nofollow noopener noreferrer" target="_blank">http://dangdangdotcom.github.io/elastic-job/elastic-job-cloud/02-guide/cloud-concepts/</a>      </p><p>ä½œä¸šAPPæŒ‡ä½œä¸šæ‰“åŒ…éƒ¨ç½²åçš„åº”ç”¨ï¼Œæè¿°äº†ä½œä¸šå¯åŠ¨éœ€è¦ç”¨åˆ°çš„CPUã€å†…å­˜ã€å¯åŠ¨è„šæœ¬åŠåº”ç”¨ä¸‹è½½è·¯å¾„ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œæ¯ä¸ªAPPå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸šã€‚</p></blockquote><p>ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªäº‘ä½œä¸šAppå¯ä»¥ç†è§£æˆç”±å¤šä¸ªä½œä¸šæ‰“åœ¨ä¸€èµ·çš„ <code>jar</code>ã€‚</p><h2 id="2-1-äº‘ä½œä¸šAppé…ç½®ç±»"><a href="#2-1-äº‘ä½œä¸šAppé…ç½®ç±»" class="headerlink" title="2.1 äº‘ä½œä¸šAppé…ç½®ç±»"></a>2.1 äº‘ä½œä¸šAppé…ç½®ç±»</h2><p>CloudAppConfigurationï¼Œäº‘ä½œä¸šAppé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨åŒ…åœ°å€</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appURL;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å¯åŠ¨è„šæœ¬</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bootstrapScript;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cpu æ•°é‡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> cpuCount = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å†…å­˜ å¤§å°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> memoryMB = <span class="number">128</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ¯æ¬¡æ‰§è¡Œä½œä¸šæ—¶æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–åº”ç”¨ã€‚ç¦ç”¨åˆ™æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‡ä»åº”ç”¨ä»“åº“ä¸‹è½½åº”ç”¨è‡³æœ¬åœ°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> appCacheEnable = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤ä¸é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚</span></div><div class="line"><span class="comment">     * ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> eventTraceSamplingCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>åœ¨ Elastic-Job-Lite é‡Œï¼Œæ‰“åŒ…ä½œä¸šï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨é‡Œå¯åŠ¨ã€‚è€Œåœ¨ Elastic-Job-Cloud é‡Œï¼Œæ‰“åŒ…ä½œä¸šä¸Šä¼ è‡³å¯ä¸‹è½½çš„åœ°å€ã€‚ä½œä¸šè¢«è°ƒåº¦æ—¶ï¼ŒMesos ä¼šä» <code>appURL</code> ä¸‹è½½åº”ç”¨åŒ…ï¼Œä½¿ç”¨ <code>bootstrapScript</code> å¯åŠ¨åº”ç”¨è¿›è¡Œæ‰§è¡Œã€‚å®é™…æƒ…å†µä¼šæ›´åŠ å¤æ‚ä¸€ä¸¢ä¸¢ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</li><li><code>cpuCount</code>, <code>memoryMB</code> é…ç½®<strong>äº‘ä½œä¸šAppè‡ªèº«å ç”¨çš„èµ„æºæƒ…å†µ</strong>ã€‚å…¶åŒ…å«çš„æ¯ä¸ªä½œä¸šå ç”¨çš„èµ„æºæƒ…å†µï¼Œä½¿ç”¨ä½œä¸šå¯¹åº”çš„äº‘ä½œä¸šé…ç½®( CloudJobConfiguration ) ï¼Œä¸‹æ–‡ä¹Ÿä¼šçœ‹åˆ°ã€‚</li><li><code>appCacheEnable</code>ï¼šæ¯æ¬¡æ‰§è¡Œä½œä¸šæ—¶æ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–åº”ç”¨ã€‚ç¦ç”¨åˆ™æ¯æ¬¡æ‰§è¡Œä»»åŠ¡å‡ä»åº”ç”¨ä»“åº“ä¸‹è½½åº”ç”¨è‡³æœ¬åœ°ã€‚</li><li><code>eventTraceSamplingCount</code>ï¼šå¸¸é©»ä½œä¸šäº‹ä»¶é‡‡æ ·ç‡ç»Ÿè®¡æ¡æ•°ï¼Œé»˜è®¤é‡‡æ ·å…¨éƒ¨è®°å½•ã€‚ä¸ºé¿å…æ•°æ®é‡è¿‡å¤§ï¼Œå¯å¯¹é¢‘ç¹è°ƒåº¦çš„å¸¸é©»ä½œä¸šé…ç½®é‡‡æ ·ç‡ï¼Œå³ä½œä¸šæ¯æ‰§è¡ŒNæ¬¡ï¼Œæ‰ä¼šè®°å½•ä½œä¸šæ‰§è¡ŒåŠè¿½è¸ªç›¸å…³æ•°æ®ã€‚</li></ul><h2 id="2-2-æ“ä½œäº‘ä½œä¸šAppé…ç½®"><a href="#2-2-æ“ä½œäº‘ä½œä¸šAppé…ç½®" class="headerlink" title="2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®"></a>2.2 æ“ä½œäº‘ä½œä¸šAppé…ç½®</h2><p>äº‘ä½œä¸šAppé…ç½®æœ‰å¤šç§æ“ä½œï¼š</p><ol><li>æ·»åŠ  / æ›´æ–° / åˆ é™¤</li><li>å¼€å¯ / ç¦ç”¨</li></ol><p>æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä»¥<strong>æ·»åŠ </strong>ä¸¾ä¾‹å­ï¼š</p><ul><li><p>è°ƒç”¨ HTTP æ¥å£ï¼š</p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"appName":"foo_app","appURL":"http://app_host:8080/yourJobs.gz","cpuCount":0.1,"memoryMB":64.0,"bootstrapScript":"bin/start.sh","appCacheEnable":true,"eventTraceSamplingCount":0&#125;' http://elastic_job_cloud_host:8899/api/app</div></pre></td></tr></table></figure></li><li><p>è¿ç»´å¹³å°</p><p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/02.png" alt=""></p></li></ul><p>è¿ç»´å¹³å°æ˜¯å¯¹è°ƒç”¨ HTTP æ¥å£çš„UIå°è£…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudAppRestfulApi</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/app"</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppRestfulApi</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œåº”ç”¨é…ç½®.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> appConfig åº”ç”¨é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">        Optional&lt;CloudAppConfiguration&gt; appConfigFromZk = appConfigService.load(appConfig.getAppName());</div><div class="line">        <span class="keyword">if</span> (appConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppConfigurationException(<span class="string">"app '%s' already existed."</span>, appConfig.getAppName());</div><div class="line">        &#125;</div><div class="line">        appConfigService.add(appConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ äº‘ä½œä¸šAPPé…ç½®.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> appConfig äº‘ä½œä¸šAppé…ç½®å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> CloudAppConfiguration appConfig)</span> </span>&#123;</div><div class="line">   regCenter.persist(CloudAppConfigurationNode.getRootNodePath(appConfig.getAppName()), CloudAppConfigurationGsonFactory.toJson(appConfig));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudAppConfigurationNode.JAVA</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudAppConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT =  <span class="string">"/config/app"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_CONFIG =  ROOT + <span class="string">"/%s"</span>; <span class="comment">// %s = $&#123;APP_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>CloudAppRestfulApiï¼Œäº‘ä½œä¸šåº”ç”¨çš„REST APIï¼Œå®ç°äº†äº‘ä½œä¸šAppé…ç½®çš„å¤šç§æ“ä½œçš„ HTTP æ¥å£ã€‚</li><li>CloudAppConfigurationServiceï¼Œäº‘ä½œä¸šAppé…ç½®æœåŠ¡ï¼Œå®ç°äº†äº‘ä½œä¸šåº”ç”¨çš„å­˜å‚¨åŠŸèƒ½ã€‚</li><li>è°ƒç”¨ <code>AppConfigService#add(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ CloudAppConfiguration åˆ°æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>${NAMESPACE}/config/app/${APP_NAME}</code>ï¼ŒJSON æ ¼å¼åŒ–å¯¹è±¡ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] get /elastic-job-cloud/config/app/exampleApp</div><div class="line">&#123;"appName":"exampleApp","appURL":"http://785j8w.com1.z0.glb.clouddn.com/elastic-job-example-cloud-2.1.5.tar.gz","bootstrapScript":"bin/start.sh","cpuCount":1.0,"memoryMB":128.0,"appCacheEnable":true,"eventTraceSamplingCount":0&#125;</div></pre></td></tr></table></figure><h1 id="3-äº‘ä½œä¸š"><a href="#3-äº‘ä½œä¸š" class="headerlink" title="3. äº‘ä½œä¸š"></a>3. äº‘ä½œä¸š</h1><p>ä¸€ä¸ªäº‘ä½œä¸šåº”ç”¨å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªäº‘ä½œä¸šã€‚äº‘ä½œä¸šæœ‰<strong>ä¸¤ç§</strong>ä½œä¸šé…ç½®ï¼šäº‘ä½œä¸šé…ç½®ã€æœ¬åœ°äº‘ä½œä¸šé…ç½®ã€‚ä¸‹é¢æ¥åˆ†åˆ«åˆ†äº«å®ƒä»¬ã€‚</p><h2 id="3-1-äº‘ä½œä¸šé…ç½®"><a href="#3-1-äº‘ä½œä¸šé…ç½®" class="headerlink" title="3.1 äº‘ä½œä¸šé…ç½®"></a>3.1 äº‘ä½œä¸šé…ç½®</h2><p>CloudJobConfigurationï¼Œäº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfiguration</span> <span class="keyword">implements</span> <span class="title">JobRootConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šåº”ç”¨åç§° &#123;<span class="doctag">@link</span> com.dangdang.ddframe.job.cloud.scheduler.config.app.CloudAppConfiguration&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String appName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šç±»å‹é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobTypeConfiguration typeConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ç‰‡ä½œä¸šæ‰€éœ€è¦çš„CPUæ•°é‡ï¼Œæœ€å°å€¼ä¸º0.001</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> cpuCount;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å•ç‰‡ä½œä¸šæ‰€éœ€è¦çš„å†…å­˜MBï¼Œæœ€å°å€¼ä¸º1</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> memoryMB;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä½œä¸šæ‰§è¡Œç±»å‹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudJobExecutionType jobExecutionType;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Springå®¹å™¨ä¸­é…ç½®çš„beanåç§°</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String beanName;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Springæ–¹å¼é…ç½®Springé…ç½®æ–‡ä»¶ç›¸å¯¹è·¯å¾„ä»¥åŠåç§°ï¼Œå¦‚ï¼šMETA-INF\applicationContext.xml</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String applicationContext; </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>JobTypeConfigurationï¼Œä½œä¸šç±»å‹é…ç½®ï¼Œåœ¨ <code>elastic-job-common-core</code> é¡¹ç›®é‡Œï¼Œä¸º Elastic-Job-Liteã€Elastic-Job-Cloud <strong>å…¬ç”¨</strong>ä½œä¸šé…ç½®ç±»ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/job-config/?self">ã€ŠElastic-Job-Lite æºç åˆ†æ â€”â€” ä½œä¸šé…ç½®ã€‹çš„ã€Œ2.2.1 ä½œä¸šç±»å‹é…ç½®ã€</a>æœ‰è¯¦ç»†è§£æã€‚</li><li><code>cpuCount</code>, <code>memoryMB</code> é…ç½®<strong>å•ç‰‡ä½œä¸šå ç”¨çš„èµ„æºæƒ…å†µ</strong>ã€‚è¿™é‡Œä¸€å®šè¦æ³¨æ„æ˜¯å•ç‰‡ä½œä¸šï¼Œä¾‹å¦‚ä¸€ä¸ªä½œä¸šæœ‰ä¸‰ä¸ªåˆ†ç‰‡( <code>shardingTotalCount = 3</code> )ï¼Œåˆ™å ç”¨èµ„æºä¸º 3 <em> <code>cpuCount</code> + 3 </em> <code>memoryMB</code>ã€‚</li><li>ä½œä¸šæ‰§è¡Œç±»å‹( CloudJobExecutionType )æœ‰ä¸¤ç§ï¼šå¸¸é©»ä½œä¸š( DAEMON )ï¼Œç¬æ—¶ä½œä¸š( TRANSIENT )ã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚Elastic-Job-Cloud ç‹¬æœ‰ï¼Œéå¸¸æœ‰è¶£ã€‚ğŸ‘ğŸ‘ğŸ‘</li><li><code>beanName</code>, <code>applicationContext</code> å®ç° Spring å¯åŠ¨æ–¹å¼ä½œä¸šã€‚åœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</li></ul><h3 id="3-1-1-æ“ä½œäº‘ä½œä¸šé…ç½®"><a href="#3-1-1-æ“ä½œäº‘ä½œä¸šé…ç½®" class="headerlink" title="3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®"></a>3.1.1 æ“ä½œäº‘ä½œä¸šé…ç½®</h3><p>äº‘ä½œä¸šé…ç½®æœ‰å¤šç§æ“ä½œï¼š</p><ol><li>æ·»åŠ  / æ›´æ–° / åˆ é™¤</li><li>å¼€å¯ / ç¦ç”¨</li></ol><p>æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä»¥<strong>æ·»åŠ </strong>ä¸¾ä¾‹å­ï¼š</p><ul><li><p>è°ƒç”¨ HTTP æ¥å£ï¼š</p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">// Javaå¯åŠ¨æ–¹å¼ä½œä¸šæ³¨å†Œ</div><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"jobName":"foo_job","appName":"foo_app","jobClass":"yourJobClass","jobType":"SIMPLE","jobExecutionType":"TRANSIENT","cron":"0/5 * * * * ?","shardingTotalCount":5,"cpuCount":0.1,"memoryMB":64.0,"appURL":"http://app_host:8080/foo-job.tar.gz","failover":true,"misfire":true,"bootstrapScript":"bin/start.sh"&#125;' http://elastic_job_cloud_host:8899/api/job/register</div><div class="line"></div><div class="line">// Springå¯åŠ¨æ–¹å¼ä½œä¸šæ³¨å†Œ</div><div class="line">curl -l -H "Content-type: application/json" -X POST -d '&#123;"jobName":"foo_job","jobClass":"yourJobClass","beanName":"yourBeanName","applicationContext":"applicationContext.xml","jobType":"SIMPLE","jobExecutionType":"TRANSIENT","cron":"0/5 * * * * ?","shardingTotalCount":5,"cpuCount":0.1,"memoryMB":64.0,"appURL":"http://file_host:8080/foo-job.tar.gz","failover":false,"misfire":true,"bootstrapScript":"bin/start.sh"&#125;' http://elastic_job_cloud_masterhost:8899/api/job/register</div></pre></td></tr></table></figure></li><li><p>è¿ç»´å¹³å°</p><p>  <img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/03.png" alt=""></p></li></ul><p>è¿ç»´å¹³å°æ˜¯å¯¹è°ƒç”¨ HTTP æ¥å£çš„UIå°è£…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CloudJobRestfulApi.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobRestfulApi</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œä½œä¸š.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/register"</span>)</div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">        producerManager.register(jobConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ProducerManager.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerManager</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ³¨å†Œä½œä¸š.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> jobConfig ä½œä¸šé…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (disableJobService.isDisabled(jobConfig.getJobName())) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job '%s' has been disable."</span>, jobConfig.getJobName());</div><div class="line">        &#125;</div><div class="line">        Optional&lt;CloudAppConfiguration&gt; appConfigFromZk = appConfigService.load(jobConfig.getAppName());</div><div class="line">        <span class="keyword">if</span> (!appConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppConfigurationException(<span class="string">"Register app '%s' firstly."</span>, jobConfig.getAppName());</div><div class="line">        &#125;</div><div class="line">        Optional&lt;CloudJobConfiguration&gt; jobConfigFromZk = configService.load(jobConfig.getJobName());</div><div class="line">        <span class="keyword">if</span> (jobConfigFromZk.isPresent()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobConfigurationException(<span class="string">"Job '%s' already existed."</span>, jobConfig.getJobName());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ·»åŠ äº‘ä½œä¸šé…ç½®</span></div><div class="line">        configService.add(jobConfig);</div><div class="line">        <span class="comment">// è°ƒåº¦ä½œä¸š</span></div><div class="line">        schedule(jobConfig);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudJobConfigurationService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ·»åŠ äº‘ä½œä¸šé…ç½®.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobConfig äº‘ä½œä¸šé…ç½®å¯¹è±¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">final</span> CloudJobConfiguration jobConfig)</span> </span>&#123;</div><div class="line">   regCenter.persist(CloudJobConfigurationNode.getRootNodePath(jobConfig.getJobName()), CloudJobConfigurationGsonFactory.toJson(jobConfig));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// CloudJobConfigurationNode.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudJobConfigurationNode</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT =  <span class="string">"/config/job"</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_CONFIG =  ROOT + <span class="string">"/%s"</span>;  <span class="comment">// %s = $&#123;JOB_NAME&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>CloudJobRestfulApiï¼Œä½œä¸šäº‘Jobçš„REST APIï¼Œå®ç°äº†ä½œä¸šäº‘Jobé…ç½®çš„å¤šç§æ“ä½œã€æŸ¥è¯¢è¿è¡Œä¸­ / å¾…è¿è¡Œ / å¤±æ•ˆè½¬ç§»ä½œä¸šåˆ—è¡¨ç­‰ HTTP æ¥å£ã€‚</li><li>ProducerManagerï¼Œå‘å¸ƒä»»åŠ¡ä½œä¸šè°ƒåº¦ç®¡ç†å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</li><li>CloudJobConfigurationServiceï¼Œä½œä¸šé…ç½®æœåŠ¡ï¼Œå®ç°äº†ä½œä¸šé…ç½®çš„å­˜å‚¨åŠŸèƒ½ã€‚</li><li><p>è°ƒç”¨ <code>CloudJobConfigurationService#add(...)</code> æ–¹æ³•ï¼Œå­˜å‚¨ CloudJobConfiguration åˆ°æ³¨å†Œä¸­å¿ƒ( Zookeeper )çš„<strong>æŒä¹…</strong>æ•°æ®èŠ‚ç‚¹ <code>${NAMESPACE}/config/job/${JOB_NAME}</code>ï¼ŒJSON æ ¼å¼åŒ–å¯¹è±¡ã€‚ä½¿ç”¨ zkClient æŸ¥çœ‹å¦‚ä¸‹ï¼š</p>  <figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">    [zk: localhost:2181(CONNECTED) 3] get /elastic-job-cloud/config/job/test_job_simple</div><div class="line">&#123;"jobName":"test_job_simple","jobClass":"com.dangdang.ddframe.job.example.job.simple.JavaSimpleJob","jobType":"SIMPLE","cron":"0/10 * * * * ?","shardingTotalCount":1,"shardingItemParameters":"","jobParameter":"","failover":false,"misfire":false,"description":"","jobProperties":&#123;"job_exception_handler":"com.dangdang.ddframe.job.executor.handler.impl.DefaultJobExceptionHandler","executor_service_handler":"com.dangdang.ddframe.job.executor.handler.impl.DefaultExecutorServiceHandler"&#125;,"appName":"exampleApp","cpuCount":0.1,"memoryMB":64.0,"jobExecutionType":"TRANSIENT"&#125;</div></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>#schedule(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä½œä¸šã€‚è¿™æ˜¯ä¸ªå¾ˆæœ‰è¶£çš„æ–¹æ³•ï¼Œåœ¨<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>è¯¦ç»†è§£æã€‚</p></li></ul><h2 id="3-2-æœ¬åœ°äº‘ä½œä¸šé…ç½®"><a href="#3-2-æœ¬åœ°äº‘ä½œä¸šé…ç½®" class="headerlink" title="3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®"></a>3.2 æœ¬åœ°äº‘ä½œä¸šé…ç½®</h2><p>LocalCloudJobConfigurationï¼Œæœ¬åœ°äº‘ä½œä¸šé…ç½®ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public final class LocalCloudJobConfiguration implements JobRootConfiguration &#123;</div><div class="line">    </div><div class="line">    private final JobTypeConfiguration typeConfig;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * åˆ†ç‰‡ä½œä¸šåºå·</div><div class="line">     */</div><div class="line">    private final int shardingItem;</div><div class="line">    </div><div class="line">    private String beanName;</div><div class="line">    </div><div class="line">    private String applicationContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>shardingItem</code>ï¼Œåˆ†ç‰‡ä½œä¸šåºå·ï¼Œç”¨äºæœ¬åœ°è°ƒè¯•æŒ‡å®šåˆ†ç‰‡ä½œä¸šé¡¹ã€‚</li></ul><p>åˆ°åº•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><blockquote><p>åœ¨å¼€å‘Elastic-Job-Cloudä½œä¸šæ—¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è„±ç¦»Mesosç¯å¢ƒï¼Œåœ¨æœ¬åœ°è¿è¡Œå’Œè°ƒè¯•ä½œä¸šã€‚å¯ä»¥åˆ©ç”¨æœ¬åœ°è¿è¡Œæ¨¡å¼å……åˆ†çš„è°ƒè¯•ä¸šåŠ¡åŠŸèƒ½ä»¥åŠå•å…ƒæµ‹è¯•ï¼Œå®Œæˆä¹‹åå†éƒ¨ç½²è‡³Mesosé›†ç¾¤ã€‚<br>æœ¬åœ°è¿è¡Œä½œä¸šæ— éœ€å®‰è£…Mesosç¯å¢ƒã€‚</p></blockquote><p>åœ¨<a href="http://elasticjob.io/docs/elastic-job-cloud/02-guide/local-executor/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå®˜æ–¹æ–‡æ¡£ â€”â€” æœ¬åœ°è¿è¡Œæ¨¡å¼ã€‹</a>æœ‰è¯¦ç»†è§£æã€‚</p><h2 id="3-3-äº‘ä½œä¸šé…ç½®æ€»ç»“"><a href="#3-3-äº‘ä½œä¸šé…ç½®æ€»ç»“" class="headerlink" title="3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“"></a>3.3 äº‘ä½œä¸šé…ç½®æ€»ç»“</h2><ul><li>CloudJobConfigurationï¼šç”Ÿäº§è¿è¡Œä½¿ç”¨ã€‚</li><li>LocalCloudJobConfigurationï¼šæœ¬åœ°å¼€å‘è°ƒè¯•ã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>èŠ‹é“å›ï¼šæœ¬æ–‡ä¸»è¦ä¸º<a href="http://www.iocoder.cn/Elastic-Job/cloud-job-scheduler-and-executor-first/?self">ã€ŠElastic-Job-Cloud æºç è§£æ â€”â€” ä½œä¸šè°ƒåº¦ï¼ˆä¸€ï¼‰ã€‹</a>åšé“ºå«ï¼Œè¿™ä¼šæ˜¯ä¸€ç¯‡é•¿æ–‡ã€‚è¯»æ‡‚ Elastic-Job-Cloud ä½œä¸šè°ƒåº¦åï¼Œæ•´ä¸ªäººè„‘æ´åˆå¼€çš„ä¸è¡Œä¸è¡Œçš„ï¼<br>æ—ç™½å›ï¼šæ”¯æŒ+1024ã€‚</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_12_14/04.png" alt=""></p><p>å¦å¤–ï¼Œæ¨èèµ„æ–™å¦‚ä¸‹ï¼Œå¯¹ç†è§£ Elastic-Job-Cloud å¾ˆæœ‰å¸®åŠ©ã€‚</p><ul><li><a href="http://www.infoq.com/cn/news/2016/09/Mesos-Elastic-Job-Cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸºäºMesosçš„å½“å½“ä½œä¸šäº‘Elastic Job Cloudã€‹</a></li><li><a href="http://www.infoq.com/cn/presentations/how-to-build-elastic-job-cloud" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¦‚ä½•ä»0åˆ°1æ­å»ºå¼¹æ€§ä½œä¸šäº‘Elastic-Job-Cloudã€‹</a></li></ul><p>é“å‹ï¼Œèµ¶ç´§ä¸Šè½¦ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;æœ¬æ–‡åŸºäº Elastic-Job V2.1.5 ç‰ˆæœ¬åˆ†äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;1. æ¦‚è¿°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2. äº‘ä½œä¸šApp&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;2
      
    
    </summary>
    
      <category term="Elastic-Job-Cloud" scheme="http://www.iocoder.cn/categories/Elastic-Job-Cloud/"/>
    
    
  </entry>
  
</feed>
