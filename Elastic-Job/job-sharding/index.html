<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Elastic-Job-Lite 源码分析 —— 作业分片 | 芋道源码 —— 纯源码解析BLOG</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="芋道源码"><meta name="description" content="摘要: 原创出处 http://www.iocoder.cn/Elastic-Job/job-sharding/ 「芋道源码」欢迎转载，保留摘要，谢谢！
本文基于 Elastic-Job V2.1.5 版本分享

1. 概述
2. 作业分片条件
3. 分配作业分片项
4. 获取作业分片上下文集合
6"><meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客,Sharding-JDBC,分库分表"><link rel="alternate" href="atom.xml" title="芋道源码 —— 纯源码解析BLOG" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="芋道源码 —— 纯源码解析BLOG">芋道源码 —— 纯源码解析BLOG</a></h1><a class="blog-motto">愿半生编码，如一生老友！</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="菜单"></a></div><nav class="animated"><ul><ul><li><a href="/">文章</a></li><li><a href="/2018-meet-you">知识星球</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">微信公众号</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">工作内推</a></li><li><a href="/link_url">友链</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Elastic-Job/job-sharding/" title="Elastic-Job-Lite 源码分析 —— 作业分片" itemprop="url">Elastic-Job-Lite 源码分析 —— 作业分片</a></h1><p class="article-author"></p><p class="article-time">总阅读量:<span id="busuanzi_value_page_pv"></span>次</p></header><div class="article-content"><p>摘要: 原创出处 <a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">http://www.iocoder.cn/Elastic-Job/job-sharding/</a> 「芋道源码」欢迎转载，保留摘要，谢谢！</p><p><strong>本文基于 Elastic-Job V2.1.5 版本分享</strong></p><ul><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">1. 概述</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">2. 作业分片条件</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">3. 分配作业分片项</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">4. 获取作业分片上下文集合</a></li><li><a href="http://www.iocoder.cn/Elastic-Job/job-sharding/">666. 彩蛋</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>🙂🙂🙂关注<strong>微信公众号：【芋道源码】</strong>有福利：</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>所有</strong>源码分析文章列表</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>中文注释源码 GitHub 地址</strong></li><li>您对于源码的疑问每条留言<strong>都</strong>将得到<strong>认真</strong>回复。<strong>甚至不知道如何读源码也可以请教噢</strong>。</li><li><strong>新的</strong>源码解析文章<strong>实时</strong>收到通知。<strong>每周更新一篇左右</strong>。</li><li><strong>认真的</strong>源码交流微信群。</li></ol></blockquote><hr><h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文主要分享 <strong>Elastic-Job-Lite 作业分片</strong>。</p><p>涉及到主要类的类图如下( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/01.png">打开大图</a> )：</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/01.png" alt=""></p><ul><li>粉色的类在 <code>com.dangdang.ddframe.job.lite.internal.sharding</code> 包下，实现了 Elastic-Job-Lite 作业分片。</li><li>ShardingService，作业分片服务。</li><li>ShardingNode，作业分片数据存储路径。</li><li>ShardingListenerManager，作业分片监听管理器。</li></ul><blockquote><p>你行好事会因为得到赞赏而愉悦<br>同理，开源项目贡献者会因为 Star 而更加有动力<br>为 Elastic-Job 点赞！<a href="https://github.com/dangdangdotcom/elastic-job/stargazers" rel="external nofollow noopener noreferrer" target="_blank">传送门</a></p></blockquote><h1 id="2-作业分片条件"><a href="#2-作业分片条件" class="headerlink" title="2. 作业分片条件"></a>2. 作业分片条件</h1><p>当作业满足分片条件时，不会<strong>立即</strong>进行作业分片分配，而是设置需要重新进行分片的<strong>标记</strong>，等到作业分片获取时，判断有该标记后<strong>执行</strong>作业分配。</p><p>设置需要重新进行分片的<strong>标记</strong>的代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 设置需要重新分片的标记.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReshardingFlag</span><span class="params">()</span> </span>&#123;</div><div class="line">   jobNodeStorage.createJobNodeIfNeeded(ShardingNode.NECESSARY);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 如果存在则创建作业节点.</span></div><div class="line"><span class="comment">* 如果作业根节点不存在表示作业已经停止, 不再继续创建节点.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> node 作业节点名称</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createJobNodeIfNeeded</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (isJobRootNodeExisted() &amp;&amp; !isJobNodeExisted(node)) &#123;</div><div class="line">       regCenter.persist(jobNodePath.getFullPath(node), <span class="string">""</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>调用 <code>#setReshardingFlag()</code> 方法设置<strong>需要重新分片的标记</strong> <code>/${JOB_NAME}/leader/sharding/necessary</code>。该 Zookeeper 数据节点是<strong>永久</strong>节点，存储空串( <code>&quot;&quot;</code> )，使用 zkClient 查看如下：</p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /elastic-job-example-lite-java/javaSimpleJob/leader/sharding</div><div class="line">[necessary]</div><div class="line">[zk: localhost:2181(CONNECTED) 3] get /elastic-job-example-lite-java/javaSimpleJob/leader/sharding/necessary</div></pre></td></tr></table></figure></li><li><p>设置标记之后，通过调用 <code>#isNeedSharding()</code> 方法即可判断是否需要重新分片。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 判断是否需要重分片.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 是否需要重分片</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNeedSharding</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(ShardingNode.NECESSARY);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 判断作业节点是否存在.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> node 作业节点名称</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 作业节点是否存在</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isJobNodeExisted</span><span class="params">(<span class="keyword">final</span> String node)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> regCenter.isExisted(jobNodePath.getFullPath(node));</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><p><strong>设置需要重新进行分片有 4 种情况</strong></p><p><strong>第一种</strong>，注册作业启动信息时。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SchedulerFacade.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStartUpInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enabled)</span> </span>&#123;</div><div class="line">   <span class="comment">// ... 省略无关代码</span></div><div class="line">   <span class="comment">// 设置 需要重新分片的标记</span></div><div class="line">   shardingService.setReshardingFlag();</div><div class="line">  <span class="comment">// ... 省略无关代码</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>第二种</strong>，作业分片总数( <code>JobCoreConfiguration.shardingTotalCount</code> )变化时。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingTotalCountChangedJobListener.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShardingTotalCountChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (configNode.isConfigPath(path)</div><div class="line">               &amp;&amp; <span class="number">0</span> != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123;</div><div class="line">           <span class="keyword">int</span> newShardingTotalCount = LiteJobConfigurationGsonFactory.fromJson(data).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">           <span class="keyword">if</span> (newShardingTotalCount != JobRegistry.getInstance().getCurrentShardingTotalCount(jobName)) &#123; <span class="comment">// 作业分片总数变化</span></div><div class="line">               <span class="comment">// 设置需要重新分片的标记</span></div><div class="line">               shardingService.setReshardingFlag();</div><div class="line">               <span class="comment">// 设置当前分片总数</span></div><div class="line">               JobRegistry.getInstance().setCurrentShardingTotalCount(jobName, newShardingTotalCount);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>第三种</strong>，服务器变化时。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingListenerManager.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListenServersChangedJobListener</span> <span class="keyword">extends</span> <span class="title">AbstractJobListener</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dataChanged</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String data)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!JobRegistry.getInstance().isShutdown(jobName)</div><div class="line">               &amp;&amp; (isInstanceChange(eventType, path)</div><div class="line">                   || isServerChange(path))) &#123;</div><div class="line">           shardingService.setReshardingFlag();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstanceChange</span><span class="params">(<span class="keyword">final</span> Type eventType, <span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> instanceNode.isInstancePath(path) &amp;&amp; Type.NODE_UPDATED != eventType;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isServerChange</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> serverNode.isServerPath(path);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>服务器变化有<strong>两种</strong>情况。</li><li>第一种，<code>#isServerChange(...)</code> 服务器被开启或禁用。</li><li>第二种，<code>#isInstanceChange(...)</code> 作业节点新增或者移除。</li></ul><p><strong>第四种</strong>，在<a href="http://www.iocoder.cn/Elastic-Job/reconcile/?self">《Elastic-Job-Lite 源码解析 —— 自诊断修复》</a>详细分享。</p><h1 id="3-分配作业分片项"><a href="#3-分配作业分片项" class="headerlink" title="3. 分配作业分片项"></a>3. 分配作业分片项</h1><p>调用 <code>ShardingService#shardingIfNecessary()</code> 方法，如果需要分片且当前节点为主节点, 则作业分片。</p><p>总体流程如下<strong>顺序图</strong>：( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/02.png">打开大图</a> )：</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/02.png" alt=""></p><p>实现代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 如果需要分片且当前节点为主节点, 则作业分片.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* 如果当前无可用节点则不分片.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shardingIfNecessary</span><span class="params">()</span> </span>&#123;</div><div class="line">   List&lt;JobInstance&gt; availableJobInstances = instanceService.getAvailableJobInstances();</div><div class="line">   <span class="keyword">if</span> (!isNeedSharding() <span class="comment">// 判断是否需要重新分片</span></div><div class="line">           || availableJobInstances.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 【非主节点】等待 作业分片项分配完成</span></div><div class="line">   <span class="keyword">if</span> (!leaderService.isLeaderUntilBlock()) &#123; <span class="comment">// 判断是否为【主节点】</span></div><div class="line">       blockUntilShardingCompleted();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 【主节点】作业分片项分配</span></div><div class="line">   <span class="comment">// 等待 作业未在运行中状态</span></div><div class="line">   waitingOtherJobCompleted();</div><div class="line">   <span class="comment">//</span></div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">false</span>);</div><div class="line">   <span class="keyword">int</span> shardingTotalCount = liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">   <span class="comment">// 设置 作业正在重分片的标记</span></div><div class="line">   log.debug(<span class="string">"Job '&#123;&#125;' sharding begin."</span>, jobName);</div><div class="line">   jobNodeStorage.fillEphemeralJobNode(ShardingNode.PROCESSING, <span class="string">""</span>);</div><div class="line">   <span class="comment">// 重置 作业分片项信息</span></div><div class="line">   resetShardingInfo(shardingTotalCount);</div><div class="line">   <span class="comment">// 【事务中】设置 作业分片项信息</span></div><div class="line">   JobShardingStrategy jobShardingStrategy = JobShardingStrategyFactory.getStrategy(liteJobConfig.getJobShardingStrategyClass());</div><div class="line">   jobNodeStorage.executeInTransaction(<span class="keyword">new</span> PersistShardingInfoTransactionExecutionCallback(jobShardingStrategy.sharding(availableJobInstances, jobName, shardingTotalCount)));</div><div class="line">   log.debug(<span class="string">"Job '&#123;&#125;' sharding complete."</span>, jobName);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>调用 <code>#isNeedSharding()</code> 方法判断是否需要重新分片。</li><li>调用 <code>LeaderService#isLeaderUntilBlock()</code> 方法判断是否为<strong>主节点</strong>。作业分片项的分配过程：<ul><li>【主节点】<strong>执行</strong>作业分片项分配。</li><li>【非主节点】<strong>等待</strong>作业分片项分配完成。</li><li><code>LeaderService#isLeaderUntilBlock()</code> 方法在<a href="http://www.iocoder.cn/Elastic-Job/election/?self">《Elastic-Job-Lite 源码分析 —— 主节点选举》「3. 选举主节点」</a>有详细分享。</li></ul></li><li><p>调用 <code>#blockUntilShardingCompleted()</code> 方法【非主节点】<strong>等待</strong>作业分片项分配完成。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">blockUntilShardingCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!leaderService.isLeaderUntilBlock() <span class="comment">// 当前作业节点不为【主节点】</span></div><div class="line">           &amp;&amp; (jobNodeStorage.isJobNodeExisted(ShardingNode.NECESSARY) <span class="comment">// 存在作业需要重分片的标记</span></div><div class="line">               || jobNodeStorage.isJobNodeExisted(ShardingNode.PROCESSING))) &#123; <span class="comment">// 存在作业正在重分片的标记</span></div><div class="line">       log.debug(<span class="string">"Job '&#123;&#125;' sleep short time until sharding completed."</span>, jobName);</div><div class="line">       BlockUtils.waitingShortTime();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>调用 <code>#LeaderService#isLeaderUntilBlock()</code> 方法判断是否为<strong>主节点</strong>。为什么上面判断了一次，这里又判断一次？主节点作业分片项分配过程中，不排除自己挂掉了，此时【非主节点】若选举成主节点，无需继续等待，当然也不能等待，因为已经没节点在执行作业分片项分配，所有节点都会卡在这里。</li><li>当 <strong>作业需要重分片的标记</strong>、<strong>作业正在重分片的标记</strong> 都不存在时，意味着作业分片项分配已经完成，下文 PersistShardingInfoTransactionExecutionCallback 类里我们会看到。</li></ul></li><li><p>调用 <code>#waitingOtherJobCompleted()</code> 方法等待作业未在运行中状态。作业是否在运行中需要 <code>LiteJobConfiguration.monitorExecution = true</code>，<a href="http://www.iocoder.cn/Elastic-Job/election/?self">《Elastic-Job-Lite 源码分析 —— 作业执行》「4.6 执行普通触发的作业」</a>有详细分享。</p></li><li>调用 <code>ConfigurationService#load(...)</code> 方法从注册中心获取作业配置( <strong>非缓存</strong> )，避免主节点本地作业配置可能非最新的，主要目的是获得作业分片总数( <code>shardingTotalCount</code> )。</li><li>调用 <code>jobNodeStorage.fillEphemeralJobNode(ShardingNode.PROCESSING, &quot;&quot;)</code> 设置<strong>作业正在重分片的标记</strong> <code>/${JOB_NAME}/leader/sharding/processing</code>。该 Zookeeper 数据节点是<strong>临时</strong>节点，存储空串( <code>&quot;&quot;</code> )，仅用于标记作业正在重分片，无特别业务逻辑。</li><li><p>调用 <code>#resetShardingInfo(...)</code> 方法<strong>重置</strong>作业分片信息。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetShardingInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount)</span> </span>&#123;</div><div class="line">  <span class="comment">// 重置 有效的作业分片项</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">      jobNodeStorage.removeJobNodeIfExisted(ShardingNode.getInstanceNode(i)); <span class="comment">// 移除 `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance`</span></div><div class="line">      jobNodeStorage.createJobNodeIfNeeded(ShardingNode.ROOT + <span class="string">"/"</span> + i); <span class="comment">// 创建 `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 移除 多余的作业分片项</span></div><div class="line">  <span class="keyword">int</span> actualShardingTotalCount = jobNodeStorage.getJobNodeChildrenKeys(ShardingNode.ROOT).size();</div><div class="line">  <span class="keyword">if</span> (actualShardingTotalCount &gt; shardingTotalCount) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = shardingTotalCount; i &lt; actualShardingTotalCount; i++) &#123;</div><div class="line">          jobNodeStorage.removeJobNodeIfExisted(ShardingNode.ROOT + <span class="string">"/"</span> + i); <span class="comment">// 移除 `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;`</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>调用 <code>JobShardingStrategy#sharding(...)</code> 方法<strong>计算</strong>每个节点分配的作业分片项。<a href="http://www.iocoder.cn/Elastic-Job/job-sharding-strategy/?self">《Elastic-Job-Lite 源码分析 —— 作业分片策略》</a>有详细分享。</p></li><li><p>调用 <code>JobNodeStorage#executeInTransaction(...)</code> + <code>PersistShardingInfoTransactionExecutionCallback#execute()</code> 方法实现在<strong>事务</strong>中<strong>设置</strong>每个节点分配的作业分片项。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PersistShardingInfoTransactionExecutionCallback.java</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersistShardingInfoTransactionExecutionCallback</span> <span class="keyword">implements</span> <span class="title">TransactionExecutionCallback</span> </span>&#123;</div><div class="line">   </div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * 作业分片项分配结果</span></div><div class="line"><span class="comment">    * key：作业节点</span></div><div class="line"><span class="comment">    * value：作业分片项</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JobInstance, List&lt;Integer&gt;&gt; shardingResults;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> CuratorTransactionFinal curatorTransactionFinal)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="comment">// 设置 每个节点分配的作业分片项</span></div><div class="line">       <span class="keyword">for</span> (Map.Entry&lt;JobInstance, List&lt;Integer&gt;&gt; entry : shardingResults.entrySet()) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> shardingItem : entry.getValue()) &#123;</div><div class="line">               curatorTransactionFinal.create().forPath(jobNodePath.getFullPath(ShardingNode.getInstanceNode(shardingItem))</div><div class="line">                       , entry.getKey().getJobInstanceId().getBytes()).and();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 移除 作业需要重分片的标记、作业正在重分片的标记</span></div><div class="line">       curatorTransactionFinal.delete().forPath(jobNodePath.getFullPath(ShardingNode.NECESSARY)).and();</div><div class="line">       curatorTransactionFinal.delete().forPath(jobNodePath.getFullPath(ShardingNode.PROCESSING)).and();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// JobNodeStorage.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 在事务中执行操作.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> callback 执行操作的回调</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeInTransaction</span><span class="params">(<span class="keyword">final</span> TransactionExecutionCallback callback)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       CuratorTransactionFinal curatorTransactionFinal = getClient().inTransaction().check().forPath(<span class="string">"/"</span>).and();</div><div class="line">       callback.execute(curatorTransactionFinal);</div><div class="line">       curatorTransactionFinal.commit();</div><div class="line">   &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</div><div class="line">       RegExceptionHandler.handleException(ex);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>设置<strong>临时</strong>数据节点 <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> 为分配的作业节点的作业实例主键( <code>jobInstanceId</code> )。使用 zkClient 查看如下：</p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 0] get /elastic-job-example-lite-java/javaSimpleJob/sharding/0/instance</div><div class="line">192.168.3.2@-@31492</div></pre></td></tr></table></figure></li></ul></li></ul><p><strong>作业分片项分配整体流程有点长，耐着心看，毕竟是核心代码哟。如果中间有任何疑问，欢迎给我公众号：<a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg">芋道源码</a> 留言。</strong></p><h1 id="4-获取作业分片上下文集合"><a href="#4-获取作业分片上下文集合" class="headerlink" title="4. 获取作业分片上下文集合"></a>4. 获取作业分片上下文集合</h1><p>在<a href="http://www.iocoder.cn/Elastic-Job/job-execute/?self">《Elastic-Job-Lite 源码分析 —— 作业执行的》「4.2 获取当前作业服务器的分片上下文」</a>中，我们可以看到作业执行器( AbstractElasticJobExecutor ) 执行作业时，会获取当前作业服务器的分片上下文进行执行。获取过程总体如下顺序图( <a href="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/03.png">打开大图</a> )：</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/03.png" alt=""></p><ul><li>橘色叉叉在<a href="http://www.iocoder.cn/Elastic-Job/job-failover/?self">《Elastic-Job-Lite 源码解析 —— 作业失效转移》</a>有详细分享。</li></ul><p>实现代码如下：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// LiteJobFacade.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getShardingContexts</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// 【忽略，作业失效转移详解】获得 失效转移的作业分片项</span></div><div class="line">   <span class="keyword">boolean</span> isFailover = configService.load(<span class="keyword">true</span>).isFailover();</div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       List&lt;Integer&gt; failoverShardingItems = failoverService.getLocalFailoverItems();</div><div class="line">       <span class="keyword">if</span> (!failoverShardingItems.isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span> executionContextService.getJobShardingContext(failoverShardingItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 作业分片，如果需要分片且当前节点为主节点</span></div><div class="line">   shardingService.shardingIfNecessary();</div><div class="line">   <span class="comment">// 获得 分配在本机的作业分片项</span></div><div class="line">   List&lt;Integer&gt; shardingItems = shardingService.getLocalShardingItems();</div><div class="line">   <span class="comment">// 【忽略，作业失效转移详解】移除 分配在本机的失效转移的作业分片项目</span></div><div class="line">   <span class="keyword">if</span> (isFailover) &#123;</div><div class="line">       shardingItems.removeAll(failoverService.getLocalTakeOffItems());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 移除 被禁用的作业分片项</span></div><div class="line">   shardingItems.removeAll(executionService.getDisabledItems(shardingItems));</div><div class="line">   <span class="comment">// 获取当前作业服务器分片上下文</span></div><div class="line">   <span class="keyword">return</span> executionContextService.getJobShardingContext(shardingItems);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>调用 <code>ShardingService#shardingIfNecessary()</code> 方法，如果需要分片且当前节点为主节点，作业分片项<strong>分配</strong>。<strong>不是每次都需要作业分片，必须满足「2. 作业分片条件」才执行作业分片</strong>。</li><li><p>调用 <code>ShardingService#getLocalShardingItems()</code>方法，获得分配在<strong>本机</strong>的作业分片项，即 <code>/${JOB_NAME}/sharding/${ITEM_ID}/instance</code> 为本机的作业分片项。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ShardingService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 获取运行在本作业实例的分片项集合.</span></div><div class="line"><span class="comment">* </span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 运行在本作业实例的分片项集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getLocalShardingItems</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (JobRegistry.getInstance().isShutdown(jobName) || !serverService.isAvailableServer(JobRegistry.getInstance().getJobInstance(jobName).getIp())) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> getShardingItems(JobRegistry.getInstance().getJobInstance(jobName).getJobInstanceId());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 获取作业运行实例的分片项集合.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> jobInstanceId 作业运行实例主键</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 作业运行实例的分片项集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getShardingItems</span><span class="params">(<span class="keyword">final</span> String jobInstanceId)</span> </span>&#123;</div><div class="line">   JobInstance jobInstance = <span class="keyword">new</span> JobInstance(jobInstanceId);</div><div class="line">   <span class="keyword">if</span> (!serverService.isAvailableServer(jobInstance.getIp())) &#123;</div><div class="line">       <span class="keyword">return</span> Collections.emptyList();</div><div class="line">   &#125;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">   <span class="keyword">int</span> shardingTotalCount = configService.load(<span class="keyword">true</span>).getTypeConfig().getCoreConfig().getShardingTotalCount();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shardingTotalCount; i++) &#123;</div><div class="line">       <span class="comment">// `/$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/instance`</span></div><div class="line">       <span class="keyword">if</span> (jobInstance.getJobInstanceId().equals(jobNodeStorage.getJobNodeData(ShardingNode.getInstanceNode(i)))) &#123;</div><div class="line">           result.add(i);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>调用 <code>shardingItems.removeAll(executionService.getDisabledItems(shardingItems))</code>，移除<strong>被禁用</strong>的作业分片项，即 <code>/${JOB_NAME}/sharding/${ITEM_ID}/disabled</code> <strong>存在</strong>的作业分片项。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutionService.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 获取禁用的任务分片项.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> items 需要获取禁用的任务分片项</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> 禁用的任务分片项</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getDisabledItems</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; items)</span> </span>&#123;</div><div class="line">   List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(items.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : items) &#123;</div><div class="line">       <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/disabled</span></div><div class="line">       <span class="keyword">if</span> (jobNodeStorage.isJobNodeExisted(ShardingNode.getDisabledNode(each))) &#123;</div><div class="line">           result.add(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>调用 <code>ExecutionContextService#getJobShardingContext(...)</code> 方法，获取<strong>当前</strong>作业服务器分片上下文。</p></li></ul><p><strong>获取当前作业服务器分片上下文</strong></p><p>调用 <code>ExecutionContextService#getJobShardingContext(...)</code> 方法，获取<strong>当前</strong>作业服务器分片上下文：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ExecutionContextService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> ShardingContexts <span class="title">getJobShardingContext</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   LiteJobConfiguration liteJobConfig = configService.load(<span class="keyword">false</span>);</div><div class="line">   <span class="comment">// 移除 正在运行中的作业分片项</span></div><div class="line">   removeRunningIfMonitorExecution(liteJobConfig.isMonitorExecution(), shardingItems);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">if</span> (shardingItems.isEmpty()) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(buildTaskId(liteJobConfig, shardingItems), liteJobConfig.getJobName(), liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(), </div><div class="line">               liteJobConfig.getTypeConfig().getCoreConfig().getJobParameter(), Collections.&lt;Integer, String&gt;emptyMap());</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 解析分片参数</span></div><div class="line">   Map&lt;Integer, String&gt; shardingItemParameterMap = <span class="keyword">new</span> ShardingItemParameters(liteJobConfig.getTypeConfig().getCoreConfig().getShardingItemParameters()).getMap();</div><div class="line">   <span class="comment">// 创建 分片上下文集合</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ShardingContexts(buildTaskId(liteJobConfig, shardingItems), <span class="comment">//</span></div><div class="line">           liteJobConfig.getJobName(), liteJobConfig.getTypeConfig().getCoreConfig().getShardingTotalCount(),</div><div class="line">           liteJobConfig.getTypeConfig().getCoreConfig().getJobParameter(),</div><div class="line">           getAssignedShardingItemParameterMap(shardingItems, shardingItemParameterMap)); <span class="comment">// 获得当前作业节点的分片参数</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>调用 <code>#removeRunningIfMonitorExecution()</code> 方法，移除正在运行中的作业分片项。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeRunningIfMonitorExecution</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> monitorExecution, <span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!monitorExecution) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   List&lt;Integer&gt; runningShardingItems = <span class="keyword">new</span> ArrayList&lt;&gt;(shardingItems.size());</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">       <span class="keyword">if</span> (isRunning(each)) &#123;</div><div class="line">           runningShardingItems.add(each); <span class="comment">// /$&#123;JOB_NAME&#125;/sharding/$&#123;ITEM_ID&#125;/running</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   shardingItems.removeAll(runningShardingItems);</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> shardingItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> jobNodeStorage.isJobNodeExisted(ShardingNode.getRunningNode(shardingItem));</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>使用 ShardingItemParameters 解析作业分片参数。例如作业分片参数( <code>JobCoreConfiguration.shardingItemParameters=&quot;0=Beijing,1=Shanghai,2=Guangzhou&quot;</code> ) 解析结果：<br><img src="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/04.png" alt=""></p><ul><li>ShardingItemParameters 代码清晰易懂，点击<a href="https://github.com/dangdangdotcom/elastic-job/blob/fd45d3799565f69c6b604db83f78629d8c9a70cd/elastic-job-common/elastic-job-common-core/src/main/java/com/dangdang/ddframe/job/util/config/ShardingItemParameters.java" rel="external nofollow noopener noreferrer" target="_blank">链接</a>直接查看。</li></ul></li><li><p>调用 <code>#buildTaskId(...)</code> 方法，创建作业任务ID( <code>ShardingContexts.taskId</code> )：</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">buildTaskId</span><span class="params">(<span class="keyword">final</span> LiteJobConfiguration liteJobConfig, <span class="keyword">final</span> List&lt;Integer&gt; shardingItems)</span> </span>&#123;</div><div class="line">   JobInstance jobInstance = JobRegistry.getInstance().getJobInstance(jobName);</div><div class="line">   <span class="keyword">return</span> Joiner.on(<span class="string">"@-@"</span>).join(liteJobConfig.getJobName(), Joiner.on(<span class="string">","</span>).join(shardingItems), <span class="string">"READY"</span>, </div><div class="line">           <span class="keyword">null</span> == jobInstance.getJobInstanceId() ? <span class="string">"127.0.0.1@-@1"</span> : jobInstance.getJobInstanceId()); </div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>taskId</code> = <code>${JOB_NAME}</code> + <code>@-@</code> + <code>${SHARDING_ITEMS}</code> + <code>@-@</code> + <code>READY</code> + <code>@-@</code> + <code>${IP}</code> + <code>@-@</code> + <code>${PID}</code>。例如：<code>javaSimpleJob@-@0,1,2@-@READY@-@192.168.3.2@-@38330</code>。</li></ul></li><li><p>调用 <code>#getAssignedShardingItemParameterMap(...)</code> 方法，获得当前作业节点的分片参数。</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> Map&lt;Integer, String&gt; <span class="title">getAssignedShardingItemParameterMap</span><span class="params">(<span class="keyword">final</span> List&lt;Integer&gt; shardingItems, <span class="keyword">final</span> Map&lt;Integer, String&gt; shardingItemParameterMap)</span> </span>&#123;</div><div class="line">       Map&lt;Integer, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(shardingItemParameterMap.size(), <span class="number">1</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> each : shardingItems) &#123;</div><div class="line">           result.put(each, shardingItemParameterMap.get(each));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    ```    </div><div class="line"></div><div class="line">* ShardingContexts，分片上下文集合。</div><div class="line">    ```Java</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingContexts</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4585977349142082152L</span>;</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 作业任务ID.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String taskId;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 作业名称.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String jobName;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 分片总数.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 作业自定义参数.</span></div><div class="line"><span class="comment">         * 可以配置多个相同的作业, 但是用不同的参数作为不同的调度实例.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String jobParameter;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 分配于本作业实例的分片项和参数的Map.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; shardingItemParameters;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 作业事件采样统计数.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> jobEventSamplingCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 当前作业事件采样统计数.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="meta">@Setter</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currentJobEventSamplingCount;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 是否允许可以发送作业事件.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="meta">@Setter</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> allowSendJobEvent = <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><ul><li><code>jobEventSamplingCount</code>，<code>currentJobEventSamplingCount</code> 在 Elastic-Job-Lite 暂未还使用，在 Elastic-Job-Cloud 使用。</li></ul></li></ul><h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>旁白君：小伙伴，更新了干货嘛，双击 666。<br>芋道君：那必须的嘛，而且这么勤快更新！是不是应该分享一波朋友圈。</p><p><img src="http://www.iocoder.cn/images/Elastic-Job/2017_10_31/05.png" alt=""></p><p>道友，赶紧上车，分享一波朋友圈！</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Elastic-Job-Lite/">Elastic-Job-Lite</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Elastic-Job/job-sharding/" data-title="Elastic-Job-Lite 源码分析 —— 作业分片 | 芋道源码 —— 纯源码解析BLOG" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Elastic-Job/job-failover/" title="Elastic-Job-Lite 源码分析 —— 作业失效转移"><strong>PREVIOUS:</strong><br><span>Elastic-Job-Lite 源码分析 —— 作业失效转移</span></a></div><div class="next"><a href="/Elastic-Job/job-sharding-strategy/" title="Elastic-Job-Lite 源码分析 —— 作业分片策略"><strong>NEXT:</strong><br><span>Elastic-Job-Lite 源码分析 —— 作业分片策略</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div><div id="toc" class="toc-aside"><strong class="toc-title">文章目录</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-作业分片条件"><span class="toc-number">2.</span> <span class="toc-text">2. 作业分片条件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-分配作业分片项"><span class="toc-number">3.</span> <span class="toc-text">3. 分配作业分片项</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-获取作业分片上下文集合"><span class="toc-number">4.</span> <span class="toc-text">4. 获取作业分片上下文集合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-彩蛋"><span class="toc-number">5.</span> <span class="toc-text">666. 彩蛋</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">微信公众号福利：芋道源码</p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. 阅读源码葵花宝典</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC 详细中文注释源码</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. 您对于源码的疑问每条留言都将得到认真回复</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. 新的源码解析文章实时收到通知，每周六十点更新</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. 认真的源码交流微信群</a></li></ul></div><div class="categorieslist"><p class="asidetitle">分类</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>25</sup></a></li><li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li><li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li><li><a href="/categories/工作内推/" title="工作内推">工作内推<sup>4</sup></a></li><li><a href="/categories/技术杂文/" title="技术杂文">技术杂文<sup>5</sup></a></li><li><a href="/categories/芋道源码的周天/" title="芋道源码的周天">芋道源码的周天<sup>1</sup></a></li></ul></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">© 2018 <a href="http://www.iocoder.cn" target="_blank" title="芋道源码">芋道源码</a> && <span style="display:inline" id="busuanzi_container_site_uv">总访客数 <span id="busuanzi_value_site_uv" font="微软雅黑"></span> 次</span> && <span style="display:inline" id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv" font="微软雅黑"></span> 次</span></p></div><div class="copyright">沪ICP备17037075号-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>