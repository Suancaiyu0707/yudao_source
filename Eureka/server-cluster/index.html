<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Eureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/server-cluster/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬

1. æ¦‚è¿°
2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°
2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨
2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
2.3 é›†ç¾¤èŠ‚ç‚¹"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Eureka/server-cluster/" title="Eureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥" itemprop="url">Eureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/server-cluster/">http://www.iocoder.cn/Eureka/server-cluster/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</a><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">2.3 é›†ç¾¤èŠ‚ç‚¹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4. åŒæ­¥æ³¨å†Œä¿¡æ¯</a><ul><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.1 åŒæ­¥æ“ä½œç±»å‹</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</a></li><li><a href="http://www.iocoder.cn/Eureka/server-cluster/">4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</a></li></ul></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server é›†ç¾¤åŒæ­¥æ³¨å†Œä¿¡æ¯</strong>ã€‚</p><p>Eureka-Server é›†ç¾¤å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/01.png" alt=""></p><ul><li>Eureka-Server é›†ç¾¤ä¸åŒºåˆ†<strong>ä¸»ä»èŠ‚ç‚¹</strong>æˆ–è€… <strong>Primary &amp; Secondary èŠ‚ç‚¹</strong>ï¼Œæ‰€æœ‰èŠ‚ç‚¹<strong>ç›¸åŒè§’è‰²( ä¹Ÿå°±æ˜¯æ²¡æœ‰è§’è‰² )ï¼Œå®Œå…¨å¯¹ç­‰</strong>ã€‚</li><li>Eureka-Client å¯ä»¥å‘<strong>ä»»æ„</strong> Eureka-Client å‘èµ·ä»»æ„<strong>è¯»å†™</strong>æ“ä½œï¼ŒEureka-Server å°†æ“ä½œå¤åˆ¶åˆ°å¦å¤–çš„ Eureka-Server ä»¥è¾¾åˆ°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚æ³¨æ„ï¼ŒEureka-Server æ˜¯é€‰æ‹©äº† AP çš„ç»„ä»¶ã€‚</li></ul><p>Eureka-Server å¯ä»¥ä½¿ç”¨ç›´æ¥é…ç½®æ‰€æœ‰èŠ‚ç‚¹çš„æœåŠ¡åœ°å€ï¼Œæˆ–è€…åŸºäº DNS é…ç½®ã€‚æ¨èé˜…è¯»ï¼š<a href="http://blog.didispace.com/springcloud6/?from=http://www.iocoder.cn" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudæ„å»ºå¾®æœåŠ¡æ¶æ„ï¼ˆå…­ï¼‰é«˜å¯ç”¨æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‹</a> ã€‚</p><p>æœ¬æ–‡ä¸»è¦ç±»åœ¨ <code>com.netflix.eureka.cluster</code> åŒ…ä¸‹ã€‚</p><p>OKï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„é¨æ¸¸åœ¨ä»£ç çš„æµ·æ´‹ã€‚</p><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><p>ps ï¼š<strong>æ³¨æ„</strong>ï¼Œæœ¬æ–‡æåˆ°çš„<strong>åŒæ­¥</strong>ï¼Œå‡†ç¡®æ¥è¯´æ˜¯<strong>å¤åˆ¶( Replication )</strong>ã€‚</p><h1 id="2-é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°"><a href="#2-é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°" class="headerlink" title="2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°"></a>2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</h1><p><code>com.netflix.eureka.cluster.PeerEurekaNodes</code> ï¼ŒEureka-Server é›†ç¾¤èŠ‚ç‚¹é›†åˆ ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeerEurekaNodes</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(PeerEurekaNodes.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹æ³¨å†Œè¡¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaServerConfig serverConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Client é…ç½®</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> EurekaClientConfig clientConfig;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server ç¼–è§£ç </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ServerCodecs serverCodecs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åº”ç”¨å®ä¾‹ä¿¡æ¯ç®¡ç†å™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server é›†ç¾¤èŠ‚ç‚¹æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;PeerEurekaNode&gt; peerEurekaNodes = Collections.emptyList();</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Eureka-Server æœåŠ¡åœ°å€æ•°ç»„</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Set&lt;String&gt; peerEurekaNodeUrls = Collections.emptySet();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ScheduledExecutorService taskExecutor;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PeerEurekaNodes</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">            PeerAwareInstanceRegistry registry,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaServerConfig serverConfig,</span></span></div><div class="line"><span class="function"><span class="params">            EurekaClientConfig clientConfig,</span></span></div><div class="line"><span class="function"><span class="params">            ServerCodecs serverCodecs,</span></span></div><div class="line"><span class="function"><span class="params">            ApplicationInfoManager applicationInfoManager)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.registry = registry;</div><div class="line">        <span class="keyword">this</span>.serverConfig = serverConfig;</div><div class="line">        <span class="keyword">this</span>.clientConfig = clientConfig;</div><div class="line">        <span class="keyword">this</span>.serverCodecs = serverCodecs;</div><div class="line">        <span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>peerEurekaNodes</code>, <code>peerEurekaNodeUrls</code>, <code>taskExecutor</code> å±æ€§ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­<strong>æœªè®¾ç½®å’Œåˆå§‹åŒ–</strong>ï¼Œè€Œæ˜¯åœ¨ <code>PeerEurekaNodes#start()</code> æ–¹æ³•ï¼Œè®¾ç½®å’Œåˆå§‹åŒ–ï¼Œä¸‹æ–‡æˆ‘ä»¬ä¼šè§£æè¿™ä¸ªæ–¹æ³•ã€‚</li><li>Eureka-Server åœ¨åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>EurekaBootStrap#getPeerEurekaNodes(...)</code> æ–¹æ³•ï¼Œåˆ›å»º PeerEurekaNodes ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/EurekaBootStrap.java#L245" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ã€‚</li></ul><h2 id="2-1-é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨"><a href="#2-1-é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨" class="headerlink" title="2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨"></a>2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</h2><p>è°ƒç”¨ <code>PeerEurekaNodes#start()</code> æ–¹æ³•ï¼Œé›†ç¾¤èŠ‚ç‚¹å¯åŠ¨ï¼Œä¸»è¦å®Œæˆä¸¤ä¸ªé€»è¾‘ï¼š</p><ul><li>åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</li><li>åˆå§‹åŒ–å›ºå®šå‘¨æœŸ( é»˜è®¤ï¼š10 åˆ†é’Ÿï¼Œå¯é…ç½® )æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯çš„ä»»åŠ¡</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»º å®šæ—¶ä»»åŠ¡æœåŠ¡</span></div><div class="line"> <span class="number">3</span>:     taskExecutor = Executors.newSingleThreadScheduledExecutor(</div><div class="line"> <span class="number">4</span>:             <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line"> <span class="number">5</span>:                 <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:                 <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:                     Thread thread = <span class="keyword">new</span> Thread(r, <span class="string">"Eureka-PeerNodesUpdater"</span>);</div><div class="line"> <span class="number">8</span>:                     thread.setDaemon(<span class="keyword">true</span>);</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> thread;</div><div class="line"><span class="number">10</span>:                 &#125;</div><div class="line"><span class="number">11</span>:             &#125;</div><div class="line"><span class="number">12</span>:     );</div><div class="line"><span class="number">13</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>:         <span class="comment">// åˆå§‹åŒ– é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line"><span class="number">15</span>:         updatePeerEurekaNodes(resolvePeerUrls());</div><div class="line"><span class="number">16</span>:         <span class="comment">// åˆå§‹åŒ– åˆå§‹åŒ–å›ºå®šå‘¨æœŸæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯çš„ä»»åŠ¡</span></div><div class="line"><span class="number">17</span>:         Runnable peersUpdateTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">18</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">19</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">20</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">21</span>:                     updatePeerEurekaNodes(resolvePeerUrls());</div><div class="line"><span class="number">22</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:                     logger.error(<span class="string">"Cannot update the replica Nodes"</span>, e);</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:         &#125;;</div><div class="line"><span class="number">28</span>:         taskExecutor.scheduleWithFixedDelay(</div><div class="line"><span class="number">29</span>:                 peersUpdateTask,</div><div class="line"><span class="number">30</span>:                 serverConfig.getPeerEurekaNodesUpdateIntervalMs(),</div><div class="line"><span class="number">31</span>:                 serverConfig.getPeerEurekaNodesUpdateIntervalMs(),</div><div class="line"><span class="number">32</span>:                 TimeUnit.MILLISECONDS</div><div class="line"><span class="number">33</span>:         );</div><div class="line"><span class="number">34</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">35</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>:     <span class="comment">// æ‰“å° é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">for</span> (PeerEurekaNode node : peerEurekaNodes) &#123;</div><div class="line"><span class="number">39</span>:         logger.info(<span class="string">"Replica node URL:  "</span> + node.getServiceUrl());</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 15 è¡Œ &amp;&amp; ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#updatePeerEurekaNodes()</code> æ–¹æ³•ï¼Œæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ã€‚</li></ul><h2 id="2-2-æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯"><a href="#2-2-æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯" class="headerlink" title="2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯"></a>2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</h2><p>è°ƒç”¨ <code>#resolvePeerUrls()</code> æ–¹æ³•ï¼Œè·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">resolvePeerUrls</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„</span></div><div class="line"> <span class="number">3</span>:     InstanceInfo myInfo = applicationInfoManager.getInfo();</div><div class="line"> <span class="number">4</span>:     String zone = InstanceInfo.getZone(clientConfig.getAvailabilityZones(clientConfig.getRegion()), myInfo);</div><div class="line"> <span class="number">5</span>:     List&lt;String&gt; replicaUrls = EndpointUtils.getDiscoveryServiceUrls(clientConfig, zone, <span class="keyword">new</span> EndpointUtils.InstanceInfoBasedUrlRandomizer(myInfo));</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// ç§»é™¤è‡ªå·±ï¼ˆé¿å…å‘è‡ªå·±åŒæ­¥ï¼‰</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">while</span> (idx &lt; replicaUrls.size()) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (isThisMyUrl(replicaUrls.get(idx))) &#123;</div><div class="line"><span class="number">11</span>:             replicaUrls.remove(idx);</div><div class="line"><span class="number">12</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:             idx++;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>:     <span class="keyword">return</span> replicaUrls;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 2 è‡³ 5 è¡Œ ï¼šè·å¾— Eureka-Server é›†ç¾¤æœåŠ¡åœ°å€æ•°ç»„ã€‚<code>EndpointUtils#getDiscoveryServiceUrls(...)</code> æ–¹æ³•ï¼Œé€»è¾‘ä¸ <a href="http://www.iocoder.cn/Eureka/end-point-and-resolver/?self">ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹ã€Œ3.4 ConfigClusterResolverã€</a> åŸºæœ¬ç±»ä¼¼ã€‚EndpointUtils æ­£åœ¨é€æ­¥ï¼ŒçŒœæµ‹æœªæ¥è¿™é‡Œä¼šæ›¿æ¢ã€‚</li><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šç§»é™¤è‡ªèº«èŠ‚ç‚¹ï¼Œé¿å…å‘è‡ªå·±åŒæ­¥ã€‚</li></ul><hr><p>è°ƒç”¨ <code>#updatePeerEurekaNodes()</code> æ–¹æ³•ï¼Œæ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸»è¦å®Œæˆä¸¤éƒ¨åˆ†é€»è¾‘ï¼š</p><ul><li>æ·»åŠ æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹</li><li>å…³é—­åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updatePeerEurekaNodes</span><span class="params">(List&lt;String&gt; newPeerUrls)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (newPeerUrls.isEmpty()) &#123;</div><div class="line"> <span class="number">3</span>:         logger.warn(<span class="string">"The replica size seems to be empty. Check the route 53 DNS Registry"</span>);</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// è®¡ç®— æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></div><div class="line"> <span class="number">8</span>:     Set&lt;String&gt; toShutdown = <span class="keyword">new</span> HashSet&lt;&gt;(peerEurekaNodeUrls);</div><div class="line"> <span class="number">9</span>:     toShutdown.removeAll(newPeerUrls);</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:     <span class="comment">// è®¡ç®— åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€</span></div><div class="line"><span class="number">12</span>:     Set&lt;String&gt; toAdd = <span class="keyword">new</span> HashSet&lt;&gt;(newPeerUrls);</div><div class="line"><span class="number">13</span>:     toAdd.removeAll(peerEurekaNodeUrls);</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (toShutdown.isEmpty() &amp;&amp; toAdd.isEmpty()) &#123; <span class="comment">// No change</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">// å…³é—­åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹</span></div><div class="line"><span class="number">20</span>:     <span class="comment">// Remove peers no long available</span></div><div class="line"><span class="number">21</span>:     List&lt;PeerEurekaNode&gt; newNodeList = <span class="keyword">new</span> ArrayList&lt;&gt;(peerEurekaNodes);</div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (!toShutdown.isEmpty()) &#123;</div><div class="line"><span class="number">23</span>:         logger.info(<span class="string">"Removing no longer available peer nodes &#123;&#125;"</span>, toShutdown);</div><div class="line"><span class="number">24</span>:         <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"><span class="number">25</span>:         <span class="keyword">while</span> (i &lt; newNodeList.size()) &#123;</div><div class="line"><span class="number">26</span>:             PeerEurekaNode eurekaNode = newNodeList.get(i);</div><div class="line"><span class="number">27</span>:             <span class="keyword">if</span> (toShutdown.contains(eurekaNode.getServiceUrl())) &#123;</div><div class="line"><span class="number">28</span>:                 newNodeList.remove(i);</div><div class="line"><span class="number">29</span>:                 eurekaNode.shutDown(); <span class="comment">// å…³é—­</span></div><div class="line"><span class="number">30</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                 i++;</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="comment">// æ·»åŠ æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹</span></div><div class="line"><span class="number">37</span>:     <span class="comment">// Add new peers</span></div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (!toAdd.isEmpty()) &#123;</div><div class="line"><span class="number">39</span>:         logger.info(<span class="string">"Adding new peer nodes &#123;&#125;"</span>, toAdd);</div><div class="line"><span class="number">40</span>:         <span class="keyword">for</span> (String peerUrl : toAdd) &#123;</div><div class="line"><span class="number">41</span>:             newNodeList.add(createPeerEurekaNode(peerUrl));</div><div class="line"><span class="number">42</span>:         &#125;</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// èµ‹å€¼</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">this</span>.peerEurekaNodes = newNodeList;</div><div class="line"><span class="number">47</span>:     <span class="keyword">this</span>.peerEurekaNodeUrls = <span class="keyword">new</span> HashSet&lt;&gt;(newPeerUrls);</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 7 è‡³ 9 è¡Œ ï¼š<strong>è®¡ç®—</strong>æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€ã€‚</li><li>ç¬¬ 11 è‡³ 13 è¡Œ ï¼š<strong>è®¡ç®—</strong>åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹åœ°å€ã€‚</li><li>ç¬¬ 19 è‡³ 34 è¡Œ ï¼š<strong>å…³é—­</strong>åˆ é™¤çš„é›†ç¾¤èŠ‚ç‚¹ã€‚</li><li><p>ç¬¬ 36 è‡³ 43 è¡Œ ï¼š<strong>æ·»åŠ </strong>æ–°å¢çš„é›†ç¾¤èŠ‚ç‚¹ã€‚è°ƒç”¨ <code>#createPeerEurekaNode(peerUrl)</code> æ–¹æ³•ï¼Œåˆ›å»ºé›†ç¾¤èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">protected</span> PeerEurekaNode <span class="title">createPeerEurekaNode</span><span class="params">(String peerEurekaNodeUrl)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     HttpReplicationClient replicationClient = JerseyReplicationClient.createReplicationClient(serverConfig, serverCodecs, peerEurekaNodeUrl);</div><div class="line"><span class="number">3</span>:     String targetHost = hostFromUrl(peerEurekaNodeUrl);</div><div class="line"><span class="number">4</span>:     <span class="keyword">if</span> (targetHost == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">5</span>:         targetHost = <span class="string">"host"</span>;</div><div class="line"><span class="number">6</span>:     &#125;</div><div class="line"><span class="number">7</span>:     <span class="keyword">return</span> <span class="keyword">new</span> PeerEurekaNode(registry, targetHost, peerEurekaNodeUrl, replicationClient, serverConfig);</div><div class="line"><span class="number">8</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 2 è¡Œ ï¼šåˆ›å»º Eureka-Server é›†ç¾¤é€šä¿¡å®¢æˆ·ç«¯ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/transport/?self">ã€ŠEureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡ã€‹ã€Œ4.2 JerseyReplicationClientã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 7 è¡Œ ï¼šåˆ›å»º PeerEurekaNode ï¼Œåœ¨ <a href="#">ã€Œ2.3 PeerEurekaNodeã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><h2 id="2-3-é›†ç¾¤èŠ‚ç‚¹"><a href="#2-3-é›†ç¾¤èŠ‚ç‚¹" class="headerlink" title="2.3 é›†ç¾¤èŠ‚ç‚¹"></a>2.3 é›†ç¾¤èŠ‚ç‚¹</h2><p><code>com.netflix.eureka.cluster.PeerEurekaNode</code> ï¼Œå•ä¸ªé›†ç¾¤èŠ‚ç‚¹ã€‚</p><p>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/fcc9027a197783a23e7cb72ad0f617b7dc63d221/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L111" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹<strong>æ„é€ æ–¹æ³•</strong></p><ul><li>ç¬¬ 129 è¡Œ ï¼šåˆ›å»º ReplicationTaskProcessor ã€‚åœ¨ <a href="#">ã€Œ4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨ã€</a> è¯¦ç»†è§£æ</li><li>ç¬¬ 131 è‡³ 140 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡ä»»åŠ¡</strong>åˆ†å‘å™¨ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 142 è‡³ 151 è¡Œ ï¼šåˆ›å»º<strong>å•ä»»åŠ¡</strong>åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( <code>Autoscaling Group</code> ) åŒæ­¥çŠ¶æ€ã€‚æš‚æ—¶è·³è¿‡ã€‚</li></ul><h1 id="3-è·å–åˆå§‹æ³¨å†Œä¿¡æ¯"><a href="#3-è·å–åˆå§‹æ³¨å†Œä¿¡æ¯" class="headerlink" title="3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯"></a>3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</h1><p>Eureka-Server å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>PeerAwareInstanceRegistryImpl#syncUp()</code> æ–¹æ³•ï¼Œä»é›†ç¾¤çš„ä¸€ä¸ª Eureka-Server èŠ‚ç‚¹è·å–<strong>åˆå§‹</strong>æ³¨å†Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">syncUp</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// Copy entire entry from neighboring DS node</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ((i &lt; serverConfig.getRegistrySyncRetries()) &amp;&amp; (count == <span class="number">0</span>)); i++) &#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// æœªè¯»å–åˆ°æ³¨å†Œä¿¡æ¯ï¼Œsleep ç­‰å¾…</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">10</span>:                 Thread.sleep(serverConfig.getRegistrySyncRetryWaitMs());</div><div class="line"><span class="number">11</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Interrupted during registry transfer.."</span>);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:         <span class="comment">// è·å–æ³¨å†Œä¿¡æ¯</span></div><div class="line"><span class="number">18</span>:         Applications apps = eurekaClient.getApplications();</div><div class="line"><span class="number">19</span>:         <span class="keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;</div><div class="line"><span class="number">20</span>:             <span class="keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (isRegisterable(instance)) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ³¨å†Œ</span></div><div class="line"><span class="number">23</span>:                         register(instance, instance.getLeaseInfo().getDurationInSecs(), <span class="keyword">true</span>); <span class="comment">// æ³¨å†Œ</span></div><div class="line"><span class="number">24</span>:                         count++;</div><div class="line"><span class="number">25</span>:                     &#125;</div><div class="line"><span class="number">26</span>:                 &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">27</span>:                     logger.error(<span class="string">"During DS init copy"</span>, t);</div><div class="line"><span class="number">28</span>:                 &#125;</div><div class="line"><span class="number">29</span>:             &#125;</div><div class="line"><span class="number">30</span>:         &#125;</div><div class="line"><span class="number">31</span>:     &#125;</div><div class="line"><span class="number">32</span>:     <span class="keyword">return</span> count;</div><div class="line"><span class="number">33</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šæœªè·å–åˆ°æ³¨å†Œä¿¡æ¯ï¼Œ<code>sleep</code> ç­‰å¾…å†æ¬¡é‡è¯•ã€‚</li><li>ç¬¬ 17 è‡³ 30 è¡Œ ï¼šè·å–æ³¨å†Œä¿¡æ¯ï¼Œè‹¥è·å–åˆ°ï¼Œæ³¨å†Œåˆ°è‡ªèº«èŠ‚ç‚¹ã€‚<ul><li>ç¬¬ 22 è¡Œ ï¼šåˆ¤æ–­åº”ç”¨å®ä¾‹æ˜¯å¦èƒ½å¤Ÿæ³¨å†Œåˆ°è‡ªèº«èŠ‚ç‚¹ã€‚ä¸»è¦ç”¨äºäºšé©¬é€Š AWS ç¯å¢ƒä¸‹çš„åˆ¤æ–­ï¼Œè‹¥ééƒ¨ç½²åœ¨äºšé©¬é€Šé‡Œï¼Œéƒ½è¿”å› <code>true</code> ã€‚ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/registry/PeerAwareInstanceRegistryImpl.java#L593" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#register()</code> æ–¹æ³•ï¼Œæ³¨å†Œåº”ç”¨å®ä¾‹åˆ°è‡ªèº«èŠ‚ç‚¹ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul></li></ul><hr><p>è‹¥è°ƒç”¨ <code>#syncUp()</code> æ–¹æ³•ï¼Œæœªè·å–åˆ°åº”ç”¨å®ä¾‹ï¼Œåˆ™ Eureka-Server ä¼šæœ‰ä¸€æ®µæ—¶é—´( é»˜è®¤ï¼š5 åˆ†é’Ÿï¼Œå¯é… )ä¸å…è®¸è¢« Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œé¿å…å½±å“ Eureka-Client ã€‚</p><ul><li><p>æ ‡è®° Eureka-Server å¯åŠ¨æ—¶ï¼Œæœªè·å–åˆ°åº”ç”¨å®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> peerInstancesTransferEmptyOnStartup = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openForTraffic</span><span class="params">(ApplicationInfoManager applicationInfoManager, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.peerInstancesTransferEmptyOnStartup = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><ul><li><p>åˆ¤æ–­ Eureka-Server æ˜¯å¦å…è®¸è¢« Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldAllowAccess</span><span class="params">(<span class="keyword">boolean</span> remoteRegionRequired)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.peerInstancesTransferEmptyOnStartup) &#123;</div><div class="line">       <span class="comment">// è®¾ç½®å¯åŠ¨æ—¶é—´</span></div><div class="line">       <span class="keyword">this</span>.startupTime = System.currentTimeMillis();</div><div class="line">       <span class="keyword">if</span> (!(System.currentTimeMillis() &gt; <span class="keyword">this</span>.startupTime + serverConfig.getWaitTimeInMsWhenSyncEmpty())) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ul><h1 id="4-åŒæ­¥æ³¨å†Œä¿¡æ¯"><a href="#4-åŒæ­¥æ³¨å†Œä¿¡æ¯" class="headerlink" title="4. åŒæ­¥æ³¨å†Œä¿¡æ¯"></a>4. åŒæ­¥æ³¨å†Œä¿¡æ¯</h1><p>Eureka-Server é›†ç¾¤åŒæ­¥æ³¨å†Œä¿¡æ¯å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/02.png" alt=""></p><ul><li>Eureka-Server æ¥æ”¶åˆ° Eureka-Client çš„ Registerã€Heartbeatã€Cancelã€StatusUpdateã€DeleteStatusOverride æ“ä½œï¼Œå›ºå®šé—´éš”( é»˜è®¤å€¼ ï¼š500 æ¯«ç§’ï¼Œå¯é… )å‘ Eureka-Server é›†ç¾¤å†…å…¶ä»–èŠ‚ç‚¹åŒæ­¥( <strong>å‡†å®æ—¶ï¼Œéå®æ—¶</strong> )ã€‚</li></ul><h2 id="4-1-åŒæ­¥æ“ä½œç±»å‹"><a href="#4-1-åŒæ­¥æ“ä½œç±»å‹" class="headerlink" title="4.1 åŒæ­¥æ“ä½œç±»å‹"></a>4.1 åŒæ­¥æ“ä½œç±»å‹</h2><p><code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl.Action</code> ï¼ŒåŒæ­¥æ“ä½œç±»å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Action &#123;</div><div class="line">   Heartbeat, Register, Cancel, StatusUpdate, DeleteStatusOverride;</div><div class="line"></div><div class="line">   <span class="comment">// ... çœç•¥ç›‘æ§ç›¸å…³å±æ€§</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>Register ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-register/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸€ï¼‰ä¹‹æ³¨å†Œã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>Heartbeat ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-renew/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäºŒï¼‰ä¹‹ç»­ç§Ÿã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>Cancel ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-cancel/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸‰ï¼‰ä¹‹ä¸‹çº¿ã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>StatusUpdate ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æ</li><li>DeleteStatusOverride ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹</a> æœ‰è¯¦ç»†è§£æ</li></ul><h2 id="4-2-å‘èµ·-Eureka-Server-åŒæ­¥æ“ä½œ"><a href="#4-2-å‘èµ·-Eureka-Server-åŒæ­¥æ“ä½œ" class="headerlink" title="4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ"></a>4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</h2><p>Eureka-Server åœ¨å®Œæˆ Eureka-Client å‘èµ·çš„ä¸Šè¿°æ“ä½œåœ¨<strong>è‡ªèº«èŠ‚ç‚¹çš„æ‰§è¡Œå</strong>ï¼Œå‘é›†ç¾¤å†…å…¶ä»– Eureka-Server å‘èµ·åŒæ­¥æ“ä½œã€‚ä»¥ Register æ“ä½œä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerAwareInstanceRegistryImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">   <span class="comment">// ç§Ÿçº¦è¿‡æœŸæ—¶é—´</span></div><div class="line">   <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</div><div class="line">   <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</div><div class="line">       leaseDuration = info.getLeaseInfo().getDurationInSecs();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// æ³¨å†Œåº”ç”¨å®ä¾‹ä¿¡æ¯</span></div><div class="line">   <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</div><div class="line">   <span class="comment">// Eureka-Server å¤åˆ¶</span></div><div class="line">   replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>æœ€åä¸€è¡Œï¼Œè°ƒç”¨ <code>#replicateToPeers(...)</code> æ–¹æ³•ï¼Œä¼ é€’<strong>å¯¹åº”çš„åŒæ­¥æ“ä½œç±»å‹</strong>ï¼Œå‘èµ·åŒæ­¥æ“ä½œã€‚</li></ul><hr><p><code>#replicateToPeers(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">2</span>:                               InstanceInfo info <span class="comment">/* optional */</span>,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:                               InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     Stopwatch tracer = action.getTimer().start();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (isReplication) &#123;</div><div class="line"> <span class="number">7</span>:             numberOfReplicationsLastMin.increment();</div><div class="line"> <span class="number">8</span>:         &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:         <span class="comment">// Eureka-Server å‘èµ·çš„è¯·æ±‚ æˆ–è€… é›†ç¾¤ä¸ºç©º</span></div><div class="line"><span class="number">11</span>:         <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">14</span>:         &#125;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</div><div class="line"><span class="number">17</span>:             <span class="comment">// If the url represents this host, do not replicate to yourself.</span></div><div class="line"><span class="number">18</span>:             <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:             replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">24</span>:         tracer.stop();</div><div class="line"><span class="number">25</span>:     &#125;</div><div class="line"><span class="number">26</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 10 è‡³ 14 è¡Œ ï¼šEureka-Server åœ¨å¤„ç†ä¸Šè¿°æ“ä½œ( Action )ï¼Œæ— è®ºæ¥è‡ª Eureka-Client å‘èµ·è¯·æ±‚ï¼Œè¿˜æ˜¯ Eureka-Server å‘èµ·åŒæ­¥ï¼Œè°ƒç”¨çš„å†…éƒ¨æ–¹æ³•ç›¸åŒï¼Œé€šè¿‡ <code>isReplication=true</code> å‚æ•°ï¼Œé¿å…æ­»å¾ªç¯åŒæ­¥ã€‚</li><li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼š<strong>å¾ªç¯</strong>é›†ç¾¤å†…<strong>æ¯ä¸ª</strong>èŠ‚ç‚¹ï¼Œè°ƒç”¨ <code>#replicateInstanceActionsToPeers(...)</code> æ–¹æ³•ï¼Œå‘èµ·åŒæ­¥æ“ä½œã€‚</li></ul><hr><p><code>#replicateInstanceActionsToPeers(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateInstanceActionsToPeers</span><span class="params">(Action action, String appName,</span></span></div><div class="line"><span class="function"><span class="params">                                            String id, InstanceInfo info, InstanceStatus newStatus,</span></span></div><div class="line"><span class="function"><span class="params">                                            PeerEurekaNode node)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       InstanceInfo infoFromRegistry;</div><div class="line">       CurrentRequestVersion.set(Version.V2);</div><div class="line">       <span class="keyword">switch</span> (action) &#123;</div><div class="line">           <span class="keyword">case</span> Cancel:</div><div class="line">               node.cancel(appName, id);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Heartbeat:</div><div class="line">               InstanceStatus overriddenStatus = overriddenInstanceStatusMap.get(id);</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.heartbeat(appName, id, infoFromRegistry, overriddenStatus, <span class="keyword">false</span>);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> Register:</div><div class="line">               node.register(info);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> StatusUpdate:</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.statusUpdate(appName, id, newStatus, infoFromRegistry);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> DeleteStatusOverride:</div><div class="line">               infoFromRegistry = getInstanceByAppAndId(appName, id, <span class="keyword">false</span>);</div><div class="line">               node.deleteStatusOverride(appName, id, infoFromRegistry);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">       logger.error(<span class="string">"Cannot replicate information to &#123;&#125; for action &#123;&#125;"</span>, node.getServiceUrl(), action.name(), t);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>Cancel</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#cancel(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L157" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li><strong>Heartbeat</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#heartbeat(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L194" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li><strong>Register</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#register(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L134" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li><strong>StatusUpdate</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#statusUpdate(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L243" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li><strong>DeleteStatusOverride</strong> ï¼šè°ƒç”¨ <code>PeerEurekaNode#deleteStatusOverride(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L294" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹å®ç°ã€‚</li><li><p>ä¸Šé¢çš„æ¯ä¸ªæ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬<strong>éƒ½</strong>ä¼šçœ‹åˆ°ç±»ä¼¼è¿™ä¹ˆä¸€æ®µä»£ç  ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">batchingDispatcher.process(</div><div class="line">    taskId(<span class="string">"$&#123;action&#125;"</span>, appName, id), <span class="comment">// id</span></div><div class="line">    <span class="keyword">new</span> InstanceReplicationTask(targetHost, Action.Cancel, appName, id) &#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> replicationClient.doString(...);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">// do Something...</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;, <span class="comment">// ReplicationTask å­ç±»</span></div><div class="line">    expiryTime</div><div class="line">)</div></pre></td></tr></table></figure><ul><li><p><code>#task(...)</code> æ–¹æ³•ï¼Œç”ŸæˆåŒæ­¥æ“ä½œä»»åŠ¡<strong>ç¼–å·</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">taskId</span><span class="params">(String requestType, String appName, String id)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> requestType + <span class="string">'#'</span> + appName + <span class="string">'/'</span> + id;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><strong>ç›¸åŒåº”ç”¨å®ä¾‹çš„ç›¸åŒåŒæ­¥æ“ä½œä½¿ç”¨ç›¸åŒä»»åŠ¡ç¼–å·</strong>ã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ2. æ•´ä½“æµç¨‹ã€</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°â€ æ¥æ”¶çº¿ç¨‹( Runner )åˆå¹¶ä»»åŠ¡ï¼Œå°†ç›¸åŒä»»åŠ¡ç¼–å·çš„ä»»åŠ¡åˆå¹¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚ â€œï¼Œå› æ­¤ï¼Œç›¸åŒåº”ç”¨å®ä¾‹çš„ç›¸åŒåŒæ­¥æ“ä½œå°±èƒ½è¢«åˆå¹¶ï¼Œå‡å°‘æ“ä½œé‡ã€‚ä¾‹å¦‚ï¼ŒEureka-Server åŒæ­¥æŸä¸ªåº”ç”¨å®ä¾‹çš„ Heartbeat æ“ä½œï¼Œæ¥æ”¶åŒæ­¥çš„ Eureak-Server æŒ‚äº†ï¼Œä¸€æ–¹é¢è¿™ä¸ªåº”ç”¨çš„è¿™æ¬¡æ“ä½œä¼š<strong>é‡è¯•</strong>ï¼Œå¦ä¸€æ–¹é¢ï¼Œè¿™ä¸ªåº”ç”¨å®ä¾‹ä¼šå‘èµ·<strong>æ–°çš„</strong> Heartbeat æ“ä½œï¼Œé€šè¿‡ä»»åŠ¡ç¼–å·åˆå¹¶ï¼Œæ¥æ”¶åŒæ­¥çš„ Eureka-Server æ¢å¤åï¼Œå‡å°‘æ”¶åˆ°<strong>é‡å¤ç§¯å‹</strong>çš„ä»»åŠ¡ã€‚</li></ul><ul><li>InstanceReplicationTask ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡ï¼Œåœ¨ <a href="#">ã€Œ4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡ã€</a> è¯¦ç»†è§£æã€‚</li><li><code>expiryTime</code> ï¼Œä»»åŠ¡è¿‡æœŸæ—¶é—´ã€‚</li></ul></li></ul></li></ul><h3 id="4-1-1-åŒæ­¥æ“ä½œä»»åŠ¡"><a href="#4-1-1-åŒæ­¥æ“ä½œä»»åŠ¡" class="headerlink" title="4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡"></a>4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡</h3><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/03.png" alt=""></p><ul><li><code>com.netflix.eureka.cluster.ReplicationTask</code> ï¼ŒåŒæ­¥ä»»åŠ¡<strong>æŠ½è±¡ç±»</strong><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTask.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ ReplicationTask ä»£ç ã€‚</li><li>å®šä¹‰äº† <code>#getTaskName()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ã€‚</li><li>å®šä¹‰äº† <code>#execute()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€‚</li><li>å®ç°äº† <code>#handleSuccess()</code> æ–¹æ³•ï¼Œå¤„ç†æˆåŠŸæ‰§è¡ŒåŒæ­¥ç»“æœã€‚</li><li>å®ç°äº† <code>#handleFailure(...)</code> æ–¹æ³•ï¼Œå¤„ç†å¤±è´¥æ‰§è¡ŒåŒæ­¥ç»“æœã€‚</li></ul></li><li><code>com.netflix.eureka.cluster.InstanceReplicationTask</code> ï¼ŒåŒæ­¥åº”ç”¨å®ä¾‹ä»»åŠ¡<strong>æŠ½è±¡ç±»</strong><ul><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/InstanceReplicationTask.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ InstanceReplicationTask ä»£ç ã€‚</li><li>å®ç°äº†çˆ¶ç±» <code>#getTaskName()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ã€‚</li></ul></li><li><code>com.netflix.eureka.cluster.AsgReplicationTask</code> ï¼Œäºšé©¬é€Š AWS ä½¿ç”¨ï¼Œæš‚æ—¶è·³è¿‡ã€‚</li></ul><p>ä»ä¸Šé¢ <code>PeerEurekaNode#åŒæ­¥æ“ä½œ(...)</code> æ–¹æ³•ï¼Œ<strong>å…¨éƒ¨</strong>å®ç°äº† InstanceReplicationTask ç±»çš„ <code>#execute()</code> æ–¹æ³•ï¼Œ<strong>éƒ¨åˆ†</strong>é‡å†™äº† <code>#handleFailure(...)</code> æ–¹æ³•ã€‚</p><h3 id="4-1-2-åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨"><a href="#4-1-2-åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨" class="headerlink" title="4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨"></a>4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨</h3><p><code>com.netflix.eureka.cluster.InstanceReplicationTask</code> ï¼Œå®ç° TaskProcessor <strong>æ¥å£</strong>ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨ã€‚</p><ul><li>TaskProcessor ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ InstanceReplicationTask ä»£ç ã€‚</li></ul><p><code>ReplicationTaskProcessor#process(task)</code> ï¼Œ<strong>å¤„ç†å•ä»»åŠ¡</strong>ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( <code>Autoscaling Group</code> ) åŒæ­¥çŠ¶æ€ï¼Œæš‚æ—¶è·³è¿‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L38" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚</p><p><code>ReplicationTaskProcessor#process(tasks)</code> ï¼Œ<strong>å¤„ç†æ‰¹é‡ä»»åŠ¡</strong>ï¼Œç”¨äº Eureka-Server é›†ç¾¤æ³¨å†Œä¿¡æ¯çš„åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œé€šè¿‡è°ƒç”¨è¢«åŒæ­¥çš„ Eureka-Server çš„ <code>peerreplication/batch/</code> æ¥å£ï¼Œä¸€æ¬¡æ€§å°†æ‰¹é‡( å¤šä¸ª )çš„åŒæ­¥æ“ä½œä»»åŠ¡å‘èµ·è¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ProcessingResult <span class="title">process</span><span class="params">(List&lt;ReplicationTask&gt; tasks)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡</span></div><div class="line"> <span class="number">4</span>:     ReplicationList list = createReplicationListOf(tasks);</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å‘èµ· æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚</span></div><div class="line"> <span class="number">7</span>:         EurekaHttpResponse&lt;ReplicationListResponse&gt; response = replicationClient.submitBatchUpdates(list);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç† æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!isSuccess(statusCode)) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (statusCode == <span class="number">503</span>) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Server busy (503) HTTP status code received from the peer &#123;&#125;; rescheduling tasks after delay"</span>, peerId);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">return</span> ProcessingResult.Congestion;</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="comment">// Unexpected error returned from the server. This should ideally never happen.</span></div><div class="line"><span class="number">16</span>:                 logger.error(<span class="string">"Batch update failure with HTTP status code &#123;&#125;; discarding &#123;&#125; replication tasks"</span>, statusCode, tasks.size());</div><div class="line"><span class="number">17</span>:                 <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             handleBatchResponse(tasks, response.getEntity().getResponseList());</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:         <span class="keyword">if</span> (isNetworkConnectException(e)) &#123;</div><div class="line"><span class="number">24</span>:             logNetworkErrorSample(<span class="keyword">null</span>, e);</div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> ProcessingResult.TransientError;</div><div class="line"><span class="number">26</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:             logger.error(<span class="string">"Not re-trying this exception because it does not seem to be a network exception"</span>, e);</div><div class="line"><span class="number">28</span>:             <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> ProcessingResult.Success;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 4 è¡Œ ï¼šåˆ›å»ºæ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡( ReplicationList ) ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œå’±å°±ä¸å•°å—¦è´´ä»£ç äº†ã€‚<ul><li>ReplicationList ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationList.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li>ReplicationInstance ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationInstance.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li><code>#createReplicationListOf(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L142" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li><code>#createReplicationInstanceOf(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L173" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li></ul></li><li>ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ <code>JerseyReplicationClient#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œè¯·æ±‚ <code>peerreplication/batch/</code> æ¥å£ï¼Œä¸€æ¬¡æ€§å°†æ‰¹é‡( å¤šä¸ª )çš„åŒæ­¥æ“ä½œä»»åŠ¡å‘èµ·è¯·æ±‚ã€‚<ul><li><code>JerseyReplicationClient#submitBatchUpdates(...)</code> æ–¹æ³•ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/transport/JerseyReplicationClient.java#L109" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li>ReplicationListResponse ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationListResponse.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li><li>ReplicationInstanceResponse ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/protocol/ReplicationInstanceResponse.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ç±»ã€‚</li></ul></li><li>ç¬¬ 9 è‡³ 31 è¡Œ ï¼šå¤„ç†æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”ï¼Œåœ¨ <a href="#">ã€Œ4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœã€</a> è¯¦ç»†è§£æã€‚</li></ul><h2 id="4-3-æ¥æ”¶-Eureka-Server-åŒæ­¥æ“ä½œ"><a href="#4-3-æ¥æ”¶-Eureka-Server-åŒæ­¥æ“ä½œ" class="headerlink" title="4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ"></a>4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</h2><p><code>com.netflix.eureka.resources.PeerReplicationResource</code> ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡ Resource ( Controller )ã€‚</p><p><code>peerreplication/batch/</code> æ¥å£ï¼Œæ˜ å°„ <code>PeerReplicationResource#batchReplication(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Path</span>(<span class="string">"batch"</span>)</div><div class="line"> <span class="number">2</span>: <span class="meta">@POST</span></div><div class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> Response <span class="title">batchReplication</span><span class="params">(ReplicationList replicationList)</span> </span>&#123;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">5</span>:         ReplicationListResponse batchResponse = <span class="keyword">new</span> ReplicationListResponse();</div><div class="line"> <span class="number">6</span>:         <span class="comment">// é€ä¸ªåŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœ( ReplicationInstanceResponse ) åˆå¹¶åˆ° ReplicationListResponse ã€‚</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">for</span> (ReplicationInstance instanceInfo : replicationList.getReplicationList()) &#123;</div><div class="line"> <span class="number">8</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:                 batchResponse.addResponse(dispatch(instanceInfo));</div><div class="line"><span class="number">10</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">11</span>:                 batchResponse.addResponse(<span class="keyword">new</span> ReplicationInstanceResponse(Status.INTERNAL_SERVER_ERROR.getStatusCode(), <span class="keyword">null</span>));</div><div class="line"><span class="number">12</span>:                 logger.error(instanceInfo.getAction() + <span class="string">" request processing failed for batch item "</span></div><div class="line"><span class="number">13</span>:                         + instanceInfo.getAppName() + <span class="string">'/'</span> + instanceInfo.getId(), e);</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> Response.ok(batchResponse).build();</div><div class="line"><span class="number">17</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">18</span>:         logger.error(<span class="string">"Cannot execute batch Request"</span>, e);</div><div class="line"><span class="number">19</span>:         <span class="keyword">return</span> Response.status(Status.INTERNAL_SERVER_ERROR).build();</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="function"><span class="keyword">private</span> ReplicationInstanceResponse <span class="title">dispatch</span><span class="params">(ReplicationInstance instanceInfo)</span> </span>&#123;</div><div class="line"><span class="number">24</span>:     ApplicationResource applicationResource = createApplicationResource(instanceInfo);</div><div class="line"><span class="number">25</span>:     InstanceResource resource = createInstanceResource(instanceInfo, applicationResource);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:     String lastDirtyTimestamp = toString(instanceInfo.getLastDirtyTimestamp());</div><div class="line"><span class="number">28</span>:     String overriddenStatus = toString(instanceInfo.getOverriddenStatus());</div><div class="line"><span class="number">29</span>:     String instanceStatus = toString(instanceInfo.getStatus());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     Builder singleResponseBuilder = <span class="keyword">new</span> Builder();</div><div class="line"><span class="number">32</span>:     <span class="keyword">switch</span> (instanceInfo.getAction()) &#123;</div><div class="line"><span class="number">33</span>:         <span class="keyword">case</span> Register:</div><div class="line"><span class="number">34</span>:             singleResponseBuilder = handleRegister(instanceInfo, applicationResource);</div><div class="line"><span class="number">35</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> Heartbeat:</div><div class="line"><span class="number">37</span>:             singleResponseBuilder = handleHeartbeat(serverConfig, resource, lastDirtyTimestamp, overriddenStatus, instanceStatus);</div><div class="line"><span class="number">38</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">39</span>:         <span class="keyword">case</span> Cancel:</div><div class="line"><span class="number">40</span>:             singleResponseBuilder = handleCancel(resource);</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> StatusUpdate:</div><div class="line"><span class="number">43</span>:             singleResponseBuilder = handleStatusUpdate(instanceInfo, resource);</div><div class="line"><span class="number">44</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">45</span>:         <span class="keyword">case</span> DeleteStatusOverride:</div><div class="line"><span class="number">46</span>:             singleResponseBuilder = handleDeleteStatusOverride(instanceInfo, resource);</div><div class="line"><span class="number">47</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">48</span>:     &#125;</div><div class="line"><span class="number">49</span>:     <span class="keyword">return</span> singleResponseBuilder.build();</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 7 è‡³ 15 è¡Œ ï¼šé€ä¸ªå¤„ç†<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œå¹¶å°†å¤„ç†ç»“æœ( ReplicationInstanceResponse ) æ·»åŠ åˆ° ReplicationListResponse ã€‚</li><li>ç¬¬ 23 è‡³ 50 è¡Œ ï¼šå¤„ç†<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡ï¼Œè¿”å›å¤„ç†ç»“æœ( ReplicationInstanceResponse )ã€‚<ul><li>ç¬¬ 24 è‡³ 25 è¡Œ ï¼šåˆ›å»º ApplicationResource , InstanceResource ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…è¯¥æ–¹æ³•æ˜¯æŠŠ<strong>å•ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡æäº¤åˆ°å…¶ä»– Resource ( Controller ) å¤„ç†ï¼ŒEureka-Server æ”¶åˆ° Eureka-Client è¯·æ±‚å“åº”çš„ Resource ( Controller ) æ˜¯<strong>ç›¸åŒçš„é€»è¾‘</strong>ã€‚</li><li>Register ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L137" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleRegister(...)</code> æ–¹æ³•ã€‚</li><li>Heartbeat ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L147" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleHeartbeat(...)</code> æ–¹æ³•ã€‚</li><li>Cancel ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L142" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleCancel(...)</code> æ–¹æ³•ã€‚</li><li>StatusUpdate ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L165" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleStatusUpdate(...)</code> æ–¹æ³•ã€‚</li><li>DeleteStatusOverride ï¼šç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/PeerReplicationResource.java#L170" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹ <code>#handleDeleteStatusOverride(...)</code> æ–¹æ³•ã€‚</li></ul></li></ul><h2 id="4-4-å¤„ç†-Eureka-Server-åŒæ­¥ç»“æœ"><a href="#4-4-å¤„ç†-Eureka-Server-åŒæ­¥ç»“æœ" class="headerlink" title="4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ"></a>4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</h2><p>ğŸ˜ˆ æƒ³æƒ³å°±æœ‰å°æ¿€åŠ¨ï¼Œç»ˆäºå†™åˆ°è¿™é‡Œäº†ã€‚</p><p>æ¥ <code>ReplicationTaskProcessor#process(tasks)</code> æ–¹æ³•ï¼Œå¤„ç†æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ProcessingResult <span class="title">process</span><span class="params">(List&lt;ReplicationTask&gt; tasks)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚å¯¹è±¡</span></div><div class="line"> <span class="number">4</span>:     ReplicationList list = createReplicationListOf(tasks);</div><div class="line"> <span class="number">5</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:         <span class="comment">// å‘èµ· æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„è¯·æ±‚</span></div><div class="line"> <span class="number">7</span>:         EurekaHttpResponse&lt;ReplicationListResponse&gt; response = replicationClient.submitBatchUpdates(list);</div><div class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç† æ‰¹é‡æäº¤åŒæ­¥æ“ä½œä»»åŠ¡çš„å“åº”</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!isSuccess(statusCode)) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (statusCode == <span class="number">503</span>) &#123;</div><div class="line"><span class="number">12</span>:                 logger.warn(<span class="string">"Server busy (503) HTTP status code received from the peer &#123;&#125;; rescheduling tasks after delay"</span>, peerId);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">return</span> ProcessingResult.Congestion;</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="comment">// Unexpected error returned from the server. This should ideally never happen.</span></div><div class="line"><span class="number">16</span>:                 logger.error(<span class="string">"Batch update failure with HTTP status code &#123;&#125;; discarding &#123;&#125; replication tasks"</span>, statusCode, tasks.size());</div><div class="line"><span class="number">17</span>:                 <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">20</span>:             handleBatchResponse(tasks, response.getEntity().getResponseList());</div><div class="line"><span class="number">21</span>:         &#125;</div><div class="line"><span class="number">22</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">23</span>:         <span class="keyword">if</span> (isNetworkConnectException(e)) &#123;</div><div class="line"><span class="number">24</span>:             logNetworkErrorSample(<span class="keyword">null</span>, e);</div><div class="line"><span class="number">25</span>:             <span class="keyword">return</span> ProcessingResult.TransientError;</div><div class="line"><span class="number">26</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">27</span>:             logger.error(<span class="string">"Not re-trying this exception because it does not seem to be a network exception"</span>, e);</div><div class="line"><span class="number">28</span>:             <span class="keyword">return</span> ProcessingResult.PermanentError;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>:     <span class="keyword">return</span> ProcessingResult.Success;</div><div class="line"><span class="number">32</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 10 è¡Œ ï¼Œè°ƒç”¨ <code>#isSuccess(...)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå“åº”çŠ¶æ€ç æ˜¯å¦åœ¨ [200, 300) èŒƒå›´å†…ã€‚</li><li>ç¬¬ 11 è‡³ 13 è¡Œ ï¼šçŠ¶æ€ç  503 ï¼Œç›®å‰ Eureka-Server è¿”å› 503 çš„åŸå› æ˜¯è¢«é™æµã€‚åœ¨ <a href="http://www.iocoder.cn/Eureka/rate-limiter/?self">ã€ŠEureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiterã€‹</a> è¯¦ç»†è§£æã€‚<strong>è¯¥æƒ…å†µä¸ºç¬æ—¶é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 14 è‡³ 18 è¡Œ ï¼šé<strong>é¢„æœŸ</strong>çŠ¶æ€ç ï¼Œç›®å‰ Eureka-Server åœ¨ä»£ç ä¸Šçœ‹ä¸‹æ¥ï¼Œä¸ä¼šè¿”å›è¿™æ ·çš„çŠ¶æ€ç ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 20 è¡Œ ï¼šè¯·æ±‚æˆåŠŸï¼Œè°ƒç”¨ <code>#handleBatchResponse(...)</code> æ–¹æ³•ï¼Œé€ä¸ªå¤„ç†<strong>æ¯ä¸ª</strong> ReplicationTask å’Œ ReplicationInstanceResponse ã€‚<strong>è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸‹ï¼Œè¯·æ±‚æˆåŠŸæŒ‡çš„æ˜¯æ•´ä¸ªè¯·æ±‚æˆåŠŸï¼Œå®é™…æ¯ä¸ª ReplicationInstanceResponse å¯èƒ½è¿”å›çš„çŠ¶æ€ç ä¸åœ¨ [200, 300) èŒƒå›´å†…</strong>ã€‚è¯¥æ–¹æ³•ä¸‹æ–‡è¯¦ç»†è§£æã€‚</li><li><p>ç¬¬ 23 è‡³ 25 è¡Œ ï¼šè¯·æ±‚å‘ç”Ÿç½‘ç»œå¼‚å¸¸ï¼Œä¾‹å¦‚ç½‘ç»œè¶…æ—¶ï¼Œæ‰“å°ç½‘ç»œå¼‚å¸¸æ—¥å¿—ã€‚ç›®å‰æ—¥å¿—çš„æ‰“å°ä¸ºéƒ¨åˆ†é‡‡æ ·ï¼Œæ¡ä»¶ä¸ºç½‘ç»œå‘ç”Ÿå¼‚å¸¸æ¯é—´éš” 10 ç§’æ‰“å°ä¸€æ¡ï¼Œé¿å…ç½‘ç»œå‘ç”Ÿå¼‚å¸¸æ‰“å°è¶…çº§å¤§é‡çš„æ—¥å¿—ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p><ul><li><code>#isNetworkConnectException(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L163" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li><li><code>#logNetworkErrorSample(...)</code> ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java#L103" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</li></ul></li><li><p>ç¬¬ 26 è‡³ 29 è¡Œ ï¼šé<strong>é¢„æœŸ</strong>å¼‚å¸¸ï¼Œç›®å‰ Eureka-Server åœ¨ä»£ç ä¸Šçœ‹ä¸‹æ¥ï¼Œä¸ä¼šæŠ›å‡ºè¿™æ ·çš„å¼‚å¸¸ã€‚<strong>è¯¥æƒ…å†µä¸ºæ°¸ä¹…é”™è¯¯ï¼Œä¼šé‡è¯•è¯¥åŒæ­¥æ“ä½œä»»åŠ¡</strong>ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/batch-tasks/?self">ã€ŠEureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†ã€‹ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> æœ‰è¯¦ç»†è§£æã€‚</p></li></ul><hr><p><code>#handleBatchResponse(...)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBatchResponse</span><span class="params">(List&lt;ReplicationTask&gt; tasks, List&lt;ReplicationInstanceResponse&gt; responseList)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (tasks.size() != responseList.size()) &#123;</div><div class="line">       <span class="comment">// This should ideally never happen unless there is a bug in the software.</span></div><div class="line">       logger.error(<span class="string">"Batch response size different from submitted task list (&#123;&#125; != &#123;&#125;); skipping response analysis"</span>, responseList.size(), tasks.size());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.size(); i++) &#123;</div><div class="line">       handleBatchResponse(tasks.get(i), responseList.get(i));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBatchResponse</span><span class="params">(ReplicationTask task, ReplicationInstanceResponse response)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ‰§è¡ŒæˆåŠŸ</span></div><div class="line">   <span class="keyword">int</span> statusCode = response.getStatusCode();</div><div class="line">   <span class="keyword">if</span> (isSuccess(statusCode)) &#123;</div><div class="line">       task.handleSuccess();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// æ‰§è¡Œå¤±è´¥</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       task.handleFailure(response.getStatusCode(), response.getResponseEntity());</div><div class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       logger.error(<span class="string">"Replication task "</span> + task.getTaskName() + <span class="string">" error handler failure"</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p><code>ReplicationTask#handleSuccess()</code> æ–¹æ³•ï¼Œæ— ä»»åŠ¡åŒæ­¥æ“ä½œä»»åŠ¡é‡å†™ï¼Œæ˜¯ä¸ª<strong>ç©ºæ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// ReplicationTask.java</div><div class="line">public void handleSuccess() &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p><code>ReplicationTask#handleFailure()</code> æ–¹æ³•ï¼Œæœ‰<strong>ä¸¤ä¸ª</strong>åŒæ­¥æ“ä½œä»»åŠ¡é‡å†™ï¼š</p><ul><li><p>Cancel ï¼šå½“ Eureka-Server ä¸å­˜åœ¨ä¸‹çº¿çš„åº”ç”¨å®ä¾‹æ—¶ï¼Œè¿”å› 404 çŠ¶æ€ç ï¼Œæ­¤æ—¶æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerEurekaNode#cancel(...)</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="keyword">super</span>.handleFailure(statusCode, responseEntity);</div><div class="line">    <span class="keyword">if</span> (statusCode == <span class="number">404</span>) &#123;</div><div class="line">        logger.warn(<span class="string">"&#123;&#125;: missing entry."</span>, getTaskName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>x</li></ul></li><li><p>Heartbeat ï¼šæƒ…å†µè¾ƒä¸ºå¤æ‚ï¼Œæˆ‘ä»¬æ¢ä¸€è¡Œç»§ç»­è¯´ï¼Œé¿å…æ’ç‰ˆæœ‰é—®é¢˜ï¼Œå½±å“é˜…è¯»ã€‚</p></li></ul></li></ul><p>å™”å™”å™”æ°ï¼Œæœ¬æ–‡çš„é‡è¦å¤´æˆæ¥å•¦ï¼Last But Very Importment ï¼ï¼ï¼</p><p>Eureka-Server æ˜¯å…è®¸<strong>åŒä¸€æ—¶åˆ»</strong>å…è®¸åœ¨ä»»æ„èŠ‚ç‚¹è¢« Eureka-Client å‘èµ·<strong>å†™å…¥</strong>ç›¸å…³çš„æ“ä½œï¼Œç½‘ç»œæ˜¯ä¸å¯é çš„èµ„æºï¼ŒEureka-Client å¯èƒ½å‘ä¸€ä¸ª Eureka-Server æ³¨å†ŒæˆåŠŸï¼Œä½†æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼Œå¯¼è‡´ Eureka-Client è¯¯ä»¥ä¸ºå¤±è´¥ï¼Œæ­¤æ—¶æ°å¥½ Eureka-Client å˜æ›´äº†åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œé‡è¯•å‘å¦ä¸€ä¸ª Eureka-Server æ³¨å†Œï¼Œé‚£ä¹ˆä¸¤ä¸ª Eureka-Server å¯¹è¯¥åº”ç”¨å®ä¾‹çš„çŠ¶æ€äº§ç”Ÿå†²çªã€‚</p><p>å†ä¾‹å¦‚â€¦â€¦ æˆ‘ä»¬ä¸è¦ç»§ç»­ä¸¾ä¾‹å­ï¼Œç½‘ç»œæ³¢åŠ¨çœŸçš„å¾ˆå¤æ‚ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ Eureka æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>åº”ç”¨å®ä¾‹( InstanceInfo ) çš„ <code>lastDirtyTimestamp</code> å±æ€§ï¼Œä½¿ç”¨<strong>æ—¶é—´æˆ³</strong>ï¼Œè¡¨ç¤ºåº”ç”¨å®ä¾‹çš„<strong>ç‰ˆæœ¬å·</strong>ï¼Œå½“è¯·æ±‚æ–¹( ä¸ä»…ä»…æ˜¯ Eureka-Client ï¼Œä¹Ÿå¯èƒ½æ˜¯åŒæ­¥æ³¨å†Œæ“ä½œçš„ Eureka-Server ) å‘ Eureka-Server å‘èµ·æ³¨å†Œæ—¶ï¼Œè‹¥ Eureka-Server å·²å­˜åœ¨æ‹¥æœ‰æ›´å¤§ <code>lastDirtyTimestamp</code> è¯¥å®ä¾‹( <strong>ç›¸åŒåº”ç”¨å¹¶ä¸”ç›¸åŒåº”ç”¨å®ä¾‹ç¼–å·è¢«è®¤ä¸ºæ˜¯ç›¸åŒå®ä¾‹</strong> )ï¼Œåˆ™è¯·æ±‚æ–¹æ³¨å†Œçš„åº”ç”¨å®ä¾‹( InstanceInfo ) æ— æ³•è¦†ç›–æ³¨å†Œæ­¤ Eureka-Server çš„è¯¥å®ä¾‹( è§ <code>AbstractInstanceRegistry#register(...)</code> æ–¹æ³• )ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢ä¸¾çš„ä¾‹å­ï¼Œç¬¬ä¸€ä¸ª Eureka-Server å‘ ç¬¬äºŒä¸ª Eureka-Server åŒæ­¥æ³¨å†Œåº”ç”¨å®ä¾‹æ—¶ï¼Œä¸ä¼šæ³¨å†Œè¦†ç›–ï¼Œåå€’æ˜¯ç¬¬äºŒä¸ª Eureka-Server åŒæ­¥æ³¨å†Œåº”ç”¨åˆ°ç¬¬ä¸€ä¸ª Eureka-Server ï¼Œæ³¨å†Œè¦†ç›–æˆåŠŸï¼Œå› ä¸º <code>lastDirtyTimestamp</code> ( åº”ç”¨å®ä¾‹çŠ¶æ€å˜æ›´æ—¶ï¼Œå¯ä»¥è®¾ç½® <code>lastDirtyTimestamp</code> ä¸ºå½“å‰æ—¶é—´ï¼Œè§ <code>ApplicationInfoManager#setInstanceStatus(status)</code> æ–¹æ³• )ã€‚</p><p>ä½†æ˜¯å…‰é <strong>æ³¨å†Œ</strong>è¯·æ±‚åˆ¤æ–­ <code>lastDirtyTimestamp</code> æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹æ—¶ï¼ŒåŒæ­¥æ“ä½œä»»åŠ¡å¤šæ¬¡æ‰§è¡Œå¤±è´¥åˆ°è¾¾è¿‡æœŸæ—¶é—´åï¼Œæ­¤æ—¶åœ¨ Eureka-Server é›†ç¾¤åŒæ­¥èµ·åˆ°æœ€ç»ˆä¸€è‡´æ€§<strong>æœ€æœ€æœ€</strong>å…³é”®æ€§å‡ºç°äº†ï¼šHeartbeat ã€‚å› ä¸º Heartbeat ä¼šå‘¨æœŸæ€§çš„æ‰§è¡Œï¼Œé€šè¿‡å®ƒä¸€æ–¹é¢å¯ä»¥åˆ¤æ–­ Eureka-Server æ˜¯å¦å­˜åœ¨å¿ƒè·³å¯¹åº”çš„åº”ç”¨å®ä¾‹ï¼Œå¦å¤–ä¸€æ–¹é¢å¯ä»¥æ¯”è¾ƒåº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> ã€‚å½“æ»¡è¶³ä¸‹é¢ä»»æ„æ¡ä»¶ï¼ŒEureka-Server è¿”å› 404 çŠ¶æ€ç ï¼š</p><ul><li>1ï¼‰Eureka-Server åº”ç”¨å®ä¾‹ä¸å­˜åœ¨ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/registry/AbstractInstanceRegistry.java#L438" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li><li>2ï¼‰Eureka-Server åº”ç”¨å®ä¾‹çŠ¶æ€ä¸º <code>UNKNOWN</code>ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/registry/AbstractInstanceRegistry.java#L450" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚ä¸ºä»€ä¹ˆä¼šæ˜¯ <code>UNKNOWN</code> ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-override-status/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹ã€Œ 4.3 ç»­ç§Ÿåœºæ™¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><strong>3ï¼‰</strong>è¯·æ±‚çš„ <code>lastDirtyTimestamp</code> æ›´å¤§ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L306" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li></ul><p>è¯·æ±‚æ–¹æ¥æ”¶åˆ° 404 çŠ¶æ€ç è¿”å›åï¼Œ<strong>è®¤ä¸º Eureka-Server åº”ç”¨å®ä¾‹å®é™…æ˜¯ä¸å­˜åœ¨çš„</strong>ï¼Œé‡æ–°å‘èµ·åº”ç”¨å®ä¾‹çš„æ³¨å†Œã€‚ä»¥æœ¬æ–‡çš„ Heartbeat ä¸ºä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// PeerEurekaNode#heartbeat(...)</span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Object responseEntity)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">super</span>.handleFailure(statusCode, responseEntity);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (statusCode == <span class="number">404</span>) &#123;</div><div class="line">  <span class="number">5</span>:         logger.warn(<span class="string">"&#123;&#125;: missing entry."</span>, getTaskName());</div><div class="line">  <span class="number">6</span>:         <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">7</span>:             logger.warn(<span class="string">"&#123;&#125;: cannot find instance id &#123;&#125; and hence replicating the instance with status &#123;&#125;"</span>,</div><div class="line">  <span class="number">8</span>:                     getTaskName(), info.getId(), info.getStatus());</div><div class="line">  <span class="number">9</span>:             register(info);</div><div class="line"> <span class="number">10</span>:         &#125;</div><div class="line"> <span class="number">11</span>:     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.shouldSyncWhenTimestampDiffers()) &#123;</div><div class="line"> <span class="number">12</span>:         InstanceInfo peerInstanceInfo = (InstanceInfo) responseEntity;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (peerInstanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">14</span>:             syncInstancesIfTimestampDiffers(appName, id, info, peerInstanceInfo);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:     &#125;</div><div class="line"> <span class="number">17</span>: &#125;</div></pre></td></tr></table></figure><ul><li><p>ç¬¬ 4 è‡³ 10 è¡Œ ï¼šæ¥æ”¶åˆ° 404 çŠ¶æ€ç ï¼Œè°ƒç”¨ <code>#register(...)</code> æ–¹æ³•ï¼Œå‘è¯¥è¢«å¿ƒè·³åŒæ­¥æ“ä½œå¤±è´¥çš„ Eureka-Server å‘èµ·æ³¨å†Œ<strong>æœ¬åœ°çš„åº”ç”¨å®ä¾‹</strong>çš„è¯·æ±‚ã€‚</p><ul><li>ä¸Šè¿° <strong>3ï¼‰</strong> ï¼Œä¼šä½¿ç”¨è¯·æ±‚å‚æ•° <code>overriddenStatus</code> å­˜å‚¨åˆ° Eureka-Server çš„åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€é›†åˆ( <code>AbstractInstanceRegistry.overriddenInstanceStatusMap</code> )ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L123" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚</li></ul></li><li><p>ç¬¬ 11 è‡³ 16 è¡Œ ï¼šæ°å¥½æ˜¯ <strong>3ï¼‰</strong> åè¿‡æ¥çš„æƒ…å†µï¼Œæœ¬åœ°çš„åº”ç”¨å®ä¾‹çš„ <code>lastDirtyTimestamp</code> å°äº Eureka-Server è¯¥åº”ç”¨å®ä¾‹çš„ï¼Œæ­¤æ—¶ Eureka-Server è¿”å› 409 çŠ¶æ€ç ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-core/src/main/java/com/netflix/eureka/resources/InstanceResource.java#L314" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹è§¦å‘æ¡ä»¶ä»£ç ä½ç½®ã€‚è°ƒç”¨ <code>#syncInstancesIfTimestampDiffers()</code> æ–¹æ³•ï¼Œè¦†ç›–æ³¨å†Œæœ¬åœ°åº”ç”¨å®ä¾‹ï¼Œç‚¹å‡» <a href="https://github.com/YunaiV/eureka/blob/7f868f9ca715a8862c0c10cac04e238bbf371db0/eureka-core/src/main/java/com/netflix/eureka/cluster/PeerEurekaNode.java#L387" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a> æŸ¥çœ‹æ–¹æ³•ã€‚</p></li></ul><p>OKï¼Œæ’’èŠ±ï¼è®°ä½ï¼šEureka é€šè¿‡ Heartbeat å®ç° Eureka-Server é›†ç¾¤åŒæ­¥çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å†™çš„æ¯”è¾ƒå—¨çš®ï¼Œæ‰€ä»¥å°±é€èƒ–å‹ä¸€åªèƒ–å‹</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_08_07/04.png" alt=""></p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p><p>ä»¥ä¸‹æ˜¯è‰ç¨¿ï¼Œå¯ä»¥å‡‘åˆçœ‹</p><p>eureka server é›†ç¾¤å‡å®šæ˜¯ s1 s2</p><p>1ï¼‰client å‘ s1 æ³¨å†Œï¼Œæœ‰ä¸€ä¸ª lastDirtyTime ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆåŠŸï¼Œ s1 ä¼šå‘ s2 åŒæ­¥<br>2ï¼‰client å‘ s1 æ³¨å†Œï¼ˆæˆåŠŸï¼Œä½†æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼‰ï¼Œç„¶å client å‘ç”ŸçŠ¶æ€çš„å˜åŒ–ï¼ŒlastDirtyTime å˜åŒ–ï¼Œå‘ s2 æ³¨å†Œã€‚<br>è¿™ä¸ªæ—¶å€™ï¼Œs1 s2 æ˜¯å†²çªçš„ï¼Œä½†æ˜¯ä»–ä»¬ä¼šäº’ç›¸åŒæ­¥ï¼Œå®é™… s2 =&gt; s1 çš„æ³¨å†Œä¼šçœŸæ­£æˆåŠŸï¼Œs1 =&gt; s2 çš„æ³¨å†Œä¸ä¼šè¿”å›å¤±è´¥ï¼Œä½†æ˜¯å®é™… s2 å¤„ç†çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯è‡ªèº«çš„ã€‚</p><p>å¿ƒè·³åªæ˜¯æœ€ç»ˆå»æ ¡éªŒã€‚</p><p>ç†è®ºæ¥è¯´ï¼Œå¿ƒè·³ä¸åº”è¯¥å¸¦ lastDirtyTime å‚æ•°ã€‚å¸¦çš„åŸå› å°±æ˜¯ä¸ºäº†åšå›ºå®šå‘¨æœŸçš„æ¯”è¾ƒã€‚</p><p>æœ€ä¼˜è§£æ˜¯ æ³¨å†Œ å°±å¤„ç†æ‰æ•°æ®ä¸ä¸€è‡´<br>æ¬¡ä¼˜è§£æ˜¯ å¿ƒè·³ å¤„ç†æ‰æ•°æ®ä¸ä¸€è‡´</p><p>å¦‚æœåœ¨ç±»æ¯”ï¼Œ</p><p>æ³¨å†Œï¼Œç›¸å½“äº insertOrUpdate<br>å¿ƒè·³ï¼Œé™„åŠ äº†æ ¡éªŒæ˜¯å¦è¦å‘èµ·ã€æ³¨å†Œã€‘</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Eureka/">Eureka</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Eureka/server-cluster/" data-title="Eureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Eureka/rate-limiter/" title="Eureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiter"><strong>PREVIOUS:</strong><br><span>Eureka æºç è§£æ â€”â€” åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RateLimiter</span></a></div><div class="next"><a href="/Eureka/transport/" title="Eureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡"><strong>NEXT:</strong><br><span>Eureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°"><span class="toc-number">2.</span> <span class="toc-text">2. é›†ç¾¤èŠ‚ç‚¹åˆå§‹åŒ–ä¸æ›´æ–°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 æ›´æ–°é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-é›†ç¾¤èŠ‚ç‚¹"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 é›†ç¾¤èŠ‚ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-è·å–åˆå§‹æ³¨å†Œä¿¡æ¯"><span class="toc-number">3.</span> <span class="toc-text">3. è·å–åˆå§‹æ³¨å†Œä¿¡æ¯</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-åŒæ­¥æ³¨å†Œä¿¡æ¯"><span class="toc-number">4.</span> <span class="toc-text">4. åŒæ­¥æ³¨å†Œä¿¡æ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-åŒæ­¥æ“ä½œç±»å‹"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 åŒæ­¥æ“ä½œç±»å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-å‘èµ·-Eureka-Server-åŒæ­¥æ“ä½œ"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 å‘èµ· Eureka-Server åŒæ­¥æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-åŒæ­¥æ“ä½œä»»åŠ¡"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.1.1 åŒæ­¥æ“ä½œä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.1.2 åŒæ­¥æ“ä½œä»»åŠ¡å¤„ç†å™¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-æ¥æ”¶-Eureka-Server-åŒæ­¥æ“ä½œ"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 æ¥æ”¶ Eureka-Server åŒæ­¥æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-å¤„ç†-Eureka-Server-åŒæ­¥ç»“æœ"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 å¤„ç† Eureka-Server åŒæ­¥ç»“æœ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>34</sup></a></li><li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li><li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>4</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>5</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å¤©/" title="èŠ‹é“æºç çš„å‘¨å¤©">èŠ‹é“æºç çš„å‘¨å¤©<sup>1</sup></a></li></ul></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>