<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-evict/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬ 

1. æ¦‚è¿°
2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ
3. EvictionTask
4. è¿‡æœŸé€»è¾‘
6"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Eureka/instance-registry-evict/" title="Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸ" itemprop="url">Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸ</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ <a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">http://www.iocoder.cn/Eureka/instance-registry-evict/</a> ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">3. EvictionTask</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">4. è¿‡æœŸé€»è¾‘</a></li><li><a href="http://www.iocoder.cn/Eureka/instance-registry-evict/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>Eureka-Server è¿‡æœŸè¶…æ—¶ç»­ç§Ÿçš„ç§Ÿçº¦</strong>ã€‚</p><blockquote><p>FROM <a href="ã€Šhttp://techshow.ctrip.com/archives/1699.htmlã€‹">ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹</a><br><img src="http://www.iocoder.cn/images/Eureka/2018_06_22/01.png" alt=""></p></blockquote><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><p><strong>æ¨è Spring Cloud è§†é¢‘</strong>ï¼š</p><ul><li><a href="https://segmentfault.com/ls/1650000011063780?r=bPN0Ir" rel="external nofollow noopener noreferrer" target="_blank">Java å¾®æœåŠ¡å®è·µ - Spring Boot</a></li><li><a href="https://segmentfault.com/ls/1650000011386794?r=bPN0Ir" rel="external nofollow noopener noreferrer" target="_blank">Java å¾®æœåŠ¡å®è·µ - Spring Cloud</a></li><li><a href="https://segmentfault.com/ls/1650000011387052?r=bPN0Ir" rel="external nofollow noopener noreferrer" target="_blank">Java å¾®æœåŠ¡å®è·µ - Spring Boot / Spring Cloud</a></li></ul><h1 id="2-ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ"><a href="#2-ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ" class="headerlink" title="2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ"></a>2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</h1><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨å®ä¾‹ä¸‹çº¿æ—¶å€™ä¼šä¸»åŠ¨å‘ Eureka-Server å‘èµ·ä¸‹çº¿è¯·æ±‚ã€‚ä½†å®é™…æƒ…å†µä¸‹ï¼Œåº”ç”¨å®ä¾‹å¯èƒ½å¼‚å¸¸å´©æºƒï¼Œåˆæˆ–è€…æ˜¯ç½‘ç»œå¼‚å¸¸ç­‰åŸå› ï¼Œå¯¼è‡´ä¸‹çº¿è¯·æ±‚æ— æ³•è¢«æˆåŠŸæäº¤ã€‚</p><p>ä»‹äºè¿™ç§æƒ…å†µï¼Œé€šè¿‡ Eureka-Client å¿ƒè·³å»¶é•¿ç§Ÿçº¦ï¼Œé…åˆ Eureka-Server æ¸…ç†è¶…æ—¶çš„ç§Ÿçº¦è§£å†³ä¸Šè¿°å¼‚å¸¸ã€‚</p><h1 id="3-EvictionTask"><a href="#3-EvictionTask" class="headerlink" title="3. EvictionTask"></a>3. EvictionTask</h1><p><code>com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask</code>ï¼Œæ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡ã€‚åœ¨ Eureka-Server å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ– EvictionTask å®šæ—¶æ‰§è¡Œï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractInstanceRegistry.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;EvictionTask&gt; evictionTaskRef = <span class="keyword">new</span> AtomicReference&lt;EvictionTask&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postInit</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// .... çœç•¥æ— å…³ä»£ç </span></div><div class="line"></div><div class="line">   <span class="comment">// åˆå§‹åŒ– æ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡</span></div><div class="line">   <span class="keyword">if</span> (evictionTaskRef.get() != <span class="keyword">null</span>) &#123;</div><div class="line">       evictionTaskRef.get().cancel();</div><div class="line">   &#125;</div><div class="line">   evictionTaskRef.set(<span class="keyword">new</span> EvictionTask());</div><div class="line">   evictionTimer.schedule(evictionTaskRef.get(),</div><div class="line">           serverConfig.getEvictionIntervalTimerInMs(),</div><div class="line">           serverConfig.getEvictionIntervalTimerInMs());</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>é…ç½® <code>eureka.evictionIntervalTimerInMs</code> ï¼Œæ¸…ç†ç§Ÿçº¦è¿‡æœŸä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤ï¼Œ60000 æ¯«ç§’ã€‚</li><li><p>EvictionTask å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EvictionTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// è·å– è¡¥å¿æ—¶é—´æ¯«ç§’æ•°</span></div><div class="line">           <span class="keyword">long</span> compensationTimeMs = getCompensationTimeMs();</div><div class="line">           logger.info(<span class="string">"Running the evict task with compensationTime &#123;&#125;ms"</span>, compensationTimeMs);</div><div class="line">           <span class="comment">// æ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘</span></div><div class="line">           evict(compensationTimeMs);</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">           logger.error(<span class="string">"Could not run the evict task"</span>, e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>è°ƒç”¨ <code>#compensationTimeMs()</code> æ–¹æ³•ï¼Œè·å¾—è¡¥å¿æ—¶é—´æ¯«ç§’æ•°ã€‚è®¡ç®—å…¬å¼ = å½“å‰æ—¶é—´ - æœ€åä»»åŠ¡æ‰§è¡Œæ—¶é—´ - ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ã€‚ä¸ºä»€ä¹ˆéœ€è¦è¡¥å¿æ—¶é—´æ¯«ç§’æ•°ï¼Œåœ¨ <a href="#">ã€Œ4. è¿‡æœŸé€»è¾‘ã€<code>Lease#isisExpired(additionalLeaseMs)</code> æ–¹æ³•</a> æ­æ™“ã€‚<code>#compensationTimeMs()</code> å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æœ€åä»»åŠ¡æ‰§è¡Œæ—¶é—´</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastExecutionNanosRef = <span class="keyword">new</span> AtomicLong(<span class="number">0L</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="title">getCompensationTimeMs</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> currNanos = getCurrentTimeNano();</div><div class="line">    <span class="keyword">long</span> lastNanos = lastExecutionNanosRef.getAndSet(currNanos);</div><div class="line">    <span class="keyword">if</span> (lastNanos == <span class="number">0L</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);</div><div class="line">    <span class="keyword">long</span> compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();</div><div class="line">    <span class="keyword">return</span> compensationTime &lt;= <span class="number">0L</span> ? <span class="number">0L</span> : compensationTime;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>ç”±äº JVM GC ï¼Œåˆæˆ–æ˜¯æ—¶é—´åç§»( clock skew ) ç­‰åŸå› ï¼Œå®šæ—¶å™¨æ‰§è¡Œå®é™…æ¯”é¢„æœŸä¼š<strong>ç•¥æœ‰å»¶è¿Ÿ</strong>ã€‚ç¬”è€…åœ¨æœ¬æœº<strong>ä½è´Ÿè½½</strong>è¿è¡Œï¼Œå¤§æ¦‚ 10 ms å†…ã€‚</p><blockquote><p>compute a compensation time defined as the actual time this task was executed since the prev iteration, vs the configured amount of time for execution. This is useful for cases where changes in time (due to clock skew or gc for example) causes the actual eviction task to execute later than the desired time according to the configured cycle.</p></blockquote></li></ul></li><li><p>è°ƒç”¨ <code>#evict(compensationTime)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œåœ¨ <a href="#">ã€Œ4. è¿‡æœŸé€»è¾‘ã€</a> è¯¦ç»†è§£æã€‚</p></li></ul></li></ul><h1 id="4-è¿‡æœŸé€»è¾‘"><a href="#4-è¿‡æœŸé€»è¾‘" class="headerlink" title="4. è¿‡æœŸé€»è¾‘"></a>4. è¿‡æœŸé€»è¾‘</h1><p>è°ƒç”¨ <code>#evict(compensationTime)</code> æ–¹æ³•ï¼Œæ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     logger.debug(<span class="string">"Running the evict task"</span>);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class="line"> <span class="number">5</span>:         logger.debug(<span class="string">"DS: lease expiration is currently disabled."</span>);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="comment">// è·å¾— æ‰€æœ‰è¿‡æœŸçš„ç§Ÿçº¦</span></div><div class="line"><span class="number">10</span>:     <span class="comment">// We collect first all expired items, to evict them in random order. For large eviction sets,</span></div><div class="line"><span class="number">11</span>:     <span class="comment">// if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,</span></div><div class="line"><span class="number">12</span>:     <span class="comment">// the impact should be evenly distributed across all applications.</span></div><div class="line"><span class="number">13</span>:     List&lt;Lease&lt;InstanceInfo&gt;&gt; expiredLeases = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">14</span>:     <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; groupEntry : registry.entrySet()) &#123;</div><div class="line"><span class="number">15</span>:         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = groupEntry.getValue();</div><div class="line"><span class="number">16</span>:         <span class="keyword">if</span> (leaseMap != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">17</span>:             <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseEntry : leaseMap.entrySet()) &#123;</div><div class="line"><span class="number">18</span>:                 Lease&lt;InstanceInfo&gt; lease = leaseEntry.getValue();</div><div class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (lease.isExpired(additionalLeaseMs) &amp;&amp; lease.getHolder() != <span class="keyword">null</span>) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"><span class="number">20</span>:                     expiredLeases.add(lease);</div><div class="line"><span class="number">21</span>:                 &#125;</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="comment">// è®¡ç®— æœ€å¤§å…è®¸æ¸…ç†ç§Ÿçº¦æ•°é‡</span></div><div class="line"><span class="number">27</span>:     <span class="comment">// To compensate for GC pauses or drifting local time, we need to use current registry size as a base for</span></div><div class="line"><span class="number">28</span>:     <span class="comment">// triggering self-preservation. Without that we would wipe out full registry.</span></div><div class="line"><span class="number">29</span>:     <span class="keyword">int</span> registrySize = (<span class="keyword">int</span>) getLocalRegistrySize();</div><div class="line"><span class="number">30</span>:     <span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (registrySize * serverConfig.getRenewalPercentThreshold());</div><div class="line"><span class="number">31</span>:     <span class="keyword">int</span> evictionLimit = registrySize - registrySizeThreshold;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:     <span class="comment">// è®¡ç®— æ¸…ç†ç§Ÿçº¦æ•°é‡</span></div><div class="line"><span class="number">34</span>:     <span class="keyword">int</span> toEvict = Math.min(expiredLeases.size(), evictionLimit);</div><div class="line"><span class="number">35</span>:     <span class="keyword">if</span> (toEvict &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">36</span>:         logger.info(<span class="string">"Evicting &#123;&#125; items (expired=&#123;&#125;, evictionLimit=&#123;&#125;)"</span>, toEvict, expiredLeases.size(), evictionLimit);</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:         <span class="comment">// é€ä¸ªè¿‡æœŸ</span></div><div class="line"><span class="number">39</span>:         Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</div><div class="line"><span class="number">40</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toEvict; i++) &#123;</div><div class="line"><span class="number">41</span>:             <span class="comment">// Pick a random item (Knuth shuffle algorithm)</span></div><div class="line"><span class="number">42</span>:             <span class="keyword">int</span> next = i + random.nextInt(expiredLeases.size() - i);</div><div class="line"><span class="number">43</span>:             Collections.swap(expiredLeases, i, next);</div><div class="line"><span class="number">44</span>:             Lease&lt;InstanceInfo&gt; lease = expiredLeases.get(i);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:             String appName = lease.getHolder().getAppName();</div><div class="line"><span class="number">47</span>:             String id = lease.getHolder().getId();</div><div class="line"><span class="number">48</span>:             EXPIRED.increment();</div><div class="line"><span class="number">49</span>:             logger.warn(<span class="string">"DS: Registry: expired lease for &#123;&#125;/&#123;&#125;"</span>, appName, id);</div><div class="line"><span class="number">50</span>:             internalCancel(appName, id, <span class="keyword">false</span>);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>:     &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure><ul><li>ç¬¬ 3 è‡³ 7 è¡Œ ï¼šåˆ¤æ–­å…è®¸æ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ï¼Œä¸»è¦å’Œ<strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>æœ‰å…³ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li><p>ç¬¬ 9 è‡³ 24 è¡Œ ï¼šè·å¾—<strong>æ‰€æœ‰è¿‡æœŸ</strong>çš„ç§Ÿçº¦é›†åˆã€‚</p><ul><li><p>ç¬¬ 19 è¡Œ ï¼šè°ƒç”¨ <code>Lease#isisExpired(additionalLeaseMs)</code> æ–¹æ³•ï¼Œåˆ¤æ–­ç§Ÿçº¦æ˜¯å¦è¿‡æœŸï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Lease.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpired</span><span class="params">(<span class="keyword">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> (evictionTimestamp &gt; <span class="number">0</span> || System.currentTimeMillis() &gt; (lastUpdateTimestamp + duration + additionalLeaseMs));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">   lastUpdateTimestamp = System.currentTimeMillis() + duration;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>ğŸ˜ˆ<strong>æ³¨æ„</strong>ï¼šåœ¨ä¸è€ƒè™‘ <code>additionalLeaseMs</code> å‚æ•°çš„æƒ…å†µä¸‹ï¼Œç§Ÿçº¦è¿‡æœŸæ—¶é—´æ¯”é¢„æœŸå¤šäº†<strong>ä¸€ä¸ª</strong> <code>duration</code>ï¼ŒåŸå› åœ¨äº <code>#renew()</code> æ–¹æ³•é”™è¯¯çš„è®¾ç½® <code>lastUpdateTimestamp = System.currentTimeMillis() + duration</code>ï¼Œæ­£ç¡®çš„è®¾ç½®åº”è¯¥æ˜¯ <code>lastUpdateTimestamp = System.currentTimeMillis()</code> ã€‚</p><blockquote><p>Note that due to renew() doing the â€˜wrongâ€ thing and setting lastUpdateTimestamp to +duration more than what it should be, the expiry will actually be 2 <em>duration. <em>*This is a minor bug and should only affect instances that ungracefully shutdown. Due to possible wide ranging impact to existing usage, this will not be fixed</em></em>.</p></blockquote></li><li><p>TODO[0023]ï¼šadditionalLeaseMs</p></li></ul></li></ul></li><li><p>ç¬¬ 26 è‡³ 34 è¡Œ ï¼šè®¡ç®—<strong>æœ€å¤§å…è®¸</strong>æ¸…ç†ç§Ÿçº¦çš„æ•°é‡ï¼Œåè®¡ç®—å…è®¸æ¸…ç†ç§Ÿçº¦çš„æ•°é‡ã€‚</p><ul><li><p>ğŸ˜ˆ<strong>æ³¨æ„</strong>ï¼šå³ä½¿ Eureka-Server å…³é—­<strong>è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</strong>ï¼Œå¦‚æœä½¿ç”¨<code>renewalPercentThreshold = 0.85</code> é»˜è®¤é…ç½®ï¼Œç»“æœä¼šæ˜¯<strong>åˆ†æ‰¹é€æ­¥</strong>è¿‡æœŸã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// å‡è®¾ 20 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 10 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬ä¸€è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">20</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">20</span> * <span class="number">0.85</span>) = <span class="number">17</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">20</span> - <span class="number">17</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">10</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬ä¸€è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 17 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 7 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬äºŒè½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">17</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">17</span> * <span class="number">0.85</span>) = <span class="number">14</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">17</span> - <span class="number">14</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">7</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬äºŒè½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 14 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 4 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬ä¸‰è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">14</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">14</span> * <span class="number">0.85</span>) = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">14</span> - <span class="number">11</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">4</span>, <span class="number">3</span>) = <span class="number">3</span>;</div><div class="line"><span class="comment">// ç¬¬ä¸‰è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 11 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 1 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚</span></div><div class="line"></div><div class="line"><span class="comment">// ç¬¬å››è½®æ‰§è¡Œå¼€å§‹</span></div><div class="line"><span class="keyword">int</span> registrySize = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> registrySizeThreshold = (<span class="keyword">int</span>) (<span class="number">11</span> * <span class="number">0.85</span>) = <span class="number">9</span>;</div><div class="line"><span class="keyword">int</span> evictionLimit = <span class="number">11</span> - <span class="number">9</span> = <span class="number">2</span>;</div><div class="line"><span class="keyword">int</span> toEvict = Math.min(<span class="number">1</span>, <span class="number">2</span>) = <span class="number">1</span>;</div><div class="line"><span class="comment">// ç¬¬å››è½®æ‰§è¡Œç»“æŸï¼Œå‰©ä½™ 10 ä¸ªç§Ÿçº¦ï¼Œå…¶ä¸­æœ‰ 0 ä¸ªç§Ÿçº¦è¿‡æœŸã€‚ç»“æŸã€‚</span></div></pre></td></tr></table></figure><ul><li>ç»“è®ºï¼šæ˜¯å¦å¼€å¯è‡ªæˆ‘ä¿æŠ¤çš„å·®åˆ«ï¼Œåœ¨äºæ˜¯å¦æ‰§è¡Œæ¸…ç†è¿‡æœŸç§Ÿçº¦é€»è¾‘ã€‚å¦‚æœæƒ³å…³é—­<strong>åˆ†æ‰¹é€æ­¥</strong>è¿‡æœŸï¼Œè®¾ç½® <code>renewalPercentThreshold = 0</code> ã€‚</li></ul></li><li><p>ç”±äº JVM GC ï¼Œæˆ–æ˜¯æœ¬åœ°æ—¶é—´å·®å¼‚åŸå› ï¼Œå¯èƒ½è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶çš„é˜€å€¼ <code>expectedNumberOfRenewsPerMin</code>ã€<code>numberOfRenewsPerMinThreshold</code> ä¸å¤Ÿæ­£ç¡®ï¼Œåœ¨<strong>è¿‡æœŸ</strong>è¿™ä¸ªç›¸å¯¹â€œå±é™©â€çš„æ“ä½œï¼Œ<strong>é‡æ–°è®¡ç®—è‡ªæˆ‘ä¿æŠ¤</strong>çš„é˜€å€¼ã€‚</p></li></ul></li><li><p>ç¬¬ 35 è‡³ 51 è¡Œ ï¼š<strong>éšæœº</strong>æ¸…ç†è¿‡æœŸçš„ç§Ÿçº¦ã€‚ç”±äºç§Ÿçº¦æ˜¯æŒ‰ç…§<strong>åº”ç”¨é¡ºåº</strong>æ·»åŠ åˆ°æ•°ç»„ï¼Œé€šè¿‡éšæœºçš„æ–¹å¼ï¼Œ<strong>å°½é‡é¿å…å•ä¸ªåº”ç”¨è¢«å…¨éƒ¨è¿‡æœŸ</strong>ã€‚</p><ul><li>ç¬¬ 39 è¡Œ ï¼šä¼ å…¥å½“å‰æ—¶é—´ä¸ºç§å­ç”Ÿæˆéšæœºï¼Œé¿å… Java çš„ä¼ªéšæœºæƒ…å†µã€‚åœ¨ <a href="http://www.cnblogs.com/greatfish/p/5845924.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸ºä»€ä¹ˆè¯´Javaä¸­çš„éšæœºæ•°éƒ½æ˜¯ä¼ªéšæœºæ•°ï¼Ÿã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 41 è‡³ 43 è¡Œ ï¼šéšæœºè°ƒæ¢åé¢çš„å…ƒç´ åˆ°å½“å‰ä½ç½®( <code>i</code> )ã€‚</li></ul></li><li>ç¬¬ 50 è¡Œ ï¼šè°ƒç”¨ <code>#internalCancel()</code> æ–¹æ³•ï¼Œä¸‹çº¿å·²è¿‡æœŸçš„ç§Ÿçº¦ï¼Œåœ¨ <a href="http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self">ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹ã€Œ3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ã€</a> æœ‰è¯¦ç»†è§£æã€‚</li></ul><h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="çŸ¥è¯†æ˜Ÿçƒ"></p><p>ğŸ˜« åŸæœ¬è§‰å¾—æ¯”è¾ƒå®¹æ˜“çš„ä¸€ç¯‡æ–‡ç« ï¼Œç»“æœæ¶ˆè€—äº†æ¯”æƒ³è±¡ä¸­çš„æ—¶é—´ï¼Œå¯èƒ½æœ‰å››ä¸ªå°æ—¶ã€‚ä¸»è¦å¡åœ¨è¡¥å¿æ—¶é—´ï¼Œç›®å‰ä¹Ÿæ²¡å¼„æ‡‚ã€‚å¦‚æœæœ‰çŸ¥é“çš„èƒ–å‹ï¼Œéº»çƒ¦å‘ŠçŸ¥ä¸‹ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Eureka/">Eureka</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Eureka/instance-registry-evict/" data-title="Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆäº”ï¼‰ä¹‹è¿‡æœŸ | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Eureka/instance-registry-fetch-all/" title="Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–"><strong>PREVIOUS:</strong><br><span>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–</span></a></div><div class="next"><a href="/Eureka/instance-registry-self-preservation/" title="Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶"><strong>NEXT:</strong><br><span>Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ"><span class="toc-number">2.</span> <span class="toc-text">2. ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-EvictionTask"><span class="toc-number">3.</span> <span class="toc-text">3. EvictionTask</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-è¿‡æœŸé€»è¾‘"><span class="toc-number">4.</span> <span class="toc-text">4. è¿‡æœŸé€»è¾‘</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number">5.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>5</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å…«/" title="èŠ‹é“æºç çš„å‘¨å…«">èŠ‹é“æºç çš„å‘¨å…«<sup>9</sup></a></li></ul></div><div id="authorInfo2"><div><img width="100%" src="/images/common/zsxq/02.png"></div></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>