<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E"><meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0"><meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214"><meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1"><meta name="sogou_site_verification" content="MpPsku240L"><title>Eureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç† | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3,minimum-scale=1"><meta name="author" content="èŠ‹é“æºç "><meta name="description" content="æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/batch-tasks/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼
æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬

1. æ¦‚è¿°
2. æ•´ä½“æµç¨‹
3. ä»»åŠ¡å¤„ç†å™¨
4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨

4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨
4.2 å•ä»»"><meta name="keywords" content="Java,æ¶æ„,åç«¯,æœåŠ¡ç«¯,RocketMQ,MyCAT,åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—,åˆ†å¸ƒå¼å­˜å‚¨,æŠ€æœ¯åšå®¢,Sharding-JDBC,åˆ†åº“åˆ†è¡¨"><link rel="alternate" href="atom.xml" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?9e70e3362807c1bd185a79655b307027";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t="http:"==document.location.protocol?"http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";document.write('<script src="'+t+'" id="sozz"><\/script>')}()</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head></html><body><header><div><div id="textlogo"><h1 class="site-name"><a href="/" title="èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢">èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢</a></h1><a class="blog-motto">æ„¿åŠç”Ÿç¼–ç ï¼Œå¦‚ä¸€ç”Ÿè€å‹ï¼</a></div><div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•"></a></div><nav class="animated"><ul><ul><li><a href="/">æ–‡ç« </a></li><li><a href="/2018-meet-you">çŸ¥è¯†æ˜Ÿçƒ</a></li><li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li><li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">å¾®ä¿¡å…¬ä¼—å·</a></li><li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">å·¥ä½œå†…æ¨</a></li><li><a href="/link_url">å‹é“¾</a></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope="" itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/Eureka/batch-tasks/" title="Eureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†" itemprop="url">Eureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç†</a></h1><p class="article-author"></p><p class="article-time">æ€»é˜…è¯»é‡:<span id="busuanzi_value_page_pv"></span>æ¬¡</p></header><div class="article-content"><p>æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/batch-tasks/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼</p><p><strong>æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬</strong></p><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">1. æ¦‚è¿°</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">2. æ•´ä½“æµç¨‹</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">3. ä»»åŠ¡å¤„ç†å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</a><ul><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</a></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</a></li></ul></li><li><a href="http://www.iocoder.cn/Eureka/batch-tasks/">666. å½©è›‹</a></li></ul><hr><p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p><blockquote><p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š</p><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol></blockquote><hr><h1>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦åˆ†äº« <strong>ä»»åŠ¡æ‰¹å¤„ç†</strong>ã€‚Eureka-Server é›†ç¾¤é€šè¿‡ä»»åŠ¡æ‰¹å¤„ç†åŒæ­¥åº”ç”¨å®ä¾‹æ³¨å†Œå®ä¾‹ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿæ˜¯ä¸º Eureka-Server é›†ç¾¤åŒæ­¥çš„åˆ†äº«åšé“ºå«ã€‚</p><p>æœ¬æ–‡æ¶‰åŠç±»åœ¨ <code>com.netflix.eureka.util.batcher</code> åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_17/02.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_17/02.png" alt=""></p><ul><li>ç´«è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡åˆ†å‘å™¨</li><li>è“è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æ¥æ”¶å™¨</li><li>çº¢è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æ‰§è¡Œå™¨</li><li>ç»¿è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡å¤„ç†å™¨</li><li>é»„è‰²éƒ¨åˆ† â€”â€” ä»»åŠ¡æŒæœ‰è€…( ä»»åŠ¡ )</li></ul><p><strong>æ¨è Spring Cloud ä¹¦ç±</strong>ï¼š</p><ul><li>è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ<strong>ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG</strong> ã€‚</li><li>ç¨‹åºçŒ¿DD â€”â€” <a href="https://union-click.jd.com/jdc?d=505Twi" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</a></li><li>å‘¨ç«‹ â€”â€” <a href="https://union-click.jd.com/jdc?d=k3sAaK" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹</a></li><li>ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚</li></ul><h1>2. æ•´ä½“æµç¨‹</h1><p>ä»»åŠ¡æ‰§è¡Œçš„æ•´ä½“æµç¨‹å¦‚ä¸‹( <a href="http://www.iocoder.cn/images/Eureka/2018_07_17/01.png">æ‰“å¼€å¤§å›¾</a> )ï¼š</p><p><img src="http://www.iocoder.cn/images/Eureka/2018_07_17/01.png" alt=""></p><ul><li><p>ç»†ç®­å¤´ â€”â€” ä»»åŠ¡æ‰§è¡Œç»å†çš„æ“ä½œ</p></li><li><p>ç²—ç®­å¤´ â€”â€” ä»»åŠ¡é˜Ÿåˆ—æµè½¬çš„æ–¹å‘</p></li><li><p><strong>ä¸åŒäº</strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»»åŠ¡æäº¤äº†<strong>ç«‹å³</strong>åŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œï¼Œä»»åŠ¡çš„æ‰§è¡Œæ‹†åˆ†äº†<strong>ä¸‰å±‚é˜Ÿåˆ—</strong>ï¼š</p><ul><li><p>ç¬¬ä¸€å±‚ï¼Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ï¼Œé‡æ–°å¤„ç†é˜Ÿåˆ—( <code>reprocessQueue</code> )ã€‚</p><ul><li>è“çº¿ï¼šåˆ†å‘å™¨åœ¨æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œè¯·æ±‚åï¼Œæäº¤åˆ°æ¥æ”¶é˜Ÿåˆ—ï¼Œ<strong>ä»»åŠ¡å®é™…æœªæ‰§è¡Œ</strong>ã€‚</li><li>é»„çº¿ï¼šæ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹å¤„ç†ä»»åŠ¡å¤±è´¥ï¼Œå°†ç¬¦åˆæ¡ä»¶( è§ <a href="#">ã€Œ3. ä»»åŠ¡å¤„ç†å™¨ã€</a> )çš„å¤±è´¥ä»»åŠ¡æäº¤åˆ°é‡æ–°æ‰§è¡Œé˜Ÿåˆ—ã€‚</li></ul></li><li><p>ç¬¬äºŒå±‚ï¼Œå¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )</p><ul><li>ç²‰çº¿ï¼šæ¥æ”¶çº¿ç¨‹( Runner )å°†é‡æ–°æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ¥æ”¶é˜Ÿåˆ—æäº¤åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—ã€‚</li></ul></li><li><p>ç¬¬ä¸‰å±‚ï¼Œå·¥ä½œé˜Ÿåˆ—( <code>workQueue</code> )</p><ul><li>ç²‰çº¿ï¼šæ¥æ”¶çº¿ç¨‹( Runner )å°†å¾…æ‰§è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡æ ¹æ®å‚æ•°( <code>maxBatchingSize</code> )å°†ä»»åŠ¡åˆå¹¶æˆ<strong>æ‰¹é‡ä»»åŠ¡</strong>ï¼Œè°ƒåº¦( æäº¤ )åˆ°å·¥ä½œé˜Ÿåˆ—ã€‚</li><li>é»„çº¿ï¼šæ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹<strong>æ± </strong>ï¼Œä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¯ä»¥æ‹‰å–ä¸€ä¸ª<strong>æ‰¹é‡ä»»åŠ¡</strong>è¿›è¡Œæ‰§è¡Œã€‚</li></ul></li></ul></li><li><p><strong>ä¸‰å±‚é˜Ÿåˆ—çš„å¥½å¤„</strong>ï¼š</p><ul><li>æ¥æ”¶é˜Ÿåˆ—ï¼Œé¿å…å¤„ç†ä»»åŠ¡çš„é˜»å¡ç­‰å¾…ã€‚</li><li>æ¥æ”¶çº¿ç¨‹( Runner )åˆå¹¶ä»»åŠ¡ï¼Œå°†ç›¸åŒä»»åŠ¡ç¼–å·( <strong>æ˜¯çš„ï¼Œä»»åŠ¡æ˜¯å¸¦æœ‰ç¼–å·çš„</strong> )çš„ä»»åŠ¡åˆå¹¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>Eureka-Server ä¸ºé›†ç¾¤åŒæ­¥æä¾›æ‰¹é‡æ“ä½œ<strong>å¤šä¸ª</strong>åº”ç”¨å®ä¾‹çš„<strong>æ¥å£</strong>ï¼Œä¸€ä¸ª<strong>æ‰¹é‡ä»»åŠ¡</strong>å¯ä»¥ä¸€æ¬¡è°ƒåº¦æ¥å£å®Œæˆï¼Œé¿å…å¤šæ¬¡è°ƒç”¨çš„å¼€é”€ã€‚å½“ç„¶ï¼Œè¿™æ ·åšçš„å‰ææ˜¯åˆå¹¶ä»»åŠ¡ï¼Œè¿™ä¹Ÿå¯¼è‡´ Eureka-Server é›†ç¾¤ä¹‹é—´å¯¹åº”ç”¨å®ä¾‹çš„æ³¨å†Œå’Œä¸‹çº¿å¸¦æ¥æ›´å¤§çš„å»¶è¿Ÿã€‚<strong>æ¯•ç«Ÿï¼ŒEureka æ˜¯åœ¨ CAP ä¹‹é—´ï¼Œé€‰æ‹©äº† AP</strong>ã€‚</li></ul></li></ul><h1>3. ä»»åŠ¡å¤„ç†å™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskProcessor</code> ï¼Œä»»åŠ¡å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskProcessor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * A processed task/task list ends up in one of the following states:</span></div><div class="line"><span class="comment">     * &lt;ul&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> Success&#125; processing finished successfully&lt;/li&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> TransientError&#125; processing failed, but shall be retried later&lt;/li&gt;</span></div><div class="line"><span class="comment">     *     &lt;li&gt;&#123;<span class="doctag">@code</span> PermanentError&#125; processing failed, and is non recoverable&lt;/li&gt;</span></div><div class="line"><span class="comment">     * &lt;/ul&gt;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">enum</span> ProcessingResult &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æˆåŠŸ</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Success,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æ‹¥æŒ¤é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Congestion,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * ç¬æ—¶é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        TransientError,</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * æ°¸ä¹…é”™è¯¯</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        PermanentError</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤„ç†å•ä»»åŠ¡</span></div><div class="line"><span class="comment">     * In non-batched mode a single task is processed at a time.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ProcessingResult <span class="title">process</span><span class="params">(T task)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å¤„ç†æ‰¹é‡ä»»åŠ¡</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * For batched mode a collection of tasks is run at a time. The result is provided for the aggregated result,</span></div><div class="line"><span class="comment">     * and all tasks are handled in the same way according to what is returned (for example are rescheduled, if the</span></div><div class="line"><span class="comment">     * error is transient).</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">ProcessingResult <span class="title">process</span><span class="params">(List&lt;T&gt; tasks)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>ProcessingResult ï¼Œå¤„ç†ä»»åŠ¡ç»“æœã€‚<ul><li><code>Success</code> ï¼ŒæˆåŠŸã€‚</li><li><code>Congestion</code> ï¼Œæ‹¥æŒ¤é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«é‡è¯•</strong>ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚è¢«é™æµã€‚</li><li><code>TransientError</code> ï¼Œç¬æ—¶é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«é‡è¯•</strong>ã€‚ä¾‹å¦‚ï¼Œç½‘ç»œè¯·æ±‚è¶…æ—¶ã€‚</li><li><code>PermanentError</code> ï¼Œæ°¸ä¹…é”™è¯¯ï¼Œ<strong>ä»»åŠ¡å°†ä¼šè¢«ä¸¢å¼ƒ</strong>ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œæ—¶å‘ç”Ÿç¨‹åºå¼‚å¸¸ã€‚</li></ul></li><li><code>#process(task)</code> æ–¹æ³•ï¼Œå¤„ç†å•ä»»åŠ¡ã€‚</li><li><code>#process(tasks)</code> æ–¹æ³•ï¼Œå¤„ç†æ‰¹é‡ä»»åŠ¡ã€‚</li></ul><h1>4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskDispatcher</code> ï¼Œä»»åŠ¡åˆ†å‘å™¨<strong>æ¥å£</strong>ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskDispatcher</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><code>#process(...)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡ç¼–å·ï¼Œä»»åŠ¡ï¼Œä»»åŠ¡è¿‡æœŸæ—¶é—´ç»™ä»»åŠ¡åˆ†å‘å™¨å¤„ç†ã€‚</li></ul><p><code>com.netflix.eureka.util.batcher.TaskDispatchers</code> ï¼Œä»»åŠ¡åˆ†å‘å™¨<strong>å·¥å‚ç±»</strong>ï¼Œç”¨äºåˆ›å»ºä»»åŠ¡åˆ†å‘å™¨ã€‚å…¶å†…éƒ¨æä¾›ä¸¤ç§ä»»åŠ¡åˆ†å‘å™¨çš„å®ç°ï¼š</p><ul><li><strong>æ‰¹é‡ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server é›†ç¾¤æ³¨å†Œä¿¡æ¯çš„åŒæ­¥ä»»åŠ¡ã€‚</li><li><strong>å•ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œç”¨äº Eureka-Server å‘äºšé©¬é€Š AWS çš„ ASG ( Autoscaling Group ) åŒæ­¥çŠ¶æ€ã€‚è™½ç„¶æœ¬ç³»åˆ—æš‚æ—¶å¯¹ AWS ç›¸å…³çš„ä¸åšè§£æï¼Œä»å·¥å…·ç±»çš„è§’åº¦æ¥è¯´ï¼Œæœ¬æ–‡ä¼šå¯¹è¯¥åˆ†å‘å™¨è¿›è¡Œåˆ†äº«ã€‚</li></ul><p><code>com.netflix.eureka.cluster.ReplicationTaskProcessor</code> ï¼Œå®ç° TaskDispatcher ï¼ŒEureka-Server é›†ç¾¤ä»»åŠ¡å¤„ç†å™¨ã€‚æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥ç‚¹å‡»<a href="https://github.com/YunaiV/eureka/blob/6e1b694898aa2f4c155936420c2ce5850f142742/eureka-core/src/main/java/com/netflix/eureka/cluster/ReplicationTaskProcessor.java" rel="external nofollow noopener noreferrer" target="_blank">é“¾æ¥</a>è‡ªå·±ç ”ç©¶ï¼Œæˆ‘ä»¬å°†åœ¨ <a href="http://www.iocoder.cn/Eureka/server-cluster/?self">ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹</a> æœ‰è¯¦ç»†è§£æã€‚</p><h2>4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</h2><p>è°ƒç”¨ <code>TaskDispatchers#createBatchingTaskDispatcher(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ‰¹é‡ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskDispatchers.java</span></div><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">  2:  * åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment">  3:  *</span></div><div class="line"><span class="comment">  4:  * <span class="doctag">@param</span> id ä»»åŠ¡æ‰§è¡Œå™¨ç¼–å·</span></div><div class="line"><span class="comment">  5:  * <span class="doctag">@param</span> maxBufferSize å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">  6:  * <span class="doctag">@param</span> workloadSize å•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">  7:  * <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">  8:  * <span class="doctag">@param</span> maxBatchingDelay æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">  9:  * <span class="doctag">@param</span> congestionRetryDelayMs è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 10:  * <span class="doctag">@param</span> networkFailureRetryMs ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 11:  * <span class="doctag">@param</span> taskProcessor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment"> 12:  * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment"> 13:  * <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment"> 14:  * <span class="doctag">@return</span> æ‰¹é‡ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment"> 15:  */</span></div><div class="line"> <span class="number">16</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskDispatcher&lt;ID, T&gt; <span class="title">createBatchingTaskDispatcher</span><span class="params">(String id,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">17</span>:                                                                          <span class="keyword">int</span> maxBufferSize,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">18</span>:                                                                          <span class="keyword">int</span> workloadSize,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">19</span>:                                                                          <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">20</span>:                                                                          <span class="keyword">long</span> maxBatchingDelay,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">21</span>:                                                                          <span class="keyword">long</span> congestionRetryDelayMs,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">22</span>:                                                                          <span class="keyword">long</span> networkFailureRetryMs,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">23</span>:                                                                          TaskProcessor&lt;T&gt; taskProcessor)</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:     <span class="comment">// åˆ›å»º ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"> <span class="number">25</span>:     <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor = <span class="keyword">new</span> AcceptorExecutor&lt;&gt;(</div><div class="line"> <span class="number">26</span>:             id, maxBufferSize, workloadSize, maxBatchingDelay, congestionRetryDelayMs, networkFailureRetryMs</div><div class="line"> <span class="number">27</span>:     );</div><div class="line"> <span class="number">28</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"> <span class="number">29</span>:     <span class="keyword">final</span> TaskExecutors&lt;ID, T&gt; taskExecutor = TaskExecutors.batchExecutors(id, workerCount, taskProcessor, acceptorExecutor);</div><div class="line"> <span class="number">30</span>:     <span class="comment">// åˆ›å»º æ‰¹é‡ä»»åŠ¡åˆ†å‘å™¨</span></div><div class="line"> <span class="number">31</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TaskDispatcher&lt;ID, T&gt;() &#123;</div><div class="line"> <span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line"> <span class="number">34</span>:             acceptorExecutor.process(id, task, expiryTime);</div><div class="line"> <span class="number">35</span>:         &#125;</div><div class="line"> <span class="number">36</span>: </div><div class="line"> <span class="number">37</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">38</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">39</span>:             acceptorExecutor.shutdown();</div><div class="line"> <span class="number">40</span>:             taskExecutor.shutdown();</div><div class="line"> <span class="number">41</span>:         &#125;</div><div class="line"> <span class="number">42</span>:     &#125;;</div><div class="line"> <span class="number">43</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li>ç¬¬ 1 è‡³ 23 è¡Œ ï¼šæ–¹æ³•å‚æ•°ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li><code>workloadSize</code> å‚æ•°ï¼Œå•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡ã€‚</li><li><code>taskProcessor</code> å‚æ•°ï¼Œ<strong>è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨å®ç°</strong>ã€‚</li></ul></li><li>ç¬¬ 24 è‡³ 27 è¡Œ ï¼šåˆ›å»ºä»»åŠ¡<strong>æ¥æ”¶</strong>æ‰§è¡Œå™¨ã€‚åœ¨ <a href="#">ã€Œ5. åˆ›å»ºä»»åŠ¡æ¥æ”¶å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡</strong>ä»»åŠ¡æ‰§è¡Œå™¨ã€‚åœ¨ <a href="#">ã€Œ6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 30 è‡³ 42 è¡Œ ï¼šåˆ›å»º<strong>æ‰¹é‡</strong>ä»»åŠ¡åˆ†å‘å™¨ã€‚<ul><li>ç¬¬ 32 è‡³ 35 è¡Œ ï¼š<code>#process()</code> æ–¹æ³•çš„å®ç°ï¼Œè°ƒç”¨ <code>AcceptorExecutor#process(...)</code> æ–¹æ³•ï¼Œæäº¤ [ ä»»åŠ¡ç¼–å· , ä»»åŠ¡ , ä»»åŠ¡è¿‡æœŸæ—¶é—´ ] ç»™ä»»åŠ¡åˆ†å‘å™¨å¤„ç†ã€‚</li></ul></li></ul><h2>4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</h2><p>è°ƒç”¨ <code>TaskDispatchers#createNonBatchingTaskDispatcher(...)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å•ä»»åŠ¡</strong>æ‰§è¡Œçš„åˆ†å‘å™¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> id ä»»åŠ¡æ‰§è¡Œå™¨ç¼–å·</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> maxBufferSize å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> maxBatchingDelay æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> congestionRetryDelayMs è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment"> 9:  * <span class="doctag">@param</span> networkFailureRetryMs ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">10:  * <span class="doctag">@param</span> taskProcessor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">11:  * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">12:  * <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">13:  * <span class="doctag">@return</span> å•ä»»åŠ¡æ‰§è¡Œçš„åˆ†å‘å™¨</span></div><div class="line"><span class="comment">14:  */</span></div><div class="line"><span class="number">15</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskDispatcher&lt;ID, T&gt; <span class="title">createNonBatchingTaskDispatcher</span><span class="params">(String id,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">16</span>:                                                                             <span class="keyword">int</span> maxBufferSize,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">17</span>:                                                                             <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">18</span>:                                                                             <span class="keyword">long</span> maxBatchingDelay,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">19</span>:                                                                             <span class="keyword">long</span> congestionRetryDelayMs,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>:                                                                             <span class="keyword">long</span> networkFailureRetryMs,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">21</span>:                                                                             TaskProcessor&lt;T&gt; taskProcessor)</span> </span>&#123;</div><div class="line"><span class="number">22</span>:     <span class="comment">// åˆ›å»º ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor = <span class="keyword">new</span> AcceptorExecutor&lt;&gt;(</div><div class="line"><span class="number">24</span>:             id, maxBufferSize, <span class="comment">/* workloadSize = 1 */</span><span class="number">1</span>, maxBatchingDelay, congestionRetryDelayMs, networkFailureRetryMs</div><div class="line"><span class="number">25</span>:     );</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> TaskExecutors&lt;ID, T&gt; taskExecutor = TaskExecutors.singleItemExecutors(id, workerCount, taskProcessor, acceptorExecutor);</div><div class="line"><span class="number">27</span>:     <span class="keyword">return</span> <span class="keyword">new</span> TaskDispatcher&lt;ID, T&gt;() &#123;</div><div class="line"><span class="number">28</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">29</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line"><span class="number">30</span>:             acceptorExecutor.process(id, task, expiryTime);</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">34</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">35</span>:             acceptorExecutor.shutdown();</div><div class="line"><span class="number">36</span>:             taskExecutor.shutdown();</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li>ç¬¬ 1 è‡³ 21 è¡Œ ï¼šæ–¹æ³•å‚æ•°ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li><s><code>workloadSize</code> å‚æ•°</s>ï¼Œç›¸æ¯” <code>#createBatchingTaskDispatcher(...)</code> å°‘è¿™ä¸ªå‚æ•°ã€‚<strong>åœ¨ç¬¬ 24 è¡Œï¼Œä½ ä¼šå‘ç°è¯¥å‚æ•°ä¼ é€’ç»™ AcceptorExecutor ä½¿ç”¨ 1 å™¢</strong>ã€‚</li><li><code>taskProcessor</code> å‚æ•°ï¼Œ<strong>è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨å®ç°</strong>ã€‚</li></ul></li><li>ç¬¬ 21 è‡³ 25 è¡Œ ï¼šåˆ›å»ºä»»åŠ¡<strong>æ¥æ”¶</strong>æ‰§è¡Œå™¨ã€‚å’Œ <code>#createBatchingTaskDispatcher(...)</code> åªå·® <code>workloadSize = 1</code> å‚æ•°ã€‚åœ¨ <a href="#">ã€Œ5. åˆ›å»ºä»»åŠ¡æ¥æ”¶å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 28 è‡³ 29 è¡Œ ï¼šåˆ›å»º<strong>å•</strong>ä»»åŠ¡æ‰§è¡Œå™¨ã€‚<strong>å’Œ <code>#createBatchingTaskDispatcher(...)</code> å·®åˆ«å¾ˆå¤§</strong>ã€‚<a href="#">ã€Œ6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 30 è‡³ 42 è¡Œ ï¼šåˆ›å»º<strong>å•</strong>ä»»åŠ¡åˆ†å‘å™¨ã€‚å’Œ <code>#createBatchingTaskDispatcher(...)</code> ä¸€æ ·ã€‚</li></ul><h1>5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</h1><p><code>com.netflix.eureka.util.batcher.AcceptorExecutor</code> ï¼Œä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€‚åˆ›å»ºæ„é€ æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">AcceptorExecutor</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AcceptorExecutor.class);</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:      * å¾…æ‰§è¡Œé˜Ÿåˆ—æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment"> 7:      * &#123;<span class="doctag">@link</span> #processingOrder&#125;</span></div><div class="line"><span class="comment"> 8:      */</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBufferSize;</div><div class="line"><span class="number">10</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">11:      * å•ä¸ªæ‰¹é‡ä»»åŠ¡åŒ…å«ä»»åŠ¡æœ€å¤§æ•°é‡</span></div><div class="line"><span class="comment">12:      */</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxBatchingSize;</div><div class="line"><span class="number">14</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">15:      * æ‰¹é‡ä»»åŠ¡ç­‰å¾…æœ€å¤§å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">16:      */</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> maxBatchingDelay;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">20:      * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">21:      */</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"><span class="number">23</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">24:      * æ¥æ”¶ä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">25:      */</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; acceptorQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">28:      * é‡æ–°æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">29:      */</span></div><div class="line"><span class="number">30</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingDeque&lt;TaskHolder&lt;ID, T&gt;&gt; reprocessQueue = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;();</div><div class="line"><span class="number">31</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">32:      * æ¥æ”¶ä»»åŠ¡çº¿ç¨‹</span></div><div class="line"><span class="comment">33:      */</span></div><div class="line"><span class="number">34</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Thread acceptorThread;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">37:      * å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„</span></div><div class="line"><span class="comment">38:      */</span></div><div class="line"><span class="number">39</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ID, TaskHolder&lt;ID, T&gt;&gt; pendingTasks = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="number">40</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">41:      * å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">42:      */</span></div><div class="line"><span class="number">43</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;ID&gt; processingOrder = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">46:      * å•ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">47:      */</span></div><div class="line"><span class="number">48</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Semaphore singleItemWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="number">49</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">50:      * å•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">51:      */</span></div><div class="line"><span class="number">52</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; singleItemWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">55:      * æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">56:      */</span></div><div class="line"><span class="number">57</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Semaphore batchWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="number">58</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">59:      * æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">60:      */</span></div><div class="line"><span class="number">61</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; batchWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"><span class="number">62</span>: </div><div class="line"><span class="number">63</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">64:      * ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></div><div class="line"><span class="comment">65:      */</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">private</span> <span class="keyword">final</span> TrafficShaper trafficShaper;</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:     AcceptorExecutor(String id,</div><div class="line"><span class="number">69</span>:                      <span class="keyword">int</span> maxBufferSize,</div><div class="line"><span class="number">70</span>:                      <span class="keyword">int</span> maxBatchingSize,</div><div class="line"><span class="number">71</span>:                      <span class="keyword">long</span> maxBatchingDelay,</div><div class="line"><span class="number">72</span>:                      <span class="keyword">long</span> congestionRetryDelayMs,</div><div class="line"><span class="number">73</span>:                      <span class="keyword">long</span> networkFailureRetryMs) &#123;</div><div class="line"><span class="number">74</span>:         <span class="keyword">this</span>.maxBufferSize = maxBufferSize;</div><div class="line"><span class="number">75</span>:         <span class="keyword">this</span>.maxBatchingSize = maxBatchingSize;</div><div class="line"><span class="number">76</span>:         <span class="keyword">this</span>.maxBatchingDelay = maxBatchingDelay;</div><div class="line"><span class="number">77</span>: </div><div class="line"><span class="number">78</span>:         <span class="comment">// åˆ›å»º ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></div><div class="line"><span class="number">79</span>:         <span class="keyword">this</span>.trafficShaper = <span class="keyword">new</span> TrafficShaper(congestionRetryDelayMs, networkFailureRetryMs);</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:         <span class="comment">// åˆ›å»º æ¥æ”¶ä»»åŠ¡çº¿ç¨‹</span></div><div class="line"><span class="number">82</span>:         ThreadGroup threadGroup = <span class="keyword">new</span> ThreadGroup(<span class="string">"eurekaTaskExecutors"</span>);</div><div class="line"><span class="number">83</span>:         <span class="keyword">this</span>.acceptorThread = <span class="keyword">new</span> Thread(threadGroup, <span class="keyword">new</span> AcceptorRunner(), <span class="string">"TaskAcceptor-"</span> + id);</div><div class="line"><span class="number">84</span>:         <span class="keyword">this</span>.acceptorThread.setDaemon(<span class="keyword">true</span>);</div><div class="line"><span class="number">85</span>:         <span class="keyword">this</span>.acceptorThread.start();</div><div class="line"><span class="number">86</span>: </div><div class="line"><span class="number">87</span>:         <span class="comment">// TODO ï¼ˆçœç•¥ä»£ç ï¼‰èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line"><span class="number">88</span>:     &#125;</div><div class="line"><span class="number">89</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li>ç¬¬ 5 è‡³ 61 è¡Œ ï¼šå±æ€§ã€‚æ¯”è¾ƒå¤šå“ˆï¼Œè¯·è€å¿ƒç†è§£ã€‚<ul><li>çœ¼å°–å¦‚ä½ ï¼Œä¼šå‘ç° AcceptorExecutor å³å­˜åœ¨å•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>singleItemWorkQueue</code> )ï¼Œåˆå­˜åœ¨æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>batchWorkQueue</code> ) ï¼Œåœ¨ <a href="#">ã€Œ9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘ã€</a> ä¼šè§£ç­”è¿™ä¸ªç–‘æƒ‘ã€‚</li></ul></li><li>ç¬¬ 78 è‡³ 79 è¡Œ ï¼šåˆ›å»ºç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€‚åœ¨ <a href="#">ã€Œ7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€</a> è¯¦ç»†è§£æã€‚</li><li>ç¬¬ 81 è‡³ 85 è¡Œ ï¼š<strong>åˆ›å»ºæ¥æ”¶ä»»åŠ¡çº¿ç¨‹</strong>ã€‚</li></ul><h1>6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</h1><p><code>com.netflix.eureka.util.batcher.TaskExecutors</code> ï¼Œä»»åŠ¡æ‰§è¡Œå™¨ã€‚<strong>å…¶å†…éƒ¨æä¾›åˆ›å»ºå•ä»»åŠ¡å’Œæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨çš„ä¸¤ç§æ–¹æ³•</strong>ã€‚TaskExecutors æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskExecutors</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TaskExecutors.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isShutdown;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * å·¥ä½œçº¿ç¨‹æ± </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Thread&gt; workerThreads;</div><div class="line"></div><div class="line">    TaskExecutors(WorkerRunnableFactory&lt;ID, T&gt; workerRunnableFactory, <span class="keyword">int</span> workerCount, AtomicBoolean isShutdown) &#123;</div><div class="line">        <span class="keyword">this</span>.isShutdown = isShutdown;</div><div class="line">        <span class="keyword">this</span>.workerThreads = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»º å·¥ä½œçº¿ç¨‹æ± </span></div><div class="line">        ThreadGroup threadGroup = <span class="keyword">new</span> ThreadGroup(<span class="string">"eurekaTaskExecutors"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; workerCount; i++) &#123;</div><div class="line">            WorkerRunnable&lt;ID, T&gt; runnable = workerRunnableFactory.create(i);</div><div class="line">            Thread workerThread = <span class="keyword">new</span> Thread(threadGroup, runnable, runnable.getWorkerName());</div><div class="line">            workerThreads.add(workerThread);</div><div class="line">            workerThread.setDaemon(<span class="keyword">true</span>);</div><div class="line">            workerThread.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * åˆ›å»ºå·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">WorkerRunnableFactory</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line">        <span class="function">WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><code>workerThreads</code> å±æ€§ï¼Œå·¥ä½œçº¿ç¨‹<strong>æ± </strong>ã€‚<strong>å·¥ä½œä»»åŠ¡é˜Ÿåˆ—ä¼šè¢«å·¥ä½œçº¿ç¨‹æ± å¹¶å‘æ‹‰å–ï¼Œå¹¶å‘æ‰§è¡Œ</strong>ã€‚</li><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnableFactory</code> ï¼Œåˆ›å»ºå·¥ä½œçº¿ç¨‹å·¥å‚<strong>æ¥å£</strong>ã€‚å•ä»»åŠ¡å’Œæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨çš„å·¥ä½œçº¿ç¨‹å®ç°ä¸åŒï¼Œé€šè¿‡è‡ªå®šä¹‰å·¥å‚å®ç°ç±»åˆ›å»ºã€‚</li></ul><h2>6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</h2><p>è°ƒç”¨ <code>TaskExecutors#batchExecutors(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> name ä»»åŠ¡æ‰§è¡Œå™¨å</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> processor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> acceptorExecutor æ¥æ”¶ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskExecutors&lt;ID, T&gt; <span class="title">batchExecutors</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor,</span></span></div><div class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics = <span class="keyword">new</span> TaskExecutorMetrics(name);</div><div class="line">   <span class="comment">// åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutors&lt;&gt;(<span class="keyword">new</span> WorkerRunnableFactory&lt;ID, T&gt;() &#123; <span class="comment">// æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> BatchWorkerRunnable&lt;&gt;(<span class="string">"TaskBatchingWorker-"</span> + name + <span class="string">'-'</span> + idx <span class="comment">/* çº¿ç¨‹å */</span>, isShutdown, metrics, processor, acceptorExecutor);</div><div class="line">       &#125;</div><div class="line">   &#125;, workerCount, isShutdown);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable.BatchWorkerRunnable</code> ï¼Œæ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹ã€‚</li></ul><h2>6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</h2><p>è°ƒç”¨ <code>TaskExecutors#singleItemExecutors(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> name ä»»åŠ¡æ‰§è¡Œå™¨å</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> workerCount ä»»åŠ¡æ‰§è¡Œå™¨å·¥ä½œçº¿ç¨‹æ•°</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> processor ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> acceptorExecutor æ¥æ”¶ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;ID&gt; ä»»åŠ¡ç¼–å·æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> &lt;T&gt; ä»»åŠ¡æ³›å‹</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> å•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">static</span> &lt;ID, T&gt; <span class="function">TaskExecutors&lt;ID, T&gt; <span class="title">singleItemExecutors</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">int</span> workerCount,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor,</span></span></div><div class="line"><span class="function"><span class="params">                                                       <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; acceptorExecutor)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics = <span class="keyword">new</span> TaskExecutorMetrics(name);</div><div class="line">   <span class="comment">// åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutors&lt;&gt;(<span class="keyword">new</span> WorkerRunnableFactory&lt;ID, T&gt;() &#123; <span class="comment">// å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹å·¥å‚</span></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> WorkerRunnable&lt;ID, T&gt; <span class="title">create</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> SingleTaskWorkerRunnable&lt;&gt;(<span class="string">"TaskNonBatchingWorker-"</span> + name + <span class="string">'-'</span> + idx <span class="comment">/* çº¿ç¨‹å */</span>, isShutdown, metrics, processor, acceptorExecutor);</div><div class="line">       &#125;</div><div class="line">   &#125;, workerCount, isShutdown);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable.SingleTaskWorkerRunnable</code> ï¼Œå•ä»»åŠ¡å·¥ä½œçº¿ç¨‹ã€‚</li></ul><h2>6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</h2><p><code>com.netflix.eureka.util.batcher.TaskExecutors.WorkerRunnable</code> ï¼Œä»»åŠ¡å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»ã€‚BatchWorkerRunnable å’Œ SingleTaskWorkerRunnable éƒ½å®ç°è¯¥ç±»ï¼Œå·®å¼‚åœ¨ <code>#run()</code> çš„è‡ªå®šä¹‰å®ç°ã€‚WorkerRunnable å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * çº¿ç¨‹å</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> String workerName;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * æ˜¯å¦å…³é—­</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> AtomicBoolean isShutdown;</div><div class="line">   <span class="keyword">final</span> TaskExecutorMetrics metrics;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡å¤„ç†å™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> TaskProcessor&lt;T&gt; processor;</div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">final</span> AcceptorExecutor&lt;ID, T&gt; taskDispatcher;</div><div class="line">   </div><div class="line">   <span class="comment">// ... çœç•¥æ„é€ æ–¹æ³•å’Œ getting æ–¹æ³•ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h1>7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</h1><p><code>com.netflix.eureka.util.batcher.TrafficShaper</code> ï¼Œç½‘ç»œé€šä¿¡æ•´å½¢å™¨ã€‚å½“ä»»åŠ¡æ‰§è¡Œå‘ç”Ÿè¯·æ±‚é™æµï¼Œæˆ–æ˜¯è¯·æ±‚ç½‘ç»œå¤±è´¥çš„æƒ…å†µï¼Œåˆ™å»¶æ—¶ AcceptorRunner å°†ä»»åŠ¡æäº¤åˆ°å·¥ä½œä»»åŠ¡é˜Ÿåˆ—ï¼Œä»è€Œé¿å…ä»»åŠ¡å¾ˆå¿«å»æ‰§è¡Œï¼Œå†æ¬¡å‘ç”Ÿä¸Šè¿°æƒ…å†µã€‚TrafficShaper å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrafficShaper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Upper bound on delay provided by configuration.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_DELAY = <span class="number">30</span> * <span class="number">1000</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è¯·æ±‚é™æµå»¶è¿Ÿé‡è¯•æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> congestionRetryDelayMs;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ç½‘ç»œå¤±è´¥å»¶è¿Ÿé‡è¯•æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> networkFailureRetryMs;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åè¯·æ±‚é™æµæ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastCongestionError;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * æœ€åç½‘ç»œå¤±è´¥æ—¶é—´æˆ³ï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastNetworkFailure;</div><div class="line"></div><div class="line">    TrafficShaper(<span class="keyword">long</span> congestionRetryDelayMs, <span class="keyword">long</span> networkFailureRetryMs) &#123;</div><div class="line">        <span class="keyword">this</span>.congestionRetryDelayMs = Math.min(MAX_DELAY, congestionRetryDelayMs);</div><div class="line">        <span class="keyword">this</span>.networkFailureRetryMs = Math.min(MAX_DELAY, networkFailureRetryMs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerFailure</span><span class="params">(ProcessingResult processingResult)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (processingResult == ProcessingResult.Congestion) &#123;</div><div class="line">            lastCongestionError = System.currentTimeMillis();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processingResult == ProcessingResult.TransientError) &#123;</div><div class="line">            lastNetworkFailure = System.currentTimeMillis();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * è®¡ç®—æäº¤å»¶è¿Ÿï¼Œå•ä½ï¼šæ¯«ç§’</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> å»¶è¿Ÿ</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">long</span> <span class="title">transmissionDelay</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// æ— å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastCongestionError == -<span class="number">1</span> &amp;&amp; lastNetworkFailure == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// è®¡ç®—æœ€åè¯·æ±‚é™æµå¸¦æ¥çš„å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastCongestionError != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">long</span> congestionDelay = now - lastCongestionError;</div><div class="line">            <span class="keyword">if</span> (congestionDelay &gt;= <span class="number">0</span> &amp;&amp; congestionDelay &lt; congestionRetryDelayMs) &#123; <span class="comment">// èŒƒå›´å†…</span></div><div class="line">                <span class="keyword">return</span> congestionRetryDelayMs - congestionDelay; <span class="comment">// è¡¥å……å»¶è¿Ÿ</span></div><div class="line">            &#125;</div><div class="line">            lastCongestionError = -<span class="number">1</span>; <span class="comment">// é‡ç½®æ—¶é—´æˆ³</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// è®¡ç®—æœ€åç½‘ç»œå¤±è´¥å¸¦æ¥çš„å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">if</span> (lastNetworkFailure != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">long</span> failureDelay = now - lastNetworkFailure;</div><div class="line">            <span class="keyword">if</span> (failureDelay &gt;= <span class="number">0</span> &amp;&amp; failureDelay &lt; networkFailureRetryMs) &#123; <span class="comment">// èŒƒå›´å†…</span></div><div class="line">                <span class="keyword">return</span> networkFailureRetryMs - failureDelay; <span class="comment">// è¡¥å……å»¶è¿Ÿ</span></div><div class="line">            &#125;</div><div class="line">            lastNetworkFailure = -<span class="number">1</span>; <span class="comment">// é‡ç½®æ—¶é—´æˆ³</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// æ— å»¶è¿Ÿ</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><code>#registerFailure(...)</code> ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œæäº¤ä»»åŠ¡ç»“æœç»™ TrafficShaper ï¼Œè®°å½•å‘ç”Ÿæ—¶é—´ã€‚åœ¨ <a href="#">ã€Œ10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘ã€</a> ä¼šçœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li><li><code>#transmissionDelay(...)</code> ï¼Œè®¡ç®—æäº¤å»¶è¿Ÿï¼Œå•ä½ï¼šæ¯«ç§’ã€‚<a href="#">ã€Œ9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘ã€</a> ä¼šçœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li></ul><h1>8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</h1><p>è°ƒç”¨ <code>AcceptorExecutor#process(...)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»åŠ¡åˆ°æ¥æ”¶ä»»åŠ¡é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AcceptorExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ID id, T task, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</div><div class="line">   acceptorQueue.add(<span class="keyword">new</span> TaskHolder&lt;ID, T&gt;(id, task, expiryTime));</div><div class="line">   acceptedTasks++;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><p><code>com.netflix.eureka.util.batcher.TaskHolder</code> ï¼Œä»»åŠ¡æŒæœ‰è€…ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskHolder</span>&lt;<span class="title">ID</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡ç¼–å·</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ID id;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T task;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡è¿‡æœŸæ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> expiryTime;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ä»»åŠ¡æäº¤æ—¶é—´æˆ³</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> submitTimestamp;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li></ul><h1>9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</h1><p>åå°çº¿ç¨‹æ‰§è¡Œ <code>AcceptorRunner#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">long</span> scheduleTime = <span class="number">0</span>;</div><div class="line"> <span class="number">4</span>:     <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line"> <span class="number">5</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:             <span class="comment">// å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )</span></div><div class="line"> <span class="number">7</span>:             drainInputQueues();</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:             <span class="comment">// å¾…æ‰§è¡Œä»»åŠ¡æ•°é‡</span></div><div class="line"><span class="number">10</span>:             <span class="keyword">int</span> totalItems = processingOrder.size();</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:             <span class="comment">// è®¡ç®—è°ƒåº¦æ—¶é—´</span></div><div class="line"><span class="number">13</span>:             <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (scheduleTime &lt; now) &#123;</div><div class="line"><span class="number">15</span>:                 scheduleTime = now + trafficShaper.transmissionDelay();</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:             <span class="comment">// è°ƒåº¦</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (scheduleTime &lt;= now) &#123;</div><div class="line"><span class="number">20</span>:                 <span class="comment">// è°ƒåº¦æ‰¹é‡ä»»åŠ¡</span></div><div class="line"><span class="number">21</span>:                 assignBatchWork();</div><div class="line"><span class="number">22</span>:                 <span class="comment">// è°ƒåº¦å•ä»»åŠ¡</span></div><div class="line"><span class="number">23</span>:                 assignSingleItemWork();</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:             <span class="comment">// 1ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨æ— ä»»åŠ¡è¯·æ±‚ï¼Œæ­£åœ¨å¿™ç¢Œå¤„ç†ä¹‹å‰çš„ä»»åŠ¡ï¼›æˆ–è€… 2ï¼‰ä»»åŠ¡å»¶è¿Ÿè°ƒåº¦ã€‚ç¡çœ  10 ç§’ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</span></div><div class="line"><span class="number">27</span>:             <span class="comment">// If no worker is requesting data or there is a delay injected by the traffic shaper,</span></div><div class="line"><span class="number">28</span>:             <span class="comment">// sleep for some time to avoid tight loop.</span></div><div class="line"><span class="number">29</span>:             <span class="keyword">if</span> (totalItems == processingOrder.size()) &#123;</div><div class="line"><span class="number">30</span>:                 Thread.sleep(<span class="number">10</span>);</div><div class="line"><span class="number">31</span>:             &#125;</div><div class="line"><span class="number">32</span>:         &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line"><span class="number">33</span>:             <span class="comment">// Ignore</span></div><div class="line"><span class="number">34</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">35</span>:             <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line"><span class="number">36</span>:             logger.warn(<span class="string">"Discovery AcceptorThread error"</span>, e);</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šæ— é™å¾ªç¯æ‰§è¡Œè°ƒåº¦ï¼Œç›´åˆ°å…³é—­ã€‚</p></li><li><p>ç¬¬ 6 è‡³ 7 è¡Œ ï¼šè°ƒç”¨ <code>#drainInputQueues()</code> æ–¹æ³•ï¼Œ<strong>å¾ªç¯</strong>å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )ï¼Œ<strong>ç›´åˆ°</strong>æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainInputQueues</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// å¤„ç†å®Œé‡æ–°æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line"> <span class="number">4</span>:         drainReprocessQueue();</div><div class="line"> <span class="number">5</span>:         <span class="comment">// å¤„ç†å®Œæ¥æ”¶é˜Ÿåˆ—</span></div><div class="line"> <span class="number">6</span>:         drainAcceptorQueue();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾… 10 msï¼Œçœ‹æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æœ‰æ–°ä»»åŠ¡</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (!isShutdown.get()) &#123;</div><div class="line"><span class="number">10</span>:             <span class="comment">// If all queues are empty, block for a while on the acceptor queue</span></div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (reprocessQueue.isEmpty() &amp;&amp; acceptorQueue.isEmpty() &amp;&amp; pendingTasks.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:                 TaskHolder&lt;ID, T&gt; taskHolder = acceptorQueue.poll(<span class="number">10</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (taskHolder != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">14</span>:                     appendTaskHolder(taskHolder);</div><div class="line"><span class="number">15</span>:                 &#125;</div><div class="line"><span class="number">16</span>:             &#125;</div><div class="line"><span class="number">17</span>:         &#125;</div><div class="line"><span class="number">18</span>:     &#125; <span class="keyword">while</span> (!reprocessQueue.isEmpty() || !acceptorQueue.isEmpty() || pendingTasks.isEmpty()); <span class="comment">// å¤„ç†å®Œè¾“å…¥é˜Ÿåˆ—( æ¥æ”¶é˜Ÿåˆ— + é‡æ–°æ‰§è¡Œé˜Ÿåˆ— )</span></div><div class="line"><span class="number">19</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>ç¬¬ 2 è¡Œ &amp;&amp; ç¬¬ 18 è¡Œ ï¼š<strong>å¾ªç¯</strong>ï¼Œç›´åˆ°<strong>åŒæ—¶</strong>æ»¡è¶³å¦‚ä¸‹å…¨éƒ¨æ¡ä»¶ï¼š</p><ul><li>é‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>reprocessQueue</code> ) å’Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ä¸ºç©º</li><li>å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„( <code>pendingTasks</code> )<strong>ä¸ä¸ºç©º</strong></li></ul></li><li><p>ç¬¬ 3 è‡³ 4 è¡Œ ï¼šå¤„ç†å®Œé‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>reprocessQueue</code> )ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainReprocessQueue</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">3</span>:     <span class="keyword">while</span> (!reprocessQueue.isEmpty() &amp;&amp; !isFull()) &#123;</div><div class="line"> <span class="number">4</span>:         TaskHolder&lt;ID, T&gt; taskHolder = reprocessQueue.pollLast(); <span class="comment">// ä¼˜å…ˆæ‹¿è¾ƒæ–°çš„ä»»åŠ¡</span></div><div class="line"> <span class="number">5</span>:         ID id = taskHolder.getId();</div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (taskHolder.getExpiryTime() &lt;= now) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"> <span class="number">7</span>:             expiredTasks++;</div><div class="line"> <span class="number">8</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pendingTasks.containsKey(id)) &#123; <span class="comment">// å·²å­˜åœ¨</span></div><div class="line"> <span class="number">9</span>:             overriddenTasks++;</div><div class="line"><span class="number">10</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">11</span>:             pendingTasks.put(id, taskHolder);</div><div class="line"><span class="number">12</span>:             processingOrder.addFirst(id); <span class="comment">// æäº¤åˆ°é˜Ÿå¤´</span></div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;</div><div class="line"><span class="number">15</span>:     <span class="comment">// å¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œæ¸…ç©ºé‡æ–°æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (isFull()) &#123;</div><div class="line"><span class="number">17</span>:         queueOverflows += reprocessQueue.size();</div><div class="line"><span class="number">18</span>:         reprocessQueue.clear();</div><div class="line"><span class="number">19</span>:     &#125;</div><div class="line"><span class="number">20</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li>ç¬¬ 4 è¡Œ ï¼šä¼˜å…ˆä»é‡æ–°æ‰§è¡Œä»»åŠ¡çš„é˜Ÿå°¾æ‹¿è¾ƒæ–°çš„ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¿ç•™æ›´æ–°çš„ä»»åŠ¡åœ¨å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„( <code>pendingTasks</code> ) é‡Œã€‚</li><li>ç¬¬ 12 è¡Œ ï¼šæ·»åŠ ä»»åŠ¡ç¼–å·åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> ) çš„å¤´éƒ¨ã€‚æ•ˆæœå¦‚ä¸‹å›¾ï¼š<img src="http://www.iocoder.cn/images/Eureka/2018_07_17/03.png" alt=""></li><li>ç¬¬ 15 è‡³ 18 è¡Œ ï¼šå¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—( <code>pendingTasks</code> )å·²æ»¡ï¼Œæ¸…ç©ºé‡æ–°æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡ã€‚</li></ul></li><li><p>ç¬¬ 5 è‡³ 6 è¡Œ ï¼šå¤„ç†å®Œæ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> )ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drainAcceptorQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">while</span> (!acceptorQueue.isEmpty()) &#123; <span class="comment">// å¾ªç¯ï¼Œç›´åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">      appendTaskHolder(acceptorQueue.poll());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTaskHolder</span><span class="params">(TaskHolder&lt;ID, T&gt; taskHolder)</span> </span>&#123;</div><div class="line">  <span class="comment">// å¦‚æœå¾…æ‰§è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œç§»é™¤å¾…å¤„ç†é˜Ÿåˆ—ï¼Œæ”¾å¼ƒè¾ƒæ—©çš„ä»»åŠ¡</span></div><div class="line">  <span class="keyword">if</span> (isFull()) &#123;</div><div class="line">      pendingTasks.remove(processingOrder.poll());</div><div class="line">      queueOverflows++;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// æ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">  TaskHolder&lt;ID, T&gt; previousTask = pendingTasks.put(taskHolder.getId(), taskHolder);</div><div class="line">  <span class="keyword">if</span> (previousTask == <span class="keyword">null</span>) &#123;</div><div class="line">      processingOrder.add(taskHolder.getId());</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      overriddenTasks++;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li><li><p>ç¬¬ 8 è‡³ 17 è¡Œ ï¼šå½“æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡ä»æ¥æ”¶é˜Ÿåˆ—( <code>acceptorQueue</code> ) æ‹‰å–ä»»åŠ¡ 10 msã€‚è‹¥æ‹‰å–åˆ°ï¼Œæ·»åŠ åˆ°å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )ã€‚</p></li></ul></li><li><p>ç¬¬ 12 è‡³ 16 è¡Œ ï¼šè®¡ç®—å¯è°ƒåº¦ä»»åŠ¡çš„æœ€å°æ—¶é—´( <code>scheduleTime</code> )ã€‚</p><ul><li>å½“ <code>scheduleTime</code> å°äºå½“å‰æ—¶é—´ï¼Œä¸é‡æ–°è®¡ç®—ï¼Œå³æ­¤æ—¶éœ€è¦å»¶è¿Ÿç­‰å¾…è°ƒåº¦ã€‚</li><li>å½“ <code>scheduleTime</code> å¤§äºç­‰äºå½“å‰æ—¶é—´ï¼Œé…åˆ <code>TrafficShaper#transmissionDelay(...)</code> é‡æ–°è®¡ç®—ã€‚</li></ul></li><li><p>ç¬¬ 19 è¡Œ ï¼šå½“ <code>scheduleTime</code> å°äºå½“å‰æ—¶é—´ï¼Œæ‰§è¡Œä»»åŠ¡çš„è°ƒåº¦ã€‚</p></li><li><p>ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ <code>#assignBatchWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦æ‰¹é‡ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">assignBatchWork</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (hasEnoughTasksForNextBatch()) &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// è·å– æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (batchWorkRequests.tryAcquire(<span class="number">1</span>)) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="comment">// è·å–æ‰¹é‡ä»»åŠ¡</span></div><div class="line"> <span class="number">6</span>:             <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">7</span>:             <span class="keyword">int</span> len = Math.min(maxBatchingSize, processingOrder.size());</div><div class="line"> <span class="number">8</span>:             List&lt;TaskHolder&lt;ID, T&gt;&gt; holders = <span class="keyword">new</span> ArrayList&lt;&gt;(len);</div><div class="line"> <span class="number">9</span>:             <span class="keyword">while</span> (holders.size() &lt; len &amp;&amp; !processingOrder.isEmpty()) &#123;</div><div class="line"><span class="number">10</span>:                 ID id = processingOrder.poll();</div><div class="line"><span class="number">11</span>:                 TaskHolder&lt;ID, T&gt; holder = pendingTasks.remove(id);</div><div class="line"><span class="number">12</span>:                 <span class="keyword">if</span> (holder.getExpiryTime() &gt; now) &#123; <span class="comment">// è¿‡æœŸ</span></div><div class="line"><span class="number">13</span>:                     holders.add(holder);</div><div class="line"><span class="number">14</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">15</span>:                     expiredTasks++;</div><div class="line"><span class="number">16</span>:                 &#125;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>:             <span class="comment">//</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">if</span> (holders.isEmpty()) &#123; <span class="comment">// æœªè°ƒåº¦åˆ°æ‰¹é‡ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="number">20</span>:                 batchWorkRequests.release();</div><div class="line"><span class="number">21</span>:             &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ·»åŠ æ‰¹é‡ä»»åŠ¡åˆ°æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="number">22</span>:                 batchSizeMetric.record(holders.size(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">23</span>:                 batchWorkQueue.add(holders);</div><div class="line"><span class="number">24</span>:             &#125;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ <code>#hasEnoughTasksForNextBatch()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿä»»åŠ¡è¿›è¡Œä¸‹ä¸€æ¬¡æ‰¹é‡ä»»åŠ¡è°ƒåº¦ï¼š1ï¼‰å¾…æ‰§è¡Œä»»åŠ¡( <code>processingOrder</code> )æ˜ å°„å·²æ»¡ï¼›æˆ–è€… 2ï¼‰åˆ°è¾¾æ‰¹é‡ä»»åŠ¡å¤„ç†æœ€å¤§ç­‰å¾…å»¶è¿Ÿã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasEnoughTasksForNextBatch</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">    <span class="keyword">if</span> (processingOrder.isEmpty()) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å¾…æ‰§è¡Œä»»åŠ¡æ˜ å°„å·²æ»¡</span></div><div class="line">    <span class="keyword">if</span> (pendingTasks.size() &gt;= maxBufferSize) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ°è¾¾æ‰¹é‡ä»»åŠ¡å¤„ç†æœ€å¤§ç­‰å¾…å»¶è¿Ÿ( é€šè¿‡å¾…å¤„ç†é˜Ÿåˆ—çš„å¤´éƒ¨ä»»åŠ¡åˆ¤æ–­ )</span></div><div class="line">    TaskHolder&lt;ID, T&gt; nextHolder = pendingTasks.get(processingOrder.peek());</div><div class="line">    <span class="keyword">long</span> delay = System.currentTimeMillis() - nextHolder.getSubmitTimestamp();</div><div class="line">    <span class="keyword">return</span> delay &gt;= maxBatchingDelay;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>x</li></ul></li><li><p>ç¬¬ 5 è‡³ 17 è¡Œ ï¼šè·å–æ‰¹é‡ä»»åŠ¡( <code>holders</code> )ã€‚ğŸ˜ˆ ä½ ä¼šå‘ç°ï¼Œæœ¬æ–‡è¯´äº†åŠå¤©çš„æ‰¹é‡ä»»åŠ¡ï¼Œå®é™…æ˜¯ <code>List&lt;TaskHolder&lt;ID, T&gt;&gt;</code> å“ˆã€‚</p></li><li><p>ç¬¬ 4 è¡Œ ï¼šè·å–æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡( <code>batchWorkRequests</code> ) ã€‚åœ¨ä»»åŠ¡æ‰§è¡Œå™¨çš„æ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œå‘å‡º <code>batchWorkRequests</code> ã€‚<strong>æ¯ä¸€ä¸ªä¿¡å·é‡éœ€è¦ä¿è¯è·å–åˆ°ä¸€ä¸ªæ‰¹é‡ä»»åŠ¡</strong>ã€‚</p></li><li><p>ç¬¬ 19 è‡³ 20 è¡Œ ï¼šæœªè°ƒåº¦åˆ°æ‰¹é‡ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡ï¼Œ<strong>ä»£è¡¨è¯·æ±‚å®é™…æœªå®Œæˆï¼Œæ¯ä¸€ä¸ªä¿¡å·é‡éœ€è¦ä¿è¯è·å–åˆ°ä¸€ä¸ªæ‰¹é‡ä»»åŠ¡</strong>ã€‚</p></li><li><p>ç¬¬ 21 è‡³ 24 è¡Œ ï¼šæ·»åŠ æ‰¹é‡ä»»åŠ¡åˆ°æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—ã€‚</p></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#assignSingleItemWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦å•ä»»åŠ¡ã€‚</p></li></ul></li><li><p>ç¬¬ 23 è¡Œ ï¼šè°ƒç”¨ <code>#assignSingleItemWork()</code> æ–¹æ³•ï¼Œè°ƒåº¦å•ä»»åŠ¡ï¼Œå’Œ <code>#assignBatchWork()</code> æ–¹æ³•<strong>ç±»ä¼¼</strong>ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">assignSingleItemWork</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!processingOrder.isEmpty()) &#123; <span class="comment">// å¾…æ‰§è¡Œä»»é˜Ÿåˆ—ä¸ä¸ºç©º</span></div><div class="line">      <span class="comment">// è·å– å•ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line">      <span class="keyword">if</span> (singleItemWorkRequests.tryAcquire(<span class="number">1</span>)) &#123;</div><div class="line">          <span class="comment">// ã€å¾ªç¯ã€‘è·å–å•ä»»åŠ¡</span></div><div class="line">          <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">          <span class="keyword">while</span> (!processingOrder.isEmpty()) &#123;</div><div class="line">              ID id = processingOrder.poll(); <span class="comment">// ä¸€å®šä¸ä¸ºç©º</span></div><div class="line">              TaskHolder&lt;ID, T&gt; holder = pendingTasks.remove(id);</div><div class="line">              <span class="keyword">if</span> (holder.getExpiryTime() &gt; now) &#123;</div><div class="line">                  singleItemWorkQueue.add(holder);</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">              expiredTasks++;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// è·å–ä¸åˆ°å•ä»»åŠ¡ï¼Œé‡Šæ”¾è¯·æ±‚ä¿¡å·é‡</span></div><div class="line">          singleItemWorkRequests.release();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>x</li></ul></li><li><p>ç¬¬ 26 è‡³ 31 è¡Œ ï¼šå½“è°ƒåº¦ä»»åŠ¡å‰çš„å¾…æ‰§è¡Œä»»åŠ¡æ•°( <code>totalItems</code> )ç­‰äºå½“å‰å¾…æ‰§è¡Œé˜Ÿåˆ—( <code>processingOrder</code> )çš„ä»»åŠ¡æ•°ï¼Œæ„å‘³ç€ï¼š1ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨æ— ä»»åŠ¡è¯·æ±‚ï¼Œæ­£åœ¨å¿™ç¢Œå¤„ç†ä¹‹å‰çš„ä»»åŠ¡ï¼›æˆ–è€… 2ï¼‰ä»»åŠ¡å»¶è¿Ÿè°ƒåº¦ã€‚ç¡çœ  10 ç§’ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p></li></ul><h1>10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</h1><h2>10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</h2><p>æ‰¹é‡ä»»åŠ¡å·¥ä½œåå°çº¿ç¨‹( BatchWorkerRunnable )æ‰§è¡Œ <code>#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// </span></div><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line">  <span class="number">4</span>:         <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line">  <span class="number">5</span>:             <span class="comment">// è·å–æ‰¹é‡ä»»åŠ¡</span></div><div class="line">  <span class="number">6</span>:             List&lt;TaskHolder&lt;ID, T&gt;&gt; holders = getWork();</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">  <span class="number">9</span>:             metrics.registerExpiryTimes(holders);</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:             <span class="comment">// è·å¾—å®é™…æ‰¹é‡ä»»åŠ¡</span></div><div class="line"> <span class="number">12</span>:             List&lt;T&gt; tasks = getTasksOf(holders);</div><div class="line"> <span class="number">13</span>:             <span class="comment">// è°ƒç”¨å¤„ç†å™¨æ‰§è¡Œä»»åŠ¡</span></div><div class="line"> <span class="number">14</span>:             ProcessingResult result = processor.process(tasks);</div><div class="line"> <span class="number">15</span>:             <span class="keyword">switch</span> (result) &#123;</div><div class="line"> <span class="number">16</span>:                 <span class="keyword">case</span> Success:</div><div class="line"> <span class="number">17</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">case</span> Congestion:</div><div class="line"> <span class="number">19</span>:                 <span class="keyword">case</span> TransientError:</div><div class="line"> <span class="number">20</span>:                     taskDispatcher.reprocess(holders, result); <span class="comment">// æäº¤é‡æ–°å¤„ç†</span></div><div class="line"> <span class="number">21</span>:                     <span class="keyword">break</span>;</div><div class="line"> <span class="number">22</span>:                 <span class="keyword">case</span> PermanentError:</div><div class="line"> <span class="number">23</span>:                     logger.warn(<span class="string">"Discarding &#123;&#125; tasks of &#123;&#125; due to permanent error"</span>, holders.size(), workerName);</div><div class="line"> <span class="number">24</span>:             &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:             <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line"> <span class="number">27</span>:             metrics.registerTaskResult(result, tasks.size());</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">30</span>:         <span class="comment">// Ignore</span></div><div class="line"> <span class="number">31</span>:     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">32</span>:         <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line"> <span class="number">33</span>:         logger.warn(<span class="string">"Discovery WorkerThread error"</span>, e);</div><div class="line"> <span class="number">34</span>:     &#125;</div><div class="line"> <span class="number">35</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>ç¬¬ 4 è¡Œ ï¼šæ— é™å¾ªç¯æ‰§è¡Œè°ƒåº¦ï¼Œç›´åˆ°å…³é—­ã€‚</p></li><li><p>ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ <code>getWork()</code> æ–¹æ³•ï¼Œè·å–<strong>ä¸€ä¸ª</strong>æ‰¹é‡ä»»åŠ¡ç›´åˆ°æˆåŠŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">private</span> List&lt;TaskHolder&lt;ID, T&gt;&gt; getWork() <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// å‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—æ‰¹é‡ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"> <span class="number">3</span>:     BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; workQueue = taskDispatcher.requestWorkItems();</div><div class="line"> <span class="number">4</span>:     <span class="comment">// ã€å¾ªç¯ã€‘è·å–æ‰¹é‡ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line"> <span class="number">5</span>:     List&lt;TaskHolder&lt;ID, T&gt;&gt; result;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">7</span>:         result = workQueue.poll(<span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line"> <span class="number">8</span>:     &#125; <span class="keyword">while</span> (!isShutdown.get() &amp;&amp; result == <span class="keyword">null</span>);</div><div class="line"> <span class="number">9</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">10</span>: &#125;</div></pre></td></tr></table></figure><p></p><ul><li><p>ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ <code>TaskDispatcher#requestWorkItems()</code> æ–¹æ³•ï¼Œå‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—æ‰¹é‡ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TaskDispatcher.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰¹é‡ä»»åŠ¡å·¥ä½œè¯·æ±‚ä¿¡å·é‡</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Semaphore batchWorkRequests = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* æ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; batchWorkQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">BlockingQueue&lt;List&lt;TaskHolder&lt;ID, T&gt;&gt;&gt; requestWorkItems() &#123;</div><div class="line">   batchWorkRequests.release();</div><div class="line">   <span class="keyword">return</span> batchWorkQueue;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li><strong>æ³¨æ„</strong>ï¼Œæ‰¹é‡ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>batchWorkQueue</code> ) å’Œå•ä»»åŠ¡å·¥ä½œé˜Ÿåˆ—( <code>singleItemWorkQueue</code> ) æ˜¯<strong>ä¸åŒçš„é˜Ÿåˆ—</strong>ã€‚</li></ul></li><li><p>ç¬¬ 5 è‡³ 8 è¡Œ ï¼š<strong>å¾ªç¯</strong>è·å–<strong>ä¸€ä¸ª</strong>æ‰¹é‡ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸã€‚</p></li></ul></li><li><p>ç¬¬ 12 è¡Œ ï¼šè°ƒç”¨ <code>#getTasksOf(...)</code> æ–¹æ³•ï¼Œè·å¾—<strong>å®é™…</strong>æ‰¹é‡ä»»åŠ¡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;T&gt; <span class="title">getTasksOf</span><span class="params">(List&lt;TaskHolder&lt;ID, T&gt;&gt; holders)</span> </span>&#123;</div><div class="line">    List&lt;T&gt; tasks = <span class="keyword">new</span> ArrayList&lt;&gt;(holders.size());</div><div class="line">    <span class="keyword">for</span> (TaskHolder&lt;ID, T&gt; holder : holders) &#123;</div><div class="line">        tasks.add(holder.getTask());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> tasks;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>x</li></ul></li><li><p>ç¬¬ 14 è‡³ 24 è¡Œ ï¼šè°ƒç”¨å¤„ç†å™¨( TaskProcessor ) æ‰§è¡Œä»»åŠ¡ã€‚å½“ä»»åŠ¡æ‰§è¡Œç»“æœä¸º <code>Congestion</code> æˆ– <code>TransientError</code> ï¼Œè°ƒç”¨ <code>AcceptorExecutor#reprocess(...)</code> æäº¤<strong>æ•´ä¸ªæ‰¹é‡ä»»åŠ¡</strong>é‡æ–°å¤„ç†ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AcceptorExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">reprocess</span><span class="params">(List&lt;TaskHolder&lt;ID, T&gt;&gt; holders, ProcessingResult processingResult)</span> </span>&#123;</div><div class="line">   <span class="comment">// æ·»åŠ åˆ° é‡æ–°æ‰§è¡Œé˜Ÿåˆ—</span></div><div class="line">   reprocessQueue.addAll(holders);</div><div class="line"></div><div class="line">   <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">   replayedTasks += holders.size();</div><div class="line">   </div><div class="line">   <span class="comment">// æäº¤ä»»åŠ¡ç»“æœç»™ TrafficShaper</span></div><div class="line">   trafficShaper.registerFailure(processingResult);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></li></ul><h2>10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</h2><p>å•ä»»åŠ¡å·¥ä½œåå°çº¿ç¨‹( SingleTaskWorkerRunnable )æ‰§è¡Œ <code>#run(...)</code> æ–¹æ³•ï¼Œè°ƒåº¦ä»»åŠ¡ï¼Œå’Œ <code>BatchWorkerRunnable#run(...)</code> åŸºæœ¬ç±»ä¼¼ï¼Œå°±ä¸å•°å—¦äº†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><p></p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// SingleTaskWorkerRunnable.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">while</span> (!isShutdown.get()) &#123;</div><div class="line">          <span class="comment">// å‘èµ·è¯·æ±‚ä¿¡å·é‡ï¼Œå¹¶è·å¾—å•ä»»åŠ¡çš„å·¥ä½œé˜Ÿåˆ—</span></div><div class="line">          BlockingQueue&lt;TaskHolder&lt;ID, T&gt;&gt; workQueue = taskDispatcher.requestWorkItem();</div><div class="line">          TaskHolder&lt;ID, T&gt; taskHolder;</div><div class="line">          <span class="comment">// ã€å¾ªç¯ã€‘è·å–å•ä»»åŠ¡ï¼Œç›´åˆ°æˆåŠŸ</span></div><div class="line">          <span class="keyword">while</span> ((taskHolder = workQueue.poll(<span class="number">1</span>, TimeUnit.SECONDS)) == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (isShutdown.get()) &#123;</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">          metrics.registerExpiryTime(taskHolder);</div><div class="line">          <span class="keyword">if</span> (taskHolder != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="comment">// è°ƒç”¨å¤„ç†å™¨æ‰§è¡Œä»»åŠ¡</span></div><div class="line">              ProcessingResult result = processor.process(taskHolder.getTask());</div><div class="line">              <span class="keyword">switch</span> (result) &#123;</div><div class="line">                  <span class="keyword">case</span> Success:</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> Congestion:</div><div class="line">                  <span class="keyword">case</span> TransientError:</div><div class="line">                      taskDispatcher.reprocess(taskHolder, result); <span class="comment">// æäº¤é‡æ–°å¤„ç†</span></div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> PermanentError:</div><div class="line">                      logger.warn(<span class="string">"Discarding a task of &#123;&#125; due to permanent error"</span>, workerName);</div><div class="line">              &#125;</div><div class="line">              <span class="comment">// TODO èŠ‹è‰¿ï¼šç›‘æ§ç›¸å…³ï¼Œæš‚æ—¶æ— è§†</span></div><div class="line">              metrics.registerTaskResult(result, <span class="number">1</span>);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      <span class="comment">// Ignore</span></div><div class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">      <span class="comment">// Safe-guard, so we never exit this loop in an uncontrolled way.</span></div><div class="line">      logger.warn(<span class="string">"Discovery WorkerThread error"</span>, e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h1>666. å½©è›‹</h1><p><img src="http://www.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="çŸ¥è¯†æ˜Ÿçƒ"></p><p>ğŸ˜ˆ åˆæ˜¯ä¸€ç¯‡é•¿æ–‡ã€‚å»ºè®®è¾¹çœ‹ä»£ç ï¼Œè¾¹å¯¹ç…§ç€æ•´ä½“æµç¨‹å›¾ï¼Œç†è§£å®é™…ä¸éš¾ã€‚</p><p>å½“ç„¶ï¼Œæ¬¢è¿ä½ æœ‰ä»»ä½•ç–‘é—®ï¼Œåœ¨æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç•™è¨€ã€‚</p><p>èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( <strong>èŠ‹é“æºç </strong> ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ</p></div><footer class="article-footer clearfix"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/Eureka/">Eureka</a></div><div class="article-share" id="share"><div data-url="http://www.iocoder.cn/Eureka/batch-tasks/" data-title="Eureka æºç è§£æ â€”â€” ä»»åŠ¡æ‰¹å¤„ç† | èŠ‹é“æºç  â€”â€” çº¯æºç è§£æåšå®¢" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/Eureka/end-point-and-resolver/" title="Eureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨"><strong>PREVIOUS:</strong><br><span>Eureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨</span></a></div><div class="next"><a href="/Eureka/instance-registry-read-write-lock/" title="Eureka æºç è§£æ â€”â€” Eurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”"><strong>NEXT:</strong><br><span>Eureka æºç è§£æ â€”â€” Eurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”</span></a></div></nav></div><div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div><div id="toc" class="toc-aside"><strong class="toc-title">æ–‡ç« ç›®å½•</strong><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. æ•´ä½“æµç¨‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3. ä»»åŠ¡å¤„ç†å™¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. åˆ›å»ºä»»åŠ¡åˆ†å‘å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 æ‰¹é‡ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 å•ä»»åŠ¡æ‰§è¡Œåˆ†å‘å™¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">5. åˆ›å»ºä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">6. åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 åˆ›å»ºæ‰¹é‡ä»»åŠ¡æ‰§è¡Œå™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 åˆ›å»ºå•ä»»åŠ¡æ‰§è¡Œå™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 å·¥ä½œçº¿ç¨‹æŠ½è±¡ç±»</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">7.</span> <span class="toc-text">7. ç½‘ç»œé€šä¿¡æ•´å½¢å™¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">8.</span> <span class="toc-text">8. ä»»åŠ¡æ¥æ”¶æ‰§è¡Œå™¨ã€å¤„ç†ä»»åŠ¡ã€‘</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">9.</span> <span class="toc-text">9. ä»»åŠ¡æ¥æ”¶çº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€‘</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">10.</span> <span class="toc-text">10. ä»»åŠ¡æ‰§è¡Œå™¨ã€æ‰§è¡Œä»»åŠ¡ã€‘</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 æ‰¹é‡ä»»åŠ¡å·¥ä½œçº¿ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 å•ä»»åŠ¡å·¥ä½œçº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">11.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol></div><div id="asidepart"><aside class="clearfix"><div id="authorInfo"><div><img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"></div><div class="social-list"></div></div><div class="categorieslist"><p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·ç¦åˆ©ï¼šèŠ‹é“æºç </p><ul><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">0. é˜…è¯»æºç è‘µèŠ±å®å…¸</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">1. RocketMQ / MyCAT / Sharding-JDBC è¯¦ç»†ä¸­æ–‡æ³¨é‡Šæºç </a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">2. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">3. æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œæ¯å‘¨å…­åç‚¹æ›´æ–°</a></li><li><a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤</a></li></ul></div><div class="categorieslist"><p class="asidetitle">åˆ†ç±»</p><ul><li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li><li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li><li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li><li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li><li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li><li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li><li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li><li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li><li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li><li><a href="/categories/Myth/" title="Myth">Myth<sup>1</sup></a></li><li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li><li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li><li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li><li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li><li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li><li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li><li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li><li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li><li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li><li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li><li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li><li><a href="/categories/å·¥ä½œå†…æ¨/" title="å·¥ä½œå†…æ¨">å·¥ä½œå†…æ¨<sup>5</sup></a></li><li><a href="/categories/æŠ€æœ¯æ‚æ–‡/" title="æŠ€æœ¯æ‚æ–‡">æŠ€æœ¯æ‚æ–‡<sup>5</sup></a></li><li><a href="/categories/æ•°æ®åº“å®ä½“è®¾è®¡/" title="æ•°æ®åº“å®ä½“è®¾è®¡">æ•°æ®åº“å®ä½“è®¾è®¡<sup>1</sup></a></li><li><a href="/categories/èŠ‹é“æºç çš„å‘¨å…«/" title="èŠ‹é“æºç çš„å‘¨å…«">èŠ‹é“æºç çš„å‘¨å…«<sup>9</sup></a></li></ul></div><div id="authorInfo2"><div><img width="100%" src="/images/common/zsxq/02.png"></div></div></aside></div></div><footer><div id="footer"><img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display:none"><p class="copyright">Â© 2018 <a href="http://www.iocoder.cn" target="_blank" title="èŠ‹é“æºç ">èŠ‹é“æºç </a> && <span style="display:inline" id="busuanzi_container_site_uv">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && <span style="display:inline" id="busuanzi_container_site_pv">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv" font="å¾®è½¯é›…é»‘"></span> æ¬¡</span> && Hosted by <a href="https://pages.coding.me" style="font-weight:700" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a></p></div><div class="copyright">æ²ªICPå¤‡17037075å·-1</div></footer><script src="/js/jquery-2.1.0.min.js"></script><script type="text/javascript">$(document).ready(function(){function e(){"number"==typeof window.innerWidth?n=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(n=document.documentElement.clientWidth)}$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var n=0,s=$("#main"),a=$("#asidepart"),o=$(".closeaside"),d=$(".openaside");$(window).resize(function(){e(),n>=1024?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),a.css("display","block").removeClass("fadeOut"),d.css("display","none"),$("#toc.toc-aside").css("display","none"))}),o.click(function(){a.addClass("fadeOut").css("display","none"),d.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),d.click(function(){d.css("display","none").removeClass("beforeFadeIn"),a.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){d.css("top",Math.max(80,260-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var a=$(".article-content>iframe"),t=$(".article-content>embed"),n=$("#toc");$("article h2");ah=$("article h2"),ta=$("#toc.toc-aside"),o=$(".openaside"),c=$(".closeaside"),a.length>0&&a.wrap('<div class="video-container" />'),t.length>0&&t.wrap('<div class="video-container" />'),0==ah.length?n.css("display","none"):(c.click(function(){ta.css("display","block").addClass("fadeIn")}),o.click(function(){ta.css("display","none")}),$(window).scroll(function(){ta.css("top",Math.max(140,320-$(this).scrollTop()))}))})</script><script type="text/javascript">$(document).ready(function(){var t=$(".share"),a=t.attr("data-url"),e=encodeURIComponent(a),r=['<a href="#" class="overlay" id="qrcode"></a>','<div class="qrcode clearfix"><span>æ‰«æäºŒç»´ç åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url='+e+'"/></div>','<a href="#textlogo" class="article-back-to-top" title="Top"></a>','<a href="https://www.facebook.com/sharer.php?u='+e+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>','<a href="https://twitter.com/intent/tweet?url='+e+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="http://service.weibo.com/share/share.php?title='+t.attr("data-title")+"&url="+e+"&ralateUid="+t.attr("data-tsina")+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<span title="Share to"></span>'].join("");t.append(r),$(".article-share-qrcode").click(function(){var t=$("#qrcode-pic").attr("data-src");$("#qrcode-pic").attr("src",t),$("#qrcode-pic").load(function(){$(".qrcode strong").text(" ")})})})</script><link rel="stylesheet" href="/alert/css/alert.css"><script src="/alert/js/alert.js"></script><script src="/js/jquery.cookie.js"></script><script src="/js/util.js"></script><script type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-107572620-1","auto"),ga("send","pageview")</script></body>