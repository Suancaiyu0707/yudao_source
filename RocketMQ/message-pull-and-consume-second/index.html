
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">

    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">

  
    <title>RocketMQ 源码分析 —— Message 拉取与消费（下） | 芋道源码 —— 纯源码解析博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="芋道源码">
    
    <meta name="description" content="摘要: 原创出处 http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/ 「芋道源码」欢迎转载，保留摘要，谢谢！
本文主要基于 RocketMQ 4.0.x 正式版

1、概述
2、Consumer
3、PushConsumer">
    

    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客,Sharding-JDBC,分库分表">
    

    
    
    <link rel="alternate" href="atom.xml" title="芋道源码 —— 纯源码解析博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            var _bdId ='9e70e3362807c1bd185a79655b307027';
             hm.src = "//hm.baidu.com/hm.js?" + _bdId;
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

    <!-- 不蒜子统计 -->
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>
</html>
  <body>
    <header>
      <div>
    
    <div id="textlogo">
        <h1 class="site-name"><a href="/" title="芋道源码 —— 纯源码解析博客">芋道源码 —— 纯源码解析博客</a></h1>
        <a class="blog-motto">
            
            愿半生编码，如一生老友！
            
        </a>
    </div>
    <div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
        </a></div>
    <nav class="animated">
        <ul>
            <ul>
                
                <li><a href="/">文章</a></li>
                
                <li><a href="/2018-meet-you">知识星球</a></li>
                
                <li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li>
                
                <li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">微信公众号</a></li>
                
                <li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">工作内推</a></li>
                
                <li><a href="/link_url">友链</a></li>
                
                <!--<li>-->
                    <!---->
                        <!--<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">-->
                            <!--<label>Search</label>-->
                            <!--<input type="text" id="search" name="q" autocomplete="off" maxlength="20"-->
                                   <!--placeholder="搜索"/>-->
                            <!--<input type="hidden" name="q" value="site:www.iocoder.cn">-->
                        <!--</form>-->
                        <!---->
                <!--</li>-->
            </ul>
    </ul></nav>
</div>

    </header>
    <div id="container">

        <div id="main" class="post" itemscope="" itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/RocketMQ/message-pull-and-consume-second/" title="RocketMQ 源码分析 —— Message 拉取与消费（下）" itemprop="url">RocketMQ 源码分析 —— Message 拉取与消费（下）</a>
  </h1>
  <p class="article-author">
      <!--By-->
    <!---->
      <!--<a href="http://www.iocoder.cn" title="芋道源码">芋道源码</a>-->
    <!---->
  </p>
  <p class="article-time">
    <!--<time datetime="2017-05-10T16:00:00.000Z" itemprop="datePublished">2017-05-11</time>-->
    <!--更新日期:<time datetime="2017-10-12T06:48:56.000Z" itemprop="dateModified">2017-10-12</time>-->
    <!---->
      总阅读量:<span id="busuanzi_value_page_pv"></span>次
  </p>
</header>
	<div class="article-content">
		
		
		<p>摘要: 原创出处 http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/ 「芋道源码」欢迎转载，保留摘要，谢谢！</p>
<p><strong>本文主要基于 RocketMQ 4.0.x 正式版</strong></p>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">1、概述</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">2、Consumer</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">3、PushConsumer 一览</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">4、PushConsumer 订阅</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">DefaultMQPushConsumerImpl#subscribe(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">FilterAPI.buildSubscriptionData(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">DefaultMQPushConsumer#registerMessageListener(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">5、PushConsumer 消息队列分配</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalanceService</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">MQClientInstance#doRebalance(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">DefaultMQPushConsumerImpl#doRebalance(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalanceImpl#doRebalance(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalanceImpl#rebalanceByTopic(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalanceImpl#removeUnnecessaryMessageQueue(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalancePushImpl#dispatchPullRequest(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">AllocateMessageQueueStrategy</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">AllocateMessageQueueAveragely</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">AllocateMessageQueueByMachineRoom</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">AllocateMessageQueueAveragelyByCircle</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">AllocateMessageQueueByConfig</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">5、PushConsumer 消费进度读取</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RebalancePushImpl#computePullFromWhere(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">[PullConsumer] RebalancePullImpl#computePullFromWhere(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">6、PushConsumer 拉取消息</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">PullMessageService</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">DefaultMQPushConsumerImpl#pullMessage(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">PullAPIWrapper#pullKernelImpl(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">PullAPIWrapper#recalculatePullFromWhichNode(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">PullAPIWrapper#processPullResult(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ProcessQueue#putMessage(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">总结</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">6、PushConsumer 消费消息</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ConsumeMessageConcurrentlyService 提交消费请求</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ConsumeRequest</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ProcessQueue#removeMessage(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">ProcessQueue#cleanExpiredMsg(...)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">7、PushConsumer 发回消费失败消息</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">MQClientAPIImpl#consumerSendMessageBack(...)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">8、Consumer 消费进度</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">OffsetStore</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">OffsetStore#load(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">LocalFileOffsetStore#load(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">OffsetSerializeWrapper</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RemoteBrokerOffsetStore#load(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">OffsetStore#readOffset(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">LocalFileOffsetStore#readOffset(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RemoteBrokerOffsetStore#readOffset(...)</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">OffsetStore#updateOffset(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">OffsetStore#persistAll(...)</a>
<ul>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">LocalFileOffsetStore#persistAll(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">RemoteBrokerOffsetStore#persistAll(...)</a></li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">MQClientInstance#persistAllConsumerOffset(...)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/">9、结尾</a></li>
</ul>
<hr>
<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>🙂🙂🙂关注**微信公众号：【芋道源码】**有福利：</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>所有</strong>源码分析文章列表</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>中文注释源码 GitHub 地址</strong></li>
<li>您对于源码的疑问每条留言<strong>都</strong>将得到<strong>认真</strong>回复。<strong>甚至不知道如何读源码也可以请教噢</strong>。</li>
<li><strong>新的</strong>源码解析文章<strong>实时</strong>收到通知。<strong>每周更新一篇左右</strong>。</li>
<li><strong>认真的</strong>源码交流微信群。</li>
</ol>
</blockquote>
<hr>
<h1>1、概述</h1>
<p>本文接：<a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-first/">《RocketMQ 源码分析 —— Message 拉取与消费（上）》</a>。</p>
<p>主要解析 <code>Consumer</code> 在 <strong>消费</strong> 逻辑涉及到的源码。</p>
<h1>2、Consumer</h1>
<p>MQ 提供了两类消费者：</p>
<ul>
<li>PushConsumer：
<ul>
<li>在大多数场景下使用。</li>
<li>名字虽然是 <code>Push</code> 开头，实际在实现时，使用 <code>Pull</code> 方式实现。通过 <code>Pull</code> <strong>不断不断不断</strong>轮询 <code>Broker</code> 获取消息。当不存在新消息时，<code>Broker</code> 会<strong>挂起请求</strong>，直到有新消息产生，取消挂起，返回新消息。这样，基本和 <code>Broker</code> 主动 <code>Push</code> 做到<strong>接近</strong>的实时性（当然，还是有相应的实时性损失）。原理类似 <strong><a href="https://www.ibm.com/developerworks/cn/web/wa-lo-comet/" rel="external nofollow noopener noreferrer" target="_blank">长轮询( <code>Long-Polling</code> )</a></strong>。</li>
</ul>
</li>
<li>PullConsumer</li>
</ul>
<p><strong>本文主要讲解<code>PushConsumer</code>，部分讲解<code>PullConsumer</code>，跳过<code>顺序消费</code>。</strong><br>
<strong>本文主要讲解<code>PushConsumer</code>，部分讲解<code>PullConsumer</code>，跳过<code>顺序消费</code>。</strong><br>
<strong>本文主要讲解<code>PushConsumer</code>，部分讲解<code>PullConsumer</code>，跳过<code>顺序消费</code>。</strong></p>
<h1>3、PushConsumer 一览</h1>
<p>先看一张 <code>PushConsumer</code> 包含的组件以及组件之间的交互图：</p>
<p><img src="http://www.iocoder.cn/images/RocketMQ/2017_05_04/09.png" alt="PushConsumer手绘图.png"></p>
<ul>
<li><code>RebalanceService</code>：均衡消息队列服务，负责分配当前 <code>Consumer</code> 可消费的消息队列( <code>MessageQueue</code> )。当有新的 <code>Consumer</code> 的加入或移除，都会重新分配消息队列。</li>
<li><code>PullMessageService</code>：拉取消息服务，<strong>不断不断不断</strong>从 <code>Broker</code> 拉取消息，并提交消费任务到 <code>ConsumeMessageService</code>。</li>
<li><code>ConsumeMessageService</code>：消费消息服务，<strong>不断不断不断</strong>消费消息，并处理消费结果。</li>
<li><code>RemoteBrokerOffsetStore</code>：<code>Consumer</code> 消费进度管理，负责从 <code>Broker</code> 获取消费进度，同步消费进度到 <code>Broker</code>。</li>
<li><code>ProcessQueue</code> ：消息处理队列。</li>
<li><code>MQClientInstance</code> ：封装对 <code>Namesrv</code>，<code>Broker</code> 的 API调用，提供给 <code>Producer</code>、<code>Consumer</code> 使用。</li>
</ul>
<h1>4、PushConsumer 订阅</h1>
<h2>DefaultMQPushConsumerImpl#subscribe(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(String topic, String subExpression)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">3</span>:         <span class="comment">// 创建订阅数据</span></div><div class="line"> <span class="number">4</span>:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class="comment">//</span></div><div class="line"> <span class="number">5</span>:             topic, subExpression);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</div><div class="line"> <span class="number">7</span>:         <span class="comment">// 通过心跳同步Consumer信息到Broker</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.mQClientFactory != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"subscription exception"</span>, e);</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：订阅 <code>Topic</code> 。</li>
<li>第 3 至 6 行 ：创建订阅数据。详细解析见：<a href="#filterapibuildsubscriptiondata">FilterAPI.buildSubscriptionData(...)</a>。</li>
<li>第 7 至 10 行 ：通过心跳同步 <code>Consumer</code> 信息到 <code>Broker</code>。</li>
</ul>
<h3>FilterAPI.buildSubscriptionData(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SubscriptionData <span class="title">buildSubscriptionData</span><span class="params">(<span class="keyword">final</span> String consumerGroup, String topic,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">2</span>:     String subString)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"> <span class="number">3</span>:     SubscriptionData subscriptionData = <span class="keyword">new</span> SubscriptionData();</div><div class="line"> <span class="number">4</span>:     subscriptionData.setTopic(topic);</div><div class="line"> <span class="number">5</span>:     subscriptionData.setSubString(subString);</div><div class="line"> <span class="number">6</span>:     <span class="comment">// 处理订阅表达式</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">8</span>:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">10</span>:         String[] tags = subString.split(<span class="string">"\\|\\|"</span>);</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (tags.length &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">for</span> (String tag : tags) &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (tag.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:                     String trimString = tag.trim();</div><div class="line"><span class="number">15</span>:                     <span class="keyword">if</span> (trimString.length() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">16</span>:                         subscriptionData.getTagsSet().add(trimString);</div><div class="line"><span class="number">17</span>:                         subscriptionData.getCodeSet().add(trimString.hashCode());</div><div class="line"><span class="number">18</span>:                     &#125;</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125;</div><div class="line"><span class="number">21</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">22</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"subString split error"</span>);</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:     &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> subscriptionData;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：根据 <code>Topic</code> 和 订阅表达式 创建订阅数据</li>
<li>subscriptionData.subVersion = System.currentTimeMillis()。</li>
</ul>
<h2>DefaultMQPushConsumer#registerMessageListener(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span><span class="params">(MessageListenerConcurrently messageListener)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.messageListener = messageListener;</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</div><div class="line"><span class="number">4</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：注册消息监听器。</li>
</ul>
<h1>5、PushConsumer 消息队列分配</h1>
<p><img src="http://www.iocoder.cn/images/RocketMQ/2017_05_04/10.png" alt="RebalanceService&amp;amp;PushConsumer分配队列"></p>
<h2>RebalanceService</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebalanceService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * 等待间隔，单位：毫秒</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> waitInterval =</div><div class="line"> <span class="number">7</span>:         Long.parseLong(System.getProperty(</div><div class="line"> <span class="number">8</span>:             <span class="string">"rocketmq.client.rebalance.waitInterval"</span>, <span class="string">"20000"</span>));</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"><span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">12:      * MQClient对象</span></div><div class="line"><span class="comment">13:      */</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mqClientFactory;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">RebalanceService</span><span class="params">(MQClientInstance mqClientFactory)</span> </span>&#123;</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.mqClientFactory = mqClientFactory;</div><div class="line"><span class="number">18</span>:     &#125;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">22</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"><span class="number">25</span>:             <span class="keyword">this</span>.waitForRunning(waitInterval);</div><div class="line"><span class="number">26</span>:             <span class="keyword">this</span>.mqClientFactory.doRebalance();</div><div class="line"><span class="number">27</span>:         &#125;</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">30</span>:     &#125;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> RebalanceService.class.getSimpleName();</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：均衡消息队列服务，负责分配当前 <code>Consumer</code> 可消费的消息队列( <code>MessageQueue</code> )。</li>
<li>第 26 行 ：调用 <code>MQClientInstance#doRebalance(...)</code> 分配消息队列。目前有三种情况情况下触发：
<ul>
<li>如 <code>第 25 行</code> 等待超时，每 20s 调用一次。</li>
<li><code>PushConsumer</code> 启动时，调用 <code>rebalanceService#wakeup(...)</code> 触发。</li>
<li><code>Broker</code> 通知 <code>Consumer</code> 加入 或 移除时，<code>Consumer</code> 响应通知，调用 <code>rebalanceService#wakeup(...)</code> 触发。</li>
</ul>
</li>
</ul>
<p>详细解析见：<a href="#mqclientinstancedorebalance">MQClientInstance#doRebalance(...)</a>。</p>
<h2>MQClientInstance#doRebalance(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class="keyword">this</span>.consumerTable.entrySet()) &#123;</div><div class="line"> <span class="number">3</span>:         MQConsumerInner impl = entry.getValue();</div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">6</span>:                 impl.doRebalance();</div><div class="line"> <span class="number">7</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">8</span>:                 log.error(<span class="string">"doRebalance exception"</span>, e);</div><div class="line"> <span class="number">9</span>:             &#125;</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：遍历当前 <code>Client</code> 包含的 <code>consumerTable</code>( <code>Consumer</code>集合 )，执行消息队列分配。</li>
<li><strong>疑问</strong>：目前代码调试下来，<code>consumerTable</code> 只包含 <code>Consumer</code> 自己。😈有大大对这个疑问有解答的，烦请解答下。</li>
<li>第 6 行 ：调用 <code>MQConsumerInner#doRebalance(...)</code> 进行队列分配。<code>DefaultMQPushConsumerImpl</code>、<code>DefaultMQPullConsumerImpl</code> 分别对该接口方法进行了实现。<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> 详细解析见：<a href="defaultmqpushconsumerimpldorebalance">DefaultMQPushConsumerImpl#doRebalance(...)</a>。</li>
</ul>
<h2>DefaultMQPushConsumerImpl#doRebalance(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.pause) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.rebalanceImpl.doRebalance(<span class="keyword">this</span>.isConsumeOrderly());</div><div class="line"><span class="number">4</span>:     &#125;</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明：执行消息队列分配。</li>
<li>第 3 行 ：调用 <code>RebalanceImpl#doRebalance(...)</code> 进行队列分配。详细解析见：<a href="#rebalancepushimpldorebalance">RebalancePushImpl#doRebalance(...)</a>。</li>
</ul>
<h2>RebalanceImpl#doRebalance(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 执行分配消息队列</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> isOrder 是否顺序消息</span></div><div class="line"><span class="comment"> 5:  */</span></div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:     <span class="comment">// 分配每个 topic 的消息队列</span></div><div class="line"> <span class="number">8</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (subTable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</div><div class="line"><span class="number">11</span>:             <span class="keyword">final</span> String topic = entry.getKey();</div><div class="line"><span class="number">12</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">this</span>.rebalanceByTopic(topic, isOrder);</div><div class="line"><span class="number">14</span>:             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">16</span>:                     log.warn(<span class="string">"rebalanceByTopic Exception"</span>, e);</div><div class="line"><span class="number">17</span>:                 &#125;</div><div class="line"><span class="number">18</span>:             &#125;</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:     &#125;</div><div class="line"><span class="number">21</span>:     <span class="comment">// 移除未订阅的topic对应的消息队列</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">this</span>.truncateMessageQueueNotMyTopic();</div><div class="line"><span class="number">23</span>: &#125;</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">26:  * 移除未订阅的消息队列</span></div><div class="line"><span class="comment">27:  */</span></div><div class="line"><span class="number">28</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">truncateMessageQueueNotMyTopic</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">29</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"><span class="number">30</span>:     <span class="keyword">for</span> (MessageQueue mq : <span class="keyword">this</span>.processQueueTable.keySet()) &#123;</div><div class="line"><span class="number">31</span>:         <span class="keyword">if</span> (!subTable.containsKey(mq.getTopic())) &#123;</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:             ProcessQueue pq = <span class="keyword">this</span>.processQueueTable.remove(mq);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (pq != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">35</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">36</span>:                 log.info(<span class="string">"doRebalance, &#123;&#125;, truncateMessageQueueNotMyTopic remove unnecessary mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">37</span>:             &#125;</div><div class="line"><span class="number">38</span>:         &#125;</div><div class="line"><span class="number">39</span>:     &#125;</div><div class="line"><span class="number">40</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#doRebalance(...)</code> 说明 ：执行分配消息队列。
<ul>
<li>第 7 至 20 行 ：循环订阅主题集合( <code>subscriptionInner</code> )，分配每一个 <code>Topic</code> 的消息队列。</li>
<li>第 22 行 ：移除未订阅的 <code>Topic</code> 的消息队列。</li>
</ul>
</li>
<li><code>#truncateMessageQueueNotMyTopic(...)</code> 说明 ：移除未订阅的消息队列。<strong>当调用 <code>DefaultMQPushConsumer#unsubscribe(topic)</code> 时，只移除订阅主题集合( <code>subscriptionInner</code> )，对应消息队列移除在该方法。</strong></li>
</ul>
<h3>RebalanceImpl#rebalanceByTopic(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebalanceByTopic</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">switch</span> (messageModel) &#123;</div><div class="line">  <span class="number">3</span>:         <span class="keyword">case</span> BROADCASTING: &#123;</div><div class="line">  <span class="number">4</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line">  <span class="number">5</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="number">6</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</div><div class="line">  <span class="number">7</span>:                 <span class="keyword">if</span> (changed) &#123;</div><div class="line">  <span class="number">8</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, mqSet);</div><div class="line">  <span class="number">9</span>:                     log.info(<span class="string">"messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"> <span class="number">10</span>:                         consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">11</span>:                         topic, <span class="comment">//</span></div><div class="line"> <span class="number">12</span>:                         mqSet, <span class="comment">//</span></div><div class="line"> <span class="number">13</span>:                         mqSet);</div><div class="line"> <span class="number">14</span>:                 &#125;</div><div class="line"> <span class="number">15</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">16</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</div><div class="line"> <span class="number">17</span>:             &#125;</div><div class="line"> <span class="number">18</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">19</span>:         &#125;</div><div class="line"> <span class="number">20</span>:         <span class="keyword">case</span> CLUSTERING: &#123;</div><div class="line"> <span class="number">21</span>:             <span class="comment">// 获取 topic 对应的 队列 和 consumer信息</span></div><div class="line"> <span class="number">22</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line"> <span class="number">23</span>:             List&lt;String&gt; cidAll = <span class="keyword">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == mqSet) &#123;</div><div class="line"> <span class="number">25</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"> <span class="number">26</span>:                     log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</div><div class="line"> <span class="number">27</span>:                 &#125;</div><div class="line"> <span class="number">28</span>:             &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == cidAll) &#123;</div><div class="line"> <span class="number">31</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed"</span>, consumerGroup, topic);</div><div class="line"> <span class="number">32</span>:             &#125;</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span> &amp;&amp; cidAll != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">35</span>:                 <span class="comment">// 排序 消息队列 和 消费者数组。因为是在Client进行分配队列，排序后，各Client的顺序才能保持一致。</span></div><div class="line"> <span class="number">36</span>:                 List&lt;MessageQueue&gt; mqAll = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> <span class="number">37</span>:                 mqAll.addAll(mqSet);</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:                 Collections.sort(mqAll);</div><div class="line"> <span class="number">40</span>:                 Collections.sort(cidAll);</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:                 AllocateMessageQueueStrategy strategy = <span class="keyword">this</span>.allocateMessageQueueStrategy;</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:                 <span class="comment">// 根据 队列分配策略 分配消息队列</span></div><div class="line"> <span class="number">45</span>:                 List&lt;MessageQueue&gt; allocateResult;</div><div class="line"> <span class="number">46</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">47</span>:                     allocateResult = strategy.allocate(<span class="comment">//</span></div><div class="line"> <span class="number">48</span>:                         <span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">49</span>:                         <span class="keyword">this</span>.mQClientFactory.getClientId(), <span class="comment">//</span></div><div class="line"> <span class="number">50</span>:                         mqAll, <span class="comment">//</span></div><div class="line"> <span class="number">51</span>:                         cidAll);</div><div class="line"> <span class="number">52</span>:                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">53</span>:                     log.error(<span class="string">"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;"</span>, strategy.getName(),</div><div class="line"> <span class="number">54</span>:                         e);</div><div class="line"> <span class="number">55</span>:                     <span class="keyword">return</span>;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:                 Set&lt;MessageQueue&gt; allocateResultSet = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">if</span> (allocateResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">60</span>:                     allocateResultSet.addAll(allocateResult);</div><div class="line"> <span class="number">61</span>:                 &#125;</div><div class="line"> <span class="number">62</span>: </div><div class="line"> <span class="number">63</span>:                 <span class="comment">// 更新消息队列</span></div><div class="line"> <span class="number">64</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</div><div class="line"> <span class="number">65</span>:                 <span class="keyword">if</span> (changed) &#123;</div><div class="line"> <span class="number">66</span>:                     log.info(</div><div class="line"> <span class="number">67</span>:                         <span class="string">"rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;"</span>,</div><div class="line"> <span class="number">68</span>:                         strategy.getName(), consumerGroup, topic, <span class="keyword">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</div><div class="line"> <span class="number">69</span>:                         allocateResultSet.size(), allocateResultSet);</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</div><div class="line"> <span class="number">71</span>:                 &#125;</div><div class="line"> <span class="number">72</span>:             &#125;</div><div class="line"> <span class="number">73</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">74</span>:         &#125;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">default</span>:</div><div class="line"> <span class="number">76</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:     &#125;</div><div class="line"> <span class="number">78</span>: &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 81:  * 当负载均衡时，更新 消息处理队列</span></div><div class="line"><span class="comment"> 82:  * - 移除 在processQueueTable &amp;&amp; 不存在于 mqSet 里的消息队列</span></div><div class="line"><span class="comment"> 83:  * - 增加 不在processQueueTable &amp;&amp; 存在于mqSet 里的消息队列</span></div><div class="line"><span class="comment"> 84:  *</span></div><div class="line"><span class="comment"> 85:  * <span class="doctag">@param</span> topic Topic</span></div><div class="line"><span class="comment"> 86:  * <span class="doctag">@param</span> mqSet 负载均衡结果后的消息队列数组</span></div><div class="line"><span class="comment"> 87:  * <span class="doctag">@param</span> isOrder 是否顺序</span></div><div class="line"><span class="comment"> 88:  * <span class="doctag">@return</span> 是否变更</span></div><div class="line"><span class="comment"> 89:  */</span></div><div class="line"> <span class="number">90</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</div><div class="line"> <span class="number">91</span>:     <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:     <span class="comment">// 移除 在processQueueTable &amp;&amp; 不存在于 mqSet 里的消息队列</span></div><div class="line"> <span class="number">94</span>:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class="keyword">this</span>.processQueueTable.entrySet().iterator();</div><div class="line"> <span class="number">95</span>:     <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// TODO 待读：</span></div><div class="line"> <span class="number">96</span>:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"> <span class="number">97</span>:         MessageQueue mq = next.getKey();</div><div class="line"> <span class="number">98</span>:         ProcessQueue pq = next.getValue();</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         <span class="keyword">if</span> (mq.getTopic().equals(topic)) &#123;</div><div class="line"><span class="number">101</span>:             <span class="keyword">if</span> (!mqSet.contains(mq)) &#123; <span class="comment">// 不包含的队列</span></div><div class="line"><span class="number">102</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">103</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class="line"><span class="number">104</span>:                     it.remove();</div><div class="line"><span class="number">105</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">106</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">107</span>:                 &#125;</div><div class="line"><span class="number">108</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pq.isPullExpired()) &#123; <span class="comment">// 队列拉取超时，进行清理</span></div><div class="line"><span class="number">109</span>:                 <span class="keyword">switch</span> (<span class="keyword">this</span>.consumeType()) &#123;</div><div class="line"><span class="number">110</span>:                     <span class="keyword">case</span> CONSUME_ACTIVELY:</div><div class="line"><span class="number">111</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">112</span>:                     <span class="keyword">case</span> CONSUME_PASSIVELY:</div><div class="line"><span class="number">113</span>:                         pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">114</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) &#123;</div><div class="line"><span class="number">115</span>:                             it.remove();</div><div class="line"><span class="number">116</span>:                             changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                             log.error(<span class="string">"[BUG]doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;, because pull is pause, so try to fixed it"</span>,</div><div class="line"><span class="number">118</span>:                                 consumerGroup, mq);</div><div class="line"><span class="number">119</span>:                         &#125;</div><div class="line"><span class="number">120</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">121</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">122</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">123</span>:                 &#125;</div><div class="line"><span class="number">124</span>:             &#125;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>:     &#125;</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>:     <span class="comment">// 增加 不在processQueueTable &amp;&amp; 存在于mqSet 里的消息队列。</span></div><div class="line"><span class="number">129</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 拉消息请求数组</span></div><div class="line"><span class="number">130</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</div><div class="line"><span class="number">131</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</div><div class="line"><span class="number">132</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) &#123;</div><div class="line"><span class="number">133</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed"</span>, consumerGroup, mq);</div><div class="line"><span class="number">134</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">135</span>:             &#125;</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">138</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">139</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">140</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">141</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">142</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">143</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">144</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">145</span>:                     log.info(<span class="string">"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">146</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">147</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">148</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">149</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">150</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">151</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">152</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">153</span>:                 &#125;</div><div class="line"><span class="number">154</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">155</span>:                 log.warn(<span class="string">"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;"</span>, consumerGroup, mq);</div><div class="line"><span class="number">156</span>:             &#125;</div><div class="line"><span class="number">157</span>:         &#125;</div><div class="line"><span class="number">158</span>:     &#125;</div><div class="line"><span class="number">159</span>: </div><div class="line"><span class="number">160</span>:     <span class="comment">// 发起消息拉取请求</span></div><div class="line"><span class="number">161</span>:     <span class="keyword">this</span>.dispatchPullRequest(pullRequestList);</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     <span class="keyword">return</span> changed;</div><div class="line"><span class="number">164</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#rebalanceByTopic(...)</code> 说明 ：分配 <code>Topic</code> 的消息队列。
<ul>
<li>第 3 至 19 行 ：广播模式( <code>BROADCASTING</code> ) 下，分配 <code>Topic</code> 对应的<strong>所有</strong>消息队列。</li>
<li>第 20 至 74 行 ：集群模式( <code>CLUSTERING</code> ) 下，分配 <code>Topic</code> 对应的<strong>部分</strong>消息队列。
<ul>
<li>第 21 至 40 行 ：获取 <code>Topic</code> 对应的消息队列和消费者们，并对其进行排序。因为各 <code>Consumer</code> 是在本地分配消息队列，排序后才能保证各 <code>Consumer</code> 顺序一致。</li>
<li>第 42 至 61 行 ：根据 队列分配策略( <code>AllocateMessageQueueStrategy</code> ) 分配消息队列。详细解析见：<a href="#allocatemessagequeuestrategy">AllocateMessageQueueStrategy</a>。</li>
<li>第 63 至 72 行 ：更新 <code>Topic</code> 对应的消息队列。</li>
</ul>
</li>
</ul>
</li>
<li><code>#updateProcessQueueTableInRebalance(...)</code> 说明 ：当分配队列时，更新 <code>Topic</code> 对应的消息队列，并返回是否有变更。
<ul>
<li>第 93 至 126 行 ：移除不存在于分配的消息队列( <code>mqSet</code> ) 的 消息处理队列( <code>processQueueTable</code> )。
<ul>
<li>第 103 行 ：移除不需要的消息队列。详细解析见：<a href="#rebalancepushimplremoveunnecessarymessagequeue">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</a>。</li>
<li>第 108 至 120 行 ：队列拉取超时，即 <code>当前时间 - 最后一次拉取消息时间 &gt; 120s</code> ( 120s 可配置)，判定发生 <strong>BUG</strong>，过久未进行消息拉取，移除消息队列。移除后，下面**#新增队列逻辑#**可以重新加入新的该消息队列。</li>
</ul>
</li>
<li>第 128 至 158 行 ：增加 分配的消息队列( <code>mqSet</code> ) 新增的消息队列。
<ul>
<li>第 132 至 135 行 ：<code>顺序消费</code> 相关跳过，详细解析见：<a href="http://www.iocoder.cn/RocketMQ/message-send-and-consume-orderly/">《RocketMQ 源码分析 —— Message 顺序发送与消费》</a>。</li>
<li>第 137 行 ：移除消息队列的消费进度。</li>
<li>第 139 行 ：获取队列消费进度。详细解析见：<a href="#rebalancepushimplcomputepullfromwhere">RebalancePushImpl#computePullFromWhere(...)</a>。</li>
<li>第 140 至 156 行 ：<strong>添加新消费处理队列，添加消费拉取消息请求</strong>。</li>
</ul>
</li>
<li>第 161 行 ：<strong>发起新增的消息队列消息拉取请求</strong>。详细解析见：<a href="#rebalancepushimpldispatchpullrequest">RebalancePushImpl#dispatchPullRequest(...)</a>。</li>
</ul>
</li>
</ul>
<h3>RebalanceImpl#removeUnnecessaryMessageQueue(...)</h3>
<h4>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// 同步队列的消费进度，并移除之。</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"> <span class="number">5</span>:     <span class="comment">// TODO 顺序消费</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"> <span class="number">7</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) &#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class="line"><span class="number">10</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">12</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">13</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">14</span>:                 &#125;</div><div class="line"><span class="number">15</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>:                 log.warn(<span class="string">"[WRONG]mq is consuming, so can not unlock it, &#123;&#125;. maybe hanged for a while, &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">17</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">18</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">21</span>:             &#125;</div><div class="line"><span class="number">22</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">23</span>:             log.error(<span class="string">"removeUnnecessaryMessageQueue Exception"</span>, e);</div><div class="line"><span class="number">24</span>:         &#125;</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">27</span>:     &#125;</div><div class="line"><span class="number">28</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：移除不需要的消息队列相关的信息，并返回是否移除成功。</li>
<li>第 2 至 4 行 ：<strong>同步</strong>队列的消费进度，并移除之。</li>
<li>第 5 至 27 行 ：<code>顺序消费</code> 相关跳过，详细解析见：<a href="http://www.iocoder.cn/RocketMQ/message-send-and-consume-orderly/">《RocketMQ 源码分析 —— Message 顺序发送与消费》</a>。</li>
</ul>
<h4><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">4</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">5</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：移除不需要的消息队列相关的信息，并返回移除成功。<strong>和<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>基本一致。</strong></li>
</ul>
<h3>RebalancePushImpl#dispatchPullRequest(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPullRequest</span><span class="params">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">for</span> (PullRequest pullRequest : pullRequestList) &#123;</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">4</span>:         log.info(<span class="string">"doRebalance, &#123;&#125;, add a new pull request &#123;&#125;"</span>, consumerGroup, pullRequest);</div><div class="line"><span class="number">5</span>:     &#125;</div><div class="line"><span class="number">6</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：发起消息拉取请求。<strong>该调用是<code>PushConsumer</code>不断不断不断拉取消息的起点</strong>。</li>
</ul>
<h4>DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">3</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：提交拉取请求。提交后，<code>PullMessageService</code> <strong>异步执行</strong>，<strong>非阻塞</strong>。详细解析见：<a href="pullmessageservice">PullMessageService</a>。</li>
</ul>
<h3>AllocateMessageQueueStrategy</h3>
<p><img src="http://www.iocoder.cn/images/RocketMQ/2017_05_04/01.png" alt="AllocateMessageQueueStrategy类图"></p>
<h4>AllocateMessageQueueAveragely</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragely</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">6</span>:         List&lt;String&gt; cidAll)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// 校验参数是否正确</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"currentCID is empty"</span>);</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mqAll is null or mqAll empty"</span>);</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cidAll is null or cidAll empty"</span>);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;"</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>:         <span class="comment">// 平均分配</span></div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID); <span class="comment">// 第几个consumer。</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> mod = mqAll.size() % cidAll.size(); <span class="comment">// 余数，即多少消息队列无法平均分配。</span></div><div class="line"><span class="number">29</span>:         <span class="keyword">int</span> averageSize =</div><div class="line"><span class="number">30</span>:             mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> : (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</div><div class="line"><span class="number">31</span>:                 + <span class="number">1</span> : mqAll.size() / cidAll.size());</div><div class="line"><span class="number">32</span>:         <span class="keyword">int</span> startIndex = (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; <span class="comment">// 有余数的情况下，[0, mod) 平分余数，即每consumer多分配一个节点；第index开始，跳过前mod余数。</span></div><div class="line"><span class="number">33</span>:         <span class="keyword">int</span> range = Math.min(averageSize, mqAll.size() - startIndex); <span class="comment">// 分配队列数量。之所以要Math.min()的原因是，mqAll.size() &lt;= cidAll.size()，部分consumer分配不到消息队列。</span></div><div class="line"><span class="number">34</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; range; i++) &#123;</div><div class="line"><span class="number">35</span>:             result.add(mqAll.get((startIndex + i) % mqAll.size()));</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">41</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="string">"AVG"</span>;</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：<strong>平均</strong>分配队列策略。</li>
<li>第 7 至 25 行 ：参数校验。</li>
<li>第 26 至 36 行 ：平均分配消息队列。
<ul>
<li>第 27 行 ：<code>index</code> ：当前 <code>Consumer</code> 在消费集群里是第几个。这里就是为什么需要对传入的 <code>cidAll</code> 参数必须进行排序的原因。如果不排序，<code>Consumer</code> 在本地计算出来的 <code>index</code> 无法一致，影响计算结果。</li>
<li>第 28 行 ：<code>mod</code> ：余数，即多少消息队列无法平均分配。</li>
<li>第 29 至 31 行 ：<code>averageSize</code> ：代码可以简化成 <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>。
<ul>
<li><code>[ 0, mod )</code> ：<code>mqAll.size() / cidAll.size() + 1</code>。前面 <code>mod</code> 个 <code>Consumer</code> 平分余数，多获得 1 个消息队列。</li>
<li><code>[ mod, cidAll.size() )</code> ：<code>mqAll.size() / cidAll.size()</code>。</li>
</ul>
</li>
<li>第 32 行 ：<code>startIndex</code> ：<code>Consumer</code> 分配消息队列开始位置。</li>
<li>第 33 行 ：<code>range</code> ：分配队列数量。之所以要 <code>Math#min(...)</code> 的原因：当 <code>mqAll.size() &lt;= cidAll.size()</code> 时，最后几个 <code>Consumer</code> 分配不到消息队列。</li>
<li>第 34 至 36 行 ：生成分配消息队列结果。</li>
</ul>
</li>
<li>举个例子：</li>
</ul>
<p>固定消息队列长度为<strong>4</strong>。</p>
<table>
<thead>
<tr>
<th></th>
<th>Consumer * 2 <em>可以整除</em></th>
<th>Consumer * 3 <em>不可整除</em></th>
<th>Consumer * 5 <em>无法都分配</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>消息队列[0]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
</tr>
<tr>
<td>消息队列[1]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
<td>Consumer[1]</td>
</tr>
<tr>
<td>消息队列[2]</td>
<td>Consumer[1]</td>
<td>Consumer[1]</td>
<td>Consumer[2]</td>
</tr>
<tr>
<td>消息队列[3]</td>
<td>Consumer[1]</td>
<td>Consumer[2]</td>
<td>Consumer[3]</td>
</tr>
</tbody>
</table>
<h4>AllocateMessageQueueByMachineRoom</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByMachineRoom</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 3:      * 消费者消费brokerName集合</span></div><div class="line"><span class="comment"> 4:      */</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> Set&lt;String&gt; consumeridcs;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">9</span>:         List&lt;String&gt; cidAll)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:         <span class="comment">// 参数校验</span></div><div class="line"><span class="number">11</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">12</span>:         <span class="keyword">int</span> currentIndex = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (currentIndex &lt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:         <span class="comment">// 计算符合当前配置的消费者数组('consumeridcs')对应的消息队列</span></div><div class="line"><span class="number">17</span>:         List&lt;MessageQueue&gt; premqAll = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">18</span>:         <span class="keyword">for</span> (MessageQueue mq : mqAll) &#123;</div><div class="line"><span class="number">19</span>:             String[] temp = mq.getBrokerName().split(<span class="string">"@"</span>);</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (temp.length == <span class="number">2</span> &amp;&amp; consumeridcs.contains(temp[<span class="number">0</span>])) &#123;</div><div class="line"><span class="number">21</span>:                 premqAll.add(mq);</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125;</div><div class="line"><span class="number">24</span>:         <span class="comment">// 平均分配</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">int</span> mod = premqAll.size() / cidAll.size();</div><div class="line"><span class="number">26</span>:         <span class="keyword">int</span> rem = premqAll.size() % cidAll.size();</div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> startIndex = mod * currentIndex;</div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> endIndex = startIndex + mod;</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</div><div class="line"><span class="number">30</span>:             result.add(mqAll.get(i));</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (rem &gt; currentIndex) &#123;</div><div class="line"><span class="number">33</span>:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));</div><div class="line"><span class="number">34</span>:         &#125;</div><div class="line"><span class="number">35</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">39</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">40</span>:         <span class="keyword">return</span> <span class="string">"MACHINE_ROOM"</span>;</div><div class="line"><span class="number">41</span>:     &#125;</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getConsumeridcs</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">44</span>:         <span class="keyword">return</span> consumeridcs;</div><div class="line"><span class="number">45</span>:     &#125;</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConsumeridcs</span><span class="params">(Set&lt;String&gt; consumeridcs)</span> </span>&#123;</div><div class="line"><span class="number">48</span>:         <span class="keyword">this</span>.consumeridcs = consumeridcs;</div><div class="line"><span class="number">49</span>:     &#125;</div><div class="line"><span class="number">50</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：<strong>平均</strong>分配<strong>可消费的</strong> <code>Broker</code> 对应的消息队列。</li>
<li>第 7 至 15 行 ：参数校验。</li>
<li>第 16 至 23 行 ：计算<strong>可消费的</strong> <code>Broker</code> 对应的消息队列。</li>
<li>第 25 至 34 行 ：平均分配消息队列。该<strong>平均分配</strong>方式和 <code>AllocateMessageQueueAveragely</code> 略有不同，其是将多余的结尾部分分配给前 <code>rem</code> 个 <code>Consumer</code>。</li>
<li>疑问：<em>使用该分配策略时，<code>Consumer</code> 和 <code>Broker</code> 分配需要怎么配置</em>。😈等研究<strong>主从</strong>相关源码时，仔细考虑下。</li>
</ul>
<h4>AllocateMessageQueueAveragelyByCircle</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragelyByCircle</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">6</span>:         List&lt;String&gt; cidAll)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:         <span class="comment">// 校验参数是否正确</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"currentCID is empty"</span>);</div><div class="line"><span class="number">10</span>:         &#125;</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) &#123;</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"mqAll is null or mqAll empty"</span>);</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"cidAll is null or cidAll empty"</span>);</div><div class="line"><span class="number">16</span>:         &#125;</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">"[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;"</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="comment">// 环状分配</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; mqAll.size(); i++) &#123;</div><div class="line"><span class="number">30</span>:             <span class="keyword">if</span> (i % cidAll.size() == index) &#123;</div><div class="line"><span class="number">31</span>:                 result.add(mqAll.get(i));</div><div class="line"><span class="number">32</span>:             &#125;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">35</span>:     &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">38</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">return</span> <span class="string">"AVG_BY_CIRCLE"</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：环状分配消息队列。</li>
</ul>
<h4>AllocateMessageQueueByConfig</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByConfig</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> List&lt;MessageQueue&gt; messageQueueList;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">6</span>:         List&lt;String&gt; cidAll)</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.messageQueueList;</div><div class="line"> <span class="number">8</span>:     &#125;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="string">"CONFIG"</span>;</div><div class="line"><span class="number">13</span>:     &#125;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">getMessageQueueList</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> messageQueueList;</div><div class="line"><span class="number">17</span>:     &#125;</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessageQueueList</span><span class="params">(List&lt;MessageQueue&gt; messageQueueList)</span> </span>&#123;</div><div class="line"><span class="number">20</span>:         <span class="keyword">this</span>.messageQueueList = messageQueueList;</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：分配<strong>配置的</strong>消息队列。</li>
<li>疑问 ：<em>该分配策略的使用场景。</em></li>
</ul>
<h1>5、PushConsumer 消费进度读取</h1>
<h2>RebalancePushImpl#computePullFromWhere(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">computePullFromWhere</span><span class="params">(MessageQueue mq)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeFromWhere consumeFromWhere = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> OffsetStore offsetStore = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">switch</span> (consumeFromWhere) &#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: <span class="comment">// 废弃</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">case</span> CONSUME_FROM_MIN_OFFSET: <span class="comment">// 废弃</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">case</span> CONSUME_FROM_MAX_OFFSET: <span class="comment">// 废弃</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET: &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">12</span>:                 result = lastOffset;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="comment">// First start,no offset</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">17</span>:                     result = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">19</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">20</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">21</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">22</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">26</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>:         &#125;</div><div class="line"><span class="number">30</span>:         <span class="keyword">case</span> CONSUME_FROM_FIRST_OFFSET: &#123;</div><div class="line"><span class="number">31</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">33</span>:                 result = lastOffset;</div><div class="line"><span class="number">34</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">35</span>:                 result = <span class="number">0L</span>;</div><div class="line"><span class="number">36</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">37</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">38</span>:             &#125;</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:         &#125;</div><div class="line"><span class="number">41</span>:         <span class="keyword">case</span> CONSUME_FROM_TIMESTAMP: &#123;</div><div class="line"><span class="number">42</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">43</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="number">44</span>:                 result = lastOffset;</div><div class="line"><span class="number">45</span>:             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) &#123;</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">47</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">48</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">49</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">50</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">51</span>:                     &#125;</div><div class="line"><span class="number">52</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">53</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">54</span>:                         <span class="keyword">long</span> timestamp = UtilAll.parseDate(<span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),</div><div class="line"><span class="number">55</span>:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();</div><div class="line"><span class="number">56</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);</div><div class="line"><span class="number">57</span>:                     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">58</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">59</span>:                     &#125;</div><div class="line"><span class="number">60</span>:                 &#125;</div><div class="line"><span class="number">61</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">62</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">63</span>:             &#125;</div><div class="line"><span class="number">64</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">65</span>:         &#125;</div><div class="line"><span class="number">66</span>: </div><div class="line"><span class="number">67</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">68</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">72</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：计算消息队列开始消费位置。</li>
<li><code>PushConsumer</code> 读取消费进度有三种选项：
<ul>
<li><code>CONSUME_FROM_LAST_OFFSET</code> ：第 6 至 29 行 ：一个新的消费集群第一次启动从<strong>队列的最后位置</strong>开始消费。<strong>后续再启动接着上次消费的进度开始消费</strong>。</li>
<li><code>CONSUME_FROM_FIRST_OFFSET</code> ：第 30 至 40 行 ：一个新的消费集群第一次启动从队列的<strong>最前位置</strong>开始消费。<strong>后续再启动接着上次消费的进度开始消费</strong>。</li>
<li><code>CONSUME_FROM_TIMESTAMP</code> ：第 41 至 65 行 ：一个新的消费集群第一次启动从<strong>指定时间点</strong>开始消费。<strong>后续再启动接着上次消费的进度开始消费</strong>。</li>
</ul>
</li>
</ul>
<h2><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(...)</h2>
<p>暂时跳过。😈</p>
<h1>6、PushConsumer 拉取消息</h1>
<p><img src="http://www.iocoder.cn/images/RocketMQ/2017_05_04/05.png" alt="DefaultMQPushConsumerImpl拉取消息"></p>
<h2>PullMessageService</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">  4:      * 拉取消息请求队列</span></div><div class="line"><span class="comment">  5:      */</span></div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">  8:      * MQClient对象</span></div><div class="line"><span class="comment">  9:      */</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mQClientFactory;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 12:      * 定时器。用于延迟提交拉取请求</span></div><div class="line"><span class="comment"> 13:      */</span></div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors</div><div class="line"> <span class="number">15</span>:         .newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line"> <span class="number">16</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:             <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"PullMessageServiceScheduledThread"</span>);</div><div class="line"> <span class="number">19</span>:             &#125;</div><div class="line"> <span class="number">20</span>:         &#125;);</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullMessageService</span><span class="params">(MQClientInstance mQClientFactory)</span> </span>&#123;</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.mQClientFactory = mQClientFactory;</div><div class="line"> <span class="number">24</span>:     &#125;</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 27:      * 执行延迟拉取消息请求</span></div><div class="line"><span class="comment"> 28:      *</span></div><div class="line"><span class="comment"> 29:      * <span class="doctag">@param</span> pullRequest 拉取消息请求</span></div><div class="line"><span class="comment"> 30:      * <span class="doctag">@param</span> timeDelay 延迟时长</span></div><div class="line"><span class="comment"> 31:      */</span></div><div class="line"> <span class="number">32</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestLater</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>&#123;</div><div class="line"> <span class="number">33</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">36</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">37</span>:                 PullMessageService.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"> <span class="number">38</span>:             &#125;</div><div class="line"> <span class="number">39</span>:         &#125;, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">40</span>:     &#125;</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 43:      * 执行立即拉取消息请求</span></div><div class="line"><span class="comment"> 44:      *</span></div><div class="line"><span class="comment"> 45:      * <span class="doctag">@param</span> pullRequest 拉取消息请求</span></div><div class="line"><span class="comment"> 46:      */</span></div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">48</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">49</span>:             <span class="keyword">this</span>.pullRequestQueue.put(pullRequest);</div><div class="line"> <span class="number">50</span>:         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">51</span>:             log.error(<span class="string">"executePullRequestImmediately pullRequestQueue.put"</span>, e);</div><div class="line"> <span class="number">52</span>:         &#125;</div><div class="line"> <span class="number">53</span>:     &#125;</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 56:      * 执行延迟任务</span></div><div class="line"><span class="comment"> 57:      *</span></div><div class="line"><span class="comment"> 58:      * <span class="doctag">@param</span> r 任务</span></div><div class="line"><span class="comment"> 59:      * <span class="doctag">@param</span> timeDelay 延迟时长</span></div><div class="line"><span class="comment"> 60:      */</span></div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeTaskLater</span><span class="params">(<span class="keyword">final</span> Runnable r, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>&#123;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="function"><span class="keyword">public</span> ScheduledExecutorService <span class="title">getScheduledExecutorService</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> scheduledExecutorService;</div><div class="line"> <span class="number">67</span>:     &#125;</div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 70:      * 拉取消息</span></div><div class="line"><span class="comment"> 71:      *</span></div><div class="line"><span class="comment"> 72:      * <span class="doctag">@param</span> pullRequest 拉取消息请求</span></div><div class="line"><span class="comment"> 73:      */</span></div><div class="line"> <span class="number">74</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">final</span> MQConsumerInner consumer = <span class="keyword">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</div><div class="line"> <span class="number">76</span>:         <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">77</span>:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</div><div class="line"> <span class="number">78</span>:             impl.pullMessage(pullRequest);</div><div class="line"> <span class="number">79</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">80</span>:             log.warn(<span class="string">"No matched consumer for the PullRequest &#123;&#125;, drop it"</span>, pullRequest);</div><div class="line"> <span class="number">81</span>:         &#125;</div><div class="line"> <span class="number">82</span>:     &#125;</div><div class="line"> <span class="number">83</span>: </div><div class="line"> <span class="number">84</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">85</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">86</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</div><div class="line"> <span class="number">89</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">90</span>:                 PullRequest pullRequest = <span class="keyword">this</span>.pullRequestQueue.take();</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">if</span> (pullRequest != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">92</span>:                     <span class="keyword">this</span>.pullMessage(pullRequest);</div><div class="line"> <span class="number">93</span>:                 &#125;</div><div class="line"> <span class="number">94</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"> <span class="number">95</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"> <span class="number">96</span>:                 log.error(<span class="string">"Pull Message Service Run Method exception"</span>, e);</div><div class="line"> <span class="number">97</span>:             &#125;</div><div class="line"> <span class="number">98</span>:         &#125;</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</div><div class="line"><span class="number">101</span>:     &#125;</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">104</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">105</span>:         <span class="keyword">return</span> PullMessageService.class.getSimpleName();</div><div class="line"><span class="number">106</span>:     &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：拉取消息服务，不断不断不断从 <code>Broker</code> 拉取消息，并提交消费任务到 <code>ConsumeMessageService</code>。</li>
<li><code>#executePullRequestLater(...)</code> ：第 26 至 40 行 ： 提交<strong>延迟</strong>拉取消息请求。</li>
<li><code>#executePullRequestImmediately(...)</code> ：第 42 至 53 行 ：提交<strong>立即</strong>拉取消息请求。</li>
<li><code>#executeTaskLater(...)</code> ：第 55 至 63 行 ：提交<strong>延迟任务</strong>。</li>
<li><code>#pullMessage(...)</code> ：第 69 至 82 行 ：执行拉取消息逻辑。详细解析见：<a href="#defaultmqpushconsumerimplpullmessage">DefaultMQPushConsumerImpl#pullMessage(...)</a>。</li>
<li><code>#run(...)</code> ：第 84 至 101 行 ：循环拉取消息请求队列( <code>pullRequestQueue</code> )，进行消息拉取。</li>
</ul>
<h2>DefaultMQPushConsumerImpl#pullMessage(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line">  <span class="number">2</span>:     <span class="keyword">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</div><div class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (processQueue.isDropped()) &#123;</div><div class="line">  <span class="number">4</span>:         log.info(<span class="string">"the pull request[&#123;&#125;] is dropped."</span>, pullRequest.toString());</div><div class="line">  <span class="number">5</span>:         <span class="keyword">return</span>;</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// 设置队列最后拉取消息时间</span></div><div class="line">  <span class="number">9</span>:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:     <span class="comment">// 判断consumer状态是否运行中。如果不是，则延迟拉取消息。</span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"> <span class="number">14</span>:     &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"> <span class="number">15</span>:         log.warn(<span class="string">"pullMessage exception, consumer state not ok"</span>, e);</div><div class="line"> <span class="number">16</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:     &#125;</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="comment">// 判断是否暂停中。</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isPause()) &#123;</div><div class="line"> <span class="number">22</span>:         log.warn(<span class="string">"consumer was paused, execute pull request later. instanceName=&#123;&#125;, group=&#123;&#125;"</span>, <span class="keyword">this</span>.defaultMQPushConsumer.getInstanceName(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</div><div class="line"> <span class="number">24</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">25</span>:     &#125;</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     <span class="comment">// 判断是否超过最大持有消息数量。默认最大值为1000。</span></div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> size = processQueue.getMsgCount().get();</div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (size &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</div><div class="line"> <span class="number">30</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// 提交延迟消息拉取请求。50ms。</span></div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> ((flowControlTimes1++ % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">32</span>:             log.warn(</div><div class="line"> <span class="number">33</span>:                 <span class="string">"the consumer message buffer is full, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, size=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;"</span>,</div><div class="line"> <span class="number">34</span>:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);</div><div class="line"> <span class="number">35</span>:         &#125;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.consumeOrderly) &#123; <span class="comment">// 判断消息跨度是否过大。</span></div><div class="line"> <span class="number">40</span>:         <span class="keyword">if</span> (processQueue.getMaxSpan() &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</div><div class="line"> <span class="number">41</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// 提交延迟消息拉取请求。50ms。</span></div><div class="line"> <span class="number">42</span>:             <span class="keyword">if</span> ((flowControlTimes2++ % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">43</span>:                 log.warn(</div><div class="line"> <span class="number">44</span>:                     <span class="string">"the queue's messages, span too long, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, maxSpan=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;"</span>,</div><div class="line"> <span class="number">45</span>:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</div><div class="line"> <span class="number">46</span>:                     pullRequest, flowControlTimes2);</div><div class="line"> <span class="number">47</span>:             &#125;</div><div class="line"> <span class="number">48</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">49</span>:         &#125;</div><div class="line"> <span class="number">50</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// TODO 顺序消费</span></div><div class="line"> <span class="number">51</span>:         <span class="keyword">if</span> (processQueue.isLocked()) &#123;</div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (!pullRequest.isLockedFirst()) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</div><div class="line"> <span class="number">54</span>:                 <span class="keyword">boolean</span> brokerBusy = offset &lt; pullRequest.getNextOffset();</div><div class="line"> <span class="number">55</span>:                 log.info(<span class="string">"the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;"</span>,</div><div class="line"> <span class="number">56</span>:                     pullRequest, offset, brokerBusy);</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">if</span> (brokerBusy) &#123;</div><div class="line"> <span class="number">58</span>:                     log.info(<span class="string">"[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;"</span>,</div><div class="line"> <span class="number">59</span>:                         pullRequest, offset);</div><div class="line"> <span class="number">60</span>:                 &#125;</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                 pullRequest.setLockedFirst(<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:                 pullRequest.setNextOffset(offset);</div><div class="line"> <span class="number">64</span>:             &#125;</div><div class="line"> <span class="number">65</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">66</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">67</span>:             log.info(<span class="string">"pull message later because not locked in broker, &#123;&#125;"</span>, pullRequest);</div><div class="line"> <span class="number">68</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">69</span>:         &#125;</div><div class="line"> <span class="number">70</span>:     &#125;</div><div class="line"> <span class="number">71</span>: </div><div class="line"> <span class="number">72</span>:     <span class="comment">// 获取Topic 对应的订阅信息。若不存在，则延迟拉取消息</span></div><div class="line"> <span class="number">73</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"> <span class="number">74</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</div><div class="line"> <span class="number">75</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">76</span>:         log.warn(<span class="string">"find the consumer's subscription failed, &#123;&#125;"</span>, pullRequest);</div><div class="line"> <span class="number">77</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">78</span>:     &#125;</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:     <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     PullCallback pullCallback = <span class="keyword">new</span> PullCallback() &#123;</div><div class="line"> <span class="number">83</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">84</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(PullResult pullResult)</span> </span>&#123;</div><div class="line"> <span class="number">85</span>:             <span class="keyword">if</span> (pullResult != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">86</span>:                 pullResult = DefaultMQPushConsumerImpl.<span class="keyword">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</div><div class="line"> <span class="number">87</span>:                     subscriptionData);</div><div class="line"> <span class="number">88</span>: </div><div class="line"> <span class="number">89</span>:                 <span class="keyword">switch</span> (pullResult.getPullStatus()) &#123;</div><div class="line"> <span class="number">90</span>:                     <span class="keyword">case</span> FOUND:</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// 设置下次拉取消息队列位置</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">long</span> prevRequestOffset = pullRequest.getNextOffset();</div><div class="line"> <span class="number">93</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         <span class="comment">// 统计</span></div><div class="line"> <span class="number">96</span>:                         <span class="keyword">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">97</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</div><div class="line"> <span class="number">98</span>:                             pullRequest.getMessageQueue().getTopic(), pullRT);</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:                         <span class="keyword">long</span> firstMsgOffset = Long.MAX_VALUE;</div><div class="line"><span class="number">101</span>:                         <span class="keyword">if</span> (pullResult.getMsgFoundList() == <span class="keyword">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</div><div class="line"><span class="number">102</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">103</span>:                         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">104</span>:                             firstMsgOffset = pullResult.getMsgFoundList().get(<span class="number">0</span>).getQueueOffset();</div><div class="line"><span class="number">105</span>: </div><div class="line"><span class="number">106</span>:                             <span class="comment">// 统计</span></div><div class="line"><span class="number">107</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</div><div class="line"><span class="number">108</span>:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                             <span class="comment">// 提交拉取到的消息到消息处理队列</span></div><div class="line"><span class="number">111</span>:                             <span class="keyword">boolean</span> dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:                             <span class="comment">// 提交消费请求</span></div><div class="line"><span class="number">114</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.consumeMessageService.submitConsumeRequest(<span class="comment">//</span></div><div class="line"><span class="number">115</span>:                                 pullResult.getMsgFoundList(), <span class="comment">//</span></div><div class="line"><span class="number">116</span>:                                 processQueue, <span class="comment">//</span></div><div class="line"><span class="number">117</span>:                                 pullRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"><span class="number">118</span>:                                 dispathToConsume);</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>:                             <span class="comment">// 提交下次拉取消息请求</span></div><div class="line"><span class="number">121</span>:                             <span class="keyword">if</span> (DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">122</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest,</div><div class="line"><span class="number">123</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval());</div><div class="line"><span class="number">124</span>:                             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">125</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">126</span>:                             &#125;</div><div class="line"><span class="number">127</span>:                         &#125;</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:                         <span class="comment">// 下次拉取消息队列位置小于上次拉取消息队列位置 或者 第一条消息的消息队列位置小于上次拉取消息队列位置，则判定为BUG，输出log</span></div><div class="line"><span class="number">130</span>:                         <span class="keyword">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset<span class="comment">//</span></div><div class="line"><span class="number">131</span>:                             || firstMsgOffset &lt; prevRequestOffset) &#123;</div><div class="line"><span class="number">132</span>:                             log.warn(</div><div class="line"><span class="number">133</span>:                                 <span class="string">"[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">134</span>:                                 pullResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">135</span>:                                 firstMsgOffset, <span class="comment">//</span></div><div class="line"><span class="number">136</span>:                                 prevRequestOffset);</div><div class="line"><span class="number">137</span>:                         &#125;</div><div class="line"><span class="number">138</span>: </div><div class="line"><span class="number">139</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">140</span>:                     <span class="keyword">case</span> NO_NEW_MSG:</div><div class="line"><span class="number">141</span>:                         <span class="comment">// 设置下次拉取消息队列位置</span></div><div class="line"><span class="number">142</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:                         <span class="comment">// 持久化消费进度</span></div><div class="line"><span class="number">145</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">146</span>: </div><div class="line"><span class="number">147</span>:                         <span class="comment">// 立即提交拉取消息请求</span></div><div class="line"><span class="number">148</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">149</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">150</span>:                     <span class="keyword">case</span> NO_MATCHED_MSG:</div><div class="line"><span class="number">151</span>:                         <span class="comment">// 设置下次拉取消息队列位置</span></div><div class="line"><span class="number">152</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:                         <span class="comment">// 持久化消费进度</span></div><div class="line"><span class="number">155</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">156</span>: </div><div class="line"><span class="number">157</span>:                         <span class="comment">// 提交立即拉取消息请求</span></div><div class="line"><span class="number">158</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">159</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">160</span>:                     <span class="keyword">case</span> OFFSET_ILLEGAL:</div><div class="line"><span class="number">161</span>:                         log.warn(<span class="string">"the pull request offset illegal, &#123;&#125; &#123;&#125;"</span>, <span class="comment">//</span></div><div class="line"><span class="number">162</span>:                             pullRequest.toString(), pullResult.toString());</div><div class="line"><span class="number">163</span>:                         <span class="comment">// 设置下次拉取消息队列位置</span></div><div class="line"><span class="number">164</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                         <span class="comment">// 设置消息处理队列为dropped</span></div><div class="line"><span class="number">167</span>:                         pullRequest.getProcessQueue().setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">168</span>: </div><div class="line"><span class="number">169</span>:                         <span class="comment">// 提交延迟任务，进行消费处理队列移除。不立即移除的原因：可能有地方正在使用，避免受到影响。</span></div><div class="line"><span class="number">170</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executeTaskLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">171</span>: </div><div class="line"><span class="number">172</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">173</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">174</span>:                                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">175</span>:                                     <span class="comment">// 更新消费进度，同步消费进度到Broker</span></div><div class="line"><span class="number">176</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(),</div><div class="line"><span class="number">177</span>:                                         pullRequest.getNextOffset(), <span class="keyword">false</span>);</div><div class="line"><span class="number">178</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.persist(pullRequest.getMessageQueue());</div><div class="line"><span class="number">179</span>: </div><div class="line"><span class="number">180</span>:                                     <span class="comment">// 移除消费处理队列</span></div><div class="line"><span class="number">181</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</div><div class="line"><span class="number">182</span>: </div><div class="line"><span class="number">183</span>:                                     log.warn(<span class="string">"fix the pull request offset, &#123;&#125;"</span>, pullRequest);</div><div class="line"><span class="number">184</span>:                                 &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"><span class="number">185</span>:                                     log.error(<span class="string">"executeTaskLater Exception"</span>, e);</div><div class="line"><span class="number">186</span>:                                 &#125;</div><div class="line"><span class="number">187</span>:                             &#125;</div><div class="line"><span class="number">188</span>:                         &#125;, <span class="number">10000</span>);</div><div class="line"><span class="number">189</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">190</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">191</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:                 &#125;</div><div class="line"><span class="number">193</span>:             &#125;</div><div class="line"><span class="number">194</span>:         &#125;</div><div class="line"><span class="number">195</span>: </div><div class="line"><span class="number">196</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">197</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"><span class="number">198</span>:             <span class="keyword">if</span> (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</div><div class="line"><span class="number">199</span>:                 log.warn(<span class="string">"execute the pull request exception"</span>, e);</div><div class="line"><span class="number">200</span>:             &#125;</div><div class="line"><span class="number">201</span>: </div><div class="line"><span class="number">202</span>:             <span class="comment">// 提交延迟拉取消息请求</span></div><div class="line"><span class="number">203</span>:             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">204</span>:         &#125;</div><div class="line"><span class="number">205</span>:     &#125;;</div><div class="line"><span class="number">206</span>: </div><div class="line"><span class="number">207</span>:     <span class="comment">// 集群消息模型下，计算提交的消费进度。</span></div><div class="line"><span class="number">208</span>:     <span class="keyword">boolean</span> commitOffsetEnable = <span class="keyword">false</span>;</div><div class="line"><span class="number">209</span>:     <span class="keyword">long</span> commitOffsetValue = <span class="number">0L</span>;</div><div class="line"><span class="number">210</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING == <span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class="line"><span class="number">211</span>:         commitOffsetValue = <span class="keyword">this</span>.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</div><div class="line"><span class="number">212</span>:         <span class="keyword">if</span> (commitOffsetValue &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">213</span>:             commitOffsetEnable = <span class="keyword">true</span>;</div><div class="line"><span class="number">214</span>:         &#125;</div><div class="line"><span class="number">215</span>:     &#125;</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:     <span class="comment">// 计算请求的 订阅表达式 和 是否进行filtersrv过滤消息</span></div><div class="line"><span class="number">218</span>:     String subExpression = <span class="keyword">null</span>;</div><div class="line"><span class="number">219</span>:     <span class="keyword">boolean</span> classFilter = <span class="keyword">false</span>;</div><div class="line"><span class="number">220</span>:     SubscriptionData sd = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"><span class="number">221</span>:     <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">222</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;</div><div class="line"><span class="number">223</span>:             subExpression = sd.getSubString();</div><div class="line"><span class="number">224</span>:         &#125;</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:         classFilter = sd.isClassFilterMode();</div><div class="line"><span class="number">227</span>:     &#125;</div><div class="line"><span class="number">228</span>: </div><div class="line"><span class="number">229</span>:     <span class="comment">// 计算拉取消息系统标识</span></div><div class="line"><span class="number">230</span>:     <span class="keyword">int</span> sysFlag = PullSysFlag.buildSysFlag(<span class="comment">//</span></div><div class="line"><span class="number">231</span>:         commitOffsetEnable, <span class="comment">// commitOffset</span></div><div class="line"><span class="number">232</span>:         <span class="keyword">true</span>, <span class="comment">// suspend</span></div><div class="line"><span class="number">233</span>:         subExpression != <span class="keyword">null</span>, <span class="comment">// subscription</span></div><div class="line"><span class="number">234</span>:         classFilter <span class="comment">// class filter</span></div><div class="line"><span class="number">235</span>:     );</div><div class="line"><span class="number">236</span>: </div><div class="line"><span class="number">237</span>:     <span class="comment">// 执行拉取。如果拉取请求发生异常时，提交延迟拉取消息请求。</span></div><div class="line"><span class="number">238</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">239</span>:         <span class="keyword">this</span>.pullAPIWrapper.pullKernelImpl(<span class="comment">//</span></div><div class="line"><span class="number">240</span>:             pullRequest.getMessageQueue(), <span class="comment">// 1</span></div><div class="line"><span class="number">241</span>:             subExpression, <span class="comment">// 2</span></div><div class="line"><span class="number">242</span>:             subscriptionData.getSubVersion(), <span class="comment">// 3</span></div><div class="line"><span class="number">243</span>:             pullRequest.getNextOffset(), <span class="comment">// 4</span></div><div class="line"><span class="number">244</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getPullBatchSize(), <span class="comment">// 5</span></div><div class="line"><span class="number">245</span>:             sysFlag, <span class="comment">// 6</span></div><div class="line"><span class="number">246</span>:             commitOffsetValue, <span class="comment">// 7</span></div><div class="line"><span class="number">247</span>:             BROKER_SUSPEND_MAX_TIME_MILLIS, <span class="comment">// 8</span></div><div class="line"><span class="number">248</span>:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, <span class="comment">// 9</span></div><div class="line"><span class="number">249</span>:             CommunicationMode.ASYNC, <span class="comment">// 10</span></div><div class="line"><span class="number">250</span>:             pullCallback<span class="comment">// 11</span></div><div class="line"><span class="number">251</span>:         );</div><div class="line"><span class="number">252</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">253</span>:         log.error(<span class="string">"pullKernelImpl exception"</span>, e);</div><div class="line"><span class="number">254</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">255</span>:     &#125;</div><div class="line"><span class="number">256</span>: &#125;</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">correctTagsOffset</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</div><div class="line"><span class="number">259</span>:     <span class="keyword">if</span> (<span class="number">0L</span> == pullRequest.getProcessQueue().getMsgCount().get()) &#123;</div><div class="line"><span class="number">260</span>:         <span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), <span class="keyword">true</span>);</div><div class="line"><span class="number">261</span>:     &#125;</div><div class="line"><span class="number">262</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#pullMessage(...)</code> 说明 ：拉取消息。
<ul>
<li>第 3 至 6 行 ：消息处理队列已经终止，不进行消息拉取。</li>
<li>第 9 行 ：设置消息处理队列最后拉取消息时间。</li>
<li>第 11 至 18 行 ：<code>Consumer</code> 未处于运行中状态，不进行消息拉取，提交<strong>延迟</strong>拉取消息请求。</li>
<li>第 20 至 25 行 ： <code>Consumer</code> 处于暂停中，不进行消息拉取，提交<strong>延迟</strong>拉取消息请求。</li>
<li>第 27 至 37 行 ：消息处理队列持有消息超过最大允许值（默认：1000条），不进行消息拉取，提交<strong>延迟</strong>拉取消息请求。</li>
<li>第 39 至 49 行 ：<code>Consumer</code> 为<strong>并发消费</strong> 并且 消息队列持有消息跨度过大（消息跨度 = 持有消息最后一条和第一条的消息位置差，默认：2000），不进行消息拉取，提交<strong>延迟</strong>拉取消息请求。</li>
<li>第 50 至 70 行 ：<code>顺序消费</code> 相关跳过，详细解析见：<a href="http://www.iocoder.cn/RocketMQ/message-send-and-consume-orderly/">《RocketMQ 源码分析 —— Message 顺序发送与消费》</a>。</li>
<li>第 72 至 78 行 ：<code>Topic</code> 对应的订阅信息不存在，不进行消息拉取，提交<strong>延迟</strong>拉取消息请求。</li>
<li>第 222 至 224 行 ：判断请求是否使用 <code>Consumer</code> <strong>本地</strong>的订阅信息( <code>SubscriptionData</code> )，而不使用 <code>Broker</code> 里的订阅信息。详细解析见：<a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6">PullMessageProcessor#processRequest(...) 第 64 至 110 行代码</a>。</li>
<li>第 226 行 ：是否开启过滤类过滤模式。详细解析见：<a href="http://www.iocoder.cn/RocketMQ/filtersrv/">《RocketMQ 源码分析 —— Filtersrv》</a>。</li>
<li>第 229 至 235 行 ：计算拉取消息请求系统标识。详细解析见：<a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader">PullMessageRequestHeader.sysFlag</a>。</li>
<li>第 237 至 255 行 ：
<ul>
<li>执行消息拉取<strong>异步</strong>请求。详细解析见：<a href="#pullapiwrapperpullkernelimpl">PullAPIWrapper#pullKernelImpl(...)</a>。</li>
<li>当发起请求产生异常时，提交<strong>延迟</strong>拉取消息请求。对应 <code>Broker</code> 处理拉取消息逻辑见：<a href="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-%E2%80%A6">PullMessageProcessor#processRequest(...)</a>。</li>
</ul>
</li>
</ul>
</li>
<li><code>PullCallback</code> ：拉取消息回调：
<ul>
<li>第 86 行 ：处理拉取结果。详细逻辑见：<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(...)</a>。</li>
<li>第 89 至 192 行 ：处理拉取状态结果：
<ul>
<li>第 90 至 139 行 ：拉取到消息( <code>FOUND</code> ) ：
<ul>
<li>第 91 至 93 行 ：设置下次拉取消息队列位置。</li>
<li>第 95 至 97 行 ：统计。</li>
<li>第 101 至 102 行 ：拉取到消息的消息列表为空，提交<strong>立即</strong>拉取消息请求。为什么会存在拉取到消息，但是消息结果未空呢？原因见：<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(...)</a>。</li>
<li>第 106 至 108 行 ：统计。</li>
<li>第 111 行 ：提交拉取到的消息到消息处理队列。详细解析见：<a href="#processqueueputmessage">ProcessQueue#putMessage(...)</a>。</li>
<li>第 113 至 118 行 ：提交消费请求到 <code>ConsumeMessageService</code>。详细解析见：<a href="#consumemessageconcurrentlyservice">ConsumeMessageConcurrentlyService</a>。</li>
<li>第 120 至 126 行 ：根据拉取频率( <code>pullInterval</code> )，提交<strong>立即或者延迟</strong>拉取消息请求。默认拉取频率为 0ms ，提交<strong>立即</strong>拉取消息请求。</li>
<li>第 129 至 137 行 ：下次拉取消息队列位置小于上次拉取消息队列位置 或者 第一条消息的消息队列位置小于上次拉取消息队列位置，则判定为<strong>BUG</strong>，输出警告日志。</li>
</ul>
</li>
<li>第 140 至 149 行 ：没有新消息( <code>NO_NEW_MSG</code> ) ：
<ul>
<li>第 142 行 ： 设置下次拉取消息队列位置。</li>
<li>第 145 行 ：更正消费进度。详细解析见：<code>#correctTagsOffset(...)</code>。</li>
<li>第 148 行 ：提交<strong>立即</strong>拉取消息请求。</li>
</ul>
</li>
<li>第 150 至 159 行 ：有新消息但是不匹配( <code>NO_MATCHED_MSG</code> )。逻辑同 <code>NO_NEW_MSG</code> 。</li>
<li>第 160 至 189 行 ：拉取请求的消息队列位置不合法 (<code>OFFSET_ILLEGAL</code>)。
<ul>
<li>第 164 行 ：设置下次拉取消息队列位置。</li>
<li>第 167 行 ：设置消息处理队列为 <code>dropped</code>。</li>
<li>第 169 至 188 行 ：提交延迟任务，进行队列移除。
<ul>
<li>第 175 至 178 行 ：更新消费进度，同步消费进度到 <code>Broker</code>。</li>
<li>第 181 行 ：移除消费处理队列。
<ul>
<li>疑问：为什么不立即移除？？？</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>第 196 至 204 行 ：发生异常，提交<strong>延迟</strong>拉取消息请求。</li>
</ul>
</li>
<li><code>#correctTagsOffset(...)</code> ：更正消费进度。
<ul>
<li>第 258 至 261 行 ： 当消费处理队列持有消息数量为 <strong>0</strong> 时，更新消费进度为拉取请求的拉取消息队列位置。</li>
</ul>
</li>
</ul>
<h3>PullAPIWrapper#pullKernelImpl(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 拉取消息核心方法</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> mq 消息队列</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> subExpression 订阅表达式</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> subVersion 订阅版本号</span></div><div class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> offset 拉取队列开始位置</span></div><div class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> maxNums 拉取消息数量</span></div><div class="line"><span class="comment"> 9:  * <span class="doctag">@param</span> sysFlag 拉取请求系统标识</span></div><div class="line"><span class="comment">10:  * <span class="doctag">@param</span> commitOffset 提交消费进度</span></div><div class="line"><span class="comment">11:  * <span class="doctag">@param</span> brokerSuspendMaxTimeMillis broker挂起请求最大时间</span></div><div class="line"><span class="comment">12:  * <span class="doctag">@param</span> timeoutMillis 请求broker超时时长</span></div><div class="line"><span class="comment">13:  * <span class="doctag">@param</span> communicationMode 通讯模式</span></div><div class="line"><span class="comment">14:  * <span class="doctag">@param</span> pullCallback 拉取回调</span></div><div class="line"><span class="comment">15:  * <span class="doctag">@return</span> 拉取消息结果。只有通讯模式为同步时，才返回结果，否则返回null。</span></div><div class="line"><span class="comment">16:  * <span class="doctag">@throws</span> MQClientException 当寻找不到 broker 时，或发生其他client异常</span></div><div class="line"><span class="comment">17:  * <span class="doctag">@throws</span> RemotingException 当远程调用发生异常时</span></div><div class="line"><span class="comment">18:  * <span class="doctag">@throws</span> MQBrokerException 当 broker 发生异常时。只有通讯模式为同步时才会发生该异常。</span></div><div class="line"><span class="comment">19:  * <span class="doctag">@throws</span> InterruptedException 当发生中断异常时</span></div><div class="line"><span class="comment">20:  */</span></div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">protected</span> PullResult <span class="title">pullKernelImpl</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">22</span>:     <span class="keyword">final</span> MessageQueue mq,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">23</span>:     <span class="keyword">final</span> String subExpression,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">24</span>:     <span class="keyword">final</span> <span class="keyword">long</span> subVersion,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">25</span>:     <span class="keyword">final</span> <span class="keyword">long</span> offset,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">26</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxNums,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">27</span>:     <span class="keyword">final</span> <span class="keyword">int</span> sysFlag,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">28</span>:     <span class="keyword">final</span> <span class="keyword">long</span> commitOffset,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">29</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerSuspendMaxTimeMillis,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">30</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">31</span>:     <span class="keyword">final</span> CommunicationMode communicationMode,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">32</span>:     <span class="keyword">final</span> PullCallback pullCallback</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">33</span>: )</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class="line"><span class="number">34</span>:     <span class="comment">// 获取Broker信息</span></div><div class="line"><span class="number">35</span>:     FindBrokerResult findBrokerResult =</div><div class="line"><span class="number">36</span>:         <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">37</span>:             <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == findBrokerResult) &#123;</div><div class="line"><span class="number">39</span>:         <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</div><div class="line"><span class="number">40</span>:         findBrokerResult =</div><div class="line"><span class="number">41</span>:             <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">42</span>:                 <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// 请求拉取消息</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">47</span>:         <span class="keyword">int</span> sysFlagInner = sysFlag;</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:         <span class="keyword">if</span> (findBrokerResult.isSlave()) &#123;</div><div class="line"><span class="number">50</span>:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         PullMessageRequestHeader requestHeader = <span class="keyword">new</span> PullMessageRequestHeader();</div><div class="line"><span class="number">54</span>:         requestHeader.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">55</span>:         requestHeader.setTopic(mq.getTopic());</div><div class="line"><span class="number">56</span>:         requestHeader.setQueueId(mq.getQueueId());</div><div class="line"><span class="number">57</span>:         requestHeader.setQueueOffset(offset);</div><div class="line"><span class="number">58</span>:         requestHeader.setMaxMsgNums(maxNums);</div><div class="line"><span class="number">59</span>:         requestHeader.setSysFlag(sysFlagInner);</div><div class="line"><span class="number">60</span>:         requestHeader.setCommitOffset(commitOffset);</div><div class="line"><span class="number">61</span>:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</div><div class="line"><span class="number">62</span>:         requestHeader.setSubscription(subExpression);</div><div class="line"><span class="number">63</span>:         requestHeader.setSubVersion(subVersion);</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class="line"><span class="number">66</span>:         <span class="keyword">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123; <span class="comment">// TODO filtersrv</span></div><div class="line"><span class="number">67</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class="line"><span class="number">68</span>:         &#125;</div><div class="line"><span class="number">69</span>: </div><div class="line"><span class="number">70</span>:         PullResult pullResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class="line"><span class="number">71</span>:             brokerAddr,</div><div class="line"><span class="number">72</span>:             requestHeader,</div><div class="line"><span class="number">73</span>:             timeoutMillis,</div><div class="line"><span class="number">74</span>:             communicationMode,</div><div class="line"><span class="number">75</span>:             pullCallback);</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:         <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">78</span>:     &#125;</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:     <span class="comment">// Broker信息不存在，则抛出异常</span></div><div class="line"><span class="number">81</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The broker["</span> + mq.getBrokerName() + <span class="string">"] not exist"</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">82</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：拉取消息核心方法。<strong>该方法参数较多，可以看下代码注释上每个参数的说明</strong>😈。</li>
<li>第 34 至 43 行 ：获取 <code>Broker</code> 信息(<code>Broker</code> 地址、是否为从节点)。
<ul>
<li><a href="#pullapiwrapperrecalculatepullfromwhichnode">#recalculatePullFromWhichNode(...)</a></li>
<li><a href="#mqclientinstancefindbrokeraddressinsubscribe">#MQClientInstance#findBrokerAddressInSubscribe(...)</a></li>
</ul>
</li>
<li>第 45 至 78 行 ：<strong>请求拉取消息</strong>。</li>
<li>第 81 行 ：当 <code>Broker</code> 信息不存在，则抛出异常。</li>
</ul>
<h4>PullAPIWrapper#recalculatePullFromWhichNode(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 消息队列 与 拉取Broker 的映射</span></div><div class="line"><span class="comment"> 3:  * 当拉取消息时，会通过该映射获取拉取请求对应的Broker</span></div><div class="line"><span class="comment"> 4:  */</span></div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong<span class="comment">/* brokerId */</span>&gt; pullFromWhichNodeTable =</div><div class="line"> <span class="number">6</span>:     <span class="keyword">new</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(<span class="number">32</span>);</div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 8:  * 是否使用默认Broker</span></div><div class="line"><span class="comment"> 9:  */</span></div><div class="line"><span class="number">10</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> connectBrokerByUser = <span class="keyword">false</span>;</div><div class="line"><span class="number">11</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">12:  * 默认Broker编号</span></div><div class="line"><span class="comment">13:  */</span></div><div class="line"><span class="number">14</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> defaultBrokerId = MixAll.MASTER_ID;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">17:  * 计算消息队列拉取消息对应的Broker编号</span></div><div class="line"><span class="comment">18:  *</span></div><div class="line"><span class="comment">19:  * <span class="doctag">@param</span> mq 消息队列</span></div><div class="line"><span class="comment">20:  * <span class="doctag">@return</span> Broker编号</span></div><div class="line"><span class="comment">21:  */</span></div><div class="line"><span class="number">22</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">recalculatePullFromWhichNode</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>&#123;</div><div class="line"><span class="number">23</span>:     <span class="comment">// 若开启默认Broker开关，则返回默认Broker编号</span></div><div class="line"><span class="number">24</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isConnectBrokerByUser()) &#123;</div><div class="line"><span class="number">25</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultBrokerId;</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:     <span class="comment">// 若消息队列映射拉取Broker存在，则返回映射Broker编号</span></div><div class="line"><span class="number">29</span>:     AtomicLong suggest = <span class="keyword">this</span>.pullFromWhichNodeTable.get(mq);</div><div class="line"><span class="number">30</span>:     <span class="keyword">if</span> (suggest != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">31</span>:         <span class="keyword">return</span> suggest.get();</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// 返回Broker主节点编号</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：计算消息队列拉取消息对应的 <code>Broker</code> 编号。</li>
</ul>
<h4>MQClientInstance#findBrokerAddressInSubscribe(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * Broker名字 和 Broker地址相关 Map</span></div><div class="line"><span class="comment"> 3:  */</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String<span class="comment">/* Broker Name */</span>, HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt;&gt; brokerAddrTable =</div><div class="line"> <span class="number">5</span>:         <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 8:  * 获得Broker信息</span></div><div class="line"><span class="comment"> 9:  *</span></div><div class="line"><span class="comment">10:  * <span class="doctag">@param</span> brokerName broker名字</span></div><div class="line"><span class="comment">11:  * <span class="doctag">@param</span> brokerId broker编号</span></div><div class="line"><span class="comment">12:  * <span class="doctag">@param</span> onlyThisBroker 是否必须是该broker</span></div><div class="line"><span class="comment">13:  * <span class="doctag">@return</span> Broker信息</span></div><div class="line"><span class="comment">14:  */</span></div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> FindBrokerResult <span class="title">findBrokerAddressInSubscribe</span><span class="params">(//</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">16</span>:     <span class="keyword">final</span> String brokerName, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerId, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> onlyThisBroker//</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">19</span>: )</span> </span>&#123;</div><div class="line"><span class="number">20</span>:     String brokerAddr = <span class="keyword">null</span>; <span class="comment">// broker地址</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">boolean</span> slave = <span class="keyword">false</span>; <span class="comment">// 是否为从节点</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">boolean</span> found = <span class="keyword">false</span>; <span class="comment">// 是否找到</span></div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     <span class="comment">// 获得Broker信息</span></div><div class="line"><span class="number">25</span>:     HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt; map = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</div><div class="line"><span class="number">26</span>:     <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; !map.isEmpty()) &#123;</div><div class="line"><span class="number">27</span>:         brokerAddr = map.get(brokerId);</div><div class="line"><span class="number">28</span>:         slave = brokerId != MixAll.MASTER_ID;</div><div class="line"><span class="number">29</span>:         found = brokerAddr != <span class="keyword">null</span>;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:         <span class="comment">// 如果不强制获得，选择一个Broker</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (!found &amp;&amp; !onlyThisBroker) &#123;</div><div class="line"><span class="number">33</span>:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();</div><div class="line"><span class="number">34</span>:             brokerAddr = entry.getValue();</div><div class="line"><span class="number">35</span>:             slave = entry.getKey() != MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>:             found = <span class="keyword">true</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:     &#125;</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="comment">// 找到broker，则返回信息</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">if</span> (found) &#123;</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="keyword">new</span> FindBrokerResult(brokerAddr, slave);</div><div class="line"><span class="number">43</span>:     &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// 找不到，则返回空</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：获取 <code>Broker</code> 信息(<code>Broker</code> 地址、是否为从节点)。</li>
</ul>
<h3>PullAPIWrapper#processPullResult(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 处理拉取结果</span></div><div class="line"><span class="comment"> 3:  * 1. 更新消息队列拉取消息Broker编号的映射</span></div><div class="line"><span class="comment"> 4:  * 2. 解析消息，并根据订阅信息消息tagCode匹配合适消息</span></div><div class="line"><span class="comment"> 5:  *</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> mq 消息队列</span></div><div class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> pullResult 拉取结果</span></div><div class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> subscriptionData 订阅信息</span></div><div class="line"><span class="comment"> 9:  * <span class="doctag">@return</span> 拉取结果</span></div><div class="line"><span class="comment">10:  */</span></div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> PullResult <span class="title">processPullResult</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> PullResult pullResult,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">12</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData)</span> </span>&#123;</div><div class="line"><span class="number">13</span>:     PullResultExt pullResultExt = (PullResultExt) pullResult;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="comment">// 更新消息队列拉取消息Broker编号的映射</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="comment">// 解析消息，并根据订阅信息消息tagCode匹配合适消息</span></div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</div><div class="line"><span class="number">20</span>:         <span class="comment">// 解析消息</span></div><div class="line"><span class="number">21</span>:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</div><div class="line"><span class="number">22</span>:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="comment">// 根据订阅信息消息tagCode匹配合适消息</span></div><div class="line"><span class="number">25</span>:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;</div><div class="line"><span class="number">26</span>:         <span class="keyword">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</div><div class="line"><span class="number">27</span>:             msgListFilterAgain = <span class="keyword">new</span> ArrayList&lt;&gt;(msgList.size());</div><div class="line"><span class="number">28</span>:             <span class="keyword">for</span> (MessageExt msg : msgList) &#123;</div><div class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (msg.getTags() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</div><div class="line"><span class="number">31</span>:                         msgListFilterAgain.add(msg);</div><div class="line"><span class="number">32</span>:                     &#125;</div><div class="line"><span class="number">33</span>:                 &#125;</div><div class="line"><span class="number">34</span>:             &#125;</div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">38</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasHook()) &#123;</div><div class="line"><span class="number">39</span>:             FilterMessageContext filterMessageContext = <span class="keyword">new</span> FilterMessageContext();</div><div class="line"><span class="number">40</span>:             filterMessageContext.setUnitMode(unitMode);</div><div class="line"><span class="number">41</span>:             filterMessageContext.setMsgList(msgListFilterAgain);</div><div class="line"><span class="number">42</span>:             <span class="keyword">this</span>.executeHook(filterMessageContext);</div><div class="line"><span class="number">43</span>:         &#125;</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         <span class="comment">// 设置消息队列当前最小/最大位置到消息拓展字段</span></div><div class="line"><span class="number">46</span>:         <span class="keyword">for</span> (MessageExt msg : msgListFilterAgain) &#123;</div><div class="line"><span class="number">47</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</div><div class="line"><span class="number">48</span>:                 Long.toString(pullResult.getMinOffset()));</div><div class="line"><span class="number">49</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</div><div class="line"><span class="number">50</span>:                 Long.toString(pullResult.getMaxOffset()));</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         <span class="comment">// 设置消息列表</span></div><div class="line"><span class="number">54</span>:         pullResultExt.setMsgFoundList(msgListFilterAgain);</div><div class="line"><span class="number">55</span>:     &#125;</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="comment">// 清空消息二进制数组</span></div><div class="line"><span class="number">58</span>:     pullResultExt.setMessageBinary(<span class="keyword">null</span>);</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">61</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：处理拉取结果。
<ul>
<li>更新消息队列拉取消息 <code>Broker</code> 编号的映射。</li>
<li>解析消息，并根据订阅信息消息 <code>tagCode</code>匹配合适消息。</li>
</ul>
</li>
<li>第 16 行 ：更新消息队列拉取消息 <code>Broker</code> 编号的映射。下次拉取消息时，如果未设置默认拉取的 <code>Broker</code> 编号，会使用更新后的 <code>Broker</code> 编号。</li>
<li>第 18 至 55 行 ：解析消息，并根据订阅信息消息 <code>tagCode</code> 匹配合适消息。
<ul>
<li>第 20 至 22 行 ：解析消息。详细解析见：<a href="http://www.iocoder.cn/RocketMQ/message/">《RocketMQ 源码分析 —— Message基础》</a> 。</li>
<li>第 24 至 35 行 ：根据订阅信息<code>tagCode</code> 匹配消息。</li>
<li>第 37 至 43 行 ：<code>Hook</code>。</li>
<li>第 45 至 51 行 ：设置消息队列当前最小/最大位置到消息拓展字段。</li>
<li>第 54 行 ：设置消息队列。</li>
</ul>
</li>
<li>第 58 行 ：清空消息二进制数组。</li>
</ul>
<h3>ProcessQueue#putMessage(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:  <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 消息映射读写锁</span></div><div class="line"><span class="comment"> 3:  */</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lockTreeMap = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:  * 消息映射</span></div><div class="line"><span class="comment"> 7:  * key：消息队列位置</span></div><div class="line"><span class="comment"> 8:  */</span></div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">11:  * 消息数</span></div><div class="line"><span class="comment">12:  */</span></div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong msgCount = <span class="keyword">new</span> AtomicLong();</div><div class="line"><span class="number">14</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">15:  * 添加消息最大队列位置</span></div><div class="line"><span class="comment">16:  */</span></div><div class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> queueOffsetMax = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">19:  * 是否正在消费</span></div><div class="line"><span class="comment">20:  */</span></div><div class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">22</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">23:  * Broker累计消息数量</span></div><div class="line"><span class="comment">24:  * 计算公式 = queueMaxOffset - 新添加消息数组[n - 1].queueOffset</span></div><div class="line"><span class="comment">25:  * Acc = Accumulation</span></div><div class="line"><span class="comment">26:  * cnt = （猜测）对比度</span></div><div class="line"><span class="comment">27:  */</span></div><div class="line"><span class="number">28</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> msgAccCnt = <span class="number">0</span>;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">31:  * 添加消息，并返回是否提交给消费者</span></div><div class="line"><span class="comment">32:  * 返回true，当有新消息添加成功时，</span></div><div class="line"><span class="comment">33:  *</span></div><div class="line"><span class="comment">34:  * <span class="doctag">@param</span> msgs 消息</span></div><div class="line"><span class="comment">35:  * <span class="doctag">@return</span> 是否提交给消费者</span></div><div class="line"><span class="comment">36:  */</span></div><div class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"><span class="number">38</span>:     <span class="keyword">boolean</span> dispatchToConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">39</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">40</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">41</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">42</span>:             <span class="comment">// 添加消息</span></div><div class="line"><span class="number">43</span>:             <span class="keyword">int</span> validMsgCnt = <span class="number">0</span>;</div><div class="line"><span class="number">44</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">45</span>:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == old) &#123;</div><div class="line"><span class="number">47</span>:                     validMsgCnt++;</div><div class="line"><span class="number">48</span>:                     <span class="keyword">this</span>.queueOffsetMax = msg.getQueueOffset();</div><div class="line"><span class="number">49</span>:                 &#125;</div><div class="line"><span class="number">50</span>:             &#125;</div><div class="line"><span class="number">51</span>:             msgCount.addAndGet(validMsgCnt);</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:             <span class="comment">// 计算是否正在消费</span></div><div class="line"><span class="number">54</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; !<span class="keyword">this</span>.consuming) &#123;</div><div class="line"><span class="number">55</span>:                 dispatchToConsume = <span class="keyword">true</span>;</div><div class="line"><span class="number">56</span>:                 <span class="keyword">this</span>.consuming = <span class="keyword">true</span>;</div><div class="line"><span class="number">57</span>:             &#125;</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// Broker累计消息数量</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">if</span> (!msgs.isEmpty()) &#123;</div><div class="line"><span class="number">61</span>:                 MessageExt messageExt = msgs.get(msgs.size() - <span class="number">1</span>);</div><div class="line"><span class="number">62</span>:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</div><div class="line"><span class="number">63</span>:                 <span class="keyword">if</span> (property != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">64</span>:                     <span class="keyword">long</span> accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</div><div class="line"><span class="number">65</span>:                     <span class="keyword">if</span> (accTotal &gt; <span class="number">0</span>) &#123;</div><div class="line"><span class="number">66</span>:                         <span class="keyword">this</span>.msgAccCnt = accTotal;</div><div class="line"><span class="number">67</span>:                     &#125;</div><div class="line"><span class="number">68</span>:                 &#125;</div><div class="line"><span class="number">69</span>:             &#125;</div><div class="line"><span class="number">70</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">71</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">72</span>:         &#125;</div><div class="line"><span class="number">73</span>:     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">74</span>:         log.error(<span class="string">"putMessage exception"</span>, e);</div><div class="line"><span class="number">75</span>:     &#125;</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:     <span class="keyword">return</span> dispatchToConsume;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>总结</h2>
<p>如果用最简单粗暴的方式描述 <code>PullConsumer</code> 拉取消息的过程，那就是如下的代码：</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (不满足拉取消息) &#123;</div><div class="line">        Thread.sleep(间隔);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    主动拉取消息();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>6、PushConsumer 消费消息</h1>
<p><img src="http://www.iocoder.cn/images/RocketMQ/2017_05_04/06.png" alt="DefaultMQPushConsumerImpl消费消息"></p>
<h2>ConsumeMessageConcurrentlyService 提交消费请求</h2>
<h3>ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 消费线程池队列</span></div><div class="line"><span class="comment"> 3:  */</span></div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 6:  * 消费线程池</span></div><div class="line"><span class="comment"> 7:  */</span></div><div class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor consumeExecutor;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitConsumeRequest</span><span class="params">(//</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">11</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">12</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">13</span>:     <span class="keyword">final</span> MessageQueue messageQueue, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">14</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> dispatchToConsume)</span> </span>&#123;</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (msgs.size() &lt;= consumeBatchSize) &#123; <span class="comment">// 提交消息小于批量消息数，直接提交消费请求</span></div><div class="line"><span class="number">17</span>:         ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">19</span>:             <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">20</span>:         &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">22</span>:         &#125;</div><div class="line"><span class="number">23</span>:     &#125; <span class="keyword">else</span> &#123; <span class="comment">// 提交消息大于批量消息数，进行分拆成多个消费请求</span></div><div class="line"><span class="number">24</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> total = <span class="number">0</span>; total &lt; msgs.size(); ) &#123;</div><div class="line"><span class="number">25</span>:             <span class="comment">// 计算当前拆分请求包含的消息</span></div><div class="line"><span class="number">26</span>:             List&lt;MessageExt&gt; msgThis = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeBatchSize);</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consumeBatchSize; i++, total++) &#123;</div><div class="line"><span class="number">28</span>:                 <span class="keyword">if</span> (total &lt; msgs.size()) &#123;</div><div class="line"><span class="number">29</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">30</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">31</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:                 &#125;</div><div class="line"><span class="number">33</span>:             &#125;</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:             <span class="comment">// 提交拆分消费请求</span></div><div class="line"><span class="number">36</span>:             ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</div><div class="line"><span class="number">37</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">38</span>:                 <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">39</span>:             &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line"><span class="number">40</span>:                 <span class="comment">// 如果被拒绝，则将当前拆分消息+剩余消息提交延迟消费请求。</span></div><div class="line"><span class="number">41</span>:                 <span class="keyword">for</span> (; total &lt; msgs.size(); total++) &#123;</div><div class="line"><span class="number">42</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">43</span>:                 &#125;</div><div class="line"><span class="number">44</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">45</span>:             &#125;</div><div class="line"><span class="number">46</span>:         &#125;</div><div class="line"><span class="number">47</span>:     &#125;</div><div class="line"><span class="number">48</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：提交<strong>立即</strong>消费请求。</li>
<li>第 16 至 22 行 ：提交消息小于等于批量消费数，直接提交消费请求。</li>
<li>第 23 至 47 行 ：当提交消息大于批量消费数，进行分拆成多个请求。
<ul>
<li>第 25 至 33 行 ：计算当前拆分请求包含的消息。</li>
<li>第 35 至 38 行 ：提交拆分消费请求。</li>
<li>第 39 至 44 行 ：提交请求被拒绝，则将当前拆分消息 + 剩余消息提交延迟消费请求，结束拆分循环。</li>
</ul>
</li>
</ul>
<h3>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 提交延迟消费请求</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> msgs 消息列表</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> processQueue 消息处理队列</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> messageQueue 消息队列</span></div><div class="line"><span class="comment"> 7:  */</span></div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(//</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">9</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">10</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">11</span>:     <span class="keyword">final</span> MessageQueue messageQueue//</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">12</span>: )</span> </span>&#123;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">18</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.submitConsumeRequest(msgs, processQueue, messageQueue, <span class="keyword">true</span>);</div><div class="line"><span class="number">19</span>:         &#125;</div><div class="line"><span class="number">20</span>:     &#125;, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">21</span>: &#125;</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">24:  * 提交延迟消费请求</span></div><div class="line"><span class="comment">25:  * <span class="doctag">@param</span> consumeRequest 消费请求</span></div><div class="line"><span class="comment">26:  */</span></div><div class="line"><span class="number">27</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(<span class="keyword">final</span> ConsumeRequest consumeRequest//</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">28</span>: )</span> </span>&#123;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">34</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumeExecutor.submit(consumeRequest); <span class="comment">// TODO BUG ?</span></div><div class="line"><span class="number">35</span>:         &#125;</div><div class="line"><span class="number">36</span>:     &#125;, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：提交延迟消费请求。</li>
<li>第 34 行 ：直接调用 <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>。如果消息数超过批量消费上限，会不会是<strong>BUG</strong>。</li>
</ul>
<h2>ConsumeRequest</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">  4:      * 消费消息列表</span></div><div class="line"><span class="comment">  5:      */</span></div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageExt&gt; msgs;</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment">  8:      * 消息处理队列</span></div><div class="line"><span class="comment">  9:      */</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 12:      * 消息队列</span></div><div class="line"><span class="comment"> 13:      */</span></div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumeRequest</span><span class="params">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue)</span> </span>&#123;</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.msgs = msgs;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">this</span>.processQueue = processQueue;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.messageQueue = messageQueue;</div><div class="line"> <span class="number">20</span>:     &#125;</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">23</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">24</span>:         <span class="comment">// 废弃队列不进行消费</span></div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</div><div class="line"> <span class="number">26</span>:             log.info(<span class="string">"the message queue not be able to consume, because it's dropped. group=&#123;&#125; &#123;&#125;"</span>, ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">27</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">28</span>:         &#125;</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.messageListener; <span class="comment">// 监听器</span></div><div class="line"> <span class="number">31</span>:         ConsumeConcurrentlyContext context = <span class="keyword">new</span> ConsumeConcurrentlyContext(messageQueue); <span class="comment">// 消费Context</span></div><div class="line"> <span class="number">32</span>:         ConsumeConcurrentlyStatus status = <span class="keyword">null</span>; <span class="comment">// 消费结果状态</span></div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">35</span>:         ConsumeMessageContext consumeMessageContext = <span class="keyword">null</span>;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"> <span class="number">37</span>:             consumeMessageContext = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">38</span>:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">39</span>:             consumeMessageContext.setProps(<span class="keyword">new</span> HashMap&lt;String, String&gt;());</div><div class="line"> <span class="number">40</span>:             consumeMessageContext.setMq(messageQueue);</div><div class="line"> <span class="number">41</span>:             consumeMessageContext.setMsgList(msgs);</div><div class="line"> <span class="number">42</span>:             consumeMessageContext.setSuccess(<span class="keyword">false</span>);</div><div class="line"> <span class="number">43</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</div><div class="line"> <span class="number">44</span>:         &#125;</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">47</span>:         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">48</span>:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; <span class="comment">// 消费返回结果类型</span></div><div class="line"> <span class="number">49</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">50</span>:             <span class="comment">// 当消息为重试消息，设置Topic为原始Topic</span></div><div class="line"> <span class="number">51</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.resetRetryTopic(msgs);</div><div class="line"> <span class="number">52</span>: </div><div class="line"> <span class="number">53</span>:             <span class="comment">// 设置开始消费时间</span></div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</div><div class="line"> <span class="number">55</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"> <span class="number">56</span>:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</div><div class="line"> <span class="number">57</span>:                 &#125;</div><div class="line"> <span class="number">58</span>:             &#125;</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// 进行消费</span></div><div class="line"> <span class="number">61</span>:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">62</span>:         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line"> <span class="number">63</span>:             log.warn(<span class="string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</div><div class="line"> <span class="number">64</span>:                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">65</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">66</span>:                 msgs,</div><div class="line"> <span class="number">67</span>:                 messageQueue);</div><div class="line"> <span class="number">68</span>:             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">69</span>:         &#125;</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>:         <span class="comment">// 解析消费返回结果类型</span></div><div class="line"> <span class="number">72</span>:         <span class="keyword">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">73</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</div><div class="line"> <span class="number">74</span>:             <span class="keyword">if</span> (hasException) &#123;</div><div class="line"> <span class="number">75</span>:                 returnType = ConsumeReturnType.EXCEPTION;</div><div class="line"> <span class="number">76</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">77</span>:                 returnType = ConsumeReturnType.RETURNNULL;</div><div class="line"> <span class="number">78</span>:             &#125;</div><div class="line"> <span class="number">79</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line"> <span class="number">80</span>:             returnType = ConsumeReturnType.TIME_OUT;</div><div class="line"> <span class="number">81</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</div><div class="line"> <span class="number">82</span>:             returnType = ConsumeReturnType.FAILED;</div><div class="line"> <span class="number">83</span>:         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</div><div class="line"> <span class="number">84</span>:             returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">85</span>:         &#125;</div><div class="line"> <span class="number">86</span>: </div><div class="line"> <span class="number">87</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">88</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"> <span class="number">89</span>:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</div><div class="line"> <span class="number">90</span>:         &#125;</div><div class="line"> <span class="number">91</span>: </div><div class="line"> <span class="number">92</span>:         <span class="comment">// 消费结果状态为空时，则设置为稍后重新消费</span></div><div class="line"> <span class="number">93</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</div><div class="line"> <span class="number">94</span>:             log.warn(<span class="string">"consumeMessage return null, Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</div><div class="line"> <span class="number">95</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">96</span>:                 msgs,</div><div class="line"> <span class="number">97</span>:                 messageQueue);</div><div class="line"> <span class="number">98</span>:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</div><div class="line"> <span class="number">99</span>:         &#125;</div><div class="line"><span class="number">100</span>: </div><div class="line"><span class="number">101</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">102</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</div><div class="line"><span class="number">103</span>:             consumeMessageContext.setStatus(status.toString());</div><div class="line"><span class="number">104</span>:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</div><div class="line"><span class="number">105</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</div><div class="line"><span class="number">106</span>:         &#125;</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:         <span class="comment">// 统计</span></div><div class="line"><span class="number">109</span>:         ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"><span class="number">110</span>:             .incConsumeRT(ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:         <span class="comment">// 处理消费结果</span></div><div class="line"><span class="number">113</span>:         <span class="keyword">if</span> (!processQueue.isDropped()) &#123;</div><div class="line"><span class="number">114</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.processConsumeResult(status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">115</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">116</span>:             log.warn(<span class="string">"processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;"</span>, messageQueue, msgs);</div><div class="line"><span class="number">117</span>:         &#125;</div><div class="line"><span class="number">118</span>:     &#125;</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：消费请求。提交请求执行消费。</li>
<li>第 24 至 28 行 ：废弃处理队列不进行消费。</li>
<li>第 34 至 44 行 ：Hook。</li>
<li>第 51 行 ：当消息为重试消息，设置 <code>Topic</code>为原始 <code>Topic</code>。例如：原始 <code>Topic</code> 为 <code>TopicTest</code>，重试时 <code>Topic</code> 为 <code>%RETRY%please_rename_unique_group_name_4</code>，经过该方法，<code>Topic</code> 设置回 <code>TopicTest</code>。</li>
<li>第 53 至 58 行 ：设置开始消费时间。</li>
<li>第 61 行 ：<strong>进行消费</strong>。</li>
<li>第 71 至 85 行 ：解析消费返回结果类型</li>
<li>第 87 至 90 行 ：<code>Hook</code>。</li>
<li>第 92 至 99 行 ：消费结果状态未空时，则设置消费结果状态为稍后消费。</li>
<li>第 101 至 106 行 ：<code>Hook</code>。</li>
<li>第 108 至 110 行 ：统计。</li>
<li>第 112 至 117 行 ：处理消费结果。<strong>如果消费处理队列被移除，恰好消息被消费，则可能导致消息重复消费，因此，消息消费要尽最大可能性实现幂等性</strong>。详细解析见：<a href="#consumemessageconcurrentlyserviceprocessconsumeresult">ConsumeMessageConcurrentlyService#processConsumeResult(...)</a>。</li>
</ul>
<h2>ConsumeMessageConcurrentlyService#processConsumeResult(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">2</span>:     <span class="keyword">final</span> ConsumeConcurrentlyStatus status, //</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeConcurrentlyContext context, //</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">4</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</span></span></div><div class="line"><span class="function"><span class="params"> <span class="number">5</span>: )</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:     <span class="keyword">int</span> ackIndex = context.getAckIndex();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// 消息为空，直接返回</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (consumeRequest.getMsgs().isEmpty())</div><div class="line"><span class="number">10</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="comment">// 计算从consumeRequest.msgs[0]到consumeRequest.msgs[ackIndex]的消息消费成功</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">switch</span> (status) &#123;</div><div class="line"><span class="number">14</span>:         <span class="keyword">case</span> CONSUME_SUCCESS:</div><div class="line"><span class="number">15</span>:             <span class="keyword">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</div><div class="line"><span class="number">16</span>:                 ackIndex = consumeRequest.getMsgs().size() - <span class="number">1</span>;</div><div class="line"><span class="number">17</span>:             &#125;</div><div class="line"><span class="number">18</span>:             <span class="comment">// 统计成功/失败数量</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">int</span> ok = ackIndex + <span class="number">1</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">int</span> failed = consumeRequest.getMsgs().size() - ok;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</div><div class="line"><span class="number">22</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</div><div class="line"><span class="number">23</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:         <span class="keyword">case</span> RECONSUME_LATER:</div><div class="line"><span class="number">25</span>:             ackIndex = -<span class="number">1</span>;</div><div class="line"><span class="number">26</span>:             <span class="comment">// 统计成功/失败数量</span></div><div class="line"><span class="number">27</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</div><div class="line"><span class="number">28</span>:                 consumeRequest.getMsgs().size());</div><div class="line"><span class="number">29</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">30</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">31</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// 处理消费失败的消息</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">switch</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> BROADCASTING: <span class="comment">// 广播模式，无论是否消费失败，不发回消息到Broker，只打印Log</span></div><div class="line"><span class="number">37</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class="line"><span class="number">38</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">39</span>:                 log.warn(<span class="string">"BROADCASTING, the message consume failed, drop it, &#123;&#125;"</span>, msg.toString());</div><div class="line"><span class="number">40</span>:             &#125;</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> CLUSTERING:</div><div class="line"><span class="number">43</span>:             <span class="comment">// 发回消息失败到Broker。</span></div><div class="line"><span class="number">44</span>:             List&lt;MessageExt&gt; msgBackFailed = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeRequest.getMsgs().size());</div><div class="line"><span class="number">45</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</div><div class="line"><span class="number">46</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">47</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">this</span>.sendMessageBack(msg, context);</div><div class="line"><span class="number">48</span>:                 <span class="keyword">if</span> (!result) &#123;</div><div class="line"><span class="number">49</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">50</span>:                     msgBackFailed.add(msg);</div><div class="line"><span class="number">51</span>:                 &#125;</div><div class="line"><span class="number">52</span>:             &#125;</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:             <span class="comment">// 发回Broker失败的消息，直接提交延迟重新消费</span></div><div class="line"><span class="number">55</span>:             <span class="keyword">if</span> (!msgBackFailed.isEmpty()) &#123;</div><div class="line"><span class="number">56</span>:                 consumeRequest.getMsgs().removeAll(msgBackFailed);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</div><div class="line"><span class="number">59</span>:             &#125;</div><div class="line"><span class="number">60</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">61</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">62</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">63</span>:     &#125;</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">// 移除消费成功消息，并更新最新消费进度</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</div><div class="line"><span class="number">67</span>:     <span class="keyword">if</span> (offset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</div><div class="line"><span class="number">68</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class="keyword">true</span>);</div><div class="line"><span class="number">69</span>:     &#125;</div><div class="line"><span class="number">70</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：处理消费结果。</li>
<li>第 8 至 10 行 ：消费请求消息未空时，直接返回。</li>
<li>第 12 至 32 行 ：计算 <code>ackIndex</code> 值。<code>consumeRequest.msgs[0 - ackIndex]</code>为消费成功，需要进行 <code>ack</code> 确认。
<ul>
<li>第 14 至 23 行 ：<code>CONSUME_SUCCESS</code> ：<code>ackIndex = context.getAckIndex()</code>。</li>
<li>第 24 至 29 行 ：<code>RECONSUME_LATER</code> ：<code>ackIndex = -1</code>。</li>
</ul>
</li>
<li>第34 至 63 行 ：处理消费失败的消息。
<ul>
<li>第 36 至 41 行 ：<code>BROADCASTING</code> ：广播模式，无论是否消费失败，不发回消息到 <code>Broker</code>，只打印日志。</li>
<li>第 42 至 60 行 ：<code>CLUSTERING</code> ：集群模式，消费失败的消息发回到 <code>Broker</code>。
<ul>
<li>第 43 至 52 行 ：发回消费失败的消息到 <code>Broker</code>。详细解析见：<a href="#defaultmqpushconsumerimplsendmessageback">DefaultMQPushConsumerImpl#sendMessageBack(...)</a>。</li>
<li>第 54 至 59 行 ：发回 <code>Broker</code> 失败的消息，直接提交延迟重新消费。</li>
<li><strong>如果发回 <code>Broker</code> 成功，结果因为例如网络异常，导致 <code>Consumer</code>以为发回失败，判定消费发回失败，会导致消息重复消费，因此，消息消费要尽最大可能性实现幂等性。</strong></li>
</ul>
</li>
</ul>
</li>
<li>第 65 至 69 行 ：移除**【消费成功】<strong>和</strong>【消费失败但发回<code>Broker</code>成功】**的消息，并更新最新消费进度。
<ul>
<li>为什么会有**【消费失败但发回<code>Broker</code>成功】<strong>的消息？见</strong>第 56 行**。</li>
<li><a href="#processqueueremovemessage">ProcessQueue#removeMessage(...)</a></li>
</ul>
</li>
</ul>
<h3>ProcessQueue#removeMessage(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * 移除消息，并返回第一条消息队列位置</span></div><div class="line"><span class="comment"> 3:  *</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> msgs 消息</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@return</span> 消息队列位置</span></div><div class="line"><span class="comment"> 6:  */</span></div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">removeMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>&#123;</div><div class="line"> <span class="number">8</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">10</span>:     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">11</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">12</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"><span class="number">13</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class="line"><span class="number">15</span>:                 result = <span class="keyword">this</span>.queueOffsetMax + <span class="number">1</span>; <span class="comment">// 这里+1的原因是：如果msgTreeMap为空时，下一条获得的消息位置为queueOffsetMax+1</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:                 <span class="comment">// 移除消息</span></div><div class="line"><span class="number">18</span>:                 <span class="keyword">int</span> removedCnt = <span class="number">0</span>;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</div><div class="line"><span class="number">20</span>:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());</div><div class="line"><span class="number">21</span>:                     <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>:                         removedCnt--;</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:                 msgCount.addAndGet(removedCnt);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty()) &#123;</div><div class="line"><span class="number">28</span>:                     result = msgTreeMap.firstKey();</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"><span class="number">35</span>:         log.error(<span class="string">"removeMessage exception"</span>, t);</div><div class="line"><span class="number">36</span>:     &#125;</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">39</span>: &#125;</div></pre></td></tr></table></figure></p>
<h2>ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:             cleanExpireMsg();</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     &#125;, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);</div><div class="line"><span class="number">10</span>: &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">/**</span></div><div class="line"><span class="comment">13:  * 清理过期消息</span></div><div class="line"><span class="comment">14:  */</span></div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanExpireMsg</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">16</span>:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();</div><div class="line"><span class="number">18</span>:     <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line"><span class="number">19</span>:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"><span class="number">20</span>:         ProcessQueue pq = next.getValue();</div><div class="line"><span class="number">21</span>:         pq.cleanExpiredMsg(<span class="keyword">this</span>.defaultMQPushConsumer);</div><div class="line"><span class="number">22</span>:     &#125;</div><div class="line"><span class="number">23</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：定时清理过期消息，默认周期：15min。</li>
</ul>
<h3>ProcessQueue#cleanExpiredMsg(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanExpiredMsg</span><span class="params">(DefaultMQPushConsumer pushConsumer)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// 顺序消费时，直接返回</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     &#125;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// 循环移除消息</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> loop = msgTreeMap.size() &lt; <span class="number">16</span> ? msgTreeMap.size() : <span class="number">16</span>; <span class="comment">// 每次循环最多移除16条</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop; i++) &#123;</div><div class="line"><span class="number">10</span>:         <span class="comment">// 获取第一条消息。判断是否超时，若不超时，则结束循环</span></div><div class="line"><span class="number">11</span>:         MessageExt msg = <span class="keyword">null</span>;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.lockTreeMap.readLock().lockInterruptibly();</div><div class="line"><span class="number">14</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line"><span class="number">16</span>:                     msg = msgTreeMap.firstEntry().getValue();</div><div class="line"><span class="number">17</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">18</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">19</span>:                 &#125;</div><div class="line"><span class="number">20</span>:             &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">this</span>.lockTreeMap.readLock().unlock();</div><div class="line"><span class="number">22</span>:             &#125;</div><div class="line"><span class="number">23</span>:         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">24</span>:             log.error(<span class="string">"getExpiredMsg exception"</span>, e);</div><div class="line"><span class="number">25</span>:         &#125;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">28</span>:             <span class="comment">// 发回超时消息</span></div><div class="line"><span class="number">29</span>:             pushConsumer.sendMessageBack(msg, <span class="number">3</span>);</div><div class="line"><span class="number">30</span>:             log.info(<span class="string">"send expire msg back. topic=&#123;&#125;, msgId=&#123;&#125;, storeHost=&#123;&#125;, queueId=&#123;&#125;, queueOffset=&#123;&#125;"</span>, msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// 判断此时消息是否依然是第一条，若是，则进行移除</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">34</span>:                 <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">35</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">36</span>:                     <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) &#123;</div><div class="line"><span class="number">37</span>:                         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">38</span>:                             msgTreeMap.remove(msgTreeMap.firstKey());</div><div class="line"><span class="number">39</span>:                         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">40</span>:                             log.error(<span class="string">"send expired msg exception"</span>, e);</div><div class="line"><span class="number">41</span>:                         &#125;</div><div class="line"><span class="number">42</span>:                     &#125;</div><div class="line"><span class="number">43</span>:                 &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">44</span>:                     <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">45</span>:                 &#125;</div><div class="line"><span class="number">46</span>:             &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"><span class="number">47</span>:                 log.error(<span class="string">"getExpiredMsg exception"</span>, e);</div><div class="line"><span class="number">48</span>:             &#125;</div><div class="line"><span class="number">49</span>:         &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">50</span>:             log.error(<span class="string">"send expired msg exception"</span>, e);</div><div class="line"><span class="number">51</span>:         &#125;</div><div class="line"><span class="number">52</span>:     &#125;</div><div class="line"><span class="number">53</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：移除过期消息。</li>
<li>第 2 至 5 行 ：顺序消费时，直接返回。</li>
<li>第 7 至 9 行 ：循环移除消息。默认最大循环次数：16次。</li>
<li>第 10 至 25 行 ：获取第一条消息。判断是否超时，若不超时，则结束循环。</li>
<li>第 29 行 ：<strong>发回超时消息到<code>Broker</code></strong>。</li>
<li>第 32 至 48 行 ：判断此时消息是否依然是第一条，若是，则进行移除。</li>
</ul>
<h1>7、PushConsumer 发回消费失败消息</h1>
<h2>DefaultMQPushConsumerImpl#sendMessageBack(...)</h2>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageBack</span><span class="params">(MessageExt msg, <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> String brokerName)</span></span></div><div class="line"><span class="function"> 2:     <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">4</span>:         <span class="comment">// Consumer发回消息</span></div><div class="line"> <span class="number">5</span>:         String brokerAddr = (<span class="keyword">null</span> != brokerName) ? <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</div><div class="line"> <span class="number">6</span>:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</div><div class="line"> <span class="number">8</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class="number">5000</span>, getMaxReconsumeTimes());</div><div class="line"> <span class="number">9</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123; <span class="comment">// TODO 疑问：什么情况下会发生异常</span></div><div class="line"><span class="number">10</span>:         <span class="comment">// 异常时，使用Client内置Producer发回消息</span></div><div class="line"><span class="number">11</span>:         log.error(<span class="string">"sendMessageBack Exception, "</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">16</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">19</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">20</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">21</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class="number">1</span>));</div><div class="line"><span class="number">22</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">23</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:         <span class="keyword">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">26</span>:     &#125;</div><div class="line"><span class="number">27</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：发回消息。</li>
<li>第 4 至 8 行 ：<code>Consumer</code> 发回消息。详细解析见：<a href="#mqclientapiimplconsumersendmessageback">MQClientAPIImpl#consumerSendMessageBack(...)</a>。</li>
<li>第 10 至 25 行 ：发生异常时，<code>Consumer</code> 内置默认 <code>Producer</code> 发送消息。
<ul>
<li>😈疑问：什么样的情况下会发生异常呢？</li>
</ul>
</li>
</ul>
<h3>MQClientAPIImpl#consumerSendMessageBack(...)</h3>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"><span class="comment"> 2:  * Consumer发回消息</span></div><div class="line"><span class="comment"> 3:  * <span class="doctag">@param</span> addr Broker地址</span></div><div class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> msg 消息</span></div><div class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> consumerGroup 消费分组</span></div><div class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> delayLevel 延迟级别</span></div><div class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> timeoutMillis 超时</span></div><div class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> maxConsumeRetryTimes 消费最大重试次数</span></div><div class="line"><span class="comment"> 9:  * <span class="doctag">@throws</span> RemotingException 当远程调用发生异常时</span></div><div class="line"><span class="comment">10:  * <span class="doctag">@throws</span> MQBrokerException 当Broker发生异常时</span></div><div class="line"><span class="comment">11:  * <span class="doctag">@throws</span> InterruptedException 当线程中断时</span></div><div class="line"><span class="comment">12:  */</span></div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerSendMessageBack</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">14</span>:     <span class="keyword">final</span> String addr,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">15</span>:     <span class="keyword">final</span> MessageExt msg,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">16</span>:     <span class="keyword">final</span> String consumerGroup,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">int</span> delayLevel,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">19</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxConsumeRetryTimes</span></span></div><div class="line"><span class="function"><span class="params"><span class="number">20</span>: )</span> <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException </span>&#123;</div><div class="line"><span class="number">21</span>:     ConsumerSendMsgBackRequestHeader requestHeader = <span class="keyword">new</span> ConsumerSendMsgBackRequestHeader();</div><div class="line"><span class="number">22</span>:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     requestHeader.setGroup(consumerGroup);</div><div class="line"><span class="number">25</span>:     requestHeader.setOriginTopic(msg.getTopic());</div><div class="line"><span class="number">26</span>:     requestHeader.setOffset(msg.getCommitLogOffset());</div><div class="line"><span class="number">27</span>:     requestHeader.setDelayLevel(delayLevel);</div><div class="line"><span class="number">28</span>:     requestHeader.setOriginMsgId(msg.getMsgId());</div><div class="line"><span class="number">29</span>:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class="keyword">this</span>.clientConfig.isVipChannelEnabled(), addr),</div><div class="line"><span class="number">32</span>:         request, timeoutMillis);</div><div class="line"><span class="number">33</span>:     <span class="keyword">assert</span> response != <span class="keyword">null</span>;</div><div class="line"><span class="number">34</span>:     <span class="keyword">switch</span> (response.getCode()) &#123;</div><div class="line"><span class="number">35</span>:         <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">37</span>:         &#125;</div><div class="line"><span class="number">38</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:     &#125;</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());</div><div class="line"><span class="number">43</span>: &#125;</div></pre></td></tr></table></figure></p>
<h1>8、Consumer 消费进度</h1>
<h2>OffsetStore</h2>
<p><img src="http://www.iocoder.cn/images/RocketMQ/2017_05_04/07.png" alt="OffsetStore类图.png"></p>
<ul>
<li><code>RemoteBrokerOffsetStore</code> ：<code>Consumer</code> <strong>集群模式</strong> 下，使用远程 <code>Broker</code> 消费进度。</li>
<li><code>LocalFileOffsetStore</code> ：<code>Consumer</code> <strong>广播模式</strong>下，使用本地 <code>文件</code> 消费进度。</li>
</ul>
<h3>OffsetStore#load(...)</h3>
<h4>LocalFileOffsetStore#load(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="comment">// 从本地硬盘读取消费进度</span></div><div class="line"> <span class="number">4</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">6</span>:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// 打印每个消息队列的消费进度</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) &#123;</div><div class="line"><span class="number">10</span>:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">11</span>:             log.info(<span class="string">"load consumer's offset, &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">12</span>:                 <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">13</span>:                 mq,</div><div class="line"><span class="number">14</span>:                 offset.get());</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：从本地文件加载消费进度到内存。</li>
</ul>
<h5>OffsetSerializeWrapper</h5>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetSerializeWrapper</span> <span class="keyword">extends</span> <span class="title">RemotingSerializable</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =</div><div class="line"> <span class="number">3</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; <span class="title">getOffsetTable</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span> offsetTable;</div><div class="line"> <span class="number">7</span>:     &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOffsetTable</span><span class="params">(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable)</span> </span>&#123;</div><div class="line"><span class="number">10</span>:         <span class="keyword">this</span>.offsetTable = offsetTable;</div><div class="line"><span class="number">11</span>:     &#125;</div><div class="line"><span class="number">12</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：本地 <code>Offset</code> 存储序列化。</li>
</ul>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json</div><div class="line">&#123;</div><div class="line">	<span class="string">"offsetTable"</span>:&#123;&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:3,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:2,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1471,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:1,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470,&#123;</div><div class="line">			<span class="string">"brokerName"</span>:<span class="string">"broker-a"</span>,</div><div class="line">			<span class="string">"queueId"</span>:0,</div><div class="line">			<span class="string">"topic"</span>:<span class="string">"TopicTest"</span></div><div class="line">		&#125;:1470</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4>RemoteBrokerOffsetStore#load(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="number">3</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：不进行加载，实际读取消费进度时，从 <code>Broker</code> 获取。</li>
</ul>
<h3>OffsetStore#readOffset(...)</h3>
<p>读取消费进度类型：</p>
<ul>
<li><code>READ_FROM_MEMORY</code> ：从内存读取。</li>
<li><code>READ_FROM_STORE</code> ：从存储( <code>Broker</code> 或 <code>文件</code> )读取。</li>
<li><code>MEMORY_FIRST_THEN_STORE</code> ：优先从内存读取，读取不到，从存储读取。</li>
</ul>
<h4>LocalFileOffsetStore#readOffset(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: &#123;</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: &#123;</div><div class="line"><span class="number">15</span>:                 OffsetSerializeWrapper offsetSerializeWrapper;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:                     offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"><span class="number">18</span>:                 &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">20</span>:                 &#125;</div><div class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">22</span>:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">23</span>:                     <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">24</span>:                         <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">25</span>:                         <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">26</span>:                     &#125;</div><div class="line"><span class="number">27</span>:                 &#125;</div><div class="line"><span class="number">28</span>:             &#125;</div><div class="line"><span class="number">29</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">30</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">31</span>:         &#125;</div><div class="line"><span class="number">32</span>:     &#125;</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>第 16 行 ：从 <code>文件</code> 读取消费进度。</li>
</ul>
<h4>RemoteBrokerOffsetStore#readOffset(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) &#123;</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: &#123;</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) &#123;</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 &#125;</div><div class="line"><span class="number">13</span>:             &#125;</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: &#123;</div><div class="line"><span class="number">15</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">16</span>:                     <span class="keyword">long</span> brokerOffset = <span class="keyword">this</span>.fetchConsumeOffsetFromBroker(mq);</div><div class="line"><span class="number">17</span>:                     AtomicLong offset = <span class="keyword">new</span> AtomicLong(brokerOffset);</div><div class="line"><span class="number">18</span>:                     <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> brokerOffset;</div><div class="line"><span class="number">20</span>:                 &#125;</div><div class="line"><span class="number">21</span>:                 <span class="comment">// No offset in broker</span></div><div class="line"><span class="number">22</span>:                 <span class="keyword">catch</span> (MQBrokerException e) &#123;</div><div class="line"><span class="number">23</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">24</span>:                 &#125;</div><div class="line"><span class="number">25</span>:                 <span class="comment">//Other exceptions</span></div><div class="line"><span class="number">26</span>:                 <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">27</span>:                     log.warn(<span class="string">"fetchConsumeOffsetFromBroker exception, "</span> + mq, e);</div><div class="line"><span class="number">28</span>:                     <span class="keyword">return</span> -<span class="number">2</span>;</div><div class="line"><span class="number">29</span>:                 &#125;</div><div class="line"><span class="number">30</span>:             &#125;</div><div class="line"><span class="number">31</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">32</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">37</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>第 16 行 ：从 <code>Broker</code> 读取消费进度。</li>
</ul>
<h3>OffsetStore#updateOffset(...)</h3>
<p>该方法 <code>RemoteBrokerOffsetStore</code> 与 <code>LocalFileOffsetStore</code> 实现相同。</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateOffset</span><span class="params">(MessageQueue mq, <span class="keyword">long</span> offset, <span class="keyword">boolean</span> increaseOnly)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:         AtomicLong offsetOld = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == offsetOld) &#123;</div><div class="line"> <span class="number">6</span>:             offsetOld = <span class="keyword">this</span>.offsetTable.putIfAbsent(mq, <span class="keyword">new</span> AtomicLong(offset));</div><div class="line"> <span class="number">7</span>:         &#125;</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> != offsetOld) &#123;</div><div class="line"><span class="number">10</span>:             <span class="keyword">if</span> (increaseOnly) &#123;</div><div class="line"><span class="number">11</span>:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);</div><div class="line"><span class="number">12</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">13</span>:                 offsetOld.set(offset);</div><div class="line"><span class="number">14</span>:             &#125;</div><div class="line"><span class="number">15</span>:         &#125;</div><div class="line"><span class="number">16</span>:     &#125;</div><div class="line"><span class="number">17</span>: &#125;</div></pre></td></tr></table></figure></p>
<h3>OffsetStore#persistAll(...)</h3>
<h4>LocalFileOffsetStore#persistAll(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">new</span> OffsetSerializeWrapper();</div><div class="line"> <span class="number">7</span>:     <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) &#123;</div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (mqs.contains(entry.getKey())) &#123;</div><div class="line"> <span class="number">9</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">10</span>:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);</div><div class="line"><span class="number">11</span>:         &#125;</div><div class="line"><span class="number">12</span>:     &#125;</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     String jsonString = offsetSerializeWrapper.toJson(<span class="keyword">true</span>);</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">16</span>:         <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">17</span>:             MixAll.string2File(jsonString, <span class="keyword">this</span>.storePath);</div><div class="line"><span class="number">18</span>:         &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"><span class="number">19</span>:             log.error(<span class="string">"persistAll consumer offset Exception, "</span> + <span class="keyword">this</span>.storePath, e);</div><div class="line"><span class="number">20</span>:         &#125;</div><div class="line"><span class="number">21</span>:     &#125;</div><div class="line"><span class="number">22</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：持久化消费进度。<strong>将消费进度写入文件</strong>。</li>
</ul>
<h4>RemoteBrokerOffsetStore#persistAll(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>&#123;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// 持久化消息队列</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">final</span> HashSet&lt;MessageQueue&gt; unusedMQ = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (!mqs.isEmpty()) &#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) &#123;</div><div class="line"><span class="number">10</span>:             MessageQueue mq = entry.getKey();</div><div class="line"><span class="number">11</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (mqs.contains(mq)) &#123;</div><div class="line"><span class="number">14</span>:                     <span class="keyword">try</span> &#123;</div><div class="line"><span class="number">15</span>:                         <span class="keyword">this</span>.updateConsumeOffsetToBroker(mq, offset.get());</div><div class="line"><span class="number">16</span>:                         log.info(<span class="string">"[persistAll] Group: &#123;&#125; ClientId: &#123;&#125; updateConsumeOffsetToBroker &#123;&#125; &#123;&#125;"</span>,</div><div class="line"><span class="number">17</span>:                             <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">18</span>:                             <span class="keyword">this</span>.mQClientFactory.getClientId(),</div><div class="line"><span class="number">19</span>:                             mq,</div><div class="line"><span class="number">20</span>:                             offset.get());</div><div class="line"><span class="number">21</span>:                     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">22</span>:                         log.error(<span class="string">"updateConsumeOffsetToBroker exception, "</span> + mq.toString(), e);</div><div class="line"><span class="number">23</span>:                     &#125;</div><div class="line"><span class="number">24</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">25</span>:                     unusedMQ.add(mq);</div><div class="line"><span class="number">26</span>:                 &#125;</div><div class="line"><span class="number">27</span>:             &#125;</div><div class="line"><span class="number">28</span>:         &#125;</div><div class="line"><span class="number">29</span>:     &#125;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     <span class="comment">// 移除不适用的消息队列</span></div><div class="line"><span class="number">32</span>:     <span class="keyword">if</span> (!unusedMQ.isEmpty()) &#123;</div><div class="line"><span class="number">33</span>:         <span class="keyword">for</span> (MessageQueue mq : unusedMQ) &#123;</div><div class="line"><span class="number">34</span>:             <span class="keyword">this</span>.offsetTable.remove(mq);</div><div class="line"><span class="number">35</span>:             log.info(<span class="string">"remove unused mq, &#123;&#125;, &#123;&#125;"</span>, mq, <span class="keyword">this</span>.groupName);</div><div class="line"><span class="number">36</span>:         &#125;</div><div class="line"><span class="number">37</span>:     &#125;</div><div class="line"><span class="number">38</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：持久化指定消息队列数组的消费进度到 <code>Broker</code>，并移除非指定消息队列。</li>
</ul>
<h4>MQClientInstance#persistAllConsumerOffset(...)</h4>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduledTask</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">2</span>:     <span class="comment">// 定时同步消费进度</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"> <span class="number">7</span>:             <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:                 MQClientInstance.<span class="keyword">this</span>.cleanOfflineBroker();</div><div class="line"> <span class="number">9</span>:                 MQClientInstance.<span class="keyword">this</span>.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:             &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">11</span>:                 log.error(<span class="string">"ScheduledTask sendHeartbeatToAllBroker exception"</span>, e);</div><div class="line"><span class="number">12</span>:             &#125;</div><div class="line"><span class="number">13</span>:         &#125;</div><div class="line"><span class="number">14</span>:     &#125;, <span class="number">1000</span>, <span class="keyword">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">15</span>: &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>说明 ：定时进行持久化，默认周期：5000ms。</li>
<li><strong>重要说明 ：</strong>
<ul>
<li><strong>消费进度持久化不仅仅只有定时持久化，拉取消息、分配消息队列等等操作，都会进行消费进度持久化。</strong></li>
<li><strong>消费进度持久化不仅仅只有定时持久化，拉取消息、分配消息队列等等操作，都会进行消费进度持久化。</strong></li>
<li><strong>消费进度持久化不仅仅只有定时持久化，拉取消息、分配消息队列等等操作，都会进行消费进度持久化。</strong></li>
</ul>
</li>
</ul>
<h1>9、结尾</h1>
<p>😈可能是本系列最长的一篇文章，如有表达错误和不清晰，请多多见谅。<br>
感谢对本系列的阅读、收藏、点赞、分享，特别是翻到结尾。😜真的有丢丢长。</p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/RocketMQ/">RocketMQ</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.iocoder.cn/RocketMQ/message-pull-and-consume-second/" data-title="RocketMQ 源码分析 —— Message 拉取与消费（下） | 芋道源码 —— 纯源码解析博客" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/RocketMQ/store-init-and-shutdown/" title="RocketMQ 源码分析 —— Store 初始化与关闭">
  <strong>PREVIOUS:</strong><br>
  <span>
  RocketMQ 源码分析 —— Store 初始化与关闭</span>
</a>
</div>


<div class="next">
<a href="/RocketMQ/message-pull-and-consume-first/" title="RocketMQ 源码分析 —— Message 拉取与消费（上）">
 <strong>NEXT:</strong><br> 
 <span>RocketMQ 源码分析 —— Message 拉取与消费（上）
</span>
</a>
</div>

</nav>

	

</div>  
        <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="toc" class="toc-aside">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2、Consumer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3、PushConsumer 一览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4、PushConsumer 订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#subscribe(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.1.1.</span> <span class="toc-text">FilterAPI.buildSubscriptionData(...)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.2.</span> <span class="toc-text">DefaultMQPushConsumer#registerMessageListener(...)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">5、PushConsumer 消息队列分配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.1.</span> <span class="toc-text">RebalanceService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.2.</span> <span class="toc-text">MQClientInstance#doRebalance(...)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.3.</span> <span class="toc-text">DefaultMQPushConsumerImpl#doRebalance(...)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.</span> <span class="toc-text">RebalanceImpl#doRebalance(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.1.</span> <span class="toc-text">RebalanceImpl#rebalanceByTopic(...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.2.</span> <span class="toc-text">RebalanceImpl#removeUnnecessaryMessageQueue(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">RebalancePushImpl#removeUnnecessaryMessageQueue(...)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.3.</span> <span class="toc-text">RebalancePushImpl#dispatchPullRequest(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#executePullRequestImmediately(...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.4.</span> <span class="toc-text">AllocateMessageQueueStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">AllocateMessageQueueAveragely</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">AllocateMessageQueueByMachineRoom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.4.3.</span> <span class="toc-text">AllocateMessageQueueAveragelyByCircle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.4.4.4.</span> <span class="toc-text">AllocateMessageQueueByConfig</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">5、PushConsumer 消费进度读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.1.</span> <span class="toc-text">RebalancePushImpl#computePullFromWhere(...)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#computePullFromWhere(...)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">7.</span> <span class="toc-text">6、PushConsumer 拉取消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">7.1.</span> <span class="toc-text">PullMessageService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">7.2.</span> <span class="toc-text">DefaultMQPushConsumerImpl#pullMessage(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">7.2.1.</span> <span class="toc-text">PullAPIWrapper#pullKernelImpl(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">PullAPIWrapper#recalculatePullFromWhichNode(...)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">MQClientInstance#findBrokerAddressInSubscribe(...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">7.2.2.</span> <span class="toc-text">PullAPIWrapper#processPullResult(...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">7.2.3.</span> <span class="toc-text">ProcessQueue#putMessage(...)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">7.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">8.</span> <span class="toc-text">6、PushConsumer 消费消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">8.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService 提交消费请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">8.1.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequest(...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">8.1.2.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">8.2.</span> <span class="toc-text">ConsumeRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">8.3.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#processConsumeResult(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">8.3.1.</span> <span class="toc-text">ProcessQueue#removeMessage(...)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">8.4.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#cleanExpireMsg(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">8.4.1.</span> <span class="toc-text">ProcessQueue#cleanExpiredMsg(...)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">9.</span> <span class="toc-text">7、PushConsumer 发回消费失败消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">9.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#sendMessageBack(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">9.1.1.</span> <span class="toc-text">MQClientAPIImpl#consumerSendMessageBack(...)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">10.</span> <span class="toc-text">8、Consumer 消费进度</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.</span> <span class="toc-text">OffsetStore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.1.</span> <span class="toc-text">OffsetStore#load(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">LocalFileOffsetStore#load(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.1.1.1.</span> <span class="toc-text">OffsetSerializeWrapper</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#load(...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.2.</span> <span class="toc-text">OffsetStore#readOffset(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">LocalFileOffsetStore#readOffset(...)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#readOffset(...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.3.</span> <span class="toc-text">OffsetStore#updateOffset(...)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.4.</span> <span class="toc-text">OffsetStore#persistAll(...)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.4.1.</span> <span class="toc-text">LocalFileOffsetStore#persistAll(...)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.4.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#persistAll(...)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">10.1.4.3.</span> <span class="toc-text">MQClientInstance#persistAllConsumerOffset(...)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">11.</span> <span class="toc-text">9、结尾</span></a></li></ol>
</div>

<div id="asidepart">
    <!--<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>-->
    <aside class="clearfix">
        <div id="authorInfo">
            <!---->
            <!--<div class="author-logo"></div>-->
            <!---->

            <div> <img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"> </div>

            <div class="social-list">
                
                
                
                
                
            </div>
        </div>

        
        <div class="categorieslist">
    <p class="asidetitle">微信公众号福利：芋道源码</p>
    <ul>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 0. 阅读源码葵花宝典 </a></li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 1. RocketMQ / MyCAT / Sharding-JDBC 详细中文注释源码 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 2. 您对于源码的疑问每条留言都将得到认真回复 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 3. 新的源码解析文章实时收到通知，每周六十点更新 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. 认真的源码交流微信群 </a> </li>


    </ul>
</div>
        
        
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
            
			    <li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li>
            
		
            
			    <li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li>
            
		
            
			    <li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/Myth/" title="Myth">Myth<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li>
            
		
            
			    <li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li>
            
		
            
			    <li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>35</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li>
            
		
            
			    <li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/工作内推/" title="工作内推">工作内推<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/技术杂文/" title="技术杂文">技术杂文<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/数据库实体设计/" title="数据库实体设计">数据库实体设计<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/芋道源码的周八/" title="芋道源码的周八">芋道源码的周八<sup>4</sup></a></li>
            
		
		</ul>
</div>

        
    </aside>
</div>
    </div>
    <footer><div id="footer">
    <img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display: none">
    
            <p class="copyright"> © 2018 
		
		<a href="http://www.iocoder.cn" target="_blank" title="芋道源码">芋道源码</a>
		
            && <span style="display: inline;" id="busuanzi_container_site_uv">总访客数 <span id="busuanzi_value_site_uv" font="微软雅黑"></span> 次</span>
            && <span style="display: inline;" id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv" font="微软雅黑"></span> 次</span>
            <!--&& Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>-->
            <!--&& Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney">coney</a>-->
            </p></div>
            <div class="copyright">沪ICP备17037075号-1</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<link rel="stylesheet" href="/alert/css/alert.css">
<script src="/alert/js/alert.js"></script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/util.js"></script>





<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-107572620-1', 'auto');  
ga('send', 'pageview');
</script>

  </body>


