
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">

    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">

  
    <title>TCC-Transaction 源码分析 —— Dubbo 支持 | 芋道源码 —— 纯源码解析BLOG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="芋道源码">
    
    <meta name="description" content="摘要: 原创出处 http://www.iocoder.cn/TCC-Transaction/dubbo-support/ 「芋道源码」欢迎转载，保留摘要，谢谢！
本文主要基于 TCC-Transaction 1.2.3.3 正式版  

1. 概述
2. Dubbo 代理
2.1 Javassis">
    

    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客,Sharding-JDBC,分库分表">
    

    
    
    <link rel="alternate" href="atom.xml" title="芋道源码 —— 纯源码解析BLOG" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css">
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            var _bdId ='9e70e3362807c1bd185a79655b307027';
             hm.src = "//hm.baidu.com/hm.js?" + _bdId;
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

    <!-- 不蒜子统计 -->
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>
</html>
  <body>
    <header>
      <div>
    
    <div id="textlogo">
        <h1 class="site-name"><a href="/" title="芋道源码 —— 纯源码解析BLOG">芋道源码 —— 纯源码解析BLOG</a></h1>
        <a class="blog-motto">
            
            愿半生编码，如一生老友！
            
        </a>
    </div>
    <div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
        </a></div>
    <nav class="animated">
        <ul>
            <ul>
                
                <li><a href="/">文章</a></li>
                
                <li><a href="/2018-meet-you">知识星球</a></li>
                
                <li><a href="https://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">Github</a></li>
                
                <li><a href="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31_bak.jpg">微信公众号</a></li>
                
                <li><a href="/categories/%E5%B7%A5%E4%BD%9C%E5%86%85%E6%8E%A8/">工作内推</a></li>
                
                <li><a href="/link_url">友链</a></li>
                
                <!--<li>-->
                    <!---->
                        <!--<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">-->
                            <!--<label>Search</label>-->
                            <!--<input type="text" id="search" name="q" autocomplete="off" maxlength="20"-->
                                   <!--placeholder="搜索"/>-->
                            <!--<input type="hidden" name="q" value="site:www.iocoder.cn">-->
                        <!--</form>-->
                        <!---->
                <!--</li>-->
            </ul>
    </ul></nav>
</div>

    </header>
    <div id="container">

        <div id="main" class="post" itemscope="" itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/TCC-Transaction/dubbo-support/" title="TCC-Transaction 源码分析 —— Dubbo 支持" itemprop="url">TCC-Transaction 源码分析 —— Dubbo 支持</a>
  </h1>
  <p class="article-author">
      <!--By-->
    <!---->
      <!--<a href="http://www.iocoder.cn" title="芋道源码">芋道源码</a>-->
    <!---->
  </p>
  <p class="article-time">
    <!--<time datetime="2018-02-27T16:00:00.000Z" itemprop="datePublished">2018-02-28</time>-->
    <!--更新日期:<time datetime="2017-10-12T06:43:18.000Z" itemprop="dateModified">2017-10-12</time>-->
    <!---->
      总阅读量:<span id="busuanzi_value_page_pv"></span>次
  </p>
</header>
	<div class="article-content">
		
		
		<p>摘要: 原创出处 <a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">http://www.iocoder.cn/TCC-Transaction/dubbo-support/</a> 「芋道源码」欢迎转载，保留摘要，谢谢！</p>
<p><strong>本文主要基于 TCC-Transaction 1.2.3.3 正式版</strong>  </p>
<ul>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">1. 概述</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2. Dubbo 代理</a><ul>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.1 JavassistProxyFactory</a><ul>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.1.1 Javassist</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.1.2 TccJavassistProxyFactory</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.1.3 TccProxy &amp; TccClassGenerator</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.1.4 配置 Dubbo Proxy</a></li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.2 JdkProxyFactory</a><ul>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.2.1 JDK Proxy</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.2.2 TccJdkProxyFactory</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.2.3 TccInvokerInvocationHandler</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">2.2.4 配置 Dubbo Proxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">3. Dubbo 事务上下文编辑器</a></li>
<li><a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/">666. 彩蛋</a></li>
</ul>
<hr>
<p><img src="http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>🙂🙂🙂关注<strong>微信公众号：【芋道源码】</strong>有福利：  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>所有</strong>源码分析文章列表  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>中文注释源码 GitHub 地址</strong>  </li>
<li>您对于源码的疑问每条留言<strong>都</strong>将得到<strong>认真</strong>回复。<strong>甚至不知道如何读源码也可以请教噢</strong>。  </li>
<li><strong>新的</strong>源码解析文章<strong>实时</strong>收到通知。<strong>每周更新一篇左右</strong>。  </li>
<li><strong>认真的</strong>源码交流微信群。</li>
</ol>
</blockquote>
<hr>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文分享 <strong>Dubbo 支持</strong>。</p>
<p>TCC-Transaction 通过 Dubbo <strong>隐式传参</strong>的功能，避免自己对业务代码的入侵。可能有同学不太理解为什么说 TCC-Transaction 对业务代码有一定的入侵性，一起来看个代码例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>代码来自 <code>tcc-transaction-http-sample</code> 。声明远程调用时，增加了参数 TransactionContext。当然你也可以通过自己使用的远程调用框架做一定封装，避免入侵。</li>
</ul>
<p>如下是对 Dubbo 封装了后，Dubbo Service 方法的例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CapitalTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(CapitalTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>代码来自 <code>http-transaction-dubbo-sample</code> 。是不是不需要传入参数 TransactionContext。当然，注解是肯定需要的，否则 TCC-Transaction 怎么知道哪些方法是 TCC 方法。</li>
</ul>
<p>TCC-Transaction 通过 Dubbo Proxy 的机制，实现 <code>@Compensable</code> 属性自动生成，增加开发体验，也避免出错。</p>
<hr>
<p>Dubbo 支持( Maven 项目 <code>tcc-transaction-dubbo</code> ) 整体代码结构如下：</p>
<p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/01.png" alt=""></p>
<ul>
<li><code>proxy</code></li>
<li><code>context</code></li>
</ul>
<p>我们分成两个小节分享这两个包实现的功能。</p>
<p><strong>笔者暂时对 Dubbo 了解的不够深入，如果有错误的地方，还烦请指出，谢谢。</strong></p>
<blockquote>
<p>你行好事会因为得到赞赏而愉悦<br>同理，开源项目贡献者会因为 Star 而更加有动力<br>为 TCC-Transaction 点赞！<a href="https://github.com/changmingxie/tcc-transaction" rel="external nofollow noopener noreferrer" target="_blank">传送门</a></p>
</blockquote>
<p>ps：笔者假设你已经阅读过<a href="https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x" rel="external nofollow noopener noreferrer" target="_blank">《tcc-transaction 官方文档 —— 使用指南1.2.x》</a>。</p>
<h1 id="2-Dubbo-代理"><a href="#2-Dubbo-代理" class="headerlink" title="2. Dubbo 代理"></a>2. Dubbo 代理</h1><p>将 Dubbo Service 方法上的<strong>注解</strong> <code>@Compensable</code> ，自动生成注解的 <code>confirmMethod</code>、<code>cancelMethod</code>、<code>transactionContextEditor</code> 属性，例子代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Compensable</span>(propagation=Propagation.SUPPORTS, confirmMethod=<span class="string">"record"</span>, cancelMethod=<span class="string">"record"</span>, transactionContextEditor=DubboTransactionContextEditor.class)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">    <span class="comment">// ... 省略代码</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>该代码通过 Javassist 生成的 Proxy 代码的示例。</li>
<li><code>propagation=Propagation.SUPPORTS</code> ：支持当前事务，如果当前没有事务，就以非事务方式执行。<strong>为什么不使用 REQUIRED</strong> ？如果使用 REQUIRED 事务传播级别，事务恢复重试时，会发起新的事务。</li>
<li><code>confirmMethod</code>、<code>cancelMethod</code> 使用和 try 方法<strong>相同方法名</strong>：<strong>本地发起</strong>远程服务 TCC confirm / cancel 阶段，调用相同方法进行事务的提交或回滚。远程服务的 CompensableTransactionInterceptor 会根据事务的状态是 CONFIRMING / CANCELLING 来调用对应方法。<ul>
<li><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/02.png" alt=""> </li>
</ul>
</li>
<li><code>transactionContextEditor=DubboTransactionContextEditor.class</code>，使用 Dubbo 事务上下文编辑器，在<a href="#">「3. Dubbo 事务上下文编辑器」</a>详细分享。</li>
</ul>
<p>Dubbo Service Proxy 提供了两种生成方式：</p>
<ul>
<li>JavassistProxyFactory，基于 Javassist 方式</li>
<li>JdkProxyFactory，基于 JDK 动态代理机制</li>
</ul>
<p>这块内容我们不拓展开，感兴趣的同学点击如下文章：</p>
<ul>
<li><a href="http://daveztong.github.io/2016/11/23/Dubbo%E5%AD%A6%E4%B9%A0-%E7%90%86%E8%A7%A3%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" rel="external nofollow noopener noreferrer" target="_blank">《Dubbo学习-理解动态代理》</a></li>
<li><a href="http://javatar.iteye.com/blog/814426" rel="external nofollow noopener noreferrer" target="_blank">《Dubbo 作者博客 —— 动态代理方案性能对比》</a></li>
<li><a href="http://blog.csdn.net/quhongwei_zhanqiu/article/details/41597261" rel="external nofollow noopener noreferrer" target="_blank">《Dubbo原理解析-代理之Javassist生成的伪代码》</a></li>
<li><strong><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">《Dubbo的服务暴露细节》</a></strong></li>
</ul>
<p>Dubbo 的 Invoker 模型是非常关键的概念，看下图：</p>
<p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/03.jpeg" alt=""></p>
<h2 id="2-1-JavassistProxyFactory"><a href="#2-1-JavassistProxyFactory" class="headerlink" title="2.1 JavassistProxyFactory"></a>2.1 JavassistProxyFactory</h2><h3 id="2-1-1-Javassist"><a href="#2-1-1-Javassist" class="headerlink" title="2.1.1 Javassist"></a>2.1.1 Javassist</h3><blockquote>
<p>Javassist 是一个开源的分析、编辑和创建 Java 字节码的类库。通过使用Javassist 对字节码操作可以实现动态 ”AOP” 框架。  </p>
<p>关于 Java 字节码的处理，目前有很多工具，如 bcel，asm( cglib只是对asm又封装了一层 )。不过这些都需要直接跟虚拟机指令打交道。  </p>
<p>Javassist 的主要的优点，在于简单，而且快速，直接使用 Java 编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成类。  </p>
</blockquote>
<ul>
<li>粗略一看，可能不够形象，下面我们通过看 TCC-Transaction 如何使用来理解理解。</li>
<li><a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">《Java学习之javassist<br>》</a></li>
<li><a href="http://blog.csdn.net/qbg19881206/article/details/8993562" rel="external nofollow noopener noreferrer" target="_blank">《Javassist 字节码操作》</a></li>
</ul>
<h3 id="2-1-2-TccJavassistProxyFactory"><a href="#2-1-2-TccJavassistProxyFactory" class="headerlink" title="2.1.2 TccJavassistProxyFactory"></a>2.1.2 TccJavassistProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</code>，TCC Javassist 代理工厂。实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJavassistProxyFactory</span> <span class="keyword">extends</span> <span class="title">JavassistProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) TccProxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>项目启动时</strong>，调用 <code>TccJavassistProxyFactory#getProxy(...)</code> 方法，生成 Dubbo Service 调用 Proxy。</li>
<li><code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>，Dubbo 调用处理器，点击<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">连接</a>查看代码。</li>
</ul>
<h3 id="2-1-3-TccProxy-amp-TccClassGenerator"><a href="#2-1-3-TccProxy-amp-TccClassGenerator" class="headerlink" title="2.1.3 TccProxy &amp; TccClassGenerator"></a>2.1.3 TccProxy &amp; TccClassGenerator</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy</code>，TCC Proxy 工厂，生成 Dubbo Service 调用 Proxy 。笔者认为，TccProxy 改成 TccProxyFactory 更合适，原因在下文。</p>
<p><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator</code>，TCC 类代码生成器，基于 Javassist 实现。 </p>
<p><strong>🦅案例</strong></p>
<p>一个 Dubbo Service，TccProxy 会动态生成两个类：</p>
<ul>
<li>Dubbo Service 调用 Proxy</li>
<li>Dubbo Service 调用 ProxyFactory，生成对应的 Dubbo Service Proxy</li>
</ul>
<p>例如 Dubbo Service 接口如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketTradeOrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span></div><div class="line">    <span class="function">String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto tradeOrderDto)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>生成 Dubbo Service 调用 <strong>ProxyFactory</strong> 如下 ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccProxy3</span> <span class="keyword">extends</span> <span class="title">TccProxy</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>TccProxy 提供 <code>#newInstance(handler)</code> 方法，创建 Proxy，所以笔者认为，TccProxy 改成 TccProxyFactory 更合适。</li>
<li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> 动态生成类标记，标记该类由 TccClassGenerator 生成的。</li>
</ul>
<p>生成 Dubbo Service 调用 <strong>Proxy</strong> 如下 ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy3</span> <span class="keyword">implements</span> <span class="title">TccClassGenerator</span>.<span class="title">DC</span>, <span class="title">RedPacketTradeOrderService</span>, <span class="title">EchoService</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method[] methods;</div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy3</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.handler = paramInvocationHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Compensable</span>(propagation = Propagation.SUPPORTS, confirmMethod = <span class="string">"record"</span>, cancelMethod = <span class="string">"record"</span>, transactionContextEditor = DubboTransactionContextEditor.class)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (String) localObject;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Object $echo(Object paramObject) &#123;</div><div class="line">        Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        arrayOfObject[<span class="number">0</span>] = paramObject;</div><div class="line">        Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">1</span>], arrayOfObject);</div><div class="line">        <span class="keyword">return</span> (Object) localObject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>com.alibaba.dubbo.rpc.service.EchoService</code>，Dubbo Service 回声服务接口，用于服务健康检查，Dubbo Service 默认自动实现该接口，点击<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/EchoService.java" rel="external nofollow noopener noreferrer" target="_blank">连接</a>查看代码。</li>
<li><code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> 动态生成类标记，标记该类由 TccClassGenerator 生成的。</li>
</ul>
<p><strong>🦅实现</strong></p>
<p>调用 <code>TccProxy#getProxy(...)</code> 方法，获得 <strong>TCC Proxy 工厂</strong>，实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// 【TccProxy.java】</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccProxy <span class="title">getProxy</span><span class="params">(ClassLoader cl, Class&lt;?&gt;... ics)</span> </span>&#123;</div><div class="line">  <span class="number">3</span>:     <span class="comment">// 校验接口超过上限</span></div><div class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (ics.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">  <span class="number">5</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">  <span class="number">6</span>:     &#125;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// use interface class name list as key.</span></div><div class="line">  <span class="number">9</span>:     StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">10</span>:     <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">11</span>:         String itf = ic.getName();</div><div class="line"> <span class="number">12</span>:         <span class="comment">// 校验是否为接口</span></div><div class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (!ic.isInterface()) &#123;</div><div class="line"> <span class="number">14</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(itf + <span class="string">" is not a interface."</span>);</div><div class="line"> <span class="number">15</span>:         &#125;</div><div class="line"> <span class="number">16</span>:         <span class="comment">// 加载接口类</span></div><div class="line"> <span class="number">17</span>:         Class&lt;?&gt; tmp = <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">19</span>:             tmp = Class.forName(itf, <span class="keyword">false</span>, cl);</div><div class="line"> <span class="number">20</span>:         &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line"> <span class="number">21</span>:         &#125;</div><div class="line"> <span class="number">22</span>:         <span class="keyword">if</span> (tmp != ic) &#123; <span class="comment">// 加载接口类失败</span></div><div class="line"> <span class="number">23</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ic + <span class="string">" is not visible from class loader"</span>);</div><div class="line"> <span class="number">24</span>:         &#125;</div><div class="line"> <span class="number">25</span>:         sb.append(itf).append(<span class="string">';'</span>);</div><div class="line"> <span class="number">26</span>:     &#125;</div><div class="line"> <span class="number">27</span>:     String key = sb.toString();</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>:     <span class="comment">// get cache by class loader.</span></div><div class="line"> <span class="number">30</span>:     Map&lt;String, Object&gt; cache;</div><div class="line"> <span class="number">31</span>:     <span class="keyword">synchronized</span> (ProxyCacheMap) &#123;</div><div class="line"> <span class="number">32</span>:         cache = ProxyCacheMap.get(cl);</div><div class="line"> <span class="number">33</span>:         <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">34</span>:             cache = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line"> <span class="number">35</span>:             ProxyCacheMap.put(cl, cache);</div><div class="line"> <span class="number">36</span>:         &#125;</div><div class="line"> <span class="number">37</span>:     &#125;</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// 获得 TccProxy 工厂</span></div><div class="line"> <span class="number">40</span>:     TccProxy proxy = <span class="keyword">null</span>;</div><div class="line"> <span class="number">41</span>:     <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"> <span class="number">42</span>:         <span class="keyword">do</span> &#123;</div><div class="line"> <span class="number">43</span>:             <span class="comment">// 从缓存中获取 TccProxy 工厂</span></div><div class="line"> <span class="number">44</span>:             Object value = cache.get(key);</div><div class="line"> <span class="number">45</span>:             <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Reference&lt;?&gt;) &#123;</div><div class="line"> <span class="number">46</span>:                 proxy = (TccProxy) ((Reference&lt;?&gt;) value).get();</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">if</span> (proxy != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">48</span>:                     <span class="keyword">return</span> proxy;</div><div class="line"> <span class="number">49</span>:                 &#125;</div><div class="line"> <span class="number">50</span>:             &#125;</div><div class="line"> <span class="number">51</span>:             <span class="comment">// 缓存中不存在，设置生成 TccProxy 代码标记。创建中时，其他创建请求等待，避免并发。</span></div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (value == PendingGenerationMarker) &#123;</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">54</span>:                     cache.wait();</div><div class="line"> <span class="number">55</span>:                 &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</div><div class="line"> <span class="number">56</span>:                 &#125;</div><div class="line"> <span class="number">57</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">58</span>:                 cache.put(key, PendingGenerationMarker);</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">60</span>:             &#125;</div><div class="line"> <span class="number">61</span>:         &#125;</div><div class="line"> <span class="number">62</span>:         <span class="keyword">while</span> (<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:     &#125;</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="keyword">long</span> id = PROXY_CLASS_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">66</span>:     String pkg = <span class="keyword">null</span>;</div><div class="line"> <span class="number">67</span>:     TccClassGenerator ccp = <span class="keyword">null</span>; <span class="comment">// proxy class generator</span></div><div class="line"> <span class="number">68</span>:     TccClassGenerator ccm = <span class="keyword">null</span>; <span class="comment">// proxy factory class generator</span></div><div class="line"> <span class="number">69</span>:     <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">70</span>:         <span class="comment">// 创建 Tcc class 代码生成器</span></div><div class="line"> <span class="number">71</span>:         ccp = TccClassGenerator.newInstance(cl);</div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:         Set&lt;String&gt; worked = <span class="keyword">new</span> HashSet&lt;String&gt;(); <span class="comment">// 已处理方法签名集合。key：方法签名</span></div><div class="line"> <span class="number">74</span>:         List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;(); <span class="comment">// 已处理方法集合。</span></div><div class="line"> <span class="number">75</span>: </div><div class="line"> <span class="number">76</span>:         <span class="comment">// 处理接口</span></div><div class="line"> <span class="number">77</span>:         <span class="keyword">for</span> (Class&lt;?&gt; ic : ics) &#123;</div><div class="line"> <span class="number">78</span>:             <span class="comment">// 非 public 接口，使用接口包名</span></div><div class="line"> <span class="number">79</span>:             <span class="keyword">if</span> (!Modifier.isPublic(ic.getModifiers())) &#123;</div><div class="line"> <span class="number">80</span>:                 String npkg = ic.getPackage().getName();</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">82</span>:                     pkg = npkg;</div><div class="line"> <span class="number">83</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">84</span>:                     <span class="keyword">if</span> (!pkg.equals(npkg)) &#123; <span class="comment">// 实现了两个非 public 的接口，</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"non-public interfaces from different packages"</span>);</div><div class="line"> <span class="number">86</span>:                     &#125;</div><div class="line"> <span class="number">87</span>:                 &#125;</div><div class="line"> <span class="number">88</span>:             &#125;</div><div class="line"> <span class="number">89</span>:             <span class="comment">// 添加接口</span></div><div class="line"> <span class="number">90</span>:             ccp.addInterface(ic);</div><div class="line"> <span class="number">91</span>:             <span class="comment">// 处理接口方法</span></div><div class="line"> <span class="number">92</span>:             <span class="keyword">for</span> (Method method : ic.getMethods()) &#123;</div><div class="line"> <span class="number">93</span>:                 <span class="comment">// 添加方法签名到已处理方法签名集合</span></div><div class="line"> <span class="number">94</span>:                 String desc = ReflectUtils.getDesc(method);</div><div class="line"> <span class="number">95</span>:                 <span class="keyword">if</span> (worked.contains(desc)) &#123;</div><div class="line"> <span class="number">96</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">97</span>:                 &#125;</div><div class="line"> <span class="number">98</span>:                 worked.add(desc);</div><div class="line"> <span class="number">99</span>:                 <span class="comment">// 生成接口方法实现代码</span></div><div class="line"><span class="number">100</span>:                 <span class="keyword">int</span> ix = methods.size();</div><div class="line"><span class="number">101</span>:                 Class&lt;?&gt; rt = method.getReturnType();</div><div class="line"><span class="number">102</span>:                 Class&lt;?&gt;[] pts = method.getParameterTypes();</div><div class="line"><span class="number">103</span>:                 StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="string">"Object[] args = new Object["</span>).append(pts.length).append(<span class="string">"];"</span>);</div><div class="line"><span class="number">104</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; pts.length; j++) &#123;</div><div class="line"><span class="number">105</span>:                     code.append(<span class="string">" args["</span>).append(j).append(<span class="string">"] = ($w)$"</span>).append(j + <span class="number">1</span>).append(<span class="string">";"</span>);</div><div class="line"><span class="number">106</span>:                 &#125;</div><div class="line"><span class="number">107</span>:                 code.append(<span class="string">" Object ret = handler.invoke(this, methods["</span>).append(ix).append(<span class="string">"], args);"</span>);</div><div class="line"><span class="number">108</span>:                 <span class="keyword">if</span> (!Void.TYPE.equals(rt)) &#123;</div><div class="line"><span class="number">109</span>:                     code.append(<span class="string">" return "</span>).append(asArgument(rt, <span class="string">"ret"</span>)).append(<span class="string">";"</span>);</div><div class="line"><span class="number">110</span>:                 &#125;</div><div class="line"><span class="number">111</span>:                 methods.add(method);</div><div class="line"><span class="number">112</span>:                 <span class="comment">// 添加方法</span></div><div class="line"><span class="number">113</span>:                 Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">114</span>:                 <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">115</span>:                     ccp.addMethod(<span class="keyword">true</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">116</span>:                 &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">117</span>:                     ccp.addMethod(<span class="keyword">false</span>, method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line"><span class="number">118</span>:                 &#125;</div><div class="line"><span class="number">119</span>:             &#125;</div><div class="line"><span class="number">120</span>:         &#125;</div><div class="line"><span class="number">121</span>: </div><div class="line"><span class="number">122</span>:         <span class="comment">// 设置包路径</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">124</span>:             pkg = PACKAGE_NAME;</div><div class="line"><span class="number">125</span>:         &#125;</div><div class="line"><span class="number">126</span>: </div><div class="line"><span class="number">127</span>:         <span class="comment">// create ProxyInstance class.</span></div><div class="line"><span class="number">128</span>:         <span class="comment">// 设置类名</span></div><div class="line"><span class="number">129</span>:         String pcn = pkg + <span class="string">".proxy"</span> + id;</div><div class="line"><span class="number">130</span>:         ccp.setClassName(pcn);</div><div class="line"><span class="number">131</span>:         <span class="comment">// 添加静态属性 methods</span></div><div class="line"><span class="number">132</span>:         ccp.addField(<span class="string">"public static java.lang.reflect.Method[] methods;"</span>);</div><div class="line"><span class="number">133</span>:         <span class="comment">// 添加属性 handler</span></div><div class="line"><span class="number">134</span>:         ccp.addField(<span class="string">"private "</span> + InvocationHandler.class.getName() + <span class="string">" handler;"</span>);</div><div class="line"><span class="number">135</span>:         <span class="comment">// 添加构造方法，参数 handler</span></div><div class="line"><span class="number">136</span>:         ccp.addConstructor(Modifier.PUBLIC, <span class="keyword">new</span> Class&lt;?&gt;[]&#123;InvocationHandler.class&#125;, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="string">"handler=$1;"</span>);</div><div class="line"><span class="number">137</span>:         <span class="comment">// 添加构造方法，参数 空</span></div><div class="line"><span class="number">138</span>:         ccp.addDefaultConstructor();</div><div class="line"><span class="number">139</span>:         <span class="comment">// 生成类</span></div><div class="line"><span class="number">140</span>:         Class&lt;?&gt; clazz = ccp.toClass();</div><div class="line"><span class="number">141</span>:         <span class="comment">// 设置静态属性 methods</span></div><div class="line"><span class="number">142</span>:         clazz.getField(<span class="string">"methods"</span>).set(<span class="keyword">null</span>, methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]));</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:         <span class="comment">// create TccProxy class.</span></div><div class="line"><span class="number">145</span>:         <span class="comment">// 创建 Tcc class 代码生成器</span></div><div class="line"><span class="number">146</span>:         ccm = TccClassGenerator.newInstance(cl);</div><div class="line"><span class="number">147</span>:         <span class="comment">// 设置类名</span></div><div class="line"><span class="number">148</span>:         String fcn = TccProxy.class.getName() + id;</div><div class="line"><span class="number">149</span>:         ccm.setClassName(fcn);</div><div class="line"><span class="number">150</span>:         <span class="comment">// 添加构造方法，参数 空</span></div><div class="line"><span class="number">151</span>:         ccm.addDefaultConstructor();</div><div class="line"><span class="number">152</span>:         <span class="comment">// 设置父类为 TccProxy.class</span></div><div class="line"><span class="number">153</span>:         ccm.setSuperClass(TccProxy.class);</div><div class="line"><span class="number">154</span>:         <span class="comment">// 添加方法 #newInstance(handler)</span></div><div class="line"><span class="number">155</span>:         ccm.addMethod(<span class="string">"public Object newInstance("</span> + InvocationHandler.class.getName() + <span class="string">" h)&#123; return new "</span> + pcn + <span class="string">"($1); &#125;"</span>);</div><div class="line"><span class="number">156</span>:         <span class="comment">// 生成类</span></div><div class="line"><span class="number">157</span>:         Class&lt;?&gt; pc = ccm.toClass();</div><div class="line"><span class="number">158</span>:         <span class="comment">// 创建 TccProxy 对象</span></div><div class="line"><span class="number">159</span>:         proxy = (TccProxy) pc.newInstance();</div><div class="line"><span class="number">160</span>:     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">161</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">162</span>:     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"><span class="number">163</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">164</span>:     &#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="number">165</span>:         <span class="comment">// release TccClassGenerator</span></div><div class="line"><span class="number">166</span>:         <span class="keyword">if</span> (ccp != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">167</span>:             ccp.release();</div><div class="line"><span class="number">168</span>:         &#125;</div><div class="line"><span class="number">169</span>:         <span class="keyword">if</span> (ccm != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">170</span>:             ccm.release();</div><div class="line"><span class="number">171</span>:         &#125;</div><div class="line"><span class="number">172</span>:         <span class="comment">// 唤醒缓存 wait</span></div><div class="line"><span class="number">173</span>:         <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line"><span class="number">174</span>:             <span class="keyword">if</span> (proxy == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">175</span>:                 cache.remove(key);</div><div class="line"><span class="number">176</span>:             &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">177</span>:                 cache.put(key, <span class="keyword">new</span> WeakReference&lt;TccProxy&gt;(proxy));</div><div class="line"><span class="number">178</span>:             &#125;</div><div class="line"><span class="number">179</span>:             cache.notifyAll();</div><div class="line"><span class="number">180</span>:         &#125;</div><div class="line"><span class="number">181</span>:     &#125;</div><div class="line"><span class="number">182</span>:     <span class="keyword">return</span> proxy;</div><div class="line"><span class="number">183</span>: &#125;</div></pre></td></tr></table></figure>
<ul>
<li>第 3 至 7 行 ：校验接口超过上限。</li>
<li>第 8 至 27 行 ：使用接口集合类名以 <code>;</code> 分隔拼接，作为 Proxy 的唯一标识。例如 ：<code>key=org.mengyun.tcctransaction.sample.dubbo.redpacket.api.RedPacketAccountService;com.alibaba.dubbo.rpc.service.EchoService;</code> 。</li>
<li><p>第 29 至 37 行 ：获得 Proxy 对应的 ClassLoader。这里我们看下静态属性 <code>ProxyCacheMap</code> 的定义：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Proxy 对象缓存</span></div><div class="line"><span class="comment">* key ：ClassLoader</span></div><div class="line"><span class="comment">* value.key ：Tcc Proxy 标识。使用 Tcc Proxy 实现接口名拼接</span></div><div class="line"><span class="comment">* value.value ：Tcc Proxy 工厂对象</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ClassLoader, Map&lt;String, Object&gt;&gt; ProxyCacheMap = <span class="keyword">new</span> WeakHashMap&lt;ClassLoader, Map&lt;String, Object&gt;&gt;();</div></pre></td></tr></table></figure>
<ul>
<li>使用 WeakHashMap，当 ClassLoader 被回收时，其对应的值一起被移除。</li>
<li><a href="http://blog.csdn.net/yangzl2008/article/details/6980709" rel="external nofollow noopener noreferrer" target="_blank">《WeakHashMap和HashMap的区别》</a></li>
<li><a href="http://www.cnblogs.com/skywang12345/p/3311092.html" rel="external nofollow noopener noreferrer" target="_blank">《Java 集合系列13之 WeakHashMap详细介绍(源码解析)和使用示例》</a></li>
</ul>
</li>
<li>第 39 至 63 行 ：一直获得 <strong>TCC Proxy 工厂</strong>直到成功。<ul>
<li>第 43 至 50 行 ：从<strong>缓存</strong>中获取 TCC Proxy 工厂。</li>
<li>第 51 至 60 行 ：若缓存中不存在，设置<strong>正在生成 TccProxy 代码标记</strong>。创建中时，其他创建请求等待，避免并发。</li>
</ul>
</li>
<li><p>第 65 行 ：<code>PROXY_CLASS_COUNTER</code>，Proxy Class 计数，用于生成 Proxy 类名自增。代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong PROXY_CLASS_COUNTER = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>第 66 至 67 行</p>
<ul>
<li><code>ccm</code>，生成 Dubbo Service 调用 <strong>ProxyFactory</strong> 的代码生成器</li>
<li><code>ccp</code>，生成 Dubbo Service 调用 <strong>Proxy</strong> 的代码生成器</li>
</ul>
</li>
<li><p><strong>第 70 至 142 行 ：生成 Dubbo Service 调用 Proxy 的代码</strong>。</p>
<ul>
<li><p>第 70 至 71 行 ：调用 <code>TccClassGenerator#newInstance(loader)</code> 方法， 创建生成 Dubbo Service 调用 <strong>Proxy</strong> 的代码生成器。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TccClassGenerator.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TccClassGenerator</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * CtClass hash 集合</span></div><div class="line"><span class="comment">     * key：类名</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> ClassPool mPool;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TccClassGenerator <span class="title">newInstance</span><span class="params">(ClassLoader loader)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TccClassGenerator(getClassPool(loader));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">TccClassGenerator</span><span class="params">(ClassPool pool)</span> </span>&#123;</div><div class="line">        mPool = pool;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>ClassPool</strong> 是一个 CtClass 对象的 hash 表，类名做为 key 。ClassPool 的 <code>#get(key)</code> 搜索 hash 表找到与指定 key 关联的 CtClass 对象。如果没有找到 CtClass 对象，<code>#get(key)</code> 读一个类文件构建新的 CtClass 对象，它是被记录在 hash 表中然后返回这个对象。</li>
</ul>
</li>
<li><p>第 76 至 120 行，处理接口。</p>
<ul>
<li>第 79 至 88 行，生成类的包名。</li>
<li><p>第 89 至 90 行，调用 <code>TccClassGenerator#addInterface(cl)</code> 方法，添加生成类的接口( <strong>Dubbo Service 接口</strong> )。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 生成类的接口集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; mInterfaces;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> addInterface(cl.getName());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addInterface</span><span class="params">(String cn)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mInterfaces == <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mInterfaces.add(cn);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 93 至 98 行，添加方法签名到已处理方法签名集合。多个接口可能存在相同的接口方法，跳过相同的方法，避免冲突。</p>
</li>
<li><p>第 99 至 110 行，生成 Dubbo Service 调用实现代码。案例代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">record</span><span class="params">(RedPacketTradeOrderDto paramRedPacketTradeOrderDto)</span> </span>&#123;</div><div class="line">  Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">  arrayOfObject[<span class="number">0</span>] = paramRedPacketTradeOrderDto;</div><div class="line">  Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</div><div class="line">  <span class="keyword">return</span> (String)localObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/04.png" alt=""></li>
</ul>
</li>
<li><p>第 112 至 118 行 ：调用 <code>TccClassGenerator#addMethod(...)</code> 方法，添加生成的方法。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 生成类的方法代码集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mMethods;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 带 <span class="doctag">@Compensable</span> 方法代码集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; compensableMethods = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(<span class="keyword">boolean</span> isCompensableMethod, String name, <span class="keyword">int</span> mod, Class&lt;?&gt; rt, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// 拼接方法</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(ReflectUtils.getName(rt)).append(<span class="string">' '</span>).append(name);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">// 是否有 @Compensable 注解</span></div><div class="line">   <span class="keyword">if</span> (isCompensableMethod) &#123;</div><div class="line">       compensableMethods.add(sb.toString());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> addMethod(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addMethod</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mMethods == <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mMethods.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第 122 至 130 行，生成类名( 例如，<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.proxy3</code> )，并调用 <code>TccClassGenerator#setClassName(...)</code> 方法，设置类名。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 生成类的类名</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mClassName;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setClassName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">   mClassName = name;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 131 至 134 行，调用 <code>TccClassGenerator#addField(...)</code> 方法，添加<strong>静态</strong>属性 <code>methods</code> ( Dubbo Service 方法集合 )和属性 <code>handler</code> ( Dubbo InvocationHandler )。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 生成类的属性集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mFields;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addField</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mFields == <span class="keyword">null</span>) &#123;</div><div class="line">       mFields = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mFields.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 135 至 136 行，调用 <code>TccClassGenerator#addConstructor(...)</code> 方法，添加参数为 <code>handler</code> 的构造方法。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 生成类的非空构造方法代码集合</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> List&lt;String&gt; mConstructors;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(<span class="keyword">int</span> mod, Class&lt;?&gt;[] pts, Class&lt;?&gt;[] ets, String body)</span> </span>&#123;</div><div class="line">   <span class="comment">// 构造方法代码</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   sb.append(modifier(mod)).append(<span class="string">' '</span>).append(SIMPLE_NAME_TAG);</div><div class="line">   sb.append(<span class="string">'('</span>);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</div><div class="line">       <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">           sb.append(<span class="string">','</span>);</div><div class="line">       sb.append(ReflectUtils.getName(pts[i]));</div><div class="line">       sb.append(<span class="string">" arg"</span>).append(i);</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">')'</span>);</div><div class="line">   <span class="keyword">if</span> (ets != <span class="keyword">null</span> &amp;&amp; ets.length &gt; <span class="number">0</span>) &#123;</div><div class="line">       sb.append(<span class="string">" throws "</span>);</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</div><div class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span>)</div><div class="line">               sb.append(<span class="string">','</span>);</div><div class="line">           sb.append(ReflectUtils.getName(ets[i]));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   sb.append(<span class="string">'&#123;'</span>).append(body).append(<span class="string">'&#125;'</span>);</div><div class="line">   <span class="comment">//</span></div><div class="line">   <span class="keyword">return</span> addConstructor(sb.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addConstructor</span><span class="params">(String code)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mConstructors == <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line">   &#125;</div><div class="line">   mConstructors.add(code);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 137 至 138 行，调用 <code>TccClassGenerator#addDefaultConstructor()</code> 方法，添加默认空构造方法。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 默认空构造方法</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDefaultConstructor = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">addDefaultConstructor</span><span class="params">()</span> </span>&#123;</div><div class="line">   mDefaultConstructor = <span class="keyword">true</span>;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 139 行，调用 <code>TccClassGenerator#toClass()</code> 方法，<strong>生成类</strong>。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> Class&lt;?&gt; toClass() &#123;</div><div class="line"> <span class="number">2</span>:    <span class="comment">// mCtc 非空时，进行释放；下面会进行创建 mCtc</span></div><div class="line"> <span class="number">3</span>:    <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">4</span>:        mCtc.detach();</div><div class="line"> <span class="number">5</span>:    &#125;</div><div class="line"> <span class="number">6</span>:    <span class="keyword">long</span> id = CLASS_NAME_COUNTER.getAndIncrement();</div><div class="line"> <span class="number">7</span>:    <span class="keyword">try</span> &#123;</div><div class="line"> <span class="number">8</span>:        CtClass ctcs = mSuperClass == <span class="keyword">null</span> ? <span class="keyword">null</span> : mPool.get(mSuperClass);</div><div class="line"> <span class="number">9</span>:        <span class="keyword">if</span> (mClassName == <span class="keyword">null</span>) &#123; <span class="comment">// 类名</span></div><div class="line"><span class="number">10</span>:            mClassName = (mSuperClass == <span class="keyword">null</span> || javassist.Modifier.isPublic(ctcs.getModifiers())</div><div class="line"><span class="number">11</span>:                    ? TccClassGenerator.class.getName() : mSuperClass + <span class="string">"$sc"</span>) + id;</div><div class="line"><span class="number">12</span>:        &#125;</div><div class="line"><span class="number">13</span>:        <span class="comment">// 创建 mCtc</span></div><div class="line"><span class="number">14</span>:        mCtc = mPool.makeClass(mClassName);</div><div class="line"><span class="number">15</span>:        <span class="keyword">if</span> (mSuperClass != <span class="keyword">null</span>) &#123; <span class="comment">// 继承类</span></div><div class="line"><span class="number">16</span>:            mCtc.setSuperclass(ctcs);</div><div class="line"><span class="number">17</span>:        &#125;</div><div class="line"><span class="number">18</span>:        mCtc.addInterface(mPool.get(DC.class.getName())); <span class="comment">// add dynamic class tag.</span></div><div class="line"><span class="number">19</span>:        <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123; <span class="comment">// 实现接口集合</span></div><div class="line"><span class="number">20</span>:            <span class="keyword">for</span> (String cl : mInterfaces) &#123;</div><div class="line"><span class="number">21</span>:                mCtc.addInterface(mPool.get(cl));</div><div class="line"><span class="number">22</span>:            &#125;</div><div class="line"><span class="number">23</span>:        &#125;</div><div class="line"><span class="number">24</span>:        <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123; <span class="comment">// 属性集合</span></div><div class="line"><span class="number">25</span>:            <span class="keyword">for</span> (String code : mFields) &#123;</div><div class="line"><span class="number">26</span>:                mCtc.addField(CtField.make(code, mCtc));</div><div class="line"><span class="number">27</span>:            &#125;</div><div class="line"><span class="number">28</span>:        &#125;</div><div class="line"><span class="number">29</span>:        <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123; <span class="comment">// 方法集合</span></div><div class="line"><span class="number">30</span>:            <span class="keyword">for</span> (String code : mMethods) &#123;</div><div class="line"><span class="number">31</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">32</span>:                    mCtc.addMethod(CtNewMethod.copy(getCtMethod(mCopyMethods.get(code.substring(<span class="number">1</span>))), code.substring(<span class="number">1</span>, code.indexOf(<span class="string">'('</span>)), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">33</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">34</span>:                    CtMethod ctMethod = CtNewMethod.make(code, mCtc);</div><div class="line"><span class="number">35</span>:                    <span class="keyword">if</span> (compensableMethods.contains(code)) &#123;</div><div class="line"><span class="number">36</span>:                        <span class="comment">// 设置 @Compensable 属性</span></div><div class="line"><span class="number">37</span>:                        ConstPool constpool = mCtc.getClassFile().getConstPool();</div><div class="line"><span class="number">38</span>:                        AnnotationsAttribute attr = <span class="keyword">new</span> AnnotationsAttribute(constpool, AnnotationsAttribute.visibleTag);</div><div class="line"><span class="number">39</span>:                        Annotation annot = <span class="keyword">new</span> Annotation(<span class="string">"org.mengyun.tcctransaction.api.Compensable"</span>, constpool);</div><div class="line"><span class="number">40</span>:                        EnumMemberValue enumMemberValue = <span class="keyword">new</span> EnumMemberValue(constpool);</div><div class="line"><span class="number">41</span>:                        enumMemberValue.setType(<span class="string">"org.mengyun.tcctransaction.api.Propagation"</span>);</div><div class="line"><span class="number">42</span>:                        enumMemberValue.setValue(<span class="string">"SUPPORTS"</span>);</div><div class="line"><span class="number">43</span>:                        annot.addMemberValue(<span class="string">"propagation"</span>, enumMemberValue);</div><div class="line"><span class="number">44</span>:                        annot.addMemberValue(<span class="string">"confirmMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">45</span>:                        annot.addMemberValue(<span class="string">"cancelMethod"</span>, <span class="keyword">new</span> StringMemberValue(ctMethod.getName(), constpool));</div><div class="line"><span class="number">46</span>:                        ClassMemberValue classMemberValue = <span class="keyword">new</span> ClassMemberValue(<span class="string">"org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor"</span>, constpool);</div><div class="line"><span class="number">47</span>:                        annot.addMemberValue(<span class="string">"transactionContextEditor"</span>, classMemberValue);</div><div class="line"><span class="number">48</span>:                        attr.addAnnotation(annot);</div><div class="line"><span class="number">49</span>:                        ctMethod.getMethodInfo().addAttribute(attr);</div><div class="line"><span class="number">50</span>:                    &#125;</div><div class="line"><span class="number">51</span>:                    mCtc.addMethod(ctMethod);</div><div class="line"><span class="number">52</span>:                &#125;</div><div class="line"><span class="number">53</span>:            &#125;</div><div class="line"><span class="number">54</span>:        &#125;</div><div class="line"><span class="number">55</span>:        <span class="keyword">if</span> (mDefaultConstructor) &#123; <span class="comment">// 空参数构造方法</span></div><div class="line"><span class="number">56</span>:            mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));</div><div class="line"><span class="number">57</span>:        &#125;</div><div class="line"><span class="number">58</span>:        <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123; <span class="comment">// 带参数构造方法</span></div><div class="line"><span class="number">59</span>:            <span class="keyword">for</span> (String code : mConstructors) &#123;</div><div class="line"><span class="number">60</span>:                <span class="keyword">if</span> (code.charAt(<span class="number">0</span>) == <span class="string">':'</span>) &#123;</div><div class="line"><span class="number">61</span>:                    mCtc.addConstructor(CtNewConstructor.copy(getCtConstructor(mCopyConstructors.get(code.substring(<span class="number">1</span>))), mCtc, <span class="keyword">null</span>));</div><div class="line"><span class="number">62</span>:                &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">63</span>:                    String[] sn = mCtc.getSimpleName().split(<span class="string">"\\$+"</span>); <span class="comment">// inner class name include $.</span></div><div class="line"><span class="number">64</span>:                    mCtc.addConstructor(CtNewConstructor.make(code.replaceFirst(SIMPLE_NAME_TAG, sn[sn.length - <span class="number">1</span>]), mCtc));</div><div class="line"><span class="number">65</span>:                &#125;</div><div class="line"><span class="number">66</span>:            &#125;</div><div class="line"><span class="number">67</span>:        &#125;</div><div class="line"><span class="number">68</span>: <span class="comment">//            mCtc.debugWriteFile("/Users/yunai/test/" + mCtc.getSimpleName().replaceAll(".", "/") + ".class");</span></div><div class="line"><span class="number">69</span>:        <span class="comment">// 生成</span></div><div class="line"><span class="number">70</span>:        <span class="keyword">return</span> mCtc.toClass();</div><div class="line"><span class="number">71</span>:    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line"><span class="number">72</span>:        <span class="keyword">throw</span> e;</div><div class="line"><span class="number">73</span>:    &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line"><span class="number">74</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">75</span>:    &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</div><div class="line"><span class="number">76</span>:        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</div><div class="line"><span class="number">77</span>:    &#125;</div><div class="line"><span class="number">78</span>: &#125;</div></pre></td></tr></table></figure>
<ul>
<li>基于 Javassist 生成类。这里不做拓展解释，配合<a href="http://www.cnblogs.com/sunfie/p/5154246.html" rel="external nofollow noopener noreferrer" target="_blank">《Java学习之javassist》</a>一起理解。</li>
<li>第 18 行，添加 <code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccClassGenerator.DC</code> 动态生成类标记，标记该类由 TccClassGenerator 生成的。</li>
<li>第 34 至 50 行，设置 @Compensable 默认属性。</li>
</ul>
</li>
<li><p>第 141 至 142 行，设置 Dubbo Service 方法集合设置到静态属性 <code>methods</code> 上。</p>
</li>
</ul>
</li>
<li><p><strong>第 144 至 157 行，生成 Dubbo Service 调用 Proxy 工厂的代码</strong>。</p>
<ul>
<li>第 146 行，调用 <code>TccClassGenerator#newInstance(loader)</code> 方法， 创建生成 Dubbo Service 调用 <strong>Proxy 工厂</strong> 的代码生成器。</li>
<li>第 147 至 149 行，生成类名( 例如，<code>org.mengyun.tcctransaction.dubbo.proxy.javassist.TccProxy3</code> )，并调用 <code>TccClassGenerator#setClassName(...)</code> 方法，设置类名。</li>
<li>第 150 至 151 行，调用 <code>TccClassGenerator#addDefaultConstructor()</code> 方法，添加默认空构造方法。</li>
<li><p>第 152 至 153 行，调用 <code>TccClassGenerator#mSuperClass()</code> 方法，设置继承父类 <strong><code>TccProxy</code></strong>。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* 生成类的父类名字</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> String mSuperClass;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> TccClassGenerator <span class="title">setSuperClass</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</div><div class="line">   mSuperClass = cl.getName();</div><div class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 154 至 155 行，调用 <code>TccClassGenerator#addInterface(cl)</code> 方法，添加生成 Proxy 实现代码的方法。代码案例如下：</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> proxy3(paramInvocationHandler);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>第 156 至 157 行，调用 <code>TccClassGenerator#toClass()</code> 方法，<strong>生成类</strong>。</p>
</li>
</ul>
</li>
<li><p>第 159 行，调用 <code>TccProxy#newInstance()</code> 方法，创建 Proxy 。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with default handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> newInstance(THROW_UNSUPPORTED_INVOKER);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* get instance with special handler.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> instance.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler handler)</span></span>;</div></pre></td></tr></table></figure>
<ul>
<li><code>#newInstance(handler)</code>，抽象方法，上面第 154 至 155 行生成。TccJavassistProxyFactory 调用该方法，获得 Proxy 。</li>
</ul>
</li>
<li><p>第 165 至 171 行，释放 TccClassGenerator 。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mCtc != <span class="keyword">null</span>) &#123;</div><div class="line">       mCtc.detach();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mInterfaces != <span class="keyword">null</span>) &#123;</div><div class="line">       mInterfaces.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mFields != <span class="keyword">null</span>) &#123;</div><div class="line">       mFields.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mConstructors.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyMethods != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyMethods.clear();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (mCopyConstructors != <span class="keyword">null</span>) &#123;</div><div class="line">       mCopyConstructors.clear();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>第 172 至 180 行，设置 Proxy 工厂缓存，并唤醒等待线程。</p>
</li>
</ul>
<p><strong>ps：</strong>代码比较多，收获会比较多，算是 Javassist 实战案例了。TCC-Transaction 作者在实现上述类，可能参考了 Dubbo 自带的实现：</p>
<ul>
<li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Proxy.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Proxy</code></a></li>
<li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.ClassGenerator</code></a></li>
<li><a href="https://github.com/alibaba/dubbo/blob/8f20e3a68efc350e3fbaa965e0a8e8a59fef1b3c/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Wrapper.java" rel="external nofollow noopener noreferrer" target="_blank"><code>com.alibaba.dubbo.common.bytecode.Wrapper</code></a></li>
</ul>
<h3 id="2-1-4-配置-Dubbo-Proxy"><a href="#2-1-4-配置-Dubbo-Proxy" class="headerlink" title="2.1.4 配置 Dubbo Proxy"></a>2.1.4 配置 Dubbo Proxy</h3><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJavassist=org.mengyun.tcctransaction.dubbo.proxy.javassist.TccJavassistProxyFactory</div><div class="line"></div><div class="line">// tcc-transaction-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJavassist"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>目前 Maven 项目 <code>tcc-transaction-dubbo</code> 已经<strong>默认</strong>配置，引入即可。</p>
<p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/05.png" alt=""></p>
<h2 id="2-2-JdkProxyFactory"><a href="#2-2-JdkProxyFactory" class="headerlink" title="2.2 JdkProxyFactory"></a>2.2 JdkProxyFactory</h2><h3 id="2-2-1-JDK-Proxy"><a href="#2-2-1-JDK-Proxy" class="headerlink" title="2.2.1 JDK Proxy"></a>2.2.1 JDK Proxy</h3><p><a href="http://blog.csdn.net/jiankunking/article/details/52143504#" rel="external nofollow noopener noreferrer" target="_blank">《 Java JDK 动态代理（AOP）使用及实现原理分析》</a></p>
<h3 id="2-2-2-TccJdkProxyFactory"><a href="#2-2-2-TccJdkProxyFactory" class="headerlink" title="2.2.2 TccJdkProxyFactory"></a>2.2.2 TccJdkProxyFactory</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jd.TccJdkProxyFactory</code>，TCC JDK 代理工厂。实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccJdkProxyFactory</span> <span class="keyword">extends</span> <span class="title">JdkProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        T proxy = (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> TccInvokerInvocationHandler(proxy, invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>项目启动时</strong>，调用 <code>TccJavassistProxyFactory#getProxy(...)</code> 方法，生成 Dubbo Service 调用 Proxy。</li>
<li><strong>第一次</strong>调用 <code>Proxy#newProxyInstance(...)</code> 方法，创建调用 Dubbo Service 服务的 Proxy。<code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>，Dubbo 调用处理器，点击<a href="https://github.com/alibaba/dubbo/blob/17619dfa974457b00fe27cf68ae3f9d266709666/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/InvokerInvocationHandler.java" rel="external nofollow noopener noreferrer" target="_blank">连接</a>查看代码。</li>
<li><strong>第二次</strong>调用 <code>Proxy#newProxyInstance(...)</code> 方法，创建对调用 Dubbo Service 的 Proxy 的 Proxy。为什么会有两层 Proxy？答案在下节 TccInvokerInvocationHandler 。</li>
</ul>
<h3 id="2-2-3-TccInvokerInvocationHandler"><a href="#2-2-3-TccInvokerInvocationHandler" class="headerlink" title="2.2.3 TccInvokerInvocationHandler"></a>2.2.3 TccInvokerInvocationHandler</h3><p><code>org.mengyun.tcctransaction.dubbo.proxy.jdk.TccInvokerInvocationHandler</code>，TCC 调用处理器，在调用 Dubbo Service 服务时，使用 ResourceCoordinatorInterceptor 拦截处理。实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccInvokerInvocationHandler</span> <span class="keyword">extends</span> <span class="title">InvokerInvocationHandler</span> </span>&#123;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"><span class="comment"> 4:      * proxy</span></div><div class="line"><span class="comment"> 5:      */</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> Object target;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="title">TccInvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span> </span>&#123;</div><div class="line"> <span class="number">9</span>:         <span class="keyword">super</span>(handler);</div><div class="line"><span class="number">10</span>:     &#125;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="keyword">public</span> &lt;T&gt; TccInvokerInvocationHandler(T target, Invoker&lt;T&gt; invoker) &#123;</div><div class="line"><span class="number">13</span>:         <span class="keyword">super</span>(invoker);</div><div class="line"><span class="number">14</span>:         <span class="keyword">this</span>.target = target;</div><div class="line"><span class="number">15</span>:     &#125;</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"><span class="number">18</span>:         Compensable compensable = method.getAnnotation(Compensable.class);</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (compensable != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">20</span>:             <span class="comment">// 设置 @Compensable 属性</span></div><div class="line"><span class="number">21</span>:             <span class="keyword">if</span> (StringUtils.isEmpty(compensable.confirmMethod())) &#123;</div><div class="line"><span class="number">22</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"confirmMethod"</span>, method.getName());</div><div class="line"><span class="number">23</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"cancelMethod"</span>, method.getName());</div><div class="line"><span class="number">24</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"transactionContextEditor"</span>, DubboTransactionContextEditor.class);</div><div class="line"><span class="number">25</span>:                 ReflectionUtils.changeAnnotationValue(compensable, <span class="string">"propagation"</span>, Propagation.SUPPORTS);</div><div class="line"><span class="number">26</span>:             &#125;</div><div class="line"><span class="number">27</span>:             <span class="comment">// 生成切面</span></div><div class="line"><span class="number">28</span>:             ProceedingJoinPoint pjp = <span class="keyword">new</span> MethodProceedingJoinPoint(proxy, target, method, args);</div><div class="line"><span class="number">29</span>:             <span class="comment">// 执行</span></div><div class="line"><span class="number">30</span>:             <span class="keyword">return</span> FactoryBuilder.factoryOf(ResourceCoordinatorAspect.class).getInstance().interceptTransactionContextMethod(pjp);</div><div class="line"><span class="number">31</span>:         &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">32</span>:             <span class="keyword">return</span> <span class="keyword">super</span>.invoke(target, method, args);</div><div class="line"><span class="number">33</span>:         &#125;</div><div class="line"><span class="number">34</span>:     &#125;</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: &#125;</div></pre></td></tr></table></figure>
<ul>
<li>第 18 至 26 行，设置带有 @Compensable 属性的默认属性。</li>
<li><p>第 28 行，生成方法切面 <code>org.mengyun.tcctransaction.dubbo.proxy.jdk.MethodProceedingJoinPoint</code>。实现代码如下：</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodProceedingJoinPoint</span> <span class="keyword">implements</span> <span class="title">ProceedingJoinPoint</span>, <span class="title">JoinPoint</span>.<span class="title">StaticPart</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 代理对象</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object proxy;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 目标对象</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object target;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 方法</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Method method;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 参数</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> Object[] args;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// Use reflection to invoke the method.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ReflectionUtils.makeAccessible(method);</div><div class="line">            <span class="keyword">return</span> method.invoke(target, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">            <span class="comment">// Invoked method threw a checked exception.</span></div><div class="line">            <span class="comment">// We must rethrow it. The client won't see the interceptor.</span></div><div class="line">            <span class="keyword">throw</span> ex.getTargetException();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Tried calling method ["</span> +</div><div class="line">                    method + <span class="string">"] on target ["</span> + target + <span class="string">"] failed"</span>, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Could not access method ["</span> + method + <span class="string">"]"</span>, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">(Object[] objects)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//        throw new UnsupportedOperationException(); // TODO 芋艿：疑问</span></div><div class="line">        <span class="keyword">return</span> proceed();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// ... 省略不重要的方法和对象</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>该类参考 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-aop/src/main/java/org/springframework/aop/aspectj/MethodInvocationProceedingJoinPoint.java" rel="external nofollow noopener noreferrer" target="_blank"><code>org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint</code></a> 实现。</li>
<li>TODO【1】 proxy 和 target 是否保留一个即可？</li>
<li>在切面处理完成后，调用 <code>#proceed(...)</code> 方法，进行远程 Dubbo Service 服务调用。</li>
<li>TODO【2】<code>#proceed(objects)</code> 抛出 throw new UnsupportedOperationException();。需要跟作者确认下。</li>
</ul>
</li>
<li>调用 <code>ResourceCoordinatorAspect#interceptTransactionContextMethod(...)</code> 方法，对方法切面拦截处理。<strong>为什么无需调用 CompensableTransactionAspect 切面</strong>？因为传播级别为 Propagation.SUPPORTS，不会发起事务。</li>
</ul>
<h3 id="2-2-4-配置-Dubbo-Proxy"><a href="#2-2-4-配置-Dubbo-Proxy" class="headerlink" title="2.2.4 配置 Dubbo Proxy"></a>2.2.4 配置 Dubbo Proxy</h3><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">// META-INF.dubbo/com.alibaba.dubbo.rpc.ProxyFactory</div><div class="line">tccJdk=org.mengyun.tcctransaction.dubbo.proxy.jdk.TccJdkProxyFactory</div><div class="line"></div><div class="line">// appcontext-service-dubbo.xml</div><div class="line"><span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">proxy</span>=<span class="string">"tccJdk"</span> <span class="attr">id</span>=<span class="string">"captialTradeOrderService"</span></span></div><div class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">"org.mengyun.tcctransaction.sample.dubbo.capital.api.CapitalTradeOrderService"</span> <span class="attr">timeout</span>=<span class="string">"5000"</span>/&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>ProxyFactory 的 <code>tccJdk</code> 在 Maven 项 <code>tcc-transaction-dubbo</code> 已经声明。</li>
<li>声明 <code>dubbo:provider</code> 的 <code>proxy=&quot;tccJdk&quot;</code>。</li>
<li>声明 <code>dubbo:reference</code> 的 <code>proxy=&quot;tccJdk&quot;</code>，否则不生效。</li>
</ul>
<h1 id="3-Dubbo-事务上下文编辑器"><a href="#3-Dubbo-事务上下文编辑器" class="headerlink" title="3. Dubbo 事务上下文编辑器"></a>3. Dubbo 事务上下文编辑器</h1><p><code>org.mengyun.tcctransaction.dubbo.context.DubboTransactionContextEditor</code>，Dubbo 事务上下文编辑器实现，实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTransactionContextEditor</span> <span class="keyword">implements</span> <span class="title">TransactionContextEditor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TransactionContext <span class="title">get</span><span class="params">(Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        String context = RpcContext.getContext().getAttachment(TransactionContextConstants.TRANSACTION_CONTEXT);</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(context)) &#123;</div><div class="line">            <span class="keyword">return</span> JSON.parseObject(context, TransactionContext.class);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> </span>&#123;</div><div class="line">        RpcContext.getContext().setAttachment(TransactionContextConstants.TRANSACTION_CONTEXT, JSON.toJSONString(transactionContext));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过 Dubbo 的隐式传参的方式，避免在 Dubbo Service 接口上声明 TransactionContext 参数，对接口产生一定的入侵。</li>
</ul>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>HOHO，对动态代理又学习了一遍，蛮 High 的。</p>
<p>这里推荐动态代理无关，和 Dubbo 相关的文章：</p>
<ul>
<li><a href="http://blog.kazaff.me/2015/01/27/dubbo%E4%B8%AD%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%9A%84%E7%BB%86%E8%8A%82/" rel="external nofollow noopener noreferrer" target="_blank">《Dubbo的服务暴露细节》</a>。</li>
<li><a href="http://weifuwu.io/2016/01/03/dubbo-provider-start/" rel="external nofollow noopener noreferrer" target="_blank">《Dubbo Provider启动主流程》</a></li>
</ul>
<p><img src="http://www.iocoder.cn/images/TCC-Transaction/2018_03_07/06.png" alt=""></p>
<p>胖友，分享一波朋友圈可好。</p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/TCC-Transaction/">TCC-Transaction</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.iocoder.cn/TCC-Transaction/dubbo-support/" data-title="TCC-Transaction 源码分析 —— Dubbo 支持 | 芋道源码 —— 纯源码解析BLOG" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/TCC-Transaction/http-sample/" title="TCC-Transaction 源码分析 —— 项目实战">
  <strong>PREVIOUS:</strong><br>
  <span>
  TCC-Transaction 源码分析 —— 项目实战</span>
</a>
</div>


<div class="next">
<a href="/TCC-Transaction/console/" title="TCC-Transaction 源码分析 —— 运维平台">
 <strong>NEXT:</strong><br> 
 <span>TCC-Transaction 源码分析 —— 运维平台
</span>
</a>
</div>

</nav>

	

</div>  
        <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="toc" class="toc-aside">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Dubbo-代理"><span class="toc-number">2.</span> <span class="toc-text">2. Dubbo 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-JavassistProxyFactory"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 JavassistProxyFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-Javassist"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 Javassist</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-TccJavassistProxyFactory"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 TccJavassistProxyFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-TccProxy-amp-TccClassGenerator"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3 TccProxy &amp; TccClassGenerator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-配置-Dubbo-Proxy"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4 配置 Dubbo Proxy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-JdkProxyFactory"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 JdkProxyFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-JDK-Proxy"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 JDK Proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-TccJdkProxyFactory"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 TccJdkProxyFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-TccInvokerInvocationHandler"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 TccInvokerInvocationHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-配置-Dubbo-Proxy"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 配置 Dubbo Proxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Dubbo-事务上下文编辑器"><span class="toc-number">3.</span> <span class="toc-text">3. Dubbo 事务上下文编辑器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-彩蛋"><span class="toc-number">4.</span> <span class="toc-text">666. 彩蛋</span></a></li></ol>
</div>

<div id="asidepart">
    <!--<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>-->
    <aside class="clearfix">
        <div id="authorInfo">
            <!---->
            <!--<div class="author-logo"></div>-->
            <!---->

            <div> <img width="100%" src="/images/common/wechat_mp_2017_07_31_bak.jpg"> </div>

            <div class="social-list">
                
                
                
                
                
            </div>
        </div>

        
        <div class="categorieslist">
    <p class="asidetitle">微信公众号福利：芋道源码</p>
    <ul>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 0. 阅读源码葵花宝典 </a></li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 1. RocketMQ / MyCAT / Sharding-JDBC 详细中文注释源码 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 2. 您对于源码的疑问每条留言都将得到认真回复 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg"> 3. 新的源码解析文章实时收到通知，每周六十点更新 </a> </li>

        <li> <a href="/images/common/wechat_mp_2017_07_31_bak.jpg">4. 认真的源码交流微信群 </a> </li>


    </ul>
</div>
        
        
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
            
			    <li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/Dubbo/" title="Dubbo">Dubbo<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Cloud/" title="Elastic-Job-Cloud">Elastic-Job-Cloud<sup>6</sup></a></li>
            
		
            
			    <li><a href="/categories/Elastic-Job-Lite/" title="Elastic-Job-Lite">Elastic-Job-Lite<sup>16</sup></a></li>
            
		
            
			    <li><a href="/categories/Eureka/" title="Eureka">Eureka<sup>23</sup></a></li>
            
		
            
			    <li><a href="/categories/Happylifeplat-TCC/" title="Happylifeplat-TCC">Happylifeplat-TCC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Hystrix/" title="Hystrix">Hystrix<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/JUC/" title="JUC">JUC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>9</sup></a></li>
            
		
            
			    <li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/RocketMQ/" title="RocketMQ">RocketMQ<sup>14</sup></a></li>
            
		
            
			    <li><a href="/categories/RxJava/" title="RxJava">RxJava<sup>5</sup></a></li>
            
		
            
			    <li><a href="/categories/Sharding-JDBC/" title="Sharding-JDBC">Sharding-JDBC<sup>18</sup></a></li>
            
		
            
			    <li><a href="/categories/SkyWalking/" title="SkyWalking">SkyWalking<sup>22</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-Cloud-Gateway/" title="Spring-Cloud-Gateway">Spring-Cloud-Gateway<sup>24</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-MVC/" title="Spring-MVC">Spring-MVC<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/Spring-Security/" title="Spring-Security">Spring-Security<sup>1</sup></a></li>
            
		
            
			    <li><a href="/categories/TCC-Transaction/" title="TCC-Transaction">TCC-Transaction<sup>7</sup></a></li>
            
		
            
			    <li><a href="/categories/TiKV/" title="TiKV">TiKV<sup>2</sup></a></li>
            
		
            
			    <li><a href="/categories/工作内推/" title="工作内推">工作内推<sup>4</sup></a></li>
            
		
            
			    <li><a href="/categories/技术杂文/" title="技术杂文">技术杂文<sup>5</sup></a></li>
            
		
		</ul>
</div>

        
    </aside>
</div>
    </div>
    <footer><div id="footer">
    <img src="http://www.iocoder.cn/images/common/wechat_mp_simple.png" style="display: none">
    
            <p class="copyright"> © 2018 
		
		<a href="http://www.iocoder.cn" target="_blank" title="芋道源码">芋道源码</a>
		
            && <span style="display: inline;" id="busuanzi_container_site_uv">总访客数 <span id="busuanzi_value_site_uv" font="微软雅黑"></span> 次</span>
            && <span style="display: inline;" id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv" font="微软雅黑"></span> 次</span>
            <!--&& Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>-->
            <!--&& Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> && Theme by <a href="http://gengbiao.me" target="_blank" title="coney">coney</a>-->
            </p></div>
            <div class="copyright">沪ICP备17037075号-1</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<link rel="stylesheet" href="/alert/css/alert.css">
<script src="/alert/js/alert.js"></script>
<script src="/js/jquery.cookie.js"></script>
<script src="/js/util.js"></script>





<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-107572620-1', 'auto');  
ga('send', 'pageview');
</script>

  </body>


